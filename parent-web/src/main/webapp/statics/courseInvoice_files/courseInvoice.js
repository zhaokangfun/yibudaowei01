var CourseInvoice=function(){this.acographyId=Utils.getQueryString("acographyId");this.empiId=Utils.getQueryString("empiId");this.treatmentState=Utils.getQueryString("treatmentState");this.medical_user_data=config_cache.getCache("medical_user_data");this.physiotherapy=Utils.getQueryString("physiotherapy");this.isYbReg=Utils.getQueryString("isYbReg");this.sex=Utils.getQueryString("sex");this.triageId=Utils.getQueryString("triageId");this.recordId=Utils.getQueryString("recordId");this.patientNo="";this.patientName="";this.userId=config_cache.getCache("medical_user_data").userId;this.selectedDoctorInfo={};this.modify_visitDoctor_api={selectVisitInfo:ContextClinc_Server+"docWorkSta/selectVisitInfo",updateVisitInfo:ContextClinc_Server+"docWorkSta/updateVisitInfo",};this.historyDateList=[];this.orderData=[];this.template={clinic:[],personal:[]};this.$courseExecutionList=null;this.clinicDoctors=[];this.templateTypeEnum={CLINIC:2,PERSONAL:3};this.finishFlag=false;this.courseInvoiceMaxNum=6};CourseInvoice.prototype={main:function(){var a=this;if(a.physiotherapy){$("menuDoctorDiv").show();a.initMenuDoctorDropBox()}else{$("menuDoctorDiv").hide()}a.initCourseLabel();a.initCourseHead();a.initDiagnosis();a.initCourseThinkbox();a.initCourseFoot();a.initTemplate();a.initHisCourse();a.initkeyBoardEvent();a.initCourseDwsStation()},initCourseLabel:function(){var a=this;$(".recipe-label .recipe-label-item span").off("click").on("click",a.selectLabel);$(".recipe-label .delete").off("click").on("click",a.deleteLabel);$(".left-prescription .add-recipe").on("click",a.addRecipe);$("#init-element").find(".close-order-list").on("click",a,function(c){var e=c.data.orderData;var k=$(this);var j=k.parents(".pill-list-item");var h=j.attr("courseId");var i=j.attr("orderNum");var f=$(".recipe-label li:visible");var b=null;$.each(f,function(l,m){if($(m).hasClass("checked")){b=l}});var g=0;$.each(e[b].courseExecutionList,function(m,l){if(h==l.courseId&&i==l.orderNum){l.delFlag=1;if(l.selectFlag&&l.selectFlag==1){g++}}});var d=courseInvoiceGlobal.calTotalPrice(e[b].courseExecutionList);$(".totalMoney input").val(d);if(courseInvoiceGlobal.getParam().isShowFee){$(".last-column .total-money").text("-")}else{$(".last-column .total-money").text(d)}j.remove();if(g>0){$(".importInfo .drug-operate .delete-drug").attr("style","display: none")}courseInvoiceGlobal.showBlankTip(e[b].courseExecutionList,0)});$(".pill-listBox ul li").on("click",a,function(h){$(".importInfo .drug-operate .delete-drug").attr("style","display: block");var b=h.data.orderData;var f=$(this);var g=f.attr("courseId");var d=f.attr("ordernum");var i=courseInvoiceGlobal;if(!$(this).hasClass("showDetail")){i.getPlanItems(g,f,i.renderPlanItems)}var e=i.getCurCourseIndex();$.each(b[e].courseExecutionList,function(k,j){j.selectFlag=0});var c=_.filter(b[e].courseExecutionList,function(j){return j.courseId==g&&j.delFlag==0&&d==j.orderNum});c[0].selectFlag=1;i.selectDetail(c[0])});a.initData()},initMenuDoctorDropBox:function(){var a=this;var c={acographyId:a.acographyId};var b={url:a.modify_visitDoctor_api.selectVisitInfo,method:"POST",data:c,dataType:"json",async:true};var d=Utils.myAjaxHandler(b);d.done(function(f){if(SUCCESSCODE==f.errorCode){var e=f.data;a.renderMenuDoctorDropBox(e)}else{$.paError(f.errorMessage,null)}}).fail(function(e){$.paError("请求异常",null)}).always(function(){})},renderMenuDoctorDropBox:function(f){if(!f||!f.clinicDoctors||f.clinicDoctors.length<=0){$.paError("获取不到就诊医生列表");return}var c=this;var g=f.clinicDoctors;var a={idKey:"USER_ID",txtKey:"EMPLOYEE_NAME",isNeedClear:false,isNeedAll:true,isNeedThink:true};var b=$("#menuDoctor");var e=c.filterDoctorList(g);b.WJZSDropdown(g,a,function(h,i){c.modifyMenuDoctor(i)});if(f.visitDoctor&&f.visitDoctor.doctorId){var d=f.visitDoctor.doctorId;b.SelectWJZSDropdownItem(d)}else{b.SelectWJZSDropdownFirstItem()}},modifyMenuDoctor:function(f){var a=this;var d=f.USER_ID;var c=f.EMPLOYEE_NAME;if(d==a.selectedDoctorInfo.userId&&c==a.selectedDoctorInfo.doctorName){return}var e={acographyId:a.acographyId,doctorId:d,doctorName:c};var b={url:a.modify_visitDoctor_api.updateVisitInfo,method:"POST",data:e,dataType:"json"};var g=Utils.myAjaxHandler(b);g.done(function(h){if(SUCCESSCODE==h.errorCode){a.selectedDoctorInfo.userId=d;a.selectedDoctorInfo.doctorName=c;a.setRecipeDoctor(d,c)}else{$.paError(h.errorMessage,null)}}).fail(function(h){$.paError("请求异常",null)}).always(function(){})},setRecipeDoctor:function(a,b){return},filterDoctorList:function(c){var a=this;var b=new Array();if(c){c.forEach(function(e,d,f){if(f[d].USER_ID){b.push(f[d])}})}return b},getPlanItems:function(b,d,c){var a={url:ContextClinc_Server+"dwsCnCourse/getPlanItems",method:"POST",dataType:"json",contentType:"application/json; charset=utf-8",data:b};var e=Utils.myAjaxHandler(a);e.done(function(f){if(f!=null&&f.errorCode==SUCCESSCODE){if(c){c.call(self,d,f.data)}}else{$.paError("操作失败")}}).fail(function(f){$.paError("操作失败!")}).always(function(){})},renderPlanItems:function(b,c){$(b).find(".pill-listBox-detail").remove();var a='<div class="pill-listBox-detail dsn" style="display: block;" ><p class="listBox-detail-title">疗程明细：</p>';$.each(c,function(e,g){var h=(g.TREATMENT_PRICE||"");if(!Utils.isBlank(h)){h=(g.itemPrice||"")}if(courseInvoiceGlobal.getParam().isShowFee){h="-"}var d=(h||"")+"/次*"+(g.itemNum||"");var f=g.DRUG_NAME||"";if(!Utils.isBlank(f)){f=g.TREATMENT_NAME||""}a+='<div class="clear"><div class="fl istBox-detail-name">'+f+'</div><div class="fl">'+d+"</div></div>"});a+="</div>";$(b).find(".pill-listBox-lineO").after(a)},selectLabel:function(){var e=$(this);var i=courseInvoiceGlobal;var f=e.parent().siblings();$.each(f,function(j,k){if($(k).hasClass("checked")&&"display: none;"!=$(k).attr("style")){$(k).removeClass("checked");$(k).find(".delete").attr("style","display: none;")}});e.parent().addClass("checked").find(".delete").attr("style","display: inline;");$(".importInfo .drug-operate .empty-drug").click();var d=e.parent().attr("CourseRecipeId");$(".print").attr("courseRecipeId",d);$(".print").attr("title","打印疗程"+i.getCurCourseNum());$(".saveAs").attr("title","疗程"+courseInvoiceGlobal.getCurCourseNum()+"另存为模板");if(!Utils.isBlank(d)){var g=$(".pill-list-content .pill-listBox .dsn");$(".pill-list-content .pill-listBox ul").html(g.clone(true));$(".totalMoney input").val("0.00");var c=$(".recipe-label li:visible");var a=null;$.each(c,function(j,k){if($(k).hasClass("checked")){a=j}});i.renderCourseExecutionList(i.orderData[a].courseExecutionList);i.changeCourseStatus(0);i.change2AddMode();return}var b=_.filter(i.orderData,function(j){return j.courseRecipeId==d});i.renderCourseExecutionList(b[0].courseExecutionList);var h=i.repceStatus(b[0]);if(h==0){courseInvoiceGlobal.changeCourseStatus(2);if(2==i.treatmentState){i.finishTreatmenMode();return}if($(".updateCouresMode:visible").length<=0){$(".updateCouresMode").click()}else{}}else{i.readOnlyMode()}i.initExecuteDoctors($(".excutorName"))},deleteLabel:function(){var d=$(this);var a=courseInvoiceGlobal.orderData;var c=d.parent().find("span").text();var b={msg:"删除"+c+"，请确认！",cancelTxt:"取消",saveTxt:"确认",onYes:function(){var i=courseInvoiceGlobal;var e=i.getCurCourseNum();var f=$(".recipe-label li:visible");var g=null;$.each(f,function(j,k){if($(k).hasClass("checked")){g=j}});var h=a[g];if(a&&h&&h.courseRecipeId){i.deleteCourse(h,function(){a.splice(g,1);i.renderCourse(a)})}else{a.splice(g,1);i.renderCourse(a)}}};$.paConfirm(b)},addRecipe:function(){var k=courseInvoiceGlobal;$(".pill-middle-info").attr("style","");$(".foot-btn").attr("style","");var d=k.orderData;var g=$(".left-prescription .add-recipe");var a=null;var j=g.parent().find("ul li:visible");if(j==null||j.length<=0){a=g.parent().find("ul li:visible").length}else{a=$(j).last().find("span").text().split("疗程单")[1]}if($(j).length>=courseInvoiceGlobal.courseInvoiceMaxNum){$.paWarn("最多只能添加六个疗程单");return false}var e;var f=$(g.parent().find(".checked:hidden")[0]);var b=g.parent().find(".checked:visible");if(b&&b.length>0){e=$(b[0]).clone(true);e.find(".delete").attr("style","display: inline")}else{e=f.clone(true);e.attr("style","");e.find(".delete").attr("style","display: inline")}var h=g.parent().find("ul li:visible").clone(true);$.each(h,function(l,m){if($(m).hasClass("checked")){$(m).removeClass("checked");$(m).find(".delete").attr("style","display: none;")}});var c="疗程单"+(++a);e.attr("CourseRecipeId","");e.find("span").text(c);e.find("span").off("click").on("click",courseInvoiceGlobal.selectLabel);e.find(".delete").off("click").on("click",courseInvoiceGlobal.deleteLabel);h.push(e[0]);h.push(f[0]);g.parent().find("ul").html(h);d.push({recipeNo:a,empiid:k.empiId,courseExecutionList:[]});var i=$("#init-element");$(".pill-list-content .pill-listBox ul").html(i.clone(true));$(".totalMoney input").val("0.00");courseInvoiceGlobal.initExecuteDoctors($(".excutorName"));courseInvoiceGlobal.change2AddMode();courseInvoiceGlobal.clearCourseInput();$(".update-drug").hide();$(".add-drug").show();$(".without-drugs").removeClass("dsn");return true},selectDetail:function(a){$(".add-drug").hide();$(".update-drug").show();var b=$(".importInfo .thinkBoxInputArea ");b.attr("courseExecutionId",a.courseExecutionId);b.attr("COURSE_PLAN_TOTAL_PRICE",a.coursePrice);b.attr("COURSE_PLAN_ID",a.courseId);b.val(a.courseName);b.attr("COURSE_PLAN_PREFERENTIAL_PRICE",a.coursePlanPrice);b.attr("COURSE_PLAN_TOTAL_TIMES",a.coursePlanTotalTimes);b.attr("COURSE_PLAN_EXECRATE",a.coursePlanExecrate);b.click();b.focus();b.attr("disabled","disabled");$(".drug-dosage input").val(a.courseQty);$(".drug-dosage input").click();$(".drug-dosage input").focus();$(".remark-advice input").val(a.remark);b.attr("orderNum",a.orderNum);b.attr("COURSE_PLAN_CODE",a.courseCode);if(!Utils.isBlank(a.doctorId)){a.doctorId="未指定"}$(".excutorName").SetWJZSDropdownSelectedData(a.doctorId);$(".drug-input .drugName-input-info").find("span").eq(0).text(a.coursePlanPrice);$(".drug-input .drugName-input-info").find("span").eq(1).text(a.coursePlanTotalTimes);$(".drug-input .drugName-input-info").find("span").eq(2).text(a.coursePlanExecrate)},initCourseHead:function(){$(".editorBtn").on("click",function(){$("#addDiagnosisPop").removeClass("dsn");$("#addDiagnosisPop .popup").show()});$("#add-save").on("click",function(){var a=$("#addDiagnosisPop").ableToFinish();if(!a){return}$("#addDiagnosisPop").addClass("dsn");courseInvoiceGlobal.saveCnMedical()});$("#add-cancel").on("click",function(){$("#addDiagnosisPop").addClass("dsn")});$("#closeDiagnosis").on("click",function(){$("#add-cancel").click()});$("#addDiagnosisPop").ketchup();$(".importInfo").ketchup()},initCourseFoot:function(){var a=this;$(".importInfo .drug-operate .add-drug").on("click",a,function(g){var d=$(".importInfo").ableToFinish();if(!d){return}var e=g.data.orderData;var b=a.getCourseExecutionData(g.data);var c=$(".recipe-label li:visible");var f=null;$.each(c,function(i,j){if($(j).hasClass("checked")){f=i}});var h=e[f];if(f>e.length){e.push({courseExecutionList:[]})}e[f].courseExecutionList.push(b);a.renderCourseExecutionList(e[f].courseExecutionList);setTimeout(a.clearCourseInput,250)});$(".importInfo .drug-operate .empty-drug").on("click",function(){a.clearCourseInput();$(".update-drug").hide();$(".add-drug").show()});$(".importInfo .drug-operate .delete-drug").on("click",function(){$(".pill-listBox ul .checked").find(".close-order-list").click();$(this).hide();$(".update-drug").hide();$(".add-drug").show()});$(".print").off("click").on("click",function(){var b=$(this).attr("courseRecipeId");a.printRecipe(b)});$(".saveCoures").on("click",a,function(c){var b=c.data.orderData;var d=courseInvoiceGlobal;d.insertOrUpdate(b,function(){d.getCourseAction(d.acographyId,d.renderCourse,$(".recipe-label ul").find(".checked:visible"))})});$(".updateCouresMode").on("click",function(){courseInvoiceGlobal.changesMode()});$(".update-drug").on("click",function(){var d=$(".importInfo").ableToFinish();if(!d){return}var g=$(".importInfo .thinkBoxInputArea ");var f=g.attr("courseExecutionId");var b=courseInvoiceGlobal.getCurCourseIndex();var e=$(g).attr("orderNum");var h=$(g).attr("COURSE_PLAN_ID");var c=a.getCourseExecutionData(courseInvoiceGlobal);c.orderNum=e;c.courseExecutionId=f;var i=[];$.each(courseInvoiceGlobal.orderData[b].courseExecutionList,function(j,k){if(k.delFlag==0&&k.courseId==h&&k.orderNum==e){i.push(c)}else{i.push(k)}});courseInvoiceGlobal.orderData[b].courseExecutionList=i;a.renderCourseExecutionList(courseInvoiceGlobal.orderData[b].courseExecutionList);setTimeout(a.clearCourseInput,250);$(".add-drug").show();$(".update-drug").hide()})},printRecipe:function(b){var a=this;var c=new CourseInvoicePrint();if(!a.finishFlag){$.paWarn("请先保存！");return}c.doPrintFacade(a.acographyId,a.empiId,b)},insertOrUpdate:function(e,c){var h=this;var f=$(".china-doctorName").attr("val");var g=$(".china-doctorName").val();var d=h.empiId;var b=h.acographyId;var a=false;if(e!=null&&e.length>0){$.each(e,function(k,l){l.doctorId=f;l.doctorName=g;l.empiId=d;l.acographyId=b;l.totalPrice=$(".totalMoney input").val();var m=[];$.each(l.courseExecutionList,function(o,n){if(n.delFlag==1&&!Utils.isBlank(n.courseExecutionId)){}else{if(n.doctorName=="未指定"||n.doctorId=="未指定"){n.doctorName=null;n.doctorId=null}m.push(n)}});l.courseExecutionList=m;if(!Utils.isBlank(l.courseExecutionList)||l.courseExecutionList.length<=0||_.filter(l.courseExecutionList,function(n){return n.delFlag==0}).length<=0){a=true}});if(a){$.paError("存在为空疗程单!");return}var j={url:ContextClinc_Server+"tcmCourse/insertOrUpdate",method:"POST",dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify(e),showMask:true};var i=Utils.myAjaxHandler(j);i.done(function(l){if(l!=null&&l.errorCode==SUCCESSCODE){if(l.data&&l.data.length>0){var k="";$.each(l.data,function(m,n){k+="疗程"+n});$.paError(k+"已经收费或者执行")}else{$.paSuccess("保存成功")}h.submittedMode();h.finishFlag=true;if(c){c.call(h,l.data)}}else{$.paError("保存失败")}}).fail(function(k){$.paError("操作失败!")}).always(function(){})}else{$.paError("疗程单为空!")}},changeCourseStatus:function(a){if(a==0){$(".pill-status>i").attr("class","new").show()}else{if(a==1){$(".pill-status>i").attr("class","changes").show()}else{if(a==2){$(".pill-status>i").attr("class","submitted").show()}else{if(a==3){$(".pill-status>i").attr("class","hasCharge").show()}else{if(a==4){$(".pill-status>i").attr("class","hasCharge").show()}else{if(a==5){$(".pill-status>i").attr("class","partRefund").show()}else{if(a==6){$(".pill-status>i").attr("class","haveRefund").show()}else{if(a==7){$(".pill-status>i").attr("class","inExecution").show()}else{if(a==8){$(".pill-status>i").attr("class","executed").show()}else{if(a==9){$(".pill-status>i").attr("class","inTheCharge").show()}}}}}}}}}}},deleteCourse:function(a,e){var b=this;if(a!=null&&a.courseRecipeId!=null){var d=[];$.each(a.courseExecutionList,function(h,g){if(g.delFlag==1&&!Utils.isBlank(g.courseExecutionId)){}else{d.push(g)}});a.courseExecutionList=d;var c={url:ContextClinc_Server+"tcmCourse/deleteCourse",method:"POST",dataType:"json",contentType:"application/json; charset=utf-8",data:JSON.stringify(a),showMask:true};var f=Utils.myAjaxHandler(c);f.done(function(g){if(g!=null&&g.errorCode==SUCCESSCODE){if("true"==g.data||g.data==true){$.paSuccess("删除成功");if(e){e.call(b,g.data)}}else{$.paSuccess("该疗程不能删除")}}else{$.paError(status.errorMessage)}}).fail(function(g){$.paError("操作失败!")}).always(function(){})}},initTemplate:function(){var a=this;$(".foot-btn .saveAs").on("click",function(){var b=this;$("#addPhysiotherapyPop").removeClass("dsn");$("#addPhysiotherapyPop .popup").show()});$("#physiotherapy-cancel").on("click",function(){var b=this;$("#addPhysiotherapyPop").addClass("dsn");$("#templateName").val("");$("#templateType").find(".radio").eq(0).addClass("checked");$("#templateType").find(".radio").eq(1).removeClass("checked")});$("#physiotherapy-save").on("click",function(){var g=this;var c=$("#addPhysiotherapyPop").ableToFinish();if(!c){return}var b=$("#templateName").val();var e=$("#templateType").find(".checked").attr("val");var f=courseInvoiceGlobal.getCurCourseIndex();var d=courseInvoiceGlobal.orderData2Template(courseInvoiceGlobal.orderData[f],b,e);courseInvoiceGlobal.saveAsTemplate(d,function(h){$("#addPhysiotherapyPop").addClass("dsn");$("#templateName").val("");$("#templateType").find(".radio").eq(0).addClass("checked");$("#templateType").find(".radio").eq(1).removeClass("checked");courseInvoiceGlobal.template={clinic:[],personal:[]};$(".topNav .template").click()})});$(".topNav .template").on("click",function(){courseInvoiceGlobal.getCourseTmplAction(courseInvoiceGlobal.templateTypeEnum.PERSONAL,courseInvoiceGlobal.renderTemplateList);courseInvoiceGlobal.getCourseTmplAction(courseInvoiceGlobal.templateTypeEnum.CLINIC,courseInvoiceGlobal.renderTemplateList)});$(".tmpl-css-wrap").on("click",".recipe-template-title",function(){$(this).toggleClass("collapse");$(this).next().slideToggle()});$("#teml_btn_search").on("click",function(){var b=$("#searchTemplateName").val();courseInvoiceGlobal.searchTemplate(b)});$("#closeCourseTmpl").on("click",function(){$("#physiotherapy-cancel").click()});$("#addPhysiotherapyPop").ketchup()},initHisCourse:function(){$(".historyRecipe i").on("click",function(){var g=$(this);var e=$("#hisDate").attr("index");if(g.hasClass("next")){if(e==(courseInvoiceGlobal.historyDateList.length-1)){$.paAlert("已经是最后一条数据");return}var b=++e;var c=courseInvoiceGlobal.historyDateList[b];var f=c.ACOGRAPHYID;$("#hisDate").SetWJZSDropdownSelectedData(f);courseInvoiceGlobal.selectHisByDate(c.ADDDATE,c.ACOGRAPHYID,c.EMPID,c.CLINICID);$("#hisDate").attr("index",b)}else{if(g.hasClass("prev")){if(e==0){$.paAlert("当前是第一条数据");return}var d=--e;var a=courseInvoiceGlobal.historyDateList[d];var f=a.ACOGRAPHYID;$("#hisDate").SetWJZSDropdownSelectedData(f);courseInvoiceGlobal.selectHisByDate(a.ADDDATE,a.ACOGRAPHYID,a.EMPID,a.CLINICID);$("#hisDate").attr("index",d)}}})},initDiagnosis:function(){var a=this;a.initChiefComThinkInput()},initData:function(){var a=this;a.selecCourseHistoryDateListAction(a.renderHisDataList);a.getCourseAction(a.acographyId,a.renderCourse);if(1==a.treatmentState||2==a.treatmentState){a.getCourseHeadInfoAction(a.acographyId,a.empiId,a.renderCourseHead);a.initExecuteDoctors($(".excutorName"))}},renderHisDataList:function(e){var b=this;var d=[];if(e&&e.length>0){$(".noDataHint").hide();$(".historyRecipe").show();var a=null;var c={idKey:"ACOGRAPHYID",txtKey:"ADDDATE",isNeedClear:false,};var g=$("#hisDate");if(e&&e.length>0){g.WJZSDropdown(e,c,function(i,h){b.selectHisByDate(h.ADDDATE,h.ACOGRAPHYID,h.EMPID,h.CLINICID);$.each(e,function(j,k){if(k.ACOGRAPHYID==h.ACOGRAPHYID){g.attr("index",j)}})});g.SelectWJZSDropdownFirstItem();var f=e[0];b.selectHisByDate(f.ADDDATE,f.ACOGRAPHYID,f.EMPID,f.CLINICID);$("#hisDate").attr("index",0)}}else{$(".noDataHint").show();$(".historyRecipe").hide()}},getGender:function(a){if(a=="-"){return""}return a==1?"男":"女"},renderCourseHead:function(b){var a=this;$(".clear .pill-number").text(b.ACOGRAPHY_SERIAL_NO||"-");$(".pill-top-info .clinic-name").text(a.medical_user_data.clinicName||"-");$(".pill-detailInfo .patient-healthCard").text(b.INSURANCE_NO||"-");$(".pill-detailInfo .patient-name").text(b.PATIENT_NAME||"-");$(".pill-detailInfo .patient-gender").text(a.getGender(b.PATIENT_GENDER||"-"));$(".pill-detailInfo .patient-age").text((Utils.calcPatientAge(b.PATIENT_BIRTH_DATE).split(",")[0]||"-")+"岁");$(".pill-detailInfo .department-name").text(b.DEPARTMENT_NAME||"-");$(".pill-detailInfo .payment-type-name").text(b.MI_TYPE_NAME||"自费");$(".pill-detailInfo .patient-no").text(b.PATIENT_NO||"-");$(".pill-detailInfo .living-address-countryside").text((b.LIVING_ADDRESS_COUNTRYSIDE||"-")+"/"+(b.MOBILE_PHONE_NUMBER||"-"));if(!Utils.isBlank(b.CHINESE_TRA_DIAGNOSIS)&&!Utils.isBlank(b.DiagnosisList)){$(".pill-detailInfo .diagnosis").text("-").attr("title","-")}else{if(Utils.isBlank(b.CHINESE_TRA_DIAGNOSIS)&&!Utils.isBlank(b.DiagnosisList)){$(".pill-detailInfo .diagnosis").text(b.CHINESE_TRA_DIAGNOSIS).attr("title",b.CHINESE_TRA_DIAGNOSIS)}else{if(!Utils.isBlank(b.CHINESE_TRA_DIAGNOSIS)&&Utils.isBlank(b.DiagnosisList)){$(".pill-detailInfo .diagnosis").text(b.DiagnosisList).attr("title",b.DiagnosisList)}else{$(".pill-detailInfo .diagnosis").text(b.CHINESE_TRA_DIAGNOSIS+"；"+b.DiagnosisList).attr("title",b.CHINESE_TRA_DIAGNOSIS+"；"+b.DiagnosisList)}}}$("#westDiagnosis").attr("val",b.diagnosisCode);$("#westDiagnosis").val(b.DiagnosisList);$("#chineseTraDiagnosis").val(b.CHINESE_TRA_DIAGNOSIS);$("#chineseTraDiagnosis").attr("val",b.CHINESE_DIAGNOSIS_CODE);$(".pill-detailInfo .add-date").text(Utils.timeStampToDateStr(b.MODIFY_DATE,7))},renderCourse:function(f,b){var c=this;$(".totalMoney input").attr("disabled","disabled");if(f&&f.length>0){var a=[];var d=$(".recipe-label ul").find(".checked");if(d&&d.length>1){d=$(".recipe-label ul").find(".checked:visible")[0];d=$(d).clone(true);d.attr("style","display: none;");d.attr("CourseRecipeId","");a.push(d[0])}else{d=$($(".recipe-label ul").find(".checked:hidden")[0]);d.attr("CourseRecipeId","");a.push(d[0])}var e="defaultRecipeId";if(b){e=b.find("span").text()}$.each(f,function(h,g){var j=d.clone(true);var i="疗程单"+g.recipeNo;j.attr("CourseRecipeId",g.courseRecipeId);j.find("span").text(i);j.removeClass("checked");j.attr("style","display: inline;");j.find(".delete").attr("style","display: none;");a.push(j[0]);if(e==i){b=j[0]}});$(".recipe-label ul").html(a);if(a&&a.length<=1){$(".pill-middle-info").attr("style","display: none;");$(".foot-btn").attr("style","display: none;")}else{if(b){$(b).find("span").click()}else{c.renderCourseExecutionList(f[0].courseExecutionList);c.repceStatus(f[0]);$($(".recipe-label ul :visible")[0]).addClass("checked");if($(".pill-status>i").hasClass("new")||$(".pill-status>i").hasClass("changes")){$($(".recipe-label ul :visible")[0]).find(".delete").attr("style","display: inline;")}else{$($(".recipe-label ul :visible")[0]).find(".delete").attr("style","display: none;")}$(".print").attr("courseRecipeId",f[0].courseRecipeId);$(".print").attr("title","打印疗程"+courseInvoiceGlobal.getCurCourseNum());$(".saveAs").attr("title","疗程"+courseInvoiceGlobal.getCurCourseNum()+"另存为模板")}}}else{$($(".recipe-label ul :visible")).remove();$(".add-recipe").click();$(".totalMoney input").val("0.00")}},getParam:function(){var a={};a.isDrugWithdrawal=_.find(this.medical_user_data.clinicParams,function(b){return b.parameterCode=="3010"}).parameterValue==2?false:true;a.isShowWeight=_.find(this.medical_user_data.clinicParams,function(b){return b.parameterCode=="3012"}).parameterValue==2?false:true;a.isShowFee=_.find(this.medical_user_data.clinicParams,function(b){return b.parameterCode=="3013"}).parameterValue==1?true:false;a.isStockCheck=_.find(this.medical_user_data.clinicParams,function(b){return b.parameterCode=="1010"}).parameterValue==2?false:true;a.isModifyPrice=_.find(this.medical_user_data.clinicParams,function(b){return b.parameterCode=="3020"}).parameterValue==2?false:true;return a},toDecimal4:function(a){var d=parseFloat(a);if(isNaN(d)||d<0){return"0.0000"}var d=Math.round(a*10000)/10000;var c=d.toString();var b=c.indexOf(".");if(b<0){b=c.length;c+="."}while(c.length<=b+4){c+="0"}return c},toDecimal2:function(a){var d=parseFloat(a);if(isNaN(d)||d<0){return"0.00"}var d=Math.round(a*100)/100;var c=d.toString();var b=c.indexOf(".");if(b<0){b=c.length;c+="."}while(c.length<=b+2){c+="0"}return c},calTotalPrice:function(c){var b=this;var a=0;if(c){c=_.filter(c,function(d){return d.delFlag==0});$.each(c,function(e,d){a+=d.coursePlanPrice*d.courseQty})}return b.toDecimal2(a)},renderCourseExecutionList:function(f){var e=this;f=_.filter(f,function(i){return i.delFlag==0});var b=$(".pill-list-content");var g=[];var d=b.find("#init-element");var c=0;e.showBlankTip(f,1);$.each(f,function(j,i){var k=d.clone(true);k.find(".list-number").text(i.orderNum+".").attr("title",i.orderNum);k.find(".drug-25per").text(i.courseName).attr("title",i.courseName);var l=i.coursePlanPrice+"/疗程";if(courseInvoiceGlobal.getParam().isShowFee){l="-"}k.find(".drug-20per").eq(0).text(l).attr("title",l);k.find(".drug-15per").text((i.doctorName||"未指定")).attr("doctorId",i.doctorId).attr("title",(i.doctorName||"未指定"));k.find(".drug-10per").text(i.courseQty||"-").attr("title",(i.courseQty||"-"));k.find(".drug-18per").text(i.remark||"-").attr("title",(i.remark||"-"));k.attr("courseExecutionId",i.courseExecutionId);k.attr("courseId",i.courseId);k.attr("orderNum",i.orderNum);if(i.selectFlag&&i.selectFlag==1){k.addClass("checked");c++}k.removeClass("dsn");k.removeAttr("id");g.push(k)});g.push(d.clone(true));b.find(".pill-listBox ul").html(g);if(c>0){$(".importInfo .drug-operate .delete-drug").attr("style","display: block")}else{$(".importInfo .drug-operate .delete-drug").attr("style","display: none")}var a=e.calTotalPrice(f);$(".totalMoney input").val(a);if(courseInvoiceGlobal.getParam().isShowFee){$(".last-column .total-money").text("-")}else{$(".last-column .total-money").text(a)}var h=e.getCurCourseIndex();if(h==null){h=0}if(e.orderData&&e.orderData[h]){$(".last-column .doctorName").text(e.orderData[h].doctorName)}},showBlankTip:function(d,a){var c=_.filter(d,function(e){return e.delFlag==0});var b=this;if(a==0){if($(".pill-status>i").hasClass("new")||$(".pill-status>i").hasClass("changes")){if(c.length<=0){$(".without-drugs").removeClass("dsn")}else{$(".without-drugs").addClass("dsn")}}else{$(".pill-list-hint").removeClass("dsn")}}else{if(a==1){if($(".pill-status>i").hasClass("new")||$(".pill-status>i").hasClass("changes")){if(c.length<=0){$(".without-drugs").removeClass("dsn")}else{$(".without-drugs").addClass("dsn")}}else{$(".pill-list-hint").removeClass("dsn")}}}},getCourseHeadInfoAction:function(e,g,d){var a=this;var c={acographyId:e,empiId:g};var b={url:ContextClinc_Server+"tcmCourse/courseHeadInfo",dataType:"json",data:c};var f=Utils.myAjaxHandler(b);f.done(function(h){if(h.errorCode==SUCCESSCODE){a.patientNo=h.data.HeadInfo.PATIENT_NO;a.patientName=h.data.HeadInfo.PATIENT_NAME;if(d){d.call(a,h.data.HeadInfo)}}})},repceStatus:function(a){var b=this;var d=a.tcmExecutionsStatus;var c=a.chargesStatus;if(d==0&&c==0){return 0}if(d!=0){if(d==1){b.changeCourseStatus(7)}else{if(d==2){b.changeCourseStatus(8)}}}else{if(c==1){b.changeCourseStatus(3)}else{if(c==2){b.changeCourseStatus(6)}else{if(c==3){b.changeCourseStatus(5)}else{if(c==4){b.changeCourseStatus(9)}}}}}},dealMutiMode:function(b){var a=this;if(2==a.treatmentState){if(b==null||b.length<=0){if(a.physiotherapy==1){if(a.historyDateList&&a.historyDateList.length>0){$("#phy-waitingState-historyRec").show()}else{$("#phy-completedNoData").show()}}else{if(a.historyDateList&&a.historyDateList.length>0){$("#treat-completedNoData-historyRec").show()}else{$("#treat-completedNoData").show()}}}else{var c=courseInvoiceGlobal.repceStatus(b[0]);if(c==0){courseInvoiceGlobal.changeCourseStatus(2)}}a.finishTreatmenMode()}else{if(1==a.treatmentState){if(b&&b.length>0){a.submittedMode()}else{if(b&&b.length==0){$(".pill-status>i").show().addClass("new")}}}else{if(0==a.treatmentState){if(b==null||b.length<=0){if(a.physiotherapy==1){if(a.historyDateList&&a.historyDateList.length>0){$("#phy-completedNoData-historyRec").show()}else{$("#phy-waitingState").show()}}else{if(a.historyDateList&&a.historyDateList.length>0){$("#treat-waitingState-historyRec").show()}else{$("#treat-waitingState").show()}}}a.unTreatmenMode()}}}$(".tab-content").show()},getCourseAction:function(e,d,a){var b=this;var g={acographyId:e};var c={url:ContextClinc_Server+"tcmCourse/getCourse",dataType:"json",method:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(g)};var f=Utils.myAjaxHandler(c);f.done(function(h){if(h!=null&&h.errorCode==SUCCESSCODE){var i=h.data;b.orderData=i;if(b.orderData&&b.orderData.length>0&&b.orderData[0].courseExecutionList&&b.orderData[0].courseExecutionList.length>0){b.finishFlag=true}b.dealMutiMode(b.orderData);if(d){if(a){d.call(b,i,a)}else{d.call(b,i)}}}else{$.paError(h.errorMessage)}}).fail(function(h){$.paError("请求失败!")}).always(function(){})},getCourseDetailList:function(d,g,c){var a=this;var f={acographyId:d,CourseRecipeId:g};var b={url:ContextClinc_Server+"tcmCourse/list",dataType:"json",method:"POST",contentType:"application/json; charset=utf-8",data:JSON.stringify(f),showMask:true};var e=Utils.myAjaxHandler(b);e.done(function(h){if(h!=null&&h.errorCode==SUCCESSCODE){var i=h.data;if(c){c.call(a,i)}}else{$.paError(h.errorMessage)}}).fail(function(h){$.paError("请求失败!")}).always(function(){})},initCourseThinkbox:function(){var a=this;var c={canedit:true,columns:[{display:"编码",dataKey:"COURSE_PLAN_CODE",width:60},{display:"名称",dataKey:"COURSE_PLAN_NAME",width:230},{display:"单价",dataKey:"COURSE_PLAN_PREFERENTIAL_PRICE",width:40}],extraParams:{key:"searchText",limitRows:20},selectFirst:true,formatResult:function(e){return},formatMatch:function(g,f,e){return g.COURSE_PLAN_NAME+"--"+g.COURSE_PLAN_CODE+"--"+g.PY_CODE+"--"+g.WB_CODE},matchContains:"word",autoFill:false,width:400,multiple:false,multipleSeparator:", ",highlight:function(f,e){return f.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+e.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:180};if(a.getParam().isShowFee){var d=[{display:"编码",dataKey:"COURSE_PLAN_CODE",width:60},{display:"名称",dataKey:"COURSE_PLAN_NAME",width:230}];c.columns=d;$(".totalMoney").hide();$(".fillOut li .total-money").eq(0).text("-")}var b=ContextClinc_Server+"tcmCourse/selectDwsCnCoursePlanListWithThink";$(".importInfo .thinkBoxInputArea").autocomplete(b,c).result(function(e,g,f){if(g){$(".drug-input .drugName-input-info").find("span").eq(0).text(g.COURSE_PLAN_PREFERENTIAL_PRICE);$(".drug-input .drugName-input-info").find("span").eq(1).text(g.COURSE_PLAN_TOTAL_TIMES);$(".drug-input .drugName-input-info").find("span").eq(2).text(g.COURSE_PLAN_EXECRATE);$(this).val(g.COURSE_PLAN_NAME);$(this).attr("COURSE_PLAN_ID",g.COURSE_PLAN_ID);$(this).attr("COURSE_PLAN_CODE",g.COURSE_PLAN_CODE);$(this).attr("COURSE_PLAN_EXECRATE",g.COURSE_PLAN_EXECRATE);$(this).attr("COURSE_PLAN_PREFERENTIAL_PRICE",g.COURSE_PLAN_PREFERENTIAL_PRICE);$(this).attr("COURSE_PLAN_TOTAL_PRICE",g.COURSE_PLAN_TOTAL_PRICE);$(this).attr("COURSE_PLAN_TOTAL_TIMES",g.COURSE_PLAN_TOTAL_TIMES);$(this).attr("COURSE_PLAN_TYPE",g.COURSE_PLAN_TYPE);if(g.DOCTOR_ID){$(".excutorName").SetWJZSDropdownSelectedData(g.DOCTOR_ID)}}})},clearCourseInput:function(){var a=this;$(".drug-input .drugName-input-info").find("span").eq(0).text("0.00");$(".drug-input .drugName-input-info").find("span").eq(1).text("0");$(".drug-input .drugName-input-info").find("span").eq(2).text("0");var b=$(".importInfo .thinkBoxInputArea ");b.val("");b.removeAttr("disabled");b.attr("COURSE_PLAN_ID","");b.attr("COURSE_PLAN_CODE","");b.attr("COURSE_PLAN_EXECRATE","");b.attr("COURSE_PLAN_PREFERENTIAL_PRICE","");b.attr("COURSE_PLAN_TOTAL_PRICE","");b.attr("COURSE_PLAN_TOTAL_TIMES","");b.attr("COURSE_PLAN_TYPE","");$(".excutorName-drop input").val("未指定");$(".excutorName-drop input").attr("val","");$(".drug-dosage input").val("");$(".remark-advice input").val("")},getCourseExecutionData:function(f){var a=this;var c=$(".importInfo .thinkBoxInputArea ");var d=$(".drug-dosage input").val()==""?0:$(".drug-dosage input").val();var e=c.attr("COURSE_PLAN_TOTAL_PRICE")==""?0:c.attr("COURSE_PLAN_TOTAL_PRICE");var b={courseExecutionId:"",acographyId:f.acographyId,clinicId:f.medical_user_data.clinic.clinicId,courseId:c.attr("COURSE_PLAN_ID"),courseName:c.val(),coursePlanPrice:c.attr("COURSE_PLAN_PREFERENTIAL_PRICE"),coursePlanTotalTimes:c.attr("COURSE_PLAN_TOTAL_TIMES"),coursePlanExecrate:c.attr("COURSE_PLAN_EXECRATE"),coursePrice:parseFloat(e)*parseFloat(d),empiId:f.empiId,patientNo:f.patientNo,patientName:f.patientName,doctorId:$(".excutorName-drop input").attr("val"),doctorName:$(".excutorName-drop input").val(),courseQty:$(".drug-dosage input").val(),courseCount:parseInt(c.attr("COURSE_PLAN_TOTAL_TIMES"))*parseInt(d),courseExecutedCount:0,chargeStatus:0,isExecute:0,orderNum:a.getOrderNum(f.orderData),remark:$(".remark-advice input").val(),courseCode:c.attr("COURSE_PLAN_CODE"),delFlag:0};return b},getCurCourseNum:function(){var c=$(".recipe-label .recipe-label-item:visible");var a=_.filter(c,function(d){return $(d).hasClass("checked")})[0];var b=parseInt($(a).text().split("疗程单")[1].trim());return b},getCurCourseIndex:function(){var a=$(".recipe-label li:visible");var b=null;$.each(a,function(c,d){if($(d).hasClass("checked")){b=c}});return b},getOrderNum:function(e,f){var b=this;var c=b.getCurCourseIndex();var d=e[c];var a=_.filter(d.courseExecutionList,function(g){return g.delFlag==0});if(f==null){return a.length+1}else{if(f==1){if(a.length==0){return 1}return parseInt(a[a.length-1].orderNum)+1}}},initChiefComThinkInput:function(){var c={canedit:true,columns:[{display:"编码",dataKey:"DICT_DIAGNOSIS_CODE",width:60},{display:"名称",dataKey:"DICT_DIAGNOSIS_NAME",width:230}],extraParams:{key:"keyword",pageSize:20,diagonsisType:"0",isJoinMI:courseInvoiceGlobal.isYbReg==1?1:0,},selectFirst:true,formatResult:function(d){return},formatMatch:function(f,e,d){return f.DICT_DIAGNOSIS_NAME+"--"+f.DICT_DIAGNOSIS_CODE+"--"+f.PY_CODE+"--"+f.WB_CODE},matchContains:"word",autoFill:false,width:485,max:100,multiple:false,multipleSeparator:", ",highlight:function(e,d){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+d.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:180};var a={canedit:true,columns:[{display:"编码",dataKey:"DICT_DIAGNOSIS_CODE",width:60},{display:"名称",dataKey:"DICT_DIAGNOSIS_NAME",width:230}],extraParams:{key:"keyword",pageSize:20,diagonsisType:"1"},selectFirst:true,formatResult:function(d){return},formatMatch:function(f,e,d){return f.DICT_DIAGNOSIS_NAME+"--"+f.DICT_DIAGNOSIS_CODE+"--"+f.PY_CODE+"--"+f.WB_CODE},matchContains:"word",autoFill:false,width:485,max:100,multiple:false,multipleSeparator:", ",highlight:function(e,d){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+d.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:180};var b=ContextClinc_Server+"dwsCnMedical/getMdcDictChiefComplaint";document.getElementById("westDiagnosis").oninput=function(){$("#westDiagnosis").attr("val","")};document.getElementById("chineseTraDiagnosis").oninput=function(){$("#chineseTraDiagnosis").attr("val","")};$("#westDiagnosis").autocomplete(b,c).result(function(d,f,e){$("#westDiagnosis").val(f.DICT_DIAGNOSIS_NAME);$("#westDiagnosis").attr("val",f.DICT_DIAGNOSIS_CODE)});$("#chineseTraDiagnosis").autocomplete(b,a).result(function(d,f,e){$("#chineseTraDiagnosis").val(f.DICT_DIAGNOSIS_NAME);$("#chineseTraDiagnosis").removeClass("pawjzs-error");$("#chineseTraDiagnosis").attr("val",f.DICT_DIAGNOSIS_CODE)})},initExecuteDoctors:function(d,a){var b=this;if(b.clinicDoctors.length<=0){var c={method:"GET",url:ContextClinc_Server+"tcmCourse/queryClinicDoctors",dataType:"json",async:false,data:{}};var e=Utils.myAjaxHandler(c);e.done(function(g){if(g.errorCode==SUCCESSCODE){var f={EMPLOYEE_MOBILE:"",EMPLOYEE_NAME:"未指定",USER_ID:"未指定"};b.clinicDoctors.push(f);if(!g.data||g.data.length<=0){}else{b.clinicDoctors=b.clinicDoctors.concat(g.data)}if(d){b.setDocDropdown(d,a)}}}).fail(function(f){}).always(function(){})}else{if(d){b.setDocDropdown(d,a)}}},setDocDropdown:function(c,a){var b=this;var d={idKey:"USER_ID",txtKey:"EMPLOYEE_NAME",isNeedClear:false};var e=c;if(b.clinicDoctors&&b.clinicDoctors.length>0){e.WJZSDropdown(b.clinicDoctors,d,function(f,g){});if(a){e.SetWJZSDropdownSelectedData(a)}else{e.SetWJZSDropdownSelectedData("未指定")}$(".china-doctorName").WJZSDropdown(b.clinicDoctors,d,function(f,g){});$(".china-doctorName").SetWJZSDropdownSelectedData(a);if(!$(".china-doctorName").val()){if(b.medical_user_data.doctor){$(".china-doctorName").SetWJZSDropdownSelectedData(b.medical_user_data.userId)}else{$(".china-doctorName").siblings("ul").find("li").eq(0).click()}}}else{if(b.medical_user_data.doctor){$(".china-doctorName").val(b.medical_user_data.doctor.doctorAccount);$(".china-doctorName").attr("val",b.medical_user_data.doctor.doctorId)}else{$(".china-doctorName").val(b.medical_user_data.userName);$(".china-doctorName").attr("val",b.medical_user_data.userId)}}},saveCnMedical:function(){var b=this;var e=b.getWestDiagnosis();var a=$("#chineseTraDiagnosis").val();var d=$("#chineseTraDiagnosis").attr("val");var f={medicalId:$(".diagnosis:visible").attr("cn_medical_id"),acographyId:b.acographyId,empiId:b.empiId,chineseTraDiagnosis:a,chineseDiagnosisCode:d!=null?d:"",dwsDiagnosisRecordList:e};var c={url:ContextClinc_Server+"TCMPrescription/saveCnMedical",dataType:"json",data:JSON.stringify(f),showMask:true,contentType:"application/json; charset=utf-8"};var g=Utils.myAjaxHandler(c);g.done(function(i){if(i.errorCode==SUCCESSCODE){$.paSuccess("保存成功！");var h=b.empiId;h.CHINESE_TRA_DIAGNOSIS=a;h.CHINESE_DIAGNOSIS_CODE=d;if(e&&e.length>0){if(null!=e[0].diagnosis){a+="；"+e[0].diagnosis;h.DiagnosisList=e[0].diagnosis}else{h.DiagnosisList=e[0].diagnosisIcd10;h.diagnosisCode=e[0].diagnosisIcd10Code;a+="；"+e[0].diagnosisIcd10}}else{h.DiagnosisList="";$("#westDiagnosis").removeAttr("val")}$(".diagnosis").text(a||"-").attr("title",(a||"-"));$("#addDiagnosisPop").addClass("dsn")}else{$.paError(i.errorCode+"：诊断信息保存失败！")}})},getWestDiagnosis:function(){var e=[];var b=$("#westDiagnosis").attr("val");var c=$("#westDiagnosis").val();if(c!=null&&c!=undefined&&c!=""){if(b!=null&&b!=undefined){var d={};d.diagnosisIcd10=$("#westDiagnosis").val();d.diagnosisIcd10Code=$("#westDiagnosis").attr("val");e.push(d)}else{var a={};a.diagnosis=c;e.push(a)}}return e},getDocName:function(c){var a=this;var b=_.filter(a.clinicDoctors,function(d){return d.USER_ID==c});if(b&&b.length>0){return b[0].EMPLOYEE_NAME}return null},getdoctorName:function(b){var a=_.filter(courseInvoiceGlobal.clinicDoctors,function(c){return c.USER_ID==b});if(a&&a.length>0){return a[0].EMPLOYEE_NAME}},qutoTemplateDetail:function(a,c){var b=this;$.each(a,function(d,e){e.acographyId=courseInvoiceGlobal.acographyId;e.empiId=courseInvoiceGlobal.empiId;e.patientName=courseInvoiceGlobal.patientName;e.patientNo=courseInvoiceGlobal.patientNo;e.chargeStatus=0;e.clinicId=courseInvoiceGlobal.clinicId;e.delFlag=0;e.courseCount=e.courseQty*e.coursePlanTotalTimes;e.courseExecutedCount=0;e.isExecute=0;e.doctorName=b.getdoctorName(e.doctorId);e.doctorId=e.doctorId;e.orderNum=courseInvoiceGlobal.getOrderNum(courseInvoiceGlobal.orderData,1);c.courseExecutionList.push(e)});$(".recipe-label ul .checked:visible").find("span").click()},qutoTemplate:function(){var a=$(this).attr("courseTmplId");if($(".updateCouresMode").is(":hidden")){courseInvoiceGlobal.getCourseTmplItemById(a,function(b){var f=courseInvoiceGlobal.getCurCourseIndex();var d=courseInvoiceGlobal.orderData[f];var c=_.filter(d.courseExecutionList,function(g){return g.delFlag==0});if(c.length==0){courseInvoiceGlobal.qutoTemplateDetail(b,d)}else{var e=courseInvoiceGlobal.addRecipe();if(e){var f=courseInvoiceGlobal.getCurCourseIndex();var d=courseInvoiceGlobal.orderData[f];courseInvoiceGlobal.qutoTemplateDetail(b,d)}}})}else{$.paWarn("当前状态不可编辑");return}},qutoHisDetail:function(b,d,c){var a=this;$.each(b,function(f,g){if(g.courseRecipeId==d){var e=[];$.each(g.courseExecutionList,function(i,h){e.push(h.courseId)});a.batchGetCoursePlanIdAction(e,function(h){$.each(h,function(j,i){$.each(g.courseExecutionList,function(l,m){if(i.disabled==0&&i.coursePlanId==m.courseId){m.disable=i.disabled;m.courseName=i.coursePlanName;m.coursePlanExecrate=i.coursePlanExecrate;m.coursePlanTotalTimes=i.coursePlanTotalTimes;m.coursePlanPrice=i.coursePlanPreferentialPrice;var k=$.extend({},m);k.courseExecutionId=null;k.orderNum=courseInvoiceGlobal.getOrderNum(courseInvoiceGlobal.orderData,1);k.acographyId=courseInvoiceGlobal.acographyId;k.chargeStatus=0;k.clinicId=courseInvoiceGlobal.clinicId;k.courseExecutedCount=0;k.delFlag=0;k.empiId=courseInvoiceGlobal.empiId;k.isExecute=0;k.patientName=courseInvoiceGlobal.patientName;k.doctorId=m.doctorId;k.doctorName=a.getdoctorName(m.doctorId);k.patientNo=courseInvoiceGlobal.patientNo;c.courseExecutionList.push(k)}})})})}$(".recipe-label ul .checked:visible").find("span").click()})},batchGetCoursePlanIdAction:function(c,d){var a=this;parameters={coursePlanIds:c,};var b={url:ContextClinc_Server+"tcmCourse/batchGetCoursePlanId",dataType:"JSON",async:false,type:"POST",data:JSON.stringify(parameters),contentType:"application/json;charset=utf-8",showMask:true};var e=Utils.myAjaxHandler(b);e.done(function(f){if(f!=null&&f.errorCode==SUCCESSCODE){if(d){d.call(a,f.data)}}else{$.paError(f.errorMessage)}}).fail(function(f){$.paError("查询历史就诊失败",1000)}).always(function(){})},qutoHIs:function(){if($(".updateCouresMode").is(":hidden")){var d=$(this).attr("courserecipeid");var a=$("#hisDate").attr("index");var e=courseInvoiceGlobal.historyDateList[a];var g=courseInvoiceGlobal.getCurCourseIndex();var c=courseInvoiceGlobal.orderData[g];var b=_.filter(c.courseExecutionList,function(h){return h.delFlag==0});if(b.length==0){courseInvoiceGlobal.qutoHisDetail(e.courses.courses,d,c)}else{var f=courseInvoiceGlobal.addRecipe();if(f){var g=courseInvoiceGlobal.getCurCourseIndex();var c=courseInvoiceGlobal.orderData[g];courseInvoiceGlobal.qutoHisDetail(e.courses.courses,d,c)}}}else{$.paWarn("当前状态不可编辑");return}},renderTemplateList:function(e,c){var b=this;var a=[];var d=null;$.each(e,function(f,g){d='<li class="recipe-template-item">'+g.courseTmplName+"</li>";d=$(d).attr("courseTmplId",g.courseTmplId);d.bind("click",b.qutoTemplate);a.push(d)});if(c==courseInvoiceGlobal.templateTypeEnum.PERSONAL){$("#china-tmpl-doctor-ul").html(a)}else{if(c==courseInvoiceGlobal.templateTypeEnum.CLINIC){$("#china-tmpl-clinic-ul").html(a)}}},getCourseTmplAction:function(c,d){var a=this;if(c==courseInvoiceGlobal.templateTypeEnum.PERSONAL&&a.template.personal.length>0){if(d){d.call(a,a.template.personal,c)}return}else{if(c==courseInvoiceGlobal.templateTypeEnum.CLINIC&&a.template.clinic.length>0){if(d){d.call(a,a.template.clinic,c)}return}}var b={url:ContextClinc_Server+"/courseManage/dwsCnCourseTmpl/selectDwsCnCourseTmplList",dataType:"JSON",contentType:"application/json;charset=utf-8",type:"POST",showMask:true,data:JSON.stringify({delFlag:0,courseTmplType:c})};var e=Utils.myAjaxHandler(b);e.done(function(f){if(f&&f.errorCode==SUCCESSCODE){if(c==courseInvoiceGlobal.templateTypeEnum.PERSONAL){a.template.personal=f.data}else{if(c==courseInvoiceGlobal.templateTypeEnum.CLINIC){a.template.clinic=f.data}}if(d){d.call(a,f.data,c)}}else{$.paError(f.errorMessage)}}).fail(function(f){$.paError("操作失败!")}).always(function(){})},getCourseTmplItemById:function(c,d){var a=this;var b={url:ContextClinc_Server+"tcmCourse/selectDwsCnCourseTmplItemByCTID",type:"POST",dataType:"JSON",data:{courseTmplId:c}};var e=Utils.myAjaxHandler(b);e.done(function(g){if(g!=null&&g.errorCode==SUCCESSCODE){var f=g.data;$(f).each(function(h,j){j.courseQty=!Utils.isBlank(j.courseQty)?1:j.courseQty;j.courseId=j.coursePlanId;j.courseCode=j.coursePlanCode;j.courseName=j.coursePlanName});if(d){d.call(a,f)}}else{$.paError(g.errorMessage)}}).fail(function(f){$.paError("操作失败!")}).always(function(){})},orderData2Template:function(d,a,e){var c=this;var f={};f.dwsCnCourseTmpl={courseTmplId:"",courseTmplName:a,clinicId:d.clinicId,doctorId:d.doctorId,userId:c.userId,departmentId:"",courseTmplType:e,};var b=[];$.each(_.filter(d.courseExecutionList,function(g){return g.delFlag==0}),function(h,i){var g={};g.courseTmplItemId="";g.courseTmplId="";g.clinicId=i.clinicId;g.doctorId=i.doctorId;g.coursePlanId=i.courseId;g.coursePlanCode=i.courseCode;g.coursePlanName=i.courseName;g.coursePlanTotalTimes=i.coursePlanTotalTimes;g.coursePlanPrice=i.coursePlanPrice;g.coursePlanExecrate=i.coursePlanExecrate;g.courseQty=i.courseQty;g.remark=i.remark;b.push(g)});f.dwsCnCourseTmplItems=b;return f},saveAsTemplate:function(c,d){var a=this;if(c.dwsCnCourseTmplItems&&c.dwsCnCourseTmplItems.length>0){var b={url:ContextClinc_Server+"/courseManage/dwsCnCourseTmpl/saveOrUpdateDwsCnCourseTmplInfo",dataType:"JSON",type:"POST",data:JSON.stringify(c),contentType:"application/json;charset=utf-8"};var e=Utils.myAjaxHandler(b);e.done(function(f){if(f!=null&&f.errorCode==SUCCESSCODE){$.paSuccess("模板保存成功");if(d){d.call(a,f.data)}}else{$.paError(f.errorMessage)}}).fail(function(f){$.paError("模板保存失败",1000)}).always(function(){})}else{$.paError("请添加诊疗数据再保存模板")}},searchTemplate:function(b){var a=this;var d=_.filter(a.template.personal,function(e){return e.courseTmplName.indexOf(b)>=0});var c=_.filter(a.template.clinic,function(e){return e.courseTmplName.indexOf(b)>=0});a.renderTemplateList(d,courseInvoiceGlobal.templateTypeEnum.PERSONAL);$("#china-tmpl-doctor-dl").addClass("collapse").next("li").removeClass("dsn");a.renderTemplateList(c,courseInvoiceGlobal.templateTypeEnum.CLINIC);$("#china-tmpl-clinic-dl").addClass("collapse").next("li").removeClass("dsn");if(d==null||d.length<=0){$("#china-tmpl-doctor-dl").removeClass("collapse").next("li").addClass("dsn")}if(c==null||c.length<=0){$("#china-tmpl-clinic-dl").removeClass("collapse").next("li").addClass("dsn")}},selecCourseHistoryDateListAction:function(c){var a=this;parameters={acographyId:a.acographyId,empiId:a.empiId};var b={url:ContextClinc_Server+"tcmCourse/selecCourseHistoryDateList",dataType:"JSON",type:"POST",data:JSON.stringify(parameters),async:false,contentType:"application/json;charset=utf-8"};var d=Utils.myAjaxHandler(b);d.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){if(c){a.historyDateList=e.data;$.each(a.historyDateList,function(f,g){g.ADDDATE=Utils.timeStampToDateStr(g.ADDDATE,7)});c.call(a,e.data)}}else{$.paError(e.errorMessage)}}).fail(function(e){$.paError("历史查询失败",1000)}).always(function(){})},cacheHistoryDateList:function(c,b){var a=this;$.each(a.historyDateList,function(d,e){if(e.ACOGRAPHYID==c){e.courses=b}})},getCourseHisByAcographyIdAction:function(d,f,h,c,e){var a=this;parameters={acographyId:f,empiId:h,isGetNewDictFlag:"Y",clinicId:c};var b={url:ContextClinc_Server+"tcmCourse/getCourseHisByAcographyId",dataType:"JSON",async:false,type:"POST",data:JSON.stringify(parameters),contentType:"application/json;charset=utf-8",showMask:true};var g=Utils.myAjaxHandler(b);g.done(function(i){if(i!=null&&i.errorCode==SUCCESSCODE){a.cacheHistoryDateList(f,i.data);if(e){e.call(a,d,i.data)}}else{$.paError(i.errorMessage)}}).fail(function(i){$.paError("查询历史就诊失败",1000)}).always(function(){})},selectHisByDate:function(b,d,c,a){courseInvoiceGlobal.getCourseHisByAcographyIdAction(b,d,c,a,courseInvoiceGlobal.renderHisCourse)},showDefaultVal:function(a){return !Utils.isBlank(a)?"-":a},renderHisCourse:function(e,f){var c=this;if(f.courses==null||f.courses.length<=0){$(".noDataHint").show();$(".historyRecipe").hide();return}$("#hisDate").val(e);$(".historyRecipe .wjzs-drop-menu").attr("style","display: none; top: 28px;");if(c.medical_user_data.clinicId!=f.clinic.clinicId){$(".historyRecipe-project .historyRecipe-Info .historyStores").show().attr("title","分店名称:"+c.showDefaultVal(f.clinic.clinicName)).text(c.showDefaultVal(f.clinic.clinicName))}else{$(".historyRecipe-project .historyRecipe-Info .historyStores").hide()}if(f.empi.doctorName){$(".historyRecipe-project .historyRecipe-Info .doctorName").show().attr("title","接诊医生:"+c.showDefaultVal(f.empi.doctorName)).text(c.showDefaultVal(f.empi.doctorName))}else{$(".historyRecipe-project .historyRecipe-Info .doctorName").hide()}if(1==f.acography.treatmentType){$(".historyRecipe-project .historyRecipe-Info .treatmentType").text("初诊")}else{if(2==f.acography.treatmentType){$(".historyRecipe-project .historyRecipe-Info .treatmentType").text("复诊")}else{$(".historyRecipe-project .historyRecipe-Info .treatmentType").text("-")}}$("#hisDiagnosis").text(c.showDefaultVal(f.empi.CHINESE_TRA_DIAGNOSIS));$("#hisDiagnosis").parent().attr("title","诊断:"+c.showDefaultVal(f.empi.CHINESE_TRA_DIAGNOSIS));if(f.courses&&f.courses.length>0){var a=null;if(c.$courseExecutionList){a=c.$courseExecutionList}else{a=$(".historyRecipe-project .historyDetail .historyDetail-item");c.$courseExecutionList=a}var d=[];$.each(f.courses,function(i,g){var j=a.clone();if(g.courseExecutionList!=null&&g.courseExecutionList.length>0){j.show().find(".prescription-title").text("疗程单 "+g.recipeNo);var h=[];$.each(g.courseExecutionList,function(m,k){var l='<li class="historyDetail-content-row"><span>'+(k.orderNum)+'.</span> <span class="projectName">'+(k.courseName||"")+"</span><span>"+(k.remark||"")+"</span> </li>";h.push(l)});j.find(".historyDetail-content-list").html(h).show();if(c.medical_user_data.clinicId!=g.clinicId){j.find(".history-quote").hide()}else{j.find(".history-quote").show();j.find(".history-quote").find(".normal-btn").attr("style","");j.find(".history-quote span").attr("courseRecipeId",g.courseRecipeId);j.find(".history-quote span").bind("click",c.qutoHIs)}d.push(j)}});$(".historyRecipe-project .historyDetail").html(d);var b=$(".historyDetail .historyDetail-head>i").eq(0);if(!$(b).hasClass("collapse")){b.click()}if(1!=c.treatmentState){$(".history-quote").hide()}}},finishTreatmenMode:function(){$(".topNav").addClass("treat-completedState");$(".importInfo").addClass("dsn");$(".pill-bottom-info").removeClass("dsn");$(".recipe-info").remove();$(".saveCoures").remove();$(".add-recipe").remove();$(".recipe-label").find(".delete").remove();$(".editorBtn").hide();$(".pill-listBox .close-order-list").remove();$(".historyDetail .normal-btn").remove()},unTreatmenMode:function(){$(".topNav").addClass("treat-completedState");$(".importInfo").addClass("dsn");$(".pill-bottom-info").removeClass("dsn");$(".recipe-info").remove();$(".saveCoures").remove();$(".add-recipe").remove();$(".recipe-label").find(".delete").remove();$(".editorBtn").hide();$(".pill-listBox .close-order-list").remove();$(".historyDetail .normal-btn").remove()},readOnlyMode:function(){$(".importInfo").addClass("dsn");$(".pill-bottom-info").removeClass("dsn");$(".recipe-info").hide();$(".recipe-label").find(".delete").hide().attr("class","delete_Save");$(".editorBtn").hide();$(".pill-listBox .close-order-list").text("");if($(".updateCouresMode").is(":hidden")){$(".historyDetail .normal-btn").show()}else{$(".historyDetail .normal-btn").hide()}},submittedMode:function(){var a=this;$(".importInfo").addClass("dsn");$(".pill-bottom-info").removeClass("dsn");$(".editorBtn").hide();$(".recipe-label").find(".delete").hide().attr("class","delete_Save");$(".pill-listBox .close-order-list").text("");$(".historyDetail .normal-btn").hide();$(".add-recipe").hide();$(".recipe-info").hide();$(".saveCoures").hide();$(".updateCouresMode").show();$(".pill-list-hint").removeClass("dsn");a.changeCourseStatus(2)},change2AddMode:function(){$(".importInfo").removeClass("dsn");$(".pill-bottom-info").addClass("dsn");$(".editorBtn").show();$(".recipe-label .checked:visible").find(".delete_Save").attr("style","display:inline;").attr("class","delete");$(".pill-listBox .close-order-list").text("×");$(".historyDetail .normal-btn").show();$(".add-recipe").show();$(".recipe-info").show();$(".saveCoures").show();$(".updateCouresMode").hide();if($(".pill-status>i").hasClass("changes")){}else{courseInvoiceGlobal.changeCourseStatus(0)}},changesMode:function(){var a=this;a.finishFlag=false;if($(".pill-status>i").hasClass("submitted")||$(".pill-status>i").hasClass("new")){$(".importInfo").removeClass("dsn");$(".pill-bottom-info").addClass("dsn");$(".editorBtn").show();$(".recipe-label .checked:visible").find(".delete_Save").attr("style","display:inline;").attr("class","delete");$(".pill-listBox .close-order-list").text("×");$(".historyDetail .normal-btn").show();$(".add-recipe").show();$(".recipe-info").show();$(".saveCoures").show();$(".updateCouresMode").hide();$(".pill-list-hint").addClass("dsn");a.changeCourseStatus(1)}else{$(".add-recipe").show();$(".saveCoures").show();$(".updateCouresMode").hide()}$(".historyDetail .normal-btn").show()},initkeyBoardEvent:function(){$(".importInfo").paKeyHandle({necessary:true,clz:"enterNext"});$(".importInfo").keypress(function(c){var a=$(".description:visible").is(":focus");if(a&&c.which==13){var b=$(".drug-input:visible").find(".update-drug");if(b.is(":visible")){$(b).click()}else{$(".add-drug:visible").click()}}})},initCourseDwsStation:function(){var a=this;if(courseInvoiceGlobal.physiotherapy==1){$(".content-inner").addClass("pt55");$(".static-menu").show();$(".static-menu>ul>li").on("click",function(){var d=$(this).index();if(d==0){var c=new Array();c.push({paramName:"empiId",paramValue:a.empiId});c.push({paramName:"acographyId",paramValue:a.acographyId});c.push({paramName:"treatmentState",paramValue:a.treatmentState});c.push({paramName:"triageId",paramValue:a.triageId});c.push({paramName:"recordId",paramValue:a.recordId});c.push({paramName:"sex",paramValue:a.sex});c.push({paramName:"isYbReg",paramValue:a.isYbReg});c.push({paramName:"physiotherapy",paramValue:1});var b="../tcm/physiotherapy.html";a.jumpToAnotherPage(c,b)}else{var c=new Array();c.push({paramName:"empiId",paramValue:a.empiId});c.push({paramName:"acographyId",paramValue:a.acographyId});c.push({paramName:"treatmentState",paramValue:a.treatmentState});c.push({paramName:"triageId",paramValue:a.triageId});c.push({paramName:"recordId",paramValue:a.recordId});c.push({paramName:"sex",paramValue:a.sex});c.push({paramName:"isYbReg",paramValue:a.isYbReg});c.push({paramName:"physiotherapy",paramValue:1});var b="../tcm/courseInvoice.html";a.jumpToAnotherPage(c,b)}});if(a.treatmentState==2){$(".static-menu-finish").html("重新开单");$("#choose_tmpl_btn").hide()}$(".static-menu-finish").on("click",function(){var b=$(this).text();if(b=="完成开单"){if(!a.finishFlag){$.paAlert("请先保存！");return}$.paConfirm({msg:"是否确定完成开单？",cancelTxt:"取消",saveTxt:"确认",onYes:function(){a.savePhysicalTherapyState()}})}else{a.getDwsAcographyById(function(d){var e=d.modifyDate;var c=new Date();if(c<=e+86400000){a.reSavePhysicalTherapyState()}else{$.paAlert("完成开单已超过24小时，不能重新开单！")}})}})}},jumpToAnotherPage:function(d,a){if(d.length<=0){return a}var c="?";for(var b in d){c+=d[b].paramName+"="+d[b].paramValue+"&"}location.href=a+c},savePhysicalTherapyState:function(){var a=this;var d={dwsAcography:{recordId:a.recordId,triageId:a.triageId,acographyId:a.acographyId}};var b={url:ContextClinc_Server+"physicalTherapy/savePhysicalTherapyState",dataType:"json",contentType:"application/json",data:JSON.stringify(d),showMask:true,async:true};var c=Utils.myAjaxHandler(b);c.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){if(Utils.notBlank(e.data.openId)){a.sendWEIXINMessage(e.data)}$.paSuccess("开单已完成!");location.href="../tcm/workstationIndex.html"}else{$.paError(e.errorMessage)}}).fail(function(e){$.paError("操作失败!")}).always(function(){})},reSavePhysicalTherapyState:function(){var a=this;var c={dwsAcography:{empiId:a.empiId,recordId:a.recordId,triageId:a.triageId,acographyId:a.acographyId}};var d={url:ContextClinc_Server+"physicalTherapy/reSavePhysicalTherapyState",dataType:"json",data:JSON.stringify(c),contentType:"application/json",showMask:true};var b=Utils.myAjaxHandler(d);b.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){self.treatmentState=1;$.paSuccess("重新开单成功!");$(".static-menu-finish").html("完成开单");var g=new Array();g.push({paramName:"empiId",paramValue:a.empiId});g.push({paramName:"acographyId",paramValue:a.acographyId});g.push({paramName:"treatmentState",paramValue:1});g.push({paramName:"triageId",paramValue:a.triageId});g.push({paramName:"recordId",paramValue:a.recordId});g.push({paramName:"sex",paramValue:a.sex});g.push({paramName:"isYbReg",paramValue:a.isYbReg});g.push({paramName:"physiotherapy",paramValue:1});var f="../tcm/courseInvoice.html";a.jumpToAnotherPage(g,f)}else{$.paError(e.errorMessage)}}).fail(function(e){$.paError("重新开单失败!")})},sendWEIXINMessage:function(e){if(e){var g=Utils.trimObj(e.clinicName);var b=Utils.trimObj(e.addressName);var a=Utils.trimObj(e.visitName);var c=Utils.trimObj(e.openId);var h=Utils.trimObj(e.acographySerialNum);var i=Utils.trimObj(e.payMoney);var d=Utils.trimObj(e.addDate);if(g&&b&&h&&i&&a&&d&&c){var f={clinicName:g,addressName:b,acographySerialNum:h,payMoney:i,visitName:a,addDate:d,openId:c};var k={type:"POST",contentType:"application/json; charset=utf-8",url:WXServicePath+"TempNoPay",data:JSON.stringify(f),dataType:"json"};var j=Utils.myAjaxHandler(k);j.done(function(l){if(l){}}).fail(function(l){}).always(function(){})}}},getDwsAcographyById:function(c){var a={url:ContextClinc_Server+"tcmPhysiotherapy/getDwsAcographyById?acographyId="+this.acographyId,dataType:"json",contentType:"application/json",data:JSON.stringify({}),showMask:true,async:false};var b=Utils.myAjaxHandler(a);b.done(function(d){if(d!=null&&d.errorCode==SUCCESSCODE){if(c&&typeof c==="function"){c(d.data)}}else{$.paError(d.errorMessage)}}).fail(function(d){$.paError("操作失败!")}).always(function(){})}};var courseInvoiceGlobal=new CourseInvoice();$(function(){courseInvoiceGlobal.main()});