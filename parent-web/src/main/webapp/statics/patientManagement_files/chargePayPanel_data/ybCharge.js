var ybClinicId;var ybOperatorId;var ybOperatorName;var ybChargeObj;$(function(){ybChargeObj=new ybCharge()});function ybCharge(a){this.ybReimburseObj=new ybReimburse();this.bizData=a}ybCharge.prototype={constructor:ybCharge,uploadYBFee:function(e){var a=this;var d=this.getYBBaseInfo();var b=a.getPageFeeList();var c={ybBizRecord:{acographyId:a.bizData.acographyId},bizItems:b};a.getYBFeeRecord(c,function(j){var h=j.ybItemNo;var i=j.ybBizRecord;if(!i||i.bizState!=2){$.paWarn("此人未进行医保登记！",null);return}var f=[];$.each(b,function(n,m){var l="clinicbm"+n;var o={no:n,mc:m.itemName,gg:m.itemSpec||m.itemUnit||"次",dw:m.itemUnit||"次",dj:m.itemPrice,sl:m.itemAmount,hjje:fixByRound(m.itemMoney,2)||0,yljgnbbm:l,tybm:null,jsxm:null,};m.clinicItemId=l;$.each(j.items,function(p,q){if(m.itemId==q.itemId){o.yljgnbbm=q.clinicItemId;o.tybm=q.ybItemId;o.jsxm=q.ybSettleCode;m.clinicItemId=q.clinicItemId;m.ybItemId=q.ybItemId;m.ybSettleCode=q.ybSettleCode}});f.push(o)});var g=a.mergeFeeItem(f);var k={yljgbm:d.ybClinicId,mzlsh:i.ybAcographyId,djh:h,mzfys:g,czybm:d.ybOperatorId,czyxm:d.ybOperatorName,};a.ybReimburseObj.ybFYUpload(k,function(n){var p=a.resolveYBReimburseInfo(n);$.each(b,function(r,q){q.ybItemNo=h});var l=null;var m="{";$.each(n.theMZJS,function(t,s){var r=s.JSXM;var q=s.JE;switch(r){case"czf":m+=('"上年门诊超支":"'+q+'",');break;case"Az":m+=('"挂号费":"'+q+'",');break;case"B":m+=('"床位费":"'+q+'",');break;case"Bd":m+=('"补充床位费":"'+q+'",');break;case"Bz":m+=('"超床位费":"'+q+'",');break;case"C":m+=('"诊查费":"'+q+'",');break;case"Cd":m+=('"补充诊查费":"'+q+'",');break;case"Cz":m+=('"自费诊查费":"'+q+'",');break;case"D":m+=('"检查费":"'+q+'",');break;case"Dd":m+=('"补充检查费":"'+q+'",');break;case"Dt":m+=('"特殊检查费":"'+q+'",');break;case"Dz":m+=('"自费检查费":"'+q+'",');break;case"E":m+=('"治疗费":"'+q+'",');break;case"Ed":m+=('"补充治疗费":"'+q+'",');break;case"Et":m+=('"特殊治疗费":"'+q+'",');break;case"Ez":m+=('"自费治疗费":"'+q+'",');break;case"F":m+=('"护理费":"'+q+'",');break;case"Fd":m+=('"补充护理费":"'+q+'",');break;case"Fz":m+=('"自费护理费":"'+q+'",');break;case"G":m+=('"手术费":"'+q+'",');break;case"Gt":m+=('"特检手术费":"'+q+'",');break;case"Gz":m+=('"自费手术费":"'+q+'",');break;case"GH":m+=('"挂号费用合计":"'+q+'",');break;case"GHF":m+=('"挂号费":"'+q+'",');break;case"GHZJ":m+=('"诊金":"'+q+'",');break;case"H":m+=('"化验费":"'+q+'",');break;case"Hd":m+=('"补充化验费":"'+q+'",');break;case"Ht":m+=('"特检化验费":"'+q+'",');break;case"Hz":m+=('"自费化验费":"'+q+'",');break;case"I":m+=('"其他费":"'+q+'",');break;case"Id":m+=('"补充其它费":"'+q+'",');break;case"Iz":m+=('"其他自费":"'+q+'",');break;case"Jc":m+=('"国产特材":"'+q+'",');break;case"Jc1":m+=('"少儿国产特材":"'+q+'",');break;case"Jc1z":m+=('"少儿国产特材自费部分":"'+q+'",');break;case"Jgc":m+=('"千元以上国产材料":"'+q+'",');break;case"Jgc1":m+=('"少儿千元以上国产材料":"'+q+'",');break;case"Jgc1z":m+=('"少儿千元以上国产材料自费部分":"'+q+'",');break;case"Jjk":m+=('"千元以上进口材料":"'+q+'",');break;case"Jjk1":m+=('"少儿千元以上进口材料":"'+q+'",');break;case"Jjk1z":m+=('"少儿千元以上进口材料自费部分":"'+q+'",');break;case"Jkc":m+=('"进口特材":"'+q+'",');break;case"Jkc1":m+=('"少儿进口特材":"'+q+'",');break;case"Jkc1z":m+=('"少儿进口特材自费部分":"'+q+'",');break;case"Jz":m+=('"自费特殊材料费":"'+q+'",');break;case"K1":m+=('"一般医用材料费":"'+q+'",');break;case"K1d":m+=('"补充材料费":"'+q+'",');break;case"K1z":m+=('"自费一般医用材料费":"'+q+'",');break;case"K2":m+=('"手术材料费":"'+q+'",');break;case"K2d":m+=('"补充手术费":"'+q+'",');break;case"K2z":m+=('"自费手术材料费":"'+q+'",');break;case"K3":m+=('"手术特殊设备仪器":"'+q+'",');break;case"K3z":m+=('"自费手术特殊设备仪器":"'+q+'",');break;case"L":m+=('"输血费":"'+q+'",');break;case"Ld":m+=('"补充输血费":"'+q+'",');break;case"Lz":m+=('"自费输血费":"'+q+'",');break;case"M":m+=('" 一般诊疗费":"'+q+'",');break;case"Zz":m+=('"目录外自费":"'+q+'",');break;case"1":m+=('"西药费":"'+q+'",');break;case"1d":m+=('"补充西药费":"'+q+'",');break;case"1z":m+=('"自费西药费":"'+q+'",');break;case"2":m+=('"中成药费":"'+q+'",');break;case"2z":m+=('"自费中成药费":"'+q+'",');break;case"3":m+=('"中草药费":"'+q+'",');break;case"3d":m+=('"补充中药费":"'+q+'",');break;case"3z":m+=('"自费中草药费":"'+q+'",');break}});m=m.substr(0,m.length-1);m+="}";var o={ybBizRecord:{acographyId:a.bizData.acographyId,ybAcographyId:i.ybAcographyId,ybClinicId:d.ybClinicId},bizFee:{ybItemNo:h,ybPayState:0,selfPayMoney:p.zfMoney,ybPayMoney:p.ybMoney,selfYbMoney:p.personMoney,ybCatCharge:m,ybOptUser:d.ybOperatorName,ybBalanceResult:JSON.stringify(n)},bizItems:b,};a.saveYBReimburseInfo(o,function(r){var q={ybClinicId:d.ybClinicId,ybAcographyId:i.ybAcographyId,ybItemNo:h,ssj:p.zfMoney};var s={ybPayData:q,reimburseInfo:p};e(s)})})})},getPageFeeList:function(){var b=[];$(".charge-item-table .readWritItem:not(.not-item)").not(":last").each(function(){var h=$(this).attr("acographyitemid");var l=$(this).find(".input-charge-item-name").val();var i=$(this).find(".charge-item-spec").text();var j=$(this).find(".input-charge-item-total-amount").val();var g=$(this).find(".charge-item-unit").text();var k=$(this).find(".charge-item-price").text();var f=$(this).find(".charge-item-money").text();var e=$(this).find(".charge-drug-source-drop").attr("val");var d={pendItemId:null,itemId:h,itemName:l,itemSpec:i,itemUnit:g,itemPrice:k,itemAmount:j,itemMoney:f||0,drugSource:e||"0"};b.push(d)});var a=session_cache.getCache("chargeOPItems");var c=$("#acographyList").getCheckedData();$.each(a,function(d){$.each(c,function(g,i){var f=a[d].sameGroupFlag;var e=i.sameGroupFlag;if(e==f){var h={pendItemId:a[d].pendItemId,itemId:a[d].acographyItemId,itemName:a[d].acographyItemName,itemSpec:a[d].acographyItemSpec,itemUnit:a[d].acographyItemUnit,itemPrice:a[d].acographyItemPrice,itemAmount:a[d].acographyItemAmount,itemMoney:a[d].totalMoney||0,drugSource:a[d].drugSource||"0"};b.push(h)}})});return b},resolveYBReimburseInfo:function(c){var g=c.theMZJS;var f=c.theMZZF;var i=c.theMZZFJG;var h=0;var e=0;var d=0;var a=0;$.each(f,function(l,k){var m=k.ZFXM;var j=k.JE;switch(m){case"01":a=j;break;case"02":h=j;break;case"0201":e=j;break}d=accSub(h,e)});var b={personMoney:e,ybMoney:d,zfMoney:a};return b},saveYBReimburseInfo:function(c,d){var a={url:ContextClinc_Server+"ybReimburse/saveYBUploadInfo",dataType:"json",type:"POST",data:JSON.stringify(c),contentType:"application/json;charset=utf-8",showMask:true};var b=Utils.myAjaxHandler(a);b.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){d(e)}else{$.paError("保存医保的结算信息失败:",e.errorMessage)}})},payYBFee:function(c,a){var d=this.getYBBaseInfo();var b={yljgbm:d.ybClinicId,mzlsh:c.ybAcographyId,djh:c.ybItemNo,ssj:c.ssj,zsj:0,czybm:d.ybOperatorId,czyxm:d.ybOperatorName,};this.ybReimburseObj.ybPay(b,function(e){a(e)})},refundYBFee:function(c,e){var a=this;var d=this.getYBBaseInfo();var b={ybBizRecord:{acographyId:c.acographyId},bizFee:{chargeBizId:c.chargeId}};this.getYBBizItemByChargeId(b,function(k){var i=k.feeState;switch(i){case 0:break;case 1:var j=k.feeInfo;var h={ybClinicId:d.ybClinicId,ybAcographyId:j.ybAcographyId,ybItemNo:j.ybItemNo,ssj:j.selfPayMoney};var m={ybPayData:h,reimburseInfo:j};e(m);return;break}var f=[];$.each(k.items,function(o,n){var p={no:o,mc:n.itemName,gg:n.itemSpec||n.itemUnit||"次",dw:n.itemUnit||n.itemSpec||"次",dj:n.itemPrice,sl:-n.itemAmount,hjje:-n.itemMoney,yljgnbbm:n.clinicItemId,tybm:n.ybItemId,jsxm:n.ybSettleCode,};f.push(p)});var g=a.mergeFeeItem(f);var l={yljgbm:d.ybClinicId,mzlsh:k.ybAcographyId,djh:k.originItemNo,mzfys:g,djh2:k.newItemNo,czybm:d.ybOperatorId,czyxm:d.ybOperatorName,};a.ybReimburseObj.ybRefund(l,function(p){var n=p;var r=a.resolveYBReimburseInfo(p);var o=k.items;$.each(o,function(t,s){s.ybItemNo=k.newItemNo;s.itemAmount=-s.itemAmount;s.itemMoney=-s.itemMoney});var q={bizFee:{ybItemNo:k.newItemNo,ybPayState:0,selfPayMoney:r.zfMoney,ybPayMoney:r.ybMoney,selfYbMoney:r.personMoney,ybItemNo_:k.originItemNo},bizItems:o,ybBizRecord:{acographyId:c.acographyId},};a.saveYBReimburseInfo(q,function(t){var s={ybClinicId:d.ybClinicId,ybAcographyId:k.ybAcographyId,ybItemNo:k.newItemNo,ssj:r.zfMoney};var u={ybPayData:s,reimburseInfo:r,ybBalanceResult:JSON.stringify(n)};e(u)})})})},getYBBizItemByItemNo:function(b,e){var d={bizFee:{ybItemNo:b}};var a={url:ContextClinc_Server+"ybReimburse/getYBBizItemByItemNo",dataType:"json",type:"POST",data:JSON.stringify(d),contentType:"application/json;charset=utf-8",showMask:true};var c=Utils.myAjaxHandler(a);c.done(function(f){if(f!=null&&f.errorCode==SUCCESSCODE){e(f.data)}else{$.paError("获取已上传医保对照项目信息失败:",f.errorMessage)}})},getYBBizItemByChargeId:function(c,d){var a={url:ContextClinc_Server+"ybReimburse/getYBBizItemByChargeId",dataType:"json",type:"POST",data:JSON.stringify(c),contentType:"application/json;charset=utf-8",showMask:true};var b=Utils.myAjaxHandler(a);b.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){d(e.data)}else{$.paError("获取已上传医保对照项目信息失败:",e.errorMessage)}})},getYBBaseInfo:function(){var a=session_cache.getCache("ybData");var d={ybClinicId:null,ybOperatorId:null,ybOperatorName:null};if(a&&a.clinicInfo){var b=a.clinicInfo;var c=a.curEmployeeInfo;ybClinicId=b.orgCode;ybOperatorId=c.miEmployeeCode;ybOperatorName=c.miEmployeeName;d={ybClinicId:ybClinicId,ybOperatorId:ybOperatorId,ybOperatorName:ybOperatorName}}return d},mergeFeeItem:function(b){var c=[];var a={};$.each(b,function(f,g){var e=g.yljgnbbm;if(!e){return true}if(a[e]){var d=a[e];d.sl=accAdd(d.sl||0,g.sl||0);d.hjje=accAdd(d.hjje||0,g.hjje||0)}else{a[e]=g}});$.each(a,function(e,d){c.push(d)});$.each(c,function(d,e){e.no=d});return c},getYBFeeRecord:function(d,b){var a={url:ContextClinc_Server+"ybReimburse/getYBItemInfoById",dataType:"json",type:"POST",data:JSON.stringify(d),contentType:"application/json;charset=utf-8",showMask:true,async:false};var c=Utils.myAjaxHandler(a);c.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){b(e.data)}else{$.paError("获取医保对照信息失败:",e.errorMessage)}})},};