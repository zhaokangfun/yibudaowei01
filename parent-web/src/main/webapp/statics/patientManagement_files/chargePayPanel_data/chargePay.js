var param={};var isChargeSubmited=false;var setIntervalGetPayStates=null;var payStatesCircle=false;var intervalSecond=5000;var intervalTotalSecond=180000;var intervalCurrentSecond=0;function initChargePay(b){param=b;var a=new ChargePay()}function ChargePay(){this.init()}ChargePay.prototype={init:function(){this.bindEvent();this.initPage();if($().tipso){this.initTipso()}},initTipso:function(){$(".double-pay-kind").tipso({content:"患者可以使用多种支付方式一起进行付费，方便记账",delay:2000,useTitle:false,position:"top"});$(".owe-pay-kind").tipso({content:"患者如果需要欠费，选择欠费支付进行支付",delay:2000,useTitle:false,position:"top"});parent.$("#pay_cancel_btn").click(function(){parent.$(".team_two").addClass("dsn");parent.$(".team_one").removeClass("dsn")});parent.$("#pay_confirm_btn").click(function(){parent.$(".team_two").addClass("dsn");parent.$(".team_one").removeClass("dsn")});parent.$(".tips-floating .team_two ul li").first().click(function(){$(".double-pay-kind").tipso("show",{delay:300,"continue":2000})});parent.$(".tips-floating .team_two ul li").eq(1).click(function(){$(".owe-pay-kind").tipso("show",{delay:300,"continue":2000})})},bindEvent:function(){var a=this;$("#pay_cancel_btn").off("click").on("click",function(){a.chargeViewHide(this)});parent.$(".pay-close").off("click").on("click",function(){a.chargeViewHide(this);parent.$(".team_two").addClass("dsn");parent.$(".team_one").removeClass("dsn")});parent.$("#w_code_show_window .close").off("click").on("click",function(){var c=session_cache.getCache("DATA_FOR_CLOSE");c.isPaySucceed=false;var b={msg:"未查询到支付信息,请前往计价收费再次支付.",saveTxt:"确定",onYes:function(){a.closeQrCode(c)},onNo:function(){a.closeQrCode(c)},};parent.$.paConfirm(b)});$("#pay_confirm_btn").off("click").on("click",function(){if(param.chargeFlag==4){var b=$("#payTypeId li.checked").attr("value");if(b!=9){a.modifyChargeRecord(b)}else{a.reCharge()}}else{var d=$("#pay_kind_id .cur").val();var c=$("#owe_pay_money").val();if(3==d&&0==c){session_cache.setCache("OWE_PAY_AND_ZERO",1)}else{session_cache.setCache("OWE_PAY_AND_ZERO",0)}if(!$("#pay_confirm_btn").hasClass("disabled")){a.submitCharge(this)}}});$(".input-money").off("keyup").on("keyup",function(b){if(!$(this).hasClass("disabled")){a.validateMoneyInput(this)}});$("#pay_kind_id").off("click").on("click","li",function(b){if(!$(this).hasClass("disabled")){var c=$(this).val();$(this).addClass("cur").siblings().removeClass("cur");a.clearPayPanel();switch(c){case 1:a.singlePay();break;case 2:a.doublePay();break;case 3:a.owePay();break}}});$(".checkboxes").off("click").on("click","li",function(b){if(!$(this).hasClass("disabled")){if(!$(b.target).is("#installPluinDiv,#installPluinDiv span,#installPluinDiv a,.health-info span,.health-info, input,.member-info,.member-info span,.read_card_btn")){a.switchPayType(this)}}});$("#read_card_btn").off("click").on("click",function(b){HealthCardPayEvent.readCard()});$("#read_pass_btn").off("click").on("click",function(b){HealthCardPayEvent.readPassword()})},initPage:function(){var b=this;session_cache.removeCache("chargePayParamterData");var a={empiId:param.pricingCharge.empiId};if(b.isShowYbLeftPanelDetails()){$(".healthDetails").show()}else{$(".healthDetails").hide()}this.initPayPanelPage(a,function(c){param.memberInfo=c;b.initPayType(c.T21);param=$.extend({},param,c);b.getParamterData(function(d){b.initPayPanel();b.initMemberPassword(d)});if($("#payTypeId li[value=9]").size()==1){$($("#payTypeId li[value=9]")[0]).after($($("#payTypeId li[value=9]")[0]).clone());$($("#payTypeId li[value=9]")[0]).attr("subPayType","2");$($("#payTypeId li[value=9]")[1]).attr("subPayType","3");$($("#payTypeId li[value=9]")[0]).find(".pay-name").text("聚合刷卡");$($("#payTypeId li[value=9]")[1]).find(".pay-name").text("聚合扫码")}})},reCharge:function(){var a={order_id:param.payOrderId,tran_amt:param.totalMoney,qr_code:param.qrCodeBase64};if($("#payTypeId li.checked").attr("subPayType")==3){a.scan_auth_tp=$("#payTypeId li.checked").attr("subPayType");pos.qrCode(a,function(c){if(c.respCode==pos.payCallbackRespCodeConst.Success){var b=parent.parent;$.paSuccess("收费成功！",2000,function(){parent.printChargeList(param.chargeId,"chargeSave");b.$("#CASH01").click()})}else{var d={msg:c.respMsg,saveTxt:"确定",hideCancel:true,hideCloseBtn:true,onYes:function(){parent.parent.$("#CASH01").click()}};parent.$.paConfirm(d)}})}else{pos.unionPayCard(a,function(c){if(c.respCode==pos.payCallbackRespCodeConst.Success){var b=parent.parent;$.paSuccess("收费成功！",2000,function(){b.$("#CASH01").click()})}else{var d={msg:c.respMsg,saveTxt:"确定",hideCancel:true,hideCloseBtn:true,onYes:function(){parent.parent.$("#CASH01").click()}};parent.$.paConfirm(d)}})}},modifyChargeRecord:function(a){var d={payOrderId:param.payOrderId,chargeId:param.chargeId,payType:param.payType,payType_:a,empiId:param.empiId};var c=ContextClinc_Server+"charge/modifyChargeRecord";var b={url:c,dataType:"json",type:"POST",data:JSON.stringify(d),contentType:"application/json;charset=utf-8",async:true,showMask:true};var e=Utils.myAjaxHandler(b);e.done(function(f){if(f!=null&&f.errorCode==SUCCESSCODE){$.paSuccess("收费成功！",2000,function(){parent.printChargeList(param.chargeId,"chargeSave");parent.parent.$("#CASH01").click()})}else{if(f!=null&&(f.errorCode=="E2SP0119"||f.errorCode=="E2SP0120")){$.paSuccess(f.errorMessage,2000,function(){parent.parent.$("#CASH01").click()})}else{$.paError("保存退费信息ajax返回错误:"+f.errorCode+":"+f.errorMessage)}}}).fail(function(f){$.paError("请求未响应，请检查网络连接！")}).always(function(){})},initPayPanelPage:function(b,e){var d={typeName:"1"};var a={method:"POST",url:ContextClinc_Server+"charge/initPayPanelPage",data:JSON.stringify(b),dataType:"json",contentType:"application/json",async:true,showMask:true};var c=Utils.myAjaxHandler(a);c.done(function(f){if(f!=null&&f.errorCode==SUCCESSCODE){e(f.data);return}else{$.paError(f.errorMessage,null);return}}).fail(function(f){$.paError("请求异常",null)}).always(function(){})},getParamterData:function(d){var b=["5001","5002","5003","5004","5006","5009","5014","9001","1010"];var a={method:"POST",url:ContextClinc_Server+"mdcParameter/selectCodeMapByCodes",data:JSON.stringify(b),dataType:"json",contentType:"application/json",showMask:true,async:true};var c=Utils.myAjaxHandler(a);c.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){session_cache.setCache("chargePayParamterData",e.data);d(e.data)}else{$.paError(e.errorMessage,null);return}}).fail(function(e){$.paError("请求异常",null)}).always(function(){})},initMemberPassword:function(a){if(a["9001"]==1){$(".span-password").show()}else{$(".span-password").hide()}},initPayType:function(c){var b;var d=false;$(".extraLi").remove();$.each(c,function(g){switch(c[g]["dictItemCode"]){case chargeConstant.chargeCash:$(".charge_cash").parent().removeClass("disabled");$(".charge_cash").parent().addClass("used");break;case chargeConstant.chargeCard:$(".charge_card").parent().removeClass("disabled");$(".charge_card").parent().addClass("used");break;case chargeConstant.chargeYb:$(".charge_yb").parent().removeClass("disabled");$(".charge_yb").parent().addClass("used");break;case chargeConstant.chargePa:$(".charge_pa").parent().removeClass("disabled");$(".charge_pa").parent().addClass("used");break;case chargeConstant.chargeWeixin:$(".charge_weixin").parent().removeClass("disabled");$(".charge_weixin").parent().addClass("used");break;case chargeConstant.chargeAlipay:$(".charge_alipay").parent().removeClass("disabled");$(".charge_alipay").parent().addClass("used");break;case chargeConstant.chargeMember:$(".charge_member").parent().parent().removeClass("disabled");$(".charge_member").parent().parent().addClass("used");break;case chargeConstant.chargeYZT:$(".charge_yztpay").parent().removeClass("disabled");$(".charge_yztpay").parent().addClass("used");$(".charge_yztpay").parent().addClass("permit");break;case chargeConstant.chargeHealth:var f=$(".charge_health").parent().parent();f.data("flag",true);f.show();$(".show-panel",window.parent.document).css("height","390px");$(".input-money-panel").css("visibility","hidden");d=true;$(".charge_health").parent().parent().removeClass("disabled");$(".charge_health").parent().addClass("used");break;default:var e=c[g]["dictItemName"];var h='<li class="extraLi used" value="'+c[g]["dictItemCode"]+'"><span class="charge_custom pay-icon"></span><span class="pay-name">'+e+"</span></li>";if(e.length>5){h='<li class="extraLi used" value="'+c[g]["dictItemCode"]+'"><span class="charge_custom pay-icon"></span><span class="pay-name toolong" title="'+e+'">'+e.substring(0,5)+"</span></li>"}$(".health-type").before(h)}});if(!d){var a=$(".charge_health").parent().parent();a.css("display","none");a.data("flag",false)}},showLeftPanelInfo:function(d,f,q){var k=param.totalMoney||"0";var i=param.yhMoney||"0";var r=param.receMoney||"0";var j=param.oweMoney||"0";var c=param.accountingMoney||"0";var l;if(this.isShowYbLeftPanelDetails()){var h=param.reimburseInfo||param.ybPreSettleDetails;var p=(h.ybMoney||h.ybPayMoney||h.fundPayMoney)||0;var o=(h.personMoney||h.selfYbMoney||h.personalYbAccountPayMoney)||0;var e=(h.zfMoney||h.selfPayMoney||h.ybCashPayMoney)||0;var b=h.overPayTotal||0;$("#yb_money_id").text("￥"+fmoney(p,d));$("#person_money_id").text("￥"+fmoney(o,d));$("#self_money_id").text("￥"+fmoney(e,d));if(YBUtils.isChongQingYb(param.MI_TYPE_CODE)){$("#over_money_id").text("￥"+fmoney(b,d));$("#over_money_div_id").removeClass("dsn")}}var a=this.fixMoneyBySet(r,f,q);l=accSub(a,r)||0;$("#recemoneyid").text("￥"+fmoney(a,d));$("#totalmoneyid").text("￥"+fmoney(k,d));$("#totalmoneyid_").text("￥"+fmoney(this.fixMoneyBySet(k,2),d));$("#yhmoneyid").text("￥"+fmoney(fixByRound(i,d),d));$("#smallmoneyid").text("￥"+fmoney(l,d));$("#smallmoneyid_").text("￥"+fmoney(this.fixMoneyBySet(l,2),d));$("#owemoneyid").text("￥"+fmoney(j,d));$("#accountmoneyid").text("￥"+fmoney(fixByRound(c,d),d));var g=$("#input_cash_id").css("visibility");if(g=="visible"){$("#pre_received_money").val(this.getPayMoney()).focus();this.validateMoneyInput($(".input-money"))}if(r==0){$("#pay_confirm_btn").removeClass("disabled")}},showLeftPanelInfoForPAOne:function(){var b=param.totalMoney||"0";var c=param.feeTotalMoney||"0";var e=param.discountMoney||"0";var f=param.oweMoney||"0";var a=param.accountingMoney||"0";var d=param.smallMoney;$("#recemoneyid").text("￥"+fmoney(b));$("#totalmoneyid_").text("￥"+fmoney(c,2));$("#yhmoneyid").text("￥"+fmoney(e,2));$("#owemoneyid").text("￥"+fmoney(0,2));$("#accountmoneyid").text("￥"+fmoney(a,2));$("#smallmoneyid_").text("￥"+fmoney(d,2))},disableOnlinePay:function(){$("#payTypeId li[value=3]").hide();$("#payTypeId li[value=7]").hide();$("#payTypeId li[value=8]").hide()},fixMoneyBySet:function(c,b,e){var a;var d=session_cache.getCache("chargePayParamterData");if(b==1){if(d["5001"]==2){a=fixByFive(c,b)}else{if(d["5001"]==1){a=fixByRound(c,b)}else{if(d["5001"]==3){a=fixByInteger(c)}else{if(d["5001"]==4){a=parseInt(fixByRound(c,0))}else{a=fixByRound(c,b)}}}}}else{if(e==1){if(d["5001"]==2){a=fixByFive(c,1)}else{if(d["5001"]==1){a=fixByRound(c,1)}else{if(d["5001"]==3){a=fixByInteger(c)}else{if(d["5001"]==4){a=parseInt(fixByRound(c,0))}else{a=fixByRound(c,1)}}}}}else{a=fixByRound(c,2)}}return a},initPayPanel:function(){$(".pay-choose-panel li").removeClass("cur checked");$(".member-type").addClass("dsn");if(param.singlePay){$("#pay_kind_id ul li[value!=1]").addClass("dsn")}if(param.owePayOff){$(".owe-pay-kind").hide()}if(param.doublePayOff){$(".double-pay-kind").hide()}if(param.chargeFlag==4){$("#pay_kind_id").off("click");$(".double-pay-kind").hide();if(param.payType==5){$("#payTypeId li[value=9]").hide()}this.showLeftPanelInfoForPAOne();this.disableOnlinePay()}else{this.showLeftPanelInfo(2,2)}if(param.payMoney==0){$(".pay-choose-panel .input-table:first").show().css("visibility","hidden").siblings().hide();$(".pay-choose-panel").addClass("disabled");$(".pay-choose-panel li").addClass("disabled");$("#pay_confirm_btn").removeClass("disabled")}else{$(".pay-choose-panel").removeClass("disabled");$(".pay-choose-panel li").removeClass("disabled");if(Utils.notBlank(param.memberInfo.memberTypeId)){$(".member-type").removeClass("dsn");$("#card_id").text(param.memberInfo.memberCardNumber);var b=param.memberInfo.cashGift+param.memberInfo.balance;$("#banlance_id").text(b)}$("#unearned").focus()}if(parent.is_yb){$("#pay_kind_id").find("li:gt(0)").addClass("disabled")}if(param.memberPayOff){if(!$(".member-type").hasClass("dsn")){$(".member-type").addClass("dsn")}}var a=0;$.each($(".pay-type li"),function(){if(!$(this).hasClass("used")){$(this).addClass("dsn")}if($(this).hasClass("member-type")){return true}a++;if(a%3==0){$(this).addClass("las")}if($(this).hasClass("health-type")){a=0}});if(param.chargeFlag==4&&param.payType==9){var d=param.realPayTypeCode;if(!d&&$("#payTypeId li[value=9]").size()==1&&$("#payTypeId li[value=9]").is(":visible")){$("#payTypeId li[value=9]").click()}else{if(d==2&&$("#payTypeId li[subpaytype=2]").is(":visible")){$("#payTypeId li[subpaytype=2]").click()}else{if(d==3&&$("#payTypeId li[subpaytype=3]").is(":visible")){$("#payTypeId li[subpaytype=3]").click()}else{var c=$("#pay_kind_id li:first");c.addClass("cur").siblings().removeClass("cur");c.click();$(".pay-type li:not(.dsn):first").click()}}}}else{if(param.chargeFlag==4&&param.payType==5&&$("#payTypeId li[value=5]").is(":visible")){$("#payTypeId li[value=5]").click()}else{var c=$("#pay_kind_id li:first");c.addClass("cur").siblings().removeClass("cur");c.click();$(".pay-type li:not(.dsn):first").click()}}},isOPDataSource:function(a){if(a==chargeConstant.dataSourcePE){return false}else{return true}},singlePay:function(b){this.showPayYZT(1);var c=$("#input_cash_id");c.show().siblings().hide();var a=$(".charge_health").parent().parent();if(a.data("flag")){a.show();$(".show-panel",window.parent.document).css("height","390px")}$("#payTypeId li:visible:not(.dsn):first").click()},doublePay:function(c){this.showPayYZT(2);var b=$("#double_pay_id");var a=$(".charge_health").parent().parent();if(a.data("flag")){a.hide();$(".show-panel",window.parent.document).css("height","359px")}b.show().css("visibility","hidden").siblings().hide();$("#payTypeId li").removeClass("checked")},owePay:function(c){this.hidePayYZT();var b=$("#owe_pay_id");var a=$(".charge_health").parent().parent();if(a.data("flag")){a.hide();$(".show-panel",window.parent.document).css("height","359px")}b.show().css("visibility","visible").siblings().hide();$("#payTypeId li:visible:not(.disabled):first").click()},chooseDoublePayType:function(b){var c=$(".checkboxes li.checked");var h=$("#double_pay_id");var g=this;if(c.length==2){h.show().css("visibility","visible").siblings().hide();var f=c.not(b);var a=f.find(".pay-name").text();if(f.find(".pay-name").hasClass("toolong")){a=f.find(".pay-name").attr("title")}g.checkEleEvent($("#1st_pay_type"),a,f.attr("value"));$("#1st_pay_money").attr("data",f.attr("value"));var d=$(b);var e=d.find(".pay-name").text();if(d.find(".pay-name").hasClass("toolong")){e=d.find(".pay-name").attr("title")}g.checkEleEvent($("#2nd_pay_type"),e,d.attr("value"));$("#2nd_pay_money").attr("data",d.attr("value"));$("#1st_pay_money").focus()}if(c.length>2){$(b).removeClass("checked");if(Utils.notBlank($("#1st_pay_money").val())){$("#pay_confirm_btn").removeClass("disabled")}}if(c.length<2){h.css("visibility","hidden");this.clearPayPanel()}},checkEleEvent:function(c,a,b){if(a.length>5){c.text(a.substring(0,5)+" :");c.attr("title",a)}else{c.text(a+" :")}},clearLeftPanel:function(){$(".left-side .number").text("￥0")},clearPayPanel:function(){$("#pay_confirm_btn").addClass("disabled");$("#pre_received_money").val("");$("#changeid").text("");$("#unearned").val("");$(".input-money").val("");$("#owemoneyid").text("￥0.00");$("#1st_pay_type").text("支付一：");$("#1st_pay_money").attr("data","");$("#2nd_pay_type").text("支付二：");$("#2nd_pay_money").attr("data","");$("#2nd_pay_money").text("");$("#1st_pay_money").attr("placeholder","");$("#1st_pay_money").val("");$("#owe_pay_money").val("");$("#owe_id").text("");$("#password_id").val("");$("#health_card_no_id").val("");$("#health_card_password_id").val("");$("#health_card_banlance_id").text("0.00")},validateDiscountInput:function(c){this.validateNumberInput(c);var b=session_cache.getCache("recordPayData");var g=parseFloat(b.disaccount);var a=$("#receid").text();a=a.substring(1,a.length);a=parseFloat(handleNumber(a));if(!b.disaccount){if(b.disaccount!=0){$(c).val("");$.paWarn("您无折扣权限！",null);return}}var f=$(c).val();var e=$("#discount_type").attr("val");var d=parseFloat(f);switch(e){case"1":if(d>100){$(c).val(f.replace(/.$/,""))}break;case"2":if(d>a){}break}},validateNumberInput:function(c){$(c).val($.trim($(c).val()));if(isNaN($(c).val())){$(c).val($(c).val().replace(/[^\d\.]+/,""))}var b=parseFloat($(c).val())||0;var e=$(c).val().split(".");var a=/^0{1,}/;$(c).val($(c).val().replace(a,"0"));var a=/(^[0-9]+.[0-9]{1,2})[0-9]*/;var d=$(c).val().replace(a,"$1");if(e.length==2&&e[1].length>=2){$(c).val(d)}if(e.length>2){$(c).val(b)}},validateMoneyInput:function(i){this.validateNumberInput(i);var b=$(i).val();var c=param.cashGift+param.balance;if($(i).attr("data")==chargeConstant.chargeMember&&$(i).val()>c){$.paWarn("会员卡余额不足！",null);$(i).val(b.replace(/.$/,""))}$("#pay_confirm_btn").removeClass("disabled");var e=$("#recemoneyid").text();e=handleNumber(e.substring(1,e.length));sje=handleNumber($(i).val());var f=$(i).parent().parent().find(".output-money");var d=$("#pay_kind_id .cur").val();if(d!=1){var g=accSub(e,sje)}else{var g=accSub(sje,e)}var h=$("#owemoneyid");if($(i).val().length==0||g<0){$("#pay_confirm_btn").addClass("disabled");f.text("");h.text("￥0.00")}if($(i).val().length!=0){f.text(fmoney(g,2));if(d==3){h.text("￥"+fmoney(g,2))}}var a;if(f.attr("data")==chargeConstant.chargeMember){a=f}if(a&&parseFloat(handleNumber(a.text()))>c){$("#pay_confirm_btn").addClass("disabled")}},getHealthCardInfo:function(b){var c=$("#health_card_no_id").val();var f=$("#health_card_no_id").data("trackInfo");var d=$("#health_card_password_id").data("machineId");var a=$("#health_card_password_id").val();var e={chargeFundPayVO:{cardNo:c,trackInfo:f,cardPwd:a,totalAmount:b,machineId:d}};return e},switchPayTypeForPAOne:function(a){var b=$(a);$(".checkboxes li").not(b).removeClass("checked");b.addClass("checked");$("#pay_confirm_btn").removeClass("disabled")},switchPayType:function(c){if(param.chargeFlag==4){this.switchPayTypeForPAOne(c);return}var d=$(c);if(!d.hasClass("disabled")){var b=$("#pay_kind_id .cur").val();$("#pay_confirm_btn").addClass("disabled");switch(b){case 1:$(".checkboxes li").not(d).removeClass("checked");d.addClass("checked");if(d.val()==chargeConstant.chargeHealth){HealthCardPayEvent.init()}else{$(".input-money-panel").show();$("#installPluinDiv").css("display","none");$("#health_card_password_id").val("");$("#health_card_no_id").val("");$(".health-info").hide()}if(d.val()!=chargeConstant.chargeCash){if(d.val()==chargeConstant.chargeMember){var g=$("#receid").text();g=g.substring(1,g.length);g=handleNumber(g)||0;if(g>param.balance){$("#pay_confirm_btn").addClass("disabled")}}$("#input_cash_id").css("visibility","hidden");$("#pre_received_money").val("");$("#changeid").text("");$("#unearned").val("");if(d.val()!=chargeConstant.chargeHealth){$("#pay_confirm_btn").removeClass("disabled")}var e=session_cache.getCache("chargePayParamterData");if(e["5014"]==1){this.showLeftPanelInfo(2,1,2)}else{this.showLeftPanelInfo(2,2,2)}}else{$("#input_cash_id").css("visibility","visible");$("#unearned").focus();this.showLeftPanelInfo(2,1,1)}break;case 2:d.toggleClass("checked");this.chooseDoublePayType(c);var e=session_cache.getCache("chargePayParamterData");var f=2,a;$("#payTypeId .checked").each(function(){if($(this).val()=="1"){f=1}});if(e["5014"]==1){a=1}else{a=2}this.showLeftPanelInfo(2,a,f);break;case 3:if(d.hasClass("checked")&&Utils.notBlank($("#owe_pay_money").val())){$("#pay_confirm_btn").removeClass("disabled")}else{$("#owe_pay_money").val("");$("#owe_id").text("");d.addClass("checked");$(".checkboxes li").not(d).removeClass("checked");$("#owe_pay_money").attr("data",d.val());if(d.val()!=chargeConstant.chargeCash){var e=session_cache.getCache("chargePayParamterData");if(e["5014"]==1){this.showLeftPanelInfo(2,1,2)}else{this.showLeftPanelInfo(2,2,2)}}else{this.showLeftPanelInfo(2,1,1)}}break}if($(".member-type").hasClass("checked")){$(".member-info").removeClass("dsn")}else{$(".member-info").addClass("dsn")}}else{d.removeClass("checked")}},chargeViewHide:function(){if(YBUtils.isChengDuYb(param.MI_TYPE_CODE)){parent.cdYbServiceInvoke.tradeCancel(param.settleCallBackData.astr_jylsh)}parent.closeChargePay()},chargeflag:false,submitCharge:function(c){if(!isChargeSubmited){isChargeSubmited=true;var b=this;if(param.chargeList==null||param.chargeList.length==0){$.paWarn("未发现需收费的项目！");return}param.pricingCharge=$.extend({},param.pricingCharge,this.getPayMoneyInfo());if(param.pricingCharge.totalMoney<0){$.paWarn("应收金额有误，请检查收费项目");isChargeSubmited=false;return}var f=$("#pay_kind_id .cur").val();if(f==2&&$(".checkboxes li.checked").length!=2){$.paWarn("请选择2种支付方式！");return}var g=session_cache.getCache("chargePayParamterData");var e=param.pricingCharge.payType;var a=param.pricingCharge.payType2nd;if(e==chargeConstant.chargeMember||a==chargeConstant.chargeMember){if(g["9001"]==1&&!Utils.notBlank($("#password_id").val())){$.paWarn("需输入会员卡密码！");$(c).removeClass("disabled");isChargeSubmited=false;return}param.pricingCharge=$.extend({},param.pricingCharge,param.memberInfo)}var d=param.payMoney||param.receMoney;if(e==chargeConstant.chargeHealth){if(d>10000){$.paWarn("单笔交易限额1万元！");$(c).removeClass("disabled");return}var h=b.getHealthCardInfo(d);param=$.extend({},param,h)}else{if(e==chargeConstant.chargeYZT){param.pricingCharge.realPayTypeCode=$("#payTypeId li.checked").attr("subPayType")}}param.pricingCharge.paymentTypeId=param.pricingCharge.paymentTypeId||1;if(param.ybPayFlag){if(param.MI_TYPE_CODE=="yb0001"){param.ybItemNo=param.ybPayData.ybItemNo;param.pricingCharge.chargeFlag="4";b.saveChargeRecord(param,function(i){b.szYbSubmitCharge(i)})}else{if(param.MI_TYPE_CODE=="yb0002"){b.xmYbSubmitCharge(param,function(i){parent.saveChargePaySuccess(i)})}else{if(YBUtils.isChongQingYb(param.MI_TYPE_CODE)){b.cqYbSubmitCharge(param,function(i){parent.saveChargePaySuccess(i)})}else{if(YBUtils.isChengDuYb(param.MI_TYPE_CODE)){b.cdYbSubmitCharge(param,function(i){parent.saveChargePaySuccess(i)})}else{if(YBUtils.isShenZhenNewYb(param.MI_TYPE_CODE)){b.saveYBFeeAndCgRecord(param,function(){b.szYbNewSubmitCharge(param,function(i){param.ybChargeResult=i;if(param.pricingCharge.dataSource==4&&param.pricingCharge.isYbReg==1){YBUtils.updateYBBizFeeOutpatientSettle(param,function(j){parent.szYbNewServiceInvoke.szYbRegSettleSuccess(param)})}else{YBUtils.updateYBBizFeePayMoney(param,function(j){parent.saveChargePaySuccess(j)})}})})}}}}}}else{this.saveChargeRecord(param)}}},cdYbSubmitCharge:function(d,g){var j=this;var h=d.settleCallBackData.astr_jyyzm;var b=d.settleCallBackData.astr_jylsh;var i=d.settleCallBackData.astr_jysc_xml;var e=Utils.accSub(parseFloat(d.settleTotalMoney),parseFloat(i.yka065));e=Utils.accSub(parseFloat(e),parseFloat(i.ykh012));var a=Utils.accAdd(Utils.accSub(parseFloat(d.totalMoney),parseFloat(d.settleTotalMoney)),parseFloat(i.ykh012));var m=parseFloat(i.yka065||0);var f={ybFundMoney:e,selfPayMoney:a,selfYbMoney:m,payMoney1st:a};d.pricingCharge=$.extend({},d.pricingCharge,f);$.each(d.ybBizItems,function(n){d.ybBizItems[n].ybItemNo=i.yka103});d.ybItemNo=i.yka103;d.ybBizRecord.ybAcographyId=i.akc190;var c={ybBizStateVO:{ybBizRecord:d.ybBizRecord,bizItems:d.ybBizItems,bizFee:{delFlag:0,presetStatus:0,selfPayMoney:parseFloat(i.ykh012),selfYbMoney:m,ybBalanceResult:JSON.stringify(i),ybCatCharge:"",ybItemNo:i.yka103,ybOptUser:i.aae011,ybPayMoney:e,ybActBalance:parseFloat(i.grzhye[0].ykc194),ybPayState:1,ybChargeSn:b,ybChargeVerifyCode:h,ybBefeBalance:parseFloat(d.beforeBalance)}},pricingChargeVO:d};var l={url:ContextClinc_Server+"ybReimburse/commonYBSave/saveYBUploadInfo",dataType:"json",type:"POST",data:JSON.stringify(c),contentType:"application/json;charset=utf-8",showMask:true};var k=Utils.myAjaxHandler(l);k.done(function(n){if(n!=null&&n.errorCode==SUCCESSCODE){parent.cdYbServiceInvoke.tradeConfrim(b,h);g(n.data)}else{parent.cdYbServiceInvoke.tradeCancel(b);isChargeSubmited=false;$.paWarn("云诊所提示信息："+n.errorMessage+"，收费失败！")}}).fail(function(){$.paConfirm({msg:"网络异常，请到医保管理->不确定交易中处理！！",saveTxt:"确定",hideCancel:true,onYes:function(){isChargeSubmited=false}})})},cqYbSubmitCharge:function(c,b){var a=this;parent.cqYbServiceInvoke.settle(a.createSettleRequestParams(c),function(g){var h=Utils.accSub(parseFloat(c.settleTotalMoney),parseFloat(g.accountPayTotal||0));h=Utils.accSub(parseFloat(h),parseFloat(g.cashPayTotal||0));h=Utils.accSub(parseFloat(h||0),parseFloat(g.dRGsInstitutionPayTotal||0));var e=Utils.accAdd(Utils.accSub(parseFloat(c.totalMoney),parseFloat(c.settleTotalMoney)),parseFloat(g.cashPayTotal||0));var l=parseFloat(g.accountPayTotal||0);var i={ybFundMoney:h,selfPayMoney:e,selfYbMoney:l,payMoney1st:e};c.pricingCharge=$.extend({},c.pricingCharge,i);$.each(c.ybBizItems,function(m){c.ybBizItems[m].serialNo=g.serialNo});c.ybItemNo=g.serialNo;var d={ybBizStateVO:{ybBizRecord:c.ybBizRecord,bizItems:c.ybBizItems,bizFee:{delFlag:0,presetStatus:0,selfPayMoney:parseFloat(g.cashPayTotal),selfYbMoney:l,ybBalanceResult:JSON.stringify(g),ybCatCharge:JSON.stringify(g),ybItemNo:g.serialNo,ybOptUser:c.optUser,ybPayMoney:h,ybActBalance:g.balance,ybBefeBalance:parseFloat(c.beforeBalance),ybPayState:1}},pricingChargeVO:c};var k={url:ContextClinc_Server+"ybReimburse/commonYBSave/saveYBUploadInfo",dataType:"json",type:"POST",data:JSON.stringify(d),contentType:"application/json;charset=utf-8",showMask:true};var j=Utils.myAjaxHandler(k);var f=a.createReFundRequestParams(g,c.ybBizRecord,c.optUser);j.done(function(m){if(m!=null&&m.errorCode==SUCCESSCODE){b(m.data)}else{parent.cqYbServiceInvoke.reFund(f);isChargeSubmited=false;$.paConfirm({msg:"云诊所提示信息："+m.errorMessage+"，收费失败！",saveTxt:"确定",hideCancel:true,onYes:function(){}})}}).fail(function(){$.paConfirm({msg:"网络异常，请到医保管理->对账明细 中查询！",saveTxt:"确定",hideCancel:true,onYes:function(){isChargeSubmited=false}})})},function(){isChargeSubmited=false})},createReFundRequestParams:function(b,d,c){var a={areaCode:MI_AREA_CODE.CHONGQING,serialNo:b.serialNo,optUser:c||"管理员",clinicNo:d.ybAcographyId,reverseType:"0",insuranceType:"1"};return a},createSettleRequestParams:function(a){var b={areaCode:MI_AREA_CODE.CHONGQING,data:{clinicNo:a.ybBizRecord.ybAcographyId,settlementType:"0",inpatBedDay:"0",optUser:a.optUser||"管理员",balancePayFlag:"0",midwaySettleDate:"",settleTotalAmount:a.settleTotalMoney,totalItemCount:a.ybBizItems.length,insuranceType:"1",hisCompanyCode:"00999",workRelateInjuryCode:"",workRelateInjuryDiseaseCode:"",pneumoconiosisSettlementType:""}};return b},xmYbSubmitCharge:function(b,a){xmYbServiceInvoke.mzsf(b,function(c){params=$.extend({},b,c);var h=Utils.accSub(parseFloat(c.mzsf.bcbxf0),parseFloat(c.mzsf.zhzfe0));h=Utils.accSub(h,parseFloat(c.mzsf.grzfe0));var f=params.bizItems;for(var g=0;g<f.length;g++){f[g]["ybItemNo"]=c.mzsf.djlsh0}b.ybItemNo=c.mzsf.djlsh0;var e=accAdd(parseFloat(b.needPayCash),parseFloat(c.mzsf.grzfe0));var n=parseFloat(c.mzsf.zhzfe0);var k={ybFundMoney:h,selfPayMoney:e,selfYbMoney:n,payMoney1st:e};b.pricingCharge=$.extend({},b.pricingCharge,k);var j={ybBizStateVO:{ybBizRecord:params.ybBizRecord,bizItems:f,bizFee:{delFlag:0,presetStatus:0,selfPayMoney:parseFloat(c.mzsf.grzfe0),selfYbMoney:n,ybBalanceResult:JSON.stringify(c),ybCatCharge:JSON.stringify(c.yb0000),ybItemNo:c.mzsf.djlsh0,ybOptUser:c.mzsf.sfrxm0,ybPayMoney:h,ybPayState:1}},pricingChargeVO:b};var m={url:ContextClinc_Server+"ybReimburse/commonYBSave/saveYBUploadInfo",dataType:"json",type:"POST",data:JSON.stringify(j),contentType:"application/json;charset=utf-8",showMask:true};var l=Utils.myAjaxHandler(m);var d={request:"TRUE",cardno:c.mzsf.cardno,cxdjh0:c.mzsf.djlsh0};l.done(function(o){if(o!=null&&o.errorCode==SUCCESSCODE){var p="还需收取现金"+e+"元!!!";$.paConfirm({msg:p,saveTxt:"确定",hideCancel:true,onYes:function(){a(o.data)}});$("#icon_close").hide()}else{xmYbServiceInvoke.mzsfcx(d);isChargeSubmited=false;var i="保存医保的结算信息失败,原因："+o.errorMessage;$.paConfirm({msg:i,saveTxt:"确定",hideCancel:true,onYes:function(){}})}}).fail(function(){xmYbServiceInvoke.mzsfcx(d);isChargeSubmited=false;$.paConfirm({msg:"请求未响应，请检查医保服务网络连接！",saveTxt:"确定",hideCancel:true,onYes:function(){}})})},function(){isChargeSubmited=false})},szYbSubmitCharge:function(a){var b=new ybCharge(param);b.payYBFee(param.ybPayData,function(){var g=$("#pay_kind_id .cur").val();var f=$("#payTypeId .checked").val();var h=$("#recemoneyid").text();var c=handleNumber(h.substring(1,h.length));var i=0;if(1==g&&1==f){c=$("#input_cash_id .input-money").val();i=Utils.trimObj($("#changeid").html())}var e={ybItemNo:param.ybItemNo,actualPayMoney:c,ransomMoney:i,payState:1};var d={url:ContextClinc_Server+"ybReimburse/updateYBBizFeePayMoney",dataType:"json",type:"POST",data:JSON.stringify(e),contentType:"application/json;charset=utf-8",showMask:true};var j=Utils.myAjaxHandler(d);j.done(function(k){if(k!=null&&k.errorCode==SUCCESSCODE){}else{$.paConfirm({msg:"更新医保支付状态失败:"+k.errorMessage,saveTxt:"确定",hideCancel:true,onYes:function(){}})}});a()})},getPayMoneyInfo:function(){var b=0;var h=0;var n=0;var e=0;var k=0;var o=null;var v=null;var u=param.yhMoney||"0";var p=$("#recemoneyid").text();var t=$("#recemoneyid").text();var d=$("#smallmoneyid").text();var f=$("#totalmoneyid").text();var r=$("#owemoneyid").text();var g=param.accountingMoney||"0";var m=0;var n=0;var c=0;var l=param.reimburseInfo;if(l){var m=l.ybMoney||l.ybPayMoney||0;var n=l.zfMoney||l.selfPayMoney||0;var c=l.personMoney||l.selfYbMoney||0}p=handleNumber(p.substring(1,p.length));t=handleNumber(t.substring(1,t.length));d=handleNumber(d.substring(1,d.length));f=handleNumber(f.substring(1,f.length));r=handleNumber(r.substring(1,r.length));var s=$("#pay_kind_id .cur").val();switch(s){case 1:o=$("#payTypeId .checked").attr("value");e=p;break;case 2:var j=$("#1st_pay_money");var a=$("#2nd_pay_money");o=j.attr("data");v=a.attr("data");e=j.val();k=handleNumber(a.text());break;case 3:o=$("#payTypeId .checked").attr("value");e=$("#owe_pay_money").val();break}switch(o){case 1:b=p;break;case 2:break;default:b=p}var q=u;if($.trim(param.discountMoneyExcludeItem)!=""){q=param.discountMoneyExcludeItem}var i={payKind:s,payType:o,payType2nd:v,reimbursementCode:0,reimbursementMoney:r,feeTotalMoney:f,payMoney1st:e,payMoney2nd:k,payKind:s,totalMoney:t,smallMoney:d,accountingMoney:g,discountMoneyExcludeItem:q,discountMoney:u,cashPayMoney:b,cardPayMoney:h,ybFundMoney:m,selfPayMoney:n,selfYbMoney:c,memberPassword:$("#password_id").val(),refundStatus:1,checkoutStatus:0,remark:$("#remark").val()};return i},saveChargeRecord:function(e,d){var a=this;var b={url:ContextClinc_Server+"charge/chargeSaveRecord",dataType:"json",type:"POST",data:JSON.stringify(e),contentType:"application/json;charset=utf-8",async:true,timeout:180000,showMask:true};var c=Utils.myAjaxHandler(b);c.done(function(f){if(f!=null&&f.errorCode==SUCCESSCODE){a.doWithChargeRecordSuccess1(f.data,d)}else{$("#pay_confirm_btn").removeClass("disabled");$.paError(f.errorMessage)}isChargeSubmited=false}).fail(function(f){$.paError("前台请求超时，请在收费记录中查看")}).always(function(){})},doWithChargeRecordSuccess1:function(c,e){param.chargeId=c.chargeId;param.chargeNo=c.chargeNo;var a=this;c.isPaySucceed=true;var b=c.qrCodeBase64;if(pos&&$("#payTypeId li.checked").attr("value")==chargeConstant.chargeYZT){var d={order_id:c.payOrderId,tran_amt:c.totalMoney,qr_code:c.qrCodeBase64};if($("#payTypeId li.checked").attr("subPayType")==3){pos.qrCode(d,function(f){a.afterPayEnd(f,c,e)})}else{pos.unionPayCard(d,function(f){a.afterPayEnd(f,c,e)})}a.chargeViewHide()}else{if(b!=null){parent.$("#pay_pop").hide();parent.$("#chargebtnid").addClass("disabled");parent.$("#w_code_totalMoney").text("(收费)￥"+fmoney(c.totalMoney||0,2));parent.$("#qrcodeImg").removeAttr("src");parent.$("#w_code_show_window").removeAttr("style");parent.$("#qrcodeImg").attr("src","data:image/png;base64,"+b);parent.$(".w_code_show_bg").removeClass("dsn");session_cache.setCache("DATA_FOR_CLOSE",c);this.intervalGet(c,e)}else{this.doWithChargeRecordSuccess2(c,e)}}},afterPayEnd:function(a,c,d){if(a.respCode==pos.payCallbackRespCodeConst.Success){this.doWithChargeRecordSuccess2(c,d)}else{var b={msg:a.respMsg,saveTxt:"确定",hideCancel:true,hideCloseBtn:true,onYes:function(){parent.parent.$("#CASH01").click()}};parent.$.paConfirm(b)}},intervalGet:function(c,b){var a=this;setIntervalGetPayStates=setInterval(function(){a.getPayStatesCircle(c,b)},intervalSecond)},getPayStatesCircle:function(g,f){var a=this;var e={payOrderId:g.payOrderId,};var b={url:ContextClinc_Server+"charge/getPayOrderStates",dataType:"json",type:"POST",data:JSON.stringify(e),contentType:"application/json;charset=utf-8",};var d=Utils.myAjaxHandler(b);d.done(function(i){if(i!=null&&i.errorCode==SUCCESSCODE&&i.data.payStatus==1){var h=g.isPaySucceed?true:false;g.isPaySucceed=h;a.closeQrCode(g,f)}});intervalCurrentSecond+=intervalSecond;if(intervalCurrentSecond>intervalTotalSecond){parent.$(".w_code_show_bg").addClass("dsn");a.clearIntervalPayStates();g.isPaySucceed=false;var c={msg:"未查询到支付信息,请前往计价收费再次支付.",saveTxt:"确定",hideCancel:true,hideCloseBtn:true,onYes:function(){a.closeQrCode(g,f)},onNo:function(){a.closeQrCode(g,f)},};parent.$.paConfirm(c)}},closeQrCode:function(b,c){var a=this;parent.$("#chargebtnid").removeClass("disabled");a.doWithChargeRecordSuccess2(b,c);a.clearIntervalPayStates()},clearIntervalPayStates:function(){if(setIntervalGetPayStates!=null){clearInterval(setIntervalGetPayStates)}parent.$(".w_code_show_bg").addClass("dsn");intervalCurrentSecond=0},doWithChargeRecordSuccess2:function(c,d){var a=this;if(param.pricingCharge.isPrintInvoice){var b=session_cache.getCache("OWE_PAY_AND_ZERO");if(1!=b){param.invoiceNo=param.pricingCharge.invoiceNo;param.invoiceNoPre=param.pricingCharge.invoiceNoPre;a.chargeSaveInvoice(param)}}if(d){d(function(){parent.saveChargePaySuccess(c)})}else{parent.saveChargePaySuccess(c)}},chargeSaveInvoice:function(c,d){var a={url:ContextClinc_Server+"charge/chargeSaveInvoice",dataType:"json",type:"POST",data:JSON.stringify(c),contentType:"application/json;charset=utf-8",async:false,showMask:true};var b=Utils.myAjaxHandler(a);b.done(function(h){if(h!=null&&h.errorCode==SUCCESSCODE){var f={chargeId:c.chargeId};try{c.invoicePrint_sup=false;parent.InvoicePrintModel.printInvoice(c)}catch(g){}}})},isShowYbLeftPanelDetails:function(){return param.ybPayFlag&&param.isShowYBDetails},getPayMoney:function(){var a=$("#recemoneyid").text();a=handleNumber(a.substring(1,a.length));return a},hidePayYZT:function(){if(this.isShowYZT()){$(".charge_yztpay").parent().addClass("dsn")}},showPayYZT:function(a){if(this.isShowYZT()&&a==1){$(".charge_yztpay").parent().removeClass("dsn")}else{$(".charge_yztpay").parent().addClass("dsn")}},isShowYZT:function(){return $(".charge_yztpay").parent().hasClass("permit")?true:false},szYbNewSubmitCharge:function(c,b){var a=this;if(c.pricingCharge.dataSource==4&&c.pricingCharge.isYbReg==1){c.operateType=4;parent.szYbNewServiceInvoke.regSettle(c,b)}else{c.operateType=2;parent.szYbNewServiceInvoke.feeSettle(c,b)}},saveYBFeeAndCgRecord:function(f,m){var e={};if(f.preSettleTransBody){var d=f.ybPreSettleDetails;var a=Utils.accSub(parseFloat(f.totalMoney||0),parseFloat(f.settleTotalMoney||0));var b=Utils.accAdd(a||0,d.ybCashPayMoney||0);var j={ybFundMoney:d.fundPayMoney||0,selfPayMoney:b||0,selfYbMoney:d.personalYbAccountPayMoney||0,payMoney1st:b};f.pricingCharge=$.extend({},f.pricingCharge,j);f.pricingCharge.chargeFlag="4";e={ybBizStateVO:{ybBizRecord:f.ybBizRecord,bizItems:f.ybBizItems,bizFee:{delFlag:0,presetStatus:0,ybItemNo:f.ybItemNo,ybOptUser:f.optUser,ybActBalance:parseFloat(f.afterBalance||0),ybBefeBalance:parseFloat(f.beforeBalance||0),ybPayState:0,settleSerialNo:f.orgSettlementCode||""}},pricingChargeVO:f}}else{if(f.ybPreSettleDetails){var j={ybFundMoney:f.ybPreSettleDetails.ybPayMoney,selfPayMoney:f.ybPreSettleDetails.selfPayMoney,selfYbMoney:f.ybPreSettleDetails.selfYbMoney,};f.pricingCharge=$.extend({},f.pricingCharge,j);f.pricingCharge.chargeFlag="4";f.pricingCharge.paymentTypeId="5";f.pricingCharge.feeTotalMoney=f.totalMoney+f.ybPreSettleDetails.ybPayMoney+f.ybPreSettleDetails.selfYbMoney;f.pricingCharge.totalMoney=f.totalMoney;var c=[];var i=f.pricingCharge.ybParams;var k=YBUtils.getYBBaseInfo();var h=k.ybOperatorId;for(var g=0;g<i.inputlist.length;g++){var l={ybItemNo:i.inputlist[g].FEE_DOC_NO,clinicId:i.clinidId,ybItemId:"",ybSettleCode:i.inputlist[g].YB_TREATMENT_CODE,itemName:i.inputlist[g].TREATMENT_NAME,itemSpec:"次",itemAmount:1,itemPrice:i.inputlist[g].TREATMENT_PRICE,itemMoney:i.inputlist[g].TREATMENT_PRICE,};c.push(l)}f.ybItemNo=i.inputlist[0].FEE_DOC_NO;e={ybBizStateVO:{ybBizRecord:{acographyId:i.acographyId},bizItems:c,bizFee:{delFlag:0,presetStatus:0,ybItemNo:i.inputlist[0].FEE_DOC_NO,ybOptUser:h,ybActBalance:0,ybBefeBalance:0,ybPayState:0,settleSerialNo:i.settlementSerialNum||""}},pricingChargeVO:f}}}var o={url:ContextClinc_Server+"ybReimburse/commonYBSave/saveYBUploadInfo",dataType:"json",type:"POST",data:JSON.stringify(e),contentType:"application/json;charset=utf-8",showMask:true};var n=Utils.myAjaxHandler(o);n.done(function(p){if(p!=null&&p.errorCode==SUCCESSCODE){m(p.data)}else{$("#pay_confirm_btn").removeClass("disabled");$.paError(p.errorMessage)}}).fail(function(){$("#pay_confirm_btn").removeClass("disabled");isChargeSubmited=false;$.paConfirm({msg:"请求未响应，请检查医保服务网络连接！",saveTxt:"确定",hideCancel:true,onYes:function(){}})})}};