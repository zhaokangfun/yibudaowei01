var empiId=Utils.getQueryString("empiId");var acographyId=Utils.getQueryString("acographyId");var treatmentState=Utils.getQueryString("treatmentState");var triageId=Utils.getQueryString("triageId");var recordId=Utils.getQueryString("recordId");var sex=Utils.getQueryString("sex");var isYbReg=Utils.getQueryString("isYbReg");var physiotherapy=Utils.getQueryString("physiotherapy");var userInfo_aclc=config_cache.getCache("medical_user_data");var finishPatFlag=true;var physiotherapy_Main=Class.create({readonly:false,currentTabIndex:0,physiotherapys:[],empi:null,personalPhysiotherapyTmpls:[],clinicPhysiotherapyTmpls:[],hisPhysiotherapys:[],physiotherapyDateHis:[],chargeStatus:{},dwsAcography:{},treatmentStock:{},selectedDoctorInfo:{},pageSize:10,isShowFee:_.find(userInfo_aclc.clinicParams,function(a){return a.parameterCode=="3013"}).parameterValue==2?true:false,isYBFlag:(userInfo_aclc&&userInfo_aclc.clinic&&userInfo_aclc.clinic.tags)?(_.find(userInfo_aclc.clinic.tags,function(a){return a.tagCode=="MI"})!=undefined?true:false):false,userId:"",employeeName:"",_init:function(){$(".content-inner").show();physiotherapy_View.addEnterKeyListener();$(".content-inner").hide();if(physiotherapy){$("menuDoctorDiv").show();physiotherapy_Main.initMenuDoctorDropBox()}else{$("menuDoctorDiv").hide()}physiotherapy_Main.addMainListener();physiotherapy_Main.addDiagnosisListener();physiotherapy_Main.addRecipeTabListener();physiotherapy_Main.addCenterDisplayListener();physiotherapy_Main.addEditAreaListener();physiotherapy_Main.addhistoryListener();physiotherapy_Main.addTemplateListener();$(".drug-input").ketchup();$("#addDiagnosisPop").ketchup();$("#addPhysiotherapyPop").ketchup();$.when(physiotherapy_Action.queryExcutors(),physiotherapy_Action.getPhysiotherapysChargeStatus(),physiotherapy_Action.queryPhysiotherapys()).done(function(d,b,g){physiotherapy_View.loadReceiptHeader(physiotherapy_Main.empi);if(physiotherapy_Main.physiotherapys.length>0){physiotherapy_View.loadPhysiotherapyTabs(physiotherapy_Main.physiotherapys)}else{var e=$.extend(true,{},physiotherapy_Model.physiotherapy);e.physiotherapyNo=1;physiotherapy_Main.physiotherapys.push(e);physiotherapy_View.addPhysiotherapyTab("理疗单 "+e.physiotherapyNo)}physiotherapy_Main.currentTabIndex=0;physiotherapy_View.selectPhysiotherapyTab(physiotherapy_Main.currentTabIndex);var a=g[0]["data"];if(treatmentState==1){if(a.physiotherapies&&a.physiotherapies.length==1&&a.physiotherapies[0]["items"]&&a.physiotherapies[0]["items"].length==0){physiotherapy_View.changeToEditingStatus()}else{if(a.physiotherapies&&a.physiotherapies.length>0){physiotherapy_View.changeToReadonlyStatus()}else{physiotherapy_View.changeToEditingStatus()}}}else{if(treatmentState==2){physiotherapy_View.changeToReadonlyStatus();var f=0;$.each(physiotherapy_Main.physiotherapys,function(j,k){var h=k.items;$.each(h,function(i,l){f+=1})});if(f==0){physiotherapy_Action.getPhysiotherapyDateHis();var c=physiotherapy_Main.physiotherapyDateHis;if(c&&c.length>0){if(physiotherapy==1){$("#phy-completedNoData-historyRec").show()}else{$("#treat-completedNoData-historyRec").show()}}else{if(physiotherapy==1){$("#phy-completedNoData").show()}else{$("#treat-completedNoData").show()}}}}}$(".content-inner").show();physiotherapy_View.focusThinkBoxInput()});physiotherapy_Action.thinksearch();physiotherapy_Action.initChiefComThinkInput();physiotherapy_Action.getPhysiotherapyDateHis(function(a){physiotherapy_View.loadPhysiotherapyDateHisDrop(a);if(a&&a.length>0){$(".dateChoose").SelectWJZSDropdownFirstItem();var b=a[0];physiotherapy_Action.getPhysiotherapyHisByAcographyId(b.acographyId,b.empiId,b.clinicId)}})},addMainListener:function(){$(".savePhysiotherapys").on("click",function(){if($(this).text()=="保存"){physiotherapy_Action.savePhysiotherapys(function(){$.when(physiotherapy_Action.queryPhysiotherapys(),physiotherapy_Action.getPhysiotherapysChargeStatus()).done(function(b,a){physiotherapy_View.changeToReadonlyStatus()})})}else{physiotherapy_View.changeToEditingStatus()}});$(".print").on("click",function(){var b=new PhysiotherapyPrint();var a=physiotherapy_Main.physiotherapys[physiotherapy_Main.currentTabIndex];if(a&&a.physiotherapyId){b.doPrintFacade(a.physiotherapyId)}else{$.paError("请先保存后打印！")}});$(".static-menu-finish").on("click",function(){var a=$(this).text();if(a=="完成开单"){if(!physiotherapy_Main.readonly){$.paAlert("请先保存！");return}$.paConfirm({msg:"是否确定完成开单？",cancelTxt:"取消",saveTxt:"确认",onYes:function(){physiotherapy_Action.savePhysicalTherapyState()}})}else{physiotherapy_Action.getDwsAcographyById(function(c){var d=c.modifyDate;var b=new Date();if(b<=d+86400000){physiotherapy_Action.reVisitPatient()}else{$.paAlert("完成开单已超过24小时，不能重新开单！")}})}});$(".topNav").on("click",".topNav-item",function(){$(this).addClass("choose").siblings().removeClass("choose");if($(this).index()==0){$(".rightInfo-wrap>div").hide();if(physiotherapy_Main.physiotherapyDateHis&&physiotherapy_Main.physiotherapyDateHis.length>0){$(".historyRecipe").show();$(".noDataHint").hide()}else{$(".historyRecipe").hide();$(".noDataHint").show()}}else{if(physiotherapy_Main.clinicPhysiotherapyTmpls.length==0&&physiotherapy_Main.personalPhysiotherapyTmpls.length==0){physiotherapy_Action.queryPersonalPhysiotherapyTmpls();physiotherapy_Action.queryClinicPhysiotherapyTmpls()}$(".rightInfo-wrap>div").hide();$(".recipe-template").show()}});$(document).keypress(function(c){var a=$(".description:visible").is(":focus");if(a&&c.which==13){var b=$(".drug-input:visible").find(".update-drug");if(b.is(":visible")){physiotherapy_View.updateDrug()}else{physiotherapy_View.addDrug()}}})},initMenuDoctorDropBox:function(){var a=this;var c={acographyId:acographyId};var b={url:modify_visitDoctor_api.selectVisitInfo,method:"POST",data:c,dataType:"json",async:true};var d=Utils.myAjaxHandler(b);d.done(function(f){if(SUCCESSCODE==f.errorCode){var e=f.data;a.renderMenuDoctorDropBox(e)}else{$.paError(f.errorMessage,null)}}).fail(function(e){$.paError("请求异常",null)}).always(function(){})},renderMenuDoctorDropBox:function(f){if(!f||!f.clinicDoctors||f.clinicDoctors.length<=0){$.paError("获取不到就诊医生列表");return}var c=this;var g=f.clinicDoctors;var a={idKey:"USER_ID",txtKey:"EMPLOYEE_NAME",isNeedClear:false,isNeedAll:true,isNeedThink:true};var b=$("#menuDoctor");var e=c.filterDoctorList(g);b.WJZSDropdown(g,a,function(h,i){c.modifyMenuDoctor(i)});if(f.visitDoctor&&f.visitDoctor.doctorId){var d=f.visitDoctor.doctorId;b.SelectWJZSDropdownItem(d)}else{b.SelectWJZSDropdownFirstItem()}},modifyMenuDoctor:function(f){var a=this;var d=f.USER_ID;var c=f.EMPLOYEE_NAME;if(d==a.selectedDoctorInfo.userId&&c==a.selectedDoctorInfo.doctorName){return}var e={acographyId:acographyId,doctorId:d,doctorName:c};var b={url:modify_visitDoctor_api.updateVisitInfo,method:"POST",data:e,dataType:"json"};var g=Utils.myAjaxHandler(b);g.done(function(h){if(SUCCESSCODE==h.errorCode){if(setRecipeDoctor){a.selectedDoctorInfo.userId=d;a.selectedDoctorInfo.doctorName=c;setRecipeDoctor(d,c)}}else{$.paError(h.errorMessage,null)}}).fail(function(h){$.paError("请求异常",null)}).always(function(){})},filterDoctorList:function(c){var a=this;var b=new Array();if(c){c.forEach(function(e,d,f){if(f[d].USER_ID){b.push(f[d])}})}return b},addDiagnosisListener:function(){$(".editorBtn").click(function(){$("#westDiagnosis").val($("#westDiagnosis").data("westDiagnosis"));$("#westDiagnosis").attr("val",$("#westDiagnosis").data("diagnosisCode"));$("#chineseTraDiagnosis").val($("#chineseTraDiagnosis").data("chineseTraDiagnosis"));$("#chineseTraDiagnosis").attr("val",$("#chineseTraDiagnosis").data("chineseDiagnosisCode"));$("#addDiagnosisPop").show()});$("#closeDiagnosis").off("click").on("click",function(){$("#addDiagnosisPop").hide()});$("#add-cancel").off("click").on("click",function(){$("#addDiagnosisPop").hide()});$("#add-save").off("click").on("click",function(){var b=$("#addDiagnosisPop").ableToFinish();if(!b){return}var a=$("#chineseTraDiagnosis").val();var c={};c.acographyId=acographyId;c.empiId=empiId;c.chineseTraDiagnosis=a;c.chineseDiagnosisCode=$("#chineseTraDiagnosis").attr("val");c.dwsDiagnosisRecordList=physiotherapy_Action.getWestDiagnosis();physiotherapy_Action.saveCnMedical(c)})},addRecipeTabListener:function(){$(".recipe-label>ul").on("click","li>span",function(){var a=Number($(this).parent().attr("itemIndex"));physiotherapy_Main.currentTabIndex=a;physiotherapy_View.selectPhysiotherapyTab(a)});$(".add-recipe").off("click").on("click",function(){var e=$(".recipe-label>ul>li").length;if(e==6){$.paError("最多能添加6张理疗单");return}var d=$(this).prev().find("li:last").find("span").text();var b=d.substr(d.length-1);var a=$.extend(true,{},physiotherapy_Model.physiotherapy);a.physiotherapyNo=Number(b)+1;physiotherapy_Main.physiotherapys.push(a);var c=physiotherapy_View.addPhysiotherapyTab("理疗单 "+a.physiotherapyNo);physiotherapy_Main.currentTabIndex=c;physiotherapy_View.selectPhysiotherapyTab(c)});$(".recipe-label>ul").on("click",".delete",function(){var b=Number($(this).parent().attr("itemIndex"));var c=physiotherapy_Main.physiotherapys[b];if(c&&c.physiotherapyId&&physiotherapy_Main.chargeStatus[c.physiotherapyId]&&physiotherapy_Main.chargeStatus[c.physiotherapyId]>3){$.paAlert("当前理疗单不可删除");return}var a=$(".recipe-label>ul .checked").find("span").text();$.paConfirm({msg:"删除"+a+"，请确认!",cancelTxt:"取消",saveTxt:"确认",onYes:function(){if(c.physiotherapyId){physiotherapy_Action.deletePhysiotherapyById(c.physiotherapyId,function(){$(this).parent().remove();var e=physiotherapy_Main.physiotherapys.length;if(c){physiotherapy_Main.physiotherapys.splice(b,1)}physiotherapy_View.loadPhysiotherapyTabs(physiotherapy_Main.physiotherapys);if(b==0&&e==1){$(".pill-middle-info .pill-list-content .pill-listBox>ul").empty();if(physiotherapy_Main.isShowFee){$(".china-totalPrice").html(physiotherapy_Main.toDecimal2(0));$(".china-totalPrice2").parent().show();$(".china-totalPrice2").html("￥"+physiotherapy_Main.toDecimal2(0))}else{$(".china-totalPrice").html("-");$(".china-totalPrice2").parent().hide();$(".china-totalPrice2").html("-")}physiotherapy_Main.currentTabIndex=-1}else{if(b==0&&e>1){physiotherapy_View.selectPhysiotherapyTab(0);physiotherapy_Main.currentTabIndex=0}else{if(b<e){physiotherapy_View.selectPhysiotherapyTab(b-1);physiotherapy_Main.currentTabIndex=b-1}}}})}else{$(this).parent().remove();var d=physiotherapy_Main.physiotherapys.length;if(c){physiotherapy_Main.physiotherapys.splice(b,1)}physiotherapy_View.loadPhysiotherapyTabs(physiotherapy_Main.physiotherapys);if(b==0&&d==1){$(".pill-middle-info .pill-list-content .pill-listBox>ul").empty();if(physiotherapy_Main.isShowFee){$(".china-totalPrice").html(physiotherapy_Main.toDecimal2(0));$(".china-totalPrice2").parent().show();$(".china-totalPrice2").html("￥"+physiotherapy_Main.toDecimal2(0))}else{$(".china-totalPrice").html("-");$(".china-totalPrice2").parent().hide();$(".china-totalPrice2").html("-")}physiotherapy_Main.currentTabIndex=-1}else{if(b==0&&d>1){physiotherapy_View.selectPhysiotherapyTab(0);physiotherapy_Main.currentTabIndex=0}else{if(b<d){physiotherapy_View.selectPhysiotherapyTab(b-1);physiotherapy_Main.currentTabIndex=b-1}}}}}})})},addCenterDisplayListener:function(){$(".pill-listBox").on("click",".pill-list-item",function(){$(".pill-listBox").find(".pill-list-item").removeClass("checked");$(this).addClass("checked");if(physiotherapy_Main.readonly){$(this).find(".close-order-list").attr("style","display: none!important;")}else{var a=Number($(".pill-status>i").attr("chargeStatus"));if(a>3){$(this).find(".close-order-list").attr("style","display: none!important;")}else{$(".pill-listBox>ul").find(".close-order-list").attr("style","display: none!important;");$(this).find(".close-order-list").attr("style","display:inline-block!important;")}}physiotherapy_View.clearDrugInput();var b=$(this).attr("itemIndex");var e=physiotherapy_Main.physiotherapys[physiotherapy_Main.currentTabIndex];var d=e.items;var c=d[b];setTimeout(function(){$("#treatmentId").val(c.treatmentId);$("#treatmentName").val(c.treatmentName);$("#treatmentType").val(c.treatmentType);$("#treatmentUnitId").val(c.treatmentUnitId);$("#treatmentUnitName").val(c.treatmentUnitName);$("#treatmentPrice").val(c.price);$("#treatmentiItemIndex").val(b);$(".thinkBoxInputArea").val(c.treatmentName);$(".china-drugDose").val(c.qty);$(".description").val(c.description);$(".china-drugDose").select()},50);$(".thinkBoxInputArea").attr("disabled","disabled");$(".update-drug").show();$(".delete-drug").show();$(".add-drug").hide()});$(".pill-listBox").on("mouseenter",".pill-list-item",function(){if(!physiotherapy_Main.readonly){$(this).find(".close-order-list").attr("style","display:inline-block!important;")}}).on("mouseleave",".pill-list-item",function(){if(!physiotherapy_Main.readonly){if(!$(this).hasClass("checked")){$(this).find(".close-order-list").attr("style","display: none!important;")}}});$(".pill-listBox").on("click",".close-order-list",function(b){var a=Number($(this).parent().attr("itemIndex"));var d=physiotherapy_Main.physiotherapys[physiotherapy_Main.currentTabIndex];var c=d.items;c.splice(a,1);physiotherapy_View.loadTreatmentReceipt(d);physiotherapy_View.clearDrugInput();physiotherapy_View.focusThinkBoxInput();$(".update-drug").hide();$(".delete-drug").hide();$(".add-drug").show();b.stopPropagation()})},addEditAreaListener:function(){$(".add-drug").off("click").on("click",function(){if(physiotherapy_View.addDrug()){physiotherapy_View.focusThinkBoxInput()}});$(".update-drug").off("click").on("click",function(){if(physiotherapy_View.updateDrug()){physiotherapy_View.focusThinkBoxInput()}});$(".empty-drug").off("click").on("click",function(){physiotherapy_View.clearDrugInput();physiotherapy_View.focusThinkBoxInput();physiotherapy_View.loadTreatmentReceipt(physiotherapy_Main.physiotherapys[physiotherapy_Main.currentTabIndex])});$(".delete-drug").off("click").on("click",function(){var b=$(".pill-listBox ul").find(".checked");if(!b||b.length==0){return}var a=Number(b.attr("itemIndex"));var d=physiotherapy_Main.physiotherapys[physiotherapy_Main.currentTabIndex];var c=d.items;c.splice(a,1);physiotherapy_View.loadTreatmentReceipt(d);physiotherapy_View.clearDrugInput();physiotherapy_View.focusThinkBoxInput();$(".update-drug").hide();$(".delete-drug").hide();$(".add-drug").show()})},addhistoryListener:function(){$(".historyDetail").on("click",".historyDetail-head>i",function(){var b=$(this).parents(".historyDetail-item");var a=b.siblings(".choose");if($(this).hasClass("collapse")){$(this).attr("class","expand fr");$(this).parent().next().slideUp();b.removeClass("choose")}else{$(this).attr("class","collapse fr");$(this).parent().next().slideDown();b.addClass("choose");a.find(".historyDetail-head>i").attr("class","expand fr");a.children(".historyDetail-content").slideUp();a.removeClass("choose")}});$(".dateChooser .prev").on("click",function(){var c=$(".dateChoose").attr("val");var b=physiotherapy_Main.findCurrentDateIndex(c);if(b==0){$.paAlert("没有更多处方记录")}else{var a=physiotherapy_Main.physiotherapyDateHis[b-1];$(".dateChoose").SetWJZSDropdownSelectedData(a.acographyId);physiotherapy_Action.getPhysiotherapyHisByAcographyId(a.acographyId,a.empiId,a.clinicId)}});$(".dateChooser .next").on("click",function(){var c=$(".dateChoose").attr("val");var a=physiotherapy_Main.findCurrentDateIndex(c);if(a==(physiotherapy_Main.physiotherapyDateHis.length-1)){$.paAlert("没有更多处方记录")}else{var b=physiotherapy_Main.physiotherapyDateHis[a+1];$(".dateChoose").SetWJZSDropdownSelectedData(b.acographyId);physiotherapy_Action.getPhysiotherapyHisByAcographyId(b.acographyId,b.empiId,b.clinicId)}});$(".historyDetail").on("click",".normal-btn",function(){if(physiotherapy_Main.readonly){$.paAlert("当前不可操作！");return}var c=$(this).parent().parent().parent().index();var f=$(".recipe-label-item.checked>span").text();f=f.substring(f.length-2);var a=physiotherapy_Main.hisPhysiotherapys[c];var e=$.extend(true,{},physiotherapy_Model.physiotherapy);e.physiotherapyNo=f;e.totalPrice=a.totalPrice;var b=a.items;$.each(b,function(g,j){var h=$.extend(true,{},physiotherapy_Model.physiotherapy_item);h.description=j.description;h.orderNum=j.orderNum;h.price=j.price;h.qty=j.qty;h.treatmentId=j.treatmentId;h.treatmentName=j.treatmentName;h.treatmentType=j.treatmentType;h.treatmentUnitId=j.treatmentUnitId;h.treatmentUnitName=j.treatmentUnitName;e.items.push(h)});var d=physiotherapy_Main.physiotherapys[physiotherapy_Main.currentTabIndex];if(d.items&&d.items.length>0){physiotherapy_View.referencePhysiotherapyTmpl(e)}else{if(physiotherapy_Main.chargeStatus&&d.physiotherapyId&&physiotherapy_Main.chargeStatus[d.physiotherapyId]&&physiotherapy_Main.chargeStatus[d.physiotherapyId]>3){$.paAlert("当前不可操作！");return}physiotherapy_Main.physiotherapys[physiotherapy_Main.currentTabIndex]=e;physiotherapy_View.loadTreatmentReceipt(e)}})},addTemplateListener:function(){$(".tmpl-css-wrap").on("click",".recipe-template-title",function(){$(this).toggleClass("collapse");$(this).next().slideToggle()});$("#teml_btn_search").on("click",function(){physiotherapy_Action.queryClinicPhysiotherapyTmpls();physiotherapy_Action.queryPersonalPhysiotherapyTmpls()});$("#china-tmpl-doctor-ul").on("click","li",function(){if(physiotherapy_Main.readonly){$.paAlert("当前不可操作！");return}var c=$(this).index();var a=physiotherapy_Main.personalPhysiotherapyTmpls[c];var b=a.items;var e=$.extend(true,{},physiotherapy_Model.physiotherapy);e.totalPrice=a.totalPrice;var f=$(".recipe-label-item.checked>span").text();f=f.substring(f.length-2);e.physiotherapyNo=f;$.each(b,function(g,j){var h=$.extend(true,{},physiotherapy_Model.physiotherapy_item);h.description=j.description;h.orderNum=j.orderNum;h.price=j.price;h.qty=j.qty;h.treatmentId=j.treatmentId;h.treatmentName=j.treatmentName;h.treatmentType=j.treatmentType;h.treatmentUnitId=j.treatmentUnitId;h.treatmentUnitName=j.treatmentUnitName;e.items.push(h)});var d=physiotherapy_Main.physiotherapys[physiotherapy_Main.currentTabIndex];if(d&&d.items.length>0){physiotherapy_View.referencePhysiotherapyTmpl(e)}else{if(physiotherapy_Main.chargeStatus&&d.physiotherapyId&&physiotherapy_Main.chargeStatus[d.physiotherapyId]&&physiotherapy_Main.chargeStatus[d.physiotherapyId]>3){$.paAlert("当前不可操作！");return}physiotherapy_Main.physiotherapys[physiotherapy_Main.currentTabIndex]=e;physiotherapy_View.loadTreatmentReceipt(e)}});$("#china-tmpl-clinic-ul").on("click","li",function(){if(physiotherapy_Main.readonly){$.paAlert("当前不可操作！");return}var b=$(this).index();var d=physiotherapy_Main.clinicPhysiotherapyTmpls[b];var a=d.items;var e=$.extend(true,{},physiotherapy_Model.physiotherapy);e.totalPrice=d.totalPrice;var f=$(".recipe-label-item.checked>span").text();f=f.substring(f.length-2);e.physiotherapyNo=f;$.each(a,function(g,j){var h=$.extend(true,{},physiotherapy_Model.physiotherapy_item);h.description=j.description;h.orderNum=j.orderNum;h.price=j.price;h.qty=j.qty;h.treatmentId=j.treatmentId;h.treatmentName=j.treatmentName;h.treatmentType=j.treatmentType;h.treatmentUnitId=j.treatmentUnitId;h.treatmentUnitName=j.treatmentUnitName;e.items.push(h)});var c=physiotherapy_Main.physiotherapys[physiotherapy_Main.currentTabIndex];if(c&&c.items.length>0){physiotherapy_View.referencePhysiotherapyTmpl(e)}else{if(physiotherapy_Main.chargeStatus&&c.physiotherapyId&&physiotherapy_Main.chargeStatus[c.physiotherapyId]&&physiotherapy_Main.chargeStatus[c.physiotherapyId]>3){$.paAlert("当前不可操作！");return}physiotherapy_Main.physiotherapys[physiotherapy_Main.currentTabIndex]=e;physiotherapy_View.loadTreatmentReceipt(e)}});$(".saveAs").on("click",function(){$("#templateName").val("");$("#addPhysiotherapyPop").show()});$("#closePhysiotherapy").off("click").on("click",function(){$("#addPhysiotherapyPop").hide()});$("#physiotherapy-cancel").off("click").on("click",function(){$("#addPhysiotherapyPop").hide()});$("#physiotherapy-save").on("click",function(){var d=$("#addPhysiotherapyPop").ableToFinish();if(!d){return}var h=physiotherapy_Main.physiotherapys[physiotherapy_Main.currentTabIndex];var e=h.items;if(e.length==0){$.paWarn("当前理疗单无项目，请添加！");return}var c=$("#templateName").val();var f=$("#templateType").find(".checked").attr("val");if(Utils.notBlank(c)){var b=0;var g=physiotherapy_Action.checkTemplateNameUse({templateName:c,templateType:f});if(!g){var a=$.extend(true,{},physiotherapy_Model.physiotherapyTmpl);a.templateName=c;a.templateType=f;$.each(e,function(j,l){var k=$.extend(true,{},physiotherapy_Model.physiotherapy_item);k.description=l.description;k.price=l.price;k.qty=l.qty;k.treatmentId=l.treatmentId;k.treatmentName=l.treatmentName;k.treatmentType=l.treatmentType;k.treatmentUnitId=l.treatmentUnitId;k.treatmentUnitName=l.treatmentUnitName;k.orderNum=j+1;b=Utils.accAdd(b,Utils.accMul(l.price,l.qty));a.items.push(k)});a.totalPrice=b;physiotherapy_Action.savePhysiotherapyTmpl(a)}else{$.paError("模板名字已存在!")}}else{$.paError("模板名称不能为空!")}})},findCurrentDateIndex:function(c){var a=this;var b=-1;if(a.physiotherapyDateHis&&a.physiotherapyDateHis.length>0){$.each(a.physiotherapyDateHis,function(d,e){if(e.acographyId==c){b=d;return false}})}return b},getTreatmentIds:function(b){var a=[];$.each(b,function(d,e){var c=e.items;$.each(c,function(f,g){if($.inArray(g.treatmentId,a)<0){a.push(g.treatmentId)}})});return a},refreshTreatmentNameAndPrice:function(c){var b=physiotherapy_Main.getTreatmentIds(c);var a=[];$.each(b,function(e,d){if(!physiotherapy_Main.treatmentStock[d]){a.push(d)}});if(a.length>0){$.when(physiotherapy_Action.getMdcDictTreatmentWithIds(b,true)).done(function(d){$.each(c,function(f,g){var e=g.items;$.each(e,function(k,l){var i=physiotherapy_Main.treatmentStock[l.treatmentId];if(i){l.treatmentName=i.TREATMENT_NAME;l.treatmentType=i.ITEM_TYPE_NAME=="单项"?1:2;l.treatmentUnitId=i.TREATMENT_UNIT;l.treatmentUnitName=i.TREATMENT_UNIT_NAME;var h=(isYbReg!=1&&physiotherapy_Main.isYBFlag)?i.CEILING_PRICE:i.TREATMENT_PRICE;if(h){l.price=h}else{l.price=0}}})})})}},toDecimal2:function(a){var d=parseFloat(a);if(isNaN(d)||d<0){return"0.00"}var d=Math.round(a*100)/100;var c=d.toString();var b=c.indexOf(".");if(b<0){b=c.length;c+="."}while(c.length<=b+2){c+="0"}return c},toDecimal4:function(a){var d=parseFloat(a);if(isNaN(d)||d<0){return"0.0000"}var d=Math.round(a*10000)/10000;var c=d.toString();var b=c.indexOf(".");if(b<0){b=c.length;c+="."}while(c.length<=b+4){c+="0"}return c}});var physiotherapy_Action=Class.create({queryPhysiotherapys:function(c){var a={url:physiotherapy_url.queryPhysiotherapys,dataType:"json",contentType:"application/json",data:JSON.stringify({empiId:empiId,acographyId:acographyId}),showMask:true,async:true};var b=Utils.myAjaxHandler(a);b.done(function(d){if(d!=null&&d.errorCode==SUCCESSCODE){physiotherapy_Main.empi=d.data["empi"];physiotherapy_Main.userId=d.data["empi"]["DOCTOR_ID"];physiotherapy_Main.employeeName=d.data["empi"]["DOCTOR_NAME"];if(d.data["physiotherapies"]&&d.data["physiotherapies"].length>0){physiotherapy_Main.physiotherapys=d.data["physiotherapies"]}if(c&&typeof c=="function"){c(d.data)}}else{$.paError(d.errorMessage)}}).fail(function(d){$.paError("操作失败!")}).always(function(){});return b},queryClinicDoctors:function(){var a={url:physiotherapy_url.queryClinicDoctors,dataType:"json",contentType:"application/json",data:JSON.stringify({}),showMask:true,async:true};var b=Utils.myAjaxHandler(a);b.done(function(c){if(c!=null&&c.errorCode==SUCCESSCODE){physiotherapy_View.loadClinicDoctorsDrop(c.data);$(".underline.doctorName").html($(".china-doctorName").val())}else{$.paError(c.errorMessage)}}).fail(function(c){$.paError("操作失败!")}).always(function(){});return b},queryExcutors:function(){var a={url:physiotherapy_url.queryClinicExcutors,dataType:"json",contentType:"application/json",data:JSON.stringify({}),showMask:true,async:true};var b=Utils.myAjaxHandler(a);b.done(function(c){if(c!=null&&c.errorCode==SUCCESSCODE){physiotherapy_View.loadExcutorsDrop(c.data);$(".excutorName").SelectWJZSDropdownFirstItem();var d=$(".excutorName").attr("val");if(Utils.notBlank(Utils.trimObj(d))){$(".readOnly-excutorName").html($(".excutorName").val())}else{$(".readOnly-excutorName").html("")}}else{$.paError(c.errorMessage)}}).fail(function(c){$.paError("操作失败!")}).always(function(){});return b},savePhysiotherapys:function(f){var e=physiotherapy_Main.physiotherapys;if(e.length==0){$.paWarn("当前无理疗单，不能保存！");return}physiotherapy_View.setExcutorInfo();var b=-1;$.each(e,function(g,j){j.userId=physiotherapy_Main.userId;j.employeeName=physiotherapy_Main.employeeName;var k=0;var h=j.items;if(h.length==0){b=g;return false}$.each(h,function(i,l){l.orderNum=i+1;k=Utils.accAdd(Utils.accMul(l.price,l.qty),k)});j.totalPrice=physiotherapy_Main.toDecimal2(k)});if(b>-1){var a="理疗单 "+e[b]["physiotherapyNo"]+" ";$.paWarn(a+"无项目，请添加！");return}var c={url:physiotherapy_url.savePhysiotherapys+"?acographyId="+acographyId+"&empiId="+empiId,dataType:"json",contentType:"application/json",data:JSON.stringify(physiotherapy_Main.physiotherapys),showMask:true,async:true};var d=Utils.myAjaxHandler(c);d.done(function(g){if(g!=null&&g.errorCode==SUCCESSCODE){$.paSuccess(g.errorMessage);if(f&&typeof f==="function"){f()}}else{$.paError(g.errorMessage)}}).fail(function(g){$.paError("操作失败!")}).always(function(){})},deletePhysiotherapyById:function(b,d){var a={url:physiotherapy_url.deletePhysiotherapyById+"?physiotherapyId="+b,dataType:"json",contentType:"application/json",data:JSON.stringify({}),showMask:true,async:true};var c=Utils.myAjaxHandler(a);c.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){$.paSuccess(e.errorMessage);if(d&&typeof d=="function"){d()}}else{$.paError(e.errorMessage)}}).fail(function(e){$.paError("操作失败!")}).always(function(){})},savePhysiotherapyTmpl:function(a){var b={url:physiotherapy_url.savePhysiotherapyTmpl,dataType:"json",contentType:"application/json",data:JSON.stringify(a),showMask:true,async:true};var c=Utils.myAjaxHandler(b);c.done(function(d){if(d!=null&&d.errorCode==SUCCESSCODE){$.paSuccess(d.errorMessage);$("#addPhysiotherapyPop").hide();physiotherapy_Action.queryPersonalPhysiotherapyTmpls();physiotherapy_Action.queryClinicPhysiotherapyTmpls()}else{$.paError(d.errorMessage)}}).fail(function(d){$.paError("操作失败!")}).always(function(){})},checkTemplateNameUse:function(c){var b=false;var a={url:physiotherapy_url.checkTemplateNameUse,dataType:"json",contentType:"application/json",data:JSON.stringify(c),showMask:true,async:false};var d=Utils.myAjaxHandler(a);d.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){if(e.data>0){b=true}}else{$.paError(e.errorMessage)}}).fail(function(e){$.paError("操作失败!")}).always(function(){});return b},saveCnMedical:function(b){var a={url:physiotherapy_url.saveCnMedical,dataType:"json",contentType:"application/json",data:JSON.stringify(b),showMask:true,async:true};var c=Utils.myAjaxHandler(a);c.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){$("#addDiagnosisPop").hide();var g=b.chineseTraDiagnosis;var d=b.dwsDiagnosisRecordList;var f=(null!=$("#westDiagnosis").val()?$("#westDiagnosis").val():"");if(f!=""){g+="；"+f}$(".diagnosis").text(Utils.notBlank(g)?g:"-");$(".diagnosis").attr("title",Utils.notBlank(g)?g:"-");$("#westDiagnosis").data("westDiagnosis",f);$("#westDiagnosis").data("diagnosisCode",null!=$("#westDiagnosis").attr("val")?$("#westDiagnosis").attr("val"):"");$("#chineseTraDiagnosis").data("chineseTraDiagnosis",null!=$("#chineseTraDiagnosis").val()?$("#chineseTraDiagnosis").val():"");$("#chineseTraDiagnosis").data("chineseDiagnosisCode",null!=$("#chineseTraDiagnosis").attr("val")?$("#chineseTraDiagnosis").attr("val"):"")}else{$.paError(e.errorMessage)}}).fail(function(d){$.paError("操作失败!")}).always(function(){})},getWestDiagnosis:function(){var e=[];var b=$("#westDiagnosis").attr("val");var c=$("#westDiagnosis").val();if(c!=null&&c!=undefined&&c!=""){if(b!=null&&b!=undefined){var d={};d.diagnosisIcd10=$("#westDiagnosis").val();d.diagnosisIcd10Code=$("#westDiagnosis").attr("val");e.push(d)}else{var a={};a.diagnosis=c;e.push(a)}}return e},queryPersonalPhysiotherapyTmpls:function(){$("#china-tmpl-doctor-ul").html("");var a=$(".searchTemplateName").val();var b={url:physiotherapy_url.queryPersonalPhysiotherapyTmpls,dataType:"json",contentType:"application/json",data:JSON.stringify({templateName:a}),showMask:true,async:true};var c=Utils.myAjaxHandler(b);c.done(function(d){if(d!=null&&d.errorCode==SUCCESSCODE){physiotherapy_Main.personalPhysiotherapyTmpls=d.data;physiotherapy_Main.refreshTreatmentNameAndPrice(d.data);physiotherapy_View.loadPersonalPhysiotherapyTmpls(d.data)}else{$.paError(d.errorMessage)}}).fail(function(d){$.paError("操作失败!")}).always(function(){})},queryClinicPhysiotherapyTmpls:function(){$("#china-tmpl-clinic-ul").html("");var a=$(".searchTemplateName").val();var b={url:physiotherapy_url.queryClinicPhysiotherapyTmpls,dataType:"json",contentType:"application/json",data:JSON.stringify({templateName:a}),showMask:true,async:true};var c=Utils.myAjaxHandler(b);c.done(function(d){if(d!=null&&d.errorCode==SUCCESSCODE){physiotherapy_Main.clinicPhysiotherapyTmpls=d.data;physiotherapy_Main.refreshTreatmentNameAndPrice(d.data);physiotherapy_View.loadClinicPhysiotherapyTmpls(d.data)}else{$.paError(d.errorMessage)}}).fail(function(d){$.paError("操作失败!")}).always(function(){})},getPhysiotherapyDateHis:function(d){var a=this;var b={url:physiotherapy_url.getPhysiotherapyDateHis,dataType:"json",contentType:"application/json",data:JSON.stringify({empiId:empiId,acographyId:acographyId}),showMask:false,async:false};var c=Utils.myAjaxHandler(b);c.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){physiotherapy_Main.physiotherapyDateHis=e.data;if(d&&typeof d=="function"){d(e.data)}}else{$.paError(e.errorMessage)}}).fail(function(e){$.paError("操作失败!")}).always(function(){})},getPhysiotherapyHisByAcographyId:function(c,e,b){var a={url:physiotherapy_url.getPhysiotherapyHisByAcographyId,dataType:"json",contentType:"application/json",data:JSON.stringify({acographyId:c,empiId:e,clinicId:b}),showMask:true,async:true};var d=Utils.myAjaxHandler(a);d.done(function(f){if(f!=null&&f.errorCode==SUCCESSCODE){physiotherapy_Main.hisPhysiotherapys=f.data.physiotherapies;physiotherapy_Main.refreshTreatmentNameAndPrice(f.data.physiotherapies);physiotherapy_View.loadPhysiotherapyHis(f.data);$(".historyDetail>ul>li:first").find(".historyDetail-head>i").click()}else{$.paError(f.errorMessage)}}).fail(function(f){$.paError("操作失败!")}).always(function(){})},thinksearch:function(){var c=[{display:"编码",dataKey:"TREATMENT_CODE",width:90},{display:"名称",dataKey:"TREATMENT_NAME",width:150},{display:"医保属性",dataKey:"FEE_LEVEL",width:60},{display:"单价",dataKey:(isYbReg!=1&&physiotherapy_Main.isYBFlag)?"CEILING_PRICE":"TREATMENT_PRICE",width:40},{display:"类型",dataKey:"ITEM_TYPE_NAME",width:30}];if(!physiotherapy_Main.isShowFee){c.splice(3,1)}if(!physiotherapy_Main.isYBFlag){c.splice(2,1)}var b={columns:c,extraParams:{key:"keyword",limitRows:20},rowHighlight:function(e){var d=false;if(physiotherapy_Main.isYBFlag){if(e.FEE_LEVEL=="未对照"){d=true}}return d},selectFirst:true,formatResult:function(d){return d.TREATMENT_NAME},formatMatch:function(f,e,d){return f.TREATMENT_NAME+"--"+f.TREATMENT_CODE+"--"+f.PY_CODE+"--"+f.WB_CODE},matchContains:"word",autoFill:false,width:500,multiple:false,multipleSeparator:", ",highlight:function(e,d){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+d.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:180};var a=ContextClinc_Server+"intentInput/getTreatmentItemAndExam";$(".thinkBoxInputArea").autocomplete(a,b).result(function(d,h,i){var e=h.TREATMENT_ID;var f=h.TREATMENT_NAME;var k=h.ITEM_TYPE_NAME=="单项"?1:2;var l=h.TREATMENT_UNIT;var j=h.TREATMENT_UNIT_NAME;var g=(isYbReg!=1&&physiotherapy_Main.isYBFlag)?h.CEILING_PRICE:h.TREATMENT_PRICE;$("#treatmentId").val(e);$("#treatmentName").val(f);$("#treatmentType").val(k);$("#treatmentUnitId").val(l);$("#treatmentUnitName").val(j);$("#treatmentPrice").val(g);$(".china-drugDose").focus()})},initChiefComThinkInput:function(){var c={canedit:true,columns:[{display:"编码",dataKey:"DICT_DIAGNOSIS_CODE",width:60},{display:"名称",dataKey:"DICT_DIAGNOSIS_NAME",width:230}],extraParams:{key:"keyword",pageSize:20,isJoinMI:isYbReg==1?1:0,diagonsisType:"0"},selectFirst:true,formatResult:function(d){return},formatMatch:function(f,e,d){return f.DICT_DIAGNOSIS_NAME+"--"+f.DICT_DIAGNOSIS_CODE+"--"+f.PY_CODE+"--"+f.WB_CODE},matchContains:"word",autoFill:false,width:485,max:100,multiple:false,multipleSeparator:", ",highlight:function(e,d){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+d.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:180};var a={canedit:true,columns:[{display:"编码",dataKey:"DICT_DIAGNOSIS_CODE",width:60},{display:"名称",dataKey:"DICT_DIAGNOSIS_NAME",width:230}],extraParams:{key:"keyword",pageSize:20,diagonsisType:"1"},selectFirst:true,formatResult:function(d){return},formatMatch:function(f,e,d){return f.DICT_DIAGNOSIS_NAME+"--"+f.DICT_DIAGNOSIS_CODE+"--"+f.PY_CODE+"--"+f.WB_CODE},matchContains:"word",autoFill:false,width:485,max:100,multiple:false,multipleSeparator:", ",highlight:function(e,d){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+d.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:180};var b=ContextClinc_Server+"dwsCnMedical/getMdcDictChiefComplaint";document.getElementById("westDiagnosis").oninput=function(){$("#westDiagnosis").attr("val","")};document.getElementById("chineseTraDiagnosis").oninput=function(){$("#chineseTraDiagnosis").attr("val","")};$("#westDiagnosis").autocomplete(b,c).result(function(d,f,e){$("#westDiagnosis").val(f.DICT_DIAGNOSIS_NAME);$("#westDiagnosis").attr("val",f.DICT_DIAGNOSIS_CODE)});$("#chineseTraDiagnosis").autocomplete(b,a).result(function(d,f,e){$("#chineseTraDiagnosis").val(f.DICT_DIAGNOSIS_NAME);$("#chineseTraDiagnosis").removeClass("pawjzs-error");$("#chineseTraDiagnosis").attr("val",f.DICT_DIAGNOSIS_CODE)})},savePhysicalTherapyState:function(){var b=$.extend(true,{},physiotherapy_Model.dwsAcography);var a={url:physicalTherapy_url.savePhysicalTherapyState,dataType:"json",contentType:"application/json",data:JSON.stringify(b),showMask:true,async:true};var c=Utils.myAjaxHandler(a);c.done(function(d){if(d!=null&&d.errorCode==SUCCESSCODE){if(Utils.notBlank(d.data.openId)){cthis.sendWEIXINMessage(tatus.data)}$.paSuccess("开单已完成!");treatmentState=2;window.location.href="./workstationIndex.html?empiId="+empiId+"&acographyId="+acographyId+"&treatmentState="+treatmentState+"&triageId="+triageId+"&recordId="+recordId+"&sex="+sex+"&isYbReg="+isYbReg+"&physiotherapy="+physiotherapy}else{$.paError(d.errorMessage)}}).fail(function(d){$.paError("操作失败!")}).always(function(){})},reVisitPatient:function(){var a=this;var c={dwsAcography:{empiId:empiId,recordId:recordId,triageId:triageId,acographyId:acographyId}};var d={url:physicalTherapy_url.reSavePhysicalTherapyState,dataType:"json",data:JSON.stringify(c),contentType:"application/json",showMask:true};var b=Utils.myAjaxHandler(d);b.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){treatmentState=1;window.location.href="./physiotherapy.html?empiId="+empiId+"&acographyId="+acographyId+"&treatmentState="+treatmentState+"&triageId="+triageId+"&recordId="+recordId+"&sex="+sex+"&isYbReg="+isYbReg+"&physiotherapy="+physiotherapy}else{$.paError(e.errorMessage)}}).fail(function(e){$.paError("重新接诊失败!")})},sendWEIXINMessage:function(e){if(e){var g=Utils.trimObj(e.clinicName);var b=Utils.trimObj(e.addressName);var a=Utils.trimObj(e.visitName);var c=Utils.trimObj(e.openId);var h=Utils.trimObj(e.acographySerialNum);var i=Utils.trimObj(e.payMoney);var d=Utils.trimObj(e.addDate);if(g&&b&&h&&i&&a&&d&&c){var f={clinicName:g,addressName:b,acographySerialNum:h,payMoney:i,visitName:a,addDate:d,openId:c};var k={type:"POST",contentType:"application/json; charset=utf-8",url:WXServicePath+"TempNoPay",data:JSON.stringify(f),dataType:"json"};var j=Utils.myAjaxHandler(k);j.done(function(l){if(l){}}).fail(function(l){}).always(function(){})}}},getPhysiotherapysChargeStatus:function(){var a={url:physiotherapy_url.getPhysiotherapysChargeStatus+"?acographyId="+acographyId,dataType:"json",contentType:"application/json",data:JSON.stringify({}),showMask:true,async:true};var b=Utils.myAjaxHandler(a);b.done(function(c){if(c!=null&&c.errorCode==SUCCESSCODE){physiotherapy_Main.chargeStatus=c.data}else{$.paError(c.errorMessage)}}).fail(function(c){$.paError("操作失败!")}).always(function(){});return b},getDwsAcographyById:function(c){var a={url:physiotherapy_url.getDwsAcographyById+"?acographyId="+acographyId,dataType:"json",contentType:"application/json",data:JSON.stringify({}),showMask:true,async:false};var b=Utils.myAjaxHandler(a);b.done(function(d){if(d!=null&&d.errorCode==SUCCESSCODE){physiotherapy_Main.dwsAcography=d.data;if(c&&typeof c==="function"){c(d.data)}}else{$.paError(d.errorMessage)}}).fail(function(d){$.paError("操作失败!")}).always(function(){})},getMdcDictTreatmentWithIds:function(d,b){var a={url:IntentInput_url.getMdcDictTreatmentByIds,dataType:"json",contentType:"application/json",data:JSON.stringify(d),showMask:true,async:b};var c=Utils.myAjaxHandler(a);c.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){if(e.data&&e.data.length>0){var f=e.data;$.each(f,function(j,h){var g=h.TREATMENT_ID;physiotherapy_Main.treatmentStock[g]=h})}}else{$.paError(e.errorMessage)}}).fail(function(e){$.paError("操作失败!")}).always(function(){});return c}});var physiotherapy_View=Class.create({loadReceiptHeader:function(f){var b=this;$(".clinic-name").text(userInfo_aclc.clinicName);$(".acography-serial-no").text(f.ACOGRAPHY_SERIAL_NO);$(".patient-healthCard").text(f.INSURANCE_NO?f.INSURANCE_NO:"-");$(".patient-name").text(f.PATIENT_NAME?f.PATIENT_NAME:"-");$(".patient-gender").text(f.PATIENT_GENDER?b.transferGender(f.PATIENT_GENDER):"-");$(".patient-age").text(f.PATIENT_BIRTH_DATE?Utils.getPersonAccurateAge(f.PATIENT_BIRTH_DATE):"-");$(".department-name").text(f.DEPARTMENT_NAME?f.DEPARTMENT_NAME:"-");$(".payment-type-name").text(f.MI_TYPE_NAME?f.MI_TYPE_NAME:"自费");$(".patient-no").text(f.PATIENT_NO?f.PATIENT_NO:"-");var d=Utils.notBlank(f.LIVING_ADDRESS_COUNTRYSIDE)?f.LIVING_ADDRESS_COUNTRYSIDE:"-";var a=Utils.notBlank(f.MOBILE_PHONE_NUMBER)?f.MOBILE_PHONE_NUMBER:"-";$(".living-address-countryside").text(d+"/"+a).attr("title",d+"/"+a);var c="";if(f.CHINESE_TRA_DIAGNOSIS){c=f.CHINESE_TRA_DIAGNOSIS;if(f.DiagnosisList){c+="；"+f.DiagnosisList}}else{c+=Utils.trimObj(f.DiagnosisList)}$(".diagnosis").text(Utils.notBlank(c)?c:"-");$(".diagnosis").attr("title",Utils.notBlank(c)?c:"-");$("#chineseTraDiagnosis").val(Utils.trimObj(f.CHINESE_TRA_DIAGNOSIS));$("#chineseTraDiagnosis").attr("val",Utils.trimObj(f.CHINESE_DIAGNOSIS_CODE));$("#chineseTraDiagnosis").data("chineseTraDiagnosis",Utils.trimObj(f.CHINESE_TRA_DIAGNOSIS));$("#chineseTraDiagnosis").data("chineseDiagnosisCode",Utils.trimObj(f.CHINESE_DIAGNOSIS_CODE));$("#westDiagnosis").attr("val",Utils.trimObj(f.diagnosisCode));$("#westDiagnosis").val(Utils.trimObj(f.DiagnosisList));$("#westDiagnosis").data("westDiagnosis",Utils.trimObj(f.DiagnosisList));$("#westDiagnosis").data("diagnosisCode",Utils.trimObj(f.diagnosisCode));var e=new Date().getTime();if(physiotherapy_Main.physiotherapys&&physiotherapy_Main.physiotherapys[physiotherapy_Main.currentTabIndex]){var g=physiotherapy_Main.physiotherapys[physiotherapy_Main.currentTabIndex];if(g.addDate){e=g.addDate}}$(".add-date").text(Utils.timeStampToDateStr(e,7))},loadTreatmentReceipt:function(g){var d=1;var c=this;var h="";var b=g.items;if(b&&b.length>0){d=Math.ceil(b.length/physiotherapy_Main.pageSize);$(".pill-listBox").show();$(".without-drugs").hide()}else{$(".pill-listBox").hide();if(!physiotherapy_Main.readonly){$(".without-drugs").show()}}$(".page").html(d);$.each(b,function(j,k){h+=c.concatReceiptItem(j,k)});$(".pill-middle-info .pill-list-content .pill-listBox>ul").html(h);var f=c.calcTotalMoney(b);if(physiotherapy_Main.isShowFee){$(".china-totalPrice").html(f);$(".china-totalPrice2").parent().show();$(".china-totalPrice2").html("￥"+f)}else{$(".china-totalPrice").html("-");$(".china-totalPrice2").parent().hide();$(".china-totalPrice2").html("-")}var e=g.physiotherapyId;var a=physiotherapy_Main.chargeStatus[e];if(a&&a>3){$(".china-doctorName").val(g.employeeName);$(".underline.doctorName").html(g.employeeName)}else{$(".china-doctorName").val(physiotherapy_Main.employeeName);$(".underline.doctorName").html(physiotherapy_Main.employeeName)}if(Utils.notBlank(g.executorId)){$(".excutorName").SetWJZSDropdownSelectedData(g.executorId);$(".readOnly-excutorName").html(g.executorName);physiotherapy_View.setExcutorInfo()}else{$(".excutorName").SetWJZSDropdownSelectedData("");$(".readOnly-excutorName").html("")}},concatReceiptItem:function(b,d){var f=Utils.trimObj(d.treatmentName);var e=physiotherapy_Main.isShowFee?physiotherapy_Main.toDecimal2(d.price):"-/"+(d.treatmentUnitName?d.treatmentUnitName:"");var a=d.qty;var c=Utils.trimObj(d.description);var g='<li class="pill-list-item clear" itemIndex="'+b+'">';g+='	<div class="list-number">'+(b+1)+".</div>";g+='	<div class="drug-40per" title="'+f+'">'+f+"</div>";g+='	<div class="drug-20per" title="'+e+'">'+e+"</div>";g+='	<div class="drug-10per" title="'+a+'">'+a+"</div>";g+='	<div class="drug-20per" title="'+c+'">'+c+"</div>";g+='	<span class="close-order-list">×</span>';g+="</li>";return g},transferGender:function(a){var b="";switch(Number(a)){case 1:b="男";break;case 2:b="女";break;case 3:b="保密";break}return b},calcTotalMoney:function(b){var a=0;$.each(b,function(c,d){a+=Utils.accMul(d.price,d.qty)});return physiotherapy_Main.toDecimal2(a)},loadClinicDoctorsDrop:function(c){var a={idKey:"USER_ID",txtKey:"EMPLOYEE_NAME",isNeedClear:false};if(c&&c.length>0){$(".china-doctorName").WJZSDropdown(c,a,function(d,e){physiotherapy_View.setDoctorInfo()})}else{var b=[{EMPLOYEE_NAME:userInfo_aclc.userName,USER_ID:userInfo_aclc.userId}];$(".china-doctorName").WJZSDropdown(b,a,function(d,e){physiotherapy_View.setDoctorInfo()})}},loadExcutorsDrop:function(d,f){var a={idKey:"USER_ID",txtKey:"EMPLOYEE_NAME",isNeedClear:false};var b=[{USER_ID:"",EMPLOYEE_NAME:"未指定"}];$.merge(b,d);$(".excutorName").cleanDropdownItem();$(".excutorName").WJZSDropdown(b,a,function(g,h){physiotherapy_View.setExcutorInfo()});if(f){var e=null;var c=false;$.each(d,function(g,h){if(h.USER_ID==f){e=h;c=true;return false}});if(c){$(".excutorName").SetWJZSDropdownSelectedData(f);$(".excutorName").data("drop_data",e)}else{$(".excutorName").SelectWJZSDropdownFirstItem();$(".excutorName").data("drop_data",d[0]||[])}}},addPhysiotherapyTab:function(b){var a=$(".recipe-label>ul>li").length;var c='<li class="recipe-label-item" itemIndex="'+a+'">';c+='	<i class="corner"></i>';c+="	<span>"+b+"</span>";c+='	<i class="delete"></i>';c+="</li>";$(".recipe-label>ul").append(c);return a},selectPhysiotherapyTab:function(d){physiotherapy_View.clearDrugInput();physiotherapy_View.focusThinkBoxInput();var c=$(".recipe-label>ul").find("li[itemIndex="+d+"]");c.addClass("checked").siblings().removeClass("checked");c.parent().find(".delete").hide();var e=physiotherapy_Main.physiotherapys[d];if(treatmentState==2){$(".savePhysiotherapys").hide()}if(physiotherapy_Main.readonly){physiotherapy_View.settingPhysiotherapyStatus(e)}else{c.find(".delete").show();var b=e.physiotherapyId;var a=physiotherapy_Main.chargeStatus[b];var e=physiotherapy_Main.physiotherapys[d];if(e.physiotherapyId){$(".pill-status>i").removeAttr("class").addClass("changes");$(".pill-status>i").attr("chargeStatus",3)}else{$(".pill-status>i").removeAttr("class");$(".pill-status>i").attr("chargeStatus","")}$(".pill-bottom-info").hide();$(".pill-list-hint").hide();$(".recipe-info").show();$(".importInfo").show();if(a&&a>3){$(".pill-bottom-info").show();$(".pill-list-hint").show();$(".recipe-info").hide();$(".importInfo").hide();c.parent().find(".delete").hide();physiotherapy_View.settingPhysiotherapyStatus(e)}physiotherapy_View.focusThinkBoxInput()}physiotherapy_View.loadTreatmentReceipt(physiotherapy_Main.physiotherapys[d])},loadPhysiotherapyTabs:function(b,c){$(".recipe-label>ul").empty();if(b&&b.length>0){$.each(b,function(d,e){physiotherapy_View.addPhysiotherapyTab("理疗单 "+e.physiotherapyNo)})}else{if(c){var a=$.extend(true,{},physiotherapy_Model.physiotherapy);a.physiotherapyNo=1;physiotherapy_Main.physiotherapys.push(a);physiotherapy_View.addPhysiotherapyTab("理疗单 "+a.physiotherapyNo)}}},clearDrugInput:function(){$(".drug-input input").val("");$(".thinkBoxInputArea").removeAttr("disabled");$(".drug-input input").removeClass("pawjzs-error");$(".update-drug").hide();$(".delete-drug").hide();$(".add-drug").show()},focusThinkBoxInput:function(){$(".thinkBoxInputArea").focus()},paConfirm:function(d){var f='<div id="pa-confirm" class="reveal-modal msg" style="height: 140px;"><span id="icon_close" class="icon_close"></span>';f+='    <div id="cfm-msg" class="show-msg"></div>';f+='    <div class="btn-bar">';f+='        <span class="bn-size btn-default" id="pa-cancel"></span><span class="bn-size btn-success" id="pa-save"></span>';f+="    </div>";f+="</div>";$("body").append(f);var e={msg:"是否确认执行该操作？",cancelTxt:"取消",saveTxt:"保存",onYes:function(){alert("无法获取确认操作的回调函数")},onNo:function(){$("#pa-confirm").remove()}};var c=$.extend({},e,d);var a="<input id='cfm-input' type='text' class='input-text'/>";var b=c.msg==="input"?"<span class='ipt-label'>"+c.label+"</span>"+a:c.msg;$("#cfm-msg").html(b);$("#cfm-msg").ketchup();$("#pa-cancel").text(c.cancelTxt);$("#pa-save").text(c.saveTxt);$("#pa-confirm").show();$("div.btn-bar span#pa-save").off("click").on("click",function(){c.onYes()});$("div.btn-bar span#pa-cancel,#icon_close").off("click").on("click",c.onNo);if(c.hideCancel){$("#pa-cancel").remove()}if(c.hideSave){$("#pa-save").remove()}},checkRadio:function(a){if(!$(a).hasClass("checked")){$(a).addClass("checked");$(a).siblings().removeClass("checked")}},showSaveTemplateDialog:function(){var a=' <div class="physiotherapy-input" >';a+='	<div id="templateType" style="margin-bottom: 12px; padding-left: 16px;">';a+='		<span style="padding-left: 12px">模板类型：</span>';a+='		<span class="radio checked" val="3" onclick="physiotherapy_View.checkRadio(this)">个人模板</span>';a+='		<span class="radio" val="2" onclick="physiotherapy_View.checkRadio(this)">诊所模板</span>';a+="	</div>";a+='	<div style="margin-bottom: 12px; padding-left: 14px;">';a+='		<span><i class="necessary">*</i>模板名称：</span>';a+='		<input id="templateName" class="input-text think-text validate(required)" maxlength="500" >';a+="	</div>";a+=" </div>";var b={msg:a,cancelTxt:"取消",saveTxt:"确认",onYes:function(){var i=physiotherapy_Main.physiotherapys[physiotherapy_Main.currentTabIndex];var f=i.items;var e=$("#templateName").val();var g=$("#templateType").find(".checked").attr("val");if(Utils.notBlank(e)){var d=0;var h=physiotherapy_Action.checkTemplateNameUse({templateName:e,templateType:g});if(!h){var c=$.extend(true,{},physiotherapy_Model.physiotherapyTmpl);c.templateName=e;c.templateType=g;$.each(f,function(j,l){var k=$.extend(true,{},physiotherapy_Model.physiotherapy_item);k.description=l.description;k.price=l.price;k.qty=l.qty;k.treatmentId=l.treatmentId;k.treatmentName=l.treatmentName;k.treatmentType=l.treatmentType;k.treatmentUnitId=l.treatmentUnitId;k.treatmentUnitName=l.treatmentUnitName;k.orderNum=j+1;d=Utils.accAdd(d,Utils.accMul(l.price,l.qty));c.items.push(k)});c.totalPrice=d;$("#pa-confirm").remove();physiotherapy_Action.savePhysiotherapyTmpl(c)}else{$.paError("模板名称已存在!")}}else{$.paError("模板名称不能为空!")}}};physiotherapy_View.paConfirm(b)},loadPersonalPhysiotherapyTmpls:function(a){var b="";$.each(a,function(c,d){b+='<li class="recipe-template-item">'+d.templateName+"</li>"});$("#china-tmpl-doctor-ul").html(b)},loadClinicPhysiotherapyTmpls:function(a){var b="";$.each(a,function(c,d){b+='<li class="recipe-template-item">'+d.templateName+"</li>"});$("#china-tmpl-clinic-ul").html(b)},loadPhysiotherapyDateHisDrop:function(b,c){$(".historyDetail>ul").empty();$(".hisDoctor").text("-");$(".treatmentType").text("-");$("#hisDiagnosis").text("-");if(b&&b.length>0){$(".historyRecipe").show();$(".noDataHint").hide();$.each(b,function(d,e){e.addDate=Utils.timeStampToDateStr(e.addDate,7)});var a={idKey:"acographyId",txtKey:"addDate",isNeedClear:false};$(".dateChoose").find(".wjzs-drop-menu").remove();$(".dateChoose").WJZSDropdown(b,a,function(d,e){physiotherapy_Action.getPhysiotherapyHisByAcographyId(e.acographyId,e.empiId,e.clinicId)})}else{$(".historyRecipe").hide();$(".noDataHint").show()}},loadPhysiotherapyHis:function(g){var c=this;var e=g.empi;var b=g.physiotherapies;$(".historyStores").text("-");$(".historyStores").attr("title","-");if(g.clinic){var a=g.clinic["clinicName"]?g.clinic["clinicName"]:"-";$(".historyStores").show();$(".historyStores").text(a);$(".historyStores").attr("title","分店名称："+a)}else{$(".historyStores").hide()}var d=e.DOCTOR_NAME?Utils.trimObj(e.DOCTOR_NAME):"-";$(".hisDoctor").text(d);$(".hisDoctor").attr("title","就诊医生："+d);$(".treatmentType").text(c.transferTreatmentType(e.TREATMENT_TYPE));var f=Utils.trimObj(e.CHINESE_TRA_DIAGNOSIS)?Utils.trimObj(e.CHINESE_TRA_DIAGNOSIS):"-";$("#hisDiagnosis").text(f);$(".historyRecipe-diagnose").attr("title","诊断："+f);var h="";$.each(b,function(j,k){h+=c.concatPhysiotherapyHis(k)});$(".historyDetail>ul").html(h);if(g.clinic||treatmentState!=1){$(".history-quote").hide()}},concatPhysiotherapyHis:function(b){var a=b.items;var c='<li class="historyDetail-item ">';c+='	<div class="historyDetail-head">';c+='		<span class="prescription-title">理疗单&nbsp;'+b.physiotherapyNo+"</span>";c+='		<i class="expand fr"></i>';c+="	</div>";c+='	<div class="historyDetail-content" style="display: none;">';c+='		<ul class="historyDetail-content-list">';$.each(a,function(d,e){c+='			<li class="historyDetail-content-row">';c+="				<span>"+(d+1)+'.</span> <span class="projectName">'+e.treatmentName+"</span><span>"+Utils.trimObj(e.description)+"</span>";c+="			</li>"});c+="		</ul>";if(treatmentState==1){c+='		<div class="history-quote">';c+='			<span class="btn normal-btn">引用理疗单</span>';c+="		</div>"}c+="	</div>";c+="</li>";return c},transferTreatmentType:function(a){var b="";switch(Number(a)){case 1:b="初诊";break;case 2:b="复诊";break}return b},changeToEditingStatus:function(){$(".savePhysiotherapys").text("保存");physiotherapy_Main.readonly=false;physiotherapy_View.setFinishPatFlag();$(".pill-bottom-info").hide();$(".pill-list-hint").hide();$(".importInfo").show();$(".recipe-info").show();$(".add-recipe").show();$(".editorBtn").show();$(".pill-list-item.checked").find(".close-order-list").show();if(physiotherapy_Main.currentTabIndex>-1){physiotherapy_View.loadPhysiotherapyTabs(physiotherapy_Main.physiotherapys);physiotherapy_View.selectPhysiotherapyTab(physiotherapy_Main.currentTabIndex)}},changeToReadonlyStatus:function(){$(".savePhysiotherapys").text("修改");physiotherapy_Main.readonly=true;finishPatFlag=true;$(".pill-bottom-info").show();$(".pill-list-hint").show();$(".recipe-info").hide();$(".importInfo").hide();$(".add-recipe").hide();$(".editorBtn").hide();$(".pill-list-item.checked").find(".close-order-list").hide();if(physiotherapy_Main.currentTabIndex>-1){physiotherapy_View.loadPhysiotherapyTabs(physiotherapy_Main.physiotherapys);physiotherapy_View.selectPhysiotherapyTab(physiotherapy_Main.currentTabIndex)}},settingPhysiotherapyStatus:function(e){var c=this;var d=e.physiotherapyId;var a=physiotherapy_Main.chargeStatus[d];var b=c.transferchargeStatus(a);$(".pill-status>i").removeAttr("class").addClass(b);$(".pill-status>i").attr("chargeStatus",a)},transferchargeStatus:function(a){var b="";switch(Number(a)){case 1:b="";break;case 2:b="submitted";break;case 3:b="changes";break;case 4:b="hasCharge";break;case 5:b="hasCharge";break;case 6:b="partRefund";break;case 7:b="haveRefund";break;case 8:b="inExecution";break;case 9:b="executed";break;case 10:b="inTheCharge";break;case 11:b="inRefund";break}return b},referencePhysiotherapyTmpl:function(e){var c=$(".recipe-label>ul>li").length;if(c==6){$.paError("最多能添加6张理疗单");return}var a=$.extend(true,{},e);if(physiotherapy_Main.physiotherapys.length>0){var d=physiotherapy_Main.physiotherapys[physiotherapy_Main.physiotherapys.length-1];a.physiotherapyNo=Number(d.physiotherapyNo)+1}else{a.physiotherapyNo=1}physiotherapy_Main.physiotherapys.push(a);var b=physiotherapy_View.addPhysiotherapyTab("理疗单 "+a.physiotherapyNo);physiotherapy_Main.currentTabIndex=b;physiotherapy_View.selectPhysiotherapyTab(b)},setDoctorInfo:function(){var c=$(".china-doctorName").val();var a=$(".china-doctorName").attr("val");var d=physiotherapy_Main.physiotherapys;var b=d[physiotherapy_Main.currentTabIndex];if(Utils.notBlank(Utils.trimObj(a))){b.userId=a;b.employeeName=c}else{b.userId="";b.employeeName=""}},setExcutorInfo:function(){var b=$(".excutorName").val();var a=$(".excutorName").attr("val");var d=physiotherapy_Main.physiotherapys;var c=d[physiotherapy_Main.currentTabIndex];if(Utils.notBlank(Utils.trimObj(a))){c.executorId=a;c.executorName=b}else{c.executorId="";c.executorName=""}},addEnterKeyListener:function(){physiotherapy_View.focusThinkBoxInput();$("body").paKeyHandle({necessary:true,clz:"enterNext"})},addDrug:function(){var e=true;var g=$(".drug-input").ableToFinish();if(!g){e=false;return e}var b=$("#treatmentId").val();var c=$("#treatmentName").val();var h=$("#treatmentType").val();var n=$("#treatmentUnitId").val();var f=$("#treatmentUnitName").val();var d=$("#treatmentPrice").val();var m=$(".china-drugDose").val();var j=$(".description").val();var i=$.extend(true,{},physiotherapy_Model.physiotherapy_item);i.treatmentId=b;i.treatmentName=c;i.treatmentType=h;i.treatmentUnitId=n;i.treatmentUnitName=f;i.price=d;i.qty=m;i.description=j;var l=physiotherapy_Main.physiotherapys[physiotherapy_Main.currentTabIndex];var k=l.items;var a=false;$.each(k,function(o,p){if(p.treatmentId==b){a=true;return false}});if(a){$.paError("该项目已存在");e=false;return e}k.push(i);$(".update-drug").hide();$(".delete-drug").hide();$(".add-drug").show();physiotherapy_View.loadTreatmentReceipt(l);physiotherapy_View.clearDrugInput();finishPatFlag=false;$(".drug-input input").val("");$(".drug-input input").removeClass("pawjzs-error");return e},updateDrug:function(){var f=true;var h=$(".drug-input").ableToFinish();if(!h){f=false;return f}var a=$("#treatmentId").val();var b=$("#treatmentName").val();var i=$("#treatmentType").val();var n=$("#treatmentUnitId").val();var g=$("#treatmentUnitName").val();var e=$("#treatmentPrice").val();var c=$("#treatmentiItemIndex").val();var m=$(".china-drugDose").val();var j=$(".description").val();var l=physiotherapy_Main.physiotherapys[physiotherapy_Main.currentTabIndex];var k=l.items;if(c>-1){var d=k[c];d.treatmentId=a;d.treatmentName=b;d.treatmentType=i;d.treatmentUnitId=n;d.treatmentUnitName=g;d.price=e;d.qty=m;d.description=j}physiotherapy_View.loadTreatmentReceipt(l);physiotherapy_View.clearDrugInput();$(".drug-input input").val("");$(".drug-input input").removeClass("pawjzs-error");return f},setFinishPatFlag:function(){if(physiotherapy_Main.physiotherapys&&physiotherapy_Main.physiotherapys.length==1&&physiotherapy_Main.physiotherapys[0].items&&physiotherapy_Main.physiotherapys[0].items.length==0){finishPatFlag=true}else{finishPatFlag=false}}});function setRecipeDoctor(b,e){physiotherapy_Main.userId=b;physiotherapy_Main.employeeName=e;var d=physiotherapy_Main.physiotherapys[physiotherapy_Main.currentTabIndex];var c=d.physiotherapyId;var a=physiotherapy_Main.chargeStatus[c];if(!(a&&a>3)){$(".china-doctorName").val(physiotherapy_Main.employeeName);$(".underline.doctorName").html(physiotherapy_Main.employeeName)}}var physiotherapy_Model=Class.create({physiotherapy:{acographyId:acographyId,empiId:empiId,advice:null,clinicId:null,userId:physiotherapy_Main.userId,employeeName:physiotherapy_Main.employeeName,executorId:null,executorName:null,isPay:null,physiotherapyId:null,physiotherapyNo:1,totalPrice:null,items:[]},physiotherapy_item:{acographyId:acographyId,empiId:empiId,clinicId:null,description:null,isPay:null,orderNum:"",physiotherapyId:null,physiotherapyItemId:null,price:null,qty:"",treatmentId:null,treatmentName:null,treatmentType:null,treatmentUnitId:null,treatmentUnitName:null},physiotherapyTmpl:{templateId:null,templateName:null,templateType:null,totalPrice:null,userId:null,advice:null,items:[]},physiotherapyTmpl_item:{description:null,orderNum:null,price:null,qty:null,templateId:null,templateItemId:null,treatmentId:null,treatmentName:null,treatmentType:null,treatmentUnitId:null,treatmentUnitName:null},dwsAcography:{dwsAcography:{acographyId:acographyId,triageId:triageId,recordId:null}}});$(function(){if(physiotherapy==1){$(".content-inner").addClass("pt55");$(".content-inner .static-menu").show();$(".static-menu>ul>li").on("click",function(){var a=$(this).index();if(a==0){window.location.href="../tcm/physiotherapy.html"+window.location.search}else{window.location.href="../tcm/courseInvoice.html"+window.location.search}});if(treatmentState==2){$(".static-menu-finish").html("重新开单")}}if(treatmentState==0){physiotherapy_Action.getPhysiotherapyDateHis(function(a){if(a&&a.length>0){if(physiotherapy==1){$("#phy-waitingState-historyRec").show()}else{$("#treat-waitingState-historyRec").show()}physiotherapy_Main.addhistoryListener();physiotherapy_View.loadPhysiotherapyDateHisDrop(a);if(a&&a.length>0){$(".dateChoose").SelectWJZSDropdownFirstItem();var b=a[0];physiotherapy_Action.getPhysiotherapyHisByAcographyId(b.acographyId,b.empiId,b.clinicId)}}else{if(physiotherapy==1){$("#phy-waitingState").show()}else{$("#treat-waitingState").show()}}$(".topNav").addClass("treat-completedState")});$(".content-inner").show();return}else{if(treatmentState==2){$(".topNav").addClass("treat-completedState")}}physiotherapy_Main._init()});