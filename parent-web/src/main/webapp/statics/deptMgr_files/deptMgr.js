var deptMgrUrls={deptMgr_selectTreeListInPage:ContextClinc_Server+"mdcDepartment/selectTreeListInPage",deptMgr_selectSimpleList:ContextClinc_Server+"mdcDepartment/selectSimpleList",deptMgr_insert:ContextClinc_Server+"mdcDepartment/insert",deptMgr_insertSelective:ContextClinc_Server+"mdcDepartment/insertSelective",deptMgr_insertReturnId:ContextClinc_Server+"mdcDepartment/insertReturnId",deptMgr_updateByPrimaryKeySelective:ContextClinc_Server+"mdcDepartment/updateByPrimaryKeySelective",deptMgr_disableOrEnable:ContextClinc_Server+"mdcDepartment/disableOrEnable",deptMgr_updateByPrimaryKey:ContextClinc_Server+"mdcDepartment/updateByPrimaryKey"};var deptType={"0":"门诊","1":"体检常规","2":"体检检验","3":"体检影像","4":"职能科室","5":"药房","8":"住院","9":"诊室"};var detailTable;var treeList;$(function(){init();renderPermissionControl()});function refreshTree(){DOMhelp.init();sn.init()}function refeshAll(b,a){$("#sc_value").val("");$("#srch_departmentType").SetWJZSDropdownSelectedData("");$("#srch_isForBooking").SetWJZSDropdownSelectedData("");treeList=new TreeList();treeList.showTreeList(b,a);$("#btn_search").off("click",search);$("#btn_search").on("click",search);$("#btn_add").off("click",showAddPanel);$("#btn_add").on("click",showAddPanel)}function init(){$("#list_div").show();$("#add_edit_div").hide();$("#sc_value").val("");$("#srch_departmentType").SetWJZSDropdownSelectedData("");$("#srch_isForBooking").SetWJZSDropdownSelectedData("");initControllData();treeList=new TreeList();treeList.showTreeList();detailTable=new DetailTable();detailTable.curParentId="";detailTable.curLeftSelId="";detailTable.curPage=1;var a={currentPage:1};detailTable.showDataListInPage(a);$("#btn_add").off("click",showAddPanel);$("#btn_add").on("click",showAddPanel);$("#btn_search").off("click",search);$("#btn_search").on("click",search)}function initControllData(){var d=[{id:"0",txt:"门诊"},{id:"1",txt:"体检常规"},{id:"2",txt:"体检检验"},{id:"3",txt:"体检影像"},{id:"4",txt:"职能科室"},{id:"5",txt:"药房"},{id:"8",txt:"住院"},{id:"9",txt:"诊室"}];var c=[{id:0,txt:"已启用"},{id:1,txt:"已停用"}];$("#departmentType").WJZSDropdown(d,null,function(e,f){});$("#srch_departmentType").WJZSDropdown(d,null,function(e,f){});var b={idKey:"id",txtKey:"txt",isNeedAll:true,isNeedClear:false};$("#disabled").WJZSDropdown(c,b,function(e,f){search()});$("#disabled").SetWJZSDropdownSelectedData(0);var a=[{id:"1",txt:"是"},{id:"2",txt:"否"}];$("#isForBooking").WJZSDropdown(a,null,function(e,f){});$("#srch_isForBooking").WJZSDropdown(a,null,function(e,f){})}function initParentDeptDropDown(b){if(!b){var f={params:{delFlag:0,onlyTopLevel:1}};var h={url:deptMgrUrls.deptMgr_selectSimpleList,dataType:"json",contentType:"application/json",data:JSON.stringify(f)};var g=Utils.myAjaxHandler(h);g.done(function(m){var j=m.data;var k=m.errorMessage;var l=m.errorCode;if(l!="E0000000"){$.paError("失败："+l+"，"+k);return}var i={idKey:"DEPARTMENT_ID",txtKey:"DEPARTMENT_NAME"};$("#parentId").WJZSDropdown(j,i,function(n,o){})}).fail(function(i){$.paError("获取数据失败!")}).always(function(){})}else{var d=[];for(var e=0;e<b.length;e++){var c=b[e];if(!c.PARENT_ID||c.PARENT_ID==""||c.PARENT_ID==-1){d.push(c)}}var a={idKey:"DEPARTMENT_ID",txtKey:"DEPARTMENT_NAME"};$("#parentId").WJZSDropdown(d,a,function(i,j){})}}function TreeMenu(a){this.parentIdCol="PARENT_ID";this.idCol="DEPARTMENT_ID";this.displayCol="DEPARTMENT_NAME";this.tree=a||[];this.groups={};this.curPage=1}TreeMenu.prototype={init:function(a){if(!a||a==""){a=-1}this.group();return this.getDom(this.groups[a])},group:function(){var b=-1;for(var a=0;a<this.tree.length;a++){if(this.tree[a][this.parentIdCol]==null||this.tree[a][this.parentIdCol]==""){b=-1}else{b=this.tree[a][this.parentIdCol]}if(this.groups[b]){this.groups[b].push(this.tree[a])}else{this.groups[b]=[];this.groups[b].push(this.tree[a])}}},getDom:function(d){if(!d){return""}var f=$("<ul>");for(var e=0;e<d.length;e++){var b=$("<li>");var c=$("<a>");c.attr("id","a_"+d[e][this.idCol]);c.attr("title",d[e][this.displayCol]);c.on("click",{selDeptId:d[e][this.idCol],selParentId:d[e][this.parentIdCol],curPage:this.curPage},showDetailDataList);c.html(d[e][this.displayCol]);b.append(c);b.append(this.getDom(this.groups[d[e][this.idCol]]));f.append(b)}return f}};function TreeList(){this.returnMsg=null}TreeList.prototype={constructor:TreeList,showTreeList:function(d,c){var a=this;var f={params:{delFlag:0,disabled:0}};var b={url:deptMgrUrls.deptMgr_selectSimpleList,dataType:"json",contentType:"application/json",data:JSON.stringify(f)};var e=Utils.myAjaxHandler(b);e.done(function(h){a.returnMsg=h;var j=h.data;var k=h.errorMessage;var m=h.errorCode;if(m!="E0000000"){$.paError("失败："+m+"，"+k);return}initParentDeptDropDown(j);var n=$("#treenav");n.empty();var o=$("<li></li>");var g=$('<a class="treenav_item">全部</a>');o.append(g);n.append(o);if(j!=null&&j.length>0){var l=new TreeMenu(j);if(c==undefined||c==null){c=1}g.on("click",{selParentId:"",selDeptId:"",curPage:c},showDetailDataList);l.curPage=c;var i=l.init("");n.append(i.children());refreshTree();if(d!=null&&d!=""){sn.expandAll();$("#a_"+d).click()}else{if(n.find("a")[0]!=undefined){if(d==""&&c){n.find("a")[0].click()}else{addActive(n.find("a").eq(0))}}}}}).fail(function(g){$.paError("获取数据失败!")}).always()}};function showAddPanel(){if(detailTable==undefined||detailTable==null){detailTable=new DetailTable()}detailTable.showAddPanelNoQuery()}function saveAdded(){detailTable.saveAdded()}function switchToListViewDiv(){$("#add_edit_div").hide();$("#list_div").show()}function showModifyPanel(a){detailTable.showModifyPanel(a)}function saveModified(a){detailTable.saveModified(a.data.index)}function deleteData(a){detailTable.deleteData(a)}function showDetailDataList(a){addActive(this);$("#sc_value").val("");$("#srch_departmentType").SetWJZSDropdownSelectedData("");$("#srch_isForBooking").SetWJZSDropdownSelectedData("");detailTable=new DetailTable();detailTable.curParentId=a.data.selParentId;detailTable.curLeftSelId=a.data.selDeptId;detailTable.curPage=a.data.curPage;var b={currentPage:a.data.curPage};detailTable.showDataListInPage(b)}function showDataListInPage(a){detailTable.isQuerying=0;detailTable.showDataListInPage(a)}function search(){detailTable.isQuerying=1;detailTable.showDataListInPage()}function updateStatus(c,b,a){detailTable.updateStatus(c,b,a)}function DetailTable(){this.returnMsg=null;this.curPage=1;this.curParentId="";this.curLeftSelId="";this.isQuerying=0}DetailTable.prototype={constructor:DetailTable,showDataListInPage:function(b){var a=this;var d={};if(a.curLeftSelId==""&&a.curParentId==""){d={keyword:$("#sc_value").val(),delFlag:0,isForBooking:$.trim($("#srch_isForBooking").attr("val")),departmentType:$.trim($("#srch_departmentType").attr("val"))};var c=$("#disabled").attr("val");if(Utils.trimObj(c)!=""){d.disabled=c}}else{d={keyword:$("#sc_value").val(),delFlag:0,parentId:a.curLeftSelId,withPatentInfo:1,departmentId:a.curLeftSelId,isForBooking:$.trim($("#srch_isForBooking").attr("val")),};var c=$("#disabled").attr("val");if(Utils.trimObj(c)!=""){d.disabled=c}}var e={pageSize:20,params:d,currentPageKey:"curPage",currentPage:(b==undefined||b==null)?1:b.currentPage};e.ajaxopts={url:deptMgrUrls.deptMgr_selectTreeListInPage,dataType:"json",contentType:"application/json",showMask:true};e.callback=function(h){a.returnMsg=h;var l=h.data.dataSource;var m=h.errorMessage;var p=h.errorCode;if(p!="E0000000"){$.paError("失败："+p+"，"+m);return}var r=$("#tb_detailList");r.empty();var o=$("<tr>");var f=$("<th>");f.html("科室编号");o.append(f);f=$("<th>");f.html("科室名称");o.append(f);f=$("<th>");f.html("科室属性");o.append(f);f=$("<th>");f.html("显示顺序");o.append(f);f=$("<th>");f.html("上级科室");o.append(f);f=$("<th>");f.html("开通预约");o.append(f);f=$("<th>");f.html("操作");o.append(f);r.append(o);for(var k=0;k<l.length;k++){var g=l[k];var o=$("<tr>");var j=$("<td>");j=$("<td>");j.html(g.DEPARTMENT_CODE);o.append(j);j=$("<td>");j.html(g.DEPARTMENT_NAME);o.append(j);j=$("<td>");j.html(deptType[g.DEPARTMENT_TYPE]);o.append(j);j=$("<td>");j.html(g.ORDER_NUM);o.append(j);j=$("<td>");j.html(g.PARENT_DEPT_NAME);o.append(j);j=$("<td>");j.html(g.IS_FOR_BOOKING==1?"是":"否");o.append(j);j=$("<td>");var q=$("<a id='btn_modify_"+k+"' WJPerm='CLINICSET01-UPDATE,CLINICSETUP01-UPDATE' onclick='showModifyPanel("+k+")'>编辑</a>");j.append(q);var n="";if(g.DISABLED==0){n=$("<a id='btn_updateStat_"+k+"' WJPerm='CLINICSET01-DISABLE,CLINICSETUP01-DISABLE' onclick='updateStatus(this.id, "+k+", 1)'>停用</a>")}else{n=$("<a id='btn_updateStat_"+k+"' WJPerm='CLINICSET01-ENABLE,CLINICSETUP01-ENABLE' onclick='updateStatus(this.id, "+k+", 0)'>启用</a>")}j.append(n);o.append(j);r.append(o)}a.curPage=h.data.currentPage;renderPermissionControl();window.parent.SetWinSize()};$("#my-page").generatePagination(e)},showAddPanelNoQuery:function(){$("#add_edit_div").removeErrorMsg();var a=this;a.resetControllVal();$("#list_div").hide();$("#add_edit_div").show();$("#btn_save").off("click");$("#btn_save").on("click",saveAdded);$("#btn_cancle").off("click");$("#btn_cancle").on("click",switchToListViewDiv);$("#add_edit_div").ketchup()},showModifyPanel:function(c){$("#add_edit_div").removeErrorMsg();var b=this;var a=b.returnMsg.data.dataSource;var d=a[c];if(d.SOURCES=="1"){Utils.disabledInput($("#departmentCode"));Utils.disabledInput($("#departmentName"));Utils.disabledInput($("#departmentType").parent("div"));Utils.disabledInput($("#parentId").parent("div"))}else{Utils.enableInput($("#departmentName"));Utils.enableInput($("#departmentType").parent("div"));Utils.enableInput($("#parentId").parent("div"));Utils.disabledInput($("#departmentCode"))}$("#departmentCode").val(d.DEPARTMENT_CODE);$("#departmentName").val(d.DEPARTMENT_NAME);$("#parentId").SetWJZSDropdownSelectedData(d.PARENT_ID=="-1"?"":d.PARENT_ID);$("#departmentType").SetWJZSDropdownSelectedData(d.DEPARTMENT_TYPE);$("#orderNum").val(d.ORDER_NUM);$("#deptRemark").val(d.DEPT_REMARK);$("#deptAddr").val(d.DEPT_ADDR);$("#isForBooking").SetWJZSDropdownSelectedData(d.IS_FOR_BOOKING);$("#list_div").hide();$("#add_edit_div").show();$("#btn_save").off("click");$("#btn_save").on("click",{index:c},saveModified);$("#btn_cancle").off("click");$("#btn_cancle").on("click",switchToListViewDiv);$("#add_edit_div").ketchup()},saveAdded:function(){var c=$("#add_edit_div").ableToFinish();if(!c){return}var b=this;var h="";if($.trim($("#parentId").attr("val"))!=null&&$.trim($("#parentId").attr("val"))!=""){h=$.trim($("#parentId").attr("val"))}var g={departmentCode:$("#departmentCode").val(),departmentName:$("#departmentName").val(),parentId:h,departmentType:$.trim($("#departmentType").attr("val")),orderNum:$("#orderNum").val(),disabled:0,deptRemark:$("#deptRemark").val(),deptAddr:$("#deptAddr").val(),presetStatus:0,delFlag:0,isForBooking:$.trim($("#isForBooking").attr("val"))};var a={mdcDepartment:g};var e=JSON.stringify(a);var d={url:deptMgrUrls.deptMgr_insertReturnId,dataType:"json",data:e,contentType:"application/json",showMask:true};var f=Utils.myAjaxHandler(d);f.done(function(l){var i=l.errorMessage;var k=l.errorCode;var j=l.data;if(k!="E0000000"){$.paError("失败："+k+"，"+i);return}if(!j){$.paError("保存信息失败！");return}$.paSuccess("保存成功！");b.curLeftSelId=j;refeshAll(b.curLeftSelId,b.curPage);switchToListViewDiv()}).fail(function(i){$.paError("获取数据失败!")}).always()},saveModified:function(g){var c=$("#add_edit_div").ableToFinish();if(!c){return}var d=this;var f=d.returnMsg.data.dataSource;var b=f[g];var a={departmentId:b.DEPARTMENT_ID,departmentCode:$("#departmentCode").val(),departmentName:$("#departmentName").val(),parentId:$.trim($("#parentId").attr("val"))==""?-1:$.trim($("#parentId").attr("val")),departmentType:$.trim($("#departmentType").attr("val")),orderNum:$("#orderNum").val(),disabled:b.DISABLED,deptRemark:$("#deptRemark").val(),deptAddr:$("#deptAddr").val(),presetStatus:b.PRESET_STATUS,delFlag:0,isForBooking:$.trim($("#isForBooking").attr("val"))};var e={mdcDepartment:a};var h=JSON.stringify(e);var j={url:deptMgrUrls.deptMgr_updateByPrimaryKeySelective,dataType:"json",data:h,contentType:"application/json",showMask:true};var i=Utils.myAjaxHandler(j);i.done(function(m){var k=m.errorMessage;var l=m.errorCode;if(l!="E0000000"){$.paError("失败："+l+"，"+k);return}$.paSuccess("更新成功！");switchToListViewDiv();refeshAll(d.curLeftSelId,d.curPage)}).fail(function(k){$.paError("获取数据失败!")}).always()},updateStatus:function(e,h,f){var c=this;var g=c.returnMsg.data.dataSource;var b=g[h];var a={departmentId:b.DEPARTMENT_ID,presetStatus:b.PRESET_STATUS,disabled:f};var d={mdcDepartment:a};var i=JSON.stringify(d);var k={url:deptMgrUrls.deptMgr_disableOrEnable,dataType:"json",data:i,contentType:"application/json"};var j=Utils.myAjaxHandler(k);j.done(function(o){var l=o.errorMessage;var m=o.errorCode;if(m!="E0000000"){$.paWarn(l);return}if(f==0){$.paSuccess("操作成功，科室已启用！")}else{$.paSuccess("操作成功，科室已停用！")}var n={currentPage:c.curPage};c.showDataListInPage(n);treeList.showTreeList()}).fail(function(l){$.paError("获取数据失败!")}).always()},resetControllVal:function(){var a=this;Utils.enableInput($("#departmentCode"));Utils.enableInput($("#departmentName"));Utils.enableInput($("#departmentType").parent("div"));Utils.enableInput($("#parentId").parent("div"));$("#departmentCode").val("");$("#departmentName").val("");$("#orderNum").val("");$("#deptRemark").val("");$("#deptAddr").val("");$("#departmentType").SetWJZSDropdownSelectedData("");$("#parentId").SetWJZSDropdownSelectedData(a.curLeftSelId==""?"":a.curLeftSelId);$("#isForBooking").SetWJZSDropdownSelectedData("")}};