var finishPatFlag=true;var acographyId=Utils.getQueryString("acographyId");var empiId=Utils.getQueryString("empiId");var treatmentState=Utils.getQueryString("treatmentState");var userInfo_aclc=config_cache.getCache("medical_user_data");var cpmpUtils=null;var cpmp=null;var cpmpHistory=null;var cpmpTmpl=null;var stock=null;var recipeListCache=null;var frequencyDataArray=[];var isYbReg=Utils.getQueryString("isYbReg");$(function(){cpmpUtils=new CPMPrescriptionUtils();cpmp=new CPMPrescription();cpmp.init();cpmpHistory=new CPMPrescriptionHistory();if(treatmentState==="1"){cpmpHistory.init()}cpmpTmpl=new CPMPrescriptionTmpl();cpmpTmpl.init();stock=new Stock();stock.init()});function CPMPrescription(){this.drugIdArr=[];this.deleteRecipeCnArr=[];this.isReadOnly=false;this.cpmRecipesMaxNum=6;this.drugSourceData=[{id:0,txt:"本院"},{id:1,txt:"外购"},{id:2,txt:"免费"}];this.empi={};this.isDrugWithdrawal=false;this.isShowFee=true;this.isModifyPrice=false;this.isYBFlag=false}CPMPrescription.prototype={init:function(){cpmp.getParam();$(".diagnosis-input").ketchup();cpmp.initClickBtn();cpmp.getCPMRecipes(empiId,acographyId,0);cpmp.initChiefComThinkInput()},initClickBtn:function(){$(".save").off("click").on("click",function(){if(cpmp.isReadOnly){cpmp.isReadOnly=false;cpmp.makeEditView()}else{var d=cpmp.getCPMRecipesData();if(d.code==0){var a=d.data;if(a&&a.length>0){var c=$(".dose-usage-number").ableToFinish();var b=$(".recipe-info").ableToFinish();if(!c||!b){return}if($(".left-prescription").find(".underStock").length>0){$.paWarn("有中成药超出库存！");return}cpmp.saveCPMRecipesList(a);cpmp.isReadOnly=true}else{$.paWarn("无处方，请添加！")}}else{$.paWarn(d.errorMsg)}}});$("#add-save").off("click").on("click",function(){var a=$(".diagnosis-input").ableToFinish();if(!a){return}cpmp.saveCnMedical()});$("#closeDiagnosis").off("click").on("click",function(){$("#addDiagnosisPop").addClass("dsn")});$("#add-cancel").off("click").on("click",function(){$("#addDiagnosisPop").addClass("dsn")});$(".applyRefund").off("click").on("click",function(){var a={msg:"申请退药后不可恢复，确定要申请退药吗?",cancelTxt:"取消",saveTxt:"确定",onYes:function(){var b=$(".pill-wrap:visible");var d=b.find(".pill-list-content .drug-list-row").not(".drugListRowClone");var g=d.length;var i=[];for(var e=0;e<g;e++){var c=$(d[e]).data("drug");if(c.DRUG_NAME){var f={recipeWestId:$(d[e]).attr("recipecnid"),};i.push(f)}}var h={recipeId:$(".recipe-label .recipe-label-item[data-index="+b.attr("data-index")+"]").attr("data-id"),recipeWestList:i};cpmp.drugWithdrawal(h)}};$.paConfirm(a)});$(".recipe-label .add-recipe").off("click").click(function(){if($(".recipe-label ul li").length>cpmp.cpmRecipesMaxNum){$.paWarn("最多只能添加六个处方");return}var b=parseInt($(".recipe-label").find("ul li:last").attr("data-index"))+1;cpmp.addPrescriptionTab(true,true,b);var a=cpmp.addPrescriptionBody(true,b,cpmp.empi);$(".recipe-label-item.checked").siblings().find(".delete").hide();a.find(".thinkBoxInputArea").focus();a.find(".pill-listBox").hide()});$(".recipe-label .delete").off().on("click",function(){var c=$(this);if(c.parent().hasClass("allowEdit")){var a=$(this).parent().attr("data-index");var b={msg:"删除成药方"+a+"，请确认！",cancelTxt:"取消",saveTxt:"确认",onYes:function(){if(c.parent().attr("data-id")){cpmp.deleteRecipeCn(c.parent().attr("data-id"))}cpmp.deleteCRecipesTab(c);$(".recipe-label-item.checked").find(".delete").show()}};$.paConfirm(b)}});$(".recipe-label li").each(function(){$(this).click(function(){var a=$(this).index();if(!cpmp.isReadOnly){$(".recipe-label ul > li:eq("+a+")").find(".delete").show();$(".recipe-label ul > li:eq("+a+")").siblings().find(".delete").hide()}$(".recipe-label ul > li:eq("+a+")").addClass("checked").siblings().removeClass("checked");$(".left-prescription > .pill-wrap:eq("+a+")").removeAttr("style").siblings(".pill-wrap").css("display","none");$(".left-prescription > .pill-wrap:eq("+a+")").find(".thinkBoxInputArea").focus();$(".print").attr("title","打印处方"+$(this).attr("data-index"));$(".saveAs").attr("title","处方"+$(this).attr("data-index")+"存为模板");cpmp.drugWithdrawalView($(this).attr("data-index"))})});$(".print").off("click").on("click",function(){var a=$(".recipe-label ul").find("li.checked").attr("data-id");if(a){new CPMPrescriptionPrint().doPrintFacade(empiId,acographyId,a)}else{$.paWarn("请先保存处方！")}});$(document).off("click",".add-drug").on("click",".add-drug",function(){cpmp.addDrugToPrescription($(this))});$(document).off("click",".update-drug").on("click",".update-drug",function(){cpmp.updateDrugToPrescription($(this))});$(document).off("click",".empty-drug").on("click",".empty-drug",function(){var a=$(this).parents(".importInfo");cpmp.cleanDrugInput(a);cpmp.revertAddStatus(a)});$(document).off("click",".delete-drug").on("click",".delete-drug",function(){var e=$(this);var f=e.parents(".pill-wrap").attr("data-index");var b;var c;if(e.parents(".pill-wrap").find(".pill-list-item.checked").length>0){b=e.parents(".pill-wrap").find(".pill-list-item.checked").find(".drug-list-row").not(".drugListRowClone").attr("recipecnid");c=e.parents(".pill-wrap").find(".pill-list-item.checked").find(".drug-list-row").not(".drugListRowClone").attr("recipeId")}else{b=e.parents(".pill-wrap").find(".drug-list-row.checked").attr("recipecnid");c=e.parents(".pill-wrap").find(".drug-list-row.checked").attr("recipeId")}if(b&&c){cpmp.deleteRecipeCnArr.push({id:f,recipecnid:b,recipeId:c})}var h=e.parents(".pill-wrap").find(".pill-list-item.checked").find(".drug-list-row").not(".drugListRowClone");var i=true;if(h&&h.length==0){i=false;h=e.parents(".pill-wrap").find(".drug-list-row.checked")}var d=h.data("drug");var j=d.DRUG_ID;var g=e.parents(".pill-wrap").find(".pill-list-content");if(i){e.parents(".pill-wrap").find(".pill-list-item.checked").remove()}else{var a=e.parents(".pill-wrap").find(".drug-list-row.checked").parents(".pill-list-item");if(a.find(".drug-list-row").not(".drugListRowClone").length==2){a.find(".pill-list-leftInfo-right").removeClass("list-special-line");a.find(".drug-list-row").removeClass("drug-list-operational");a.addClass("drug-list-operational")}e.parents(".pill-wrap").find(".drug-list-row.checked").remove()}cpmp.cleanDrugInput(e.parents(".importInfo"));cpmp.revertAddStatus(e.parents(".importInfo"));e.remove();cpmp.deleteDrugIdArr(f,j);cpmpUtils.calcTotalPrice(g);if(g.find(".pill-list-item:not(.prescription-cell-clone)").length==0){$(".pill-list-content:visible>.pill-listBox").hide();$(".pill-list-content:visible>.without-drugs").show();$(".pill-list-hint:visible>i").hide()}});$(".pill-listBox").on("click",".close-order-list",function(h){var f=$(this);var g=f.parents(".pill-wrap").attr("data-index");var b=f.parent().attr("recipecnid");var c=f.parent().attr("recipeId");if(b&&c){cpmp.deleteRecipeCnArr.push({id:g,recipecnid:b,recipeId:c})}var d=f.parents(".drug-list-row").data("drug");var k=d.DRUG_ID;var i=f.parents(".pill-list-content");f.parents(".pill-middle-info").find(".delete-drug").remove();cpmp.cleanDrugInput(f.parents(".pill-middle-info").find(".importInfo"));cpmp.revertAddStatus(f.parents(".pill-middle-info").find(".importInfo"));cpmp.deleteDrugIdArr(g,k);h.stopPropagation();if($(this).parents(".drug-list-operational").hasClass("drug-list-row")){var j=$(this).parents(".leftInfo-right-drug").children(".drug-list-row");if(j.length>2){var a=$(this).parents(".leftInfo-right-drug");$(this).parents(".drug-list-operational").remove();if(a.children(".drug-list-row").length==2){if(a.find(".drug-list-row").hasClass("drug-list-operational")){a.find(".drug-list-row").removeClass("drug-list-operational")}if(!a.parent().parent().parent().hasClass("drug-list-operational")){a.parent().parent().parent().addClass("drug-list-operational")}if(a.parent().parent().parent().find(".pill-list-leftInfo-right").hasClass("list-special-line")){a.parent().parent().parent().find(".pill-list-leftInfo-right").removeClass("list-special-line")}}}else{if(j.length==2){$(this).parents(".drug-list-operational").remove();j.removeClass("drug-list-operational");j.parents(".pill-list-leftInfo-right").removeClass("list-special-line");j.parents(".pill-list-item").addClass("drug-list-operational")}}}else{$(this).parents(".drug-list-operational").remove()}cpmpUtils.calcTotalPrice(i);if(i.find(".pill-list-item:not(.prescription-cell-clone)").length==0){$(".pill-list-content:visible>.pill-listBox").hide();$(".pill-list-content:visible>.without-drugs").show();$(".pill-list-hint:visible>i").hide()}});$(".pill-list-content").on("click",".pill-list-item",function(){var d=$(this);if(!cpmp.isReadOnly){if(d.find(".drug-list-row").not(".drugListRowClone").length==1){d.addClass("checked").siblings().removeClass("checked");d.siblings().find(".drug-list-row").removeClass("checked");var a=d.parents(".pill-middle-info").find(".importInfo");if(a.find(".delete-drug").length==0){a.find(".empty-drug").after('<i class="delete-drug" title="删除"></i>');a.find(".add-drug").after('<i class="update-drug" title="更新"></i>')}a.find(".add-drug").hide();var b=d.find(".drug-list-row").not(".drugListRowClone").data("drug");var f="";if(d.find(".list-number").text()){f=d.find(".list-number").text().substr(0,d.find(".list-number").text().indexOf("."))}a.find(".groupNum").attr("disabled","disabled");a.find(".groupNum").val(f);a.find(".totalQty").val(d.find(".drug-list-row").not(".drugListRowClone").find(".totalQty").attr("totalQty")||0);var h=d.find(".drug-list-row").not(".drugListRowClone");var c={drugSplit:h.find(".totalQty").attr("drugSplit"),storeUnitId:h.find(".drugDose").attr("storeUnitId"),dispenseUnitId:h.find(".drugDose").attr("dispenseUnitId"),drugUnitId:h.find(".totalQty").attr("drugUnitId"),recipeUnit:h.find(".totalQty").attr("recipeUnit"),storeUnitName:h.find(".drugDose").attr("storeUnitName"),dispenseUnitName:h.find(".drugDose").attr("dispenseUnitName")};cpmp.initDrugTotalUnit(a.find(".drug-total-unit"),b,c);if(b){var g=a.find(".thinkBoxInputArea");g.attr("disabled","disabled");g.data("drug",b);g.val(d.find(".drugName").text());a.find(".drugPackageSpec").text(b.DRUG_PACKAGE_SPEC);a.find(".china-drugDose").val(d.find(".drug-list-row").not(".drugListRowClone").data("drugDose")).focus();a.find(".china-drugUnitName").text(b.DRUG_DOSE_UNIT_NAME);cpmp.setSelectValue(a.find(".cn-source"),d.find(".drug-list-row").not(".drugListRowClone").data("drugSource")||0);cpmp.setSelectValue(a.find(".drug-usage"),d.find(".drugUsageName").attr("drugUsageId"));var e=d.find(".frequencyName");cpmp.setSelectValue(a.find(".drug-frequency"),e.attr("frequencyId"));var i={DRUG_FREQUENCY_QTY:e.attr("frequencyQty"),DRUG_FREQUENCY_NAME:e.text(),REMARK:e.attr("frequencyRemark")};a.find(".drug-frequency").find("input").data("data",i);a.find(".totalDay").val(d.find(".totalDay").attr("totalDay"))}a.find(".pawjzs-error").each(function(j,k){$(k).removeClass("pawjzs-error")})}}});$(".pill-list-content").on("click",".drug-list-row",function(g){g.stopPropagation();var d=$(this);if(!cpmp.isReadOnly){if(d.siblings().not(".drugListRowClone").length==0){d.parents(".pill-list-item").addClass("checked").siblings().removeClass("checked");d.parents(".pill-list-item").siblings().find(".drug-list-row").removeClass("checked")}else{d.parents(".pill-list-item").removeClass("checked").siblings().removeClass("checked");d.parents(".pill-list-item").siblings().find(".drug-list-row").removeClass("checked");d.addClass("checked").siblings().removeClass("checked")}var a=d.parents(".pill-middle-info").find(".importInfo");if(a.find(".delete-drug").length==0){a.find(".empty-drug").after('<i class="delete-drug" title="删除"></i>');a.find(".add-drug").after('<i class="update-drug" title="更新"></i>')}a.find(".add-drug").hide();var b=d.data("drug");var h="";if(d.parents(".pill-list-item").find(".list-number").text()){h=d.parents(".pill-list-item").find(".list-number").text().substr(0,d.parents(".pill-list-item").find(".list-number").text().indexOf("."))}a.find(".groupNum").attr("disabled","disabled");a.find(".groupNum").val(h);a.find(".totalQty").val(d.find(".totalQty").attr("totalQty")||0);var c={drugSplit:d.find(".totalQty").attr("drugSplit"),storeUnitId:d.find(".drugDose").attr("storeUnitId"),dispenseUnitId:d.find(".drugDose").attr("dispenseUnitId"),drugUnitId:d.find(".totalQty").attr("drugUnitId"),recipeUnit:d.find(".totalQty").attr("recipeUnit"),storeUnitName:d.find(".drugDose").attr("storeUnitName"),dispenseUnitName:d.find(".drugDose").attr("dispenseUnitName")};cpmp.initDrugTotalUnit(a.find(".drug-total-unit"),b,c);if(b){var i=a.find(".thinkBoxInputArea");i.attr("disabled","disabled");i.data("drug",b);i.val(d.parents(".pill-list-item").find(".drugName").text());a.find(".drugPackageSpec").text(b.DRUG_PACKAGE_SPEC);a.find(".china-drugDose").val(d.data("drugDose")).focus();a.find(".china-drugUnitName").text(b.DRUG_DOSE_UNIT_NAME);cpmp.setSelectValue(a.find(".cn-source"),d.data("drugSource")||0);cpmp.setSelectValue(a.find(".drug-usage"),d.parents(".pill-list-item").find(".drugUsageName").attr("drugUsageId"));var f=d.parents(".pill-list-item").find(".frequencyName");cpmp.setSelectValue(a.find(".drug-frequency"),f.attr("frequencyId"));var j={DRUG_FREQUENCY_QTY:f.attr("frequencyQty"),DRUG_FREQUENCY_NAME:f.text(),REMARK:f.attr("frequencyRemark")};a.find(".drug-frequency").find("input").data("data",j);a.find(".totalDay").val(d.parents(".pill-list-item").find(".totalDay").attr("totalDay"))}a.find(".pawjzs-error").each(function(e,k){$(k).removeClass("pawjzs-error")})}});$(".pill-listBox").on("mouseenter",".drug-list-operational",function(){if($(this).parents(".pill-wrap").find(".pill-status>i.changes").length>0||$(this).parents(".pill-wrap").find(".pill-status>i.new").length>0){$(this).find(".close-order-list").css("display","inline-block")}}).on("mouseleave",".drug-list-operational",function(){$(this).find(".close-order-list").hide()});$(document).keypress(function(f){if(f.which==13){if($(".importInfo .groupNum:visible").is(":focus")){$(".importInfo .drug-source:visible").focus().click()}else{if($(".importInfo .drug-source:visible").is(":focus")){$(".importInfo .thinkBoxInputArea:visible").focus()}else{if($(".importInfo .thinkBoxInputArea:visible").is(":focus")){$(".importInfo .china-drugDose:visible").focus()}else{if($(".importInfo .china-drugDose:visible").is(":focus")){var a=$(".importInfo .china-footnote:visible");a.focus().click();var b=$(".importInfo .drug-usage:visible").find(".drop-item[data-value='"+a.attr("val")+"']");b.addClass("drop_over").siblings().removeClass("drop_over");$(".importInfo .drug-usage .wjzs-drop-menu:visible").scrollTop(b.position().top)}else{if($(".importInfo .china-footnote:visible").is(":focus")){var g=$(".importInfo .frequencyName:visible");g.focus().click();var b=$(".importInfo .drug-frequency:visible").find(".drop-item[data-value='"+g.attr("val")+"']");b.addClass("drop_over").siblings().removeClass("drop_over");$(".importInfo .drug-frequency .wjzs-drop-menu:visible").scrollTop(b.position().top)}else{if($(".importInfo .frequencyName:visible").is(":focus")){$(".importInfo .totalDay:visible").focus()}else{if($(".importInfo .totalDay:visible").is(":focus")){$(".importInfo .totalQty:visible").focus()}else{if($(".importInfo .totalQty:visible").is(":focus")){var d=$(".importInfo .drug-total-unit:visible");d.focus().click();var b=$(".importInfo .drug-unit:visible").find(".drop-item[data-value='"+d.attr("val")+"']");b.addClass("drop_over").siblings().removeClass("drop_over");$(".importInfo .drug-unit .wjzs-drop-menu:visible").scrollTop(b.position().top)}else{if($(".importInfo .drug-total-unit:visible").is(":focus")){var c=$(".importInfo:visible").find(".update-drug");if(c.is(":visible")){cpmp.updateDrugToPrescription(c)}else{cpmp.addDrugToPrescription($(".add-drug:visible"))}}}}}}}}}}}});$(".topNav-item").off("click").on("click",function(){$(this).siblings("li").removeClass("choose");$(this).addClass("choose");$(this).parents(".topNav-wrap").next(".rightInfo-wrap").children().addClass("dsn");var a=$(this).parents(".topNav-wrap").next(".rightInfo-wrap");if($(this).index()==0){if("0"==$(".noDataHint").attr("hasHistoryRecipe")){a.children(".noDataHint").removeClass("dsn")}else{if("1"==$(".noDataHint").attr("hasHistoryRecipe")){a.children(".historyRecipe").removeClass("dsn")}}}else{if($(this).index()==1){a.children(".recipe-template").removeClass("dsn");cpmpTmpl.getChinaTmplMedicien()}else{a.children(".classicalDrug").removeClass("dsn")}}});$(".editorBtn").off("click").on("click",function(){$("#chineseTraDiagnosis").val(cpmp.empi.CHINESE_TRA_DIAGNOSIS!=null?cpmp.empi.CHINESE_TRA_DIAGNOSIS:"");$("#chineseTraDiagnosis").attr("val",Utils.trimObj(cpmp.empi.CHINESE_DIAGNOSIS_CODE));$("#westDiagnosis").val(cpmp.empi.DiagnosisList!=null?cpmp.empi.DiagnosisList:"");$("#westDiagnosis").attr("val",Utils.trimObj(cpmp.empi.diagnosisCode));$("#addDiagnosisPop").removeClass("dsn")});if(!$.support.leadingWhitespace){if($(".tab-content").width()>1340){$(".space-bg").show()}else{$(".space-bg").hide()}}$(".china-drugDose").off("keyup").on("keyup",function(){var e=$(this).parents(".importInfo");var a=e.find(".thinkBoxInputArea").data("drug");var b=$(this).val();var d=e.find(".frequencyName").data("data");var c=e.find(".totalDay").val();if(a&&b&&b!="必填项不能为空。"&&d&&c&&c!="必填项不能为空。"){e.find(".totalQty").val(cpmpUtils.caleAmount(a.DRUG_DOSAGE_TYPE,b,d.DRUG_FREQUENCY_QTY,c,a.DRUG_CONVERT_RATE_DOSE,a.DRUG_CONVERT_RATE,a.DRUG_CONVERT_RATE_STORE_UNIT||1,e.find(".drug-total-unit").val()===a.DRUG_STORE_UNIT_NAME?0:1))}});$(".totalDay").off("keyup").on("keyup",function(){var e=$(this).parents(".importInfo");var a=e.find(".thinkBoxInputArea").data("drug");var b=e.find(".china-drugDose").val();var d=e.find(".frequencyName").data("data");var c=$(this).val();if(a&&b&&b!="必填项不能为空。"&&d&&c&&c!="必填项不能为空。"){e.find(".totalQty").val(cpmpUtils.caleAmount(a.DRUG_DOSAGE_TYPE,b,d.DRUG_FREQUENCY_QTY,c,a.DRUG_CONVERT_RATE_DOSE,a.DRUG_CONVERT_RATE,a.DRUG_CONVERT_RATE_STORE_UNIT||1,e.find(".drug-total-unit").val()===a.DRUG_STORE_UNIT_NAME?0:1))}})},getCPMRecipes:function(g,d,c){var f=this;var b={acographyId:d,empiId:g};var a={url:ContextClinc_Server+"CPMPrescription/getCPMRecipes",dataType:"json",showMask:true,data:b};var e=Utils.myAjaxHandler(a);e.done(function(k){if(k.errorCode==SUCCESSCODE){$(".content-inner").removeAttr("style");var s=k.data.lstPrescription;f.empi=k.data.empi;if(s&&s.length>0){recipeListCache=s;f.isReadOnly=true;f.cleanAll();for(var o=0;s[o];o++){var r=s[o];var h=false;if(parseInt(r.recipeName)==c||(c==0&&o==0)){h=true}var u=(r.isSend==0&&r.isPay==0);var m=f.addPrescriptionTab(h,u,parseInt(r.recipeName));if(m){m.attr("data-id",r.recipeId)}}var p=s.length;var o=0;var n=s[0].recipeName;l();function l(){j();o++;if(o>p-1){return}if(o==p-1){setTimeout(function(){j()},30)}else{setTimeout(function(){l()},30)}}function j(){f.loadingPrescriptionBody(s,c,n,o);if(treatmentState==2){$(".tab-content-top .delete-cf").remove();$(".tab-content-top .add-cf").remove();$(".save").remove();if(!$(".topNav").hasClass("treat-completedState")){$(".topNav").addClass("treat-completedState")}}}if(treatmentState==="2"){cpmpHistory.init()}if(f.isReadOnly){f.makeReadonlyView()}}else{if(treatmentState=="1"){f.isReadOnly=false;if($(".recipe-label ul li").length>f.cpmRecipesMaxNum){$.paWarn("最多只能添加六个处方");return}var q=parseInt($(".recipe-label").find("ul li:last").attr("data-index"))+1;f.addPrescriptionTab(true,true,q);f.addPrescriptionBody(true,q,f.empi);f.makeEditView()}if(!d||treatmentState=="0"||treatmentState=="2"){if(treatmentState==="0"){var k=cpmpHistory.getDateListSync();var t;if(k&&SUCCESSCODE===k.errorCode&&k.data){t=_.filter(k.data,function(i){return i.ACOGRAPHYID!=d})}if(t&&t.length>0){$(".content-inner").show();cpmpHistory.initClick();cpmpHistory.renderPrescriptionHistory(k);$(".topNav").addClass("treat-completedState");$("#treat-waitingState-historyRec").show();f.makeReadonlyView()}else{$("#treat-waitingState").show()}}else{var k=cpmpHistory.getDateListSync();var t;if(k&&SUCCESSCODE===k.errorCode&&k.data){t=_.filter(k.data,function(i){return i.ACOGRAPHYID!=d})}if(t&&t.length>0){$(".content-inner").show();cpmpHistory.initClick();cpmpHistory.renderPrescriptionHistory(k);$(".topNav").addClass("treat-completedState");$("#treat-completedNoData-historyRec").show();f.makeReadonlyView()}else{$("#treat-completedNoData").show()}}}}}else{$.paError(k.errorCode+"：查询中成药处方失败！")}})},cleanAll:function(){$(".recipe-label").find(".prescription-tab-clone").siblings("li").remove();$(".left-prescription").find(".prescription-body-clone").siblings(".pill-wrap").remove();$(".pill-list-content").find(".prescription-cell-clone").siblings("li").remove()},getPrescriptionStauts:function(a,c){var b="new";if(c==0&&a==0){b="submitted"}else{if(a==1){if(c==0){b="hasCharge"}else{if(c==1){b="sentMedicine"}else{if(c==2){b="retiredMedicine"}else{if(c==6){b="backMedicine"}}}}}else{if(a==2){b="haveRefund"}else{if(a==3){b="partRefund"}else{if(a===4){b="inTheCharge"}else{if(a===5){b="inRefund"}}}}}}return b},loadingPrescriptionBody:function(e,f,a,c){var g=e[c];var b=false;if(parseInt(g.recipeName)==f||(f==0&&c==0)){b=true}var d=cpmp.addPrescriptionBody(b,parseInt(g.recipeName),cpmp.empi,g,a);cpmp.addPrescriptionBodyData(d,g)},makeReadonlyView:function(){$(".already-importInfo").show();$(".importInfo").hide();$(".add-recipe").hide();$(".delete").hide();$(".quote").hide();$(".recipe-info").hide();$(".pill-list-hint").show();$(".pill-bottom-info").show();$(".save").text("修改");$(".allowEdit").attr("disabled","disabled");$(".recipe-template-item").removeClass("china-tmpl-dd");$(".pill-status>i.changes").removeClass("changes").addClass("submitted");$(".editorBtn").hide();finishPatFlag=true},addPrescriptionTab:function(a,c,b){if($(".recipe-label ul li").length>cpmp.cpmRecipesMaxNum){$.paWarn("最多只能添加六个处方");return}var d=$(".recipe-label .prescription-tab-clone").clone(true).removeClass("prescription-tab-clone").attr("data-index",b).show();d.find("span").text("成药方"+b);if(c){d.addClass("allowEdit");d.find(".delete").show()}else{d.addClass("readonly");d.find(".delete").removeClass("delete")}$(".recipe-label ul").append(d);if(a){d.addClass("checked");d.siblings("li").removeClass("checked");$(".print").attr("title","打印处方"+b);$(".saveAs").attr("title","处方"+b+"存为模板")}return d},addPrescriptionBody:function(b,i,k,j,e){if($(".pill-wrap").length>cpmp.cpmRecipesMaxNum){$.paWarn("最多只能添加六个处方");return}var d=$(".prescription-body-clone").clone(true).removeClass("prescription-body-clone").attr("data-index",i);$(".foot-btn").before(d);if(i==e){d.removeAttr("style")}if(b){if(i!=e){var a=$(".prescription-body-clone").clone(true).removeClass("prescription-body-clone").attr("data-index",e);a.attr("style","display:none")}d.removeAttr("style");$(".left-prescription > .pill-wrap[data-index="+i+"]").show().siblings(".pill-wrap").hide()}d.find(".patient-healthCard").text(k.INSURANCE_NO?k.INSURANCE_NO:"-");d.find(".acography-serial-no").text(k.ACOGRAPHY_SERIAL_NO);d.find(".clinic-name").text(userInfo_aclc.clinicName);d.find(".patient-name").text(k.PATIENT_NAME).attr("title",k.PATIENT_NAME);d.find(".patient-gender").text(k.PATIENT_GENDER=="1"?"男":k.PATIENT_GENDER=="2"?"女":k.PATIENT_GENDER=="3"?"保密":"");d.find(".patient-age").text(Utils.getPersonAccurateAge(k.PATIENT_BIRTH_DATE));d.find(".department-name").text((k.DEPARTMENT_NAME||"-"));d.find(".payment-type-name").text(k.MI_TYPE_NAME||"自费");d.find(".patient-no").text((k.PATIENT_NO||"-"));var f=Utils.isBlank(k.MOBILE_PHONE_NUMBER)?k.MOBILE_PHONE_NUMBER:"-";var h=Utils.isBlank(k.LIVING_ADDRESS_COUNTRYSIDE)?(k.LIVING_ADDRESS_COUNTRYSIDE+"/"+f):("-/"+f);d.find(".living-address-countryside").text(h).attr("title",h);var g=k.CHINESE_TRA_DIAGNOSIS;if(g){if(k.DiagnosisList){g+="；"+k.DiagnosisList;$("#westDiagnosis").val(k.DiagnosisList!=null?k.DiagnosisList:"");$("#westDiagnosis").attr("val",k.diagnosisCode!=null?k.diagnosisCode:"")}}else{g=k.DiagnosisList}$("#chineseTraDiagnosis").val(k.CHINESE_TRA_DIAGNOSIS!=null?k.CHINESE_TRA_DIAGNOSIS:"");$("#chineseTraDiagnosis").attr("val",k.CHINESE_DIAGNOSIS_CODE!=null?k.CHINESE_DIAGNOSIS_CODE:"");d.find(".diagnosis").text(g||"-").attr("title",g||"-");d.find(".diagnosis").attr("cn_medical_id",k.CN_MEDICAL_ID||"");var c=(j&&j.addDate)?j.addDate:_.now();d.find(".add-date").text(Utils.timeStampToDateStr(c,7));d.find(".doctorNameShow").text(k.DOCTOR_NAME||"");if(!cpmp.isShowFee){d.find(".china-totalPrice2").parent().hide();d.find(".china-totalPrice").text("-")}if(!cpmp.isModifyPrice){d.find(".china-totalPrice2").attr("disabled","disabled")}else{d.find(".china-totalPrice2").removeAttr("disabled")}if(j){if(j.isSend==0&&j.isPay==0){d.ketchup()}else{d.addClass("readonly");d.find(".importInfo").addClass("readonly");d.find(".already-importInfo").addClass("readonly");d.find(".recipe-info").addClass("readonly");d.find(".pill-list-hint").addClass("readonly");d.find(".pill-bottom-info").addClass("readonly")}d.find(".pill-status>i").attr("class",cpmp.getPrescriptionStauts(j.isPay,j.isSend))}else{d.ketchup()}cpmp.initFrequencyDropBox(d.find(".frequencyNameDropDown"));cpmp.initDrugUsage(d);cpmp.initDrugSource(d);cpmp.initalCPMRecipesThinkBox(d.find(".thinkBoxInputArea"),i);if(b){cpmp.drugWithdrawalView(i)}return d},drugWithdrawalView:function(a){if(cpmp.isDrugWithdrawal&&$(".left-prescription > .pill-wrap[data-index="+a+"]").find(".pill-status>i.sentMedicine").length>0){$(".applyRefund").css("display","inline-block")}else{$(".applyRefund").css("display","none")}},prescriptionType:[],initDrugUsage:function(a){var c={};var b={type:"GET",method:"GET",url:ContextClinc_Server+"combox/drugUsage",dataType:"json",data:null,async:true};var d=Utils.myAjaxHandler(b);d.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){if(cpmp.prescriptionType&&cpmp.prescriptionType.length==0){_.each(e.data,function(g){cpmp.prescriptionType.push({dictItemCode:g.DRUG_USAGE_ID,dictItemName:g.DRUG_USAGE_NAME})})}var f={idKey:"dictItemCode",txtKey:"dictItemName",isNeedThink:false,isNeedClear:false};a.find(".china-footnote").WJZSDropdown(cpmp.prescriptionType,f,function(g,h){})}else{$.paError(e.errorMessage)}}).fail(function(e){$.paError("操作失败!")}).always(function(){})},initDrugSource:function(a){var b={isNeedClear:false};a.find(".drug-source").WJZSDropdown(this.drugSourceData,b,function(c,d){});a.find(".drug-source").SelectWJZSDropdownFirstItem()},makeEditView:function(){$(".already-importInfo.readonly").show();$(".already-importInfo:not(.readonly)").hide();$(".importInfo:not(.readonly)").show();$(".importInfo.readonly").hide();$(".add-recipe").show();$(".recipe-label-item.checked").find(".delete").show();$(".quote").not(".hideQuote").show();$(".recipe-info:not(.readonly)").show();$(".recipe-info.readonly").hide();$(".pill-list-hint:not(.readonly)").hide();$(".pill-list-hint.readonly").show();$(".pill-bottom-info:not(.readonly)").hide();$(".pill-bottom-info.readonly").show();$(".drugType").cancelDisabledAll();$(".save").text("保存");$(".allowEdit").removeAttr("disabled");$(".recipe-template-item").addClass("china-tmpl-dd");$(".pill-status>i.submitted").removeClass("submitted").addClass("changes");cpmp.checkCellLowStock();$(".thinkBoxInputArea").focus();$(".editorBtn").show();$(".groupNum").removeAttr("disabled");finishPatFlag=false},checkCellLowStock:function(){$.each($(".left-prescription .pill-wrap:gt(0)"),function(a,c){if($(this).find(".pill-status>i.submitted").length>0||$(this).find(".pill-status>i.changes").length>0){var b=$(this).find(".pill-list-content");cpmpUtils.calcTotalPrice(b,true)}})},initalCPMRecipesThinkBox:function(f,c){var d=[{display:"名称",dataKey:"DRUG_NAME",width:100},{display:"规格",dataKey:"DRUG_PACKAGE_SPEC",width:90},{display:"库存",dataKey:"SHOW_STORE_VALIDE_QTY",width:120}];if(cpmp.isYBFlag){var e={display:"医保属性",dataKey:"FEE_LEVEL",width:60};d.splice(1,0,e)}if(cpmp.isShowFee){var g={display:"价格(¥)",dataKey:isYbReg!=="1"&&cpmp.isYBFlag?"CEILING_PRICE":"NEW_RETAIL_PRICE",width:60};d.splice(d.length-1,0,g)}var b={columns:d,extraParams:{key:"keyword",limitRows:20,drugPropType:4},rowHighlight:function(i){var h=false;if(cpmp.isYBFlag){if(i.FEE_LEVEL=="未对照"){h=true}}return h},wrapperHandle:".tab-content",selectFirst:true,matchContains:"word",autoFill:false,width:560,formatResult:function(h){return h.DRUG_NAME},formatMatch:function(k,j,h){return k.DRUG_NAME+"--"+k.DRUG_CODE+"--"+k.PY_CODE+"--"+k.WB_CODE},multiple:false,multipleSeparator:", ",highlight:function(i,h){return i.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+h.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:180};var a=ContextClinc_Server+"drugAPI/getMdcDictDrug";f.autocomplete(a,b).result(function(h,l,m){if(l){var k=f.parents(".importInfo");cpmp.setSelectValue(k.find(".drug-usage"),l.DRUG_USAGE_ID||"");cpmp.setSelectValue(k.find(".drug-frequency"),l.DRUG_FREQUENCY_ID||"");var j=$(k.find(".drug-frequency")).find(".drop-item[data-value='"+l.DRUG_FREQUENCY_ID+"']");if(j.length>0){k.find(".drug-frequency").find("input").data("data",j.data().drop_data)}cpmp.setGroupNo(f.parents(".pill-middle-info"));k.find(".drugPackageSpec").text(l.DRUG_PACKAGE_SPEC||"");var s=l.DRUG_STORE_UNIT_QTY;var n=k.find(".drug-source").attr("val");l.drugSource=n;if(stock.isStockCheck&&n!=1){if(s>0){f.data("drug",l);k.find(".china-drugUnitName").text(l.DRUG_DOSE_UNIT_NAME);k.find(".china-drugDose").val(l.DRUG_DOSE).focus()}else{$.paWarn("该中成药暂无库存！");f.val("").focus()}}else{f.data("drug",l);k.find(".china-drugUnitName").text(l.DRUG_DOSE_UNIT_NAME);k.find(".china-drugDose").val(l.DRUG_DOSE).focus()}var p=l;k=$(this).parents(".importInfo");var r=k.find(".china-drugDose").val();var q=k.find(".frequencyName").data("data");var i=k.find(".totalDay").val();var o={drugSplit:p.DRUG_SPLIT,storeUnitId:p.DRUG_STORE_UNIT_ID,dispenseUnitId:p.DRUG_DISPENSE_UNIT_ID,drugUnitId:p.DRUG_DISPENSE_UNIT_ID,recipeUnit:p.DRUG_DISPENSE_UNIT_NAME,storeUnitName:p.DRUG_STORE_UNIT_NAME,dispenseUnitName:p.DRUG_DISPENSE_UNIT_NAME};cpmp.initDrugTotalUnit(k.find(".drug-total-unit"),p,o);if(p&&r&&r!="必填项不能为空。"&&q&&i&&i!="必填项不能为空。"){k.find(".totalQty").val(cpmpUtils.caleAmount(p.DRUG_DOSAGE_TYPE,r,q.DRUG_FREQUENCY_QTY,i,p.DRUG_CONVERT_RATE_DOSE,p.DRUG_CONVERT_RATE,p.DRUG_CONVERT_RATE_STORE_UNIT||1,k.find(".drug-total-unit").val()===p.DRUG_STORE_UNIT_NAME?0:1))}}})},setGroupNo:function(b){if(b.find(".groupNum").val()){return}var a=0;b.find(".list-number").each(function(){var c=parseInt($(this).html());a=a<c?c:a});b.find(".groupNum").val(a+1)},addPrescriptionBodyData:function(e,o){var q=cpmpUtils.toDecimal2(o.totalPrice);if(_.isNumber(o.totalPrice)){e.find(".china-totalPrice2").val(q)}if(!cpmp.isShowFee){q="-"}e.find(".china-totalPrice").text(q);e.find(".china-advice").val();e.find(".china-advice").val(o.advice).blur();var i=e.find(".thinkBoxInputArea");var m=o.recipeWestList;e.find(".already-importInfo .china-advice").text((Utils.notBlank(o.advice)?o.advice:""||"无"));var a=[];for(var h=0;m[h];h++){var k=m[h];a.push(k.drugId)}var r=cpmp.getMdcDictDrugWithId(a);var c=[];if(m.length==r.length){c=m}else{_.each(m,function(j,s){_.each(r,function(u,t){if(j.drugId==u.DRUG_ID){c.push(j);return false}})})}var d=parseInt((c.length+8-1)/8);e.find(".page").text(d);var b={};_.each(c,function(j,s){if(b[j.groupNum]){b[j.groupNum].push(j)}else{b[j.groupNum]=[];b[j.groupNum].push(j)}});var g=Object.keys(b);for(var n in g){var m=b[g[n]];if(!m||m.length==0){continue}var f=e.find(".prescription-cell-clone").clone(true).removeClass("prescription-cell-clone").show();e.find(".pill-list-content .pill-list-item-ul").append(f);f.find(".list-number").text(g[n]+".");for(var k in m){var l=cpmp.searchDrugFromDrugList(r,m[k].drugId);if(l){var p=cpmp.addPrescriptionCell(f);e.find(".pill-listBox").show();e.find(".pill-list-content>.without-drugs").hide();e.find(".pill-list-hint>i").show();e.find(".pill-list-content").find(".pill-list-item-ul")[0].scrollIntoView(false);cpmp.addExistPrescriptionCellData(p,l,m[k].drugDose,m[k].footnote,m[k].footnoteName,m[k].drugSource,o.recipeName,m[k].totalQty,o,m[k]);p.attr("recipecnid",m[k].recipeWestId);p.attr("recipeId",m[k].recipeId);p.attr("drugid",m[k].drugId)}}f.find(".drugUsageName").text(m[k].drugUsageName||"").attr("title",m[k].drugUsageName||"");f.find(".drugUsageName").attr("drugUsageId",m[k].drugUsageId||"");f.find(".frequencyName").text(m[k].frequencyName||"").attr("title",m[k].frequencyRemark||"");f.find(".frequencyName").attr("frequencyId",m[k].frequencyId||"");f.find(".frequencyName").attr("frequencyQty",m[k].frequencyQty||0);f.find(".frequencyName").attr("frequencyRemark",m[k].frequencyRemark||"");f.find(".totalDay").text((m[k].totalDay||"")+"天").attr("title",(m[k].totalDay||"")+"天");f.find(".totalDay").attr("totalDay",m[k].totalDay||"");if(m&&m.length>1){if(f.hasClass("drug-list-operational")){f.removeClass("drug-list-operational")}}else{if(m&&m.length==1){if(f.find(".drug-list-row").hasClass("drug-list-operational")){f.find(".drug-list-row").removeClass("drug-list-operational")}if(f.find(".pill-list-leftInfo-right").hasClass("list-special-line")){f.find(".pill-list-leftInfo-right").removeClass("list-special-line")}}}}},getMdcDictDrugWithId:function(b){var e=null;if(b&&b!=""){var d={drugIds:b};var a={type:"POST",method:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"intentInput/getMdcDictDrugWithDrugId",data:JSON.stringify(d),dataType:"json",async:false};var c=Utils.myAjaxHandler(a);c.done(function(f){if(!f.errorMessage){e=f.data}else{$.paError(f.errorMessage,null);return}}).fail(function(f){$.paError("请求异常",null)}).always(function(){})}return e},searchDrugFromDrugList:function(c,a){var b=null;if(c&&c.length>0&&a&&a!=""){$.each(c,function(e,f){var d=Utils.trimObj(f.DRUG_ID);if(d!=""&&d==a){b=f;return false}})}return b},addPrescriptionCell:function(b){var a=b.find(".drugListRowClone").clone(true).removeClass("drugListRowClone").show();b.find(".rightDrugClone").append(a);return a},addPrescriptionCellData:function(j,d,g,f,i,c,e,a,b,h){d.drugSource=c;j.data("drug",d);j.data("drugDose",g);j.data("footnote",f);j.data("drugSource",c);j.data("totalQty",parseInt(a));j.find(".drugSpec").text(d.DRUG_PACKAGE_SPEC||"").attr("title",d.DRUG_PACKAGE_SPEC);j.find(".drugDose").text((g||"")+(d.DRUG_DOSE_UNIT_NAME||"")).attr("title",(g||"")+(d.DRUG_DOSE_UNIT_NAME||"")).attr("drugUnitName",d.DRUG_DOSE_UNIT_NAME).attr("dispenseUnitName",d.DRUG_DISPENSE_UNIT_NAME).attr("drugDose",g).attr("storeUnitId",d.DRUG_STORE_UNIT_ID).attr("storeUnitName",d.DRUG_STORE_UNIT_NAME).attr("dispenseUnitId",d.DRUG_DISPENSE_UNIT_ID);j.find(".totalQty").text((parseInt(a)||"")+(b||"")).attr("title",(parseInt(a)||"")+(b||"")).attr("recipeUnit",b).attr("totalQty",parseInt(a)).attr("drugSplit",d.DRUG_SPLIT).attr("scatteredPrice",d.NEW_SCATTERED_PRICE).attr("unitPrice",isYbReg!=="1"&&cpmp.isYBFlag?d.CEILING_PRICE:d.NEW_RETAIL_PRICE).attr("unitPriceForCalc",b===d.DRUG_STORE_UNIT_NAME?isYbReg!=="1"&&cpmp.isYBFlag?d.CEILING_PRICE:d.NEW_RETAIL_PRICE:d.NEW_SCATTERED_PRICE).attr("drugUnitId",h);if(c==1){j.addClass("outsourcing")}else{if(c==2){j.addClass("forFree")}else{j.removeClass("outsourcing").removeClass("forFree")}}j.find(".drugName").text(d.DRUG_NAME||"").attr("drugId",d.DRUG_ID).attr("title",d.DRUG_NAME);cpmp.addDrugIdArr(e,d.DRUG_ID)},addExistPrescriptionCellData:function(j,d,g,f,i,c,e,a,h,b){d.drugSource=c;j.data("drug",d);j.data("drugDose",g);j.data("footnote",f);j.data("drugSource",c);j.data("totalQty",parseInt(a));j.find(".drugSpec").text(b.drugSpec||"").attr("title",b.drugSpec||"");j.find(".drugDose").text((g||"")+(b.drugUnitName||"")).attr("drugUnitName",b.drugUnitName).attr("title",b.drugDose+b.drugUnitName||"").attr("drugDose",b.drugDose).attr("storeUnitId",b.storeUnitId).attr("storeUnitName",b.storeUnitName).attr("dispenseUnitName",b.dispenseUnitName).attr("dispenseUnitId",d.DRUG_DISPENSE_UNIT_ID);j.find(".totalQty").text((parseInt(a)||"")+(b.recipeUnit||"")).attr("drugUnitId",b.drugUnitId).attr("recipeUnit",b.recipeUnit).attr("title",parseInt(a)+b.recipeUnit||"");j.find(".totalQty").attr("totalQty",parseInt(a)).attr("drugSplit",b.drugSplit).attr("scatteredPrice",b.scatteredPrice).attr("unitPrice",b.unitPrice).attr("unitPriceForCalc",b.recipeUnit===b.storeUnitName?b.unitPrice:b.scatteredPrice);if(h){if(h.isSend==0&&h.isPay==0){}else{j.find(".close-order-list").removeClass("close-order-list").hide()}}if(c==1){j.addClass("outsourcing")}else{if(c==2){j.addClass("forFree")}else{j.removeClass("outsourcing").removeClass("forFree")}}j.find(".drugName").text(b.drugName||"").attr("drugId",b.drugId).attr("title",b.drugName);cpmp.addDrugIdArr(e,b.drugId)},addDrugIdArr:function(b,a){cpmp.drugIdArr.push(b+"|"+a)},getCPMRecipesData:function(){var a=[];var r=$(".left-prescription .pill-wrap");var f=r.length;for(var c=1;c<=f-1;c++){if($($(".recipe-label-item")[c]).hasClass("readonly")){continue}var k=$(r[c]).find(".pill-list-content .drug-list-row").not(".drugListRowClone");var o=k.length;var m=$(".recipe-label .recipe-label-item:eq("+c+")").attr("data-index");var l=$(k[0]).find(".drugName").text();if(o==0){if(l==null||l==""||l==undefined){return{code:1,errorMsg:"处方"+m+"无中成药，请添加！"}}}var p=$(r[c]).find(".china-totalPrice2").val();if(!p){return{code:1,errorMsg:"处方"+m+"总金额为空，请添加！"}}if(cpmpUtils.toDecimal2(p).length>10){return{code:1,errorMsg:"处方"+m+"总金额输入过大，请重新输入！"}}var h=[];var e=1;for(var b=0;b<o;b++){var d=$(k[b]).data("drug");if(d.DRUG_NAME){var g=$(k[b]).parent().parent().parent().find(".list-number").text();if(g){g=g.substr(0,$(r[c]).find(".list-number").text().indexOf("."))}var q={orderNum:e++,recipeWestId:$(k[b]).attr("recipecnid"),drugName:$(k[b]).find(".drugName").text(),drugSource:$(k[b]).data("drugSource"),drugDose:$(k[b]).data("drugDose"),drugUnitName:$(k[b]).find(".drugDose").attr("drugUnitName"),drugUnitId:$(k[b]).find(".totalQty").attr("drugUnitId"),unitPrice:$(k[b]).find(".totalQty").attr("unitPrice"),drugId:d.DRUG_ID,totalQty:$(k[b]).find(".totalQty").attr("totalQty")||0,groupNum:g,drugUsageId:$(k[b]).parents(".pill-list-item").find(".drugUsageName").attr("drugUsageId"),drugUsageName:$(k[b]).parents(".pill-list-item").find(".drugUsageName").text(),frequencyId:$(k[b]).parents(".pill-list-item").find(".frequencyName").attr("frequencyId"),frequencyName:$(k[b]).parents(".pill-list-item").find(".frequencyName").text(),frequencyQty:$(k[b]).parents(".pill-list-item").find(".frequencyName").attr("frequencyQty"),totalDay:$(k[b]).parents(".pill-list-item").find(".totalDay").attr("totalDay"),drugSpec:$(k[b]).find(".drugSpec").text(),recipeUnit:$(k[b]).find(".totalQty").attr("recipeUnit"),storeUnitId:$(k[b]).find(".drugDose").attr("storeUnitId"),storeUnitName:$(k[b]).find(".drugDose").attr("storeUnitName"),drugSplit:$(k[b]).find(".totalQty").attr("drugSplit"),scatteredPrice:$(k[b]).find(".totalQty").attr("scatteredPrice"),dispenseUnitName:$(k[b]).find(".drugDose").attr("dispenseUnitName")};h.push(q)}}for(var b=0;cpmp.deleteRecipeCnArr[b];b++){var q={recipeWestId:cpmp.deleteRecipeCnArr[b].recipecnid,delFlag:1,recipeId:cpmp.deleteRecipeCnArr[b].recipeId};h.push(q)}var n={recipeId:$(".recipe-label .recipe-label-item:eq("+c+")").attr("data-id"),acographyId:acographyId,recipeName:m,totalPrice:$(r[c]).find(".china-totalPrice2").val(),advice:$(r[c]).find(".china-advice").val(),recipeWestList:h};a.push(n)}return{code:0,errorMsg:"",data:a}},getParam:function(){cpmp.isDrugWithdrawal=_.find(userInfo_aclc.clinicParams,function(a){return a.parameterCode=="3010"}).parameterValue==2?false:true;cpmp.isShowFee=_.find(userInfo_aclc.clinicParams,function(a){return a.parameterCode=="3013"}).parameterValue==2?true:false;cpmp.isModifyPrice=_.find(userInfo_aclc.clinicParams,function(a){return a.parameterCode=="3020"}).parameterValue==2?false:true;if(null!=userInfo_aclc.clinic&&null!=userInfo_aclc.clinic.tags){cpmp.isYBFlag=_.find(userInfo_aclc.clinic.tags,function(a){return a.tagCode=="MI"})!=undefined?true:false}},initChiefComThinkInput:function(){var c={canedit:true,columns:[{display:"编码",dataKey:"DICT_DIAGNOSIS_CODE",width:60},{display:"名称",dataKey:"DICT_DIAGNOSIS_NAME",width:230}],extraParams:{key:"keyword",pageSize:20,diagonsisType:"0",isJoinMI:isYbReg==1?1:0},selectFirst:true,formatResult:function(d){return},formatMatch:function(f,e,d){return f.DICT_DIAGNOSIS_NAME+"--"+f.DICT_DIAGNOSIS_CODE+"--"+f.PY_CODE+"--"+f.WB_CODE},matchContains:"word",autoFill:false,width:485,max:100,multiple:false,multipleSeparator:", ",highlight:function(e,d){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+d.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:180};var a={canedit:true,columns:[{display:"编码",dataKey:"DICT_DIAGNOSIS_CODE",width:60},{display:"名称",dataKey:"DICT_DIAGNOSIS_NAME",width:230}],extraParams:{key:"keyword",pageSize:20,diagonsisType:"1"},selectFirst:true,formatResult:function(d){return},formatMatch:function(f,e,d){return f.DICT_DIAGNOSIS_NAME+"--"+f.DICT_DIAGNOSIS_CODE+"--"+f.PY_CODE+"--"+f.WB_CODE},matchContains:"word",autoFill:false,width:485,max:100,multiple:false,multipleSeparator:", ",highlight:function(e,d){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+d.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:180};var b=ContextClinc_Server+"dwsCnMedical/getMdcDictChiefComplaint";document.getElementById("westDiagnosis").oninput=function(){$("#westDiagnosis").attr("val","")};document.getElementById("chineseTraDiagnosis").oninput=function(){$("#chineseTraDiagnosis").attr("val","")};$("#westDiagnosis").autocomplete(b,c).result(function(d,f,e){$("#westDiagnosis").val(f.DICT_DIAGNOSIS_NAME);$("#westDiagnosis").attr("val",f.DICT_DIAGNOSIS_CODE)});$("#chineseTraDiagnosis").autocomplete(b,a).result(function(d,f,e){$("#chineseTraDiagnosis").val(f.DICT_DIAGNOSIS_NAME);$("#chineseTraDiagnosis").removeClass("pawjzs-error");$("#chineseTraDiagnosis").attr("val",f.DICT_DIAGNOSIS_CODE)})},initFrequencyDropBox:function(c){var a=this;var b=a.selectFrequencyAction(null,function(e){var d={idKey:"DRUG_FREQUENCY_ID",txtKey:"REMARK",isNeedClear:false};frequencyDataArray=e;c.WJZSDropdown(e,d,function(i,j){var k=c.parents(".importInfo");k.find(".totalQty").removeClass("pawjzs-error");c.data("data",j);var f=k.find(".thinkBoxInputArea").data("drug");if(!f){return}var g=k.find(".china-drugDose").val();var h=k.find(".totalDay").val();if(g&&g!="必填项不能为空。"&&h&&h!="必填项不能为空。"){k.find(".totalQty").val(cpmpUtils.caleAmount(f.DRUG_DOSAGE_TYPE,g,j.DRUG_FREQUENCY_QTY,h,f.DRUG_CONVERT_RATE_DOSE,f.DRUG_CONVERT_RATE,f.DRUG_CONVERT_RATE_STORE_UNIT||1,k.find(".drug-total-unit").val()===f.DRUG_STORE_UNIT_NAME?0:1))}})})},selectFrequencyAction:function(c,f){var a=this;if(a.freData!=null&&f){if(f){f.call(a,a.freData);return}}var d={};var b={type:"GET",method:"GET",url:ContextClinc_Server+"combox/drugFrequency",dataType:"json",data:null,async:true};var e=Utils.myAjaxHandler(b);e.done(function(g){if(g!=null&&g.errorCode==SUCCESSCODE){a.freData=g.data;if(f){f.call(a,a.freData)}}else{$.paError(g.errorMessage)}}).fail(function(g){$.paError("操作失败!")}).always(function(){})},addDrugToPrescription:function(q){var j=q.parents(".importInfo");var g=$.trim(j.find(".groupNum").val());if(!g){$.paAlert("请填写组号！");return}var n=q.parents(".pill-wrap").find(".pill-list-item").not(".prescription-cell-clone").find(".drug-list-row").not(".drugListRowClone");if(n&&n.length>999){$.paWarn("一张成药方药品数量不能超过1000个！");return}var h=j.find(".thinkBoxInputArea");if(!h.val()){$.paAlert("请选择中成药！");return}var u=h.data("drug");var t=[];t.push(u.DRUG_ID);n.each(function(E){t.push($(this).attr("drugid"))});var A=_.uniq(t);if(A.length>1000){$.paWarn("一张成药方药品种类不能超过1000种！");return}if(!$.trim(j.find(".china-drugDose").val())){$.paAlert("请添加用量！");return}if(!j.find(".china-footnote").val()){$.paAlert("请添加用法！");return}if(!j.find(".frequencyName").val()){$.paAlert("请添加频率！");return}if(!$.trim(j.find(".totalDay").val())){$.paAlert("请添加天数！");return}if(!$.trim(j.find(".totalQty").val())){$.paAlert("请添加总量！");return}var p=j.ableToFinish();if(!p){return}var k=h.parents(".pill-wrap").attr("data-index");var f=h.data("recipe");var C=[];h.parents(".pill-wrap").find(".pill-list-item").not(".prescription-cell-clone").find(".drug-list-row").not(".drugListRowClone").each(function(F,G){var E=$(G).parents(".pill-list-item").not(".prescription-cell-clone").find(".list-number").text();if(E){E=E.substr(0,E.indexOf("."))}C.push(k+"|"+$(G).attr("drugid")+"|"+E)});if($.inArray(k+"|"+u.DRUG_ID+"|"+g,C)==-1){var o=h.parents(".pill-wrap");var b=j.find(".china-drugDose").val();var s=j.find(".china-footnote").attr("val");var d=j.find(".china-footnote").val();var v=j.find(".drug-source").attr("val");var w=o.find(".pill-list-item").not(".prescription-cell-clone");var i=false;var D=[];D.push(u.DRUG_ID);var y=cpmp.getMdcDictDrugWithId(D);for(var k=0;k<w.length;k++){if($(w[k]).find(".list-number").text()==(g+".")){if(!$(w[k]).find(".pill-list-leftInfo-right").hasClass("list-special-line")){$(w[k]).find(".pill-list-leftInfo-right").addClass("list-special-line")}if(!$(w[k]).find(".drug-list-row").hasClass("drug-list-operational")){$(w[k]).find(".drug-list-row").addClass("drug-list-operational")}if($(w[k]).hasClass("drug-list-operational")){$(w[k]).removeClass("drug-list-operational")}var c=cpmp.addPrescriptionCell($(w[k]));o.find(".pill-listBox").show();o.find(".pill-list-content>.without-drugs").hide();o.find(".pill-list-hint>i").show();o.find(".pill-list-content").find(".pill-list-item-ul")[0].scrollIntoView(false);var u=cpmp.searchDrugFromDrugList(y,u.DRUG_ID);cpmp.addPrescriptionCellData(c,u,b,s,d,v,k,j.find(".totalQty").val(),j.find(".drug-total-unit").val(),j.find(".totalQty").attr("drugUnitId"));$(w[k]).find(".drugUsageName").text(d).attr("drugUsageId",s).attr("title",d);var r=j.find(".frequencyName");var x=r.data("data");$(w[k]).find(".frequencyName").text(x.DRUG_FREQUENCY_NAME).attr("frequencyId",r.attr("val")).attr("frequencyQty",x.DRUG_FREQUENCY_QTY).attr("title",x.REMARK);$(w[k]).find(".totalDay").text(j.find(".totalDay").val()+"天").attr("totalDay",j.find(".totalDay").val()).attr("title",j.find(".totalDay").val()+"天");c.data("footnote",s);c.data("drugDose",b);c.data("drugSource",v);c.attr("drugid",u.DRUG_ID);i=true;var l=[];_.each(c.siblings().not(".drugListRowClone"),function(E){l.push($(E).attr("drugId"))});var z=cpmp.getMdcDictDrugWithId(l);var B=j.find(".frequencyName").data("data").DRUG_FREQUENCY_QTY;var m=j.find(".totalDay").val();_.each(c.siblings().not(".drugListRowClone"),function(G){var H=$(G);var F=cpmp.searchDrugFromDrugList(z,H.attr("drugId"));var E=cpmpUtils.caleAmount(F.DRUG_DOSAGE_TYPE,(H.find(".drugDose").attr("drugDose")||0),B,m,F.DRUG_CONVERT_RATE_DOSE,F.DRUG_CONVERT_RATE,F.DRUG_CONVERT_RATE_STORE_UNIT||1,H.find(".drug-total-unit").val()===F.DRUG_STORE_UNIT_NAME?0:1);H.find(".totalQty").text(E+H.find(".totalQty").attr("recipeUnit")).attr("totalQty",E)});break}}if(!i){var a=o.find(".prescription-cell-clone").clone(true).removeClass("prescription-cell-clone").show();a.find(".list-number").text(g+".");if(a.find(".pill-list-leftInfo-right").hasClass("list-special-line")){a.find(".pill-list-leftInfo-right").removeClass("list-special-line")}if(a.find(".drug-list-row").hasClass("drug-list-operational")){a.find(".drug-list-row").removeClass("drug-list-operational")}if(!a.find(".pill-list-item").hasClass("drug-list-operational")){a.find(".pill-list-item").addClass("drug-list-operational")}var c=cpmp.addPrescriptionCell(a);var u=cpmp.searchDrugFromDrugList(y,u.DRUG_ID);cpmp.addPrescriptionCellData(c,u,b,s,d,v,k,j.find(".totalQty").val(),j.find(".drug-total-unit").val(),j.find(".totalQty").attr("drugUnitId"));a.find(".drugUsageName").text(d).attr("drugUsageId",s).attr("title",d);var r=j.find(".frequencyName");var x=j.find(".frequencyName").data("data");a.find(".frequencyName").text(x.DRUG_FREQUENCY_NAME).attr("frequencyId",r.attr("val")).attr("frequencyQty",x.DRUG_FREQUENCY_QTY).attr("title",x.REMARK);a.find(".totalDay").text(j.find(".totalDay").val()+"天").attr("totalDay",j.find(".totalDay").val()).attr("title",j.find(".totalDay").val()+"天");a.find(".drug-list-row").not(".drugListRowClone").data("footnote",s);a.find(".drug-list-row").not(".drugListRowClone").data("drugDose",b);a.find(".drug-list-row").not(".drugListRowClone").data("drugSource",v);a.find(".drug-list-row").not(".drugListRowClone").attr("drugid",u.DRUG_ID);o.find(".pill-list-item-ul").append(a);o.find(".pill-listBox").show();o.find(".pill-list-content>.without-drugs").hide();o.find(".pill-list-hint>i").show();o.find(".pill-list-content").find(".pill-list-item-ul")[0].scrollIntoView(false)}var e=h.parents(".pill-middle-info").find(".pill-list-content");cpmpUtils.calcTotalPrice(e);cpmp.cleanDrugInput(j);cpmp.revertAddStatus(j)}else{$.paWarn("处方"+k+"组"+g+"中已存在该中成药！")}},renderResableMecdtion:function(d){var h=[];if(d){var o=d;for(var p=0;p<o.length;p++){var e={title:null,msg:[]};var f=o[p];e.title="成药处方"+f.warningMsg;var r=f.result.resultCode;if("000000"!=r){continue}if(f.result.result){for(var n=0;n<f.result.result.length;n++){var s=f.result.result[n];if(s.hitSize=="0"){continue}e.msg.push(s.msg);if(s.results){for(var m=0;m<s.results.length;m++){var c=s.results[m];e.msg.push(c.violationDetails[0].ruleMsg)}}}}else{e.msg.push(f.result.msg)}h.push(e)}}if(h&&h.length>0){var b="";for(var m=0;m<h.length;m++){var a=h[m];var q=a.title;for(var g=0;g<a.msg.length;g++){b+='<div class="drugs_line_wrap clear"><span>'+q+"&nbsp;&nbsp;&nbsp;&nbsp;"+a.msg[g]+'</span><span class="testing_reason"></span></div>'}}if(Utils.isBlank(b)){$("#drugs_testing").attr("style","display:block");$("#drugs_testing").find(".popcontent").html(b)}}},saveCPMRecipesList:function(b){var a={url:ContextClinc_Server+"CPMPrescription/saveCPMRecipesList",dataType:"json",data:JSON.stringify(b),showMask:true,contentType:"application/json; charset=utf-8"};var c=Utils.myAjaxHandler(a);c.done(function(g){if(g.errorCode==SUCCESSCODE){if(g.data&&g.data.length>0){var e="";for(var d=0;g.data[d];d++){e+="处方"+g.data[d]+"，"}$.paWarn(e.substr(0,e.length-1)+"已发药或已收费,不允许修改！")}else{$.paSuccess("保存成功！");RMUilts.action(b,cpmp.renderResableMecdtion)}cpmp.drugIdArr=[];cpmp.deleteRecipeCnArr=[];var f=$(".recipe-label-item.checked").attr("data-index");cpmp.getCPMRecipes(empiId,acographyId,f);return}else{$.paError(g.errorCode+"：保存中成药处方失败！")}})},cleanDrugInput:function(a){a.find(".groupNum").val("");a.find(".thinkBoxInputArea").val("");a.find(".drugPackageSpec").text("");a.find(".drugPackageSpec").val("");a.find(".china-drugDose").val("");a.find(".china-drugUnitName").text("");a.find(".china-footnote").val("");a.find(".china-footnote").removeAttr("val");a.find(".frequencyName").val("");a.find(".frequencyName").removeAttr("val");a.find(".totalDay").val("");a.find(".totalQty").val("");a.find(".drug-total-unit").val("");a.find(".drug-total-unit").removeAttr("val");a.find(".drug-total-unit").WJZSDropdown({},{isNeedClear:false},function(b,c){})},revertAddStatus:function(a){a.find(".update-drug").remove();a.find(".add-drug").show();a.find(".delete-drug").remove();a.find(".thinkBoxInputArea").removeData("drug").removeAttr("disabled").focus();a.find(".groupNum").removeAttr("disabled")},deleteDrugIdArr:function(b,a){cpmp.drugIdArr.splice($.inArray(b+"|"+a,cpmp.drugIdArr),1)},setSelectValue:function(b,a){$(b).find("input").attr("val",a);$(b).find("input").val($(b).find(".drop-item[data-value='"+a+"']").text())},updateDrugToPrescription:function(h){var d=h.parents(".importInfo");if(!d.find(".china-footnote").val()){$.paAlert("请添加用法！");return}if(!d.find(".frequencyName").val()){$.paAlert("请添加频率！");return}if(!$.trim(d.find(".totalDay").val())){$.paAlert("请添加天数！");return}if(!$.trim(d.find(".totalQty").val())){$.paAlert("请添加总量！");return}var g=h.parents(".importInfo").ableToFinish();if(!g){return}var e=d.parents(".pill-wrap").attr("data-index");var l=h.parents(".importInfo").find(".thinkBoxInputArea").data("drug");var o=d.parents(".pill-middle-info").find(".pill-list-content");var b=o.find(".pill-list-item.checked");var k=true;if(b&&b.length==0){k=false;b=o.find(".drug-list-row.checked")}var j=d.find(".china-footnote").attr("val");var c=d.find(".china-footnote").val();if(c=="请选择"||!c){c="";b.find(".separator").hide()}else{b.find(".separator").show()}var a=d.find(".china-drugDose").val();var m=d.find(".drug-source").attr("val");b.find(".drugDose").text((a||0)+(l.DRUG_DOSE_UNIT_NAME||"")).attr("drugUnitName",l.DRUG_DOSE_UNIT_NAME).attr("drugDose",a);b.find(".totalQty").text((d.find(".totalQty").val()||0)+d.find(".drug-total-unit").val()).attr("totalQty",(d.find(".totalQty").val()||0)).attr("recipeUnit",d.find(".drug-total-unit").val()).attr("drugUnitId",d.find(".totalQty").attr("drugUnitId")).attr("unitPrice",isYbReg!=="1"&&cpmp.isYBFlag?l.CEILING_PRICE:l.NEW_RETAIL_PRICE).attr("unitPriceForCalc",d.find(".drug-total-unit").val()===l.DRUG_STORE_UNIT_NAME?isYbReg!=="1"&&cpmp.isYBFlag?l.CEILING_PRICE:l.NEW_RETAIL_PRICE:l.NEW_SCATTERED_PRICE);if(k){b.find(".drugUsageName").text(c).attr("drugUsageId",j).attr("title",c);var i=d.find(".frequencyName");var n=i.data("data");b.find(".frequencyName").text(n.DRUG_FREQUENCY_NAME).attr("frequencyId",i.attr("val")).attr("frequencyQty",n.DRUG_FREQUENCY_QTY).attr("frequencyRemark",n.REMARK).attr("title",n.REMARK);b.find(".totalDay").text(d.find(".totalDay").val()+"天").attr("totalDay",d.find(".totalDay").val()).attr("title",d.find(".totalDay").val()+"天");b.find(".drug-list-row").not(".drugListRowClone").attr("drugid",l.DRUG_ID);b.find(".drug-list-row").not(".drugListRowClone").data("footnote",j);b.find(".drug-list-row").not(".drugListRowClone").data("drugDose",a);b.find(".drug-list-row").not(".drugListRowClone").data("drugSource",m);if(m==1){if(b.find(".drug-list-row").not(".drugListRowClone").hasClass("forFree")){b.find(".drug-list-row").not(".drugListRowClone").removeClass("forFree")}b.find(".drug-list-row").not(".drugListRowClone").addClass("outsourcing")}else{if(m==2){if(b.find(".drug-list-row").not(".drugListRowClone").hasClass("outsourcing")){b.find(".drug-list-row").not(".drugListRowClone").removeClass("outsourcing")}b.find(".drug-list-row").not(".drugListRowClone").addClass("forFree")}else{b.find(".drug-list-row").not(".drugListRowClone").removeClass("outsourcing").removeClass("forFree")}}}else{var f=[];_.each(b.siblings().not(".drugListRowClone"),function(s){f.push($(s).attr("drugId"))});var p=cpmp.getMdcDictDrugWithId(f);var q=d.find(".frequencyName").data("data").DRUG_FREQUENCY_QTY;var r=d.find(".totalDay").val();_.each(b.siblings().not(".drugListRowClone"),function(u){var v=$(u);var t=cpmp.searchDrugFromDrugList(p,v.attr("drugId"));var s=cpmpUtils.caleAmount(t.DRUG_DOSAGE_TYPE,(v.find(".drugDose").attr("drugDose")||0),q,r,t.DRUG_CONVERT_RATE_DOSE,t.DRUG_CONVERT_RATE,t.DRUG_CONVERT_RATE_STORE_UNIT||1,v.find(".drug-total-unit").val()===t.DRUG_STORE_UNIT_NAME?0:1);v.find(".totalQty").text(s+v.find(".totalQty").attr("recipeUnit")).attr("totalQty",s)});b.parents(".pill-list-item").find(".drugUsageName").text(c).attr("drugUsageId",j).attr("title",c);var i=d.find(".frequencyName");var n=i.data("data");b.parents(".pill-list-item").find(".frequencyName").text(n.DRUG_FREQUENCY_NAME).attr("frequencyId",i.attr("val")).attr("frequencyQty",n.DRUG_FREQUENCY_QTY).attr("frequencyRemark",n.REMARK).attr("title",n.REMARK);b.parents(".pill-list-item").find(".totalDay").text(d.find(".totalDay").val()+"天").attr("totalDay",d.find(".totalDay").val());b.attr("drugid",l.DRUG_ID);b.data("footnote",j);b.data("drugDose",a);b.data("drugSource",m);if(m==1){if(b.hasClass("forFree")){b.removeClass("forFree")}b.addClass("outsourcing")}else{if(m==2){if(b.hasClass("outsourcing")){b.removeClass("outsourcing")}b.addClass("forFree")}else{b.removeClass("outsourcing").removeClass("forFree")}}}cpmpUtils.calcTotalPrice(o);cpmp.cleanDrugInput(d);cpmp.revertAddStatus(d)},drugWithdrawal:function(b){var a={url:ContextClinc_Server+"CPMPrescription/CPMDrugWithdrawal",dataType:"json",data:JSON.stringify(b),showMask:true,contentType:"application/json; charset=utf-8"};var c=Utils.myAjaxHandler(a);c.done(function(e){if(e.errorCode==SUCCESSCODE){$.paSuccess("保存成功！");var d=$(".recipe-label-item.checked").attr("data-index");cpmp.getCPMRecipes(empiId,acographyId,d);return}else{$.paError(e.errorCode+"：退药失败！")}})},saveCnMedical:function(){var d=cpmp.getWestDiagnosis();var a=$("#chineseTraDiagnosis").val();var c=$("#chineseTraDiagnosis").attr("val");var e={medicalId:$(".diagnosis:visible").attr("cn_medical_id"),acographyId:acographyId,empiId:empiId,chineseTraDiagnosis:a,chineseDiagnosisCode:c,dwsDiagnosisRecordList:d};var b={url:ContextClinc_Server+"TCMPrescription/saveCnMedical",dataType:"json",data:JSON.stringify(e),showMask:true,async:false,contentType:"application/json; charset=utf-8"};var f=Utils.myAjaxHandler(b);f.done(function(h){if(h.errorCode==SUCCESSCODE){$.paSuccess("保存成功！");var g=cpmp.empi;g.CHINESE_TRA_DIAGNOSIS=a;g.CHINESE_DIAGNOSIS_CODE=c;if(d&&d.length>0){if(null!=d[0].diagnosis){a+="；"+d[0].diagnosis;g.DiagnosisList=d[0].diagnosis}else{g.DiagnosisList=d[0].diagnosisIcd10;g.diagnosisCode=d[0].diagnosisIcd10Code;a+="；"+d[0].diagnosisIcd10}}else{g.DiagnosisList="";$("#westDiagnosis").removeAttr("val")}$(".diagnosis").text(a||"-").attr("title",a||"-");$("#addDiagnosisPop").addClass("dsn")}else{$.paError(h.errorCode+"：修改中医诊断失败！")}})},getWestDiagnosis:function(){var e=[];var b=$("#westDiagnosis").attr("val");var c=$("#westDiagnosis").val();if(c!=null&&c!=undefined&&c!=""){if(b!=null&&b!=undefined){var d={};d.diagnosisIcd10=$("#westDiagnosis").val();d.diagnosisIcd10Code=$("#westDiagnosis").attr("val");e.push(d)}else{var a={};a.diagnosis=c;e.push(a)}}return e},deleteCRecipesTab:function(b){var a=b.parent().attr("data-index");b.parent().remove();$(".left-prescription > .pill-wrap[data-index="+a+"]").remove();$(".recipe-label>ul>li:eq(1)").addClass("checked").siblings().removeClass("checked");$(".left-prescription > .pill-wrap:eq(1)").show().siblings(".pill-wrap").hide();cpmp.cleanDrugData(a)},cleanDrugData:function(b){var a=b.length;cpmp.drugIdArr=_.reject(cpmp.drugIdArr,function(c){return _.isEqual(c.substr(0,a),b)})},deleteRecipeCn:function(c){var a=this;var d={recipeId:c};var b={url:ContextClinc_Server+"dentistryRecipe/delDentistryRecipe",dataType:"json",showMask:true,data:d};var e=Utils.myAjaxHandler(b);e.done(function(f){if(f.errorCode=="E0000000"){if(f.data<1){$.paWarn("处方已经发药或者收费，不允许删除该处方！")}}else{$.paError("删除成处方失败！")}}).fail(function(f){$.paError("操作失败!")}).always(function(){})},initDrugTotalUnit:function(g,c,b){var a={idKey:"code",txtKey:"text",isNeedClear:false};var f=b.drugSplit===null||b.drugSplit==="0"||b.storeUnitId===b.dispenseUnitId;var e;f?e=[{code:"0",text:b.recipeUnit,drugUnitId:b.storeUnitId}]:e=[{code:"0",text:b.storeUnitName,drugUnitId:b.storeUnitId},{code:"1",text:b.dispenseUnitName,drugUnitId:b.dispenseUnitId}];g.WJZSDropdown(e,a,function(j,k){var m=g.parents(".importInfo");var h=m.find(".china-drugDose").val();var l=m.find(".frequencyName").data("data");var i=m.find(".totalDay").val();m.find(".totalQty").attr("drugUnitId",k.drugUnitId);if(c&&h&&h!=="必填项不能为空。"&&l&&i&&i!=="必填项不能为空。"){m.find(".totalQty").val(cpmpUtils.caleAmount(c.DRUG_DOSAGE_TYPE,h,l.DRUG_FREQUENCY_QTY,i,c.DRUG_CONVERT_RATE_DOSE,c.DRUG_CONVERT_RATE,c.DRUG_CONVERT_RATE_STORE_UNIT||1,m.find(".drug-total-unit").val()===c.DRUG_STORE_UNIT_NAME?0:1))}});var d;!f&&b.recipeUnit!==b.storeUnitName?d=e[1]:d=e[0];g.SetWJZSDropdownSelectedData(d.code);g.val(d.text).attr("val",d.code);g.parents(".importInfo").find(".totalQty").attr("drugUnitId",d.drugUnitId)},};function CPMPrescriptionHistory(){this.historyAcography=[]}CPMPrescriptionHistory.prototype={init:function(){cpmpHistory.initClick();cpmpHistory.initDateChoose()},initClick:function(){$(document).on("click",".historyDetail-head i:not(.quote)",function(){$(this).toggleClass("collapse");$(this).toggleClass("expand");var b=$(this).parents(".historyDetail-item");var a=b.find(".quote").attr("recipe-id");b.find(".historyDetail-content[recipe-id="+a+"]").slideToggle()});$(".historyRecipe").on("click",".quote",function(){var b=$(this).parents(".historyRecipe-project");var c=b.attr("acography-id");var a=$(this).attr("recipe-id");var e=_.find(cpmpHistory.historyAcography,function(f){return f.acographyId==c});if(e&&e.lstDwsRecipe){var d=_.find(e.lstDwsRecipe,function(f){return f.recipeId==a});cpmpTmpl.chinaTmplUse(d,2)}});$(".prev").on("click",function(){var a=$(".dateChooser input").attr("val");$(".dateChooser ul>li").each(function(b){if(a==$(this).attr("data-value")){if(b==0){$.paAlert("无更多历史处方")}else{var c=$(this).prev().attr("data-value");$(".dateChooser input").attr("val",c);$(".dateChooser input").val($(this).prev().text());cpmpHistory.getPrescriptionHistory($(this).prev().data("drop_data"))}}})});$(".next").on("click",function(){var a=$(".dateChooser input").attr("val");var b=$(".dateChooser ul>li").length-1;$(".dateChooser ul>li").each(function(c){if(a==$(this).attr("data-value")){if(c==b){$.paAlert("无更多历史处方")}else{var d=$(this).next().attr("data-value");$(".dateChooser input").attr("val",d);$(".dateChooser input").val($(this).next().text());cpmpHistory.getPrescriptionHistory($(this).next().data("drop_data"))}}})})},initDateChoose:function(){var a={contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"TCMPrescription/getHisAcographyDate?empiId="+empiId,dataType:"json",showMask:false};var b=Utils.myAjaxHandler(a);b.done(function(f){if(SUCCESSCODE==f.errorCode){if(f.data&&f.data.length>0){$(".noDataHint").attr("hasHistoryRecipe","1");var e={idKey:"ACOGRAPHYID",txtKey:"TXT",isNeedClear:false};var c=_.filter(f.data,function(g){return g.ACOGRAPHYID!=acographyId});$(".dateChoose").WJZSDropdown(c,e,function(g,h){cpmpHistory.getPrescriptionHistory(h)});$(".dateChoose").SelectWJZSDropdownFirstItem();var d=$(".dateChoose").attr("val");if(d){$(".dateChooser").find("ul>li[data-value="+d+"]").trigger("click");$(".dateChooser .wjzs-drop-menu").hide()}else{$(".historyRecipe").addClass("dsn");$(".noDataHint").removeClass("dsn").attr("hasHistoryRecipe","0")}}else{$(".historyRecipe").addClass("dsn");$(".noDataHint").removeClass("dsn").attr("hasHistoryRecipe","0")}}else{$.paError(f.errorMessage,null)}}).fail(function(c){$.paError("请求异常",null)})},getPrescriptionHistory:function(b){var a={contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"CPMPrescription/getHisAcography4CPMRecipeByDate?empiId="+b.EMPIID+"&acographyId="+b.ACOGRAPHYID+"&clinicId="+b.CLINICID,dataType:"json",showMask:false};var c=Utils.myAjaxHandler(a);c.done(function(d){if(SUCCESSCODE==d.errorCode){cpmpHistory.historyAcography=d.data;cpmpHistory.renderPrescriptionHistoryData(d.data)}else{$.paError(d.errorMessage,null)}}).fail(function(d){$.paError("请求异常",null)})},renderPrescriptionHistoryData:function(b){if(b&&b.length>0){var a=[];_.each(b,function(e,d){if(e.lstDwsRecipe&&e.lstDwsRecipe.length>0){_.each(e.lstDwsRecipe,function(g,f){if(g.recipeWestList&&g.recipeWestList.length>0){_.each(g.recipeWestList,function(i,h){if(a.indexOf(i.drugId)==-1){a.push(i.drugId)}})}})}});var c=cpmp.getMdcDictDrugWithId(a);_.each(b,function(h,e){var g=$(".recipe-history-clone").clone(true).removeClass("recipe-history-clone").show();g.attr("acography-id",h.acographyId);g.find(".history-content").attr("acography-id",h.acographyId);g.find(".treatmentType").text((h.treatmentType==2?"复诊":"初诊"));var f=h.empi;g.find(".doctorName").text(f.DOCTOR_NAME||"").attr("title","就诊医生："+(f.DOCTOR_NAME||""));var d=f.CHINESE_TRA_DIAGNOSIS;if(d){if(f.DiagnosisList){d+="；"+f.DiagnosisList}}else{d=f.DiagnosisList}g.find("#hisDiagnosis").text(d||"-");g.find(".historyRecipe-diagnose").attr("title","诊断："+(d||"-"));if(f.CLINIC_NAME){g.find(".historyStores").removeClass("dsn");g.find(".historyStores").text(f.CLINIC_NAME).attr("title","分店名称："+f.CLINIC_NAME);g.find(".quote").addClass("hideQuote").hide()}else{g.find(".historyStores").addClass("dsn")}if(h.lstDwsRecipe.length>0){_.each(h.lstDwsRecipe,function(p,q){var m=g.find(".historyDetail>ul>.history-clone").clone(true).removeClass("history-clone");m.find(".prescription-title").text("成药方 "+p.recipeName);m.find(".quote").attr("data-index",p.recipeName).attr("recipe-id",p.recipeId);m.show();if(q>0){m.find(".historyDetail-content").hide();m.find(".historyDetail-head .collapse").addClass("expand").removeClass("collapse")}m.find(".historyDetail-content").attr("recipe-id",p.recipeId);m.find(".print").attr("title","打印处方"+p.recipeName);m.find(".advice").text((p.advice||""));if(p.recipeWestList&&p.recipeWestList.length>0){var k={};var j=p.recipeWestList;_.each(j,function(r,s){if(k[r.groupNum]){k[r.groupNum].push(r)}else{k[r.groupNum]=[];k[r.groupNum].push(r)}});var l=Object.keys(k);for(var o in l){var n=k[l[o]];if(!n||n.length==0){continue}_.each(n,function(t,u){var r=m.find(".history-cell-clone").clone(true).removeClass("history-cell-clone").show();var s=cpmp.searchDrugFromDrugList(c,t.drugId);if(0==u){r.find(".groupNum").text("组 "+(t.groupNum||""))}r.find(".drugName").text(t.drugName).attr("title",t.drugName);r.find(".drugPackageSpec").text(t.drugSpec||"");r.find(".drugDose").text("单次用量："+(t.drugDose||"")+(t.drugUnitName||""));r.find(".drugUsage").text("用法："+t.drugUsageName||"");r.find(".frequency").text("频率："+t.frequencyName||"");m.find(".historyDetail-content>ul").append(r)})}var i=15;if(m.find(".right-drugShow li").length>(i+1)){m.find(".right-drugShow .loadMore-hint").show();m.find(".right-drugShow li").each(function(r){if(r>(i-2)){$(this).hide()}});m.find(".right-drugShow .loadMore-hint").on("click",function(){$(this).hide();m.find(".right-drugShow li").each(function(r){if(r>(i-2)){$(this).show()}})})}}g.find(".historyDetail>ul").append(m)})}else{g.find(".historyDetail>ul").append('<p class="unprescribedHint">本次诊断并无处方</p>')}$(".historyRecipe").find(".historyRecipe-project:not(.recipe-history-clone)").remove();$(".historyRecipe").append(g)})}},getDateListSync:function(){var a={contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"TCMPrescription/getHisAcographyDate?empiId="+empiId,dataType:"json",showMask:false,async:false};var c=Utils.myAjaxHandler(a);var b;c.done(function(d){b=d}).fail(function(d){$.paError("请求异常",null)});return b},renderPrescriptionHistory:function(d){if(SUCCESSCODE==d.errorCode){if(d.data&&d.data.length>0){$(".noDataHint").attr("hasHistoryRecipe","1");var c={idKey:"ACOGRAPHYID",txtKey:"TXT",isNeedClear:false};var a=_.filter(d.data,function(e){return e.ACOGRAPHYID!=acographyId});$(".dateChoose").WJZSDropdown(a,c,function(e,f){cpmpHistory.getPrescriptionHistory(f)});$(".dateChoose").SelectWJZSDropdownFirstItem();var b=$(".dateChoose").attr("val");if(b){$(".dateChooser").find("ul>li[data-value="+b+"]").trigger("click");$(".dateChooser .wjzs-drop-menu").hide()}else{$(".historyRecipe").addClass("dsn");$(".noDataHint").removeClass("dsn").attr("hasHistoryRecipe","0")}}else{$(".historyRecipe").addClass("dsn");$(".noDataHint").removeClass("dsn").attr("hasHistoryRecipe","0")}}else{$.paError(d.errorMessage,null)}}};function CPMPrescriptionTmpl(){this.templateLevel=[{id:"3",txt:"个人模板"},{id:"2",txt:"诊所模板"}]}CPMPrescriptionTmpl.prototype={init:function(){cpmpTmpl.initClickBtn()},initClickBtn:function(){$(document).on("click",".china-tmpl-dd",function(){if(!cpmp.isReadOnly){var a=$(this).attr("data-id");var b=_.find(cpmpTmpl.chinaTmplInfoMap.user,function(c){return c.recipetmplId==a});if($(this).attr("template-type")==2){b=_.find(cpmpTmpl.chinaTmplInfoMap.clinic,function(c){return c.recipetmplId==a})}cpmpTmpl.chinaTmplUse(b,1)}});$(".content-inner .popup-model dt").on("click",function(b){var a=$(this).parents("dl").find("dd").is(":visible");if(!a){$(this).parents("dl").siblings().find("dd").hide();$(this).parents("dl").find("dd").show()}else{$(this).parents("dl").find("dd").hide()}});$(".saveAs").off("click").on("click",function(){$(".popup-model").hide();var a={msg:'<div class="clear" style="margin-bottom: 12px; padding-left: 18px;"><div class="fl" style="color:#5c5c5c;line-height: 30px;">模板级别：</div><div class="template-level"><span class="radio checked" val="3" onclick="cpmpTmpl.checkRadio(this)">个人模板</span><span class="radio" val="2" onclick="cpmpTmpl.checkRadio(this)">诊所模板</span></div></div><i class="necessary">*</i>模板名称：<input type="text" class="input-text validate(notEmpty,required,maxlength(30))" maxlength="30" id="templateName">',cancelTxt:"取消",saveTxt:"确认",onYes:function(){var b=$.trim($("#templateName").val());$("#templateName").val($.trim($("#templateName").val()));if(!$("#cfm-msg").ableToFinish()){return}var d=$(".template-level").find(".checked").attr("val");if(!cpmpTmpl.checkCnRecipeTmplName(b,d)){$.paWarn("模板名称已经存在!");$("#templateName").addClass("tmpl_input_rename")}else{var c=$(".dose-usage-number").ableToFinish();var e=$("#cfm-msg").ableToFinish();if(!c||!e){return}$("#pa-confirm").remove();cpmpTmpl.saveCnRecipeTmpl(b,d)}}};cpmpTmpl.paConfirm(a);cpmpTmpl.initTemplateLevel()});$(document).on("click",".recipe-template-title-li",function(){$(this).toggleClass("collapse");var a=$(this).next();a.slideToggle()});$("#teml_btn_search").on("click",function(){var a=$(".templateName").val();cpmpTmpl.getChinaTmplMedicien(a)})},checkRadio:function(a){if(!$(a).hasClass("checked")){$(a).addClass("checked");$(a).siblings().removeClass("checked")}},chinaTmplInfoMap:{},getChinaTmplMedicien:function(a){var c={templateName:a};var b={url:ContextClinc_Server+"CPMPrescription/getCPMRecipeTmpl",dataType:"json",data:c,contentType:"application/x-www-form-urlencoded"};var d=Utils.myAjaxHandler(b);d.done(function(k){if(k.errorCode==SUCCESSCODE){if(k.data.length<1){return}var g=k.data;cpmpTmpl.chinaTmplInfoMap=g;$("#china-tmpl-doctor-ul li:not(.china-tmpl-dd-doctor-clone)").remove();$("#china-tmpl-clinic-ul li:not(.china-tmpl-dd-clinic-clone)").remove();$("#china-tmpl-platform-ul li:not(.china-tmpl-dd-platform-clone)").remove();var h=g.user;var j=g.clinic;for(var f=0;h[f];f++){var l=$('<li class="recipe-template-item china-tmpl-dd" title=""></li>');l.attr("id","");l.attr("data-id",h[f].recipetmplId);var e=h[f].templateName;l.text(e);l.attr("title",e);l.attr("template-type",3);$("#china-tmpl-doctor-ul").append(l)}for(var f=0;j[f];f++){var l=$('<li class="recipe-template-item china-tmpl-dd" title=""></li>');l.attr("id","");l.attr("data-id",j[f].recipetmplId);var e=j[f].templateName;l.text(e);l.attr("title",e);l.attr("template-type",2);$("#china-tmpl-clinic-ul").append(l);$("#china-tmpl-clinic-ul").parent().hide()}}else{$.paError(k.errorCode+"：查询到中成药处方模板失败！")}})},chinaTmplUse:function(f,e){var c=$(".recipe-label-item.checked").attr("data-index");var d=$(".left-prescription > .pill-wrap[data-index="+c+"]").find(".pill-list-item").length;if(d>1){if($(".recipe-label ul li").length>cpmp.cpmRecipesMaxNum){$.paWarn("最多只能添加六个处方");return}var c=parseInt($(".recipe-label").find("ul li:last").attr("data-index"))+1;cpmp.addPrescriptionTab(true,true,c);cpmp.addPrescriptionBody(true,c,cpmp.empi);var a=$(".left-prescription .pill-wrap:last");var b=$(".recipe-label .recipe-label-item:last").attr("data-index");$(".recipe-label .recipe-label-item:last").siblings(".recipe-label-item").removeClass("current");$(".left-prescription > .pill-wrap[data-index="+b+"]").show().siblings(".pill-wrap").hide();$(".recipe-label-item.checked").siblings().find(".delete").hide();cpmpTmpl.quoteRecipe(a,b,f,e)}else{var a=$(".left-prescription > .pill-wrap[data-index="+c+"]");cpmpTmpl.quoteRecipe(a,c,f,e)}},quoteRecipe:function(j,b,e,f){var q=(f==1)?e.recipeWestTmplList:e.recipeWestList;if(q&&q.length>0){var r=_.pluck(q,"drugId");var p=cpmp.getMdcDictDrugWithId(r);var i=[];if(q.length==p.length){i=q}else{_.each(q,function(s,t){_.each(p,function(v,u){if(s.drugId==v.DRUG_ID){i.push(s);return false}})})}if(p&&p.length>0){j.find(".china-advice").val((e.advice||""));if(f==2){var k=j.find(".thinkBoxInputArea")}else{}j.find(".china-totalPrice").val(e.totalprice);j.find(".china-totalPrice2").val(e.totalprice);var d={};_.each(i,function(s,t){if(d[s.groupNum]){d[s.groupNum].push(s)}else{d[s.groupNum]=[];d[s.groupNum].push(s)}});var o=Object.keys(d);for(var g in o){var q=d[o[g]];if(!q||q.length==0){continue}var a=j.find(".prescription-cell-clone").clone(true).removeClass("prescription-cell-clone").show();j.find(".pill-list-content .pill-list-item-ul").append(a);a.find(".list-number").text(o[g]+".");for(var l in q){var c=cpmp.addPrescriptionCell(a);j.find(".pill-listBox").show();j.find(".pill-list-content>.without-drugs").hide();j.find(".pill-list-hint>i").show();j.find(".pill-list-content").find(".pill-list-item-ul")[0].scrollIntoView(false);var m=cpmp.searchDrugFromDrugList(p,q[l].drugId);if(m){cpmp.addPrescriptionCellData(c,m,q[l].drugDose,q[l].footnote,q[l].footnoteName,q[l].drugSource,e.recipeName,q[l].totalQty,q[l].recipeUnit,q[l].drugUnitId);c.attr("recipecnid",q[l].recipeWestId);c.attr("recipeId",q[l].recipeId);c.attr("drugid",q[l].drugId)}}a.find(".drugUsageName").text(q[l].drugUsageName||"");a.find(".drugUsageName").attr("drugUsageId",q[l].drugUsageId||"").attr("title",q[l].drugUsageName||"");a.find(".frequencyName").text(q[l].frequencyName||"");a.find(".frequencyName").attr("frequencyId",q[l].frequencyId||"");var h=_.find(frequencyDataArray,function(s){if(s.DRUG_FREQUENCY_ID==q[l].frequencyId){return s}});if(h){a.find(".frequencyName").attr("frequencyQty",q[l].frequencyQty||0).attr("title",h.REMARK||"")}a.find(".totalDay").text((q[l].totalDay||"")+"天");a.find(".totalDay").attr("totalDay",q[l].totalDay||"").attr("title",(q[l].totalDay||"")+"天");if(q&&q.length>1){if(a.hasClass("drug-list-operational")){a.removeClass("drug-list-operational")}}else{if(q&&q.length==1){if(a.find(".drug-list-row").hasClass("drug-list-operational")){a.find(".drug-list-row").removeClass("drug-list-operational")}if(a.find(".pill-list-leftInfo-right").hasClass("list-special-line")){a.find(".pill-list-leftInfo-right").removeClass("list-special-line")}}}}var n=j.find(".pill-list-content");cpmpUtils.calcTotalPrice(n)}else{$.paWarn("查询不到模板对应药品的相关数据,请手动填写处方");return}}else{$.paWarn("无模板数据,请手动填写处方");return}},checkCnRecipeTmplName:function(e,b){var c={};var a={url:ContextClinc_Server+"CPMPrescription/checkCPMTmplName",dataType:"json",data:{tmplName:e!=null?e:"",tmplId:null,templateType:b},async:false};var d=Utils.myAjaxHandler(a);d.done(function(f){if(f!=null&&f.errorCode==SUCCESSCODE){c=f.data}else{if(f!=null&&f.errorCode=="E1SP0002"){}else{$.paError(f.errorMessage)}}}).fail(function(f){$.paError("操作失败!")}).always(function(){});return c},paConfirm:function(d){$("body").append('<div id="pa-confirm" class="reveal-modal msg" style="height: 140px;"><span id="icon_close" class="icon_close"></span><div id="cfm-msg" class="show-msg"></div><div class="btn-bar"><span class="bn-size btn-default" id="pa-cancel"></span><span class="bn-size btn-success" id="pa-save"></span></div></div>');var e={msg:"是否确认执行该操作？",cancelTxt:"取消",saveTxt:"保存",onYes:function(){alert("无法获取确认操作的回调函数")},onNo:function(){$("#pa-confirm").remove()}};var c=$.extend({},e,d);var a="<input id='cfm-input' type='text' class='input-text'/>";var b=c.msg==="input"?"<span class='ipt-label'>"+c.label+"</span>"+a:c.msg;$("#cfm-msg").html(b);$("#cfm-msg").ketchup();$("#pa-cancel").text(c.cancelTxt);$("#pa-save").text(c.saveTxt);$("#pa-confirm").show();$("div.btn-bar span#pa-save").off("click").on("click",function(){c.onYes()});$("div.btn-bar span#pa-cancel,#icon_close").off("click").on("click",c.onNo);if(c.hideCancel){$("#pa-cancel").remove()}if(c.hideSave){$("#pa-save").remove()}},saveCnRecipeTmpl:function(p,h){var i=$(".recipe-label-item.checked").attr("data-index");var f=$(".pill-wrap[data-index="+i+"]");var n={templateName:p,recipetmplId:null,recipeType:3,templateType:h,recipeName:i,advice:f.find(".china-advice").val(),totalPrice:f.find(".china-totalPrice2").val(),};var l=f.find(".pill-list-content .drug-list-row").not(".drugListRowClone");var o=l.length;var m=$(l[1]).find(".drugName").text();if(o==0){if(m==null||m==""||m==undefined){$.paWarn("处方"+i+"无中成药信息，请添加！")}return}var k=[];var g=1;for(var c=0;c<o;c++){var e=$(l[c]).data("drug");if(e.DRUG_NAME){var a=$(l[c]).parents(".pill-list-item");var d={};var b=a.find(".list-number").text();if(b&&b.indexOf(".")!=-1){d.groupNum=b.substr(0,b.indexOf("."))}else{d.groupNum=""}d.orderNum=g++;d.drugId=e.DRUG_ID;d.drugName=e.DRUG_NAME;d.drugSource=e.drugSource;d.drugSpec=e.DRUG_PACKAGE_SPEC;d.drugUsageId=a.find(".drugUsageName").attr("drugUsageId");d.drugUsageName=a.find(".drugUsageName").text();d.drugDose=$(l[c]).data("drugDose");d.drugUnitName=e.DRUG_DOSE_UNIT_NAME;d.frequencyId=a.find(".frequencyName").attr("frequencyId");d.frequencyName=a.find(".frequencyName").text();d.frequencyQty=a.find(".frequencyName").attr("frequencyQty");d.totalDay=a.find(".totalDay").attr("totalDay");d.totalQty=$(l[c]).data("totalQty");d.unitPrice=$(l[c]).find(".totalQty").attr("unitPrice");d.drugSource=$(l[c]).data("drugSource");d.recipeUnit=$(l[c]).find(".totalQty").attr("recipeUnit");d.drugUnitId=$(l[c]).find(".totalQty").attr("drugUnitId");d.recipeWestId=$(l[c]).attr("recipecnid");d.delFlag=0;k.push(d)}}n.recipeWestTmplList=k;cpmpTmpl.editCnRecipeTmpl(n);cpmpTmpl.chinaTmplInfo=null},editCnRecipeTmpl:function(a){var b={url:ContextClinc_Server+"CPMPrescription/addCPMRecipeImpl",dataType:"json",data:JSON.stringify(a),showMask:true,contentType:"application/json; charset=utf-8"};var c=Utils.myAjaxHandler(b);c.done(function(d){if(d.errorCode==SUCCESSCODE){$.paSuccess("保存成功！");cpmpTmpl.getChinaTmplMedicien()}else{$.paError("保存失败！")}}).fail(function(d){$.paError("操作失败！")}).always(function(){})},initTemplateLevel:function(){var a={isNeedClear:false};$(".template-type").WJZSDropdown(this.templateLevel,a,function(b,c){});$(".template-type").SelectWJZSDropdownFirstItem()},};function CPMPrescriptionUtils(){}CPMPrescriptionUtils.prototype={calcTotalPrice:function(e,a){var c=0;var d=e.find(".pill-list-item:not(.prescription-cell-clone)");var b=false;d.each(function(){$(this).find(".drug-list-row").not(".drugListRowClone").each(function(){var i=$(this).data("drugSource");if(i==0||!i){var g=$(this).data("drug");var k=g.DRUG_CONVERT_RATE_DOSE;var l=g.DRUG_CONVERT_RATE_STORE_UNIT;var j=g.DRUG_STORE_UNIT_QTY;var f=$(this).find(".totalQty").attr("unitPriceForCalc");var h=$(this).find(".totalQty").attr("totalQty");if(h&&h!="必填项不能为空。"){if(!k||k==""){k=1}if(!l||l==""){l=1}if(j&&!isNaN(j)&&h&&!isNaN(h)){if(stock.isStockCheck&&cpmpUtils.isLowStock(h,1,k,l,j)){$(this).addClass("underStock");b=true}else{$(this).removeClass("underStock")}}else{if(stock.isStockCheck){$(this).addClass("underStock");b=true}else{$(this).removeClass("underStock")}}if(f){c+=f*h}}}else{$(this).removeClass("underStock")}})});if(b){e.parents(".pill-middle-info").find(".understock-tag").show()}else{e.parents(".pill-middle-info").find(".understock-tag").hide()}if(!a){e.parents(".pill-wrap").find(".china-totalPrice").text(this.toDecimal2(c));e.parents(".pill-wrap").find(".china-totalPrice2").val(this.toDecimal2(c))}},toDecimal2:function(a){var d=parseFloat(a);if(isNaN(d)||d<0){return"0.00"}var d=Math.round(a*100)/100;var c=d.toString();var b=c.indexOf(".");if(b<0){b=c.length;c+="."}while(c.length<=b+2){c+="0"}return c},caleAmount:function(j,f,c,b,a,k,d,e){if(isNaN(f)||isNaN(c)||isNaN(b)||isNaN(a)||isNaN(k)||isNaN(d)||isNaN(e)){return""}var i=k;if(e==0){i=d}if(f&&c&&b&&a&&k){if(j==1){var h=Math.ceil(Utils.accMul(f,this.accDiv(a,k)));var l=Utils.accMul(h,c);if(e==0){return Math.ceil(this.accDiv(Utils.accMul(l,b),this.accDiv(d,k)))}else{return Utils.accMul(l,b)}}else{var g=Utils.accMul(Utils.accMul(Utils.accMul(f,c),b),a);if(e==0){return Math.ceil(this.accDiv(g,d))}else{return Math.ceil(this.accDiv(g,k))}}}else{return""}},accDiv:function(arg1,arg2){var t1=0,t2=0,r1,r2;try{t1=arg1.toString().split(".")[1].length}catch(e){}try{t2=arg2.toString().split(".")[1].length}catch(e){}with(Math){r1=Number(arg1.toString().replace(".",""));r2=Number(arg2.toString().replace(".",""));return(r1/r2)*pow(10,t2-t1)}},isLowStock:function(b,a,f,e,d){var c=false;if(b*a>d){c=true}return c},};