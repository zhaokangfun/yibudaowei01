var gender={"1":"男","2":"女","3":"保密"};var drugSourceData=[{id:0,name:""},{id:1,name:"【外购】"},{id:2,name:"【免费】"}];var userInfo_aclc=config_cache.getCache("medical_user_data");var item3013=_.find(userInfo_aclc.clinicParams,function(a){return a.parameterCode=="3013"});var isHidePrice=item3013&&item3013.parameterValue;function CPMPrescriptionPrint(){}CPMPrescriptionPrint.prototype={doPrintFacade:function(e,d,b){var a=this;var c=a.getPrintData(e,d,b);wjPrintUtils.getPrintSetting(wjPrintUtils.printFunction.rescript,function(h,g){if(h==1){a.doPrint(c,d,e,g)}else{if(h==2){var f=a.customPrint(c,d,e);wjPrintUtils.print(g,f,function(i){if(i.code!=SUCCESSCODE){$.paWarn(i.message)}})}else{$.paWarn("请先配置打印参数！")}}})},doPrint:function(z,u,b,a){var m=this;LODOP=getLodop();if(!LODOP){return}var i=_.isNumber(a.rightOffset)?a.rightOffset:0;var h=_.isNumber(a.bottomOffset)?a.bottomOffset:0;LODOP.PRINT_INITA(h,i,530+i,763+h,"");LODOP.SET_PRINT_PAGESIZE(1,1480,2100,"");var e=z.recipe;m.createHead(z.empi);m.createFooter(e,z.empi);var w=new Array();for(var r=0;r<e.recipeWestList.length;r++){w.push(e.recipeWestList[r])}var t=252;var v;var g=new Array();var d=true;for(var q=0;q<e.recipeWestList.length;q++){var o=false;var f=0;v=new Array();if(g.length>0){for(var n=0;n<g.length;n++){if(g[n]==e.recipeWestList[q].groupNum){o=true}}}if(o){continue}for(var r=0;r<w.length;r++){if(e.recipeWestList[q].groupNum==w[r].groupNum){v.push(w[r]);g.push(e.recipeWestList[q].groupNum);f++}}if(v.length>1){var c=t;for(var l=0;l<v.length;l++){if(t>544){if(d){LODOP.ADD_PRINT_LINE(t-15,462,c,462,0,1)}t=252;LODOP.NEWPAGEA();c=252;m.createHead(z.empi);m.createFooter(e,z.empi)}LODOP.ADD_PRINT_TEXT(t,10,170,20,(l==0?v[l].groupNum+"、":"    ")+this.convertId2Name(v[l].drugSource)+v[l].drugName);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.ADD_PRINT_TEXT(t,180,127,20,v[l].drugSpec);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.ADD_PRINT_TEXT(t,308,95,20,v[l].drugDose+" "+v[l].drugUnitName);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.ADD_PRINT_TEXT(t,398,72,20,+v[l].totalQty+v[l].recipeUnit);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");t+=30;d=true}LODOP.ADD_PRINT_TEXT(t,398,45,20,v[0].totalDay+"天");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_LINE(t-19,465,c-2,465,0,1);LODOP.ADD_PRINT_TEXT(t,180,180,20,"用法："+v[0].drugUsageName);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Bold",1);d=false}else{if(t>544){t=252;LODOP.NEWPAGEA();m.createHead(z.empi);m.createFooter(e,z.empi)}LODOP.ADD_PRINT_TEXT(t,10,170,20,v[0].groupNum+"、"+this.createDrugSource(v[0].drugSource)+v[0].drugName);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.ADD_PRINT_TEXT(t,180,145,20,v[0].drugSpec);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.ADD_PRINT_TEXT(t,308,95,20,v[0].drugDose+" "+v[0].drugUnitName);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.ADD_PRINT_TEXT(t,398,100,20,+v[0].totalQty+v[0].recipeUnit);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");t+=30;LODOP.ADD_PRINT_TEXT(t,180,185,20,"用法："+v[0].drugUsageName);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_TEXT(t,398,45,20,v[0].totalDay+"天");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Bold",1)}LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.ADD_PRINT_TEXT(t,335,55,20,v[0].frequencyRemark||v[0].frequencyName);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Bold",1);t+=30}LODOP.ADD_PRINT_TEXT(t,215,100,20,"(以下空白)");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Italic",1);LODOP.ADD_PRINT_TEXT(685,317,210,25,"药品总金额（元）:");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.SET_PRINT_STYLEA(0,"ItemType",4);LODOP.ADD_PRINT_TEXT(654,421,99,25);LODOP.ADD_PRINT_TEXT(684,421,99,25,(isHidePrice==1?"-":m.toDecimal2(e.totalPrice)));LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Alignment",2);LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.SET_PRINT_STYLEA(0,"ItemType",4);LODOP.ADD_PRINT_LINE(695,420,695,516,0,1);operateType()},getPrintData:function(f,d,b){var c={};var a={url:ContextClinc_Server+"CPMPrescription/getRecipeCn4Print",dataType:"json",data:{empiId:f,acographyId:d,recipeId:b},async:false,showMask:true,};var e=Utils.myAjaxHandler(a);e.done(function(g){if(g.errorCode==SUCCESSCODE){c=g.data}}).fail(function(g){$.paError("操作失败!")}).always(function(){});return c},customPrint:function(data,acographyId,empiId){var self=this;var recipeData=data.recipe;var recipeWestList=new Array();for(var j=0;j<recipeData.recipeWestList.length;j++){recipeWestList.push(recipeData.recipeWestList[j])}var printData={};printData.data={};printData.data.info={};printData.data.info.clinicName=userInfo_aclc.clinicName;printData.data.info.patientName=data.empi.PATIENT_NAME;printData.data.info.gender=eval("gender["+data.empi.PATIENT_GENDER+"]");printData.data.info.age=Utils.getPersonAccurateAge(data.empi.PATIENT_BIRTH_DATE);printData.data.info.departmentName=data.empi.DEPARTMENT_NAME||"-";printData.data.info.fadeName=data.empi.MI_TYPE_NAME||"自费";if(recipeData){printData.data.info.doctorName=recipeData.employeeName||recipeData.doctorName}else{printData.data.info.doctorName=userInfo_aclc.userName}var patient_no=data.empi.PATIENT_NO;if(null==patient_no||"null"==patient_no||""==patient_no){patient_no=""}else{patient_no=patient_no.substr(0,18)}printData.data.info.patientNo=patient_no;printData.data.info.medicareCardNo=data.empi.INSURANCE_NO||"-";var living_address_countryside=data.empi.LIVING_ADDRESS_COUNTRYSIDE;if(null==living_address_countryside||"null"==living_address_countryside||""==living_address_countryside){living_address_countryside="-"}var addressPhone="";if(null==data.empi.MOBILE_PHONE_NUMBER||"null"==data.empi.MOBILE_PHONE_NUMBER||""==data.empi.MOBILE_PHONE_NUMBER){addressPhone=living_address_countryside+"/-"}else{addressPhone=living_address_countryside+"/"+data.empi.MOBILE_PHONE_NUMBER}if(null!=data.empi.MOBILE_PHONE_NUMBER&&self.getStrLength(addressPhone)>102){var mobileLength=self.getStrLength("/"+data.empi.MOBILE_PHONE_NUMBER);addressPhone=self.cutStr(living_address_countryside,102-mobileLength)+"/"+data.empi.MOBILE_PHONE_NUMBER}printData.data.info.addressPhone=addressPhone;printData.data.info.modifyDate=Utils.timeStampToDateStr(data.empi.MODIFY_DATE,4);var diagnosis=data.empi.CHINESE_TRA_DIAGNOSIS;if(diagnosis){if(data.empi.DiagnosisList){diagnosis+="；"+data.empi.DiagnosisList}}else{diagnosis=data.empi.DiagnosisList}printData.data.info.diagnosis=diagnosis||"-";printData.data.info.acographySerialNo=data.empi.ACOGRAPHY_SERIAL_NO;printData.data.info.reviewe="";printData.data.info.allocate="";printData.data.info.check="";printData.data.info.dispensing="";printData.data.info.recipeName="成药方"+recipeData.recipeName;printData.data.info.advice=Utils.notBlank(recipeData.advice)?""+recipeData.advice:""||"无";printData.data.info.totalPrice=self.toDecimal2(recipeData.totalPrice);var tempList;var groupNumList=new Array();printData.data.recipe=new Array();for(var k=0;k<recipeData.recipeWestList.length;k++){var continueFlag=false;var count=0;tempList=new Array();if(groupNumList.length>0){for(var p=0;p<groupNumList.length;p++){if(groupNumList[p]==recipeData.recipeWestList[k].groupNum){continueFlag=true}}}if(continueFlag){continue}for(var j=0;j<recipeWestList.length;j++){if(recipeData.recipeWestList[k].groupNum==recipeWestList[j].groupNum){tempList.push(recipeWestList[j]);groupNumList.push(recipeData.recipeWestList[k].groupNum);count++}}if(tempList.length>1){for(var s=0;s<tempList.length;s++){var recipe={};recipe.groupNum=tempList[s].groupNum;recipe.drugName=this.convertId2Name(tempList[s].drugSource)+tempList[s].drugName;recipe.drugSpec=tempList[s].drugSpec;recipe.drugDose=tempList[s].drugDose+" "+tempList[s].drugUnitName;recipe.totalQty=tempList[s].totalQty+tempList[s].recipeUnit;recipe.drugSource="";recipe.totalDay="";recipe.drugUsageName="";recipe.frequencyName="";recipe.totalDay="";printData.data.recipe.push(recipe)}var recipe2={};recipe2.groupNum=tempList[0].groupNum;recipe2.drugName="";recipe2.drugSpec="";recipe2.drugDose="";recipe2.totalQty="";recipe2.drugSource="";recipe2.totalDay=tempList[0].totalDay+"天";recipe2.drugUsageName="用法："+tempList[0].drugUsageName;recipe2.frequencyName=tempList[0].frequencyRemark||tempList[0].frequencyName;printData.data.recipe.push(recipe2)}else{var recipe3={};recipe3.groupNum=tempList[0].groupNum;recipe3.drugName=this.createDrugSource(tempList[0].drugSource)+tempList[0].drugName;recipe3.drugSpec=tempList[0].drugSpec;recipe3.drugDose=tempList[0].drugDose+" "+tempList[0].drugUnitName;recipe3.totalQty=tempList[0].totalQty+tempList[0].recipeUnit;recipe3.drugSource="";recipe3.drugUsageName="用法："+tempList[0].drugUsageName;recipe3.frequencyName=tempList[0].frequencyRemark||tempList[0].frequencyName;recipe3.totalDay=tempList[0].totalDay+"天";printData.data.recipe.push(recipe3)}}return printData},createDrugSource:function(a){var b="";if(a==1){b="【外购】"}else{if(a==2){b="【免费】"}}return b},createHead:function(data){var self=this;LODOP.ADD_PRINT_TEXT(7,5,32,25,"NO.");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_TEXT(79,110,127,20,data.IS_YB_REG==1?(data.INSURANCE_NO||"-"):"-");LODOP.ADD_PRINT_TEXT(7,38,120,25,data.ACOGRAPHY_SERIAL_NO);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_RECT(3,450,43,18,0,1);LODOP.ADD_PRINT_TEXT(8,455,35,25,"普通");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Alignment",2);LODOP.ADD_PRINT_TEXT(7,491,35,25,"#/&");LODOP.SET_PRINT_STYLEA(0,"ItemType",2);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Alignment",2);LODOP.SET_PRINT_STYLEA(0,"ItemType",2);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Alignment",2);LODOP.ADD_PRINT_TEXT(105,7,45,25,"姓名 :");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_TEXT(105,159,40,25,"性别 :");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Alignment",2);LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_TEXT(105,229,41,25,"年龄 :");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Alignment",2);LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_TEXT(105,332,40,25,"科室 :");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Alignment",2);LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_TEXT(105,442,40,25,"费别 :");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Alignment",2);LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_TEXT(135,8,55,25,"病历号 :");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_TEXT(135,160,71,25,"住址/电话 :");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Alignment",2);LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_TEXT(170,8,100,25,"临床诊断及证型 :");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_TEXT(170,384,65,25,"开具日期 :");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Alignment",2);LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_TEXT(105,50,108,25,data.PATIENT_NAME);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.ADD_PRINT_TEXT(105,194,34,25,eval("gender["+data.PATIENT_GENDER+"]"));LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Alignment",2);LODOP.ADD_PRINT_TEXT(105,270,70,25,Utils.getPersonAccurateAge(data.PATIENT_BIRTH_DATE));LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.ADD_PRINT_TEXT(105,370,81,25,data.DEPARTMENT_NAME||"-");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.ADD_PRINT_TEXT(105,479,59,25,data.MI_TYPE_NAME||"自费");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");var patient_no=data.PATIENT_NO;if(null==patient_no||"null"==patient_no||""==patient_no){patient_no=""}else{patient_no=patient_no.substr(0,18)}LODOP.ADD_PRINT_TEXT(135,55,119,25,patient_no);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");var living_address_countryside=data.LIVING_ADDRESS_COUNTRYSIDE;if(null==living_address_countryside||"null"==living_address_countryside||""==living_address_countryside){living_address_countryside="-"}var addressPhone=living_address_countryside+"/"+data.MOBILE_PHONE_NUMBER;if(null!=data.MOBILE_PHONE_NUMBER&&self.getStrLength(addressPhone)>102){var mobileLength=self.getStrLength("/"+data.MOBILE_PHONE_NUMBER);addressPhone=self.cutStr(living_address_countryside,102-mobileLength)+"/"+data.MOBILE_PHONE_NUMBER}if(data.MOBILE_PHONE_NUMBER==null){addressPhone=living_address_countryside+"/-"}LODOP.ADD_PRINT_TEXT(135,231,310,25,addressPhone);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");var diagnosis=data.CHINESE_TRA_DIAGNOSIS;if(diagnosis){if(data.DiagnosisList){diagnosis+="；"+data.DiagnosisList}}else{diagnosis=data.CHINESE_TRA_DIAGNOSIS}LODOP.ADD_PRINT_TEXT(170,107,281,25,diagnosis||"-");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.ADD_PRINT_TEXT(170,449,95,25,Utils.timeStampToDateStr(data.MODIFY_DATE,7));LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.ADD_PRINT_LINE(94,4,94,530,0,1);LODOP.ADD_PRINT_LINE(198,4,198,530,0,1)},createFooter:function(b,c){var a=this;var d="注：1、本处方当日有效\n       2、取药时请当面核对药品名称、规格、数量\n       3、延长处方用量时间原因： 慢性病、老年病、外地、其他";LODOP.ADD_PRINT_TEXT(212,10,100,35,"RP:");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"FontSize",18);LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_TEXT(79,7,111,20,"医疗证/医保卡号：");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.ADD_PRINT_TEXT(30,450,52,20,"成药方"+b.recipeName);LODOP.ADD_PRINT_TEXT(596,10,510,45,"医嘱："+(Utils.notBlank(b.advice)?""+b.advice:""||"无"));LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_LINE(645,0,645,530,0,1);LODOP.ADD_PRINT_TEXT(28,10,510,25,userInfo_aclc.clinicName);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"FontSize",13);LODOP.SET_PRINT_STYLEA(0,"Alignment",2);LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_TEXT(53,10,510,25,"成药 处方笺");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"FontSize",13);LODOP.SET_PRINT_STYLEA(0,"Alignment",2);LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_LINE(645,0,645,530,0,1);LODOP.ADD_PRINT_TEXT(655,10,40,25,"审核 :");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_LINE(665,46,665,150,0,1);LODOP.ADD_PRINT_TEXT(655,180,40,25,"调配 :");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_LINE(665,216,665,310,0,1);LODOP.ADD_PRINT_TEXT(655,384,40,25,"医师 :");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.SET_PRINT_STYLEA(0,"ItemType",4);LODOP.ADD_PRINT_TEXT(710,11,344,55,d);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"FontSize",8);LODOP.ADD_PRINT_TEXT(654,421,99,25,c.DOCTOR_NAME);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Alignment",2);LODOP.ADD_PRINT_LINE(665,420,665,516,0,1);LODOP.ADD_PRINT_TEXT(685,10,40,25,"核对 :");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_LINE(695,46,695,150,0,1);LODOP.ADD_PRINT_TEXT(685,180,40,25,"发药 :");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_LINE(695,216,695,310,0,1)},getStrLength:function(b){var a=b.match(/[^\x00-\xff]/ig);return b.length+(a==null?0:a.length)},cutStr:function(d,a){if(!d){return""}if(a<=0){return""}var c=0;for(var b=0;b<d.length;b++){if(d.charCodeAt(b)>255){c+=2}else{c++}if(c==a){return d.substring(0,b-2)}else{if(c>a){return d.substring(0,b-2)}}}return d},convertId2Name:function(b){for(var a=0;a<drugSourceData.length;a++){if(drugSourceData[a].id==b){return drugSourceData[a].name}}return""},toDecimal2:function(a){var d=parseFloat(a);if(isNaN(d)||d<0){return"0.00"}var d=Math.round(a*100)/100;var c=d.toString();var b=c.indexOf(".");if(b<0){b=c.length;c+="."}while(c.length<=b+2){c+="0"}return c},};