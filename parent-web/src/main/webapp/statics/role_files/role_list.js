var pageInfo={currentPage:1,pageSize:20,totalPage:0};var clinicRole_api={clinic_role_add:ContextClinc_Server+"role/add",clinic_role_update:ContextClinc_Server+"role/edit",clinic_role_list:ContextClinc_Server+"role/roleList",clinic_role_del:ContextClinc_Server+"role/del",clinic_listClinicModules:ContextClinc_Server+"role/listClinicModules",clinic_listClinicPerms:ContextClinc_Server+"role/listClinicPerms",clinic_listRolePerms:ContextClinc_Server+"role/listRolePerms",clinic_role_bindUser:ContextClinc_Server+"role/bindUser",clinic_role_listUser:ContextClinc_Server+"role/listUser",clinic_listClinicResPerms:ContextClinc_Server+"role/getClinicResPerms"};var dataSource=[];var clinicModules={};var clinicPerms={};var rolePerms={};var currentRole={id:"",name:""};var roleType={"1001":"产品包管理角色","1002":"系统预设角色","2001":"自定义角色"};var initPaginationHandler=false;Date.prototype.format=function(b){var c={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};if(/(y+)/.test(b)){b=b.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var a in c){if(new RegExp("("+a+")").test(b)){b=b.replace(RegExp.$1,RegExp.$1.length===1?c[a]:("00"+c[a]).substr((""+c[a]).length))}}return b};var clinicRole_js=Class.create({initPage:function(){clinicRole_js.initStaticDom();clinicRole_js.loadRoleData();$("#addBtn").bind("click",this.addBtnClick);$("body").on("click","#cancelBtn",function(){$("#roleId").removeClass("wjzs-disabled notAllowed");clinicRole_js.renderCheckBoxs();$("#roleId").removeAttr("readonly","readonly");$("#list_div").show();$("#add_edit_div").hide();clinicRole_js.cleanRolePermission()});$("#searchBtn").bind("click",this.searchBtnClick)},initStaticDom:function(){var b=$("#status");var a={isNeedAll:false,isNeedClear:false};var c=[{id:" ",txt:"不限"},{id:"0",txt:"未使用"},{id:"1",txt:"使用中"}];b.WJZSDropdown(c,a,function(d,e){});b.val("不限").attr("val"," ")},loadRoleData:function(){var a={currentPage:pageInfo.currentPage,pageSize:pageInfo.pageSize,status:$("#status").attr("val"),name:$("#name").val()};a.ajaxopts={method:"POST",url:clinicRole_api.clinic_role_list,async:false,dataType:"json",showMask:true};a.callback=function(b){if(b!=null&&b.errorCode==SUCCESSCODE){dataSource=b.data.dataSource;clinicRole_js.refreshTable()}else{$.paError(b.errorMessage)}};$("#my-page").generatePagination(a)},refreshTable:function(){var a=$("#tablelist");a.html("");var e=$("<tr><th>序号</th><th>角色名称</th><th>状态</th><th>创建时间</th><th>管理</th></tr>");e.appendTo(a);var b=0;for(var c=0;c<dataSource.length;c++){var d=dataSource[c];if(d.typeCode=="1001"){continue}b++;var f;if(b%2==0){f=$("<tr id='"+d.id+"'></tr>")}else{f=$("<tr id='"+d.id+"'></tr>")}if(d.status=="0"){d.status="未使用"}else{d.status="使用中"}f.appendTo(a);f.append("<td style='text-align:left;'>"+b+"</td><td style='text-align:left;'>"+(d.name==null?"":(d.typeCode=="1002"?d.name:d.name))+"</td><td>"+d.status+"</td><td style='text-align:left;'>"+new Date(d.addDate).format("yyyy-MM-dd hh:mm:ss")+"</td>");if(d.typeCode=="1002"){f.append('<td><a href="javascript:void(0);" onclick="clinicRole_js.editData(\''+d.id+"','"+d.name+"','"+d.typeCode+"')\" >查看</a></td>")}else{if(d.status=="未使用"&&d.typeCode=="2001"){f.append('<td><a href="javascript:void(0);" onclick="clinicRole_js.editData(\''+d.id+"','"+d.name+"','"+d.typeCode+'\')" >编辑</a><a href="javascript:void(0);" onclick="clinicRole_js.deleteData(\''+d.id+"')\" >删除</a></td>")}else{if(d.status=="使用中"){f.append('<td><a href="javascript:void(0);" onclick="clinicRole_js.editData(\''+d.id+"','"+d.name+"','"+d.typeCode+"')\" >编辑</a></td>")}}}}},addBtnClick:function(){$("#add_edit_div").animate({scrollTop:0},500);$("#add_edit_div").removeErrorMsg();$("#editName").text("新增角色");$("#roleId").val("");$("#roleId").removeAttr("rolename");currentRole.id="";currentRole.name="";clinicRole_js.cleanRolePermission();$("#roleId").removeClass("wjzs-disabled notAllowed");$("#roleId").removeAttr("readonly","readonly");clinicRole_js.loadClinicModules();$("#list_div").hide();$("#add_edit_div").show()},editData:function(c,a,b){if(b=="1002"){$("#roleId").attr("readonly","readonly");$("#roleId").addClass("wjzs-disabled notAllowed");clinicRole_js.checkboxesLiUnBind()}$("#add_edit_div").removeErrorMsg();$("#add_edit_div").animate({scrollTop:0},500);$("#editName").text("编辑角色");currentRole.id=c;currentRole.name=a;$("#roleId").val(a);$("#roleId").attr("rolename",a);clinicRole_js.loadClinicModules(c);$("#list_div").hide();$("#add_edit_div").show()},permsMenuShow:function(){$(".level3-checkboxes").addClass("dsn");$(".level2-checkboxes .icon-more").removeClass("contract").addClass("expand")},searchBtnClick:function(){pageInfo=defaultPageinfo;$("#my-page").html("");pageInfo.currentPage=1;clinicRole_js.paginationHandler({currentPage:pageInfo.currentPage,isCallback:true})},findItemData:function(d){var a;for(var b=0;b<dataSource.length;b++){var c=dataSource[b];if(c.id==d){a=c;break}}return a},loadClinicModules:function(b){var a={method:"GET",url:clinicRole_api.clinic_listClinicResPerms,data:{roleId:b},dataType:"json"};var c=Utils.myAjaxHandler(a);c.done(function(d){if(d!=null&&d.errorCode==SUCCESSCODE){data=d.data;clinicRole_js.refreshMenutree(data)}else{$.paError(d.errorMessage)}}).fail(function(d){$.paError("请求异常")}).always(function(){})},loadRolePerms:function(b,e){if(b==undefined||b==""){return}var c=clinicRole_js.findItemData(b);var a={method:"GET",url:clinicRole_api.clinic_listRolePerms,data:{roleId:b,typeCode:c.typeCode},dataType:"json",showMask:true};var d=Utils.myAjaxHandler(a);d.done(function(f){if(f!=null&&f.errorCode==SUCCESSCODE){rolePerms=f.data;e();$("#list_div").hide();$("#add_edit_div").show()}else{$.paError(f.errorMessage)}}).fail(function(f){$.paError("请求异常")}).always(function(){})},initRolePermission:function(){clinicRole_js.cleanRolePermission();$(".checkboxes-wrapper li").each(function(){var a=$(this).attr("value");if(rolePerms[a]){$(this).addClass("checked")}});$(".level2-checkboxes").each(function(){var a=true;$(this).next(".level3-checkboxes").each(function(){$(this).find("li").each(function(){if(!$(this).hasClass("checked")){a=false}})});if(a){$(this).find("li").addClass("checked")}});$(".level1-checkboxes").each(function(){var a=true;$(this).siblings(".level2-checkboxes").each(function(){$(this).find("li").each(function(){if(!$(this).hasClass("checked")){a=false}})});if(a){$(this).find("li").addClass("checked")}})},cleanRolePermission:function(){$(".checkboxes-wrapper li span").removeClass("checked")},refreshMenutree:function(u){if(u==undefined){return}var H=$("#permissionDiv");H.html("<div class='bl-title' style='border-top: 1px solid #dfdfdf;'><h2>角色权限设置</h2></div>");var C=$("<div class='checkboxes-wrapper'></div>");var a=$("<ul class='level1-checkboxes'></ul>");a.appendTo(C);C.appendTo(H);for(var J=0;J<u.length;J++){var c=u[J];var g=c.resourceName;var e=c.resourceCode;var B=c.alias;var h=$("<li class='menu_item level1-item' value="+e+"><span class='menu_name'>"+(B==null?g:g+"("+B+")")+"</span></li>");h.appendTo(a);var E=c.subResource;if(E==undefined){continue}var b=$("<ul class='level2-checkboxes'></ul>");b.appendTo(h);var y=0;for(var I=0;I<E.length;I++){var M=E[I];var x=M.resourceCode;var s=M.alias;var p=E[I].subResource;var D="";if(p==undefined||p.length==0){D=$("<li class='menu_item level2-item' value="+x+"><span class='menu_name'>"+(s==null?M.resourceName:M.resourceName+"("+s+")")+"<i class='drop_arrow noview'></i></span></li>")}else{D=$("<li class='menu_item level2-item' value="+x+"><span class='menu_name'>"+(s==null?M.resourceName:M.resourceName+"("+s+")")+"</span></li>")}D.appendTo(b);if(p==undefined||p.length==0){var r=$("<ul class='level3-checkboxes dsn permission'></ul>");var f=M.resoucePermission;for(var F=0;F<f.length;F++){var q=f[F];var t=q.resourceCode;var L=q.actionCode;var z=q.resourceName;var N=q.actionName;var o=t+"-"+L;var l="";if(clinicRole_js.isAuthority(t,L,M.authzedRolePermission)){l=$("<li class='menu_item level3-item'><span value="+o+" class='menu_name checked'>"+q.actionName+"</span></li>")}else{l=$("<li class='menu_item level3-item'><span value="+o+" class='menu_name'>"+q.actionName+"</span></li>")}l.appendTo(r)}if(r.find("span.checked").length==f.length&&f.length!=0){y+=1;D.find("span").addClass("checked")}r.appendTo(D);continue}var r=$("<ul class='level2-checkboxes'></ul>");var w=0;for(var G=0;G<p.length;G++){var d=p[G];var x=d.resourceCode;var s=d.alias;var n=$("<li class='menu_item level2-item' value="+x+"><span class='menu_name'>"+(s==null?d.resourceName:d.resourceName+"("+s+")")+"<i class='drop_arrow noview'></i></span></li>");var K=$("<ul class='level3-checkboxes dsn permission'></ul>");var f=d.resoucePermission;var v=0;for(var F=0;F<f.length;F++){var q=f[F];var t=q.resourceCode;var L=q.actionCode;var z=q.resourceName;var N=q.actionName;var o=t+"-"+L;var l="";if(clinicRole_js.isAuthority(t,L,d.authzedRolePermission)){v+=1;l=$("<li class='menu_item level3-item'><span value="+o+" class='menu_name checked'>"+q.actionName+"</span></li>")}else{l=$("<li class='menu_item level3-item'><span value="+o+"  class='menu_name'>"+q.actionName+"</span></li>")}l.appendTo(K)}if(v==f.length&&v!=0){w+=1;n.find("span").addClass("checked")}K.appendTo(n);n.appendTo(r)}if(w==p.length&&w!=0){y+=1;D.find("span").addClass("checked")}r.appendTo(D)}if(y==E.length&&y!=0){h.find("span").addClass("checked")}}var A=$("<div class='btn-group fr' style='width:285px'><a href='javascript:;' class='btn btn-cancel fl'  id='cancelBtn'>取消 </a><a href='javascript:;' class='btn fl' onclick=clinicRole_js.saveData() id='btn_save'>保存</a></div>");A.appendTo(H);clinicRole_js.renderCheckBoxs()},isAuthority:function(c,b,d){if(d!=undefined&&d.length>0){for(var a=0;a<d.length;a++){if(d[a].resourceCode==c&&d[a].actionCode==b){return true}}}return false},renderCheckBoxs:function(){$(".drop_arrow").on("click",function(b){b.stopPropagation();if($(this).hasClass("noview")){$(this).parent().siblings().slideDown("fast")}else{$(this).parent().siblings().slideUp("fast")}$(this).toggleClass("noview")});$(".menu_name").on("click",function(b){b.stopPropagation();if($(this).hasClass("checked")){$(this).removeClass("checked");$(this).siblings("ul").find(".menu_name").removeClass("checked")}else{$(this).addClass("checked");$(this).siblings("ul").find(".menu_name").addClass("checked")}a($(this))});function a(c){var d=true;if(c.hasClass("checked")){c.parent().siblings(".menu_item").each(function(){if(!$(this).children(".menu_name").hasClass("checked")){d=false;return false}});if(d){var b=c.parent().parent().siblings(".menu_name");b.addClass("checked");if(!c.parent().parent().hasClass("level1-checkboxes")){a(b)}}}else{var b=c.parent().parent().siblings(".menu_name");b.removeClass("checked");if(!c.parent().parent().hasClass("level1-checkboxes")){a(b)}}}},checkboxesLiUnBind:function(){$(".checkboxes li").unbind("click");$(".level1-checkboxes li").unbind("click");$(".level2-checkboxes li").unbind("click");$(".level3-checkboxes li").unbind("click")},findResPerms:function(b){var e=[];for(var c=0;c<clinicPerms.permissions.length;c++){var d=clinicPerms.permissions[c];var a=d.resourceCode.substring(0,b.length)==b;if(a){e.push(d)}}return e},saveData:function(){$("#add_edit_div").ketchup();var e=$("#add_edit_div").ableToFinish();if(!e){$("#add_edit_div").animate({scrollTop:0},500);return}var b="";$(".permission .checked").each(function(){var i=$(this).attr("value");if(b==""){b=b+i}else{b=b+","+i}});if(b==""){$.paWarn("请选择权限！");return}if(currentRole.id==""){currentRole.name=$("#roleId").val()}else{var d=clinicRole_js.findItemData(currentRole.id);if(d.typeCode!=="2001"){$.paWarn("预设角色不允许修改！");return}}if(currentRole.name==""){$.paWarn("权限名称不能为空！");return}var a=(currentRole.id==undefined||currentRole.id=="");var g=a?clinicRole_api.clinic_role_add:clinicRole_api.clinic_role_update;if(!a&&$("#roleId").val()!=$("#roleId").attr("rolename")){currentRole.name=$("#roleId").val()}var c={role:currentRole,permission:b};var f={method:"POST",url:g,data:{paramData:JSON.stringify(c)},dataType:"json",showMask:true};var h=Utils.myAjaxHandler(f);h.done(function(i){if(i!=null&&i.errorCode==SUCCESSCODE){$.paSuccess("刷新成功");clinicRole_js.loadRoleData();$("#list_div").show();$("#add_edit_div").hide()}else{$.paError(i.errorMessage)}}).fail(function(i){$.paError("请求异常")}).always(function(){})},roleClickHandler:function(a){$(a).addClass("current").siblings().removeClass("current");clinicRole_js.loadRolePerms(a.id,clinicRole_js.initRolePermission)},paginationHandler:function(a,c){pageInfo.currentPage=a.currentPage;if(a.isCallback){clinicRole_js.loadRoleData()}var b={containerId:"my-page",pageCount:pageInfo.totalPage,condition:{currentPage:pageInfo.currentPage,isCallback:true},callback:clinicRole_js.paginationHandler};if(!a.isGenerated){Pagination.generatePagination(b)}if(typeof c==="function"){c(pageInfo.currentPage,pageInfo.totalPage)}},deleteData:function(c){var a=clinicRole_js.findItemData(c);if(a==undefined){$.paWarn("请选择需要删除的记录后再操作");return}if(a.typeCode!=="2001"){$.paWarn("预设角色不允许修改！");return}var b={msg:"是否确定删除？",cancelTxt:"取消",saveTxt:"确定",onYes:function(){var d={method:"POST",url:clinicRole_api.clinic_role_del,data:{id:a.id},dataType:"json"};var e=Utils.myAjaxHandler(d);e.done(function(f){if(f!=null&&f.errorCode==SUCCESSCODE){clinicRole_js.searchBtnClick()}else{if(f.errorCode=="E2SP0109"){$.paWarn("该角色已被授权使用，不可删除")}else{$.paError(f.errorMessage)}}}).fail(function(f){$.paError("请求异常",3000)}).always(function(){})}};$.paConfirm(b)}});