var inventorywarn=Utils.getQueryString("inventorywarn")!=null?Utils.getQueryString("inventorywarn"):"";var zeroselect=Utils.getQueryString("zeroselect")!=null?Utils.getQueryString("zeroselect"):"";zeroselect=zeroselect==""?"1":zeroselect;var inventoryType=Utils.getQueryString("inventoryType")!=null?Utils.getQueryString("inventoryType"):"";var searchText=Utils.getQueryString("searchText")!=null?Utils.getQueryString("searchText"):"";var currentPageNo=Utils.getQueryString("currentPage");var validtimewarn="";var commonCheckboxStoreTree;currentPageNo=(currentPageNo==null?1:currentPageNo);var isChainClinic=isChainClinic();var warningType="all";$(function(){inventoryIndex.initClassify(inventoryType);inventoryIndex.initWarningType(warningType);inventoryIndex.initStore();if(inventorywarn&&inventorywarn=="1"){$("#inventorywarn").find("input").addClass("checked");$("#inventorywarn").find("span").addClass("active")}if(zeroselect&&zeroselect=="1"){$("#zeroselect").find("input").addClass("checked");$("#zeroselect").find("span").addClass("active")}if(searchText){$("#search_text").val(searchText)}$(".search-box a").on("click",function(a){currentPageNo=1;inventoryIndex.searchInventory();inventoryIndex.getInventorySummaryData()});$("#search_text").on("keyup",function(a){if(a.which==13){currentPageNo=1;inventoryIndex.searchInventory();inventoryIndex.getInventorySummaryData()}});$(".search-btn").on("click",function(){currentPageNo=1;inventoryIndex.searchInventory();inventoryIndex.getInventorySummaryData()});$("#inventory_export").on("click",function(){var a=inventoryIndex.getSearchKey();window.location.href=ContextClinc_Server+"inventory/exportExcel?cookie_pawj_medical_user_id="+Utils.getCookie("cookie_pawj_medical_user_id")+"&zeroselect="+a.zeroselect+"&inventoryWarn="+a.inventoryWarn+"&warningType="+a.warningType+"&drugSortCode="+a.drugSortCode});$(".checkbox-box li").on("click",function(b){var d=$(this).attr("id");currentPageNo=1;var a=$(this).find("input");a.hasClass("checked")?a.removeClass("checked"):a.addClass("checked");var c=$(this).find("span");c.hasClass("active")?c.removeClass("active"):c.addClass("active");isChainClinic?$("#storeNameTh").removeClass("hide"):$("#storeNameTh").addClass("hide");if(d=="inventorywarn"){c.hasClass("active")?$("#warningTypeCmp").removeClass("hide"):$("#warningTypeCmp").addClass("hide");if(c.hasClass("active")){$("#warningTypeTh").removeClass("hide");if(warningType==3||warningType=="all"||warningType==""){if($("#zeroselect").find("input").hasClass("checked")){$("#zeroselect").find("input").removeClass("checked")}if($("#zeroselect").find("span").hasClass("active")){$("#zeroselect").find("span").removeClass("active")}}}else{$("#warningTypeTh").addClass("hide")}inventoryIndex.searchInventory();inventoryIndex.getInventorySummaryData()}else{if(d=="zeroselect"){inventoryIndex.searchInventory();inventoryIndex.getInventorySummaryData()}else{if(d=="validtimewarn"){inventoryIndex.searchInventory();inventoryIndex.getInventorySummaryData()}}}});$("#inventory_set").on("click",function(){location.href="inventory_set.html?inventorywarn="+inventorywarn+"&zeroselect="+zeroselect+"&inventoryType="+inventoryType+"&searchText="+searchText+"&currentPage="+currentPageNo});$("#inventory_valid").on("click",function(){location.href="inventory_valid.html?inventorywarn="+inventorywarn+"&zeroselect="+zeroselect+"&inventoryType="+inventoryType+"&searchText="+searchText+"&currentPage="+currentPageNo});$("#inventory_search").on("click",function(){location.href="inventory_search.html?inventorywarn="+inventorywarn+"&zeroselect="+zeroselect+"&inventoryType="+inventoryType+"&searchText="+searchText+"&currentPage="+currentPageNo});$("#inventory_table").on("click",".batch_num_search",function(){var a=$(this).parent().parent("tr").attr("data-drug-id");var b=$(this).parent().parent("tr").attr("data-clinic-id");inventoryIndex.searchBatchNum(a,b)});if(isChainClinic){$("#inventory_search").removeClass("hide")}$("#inventory_table").on("click",".inventory_detail",function(){var a=$(this).parent().parent("tr").attr("data-drug-id");var c=$(this).parent().parent("tr").attr("data-drug-name");var e=$(this).parent().parent("tr").attr("data-drug-spec");var d=$(this).parent().parent("tr").attr("data-drug-retail-price");var b=$(this).parent().parent("tr").attr("data-clinic-id");location.href="inventory_entry_detail.html?drugId="+a+"&drugName="+encodeURIComponent(c)+"&drugPackageSpec="+encodeURIComponent(e)+"&drugRetailPrice="+d+"&inventorywarn="+inventorywarn+"&zeroselect="+zeroselect+"&inventoryType="+inventoryType+"&searchText="+encodeURIComponent(searchText)+"&currentPage="+currentPageNo+"&clinicId="+b});$("#clinicNamesBox").click(function(){var b=$("#clinicIds").val().split(",");var a=[];for(var c in b){if(b[c]!=""){a.push(b[c])}}commonCheckboxStoreTree.show(a)});isChainClinic?$("#storeNameTh").removeClass("hide"):$("#storeNameTh").addClass("hide");if($("#inventorywarn").find("span").hasClass("active")){$("#warningTypeTh").removeClass("hide")}else{$("#warningTypeTh").addClass("hide")}$("#inventorywarn").find("span").hasClass("active")?$("#warningTypeCmp").removeClass("hide"):$("#warningTypeCmp").addClass("hide");if(isChainClinic){$("#store").removeClass("hide")}$("#inventory_table").on("mouseenter",".data_detail",function(){$(this).children(".data_detail_box").show()}).on("mouseleave",".data_detail",function(){$(this).children(".data_detail_box").hide()});inventoryIndex.searchInventory();inventoryIndex.getInventorySummaryData()});var inventoryIndex={initClassify:function(d){var c={};var a={method:"GET",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"mdcDictDrug/drugtypes",data:JSON.stringify(c),dataType:"json"};var b=Utils.myAjaxHandler(a);b.done(function(e){if(SUCCESSCODE==e.errorCode){inventoryIndex.setInventoryClassify(e.data,d)}else{$.paError(e.errorMessage,null)}}).fail(function(e){$.paError("请求异常",null)}).always(function(){})},initStore:function(){if(!commonCheckboxStoreTree){commonCheckboxStoreTree=new CommonCheckboxStoreTree({callback:function(b){var e="";var c="";for(var d=0,a=b.length;d<a;d++){e+=b[d].name;c+=""+b[d].id+"";if(d!=(a-1)){e+=",";c+=","}}$("#select-store-input").val(e);$("#clinicIds").val(""+c+"");currentPageNo=1;inventoryIndex.searchInventory();inventoryIndex.getInventorySummaryData()}})}},setInventoryClassify:function(c,d){var b=[{drugTypeId:"all",drugTypeName:"全部"}];$.merge(b,c);var a={idKey:"drugTypeId",txtKey:"drugTypeName",isNeedClear:false};$("#inventory_type").WJZSDropdown(b,a,function(e,f){inventoryType=f.drugTypeId;inventoryIndex.searchInventory();inventoryIndex.getInventorySummaryData()});if(d){$("#inventory_type").SetWJZSDropdownSelectedData(d)}},initWarningType:function(b){var a=[{warningTypeId:1,warningTypeName:"上限预警"},{warningTypeId:2,warningTypeName:"下限预警"},{warningTypeId:3,warningTypeName:"0库存预警"}];inventoryIndex.setWarningType(a,b)},setWarningType:function(c,d){var b=[{warningTypeId:"all",warningTypeName:"全部"}];$.merge(b,c);var a={idKey:"warningTypeId",txtKey:"warningTypeName",isNeedClear:false};$("#warning_type").WJZSDropdown(b,a,function(e,f){warningType=f.warningTypeId;if(warningType==3||warningType=="all"){if($("#zeroselect").find("input").hasClass("checked")){$("#zeroselect").find("input").removeClass("checked")}if($("#zeroselect").find("span").hasClass("active")){$("#zeroselect").find("span").removeClass("active")}}inventoryIndex.searchInventory();inventoryIndex.getInventorySummaryData()});if(d){$("#warning_type").SetWJZSDropdownSelectedData(d)}},getSearchKey:function(c){if($("#inventorywarn").find("span").hasClass("active")){inventorywarn=1}else{inventorywarn=0}if($("#zeroselect").find("span").hasClass("active")){zeroselect=1}else{zeroselect=0}currentPage=(c==undefined||c==null)?parseInt(currentPageNo):c.currentPage;if("all"==inventoryType){inventoryType=""}if("all"==warningType){warningType=""}searchText=$.trim($("#search_text").val());var b=$("#clinicIds").val().split(",");var a=[];for(var e in b){if(b[e]!=""){a.push(b[e])}}var d={drugSortCode:inventoryType,searchText:searchText,inventoryWarn:inventorywarn,zeroselect:zeroselect,currentPage:currentPage,pageSize:10,clinicList:a,warningType:warningType};return d},searchInventory:function(b){var c=inventoryIndex.getSearchKey(b);var a=$.extend({},b,c);a.ajaxopts={showMask:true,url:ContextClinc_Server+"inventory/inventory_drug_list",type:"POST"};a.callback=function(g){if(SUCCESSCODE==g.errorCode){var d=g.data.dataSource;var f="";for(var e=0;e<d.length;e++){f+=inventoryIndex.addInventoryListhtml(d[e])}$("#inventory_table").empty();$("#inventory_table").append(f);if($(".inventory_detail").length==0){$(".tips-floating .tips-list ul li").eq(3).hide()}else{$(".tips-floating .tips-list ul li").eq(3).show()}if($(".batch_num_search").length==0){$(".tips-floating .tips-list ul li").eq(4).hide()}else{$(".tips-floating .tips-list ul li").eq(4).show()}$(".inventory_detail").tipso({content:"点击可以查看库存详细信息",useTitle:false,});$(".batch_num_search").tipso({content:"点击按钮可以查询详细的批次情况",useTitle:false,});$(".tips-floating .tips-list ul li").eq(3).click(function(){$($(".inventory_detail")[0]).tipso("show",{delay:300,"continue":2000})});$(".tips-floating .tips-list ul li").eq(4).click(function(){$($(".batch_num_search")[0]).tipso("show",{delay:300,"continue":2000})});currentPageNo=g.data.currentPage}else{$.paError(g.errorMessage,null)}};$("#my-page").generatePagination(a)},addInventoryListhtml:function(d){var h=this;var e="";e+='<tr data-drug-id="'+d.drugId+'" data-drug-name="'+d.drugName+'" data-drug-spec="'+d.drugPackageSpec+'" data-drug-retail-price="'+d.drugRetailPrice+'" data-clinic-id="'+d.clinicId+'">';var b="";if(d.drugName){if(d.disable==1){b=d.drugName+"<font color='#CDCDC1'>(已停用)</font> "}else{b=d.drugName}}var g=d.drugTypeName!=null?d.drugTypeName:"";e+='<td width="5%">'+g+"</td>";e+='<td width="15%">'+b+"</td>";var a=d.drugPackageSpec!=null?d.drugPackageSpec:"--";e+='<td width="8%">'+a+"</td>";if($("#inventorywarn").find("span").hasClass("active")){var i="";if(d.drugStoreUnitQty==0){i="0库存预警"}if(d.drugStoreUnitQty>d.inventoryCeiling){i="上限预警"}if(d.drugStoreUnitQty<d.inventoryFloor){i==""?(i+="下限预警"):(i+="，下限预警")}e+='<td width="10%">'+i+"</td>"}var c=d.showExpiredQty?d.showExpiredQty:("0"+d.drugStoreUnitName);var f=d.showVirtualQty?d.showVirtualQty:("0"+d.drugStoreUnitName);e+='<td width="12%">'+(d.manufactorName||"--")+"</td>";e+='<td width="8%" style="text-align: right;padding-right:9px;">'+(d.drugRetailPrice||"0")+"</td>";e+='<td width="8%" style="text-align: right;padding-right:9px;">'+(d.drugPurchaseStorePrice||"")+"</td>";e+='<td width="10%" class="data_detail">'+h.parseInventoryCount(d.showInventoryCount.replace("null",""),d.drugStoreUnitName)+'<div class="data_detail_box dsn"><p>已过期：<span>'+c+"</span></p><p>收费中：<span>"+f+"</span></p></div></td>";e+='<td width="10%" class="data_detail">'+h.parseInventoryCount(d.showStoreValideQty.replace("null",""),d.drugStoreUnitName)+'<div class="data_detail_box dsn"><p>已过期：<span>'+c+"</span></p><p>收费中：<span>"+f+"</span></p></div></td>";if(isChainClinic){e+='<td width="10%">'+d.clinicName||"</td>"}e+="<td>";e+='<a width="10%" class="inventory_detail" href="javascript:;">进销存详情</a> <a class="batch_num_search" href="javascript:;">批次详情</a>';e+="</td>";e+="</tr>";return e},parseInventoryCount:function(e,d){if(e!=null&&$.trim(e)!=""){var c="";var a=$.trim(e).split("#");for(var b=0;b<a.length;b++){if(b%2!=0){c+='<span class="text_theme_color">'+a[b]+"</span>"}else{c+=a[b]}}return c}return'<span class="text_theme_color">0</span> '+(d?d:"")},searchBatchNum:function(d,b){var a={method:"GET",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"inventory/inventory_batchnum_list?drugId="+d+"&clinicId="+b,dataType:"json"};var c=Utils.myAjaxHandler(a);c.done(function(e){if(SUCCESSCODE==e.errorCode){inventoryIndex.displayBatchNum(e.data)}else{$.paError(e.errorMessage,null)}}).fail(function(e){$.paError("请求异常",null)}).always(function(){})},displayBatchNum:function(d){var c="";if(d!=undefined&&d.length>0){for(var b=0,a=d.length;b<a;b++){c+="<tr>";c+='<td width="100px">'+d[b].drugName+"</td>";c+='<td width="110px">'+d[b].drugPackageSpec+"</td>";c+='<td width="90px">'+d[b].drugStoreUnitQty+d[b].drugStoreUnitName+"</td>";c+='<td width="80px">'+(d[b].drugPurchaseStorePrice?d[b].drugPurchaseStorePrice:"")+"元/"+d[b].drugStoreUnitName+"</td>";var g=d[b].batchNum!=null?d[b].batchNum:"";c+='<td width="90px">'+g+"</td>";c+='<td width="90px">'+Utils.timeStampToDateStr(d[b].validDate,7)+"</td>";var f=d[b].vendorName!=null?d[b].vendorName:" ";c+='<td width="70px">'+f+"</td>";var e=d[b].manufactorName!=null?d[b].manufactorName:"";c+="<td>"+e+"</td>";c+="</tr>"}$("#batch_num_table").html(c);inventoryIndex.changeLcTrBgr($("#batch_num_table"));$(".detail-popup").show()}},changeLcTrBgr:function(b){var a=b.find("tr");var c=a.length;if(c>1){$.each(a,function(d){$(a[d]).removeClass("table-tr-bgc");if(d%2!=0){$(a[d]).addClass("table-tr-bgc")}})}},getInventorySummaryData:function(b){var c=inventoryIndex.getSearchKey(b);var a=$.extend({},b,c);a.ajaxopts={showMask:true,url:ContextClinc_Server+"inventory/get_inventory_summary_data",type:"POST"};a.callback=function(d){if(SUCCESSCODE==d.errorCode){if(d.data.length>0){$("#totalPurchaseAmountSum").val(d.data[0].TOTAL_PURCHASE_AMOUNT_SUM==null?0:d.data[0].TOTAL_PURCHASE_AMOUNT_SUM.toFixed(2));$("#totalRetailAmountSum").val(d.data[0].TOTAL_RETAIL_AMOUNT_SUM==null?0:d.data[0].TOTAL_RETAIL_AMOUNT_SUM.toFixed(2))}}else{$.paError(d.errorMessage,null)}};$("#my-page-summary").generatePagination(a)},changePrice:function(a){return null!=a&&""!=a?(a+="",0==a.indexOf(".")&&(a="0"+a),(a.indexOf(".")<0||a.substring(a.indexOf(".")+1).length==0||a.substring(a.indexOf(".")+1).length==1)&&(a=parseFloat(a).toFixed(2)+""),a.substring(a.indexOf(".")+1).length>4&&(a=parseFloat(a).toFixed(4)+"")):a="0.00",a},};var selectModel={getValue:function(c){var b=$("#"+c);var a={id:b.attr("val"),value:b.val()};return a},setValue:function(d,b){var a=$("#"+d);a.attr("val",b);var c=a.parent(".drop").find("li [value="+b+"]").text();a.val(c)}};