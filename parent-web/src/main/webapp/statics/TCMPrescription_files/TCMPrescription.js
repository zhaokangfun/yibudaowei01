var finishPatFlag=true;var acographyId=Utils.getQueryString("acographyId");var empiId=Utils.getQueryString("empiId");var treatmentState=Utils.getQueryString("treatmentState");var userInfo_aclc=config_cache.getCache("medical_user_data");var tcmpUtils=null;var tcmp=null;var tcmpHistory=null;var tcmpTmpl=null;var tcmpClassical=null;var prescriptionPrint=null;var isYbReg=Utils.getQueryString("isYbReg");$(function(){tcmpUtils=new TCMPrescriptionUtils();tcmp=new TCMPrescription();tcmp.init();tcmpHistory=new TCMPrescriptionHistory();if(treatmentState==="1"){tcmpHistory.init()}tcmpTmpl=new TCMPrescriptionTmpl();tcmpTmpl.init();prescriptionPrint=new TCMPrescriptionPrint();if(treatmentState=="1"){tcmpClassical=new TCMClassicalPrescription();tcmpClassical.init()}else{if(treatmentState=="2"){$(".topNav").addClass("treat-completedState")}}});function TCMPrescription(){this.drugIdArr=[];this.deleteRecipeCnArr=[];this.isReadOnly=false;this.herbalRecipesMaxNum=6;this.eatRequire=[{id:"0",txt:"内服"},{id:"1",txt:"外用"}];this.drugSourceData=[{id:0,txt:"本院"},{id:1,txt:"外购"},{id:2,txt:"免费"},{id:3,txt:"外煎"}];this.empi={};this.isDrugWithdrawal=false;this.isShowWeight=false;this.isShowFee=true;this.isStockCheck=true;this.isModifyPrice=false;this.isYBFlag=false}TCMPrescription.prototype={init:function(){tcmp.getParam();if(tcmp.isShowWeight){$(".pill-weight").show()}else{$(".pill-weight").hide()}$(".diagnosis-input").ketchup();tcmp.initDrugType();tcmp.initEatRequire();tcmp.initTcmAdvice();tcmp.initClickBtn();tcmp.getHerbalRecipes(empiId,acographyId,0);tcmp.initChiefComThinkInput()},initClickBtn:function(){$(".save").off("click").on("click",function(){if(tcmp.isReadOnly){tcmp.isReadOnly=false;tcmp.makeEditView()}else{var e=tcmp.getHerbalRecipesData();if(e.code==0){var a=e.data;if(a&&a.length>0){var c=$(".dose-usage-number").ableToFinish();var d=$(".advice-detail-left").ableToFinish();var b=$(".recipe-info").ableToFinish();if(!c||!b||!d){return}if($(".left-prescription").find(".underStock").length>0){$.paWarn("有中药超出库存！");return}tcmp.saveHerbalRecipesList(a);tcmp.isReadOnly=true}else{$.paWarn("无处方，请添加！")}}else{$.paWarn(e.errorMsg)}}});$("#add-save").off("click").on("click",function(){var a=$(".diagnosis-input").ableToFinish();if(!a){return}tcmp.saveCnMedical()});$("#closeDiagnosis").off("click").on("click",function(){$("#addDiagnosisPop").addClass("dsn")});$("#add-cancel").off("click").on("click",function(){$("#addDiagnosisPop").addClass("dsn")});$(".extraChargePop .full-width-table").on("keyup",".projectNum",function(){tcmpUtils.calcProjectPrice($(".pill-wrap:visible"))});$(".extraChargeBtn").off("click").on("click",function(){var a=$(this).parents(".pill-wrap");if(!tcmp.isShowFee){a.children(".extraChargePop").find(".extraPriceTd").hide()}var b=a.children(".extraChargePop").removeClass("dsn");a.find(".projectNum").bind("input propertychange",function(){tcmpUtils.calcProjectPrice(a)})});$(".extraChargePop .closeExtraCharge").off("click").on("click",function(){$(this).parents(".extraChargePop").find("tbody tr").removeClass("dsn");$(this).parents(".extraChargePop").find("tbody .cacheTr").remove();$(".extraChargePop:visible").addClass("dsn")});$(".extraChargePop .extra-cancel").off("click").on("click",function(){$(this).parents(".extraChargePop").find("tbody tr").removeClass("dsn");$(this).parents(".extraChargePop").find("tbody .cacheTr").remove();$(".extraChargePop:visible").addClass("dsn")});$(".extraChargePop .extra-save").off("click").on("click",function(){var d=$(this).parents(".pill-wrap");$(this).parents(".popcontent").find("tbody .dsn").remove();$(this).parents(".popcontent").find("tr").removeClass("cacheTr");if(!$(this).parents(".popcontent").find("tr:not('.tp_newtr')").ableToFinish()){return}var a="";var c=$(this).parents(".popcontent").find(".projectName");if(c&&c.length>1){$.each(c,function(e){if($(c[e]).val()){a+=$(c[e]).val()+"，"}});var b=tcmpUtils.calcProjectPrice(d);if(!b){return}d.find(".sumProjectprice").val(b);tcmp.showExtraCharge(d,b,a);d.find(".extraCharge-Num").text(c.length-1).show()}else{d.find(".sumProjectprice").val("0.00");tcmp.showExtraCharge(d,0,a)}$(this).parents(".extraChargePop").addClass("dsn");tcmpUtils.calcTotalPrice(d.find(".pill-list-content"))}),$("#comUsed-tag").off("click").on("click",function(){var a=$(this).parents(".pill-wrap").attr("data-index");$("#comUsed-save").attr("data-index",a);$("#comUsedPop").show()});$(".comUsed-cont>li").off("click").on("click",function(){$(this).toggleClass("checked")});$("#comUsed-cancel").off("click").on("click",function(){$(".comUsed-cont>li").removeClass("checked");$("#comUsedPop").hide()});$("#comUsed-save").off("click").on("click",function(){var a=$(".pill-wrap:visible .importInfo").find(".china-advice");var b=a.val();$(".comUsed-cont>li.checked").each(function(){b+=$(this).text()+"；"});if(b.length>=105){$.paWarn("医嘱输入长度超限")}else{a.val(b)}$(".comUsed-cont>li").removeClass("checked");$("#comUsedPop").hide()});$(".applyRefund").off("click").on("click",function(){var a={msg:"申请退药后不可恢复，确定要申请退药吗?",cancelTxt:"取消",saveTxt:"确定",onYes:function(){var b=$(".pill-wrap:visible");var d=b.find(".pill-list-content ul li");var g=d.length;var i=[];for(var e=1;e<g;e++){var c=$(d[e]).data("drug");if(c.DRUG_NAME){var f={recipeCnId:$(d[e]).attr("recipecnid"),};i.push(f)}}var h={recipeId:$(".recipe-label .recipe-label-item[data-index="+b.attr("data-index")+"]").attr("data-id"),recipeCnList:i};tcmp.drugWithdrawal(h)}};$.paConfirm(a)});$(".recipe-label .add-recipe").click(function(){if($(".recipe-label ul li").length>tcmp.herbalRecipesMaxNum){$.paWarn("最多只能添加六个处方");return}var b=parseInt($(".recipe-label").find("ul li:last").attr("data-index"))+1;tcmp.addPrescriptionTab(true,true,b);var a=tcmp.addPrescriptionBody(true,b,tcmp.empi);a.find(".thinkBoxInputArea").focus()});$(".recipe-label .delete").off().on("click",function(){var c=$(this);if(c.parent().hasClass("allowEdit")){var a=$(this).parent().attr("data-index");var b={msg:"删除处方"+a+"，请确认！",cancelTxt:"取消",saveTxt:"确认",onYes:function(){if(c.parent().attr("data-id")){var d=tcmp.deleteRecipeCn(c.parent().attr("data-id"));if(!d){tcmp.deleteHerbalRecipesTab(c)}}else{tcmp.deleteHerbalRecipesTab(c)}}};$.paConfirm(b)}});$(".recipe-label li").each(function(){$(this).click(function(){var a=$(this).index();$(".recipe-label ul > li:eq("+a+")").addClass("checked").siblings().removeClass("checked");$(".left-prescription > .pill-wrap:eq("+a+")").removeAttr("style").siblings(".pill-wrap").css("display","none");$(".left-prescription > .pill-wrap:eq("+a+")").find(".thinkBoxInputArea").focus();$(".print").attr("title","打印处方"+$(this).attr("data-index"));$(".saveAs").attr("title","处方"+$(this).attr("data-index")+"存为模板");tcmp.drugWithdrawalView($(this).attr("data-index"))})});$(".print").off("click").on("click",function(){var a=$(".recipe-label ul").find("li.checked").attr("data-id");if(a){prescriptionPrint.doPrintFacade(empiId,acographyId,a,!tcmp.isShowFee?true:false)}else{$.paWarn("请先保存处方！")}});$(document).on("click",".add-drug",function(){tcmp.addDrugToPrescription($(this))});$(document).on("click",".update-drug",function(){tcmp.updateDrugToPrescription($(this))});$(document).on("click",".empty-drug",function(){var a=$(this).parents(".drug-input");tcmp.cleanDrugInput(a);tcmp.revertAddStatus(a)});$(document).on("click",".delete-drug",function(){var f=$(this);var c=f.parents(".pill-wrap").attr("data-index");var e=f.parents(".pill-wrap").find(".pill-list-item.checked").attr("recipecnid");if(e){tcmp.deleteRecipeCnArr.push({id:c,recipecnid:e})}var b=f.parents(".pill-wrap").find(".pill-list-item.checked").data("drug");var a=b.DRUG_ID;var d=f.parents(".pill-wrap").find(".pill-list-content");f.parents(".pill-wrap").find(".dose-herbs >span").text(d.find("li").length-2);f.parents(".pill-wrap").find(".pill-list-item.checked").remove();tcmp.cleanDrugInput(f.parents(".drug-input"));tcmp.revertAddStatus(f.parents(".drug-input"));f.remove();tcmp.deleteDrugIdArr(c,a);tcmpUtils.calcTotalPrice(d);tcmpUtils.calcTotalWeight(d);if(d.find(".pill-list-item:not(.prescription-cell-clone)").length==0){$(".pill-list-content:visible>ul").hide();$(".pill-list-content:visible>.without-drugs").show();$(".pill-list-hint:visible>i").hide()}});$(".pill-list-content").on("click",".delete-herbal",function(){var f=$(this);var c=f.parents(".pill-wrap").attr("data-index");var e=f.parent().attr("recipecnid");if(e){tcmp.deleteRecipeCnArr.push({id:c,recipecnid:e})}var b=f.parents(".pill-list-item").data("drug");var a=b.DRUG_ID;var d=f.parents(".pill-list-content");f.parents(".pill-middle-info").find(".delete-drug").remove();tcmp.cleanDrugInput(f.parents(".pill-middle-info").find(".drug-input"));tcmp.revertAddStatus(f.parents(".pill-middle-info").find(".drug-input"));f.parents(".pill-middle-info").find(".dose-herbs >span").text(f.parent("li").siblings("li").length-1);f.parent().remove();tcmp.deleteDrugIdArr(c,a);tcmpUtils.calcTotalPrice(d);tcmpUtils.calcTotalWeight(d);if(d.find(".pill-list-item:not(.prescription-cell-clone)").length==0){$(".pill-list-content:visible>ul").hide();$(".pill-list-content:visible>.without-drugs").show();$(".pill-list-hint:visible>i").hide()}});$(".pill-list-content").on("click",".pill-list-item",function(){var d=$(this);d.addClass("checked").siblings().removeClass("checked");d.addClass("alreadyClick").siblings().removeClass("alreadyClick");if(!tcmp.isReadOnly){d.find("i").show();d.siblings().find("i").hide();var b=d.parents(".pill-middle-info").find(".drug-input");if(b.find(".delete-drug").length==0){b.find(".empty-drug").after('<i class="delete-drug" title="删除"></i>');b.find(".add-drug").after('<i class="update-drug" title="更新"></i>')}b.find(".add-drug").hide();var a=d.data("drug");if(a){var c=b.find(".thinkBoxInputArea");c.attr("disabled","disabled");setTimeout(function(){c.val(a.DRUG_NAME)},50);b.find(".china-drugDose").val(d.data("drugDose")).focus();b.find(".china-drugUnitName").text(a.DRUG_DOSE_UNIT_NAME);tcmp.setSelectValue(b.find(".drug-usage"),d.data("footnote"));tcmp.setSelectValue(b.find(".cn-source"),d.data("drugSource")||0)}}});$(".pill-list-content").on("mouseenter mouseleave","li",function(){var a=$(this);if(!a.hasClass("alreadyClick")){a.toggleClass("checked");if(a.parents(".pill-wrap").find(".pill-status>i.changes").length>0||a.parents(".pill-wrap").find(".pill-status>i.new").length>0){a.find("i").toggle()}}});$(document).keypress(function(d){var b=$(".drug-dosage .china-drugDose:visible").is(":focus");if(b&&d.which==13){var c=$(".drug-input:visible").find(".update-drug");if(c.is(":visible")){tcmp.updateDrugToPrescription(c)}else{tcmp.addDrugToPrescription($(".add-drug:visible"))}}var a=$(".classicalDrug #keyword").is(":focus");if(a&&d.which==13){tcmpClassical.searchPrescriptions($(".classicalDrug #keyword"))}});$(".topNav-item").on("click",function(){$(this).siblings("li").removeClass("choose");$(this).addClass("choose");$(this).parents(".topNav-wrap").next(".rightInfo-wrap").children().addClass("dsn");var a=$(this).parents(".topNav-wrap").next(".rightInfo-wrap");if($(this).index()==0){a.children(".historyRecipe").removeClass("dsn")}else{if($(this).index()==1){a.children(".recipe-template").removeClass("dsn");tcmpTmpl.getChinaTmplMedicien()}else{a.children(".classicalDrug").removeClass("dsn");tcmpClassical.initClassicalPrescriptionType()}}});$(".editorBtn").off("click").on("click",function(){$("#chineseTraDiagnosis").val(Utils.trimObj(tcmp.empi.CHINESE_TRA_DIAGNOSIS));$("#chineseTraDiagnosis").attr("val",Utils.trimObj(tcmp.empi.CHINESE_DIAGNOSIS_CODE));$("#westDiagnosis").val(tcmp.empi.DiagnosisList!=null?tcmp.empi.DiagnosisList:"");$("#westDiagnosis").attr("val",Utils.trimObj(tcmp.empi.diagnosisCode));$("#addDiagnosisPop").removeClass("dsn")});if(!$.support.leadingWhitespace){if($(".tab-content").width()>1340){$(".space-bg").show()}else{$(".space-bg").hide()}}},cleanDrugInput:function(a){tcmp.setSelectValue(a.find(".drug-usage"),"");a.find(".china-footnote").val("");a.find(".thinkBoxInputArea").val("");a.find(".china-drugDose").val("");a.find(".china-drugUnitName").text("")},revertAddStatus:function(a){a.find(".update-drug").remove();a.find(".add-drug").show();a.find(".delete-drug").remove();a.find(".thinkBoxInputArea").removeData("drug").removeAttr("disabled").focus()},addDrugToPrescription:function(a){var e=a.parents(".drug-input");var a=e.find(".thinkBoxInputArea");var d=e.ableToFinish();if(!d){return}if(!a.val()){$.paWarn("请选择中药！");return}var k=$.trim(e.find(".china-drugDose").val());if(!k){$.paWarn("请添加中药用量！");return}var h=a.parents(".pill-wrap").attr("data-index");var f=a.data("drug");if($.inArray(h+"|"+f.DRUG_ID,tcmp.drugIdArr)==-1){var g=a.parents(".pill-wrap");var j=e.find(".china-footnote").attr("val");var l=e.find(".china-footnote").val();var c=e.find(".drug-source").attr("val");var m=tcmp.addPrescriptionCell(g);tcmp.addPrescriptionCellData(m,f,k,j,l,c,h);var b=a.parents(".pill-middle-info").find(".pill-list-content");tcmpUtils.calcTotalPrice(b);tcmpUtils.calcTotalWeight(b);var i=b.find("li");a.parents(".importInfo").find(".dose-herbs >span").text(i.length-1)}else{$.paWarn("处方"+h+"中已存在该中药！")}tcmp.cleanDrugInput(e);tcmp.revertAddStatus(e)},updateDrugToPrescription:function(g){var f=g.parents(".drug-input");var c=$.trim(f.find(".china-drugDose").val());if(!c){$.paWarn("请添加中药用量！");return}var e=f.parents(".pill-middle-info").find(".pill-list-content");var a=e.find(".pill-list-item.checked");var h=f.find(".china-footnote").attr("val");var d=f.find(".china-footnote").val();if(d=="请选择"||!d){d="";a.find(".separator").hide()}else{a.find(".separator").show()}var b=f.find(".drug-source").attr("val");a.find(".china-drugDose").text(c);a.find(".drugUsage").text(d).attr("title",d);a.data("footnote",h);a.data("drugDose",c);a.data("drugSource",b);if(b==1){a.addClass("outsourcing").removeClass("forFree").removeClass("outFry")}else{if(b==2){a.addClass("forFree").removeClass("outsourcing").removeClass("outFry")}else{if(b==3){a.addClass("outFry").removeClass("outsourcing").removeClass("forFree")}else{a.removeClass("outsourcing").removeClass("forFree").removeClass("outFry")}}}tcmpUtils.calcTotalPrice(e);tcmpUtils.calcTotalWeight(e);tcmp.cleanDrugInput(f);tcmp.revertAddStatus(f)},addDrugIdArr:function(b,a){tcmp.drugIdArr.push(b+"|"+a)},deleteDrugIdArr:function(b,a){tcmp.drugIdArr.splice($.inArray(b+"|"+a,tcmp.drugIdArr),1)},cleanAll:function(){$(".recipe-label").find(".prescription-tab-clone").siblings("li").remove();$(".left-prescription").find(".prescription-body-clone").siblings(".pill-wrap").remove();$(".pill-list-content").find(".prescription-cell-clone").siblings("li").remove()},getHerbalRecipes:function(f,d,c){var g=this;var b={acographyId:d,empiId:f};var a={url:ContextClinc_Server+"TCMPrescription/getHerbalRecipes",dataType:"json",showMask:true,data:b};var e=Utils.myAjaxHandler(a);e.done(function(k){if(k.errorCode==SUCCESSCODE){$(".content-inner").removeAttr("style");var s=k.data.lstPrescription;g.empi=k.data.empi;if(s&&s.length>0){g.isReadOnly=true;g.cleanAll();for(var o=0;s[o];o++){var r=s[o];var h=false;if(parseInt(r.recipeName)==c||(c==0&&o==0)){h=true}var u=(r.isSend==0&&r.isPay==0);var m=g.addPrescriptionTab(h,u,parseInt(r.recipeName));if(m){m.attr("data-id",r.recipeId)}}var p=s.length;var o=0;var n=s[0].recipeName;l();function l(){g.loadingPrescriptionBody(s,c,n,o);o++;if(o>p-1){if(treatmentState==2){$(".save").remove()}return}if(o==p-1){setTimeout(function(){j()},30)}else{setTimeout(function(){l()},30)}}function j(){g.loadingPrescriptionBody(s,c,n,o);if(g.isReadOnly){$(".drugType").disabledAll();$(".eatRequire").disabledAll();$(".importInfo .processingProject").disabledAll()}if(treatmentState==2){$(".tab-content-top .delete-cf").remove();$(".tab-content-top .add-cf").remove();$(".save").remove()}}if(treatmentState==="2"){tcmpHistory.init()}if(g.isReadOnly){g.makeReadonlyView()}}else{if(treatmentState=="1"){g.isReadOnly=false;if($(".recipe-label ul li").length>g.herbalRecipesMaxNum){$.paWarn("最多只能添加六个处方");return}var q=parseInt($(".recipe-label").find("ul li:last").attr("data-index"))+1;g.addPrescriptionTab(true,true,q);g.addPrescriptionBody(true,q,g.empi);g.makeEditView()}else{if(treatmentState=="0"){var k=tcmpHistory.getDateListSync();var t;if(k&&SUCCESSCODE===k.errorCode&&k.data){t=_.filter(k.data,function(i){return i.ACOGRAPHYID!=d})}if(t&&t.length>0){$(".content-inner").show();tcmpHistory.initClick();tcmpHistory.renderPrescriptionHistory(k);$(".topNav").addClass("treat-completedState");$("#treat-waitingState-historyRec").show();g.makeReadonlyView()}else{$("#treat-waitingState").show()}}else{var k=tcmpHistory.getDateListSync();var t;if(k&&SUCCESSCODE===k.errorCode&&k.data){t=_.filter(k.data,function(i){return i.ACOGRAPHYID!=d})}if(t&&t.length>0){$(".content-inner").show();tcmpHistory.initClick();tcmpHistory.renderPrescriptionHistory(k);$(".topNav").addClass("treat-completedState");$("#treat-completedNoData-historyRec").show();g.makeReadonlyView()}else{$("#treat-completedNoData").show()}}}}}else{$.paError(k.errorCode+"：查询中药处方失败！")}})},loadingPrescriptionBody:function(e,f,a,c){var g=e[c];var b=false;if(parseInt(g.recipeName)==f||(f==0&&c==0)){b=true}var d=tcmp.addPrescriptionBody(b,parseInt(g.recipeName),tcmp.empi,g,a);tcmp.addPrescriptionBodyData(d,g)},addPrescriptionTab:function(a,c,b){if($(".recipe-label ul li").length>tcmp.herbalRecipesMaxNum){$.paWarn("最多只能添加六个处方");return}var d=$(".recipe-label .prescription-tab-clone").clone(true).removeClass("prescription-tab-clone").attr("data-index",b).show();d.find("span").text("处方 "+b);if(c){d.addClass("allowEdit");d.find(".delete").show()}else{d.addClass("readonly");d.find(".delete").removeClass("delete")}$(".recipe-label ul").append(d);if(a){d.addClass("checked");d.siblings("li").removeClass("checked");$(".print").attr("title","打印处方"+b);$(".saveAs").attr("title","处方"+b+"存为模板")}return d},drugWithdrawalView:function(a){if(tcmp.isDrugWithdrawal&&$(".left-prescription > .pill-wrap[data-index="+a+"]").find(".pill-status>i.sentMedicine").length>0){$(".applyRefund").css("display","inline-block")}else{$(".applyRefund").css("display","none")}},getParam:function(){tcmp.isDrugWithdrawal=_.find(userInfo_aclc.clinicParams,function(a){return a.parameterCode=="3010"}).parameterValue==2?false:true;tcmp.isShowWeight=_.find(userInfo_aclc.clinicParams,function(a){return a.parameterCode=="3012"}).parameterValue==2?false:true;tcmp.isShowFee=_.find(userInfo_aclc.clinicParams,function(a){return a.parameterCode=="3013"}).parameterValue==2?true:false;tcmp.isStockCheck=_.find(userInfo_aclc.clinicParams,function(a){return a.parameterCode=="1010"}).parameterValue==2?false:true;tcmp.isModifyPrice=_.find(userInfo_aclc.clinicParams,function(a){return a.parameterCode=="3020"}).parameterValue==2?false:true;if(null!=userInfo_aclc.clinic&&null!=userInfo_aclc.clinic.tags){tcmp.isYBFlag=_.find(userInfo_aclc.clinic.tags,function(a){return a.tagCode=="MI"})!=undefined?true:false}},getPrescriptionStauts:function(a,c){var b="new";if(c==0&&a==0){b="submitted"}else{if(a==1){if(c==0){b="hasCharge"}else{if(c==1){b="sentMedicine"}else{if(c==2){b="retiredMedicine"}else{if(c==6){b="backMedicine"}}}}}else{if(a==2){b="haveRefund"}else{if(a==4){b="inTheCharge"}else{if(a==5){b="inRefund"}}}}}return b},addPrescriptionBody:function(isCurrent,index,empi,recipe,firstRecipeIndex){if($(".pill-wrap").length>tcmp.herbalRecipesMaxNum){$.paWarn("最多只能添加六个处方");return}var bodyClone=$(".prescription-body-clone").clone(true).removeClass("prescription-body-clone").attr("data-index",index);$(".foot-btn").before(bodyClone);if(index==firstRecipeIndex){bodyClone.removeAttr("style")}if(isCurrent){if(index!=firstRecipeIndex){var firstBodyClone=$(".prescription-body-clone").clone(true).removeClass("prescription-body-clone").attr("data-index",firstRecipeIndex);firstBodyClone.attr("style","display:none")}bodyClone.removeAttr("style");$(".left-prescription > .pill-wrap[data-index="+index+"]").show().siblings(".pill-wrap").hide()}bodyClone.find(".acography-serial-no").text(empi.ACOGRAPHY_SERIAL_NO);bodyClone.find(".clinic-name").text(userInfo_aclc.clinicName);bodyClone.find(".patient-healthCard").text(empi.INSURANCE_NO||"-");bodyClone.find(".patient-name").text(empi.PATIENT_NAME).attr("title",empi.PATIENT_NAME);bodyClone.find(".patient-gender").text(eval("gender["+empi.PATIENT_GENDER+"]"));bodyClone.find(".patient-age").text(Utils.getPersonAccurateAge(empi.PATIENT_BIRTH_DATE));bodyClone.find(".department-name").text((empi.DEPARTMENT_NAME||"-"));bodyClone.find(".payment-type-name").text(empi.MI_TYPE_NAME||"自费");bodyClone.find(".patient-no").text((empi.PATIENT_NO||"-"));var mobileNumer=Utils.isBlank(empi.MOBILE_PHONE_NUMBER)?empi.MOBILE_PHONE_NUMBER:"-";var livingAddress=Utils.isBlank(empi.LIVING_ADDRESS_COUNTRYSIDE)?(empi.LIVING_ADDRESS_COUNTRYSIDE+"/"+mobileNumer):("-/"+mobileNumer);bodyClone.find(".living-address-countryside").text(livingAddress).attr("title",livingAddress);var diagnosis=empi.CHINESE_TRA_DIAGNOSIS;if(diagnosis){if(empi.DiagnosisList){diagnosis+="；"+empi.DiagnosisList;$("#westDiagnosis").val(empi.DiagnosisList!=null?empi.DiagnosisList:"");$("#westDiagnosis").attr("val",empi.diagnosisCode!=null?empi.diagnosisCode:"")}}else{diagnosis=empi.DiagnosisList}$("#chineseTraDiagnosis").val(empi.CHINESE_TRA_DIAGNOSIS!=null?empi.CHINESE_TRA_DIAGNOSIS:"");$("#chineseTraDiagnosis").attr("val",empi.CHINESE_DIAGNOSIS_CODE!=null?empi.CHINESE_DIAGNOSIS_CODE:"");bodyClone.find(".china-advice").val("");bodyClone.find(".diagnosis").text((diagnosis||"-")).attr("title",(diagnosis||"-"));bodyClone.find(".diagnosis").attr("cn_medical_id",(empi.CN_MEDICAL_ID||""));var addDate=(recipe&&recipe.addDate)?recipe.addDate:_.now();bodyClone.find(".add-date").text(Utils.timeStampToDateStr(addDate,7));bodyClone.find(".doctorName").text(empi.DOCTOR_NAME||"");if(!tcmp.isShowFee){bodyClone.find(".china-totalPrice2").parent().hide();bodyClone.find(".china-totalPrice").text("-")}if(!tcmp.isModifyPrice){bodyClone.find(".china-totalPrice2").attr("disabled","disabled")}else{bodyClone.find(".china-totalPrice2").removeAttr("disabled")}if(recipe){if(recipe.isSend==0&&recipe.isPay==0){bodyClone.find(".china-agentQty").addClass("validate(required,maxlength(2),min(1),digits)");bodyClone.ketchup()}else{bodyClone.addClass("readonly");bodyClone.find(".importInfo").addClass("readonly");bodyClone.find(".already-importInfo").addClass("readonly");bodyClone.find(".recipe-info").addClass("readonly");bodyClone.find(".pill-list-hint").addClass("readonly");bodyClone.find(".pill-bottom-info").addClass("readonly")}bodyClone.find(".pill-status>i").attr("class",tcmp.getPrescriptionStauts(recipe.isPay,recipe.isSend))}else{bodyClone.find(".china-agentQty").addClass("validate(required,maxlength(2),min(1),digits)");bodyClone.ketchup()}tcmp.initPrescriptionType(bodyClone);tcmp.initDrugSource(bodyClone);tcmp.initUseUnit(bodyClone);tcmp.initFrequencyDropBox(bodyClone);tcmp.initProcessingProject(bodyClone);bodyClone.find(".china-agentQty").bind("input propertychange",function(){var cellsParent=$(this).parents(".pill-wrap").find(".pill-list-content");tcmpUtils.calcTotalPrice(cellsParent);tcmpUtils.calcTotalWeight(cellsParent)});tcmp.initalHerbalRecipesThinkBox(bodyClone.find(".thinkBoxInputArea"),index);if(isCurrent){tcmp.drugWithdrawalView(index)}return bodyClone},addPrescriptionBodyData:function(bodyClone,recipe){bodyClone.find(".china-agentQty").val(recipe.agentQty);var totalPrice=prescriptionPrint.toDecimal4(recipe.totalPrice);if(_.isNumber(recipe.totalPrice)){bodyClone.find(".china-totalPrice2").val(totalPrice)}if(!tcmp.isShowFee){totalPrice="-"}bodyClone.find(".china-totalPrice").text(totalPrice);bodyClone.find(".china-advice").val(recipe.advice).blur();if(Utils.isBlank(recipe.frequencyId)){tcmp.setFrequencyDown(bodyClone,recipe.frequencyId)}bodyClone.find(".use-level").val(recipe.useNum);bodyClone.find(".use-unit").SetWJZSDropdownSelectedData(recipe.useUnit);if(null!=recipe.recipeTreatmentList&&recipe.recipeTreatmentList.length>0){var extraChargePop=bodyClone.find(".extraChargePop");var sumProjecPrice=0;var projectNames="";_.each(recipe.recipeTreatmentList,function(item,key){var newAtr=extraChargePop.find(".tp_newtr").clone().removeClass("tp_newtr");projectNames+=item.treatmentName+"，";sumProjecPrice+=item.totalPrice;newAtr.find(".tp_newtr").before(extraChargePop.find(".tp_newtr").clone().removeClass("tp_newtr"));newAtr.find(".projectPrice").val(item.treatmentPrice);newAtr.find(".projectNum").val(item.treatmentNum);newAtr.find(".projectName").attr("disabled","disabled").val(item.treatmentName);newAtr.find(".projectId").attr("treatmentUnit",item.treatmentUnit).attr("treatmentUnitName",item.treatmentUnitName).val(item.treatmentId);newAtr.find(".totalProjectPrice").val(Utils.changePrice(item.totalPrice));newAtr.find(".delete-row").text("删除");extraChargePop.find(".tp_newtr").before(newAtr)});sumProjecPrice=Utils.changePrice(sumProjecPrice);tcmp.removeTableTR();tcmp.showExtraCharge(bodyClone,sumProjecPrice,projectNames);bodyClone.find(".extraCharge-Num").text(recipe.recipeTreatmentList.length).show();bodyClone.find(".sumProjectprice").val(sumProjecPrice);extraChargePop.ketchup()}bodyClone.find(".drugType").checkedItem([{orderIndex:recipe.drugType}]);var TotalDrugType=recipe.drugType;if(TotalDrugType==0){bodyClone.find(".drugSpecification").text("饮片")}else{bodyClone.find(".drugSpecification").text("颗粒")}var obj=bodyClone.find(".thinkBoxInputArea");if(obj.data("typeahead")){obj.data("typeahead").options.extraParams.drugSortId=bodyClone.find(".drugType").getCheckedData()[0].parameterValue;obj.data("typeahead").cache.flush()}bodyClone.find(".eatRequire").checkedItem([{id:recipe.eatRequire}]);var recipeCnList=recipe.recipeCnList;bodyClone.find(".already-importInfo .china-agentQty").text(recipe.agentQty);var aa=eval("eatRequire["+recipe.eatRequire+"]");bodyClone.find(".already-importInfo .china-advice").text((recipe.eatRequire==1?"外用":"内服")+(Utils.notBlank(recipe.frequencyName)?"，"+recipe.frequencyName:"")+(Utils.notBlank(recipe.useNum)?"，每次"+recipe.useNum+(recipe.useUnit||"ml"):"")+(Utils.notBlank(recipe.advice)?"，"+recipe.advice:""));bodyClone.find(".already-importInfo .already-herbs >span").text(recipeCnList.length);var tempDrugIds=[];for(var j=0;recipeCnList[j];j++){var recipeCn=recipeCnList[j];tempDrugIds.push(recipeCn.drugId)}var pageCount=parseInt((recipeCnList.length+27-1)/27);bodyClone.find(".page").text(pageCount);var drugDataList=tcmp.getMdcDictDrugWithId(tempDrugIds);for(var j=0;recipeCnList[j];j++){var recipeCn=recipeCnList[j];var tempDrugObj=tcmp.searchDrugFromDrugList(drugDataList,recipeCn.drugId);if(recipeCn.drugId==null||recipeCn.drugId==""){tempDrugObj={DRUG_DOSE_UNIT_NAME:recipeCn.drugUnitName,DRUG_NAME:recipeCn.pDrugName,PDRUG_ID:recipeCn.pDrugId,DRUG_ID:recipeCn.drugId,DRUG_RETAIL_PRICE:recipeCn.unitPrice}}if(tempDrugObj){tempDrugObj.DRUG_NAME=recipeCn.drugName;tempDrugObj.DRUG_RETAIL_PRICE=recipeCn.unitPrice;var cell=tcmp.addPrescriptionCell(bodyClone);tcmp.addPrescriptionCellData(cell,tempDrugObj,recipeCn.drugDose,recipeCn.footnote,recipeCn.footnoteName,recipeCn.drugSource,recipe.recipeName);cell.attr("recipecnid",recipeCn.recipeCnId);if(recipe.isSend==0&&recipe.isPay==0){}else{cell.find(".delete-herbal").removeClass("delete-herbal")}}}bodyClone.find(".dose-herbs >span").text(recipeCnList.length);var cellParent=bodyClone.find(".pill-list-content");tcmpUtils.calcTotalWeight(cellParent)},addPrescriptionCell:function(b){var a=b.find(".prescription-cell-clone").clone(true).removeClass("prescription-cell-clone").show();b.find(".pill-list-content ul").append(a);b.find(".pill-list-content>ul").show();b.find(".pill-list-content>.without-drugs").hide();b.find(".pill-list-hint>i").show();b.find(".pill-list-content").scrollTop(1000000);return a},addPrescriptionCellData:function(a,b,e,g,f,d,c){b.drugSource=d;a.data("drug",b);a.data("drugDose",e);a.data("footnote",g);a.data("drugSource",d);a.find(".china-drugDose").text(e);a.find(".china-drugUnitName").text(b.DRUG_DOSE_UNIT_NAME);a.find(".china-drugName").text(b.DRUG_NAME).attr("title",b.DRUG_NAME);if(f=="请选择"||!f){f="";a.find(".separator").hide()}else{a.find(".separator").show()}a.find(".drugUsage").text(f).attr("title",f);if(d==1){a.addClass("outsourcing")}else{if(d==2){a.addClass("forFree")}else{if(d==3){a.addClass("outFry")}else{a.removeClass("outsourcing").removeClass("forFree")}}}tcmp.addDrugIdArr(c,b.DRUG_ID)},getHerbalRecipesData:function(h){var b=[];var k=$(".left-prescription .pill-wrap");var e=k.length;for(var d=1;d<=e-1;d++){if(!h){if($($(".recipe-label-item")[d]).hasClass("readonly")){continue}}var f=$(".recipe-label .recipe-label-item:eq("+d+")").attr("data-index");var a=tcmp.getCheckedHerbalRecipeData($(k[d]),d);if(null==a.recipeCnList||a.recipeCnList.length<1){return{code:1,errorMsg:"处方"+f+"无中药，请添加！",data:b}}if(!a.agentQty){return{code:1,errorMsg:"处方"+f+"无剂数，请添加！",data:b}}if(!a.totalPrice){return{code:1,errorMsg:"处方"+f+"无总金额，请添加！",data:b}}if(prescriptionPrint.toDecimal4(a.totalPrice).length>12){return{code:1,errorMsg:"处方"+f+"总金额输入过大，请重新输入！",data:b}}b.push(a)}for(var c=0;tcmp.deleteRecipeCnArr[c];c++){var g={recipeId:tcmp.deleteRecipeCnArr[c].recipecnid,delFlag:1,remark:tcmp.deleteRecipeCnArr[c].id,};b.push(g)}return{code:0,errorMsg:"",data:b}},getCheckedHerbalRecipeData:function(c,e){var l=$(c).find(".pill-list-content ul li");var p=l.length;var n=$(".recipe-label .recipe-label-item:eq("+e+")").attr("data-index");var m=$(l[1]).find(".china-drugName").text();if(p==1){if(m==null||m==""||m==undefined){return n}}var a=[];_.each($(c).find(".extraChargePop tr"),function(s,j){var i=$(s).find(".projectId").val();if(i!=null&&i!=""){var r={treatmentPrice:$(s).find(".projectPrice").val(),treatmentNum:$(s).find(".projectNum").val(),totalPrice:$(s).find(".totalProjectPrice").val(),treatmentName:$(s).find(".projectName").val(),treatmentId:i,treatmentUnit:$(s).find(".projectId").attr("treatmentUnit"),treatmentUnitName:$(s).find(".projectId").attr("treatmentUnitName")};a.push(r)}});var k=[];var h=$(".recipe-label .recipe-label-item:eq("+e+")").attr("data-id");for(var d=1;d<p;d++){var g=$(l[d]).data("drug");if(g.DRUG_NAME){var q={recipeCnId:$(l[d]).attr("recipecnid"),recipeId:h,acographyId:acographyId,clinicId:userInfo_aclc.clinicId,drugName:g.DRUG_NAME,footnote:$(l[d]).data("footnote"),footnoteName:$(l[d]).find(".drugUsage").attr("title"),drugSource:$(l[d]).data("drugSource"),drugDose:$(l[d]).data("drugDose"),drugPackageSpec:g.DRUG_PACKAGE_SPEC!="--"?g.DRUG_PACKAGE_SPEC:"",drugUnitName:g.DRUG_DOSE_UNIT_NAME,drugUnitId:g.DRUG_DOSE_UNIT_ID,unitPrice:g.DRUG_RETAIL_PRICE,pDrugId:g.PDRUG_ID,drugId:g.DRUG_ID};k.push(q)}}var b=$.trim($(c).find(".frequencyName").attr("val"));var f=$(c).find(".frequencyName").val();if(!b){f=""}var o={recipeId:h,acographyId:acographyId,clinicId:userInfo_aclc.clinicId,recipeName:n,agentQty:$(c).find(".china-agentQty").val(),recipeTreatmentList:a,totalPrice:$(c).find(".china-totalPrice2").val(),drugType:$(c).find(".drugType").getCheckedData()[0].orderIndex,eatRequire:$(c).find(".eatRequire").getCheckedData()[0].id,advice:$(c).find(".china-advice").val(),recipeCnList:k,prescriptionId:$(c).find(".pill-list-content").attr("data-prescriptionId"),frequencyId:b,frequencyName:f,useNum:$.trim($(c).find(".use-level").val()),useUnit:$(c).find(".use-unit").attr("val")};return o},showExtraCharge:function(d,g,b){var c="";var f="";if(b){var a="";if(tcmp.isShowFee){a="<span class='total-number'>￥"+g+"</span>，包括";f="￥"+g}b=b.substr(0,b.length-1)+"。";var e="附加费："+b;c="附加费"+a+"："+b;d.find(".extraCharge-item").attr("title",b).text(e)}else{d.find(".extraCharge-Num").hide();d.find(".extraCharge-item").text("添加附加费")}d.find(".extraCharge-money").text(f);d.find(".already-importInfo .processingProject").append(c)},getWestDiagnosis:function(){var e=[];var b=$("#westDiagnosis").attr("val");var c=$("#westDiagnosis").val();if(c!=null&&c!=undefined&&c!=""){if(b!=null&&b!=undefined){var d={};d.diagnosisIcd10=$("#westDiagnosis").val();d.diagnosisIcd10Code=$("#westDiagnosis").attr("val");e.push(d)}else{var a={};a.diagnosis=c;e.push(a)}}return e},renderResableMecdtion:function(d){var h=[];if(d){var o=d;for(var p=0;p<o.length;p++){var e={title:null,msg:[]};var f=o[p];e.title="草药处方"+f.warningMsg;var r=f.result.resultCode;if("000000"!=r){continue}if(f.result.result){for(var n=0;n<f.result.result.length;n++){var s=f.result.result[n];if(s.hitSize=="0"){continue}e.msg.push(s.msg);if(s.results){for(var m=0;m<s.results.length;m++){var c=s.results[m];e.msg.push(c.violationDetails[0].ruleMsg)}}}}else{e.msg.push(f.result.msg)}h.push(e)}}if(h&&h.length>0){var b="";for(var m=0;m<h.length;m++){var a=h[m];var q=a.title;for(var g=0;g<a.msg.length;g++){b+='<div class="drugs_line_wrap clear"><span>'+q+"&nbsp;&nbsp;&nbsp;&nbsp;"+a.msg[g]+'</span><span class="testing_reason"></span></div>'}}if(Utils.isBlank(b)){$("#drugs_testing").attr("style","display:block");$("#drugs_testing").find(".popcontent").html(b)}}},saveHerbalRecipesList:function(b){var a={url:ContextClinc_Server+"TCMPrescription/saveHerbalRecipesList",dataType:"json",data:JSON.stringify(b),showMask:true,contentType:"application/json; charset=utf-8"};var c=Utils.myAjaxHandler(a);c.done(function(g){if(g.errorCode==SUCCESSCODE){if(g.data&&g.data.length>0){var e="";for(var d=0;g.data[d];d++){e+="处方"+g.data[d]+"，"}$.paWarn(e.substr(0,e.length-1)+"已发药或已收费,不允许修改！")}else{$.paSuccess("保存成功！");audit_Btn.tcm.auditRecipe(0)}tcmp.drugIdArr=[];tcmp.deleteRecipeCnArr=[];var f=$(".recipe-label-item.checked").attr("data-index");tcmp.getHerbalRecipes(empiId,acographyId,f);RMUilts.action(b,tcmp.renderResableMecdtion);return}else{$.paError(g.errorCode+"：保存中药处方失败！")}})},saveCnMedical:function(){var d=tcmp.getWestDiagnosis();var a=$("#chineseTraDiagnosis").val();var c=$("#chineseTraDiagnosis").attr("val");var e={medicalId:$(".diagnosis:visible").attr("cn_medical_id"),acographyId:acographyId,empiId:empiId,chineseTraDiagnosis:a,chineseDiagnosisCode:c!=null?c:"",dwsDiagnosisRecordList:d};var b={url:ContextClinc_Server+"TCMPrescription/saveCnMedical",dataType:"json",data:JSON.stringify(e),showMask:true,async:false,contentType:"application/json; charset=utf-8"};var f=Utils.myAjaxHandler(b);f.done(function(h){if(h.errorCode==SUCCESSCODE){$.paSuccess("保存成功！");var g=tcmp.empi;g.CHINESE_TRA_DIAGNOSIS=a;g.CHINESE_DIAGNOSIS_CODE=c;if(d&&d.length>0){if(null!=d[0].diagnosis){a+="；"+d[0].diagnosis;g.DiagnosisList=d[0].diagnosis}else{g.DiagnosisList=d[0].diagnosisIcd10;g.diagnosisCode=d[0].diagnosisIcd10Code;a+="；"+d[0].diagnosisIcd10}}else{g.DiagnosisList="";$("#westDiagnosis").removeAttr("val")}$(".diagnosis").text(a||"-").attr("title",(a||"-"));$("#addDiagnosisPop").addClass("dsn")}else{$.paError(h.errorCode+"：修改中医诊断失败！")}})},drugWithdrawal:function(b){var a={url:ContextClinc_Server+"TCMPrescription/cnDrugWithdrawal",dataType:"json",data:JSON.stringify(b),showMask:true,contentType:"application/json; charset=utf-8"};var c=Utils.myAjaxHandler(a);c.done(function(e){if(e.errorCode==SUCCESSCODE){$.paSuccess("保存成功！");var d=$(".recipe-label-item.checked").attr("data-index");tcmp.getHerbalRecipes(empiId,acographyId,d);return}else{$.paError(e.errorCode+"：退药失败！")}})},deleteHerbalRecipesTab:function(b){var a=b.parent().attr("data-index");b.parent().remove();$(".left-prescription > .pill-wrap[data-index="+a+"]").remove();$(".recipe-label>ul>li:eq(1)").addClass("checked").siblings().removeClass("checked");$(".left-prescription > .pill-wrap:eq(1)").show().siblings(".pill-wrap").hide();tcmp.cleanDrugData(a)},cleanDrugData:function(b){var a=b.length;tcmp.drugIdArr=_.reject(tcmp.drugIdArr,function(c){return _.isEqual(c.substr(0,a),b)})},initChiefComThinkInput:function(){var c={canedit:true,columns:[{display:"编码",dataKey:"DICT_DIAGNOSIS_CODE",width:60},{display:"名称",dataKey:"DICT_DIAGNOSIS_NAME",width:230}],extraParams:{key:"keyword",pageSize:20,diagonsisType:"0",isJoinMI:isYbReg==1?1:0},selectFirst:true,formatResult:function(d){return},formatMatch:function(f,e,d){return f.DICT_DIAGNOSIS_NAME+"--"+f.DICT_DIAGNOSIS_CODE+"--"+f.PY_CODE+"--"+f.WB_CODE},matchContains:"word",autoFill:false,width:485,max:100,multiple:false,multipleSeparator:", ",highlight:function(e,d){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+d.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:180};var a={canedit:true,columns:[{display:"编码",dataKey:"DICT_DIAGNOSIS_CODE",width:60},{display:"名称",dataKey:"DICT_DIAGNOSIS_NAME",width:230}],extraParams:{key:"keyword",pageSize:20,diagonsisType:"1"},selectFirst:true,formatResult:function(d){return},formatMatch:function(f,e,d){return f.DICT_DIAGNOSIS_NAME+"--"+f.DICT_DIAGNOSIS_CODE+"--"+f.PY_CODE+"--"+f.WB_CODE},matchContains:"word",autoFill:false,width:485,max:100,multiple:false,multipleSeparator:", ",highlight:function(e,d){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+d.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:180};var b=ContextClinc_Server+"dwsCnMedical/getMdcDictChiefComplaint";document.getElementById("westDiagnosis").oninput=function(){$("#westDiagnosis").attr("val","")};document.getElementById("chineseTraDiagnosis").oninput=function(){$("#chineseTraDiagnosis").attr("val","")};$("#westDiagnosis").autocomplete(b,c).result(function(d,f,e){$("#westDiagnosis").val(f.DICT_DIAGNOSIS_NAME);$("#westDiagnosis").attr("val",f.DICT_DIAGNOSIS_CODE)});$("#chineseTraDiagnosis").autocomplete(b,a).result(function(d,f,e){$("#chineseTraDiagnosis").val(f.DICT_DIAGNOSIS_NAME);$("#chineseTraDiagnosis").removeClass("pawjzs-error");$("#chineseTraDiagnosis").attr("val",f.DICT_DIAGNOSIS_CODE)})},initalHerbalRecipesThinkBox:function(g,c){var d=[{display:"中药名称",dataKey:"DRUG_NAME",width:100},{display:"规格",dataKey:"DRUG_PACKAGE_SPEC",width:90},{display:"库存",dataKey:"SHOW_STORE_VALIDE_QTY",width:120}];if(tcmp.isYBFlag){var e={display:"医保属性",dataKey:"FEE_LEVEL",width:60};d.splice(1,0,e)}if(tcmp.isShowFee){var h={display:"价格(¥)",dataKey:isYbReg!=="1"&&tcmp.isYBFlag?"CEILING_PRICE":"DRUG_RETAIL_PRICE",width:60};d.splice(d.length-1,0,h)}var f=$(".pill-wrap[data-index="+c+"]").find(".drugType").getCheckedData()[0].parameterValue;var b={columns:d,extraParams:{key:"keyword",limitRows:20,drugPropType:1,drugSortId:f},rowHighlight:function(j){var i=false;if(tcmp.isYBFlag){if(j.FEE_LEVEL=="未对照"){i=true}}return i},wrapperHandle:".tab-content",selectFirst:true,matchContains:"word",autoFill:false,width:560,formatResult:function(i){return i.DRUG_NAME},formatMatch:function(l,k,j){return l.DRUG_NAME+"--"+l.DRUG_CODE+"--"+l.PY_CODE+"--"+l.WB_CODE},multiple:false,multipleSeparator:", ",highlight:function(j,i){return j.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+i.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:180};var a=ContextClinc_Server+"drugAPI/getMdcDictDrug";g.autocomplete(a,b).result(function(l,n,m){if(n){n.DRUG_RETAIL_PRICE=(isYbReg!=="1"&&tcmp.isYBFlag?n.CEILING_PRICE:n.DRUG_RETAIL_PRICE);var k=g.parents(".drug-input").find(".drug-source").attr("val");n.drugSource=k;if(n.DRUG_USAGE_ID){var j=_.find(tcmp.prescriptionType,function(o){return o.dictItemId==n.DRUG_USAGE_ID});if(j){g.parents(".drug-input").find(".china-footnote").SetWJZSDropdownSelectedData(j.dictItemCode)}}var i=n.DRUG_DOSE;if(tcmp.isStockCheck&&k!=1&&k!=3){if(n.DRUG_STORE_UNIT_QTY>0){g.data("drug",n);g.parents(".drug-input").find(".china-drugUnitName").text(n.DRUG_DOSE_UNIT_NAME);g.parents(".drug-input").find(".china-drugDose").val(i).focus()}else{$.paWarn("该中药暂无库存！");g.val("").focus()}}else{g.data("drug",n);g.parents(".drug-input").find(".china-drugUnitName").text(n.DRUG_DOSE_UNIT_NAME);g.parents(".drug-input").find(".china-drugDose").val(i).focus()}}})},deleteRecipeCn:function(b){var d="";var c={recipeId:b};var a={url:ContextClinc_Server+"TCMPrescription/deleteRecipeCn",dataType:"json",data:c,showMask:true,contentType:"application/x-www-form-urlencoded",async:false};var e=Utils.myAjaxHandler(a);e.done(function(f){if(f.errorCode==SUCCESSCODE){if(f.data<1){$.paWarn("处方已发药或已收费，不允许删除该处方！");d="error"}}else{$.paError("删除处方失败！")}});return d},setSelectValue:function(b,a){$(b).find("input").attr("val",a);$(b).find("input").val($(b).find(".drop-item[data-value='"+a+"']").text())},makeReadonlyView:function(){$(".4editpage").hide();$(".4editnoshowweight").hide();$(".default").show();$(".already-importInfo").show();$(".importInfo").hide();$(".add-recipe").hide();$(".delete").hide();$(".quote").hide();$(".recipe-info").hide();$(".pill-list-hint").show();$(".pill-bottom-info").show();$(".save").text("修改");$(".allowEdit").attr("disabled","disabled");$(".recipe-template-item").removeClass("china-tmpl-dd");$(".pill-status>i.changes").removeClass("changes").addClass("submitted");$(".copyPrescription").hide();$(".editorBtn").hide();$(".icon-tips").hide();finishPatFlag=true},makeEditView:function(){if(tcmp.isShowWeight){$(".4editpage").show();$(".4editnoshowweight").hide()}else{$(".4editnoshowweight").show();$(".4editpage").hide()}$(".default").hide();$(".already-importInfo.readonly").show();$(".already-importInfo:not(.readonly)").hide();$(".importInfo:not(.readonly)").show();$(".importInfo.readonly").hide();$(".add-recipe").show();$(".delete").show();$(".quote").show();$(".hideQuote").hide();$(".recipe-info:not(.readonly)").show();$(".recipe-info.readonly").hide();$(".pill-list-hint:not(.readonly)").hide();$(".pill-list-hint.readonly").show();$(".pill-bottom-info:not(.readonly)").hide();$(".pill-bottom-info.readonly").show();$(".drugType").cancelDisabledAll();$(".eatRequire").cancelDisabledAll();$(".importInfo .processingProject").cancelDisabledAll();$(".save").text("保存");$(".allowEdit").removeAttr("disabled");$(".recipe-template-item").addClass("china-tmpl-dd");$(".pill-status>i.submitted").removeClass("submitted").addClass("changes");tcmp.checkCellLowStock();$(".thinkBoxInputArea").focus();$(".editorBtn").show();$(".copyPrescription").show();finishPatFlag=false;$(".icon-tips").show()},checkCellLowStock:function(){$.each($(".left-prescription .pill-wrap:gt(0)"),function(a,c){if($(this).find(".pill-status>i.submitted").length>0||$(this).find(".pill-status>i.changes").length>0){var b=$(this).find(".pill-list-content");tcmpUtils.calcTotalPrice(b,true);tcmpUtils.calcTotalWeight(b)}})},getMdcDictDrugWithId:function(b){var e=null;if(b&&b!=""){var d={drugIds:b};var a={type:"POST",method:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"intentInput/getMdcDictDrugWithDrugId",data:JSON.stringify(d),dataType:"json",async:false};var c=Utils.myAjaxHandler(a);c.done(function(f){if(!f.errorMessage){e=f.data}else{$.paError(f.errorMessage,null);return}}).fail(function(f){$.paError("请求异常",null)}).always(function(){})}return e},getMdcTreatementWithIds:function(c){var b=null;var a={url:ContextClinc_Server+"intentInput/getMdcDictTreatmentByIds",dataType:"json",contentType:"application/json",data:JSON.stringify(c),async:false};var d=Utils.myAjaxHandler(a);d.done(function(e){if(!e.errorMessage){b=e.data}else{$.paError(e.errorMessage,null);return}}).fail(function(e){$.paError("请求异常",null)}).always(function(){});return b},searchDrugFromDrugList:function(c,a){var b=null;if(c&&c.length>0&&a&&a!=""){$.each(c,function(e,f){var d=Utils.trimObj(f.DRUG_ID);if(d!=""&&d==a){b=f;return false}})}return b},prescriptionType:[],initPrescriptionType:function(a){if(tcmp.prescriptionType&&tcmp.prescriptionType.length==0){if(config_cache.getCache("md_dict")){tcmp.prescriptionType=config_cache.getCache("md_dict").T25}}var b={idKey:"dictItemCode",txtKey:"dictItemName",isNeedThink:true};a.find(".china-footnote").WJZSDropdown(tcmp.prescriptionType,b,function(c,d){})},initDrugSource:function(a){var b={isNeedClear:false};a.find(".drug-source").WJZSDropdown(this.drugSourceData,b,function(c,d){});a.find(".drug-source").SelectWJZSDropdownFirstItem()},initUseUnit:function(a){var c={isNeedClear:false};var b=[{id:"ml",txt:"ml"},{id:"g",txt:"g"}];a.find(".use-unit").WJZSDropdown(b,c,function(d,e){});a.find(".use-unit").SelectWJZSDropdownFirstItem()},initDrugType:function(){var b=_.filter(userInfo_aclc.clinicParams,function(c){return c.paramType==8});var a={type:"radio",idKey:"parameterValue",txtKey:"parameterName"};$(".importInfo .drugType").setInputForm(b,a,function(f,h){var c=false;var e="";$(".pill-list-content:visible").find(".pill-list-item:not(.prescription-cell-clone)").each(function(k){var j=$(this).data("drug");e=j.DRUG_SORT_ID;if(f.parameterValue!=e){c=true;return}});if(c){var d={msg:"当前处方中有非"+f.parameterName+"中药，是否清空？",cancelTxt:"否",saveTxt:"是",onYes:function(){tcmp.cleanAllDrug();var i=$(h).parents(".importInfo").find(".thinkBoxInputArea");if(i.data("typeahead")){i.data("typeahead").options.extraParams.drugSortId=f.parameterValue;i.data("typeahead").cache.flush()}else{return false}},onNo:function(){$(".importInfo:visible .drugType").checkedItem([{parameterValue:e}])}};$.paConfirm(d)}else{var g=$(h).parents(".importInfo").find(".thinkBoxInputArea");if(g.data("typeahead")){g.data("typeahead").options.extraParams.drugSortId=f.parameterValue;g.data("typeahead").cache.flush()}else{return false}}}).checkedItem([{orderIndex:"0"}])},initEatRequire:function(){$(".importInfo .eatRequire").setInputForm(this.eatRequire,null,function(a,b){}).checkedItem([{id:"0"}])},initProcessingProject:function(d){var c=[{display:"编码",dataKey:"TREATMENT_CODE",width:60},{display:"名称",dataKey:"TREATMENT_NAME",width:230},{display:"单价",dataKey:"TREATMENT_PRICE",width:40}];if(!tcmp.isShowFee){c=[{display:"编码",dataKey:"TREATMENT_CODE",width:60},{display:"名称",dataKey:"TREATMENT_NAME",width:230}]}var b={columns:c,extraParams:{key:"keyword",limitRows:20},selectFirst:true,formatResult:function(e){return e.TREATMENT_NAME},formatMatch:function(g,f,e){return g.TREATMENT_NAME+"--"+g.TREATMENT_CODE+"--"+g.PY_CODE+"--"+g.WB_CODE},matchContains:"word",autoFill:false,width:480,multiple:false,multipleSeparator:", ",highlight:function(f,e){return f.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+e.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:180};var a=ContextClinc_Server+"intentInput/getTreatmentItemAndExam";d.find(".extraChargePop .projectName").autocomplete(a,b).result(function(e,g,f){if(g){if(d.find(".extraChargePop tbody")&&d.find("tr:not('.dsn'):not('.tp_newtr')").length>4){$(this).val("");$.paWarn("一次只能添加四种附加费，请确认!");return}tcmp.newATr($(this),d);$(this).parents(".tp_newtr").addClass("cacheTr").removeClass("tp_newtr");$(this).siblings(".projectId").attr("treatmentUnit",g.TREATMENT_UNIT).attr("treatmentUnitName",g.TREATMENT_UNIT_NAME).val(g.TREATMENT_ID);$(this).parent().siblings(".price").children().val(Utils.changePrice(g.TREATMENT_PRICE));$(this).parent().siblings(".treatnum").children().val(1).focus().select();$(this).parent().siblings(".deleteTd").children("span").text("删除");$(this).attr("disabled","disabled");$(this).off();tcmpUtils.calcProjectPrice(d)}});d.find(".extraChargePop .projectNum").bind("input propertychange",function(){tcmpUtils.calcProjectPrice(d)});tcmp.removeTableTR()},initTcmAdvice:function(){var a="";_.each(config_cache.getCache("tcmAdivice"),function(c,b){a+="<li>"+c.adviceName+"</li>"});$("#comUsedPop .comUsed-cont").append(a)},newATr:function(c,b){var a=$(c).parents("tr").clone();a.find(".projectName").val("");$(c).parents("tr").after(a);b.find(".extraChargePop").ketchup();tcmp.initProcessingProject(b)},removeTableTR:function(a){$(".extraChargePop .delete-row").off("click").on("click",function(){$(this).parent().parent().addClass("dsn")})},initFrequencyDropBox:function(a){var c=[];var b={idKey:"DRUG_FREQUENCY_ID",txtKey:"REMARK"};a.find(".frequencyName").WJZSDropdown(config_cache.getCache("drugFrequency"),b,function(d,e){if(!$.trim(e.DRUG_FREQUENCY_ID)){a.find(".frequencyName").val("")}})},setFrequencyDown:function(a,b){a.find(".frequencyName").SetWJZSDropdownSelectedData(b)},cleanAllDrug:function(){var a=$(".pill-wrap:visible").attr("data-index");$(".pill-wrap:visible").find(".pill-list-item").each(function(c){var d=$(this).attr("recipecnid");if(d){tcmp.deleteRecipeCnArr.push({id:a,recipecnid:d})}});var b=$(".pill-list-content:visible");tcmp.cleanDrugData(a);b.find(".pill-list-item:not(.prescription-cell-clone)").remove();tcmpUtils.calcTotalPrice(b);tcmpUtils.calcTotalWeight(b);$(".pill-list-content:visible>ul").hide();$(".pill-list-content:visible>.without-drugs").show();$(".pill-list-hint:visible>i").hide();tcmp.cleanDrugInput($(".drug-input:visible"));tcmp.revertAddStatus($(".drug-input:visible"))},isLowStock:function(b,a,f,e,d){var c=false;if(b*a>d){c=true}return c},};function TCMPrescriptionTmpl(){this.templateLevel=[{id:"3",txt:"个人模板"},{id:"2",txt:"诊所模板"}]}TCMPrescriptionTmpl.prototype={init:function(){tcmpTmpl.initClickBtn()},initClickBtn:function(){$(".tmpl-css-wrap").delegate(".china-tmpl-dd","click",function(){if(!tcmp.isReadOnly){var a=$(this).attr("data-id");var b=tcmpTmpl.getChinaTmplMedicienDtl(a);tcmpTmpl.chinaTmplUse(b,1)}});$(".content-inner .popup-model dt").on("click",function(b){var a=$(this).parents("dl").find("dd").is(":visible");if(!a){$(this).parents("dl").siblings().find("dd").hide();$(this).parents("dl").find("dd").show()}else{$(this).parents("dl").find("dd").hide()}});$(".saveAs").off("click").on("click",function(){$(".popup-model").hide();var a={msg:'<div class="clear" style="margin-bottom: 12px; padding-left: 18px;"><div class="fl" style="color:#5c5c5c;">模板级别：</div><div class="template-level"><span class="radio checked" val="3" onclick="tcmpTmpl.checkRadio(this)" >个人模板</span><span class="radio" val="2" onclick="tcmpTmpl.checkRadio(this)">诊所模板</span></div></div><i class="necessary">*</i>模板名称：<input type="text" class="input-text validate(notEmpty,required,maxlength(30))" maxlength="30" id="templateName">',cancelTxt:"取消",saveTxt:"确认",onYes:function(){var b=$.trim($("#templateName").val());if(!$("#cfm-msg").ableToFinish()){return}var d=$(".template-level .radio.checked").attr("val");if(!tcmpTmpl.checkCnRecipeTmplName(b,d)){$.paWarn("模板名称已经存在!");$("#templateName").addClass("tmpl_input_rename")}else{var c=$(".dose-usage-number").ableToFinish();var e=$("#cfm-msg").ableToFinish();if(!c||!e){return}$("#pa-confirm").remove();tcmpTmpl.saveCnRecipeTmpl(b,d)}}};tcmpTmpl.paConfirm(a)});$(".copyPrescription").off("click").on("click",function(){var c=$(".recipe-label-item.checked").attr("data-index");var f=$(".left-prescription > .pill-wrap[data-index="+c+"]");var d=f.find(".pill-list-item").length;if(d>1){if($(".recipe-label ul li").length>tcmp.herbalRecipesMaxNum){$.paWarn("最多只能添加六个处方");return}var b=parseInt($(".recipe-label").find("ul li:last").attr("data-index"))+1;tcmp.addPrescriptionTab(true,true,b);tcmp.addPrescriptionBody(true,b,tcmp.empi);var a=$(".left-prescription .pill-wrap:last");$(".recipe-label .recipe-label-item:last").siblings(".recipe-label-item").removeClass("current");a.show().siblings(".pill-wrap").hide();var e=tcmp.getCheckedHerbalRecipeData(f,b);tcmpTmpl.quoteRecipe(a,b,e,4)}else{$.paWarn("请为处方先添加药品!")}});$("body").delegate(".recipe-template-title-li","click",function(){$(this).toggleClass("collapse");var a=$(this).next();a.slideToggle()});$("#teml_btn_search").off("click").on("click",function(){var a=$(".templateName").val();tcmpTmpl.getChinaTmplMedicien(a)})},checkRadio:function(a){if(!$(a).hasClass("checked")){$(a).addClass("checked");$(a).siblings().removeClass("checked")}},chinaTmplInfoMap:{},getChinaTmplMedicien:function(a){var c={templateName:a};var b={url:ContextClinc_Server+"DwsRecipeTmpl/getRecipeCnImpl",dataType:"json",data:c,contentType:"application/x-www-form-urlencoded"};var d=Utils.myAjaxHandler(b);d.done(function(l){if(l.errorCode==SUCCESSCODE){if(l.data.length<1){return}var g=l.data;tcmpTmpl.chinaTmplInfoMap=g;$("#china-tmpl-doctor-ul li:not(.china-tmpl-dd-doctor-clone)").remove();$("#china-tmpl-clinic-ul li:not(.china-tmpl-dd-clinic-clone)").remove();$("#china-tmpl-platform-ul li:not(.china-tmpl-dd-platform-clone)").remove();var h=g.user;var k=g.clinic;for(var f=0;h[f];f++){var m=$('<li class="recipe-template-item china-tmpl-dd" title=""></li>');m.attr("id","");m.attr("data-id",h[f].recipetmplId);var e=h[f].templateName;m.text(e);m.attr("title",e);m.attr("template-type",3);$("#china-tmpl-doctor-ul").append(m)}for(var f=0;k[f];f++){var m=$('<li class="recipe-template-item china-tmpl-dd" title=""></li>');m.attr("id","");m.attr("data-id",k[f].recipetmplId);var e=k[f].templateName;m.text(e);m.attr("title",e);m.attr("template-type",2);$("#china-tmpl-clinic-ul").append(m);$("#china-tmpl-clinic-ul").parent().hide()}if(h&&h.length>0){if(!$("#china-tmpl-doctor-dl").hasClass("collapse")){$("#china-tmpl-doctor-dl").toggleClass("collapse");var j=$("#china-tmpl-doctor-dl").next();j.slideToggle()}}else{if(k&&k.length>0){if(!$("#china-tmpl-clinic-dl").hasClass("collapse")){$("#china-tmpl-clinic-dl").toggleClass("collapse");var j=$("#china-tmpl-clinic-dl").next();j.slideToggle()}}}}else{$.paError(l.errorCode+"：查询到中药处方模板失败！")}})},getChinaTmplMedicienDtl:function(c){var a=null;var d={recipeTmplId:c};var b={url:ContextClinc_Server+"dwsRecipeCnTmpl/getRecipeCnTmpl",dataType:"json",data:d,async:false,contentType:"application/x-www-form-urlencoded"};var e=Utils.myAjaxHandler(b);e.done(function(f){if(f.errorCode==SUCCESSCODE){a=f.data}else{$.paError(f.errorCode+"：查询到中药处方模板明细失败！");return}});return a},chinaTmplUse:function(f,e){var c=$(".recipe-label-item.checked").attr("data-index");var d=$(".left-prescription > .pill-wrap[data-index="+c+"]").find(".pill-list-item").length;if(d>1){if($(".recipe-label ul li").length>tcmp.herbalRecipesMaxNum){$.paWarn("最多只能添加六个处方");return}var c=parseInt($(".recipe-label").find("ul li:last").attr("data-index"))+1;tcmp.addPrescriptionTab(true,true,c);tcmp.addPrescriptionBody(true,c,tcmp.empi);var a=$(".left-prescription .pill-wrap:last");var b=$(".recipe-label .recipe-label-item:last").attr("data-index");$(".recipe-label .recipe-label-item:last").siblings(".recipe-label-item").removeClass("current");$(".left-prescription > .pill-wrap[data-index="+b+"]").show().siblings(".pill-wrap").hide();tcmpTmpl.quoteRecipe(a,b,f,e)}else{var a=$(".left-prescription > .pill-wrap[data-index="+c+"]");tcmpTmpl.quoteRecipe(a,c,f,e)}},quoteRecipe:function(j,l,n,m){var c=(m==1)?n.recipeCnTmplList:n.recipeCnList;if(c&&c.length>0){var b=_.pluck(c,"drugId");var p=tcmp.getMdcDictDrugWithId(b);var i="";if((p&&p.length>0)||m==3){j.find(".thinkBoxInputArea").focus();j.find(".china-agentQty").val(n.agentQty);j.find(".china-agentQty").text(n.agentQty);j.find(".use-level").val((n.useNum||""));j.find(".use-unit").SetWJZSDropdownSelectedData(n.useUnit);if(Utils.isBlank(n.frequencyId)){tcmp.setFrequencyDown(j,n.frequencyId)}j.find(".china-advice").val((n.advice||""));j.find(".already-herbs >span").text(c.length);j.find(".dose-herbs >span").text(c.length);if(null!=n.recipeTreatmentList&&n.recipeTreatmentList.length>0){var d=j.find(".extraChargePop");var h=0;var g="";var o=_.pluck(n.recipeTreatmentList,"treatmentId");var k=tcmp.getMdcTreatementWithIds(o);if(null==k||o.length<1){$.paWarn("未查询到附加费项目");return}_.each(n.recipeTreatmentList,function(t,s){var v=_.filter(k,function(w){return w.TREATMENT_ID==t.treatmentId});if(null!=v&&v.length>0){var r=v[0];g+=r.TREATMENT_NAME+"，";var u=d.find(".tp_newtr").clone().removeClass("tp_newtr");var q=parseFloat(r.TREATMENT_PRICE)*parseFloat(t.treatmentNum);h+=q;u.find(".tp_newtr").before(d.find(".tp_newtr").clone().removeClass("tp_newtr"));u.find(".projectPrice").val(r.TREATMENT_PRICE);u.find(".projectNum").val(t.treatmentNum);u.find(".projectName").attr("disabled","disabled").val(r.TREATMENT_NAME);u.find(".projectId").val(t.treatmentId);u.find(".projectId").attr("treatmentUnit",r.TREATMENT_UNIT).attr("treatmentUnitName",r.TREATMENT_UNIT_NAME);u.find(".totalProjectPrice").val(Utils.changePrice(q));u.find(".delete-row").text("删除");d.find(".tp_newtr").before(u)}});h=Utils.changePrice(h);tcmp.removeTableTR();tcmp.showExtraCharge(j,h,g);j.find(".sumProjectprice").val(h);j.find(".extraCharge-Num").text(n.recipeTreatmentList.length).show();d.ketchup()}if(m==1){var a=p[0].DRUG_SORT_ID;j.find(".drugType").checkedItem([{parameterValue:a}]);var f=j.find(".thinkBoxInputArea");if(f.data("typeahead")){f.data("typeahead").options.extraParams.drugSortId=a;f.data("typeahead").cache.flush()}}else{j.find(".drugType").checkedItem([{orderIndex:n.drugType}]);var f=j.find(".thinkBoxInputArea");if(f.data("typeahead")){f.data("typeahead").options.extraParams.drugSortId=j.find(".drugType").getCheckedData()[0].parameterValue;f.data("typeahead").cache.flush()}}j.find(".eatRequire").checkedItem([{id:n.eatRequire}]);j.find(".china-totalPrice").val(n.totalprice);j.find(".china-totalPrice2").val(n.totalprice);if(m==3){j.find(".pill-list-content").attr("data-prescriptionId",n.prescriptionId)}_.each(c,function(s,u){var t=tcmp.searchDrugFromDrugList(p,s.drugId);if(t||m==3){var r=j.attr("data-index");var q=tcmp.addPrescriptionCell(j);if(!t&&m==3){t={DRUG_DOSE_UNIT_NAME:s.drugUnitName,DRUG_NAME:s.pDrugName,PDRUG_ID:s.pDrugId,DRUG_ID:s.drugId}}tcmp.addPrescriptionCellData(q,t,s.drugDose,s.footnote,s.footnoteName,s.drugSource,r)}else{if(!t&&m!=3){i+=s.drugName+","}}});var e=j.find(".pill-list-content");tcmpUtils.calcTotalPrice(e);tcmpUtils.calcTotalWeight(e)}else{$.each(c,function(q){i+=q.drugName+","});$.paWarn("字典表中查询不到引用的药品的相关数据,请手动填写处方");return}}else{$.paWarn("无模板数据,请手动填写处方");return}},checkCnRecipeTmplName:function(e,a){var c={};var b={url:ContextClinc_Server+"dwsRecipeCnTmpl/checkTmplName",dataType:"json",data:{tmplName:e!=null?e:"",tmplType:a,tmplId:null},async:false};var d=Utils.myAjaxHandler(b);d.done(function(f){if(f!=null&&f.errorCode==SUCCESSCODE){c=f.data}else{if(f!=null&&f.errorCode=="E1SP0002"){}else{$.paError(f.errorMessage)}}}).fail(function(f){$.paError("操作失败!")}).always(function(){});return c},paConfirm:function(d){$("body").append('<div id="pa-confirm" class="reveal-modal msg" style="height: 140px;"><span id="icon_close" class="icon_close"></span><div id="cfm-msg" class="show-msg"></div><div class="btn-bar"><span class="bn-size btn-default" id="pa-cancel"></span><span class="bn-size btn-success" id="pa-save"></span></div></div>');var e={msg:"是否确认执行该操作？",cancelTxt:"取消",saveTxt:"保存",onYes:function(){alert("无法获取确认操作的回调函数")},onNo:function(){$("#pa-confirm").remove()}};var c=$.extend({},e,d);var a="<input id='cfm-input' type='text' class='input-text'/>";var b=c.msg==="input"?"<span class='ipt-label'>"+c.label+"</span>"+a:c.msg;$("#cfm-msg").html(b);$("#cfm-msg").ketchup();$("#pa-cancel").text(c.cancelTxt);$("#pa-save").text(c.saveTxt);$("#pa-confirm").show();$("div.btn-bar span#pa-save").off("click").on("click",function(){c.onYes()});$("div.btn-bar span#pa-cancel,#icon_close").off("click").on("click",c.onNo);if(c.hideCancel){$("#pa-cancel").remove()}if(c.hideSave){$("#pa-save").remove()}},saveCnRecipeTmpl:function(n,e){var f=$(".recipe-label-item.checked").attr("data-index");var d=$(".pill-wrap[data-index="+f+"]");var k={templateName:n,recipetmplId:null,recipeType:2,templateType:e,recipeName:f,agentQty:d.find(".china-agentQty").val(),eatRequire:d.find(".eatRequire").getCheckedData()[0].id,advice:d.find(".china-advice").val(),totalPrice:d.find(".china-totalPrice2").val(),frequencyName:d.find(".frequencyName").val(),frequencyId:d.find(".frequencyName").attr("val"),useNum:d.find(".use-level").val(),useUnit:d.find(".use-unit").attr("val")};var h=d.find(".pill-list-content ul li");var l=h.length;var i=$(h[1]).find(".china-drugName").text();if(l==1){if(i==null||i==""||i==undefined){$.paWarn("处方"+f+"无中药信息，请添加！")}return}var g=[];for(var a=1;a<l;a++){var c=$(h[a]).data("drug");if(c.DRUG_NAME){var m={drugName:c.DRUG_NAME,drugSource:c.drugSource,footnote:$(h[a]).data("footnote"),drugDose:$(h[a]).data("drugDose"),drugUnitName:c.DRUG_DOSE_UNIT_NAME,drugUnitId:c.DRUG_DOSE_UNIT_ID,unitPrice:c.DRUG_RETAIL_PRICE,recipetmplId:null,recipecntmplId:null,drugId:c.DRUG_ID,orderNum:a};g.push(m)}}var b={};b.dwsRecipeTmpl=k;b.dwsRecipeCnTmpls=g;tcmpTmpl.editCnRecipeTmpl(b);tcmpTmpl.chinaTmplInfo=null},editCnRecipeTmpl:function(a){var b={url:ContextClinc_Server+"dwsRecipeCnTmpl/saveRecipeCnTmpl",dataType:"json",data:JSON.stringify(a),showMask:true,contentType:"application/json; charset=utf-8"};var c=Utils.myAjaxHandler(b);c.done(function(d){if(d.errorCode==SUCCESSCODE){$.paSuccess("保存成功！");tcmpTmpl.getChinaTmplMedicien()}else{$.paError("保存失败！")}}).fail(function(d){$.paError("操作失败！")}).always(function(){})},initTemplateLevel:function(){var a={isNeedClear:false};$(".template-type").WJZSDropdown(this.templateLevel,a,function(b,c){});$(".template-type").SelectWJZSDropdownFirstItem()},};function TCMPrescriptionHistory(){this.historyAcography=[];this.historyRecipes=[]}TCMPrescriptionHistory.prototype={init:function(){tcmpHistory.initClick();setTimeout(function(){tcmpHistory.initDateChoose()},30)},initClick:function(){$(".historyDetail").off("click").on("click",".historyDetail-head i:not(.quote)",function(){$(this).toggleClass("collapse");$(this).toggleClass("expand");$(this).parents(".historyDetail-head").next().slideToggle();if($(this).hasClass("collapse")){$(this).parents(".historyDetail-item").addClass("choose")}else{$(this).parents(".historyDetail-item").removeClass("choose")}});$(".historyRecipe").on("click",".quote",function(){var b=$(this).parents(".historyRecipe-project");var d=b.attr("acography-id");var a=$(this).attr("recipe-id");var c=tcmpHistory.historyRecipes;if(c){var e=_.find(c,function(f){return f.recipeId==a});tcmpTmpl.chinaTmplUse(e,2)}});$(".prev").on("click",function(){var a=$(".dateChooser input").attr("val");$(".dateChooser ul>li").each(function(c){if(a==$(this).attr("data-value")){if(c==0){$.paAlert("无更多历史处方")}else{var d=$(this).prev().attr("data-value");$(".dateChooser input").attr("val",d);$(".dateChooser input").val($(this).prev().text());var b=_.find(tcmpHistory.historyAcography,function(e){return e.ID==d});tcmpHistory.getPrescriptionHistory(b)}}})});$(".next").on("click",function(){var a=$(".dateChooser input").attr("val");var b=$(".dateChooser ul>li").length-1;$(".dateChooser ul>li").each(function(d){if(a==$(this).attr("data-value")){if(d==b){$.paAlert("无更多历史处方")}else{var e=$(this).next().attr("data-value");$(".dateChooser input").attr("val",e);$(".dateChooser input").val($(this).next().text());var c=_.find(tcmpHistory.historyAcography,function(f){return f.ID==e});tcmpHistory.getPrescriptionHistory(c)}}})})},initDateChoose:function(){var a={url:ContextClinc_Server+"TCMPrescription/getHisAcographyDate?empiId="+empiId,dataType:"json",showMask:false};var b=Utils.myAjaxHandler(a);b.done(function(f){if(SUCCESSCODE==f.errorCode){var e={idKey:"ID",txtKey:"TXT",isNeedClear:false,acographyId:"ACOGRAPHYID",treatmentType:"TREATMENTTYPE",doctorName:"DOCTORNAME",clinicId:"CLINICID",empiId:"EMPIID"};var c=_.filter(f.data,function(g){return g.ACOGRAPHYID!=acographyId});tcmpHistory.historyAcography=c;$(".dateChoose").WJZSDropdown(c,e,function(g,h){tcmpHistory.getPrescriptionHistory(h)});$(".dateChoose").SelectWJZSDropdownFirstItem();var d=$(".dateChoose").attr("val");if(d){$(".dateChooser").find("ul>li[data-value="+d+"]").trigger("click");$(".dateChooser .wjzs-drop-menu").hide()}else{$(".historyRecipe").html('<div class="noDataHint"><p class="noDataHint-text">暂无历史处方</p></div>')}}else{$.paError(f.errorMessage,null)}}).fail(function(c){$.paError("请求异常",null)})},getPrescriptionHistory:function(a){var b={contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"TCMPrescription/getHisAcographyRecipe?empiId="+a.EMPIID+"&acographyId="+a.ACOGRAPHYID+"&clinicId="+a.CLINICID,dataType:"json",showMask:false};var c=Utils.myAjaxHandler(b);c.done(function(d){if(SUCCESSCODE==d.errorCode){if(null!=d.data){tcmpHistory.historyRecipes=d.data.recipeList}tcmpHistory.renderPrescriptionHistoryData(d.data,a)}else{$.paError(d.errorMessage,null)}}).fail(function(d){$.paError("请求异常",null)})},renderPrescriptionHistoryData:function(d,a){if(a){var e=$(".recipe-history-clone").clone(true).removeClass("recipe-history-clone").show();e.attr("acography-id",a.ACOGRAPHYID);e.find(".history-content").attr("acography-id",a.ACOGRAPHYID);e.find(".treatmentType").text((a.TREATMENTTYPE==2?"复诊":"初诊"));e.find(".addDate").text(a.TXT);e.find(".doctorName").text(a.DOCTORNAME||"").attr("title","就诊医生："+(a.DOCTORNAME||""));if(d){var c=d.cnMedical;var b="";if(c&&c.chineseTraDiagnosis){b=c.chineseTraDiagnosis}if(b){if(d.DiagnosisList){b+="；"+d.DiagnosisList}}else{b=d.DiagnosisList}e.find("#hisDiagnosis").text((b||"-"));e.find(".historyRecipe-diagnose").attr("title","诊断："+(b||"-"));if(d.recipeList&&d.recipeList.length>0){_.each(d.recipeList,function(h,g){var f=e.find(".historyDetail>ul>.history-clone").clone(true).removeClass("history-clone");f.find(".prescription-title").text("草药方  "+h.recipeName);f.find(".quote").attr("data-index",h.recipeName).attr("recipe-id",h.recipeId);f.find(".quote").attr("title","引用草药方"+h.recipeName);f.show();if(g>0){f.find(".historyDetail-content").hide();f.find(".historyDetail-head .collapse").addClass("expand").removeClass("collapse")}f.find(".historyDetail-content").attr("recipe-id",h.recipeId);f.find(".drug-Type").text((h.drugType==1?"（颗粒）":"（饮片）"));f.find(".eatRequire").text((h.eatRequire==1?"外用":"内服")+(Utils.notBlank(h.frequencyName)?"，"+h.frequencyName:"")+(Utils.notBlank(h.useNum)?"，每次"+h.useNum+(h.useUnit||"ml"):""));f.find(".agentQty").text(h.agentQty);if(h.advice==null||h.advice==""){f.find(".line").addClass("dsn")}else{f.find(".line").removeClass("dsn")}f.find(".advice").text((h.advice||""));f.find(".drugNum").text(h.recipeCnList.length);if(h.recipeCnList.length>0){var i="";_.each(h.recipeCnList,function(j,k){if(i!=""){i+="，"}if(j.drugSource==1){i+='<span class="drugSource">【外购】</span>'}else{if(j.drugSource==2){i+='<span class="drugSource">【免费】</span>'}else{if(j.drugSource==3){i+='<span class="drugSource">【外煎】</span>'}}}i+='<span class="drugName" >'+j.drugName+"</span>";if(Utils.isBlank(j.footnoteName)){i+='<span class="drugUsage">（'+j.footnoteName+"）</span>"}i+='<span class="drugDose">'+j.drugDose+j.drugUnitName+"</span>"});f.find(".row-content").empty().append(i)}e.find(".historyDetail>ul").append(f)})}else{e.find(".historyDetail>ul").append('<p class="unprescribedHint">本次诊断并无处方</p>')}if(d.chainClinicName){e.find(".historyStores").removeClass("dsn");e.find(".historyStores").text(d.chainClinicName).attr("title","分店名称："+d.chainClinicName);e.find(".quote").addClass("hideQuote").hide()}else{e.find(".historyStores").addClass("dsn")}$(".historyRecipe").find(".historyRecipe-project:not(.recipe-history-clone)").remove();$(".historyRecipe").append(e)}}},getDateListSync:function(){var a={url:ContextClinc_Server+"TCMPrescription/getHisAcographyDate?empiId="+empiId,dataType:"json",showMask:false,async:false};var c=Utils.myAjaxHandler(a);var b;c.done(function(d){b=d}).fail(function(d){$.paError("请求异常",null)});return b},renderPrescriptionHistory:function(d){if(SUCCESSCODE==d.errorCode){var c={idKey:"ID",txtKey:"TXT",isNeedClear:false,acographyId:"ACOGRAPHYID",treatmentType:"TREATMENTTYPE",doctorName:"DOCTORNAME",clinicId:"CLINICID",empiId:"EMPIID"};var a=_.filter(d.data,function(e){return e.ACOGRAPHYID!=acographyId});tcmpHistory.historyAcography=a;$(".dateChoose").WJZSDropdown(a,c,function(e,f){tcmpHistory.getPrescriptionHistory(f)});$(".dateChoose").SelectWJZSDropdownFirstItem();var b=$(".dateChoose").attr("val");if(b){$(".dateChooser").find("ul>li[data-value="+b+"]").trigger("click");$(".dateChooser .wjzs-drop-menu").hide()}else{$(".historyRecipe").html('<div class="noDataHint"><p class="noDataHint-text">暂无历史处方</p></div>')}}else{$.paError(d.errorMessage,null)}}};function TCMClassicalPrescription(){this.prescriptionType={};this.effectPrescriptions=null}TCMClassicalPrescription.prototype={init:function(){tcmpClassical.initClick()},initClick:function(){$(".classicalDrug").on("click",".findDrug-way i",function(){if($(this).hasClass("expand")){var a=$(this).attr("data-val");var b=tcmpClassical.getPrescriptionByType(a);tcmpClassical.renderPrescriptions(a,b);tcmpClassical.showfindDrugWay(a);tcmpClassical.showMorePrescript()}else{$(this).toggleClass("collapse");$(this).toggleClass("expand");$(this).parent().next(".findDrug-content").slideToggle()}});$(".classicalDrug").on("click",".showMore-hint",function(){$(this).prev().removeClass("showMore");$(this).hide()});$("#btnSearch").off("click").on("click",function(){tcmpClassical.searchPrescriptions(this)});$(".effectDrug-btn").off("click").on("click",function(){tcmpClassical.renderPrescriptions(0,tcmpClassical.getPrescriptionByType(0));$(".searchResults").addClass("dsn");$(".no-searchResults").addClass("dsn");$(".find-formula").removeClass("dsn");tcmpClassical.showfindDrugWay(0);tcmpClassical.showMorePrescript(0)});$(".classicalDrug").on("click",".effectDrug-item",function(){var a=$(this).attr("data-val");var b=$(this).parents(".prescription-info").attr("id");tcmpClassical.renderPrescriptions(3,tcmpClassical.getPrescriptionByTypeId(a),b);$(".find-formula").addClass("dsn");$(".effectDrug-explain").removeClass("dsn");tcmpClassical.showMorePrescript(3)});$(".classicalDrug").on("click",".returnBack",function(){var a=$(this).attr("data-pardiv");$("#"+a).siblings().addClass("dsn");$("#"+a).removeClass("dsn")});$(".classicalDrug").on("click",".details",function(){var a=$(this).siblings("span").attr("id");var b=tcmpClassical.getCollectPresciption(a);var c=$(this).parents(".prescription-info").attr("id");tcmpClassical.renderPrescriptionDtl(a,b,c);$(".prescriptionDetailsPage").siblings().addClass("dsn")});$(".classicalDrug").on("click",".quote",function(){var a=tcmpClassical.quoteClassicPrescription(tcmpClassical.getClinicDrugs($(this).attr("data-val")));if(a){tcmpTmpl.chinaTmplUse(a,3)}});$(".classicalDrug").on("click",".collect",function(){if(!tcmp.isReadOnly){var a=$(this).siblings(".returnBack").attr("data-pardiv");tcmpClassical.savePrescriptionCollect($(this).attr("data-val"),$(this).attr("data-collect"),a);$(".effectDrug-explain").addClass("dsn");$(".find-formula").addClass("dsn")}})},initClassicalPrescriptionType:function(){var a="1";var b=tcmpClassical.getPrescriptionByType(a);if(Utils.isBlank(b)){tcmpClassical.renderPrescriptions(a,b)}else{a="0";tcmpClassical.renderPrescriptions(a,tcmpClassical.getPrescriptionByType(a))}tcmpClassical.showfindDrugWay(a);$(".find-formula").siblings().addClass("dsn");$(".find-formula").removeClass("dsn");tcmpClassical.showMorePrescript(a);$(".classicalDrug>quote").addClass("dsn")},searchPrescriptions:function(c){var a=$("#keyword").val();if(!a){$.paAlert("请输入方剂名称搜索！");return}var b=tcmpClassical.getPrescriptionByType(4,$("#keyword").val());var d=$(c).parents(".prescription-info").attr("id");if(null!=b&&b.length>0){tcmpClassical.renderPrescriptions(4,b,d);$(".no-searchResults").addClass("dsn");$(".searchResults-list").removeClass("dsn");tcmpClassical.showMorePrescript(4)}else{$("#search-return-back").attr("data-pardiv",d);$(".searchResults-list").addClass("dsn");$(".no-searchResults").removeClass("dsn");$("#keyword").val("")}$(".find-formula").addClass("dsn");$(".searchResults").removeClass("dsn")},showfindDrugWay:function(a){_.each([0,1,2],function(c,b){if(c==a){$(".findDrug-way i").eq(c).addClass("collapse").removeClass("expand");$(".findDrug-way").eq(c).next(".findDrug-content").slideDown()}else{$(".findDrug-way i").eq(c).addClass("expand").removeClass("collapse");$(".findDrug-way").eq(c).next(".findDrug-content").slideUp()}})},renderPrescriptions:function(b,d,e){if(Utils.isBlank(d)){var a="";if(0==b){a+='<ul class="effectDrug">';$.each(d,function(f,g){a+='<li class="effectDrug-item" id="presscripteion_'+g.categoryId+'" data-val="'+g.categoryId+'">'+g.categoryName+"</li>";a+='<input type="hidden" value="'+g.remark+'"/>'});a+="</ul>";$("#prescript_"+b).parent().next(".findDrug-content").empty();$("#prescript_"+b).parent().next(".findDrug-content").html(a)}else{if(1==b||2==b){a+="<ul>";a+=tcmpClassical.renderPrescriptionLi(d);a+="</ul>";$("#prescript_"+b).parent().next(".findDrug-content").empty();$("#prescript_"+b).parent().next(".findDrug-content").html(a)}else{if(3==b){var c=$(".findDrug-content #presscripteion_"+d[0].typeId).next("input").val();a+='<h4 class="header-title"><i class="returnBack fl" title="返回" id="returnPrescBack" data-pardiv="'+e+'"></i>'+d[0].typeName+"</h4>";a+='<div class="effectDrug-explain-detail"><p class="effectDrug-explain-describe">'+c+'</p><div class="showMore-hint dsn">更多>></div></div>';a+='<div class="effectDrug-explain-list"><div class="effectDrug-totle">共<span>'+d.length+"</span>方</div><ul>";a+=tcmpClassical.renderPrescriptionLi(d);a+="</ul></div>";$(".effectDrug-explain").empty();$(".effectDrug-explain").html(a)}else{if(4==b){$("#search-return-back").attr("data-pardiv",e);a+='<div class="effectDrug-totle">共<span>'+d.length+"</span>方</div><ul>";a+=tcmpClassical.renderPrescriptionLi(d);a+="</ul></div>";$(".searchResults-list").empty();$(".searchResults-list").html(a)}}}}}else{$(".findDrug-content").empty()}},renderPrescriptionLi:function(b){var a="";$.each(b,function(c,d){a+='<li class="prescriptionList"><p class="prescriptionTitle"><span class="prescriptionName" id="'+d.prescriptionId+'">'+d.prescriptionName+"</span>";a+='<i class="details fr" title="详情"></i></p>';a+='<p class="prescriptionDescribe"><span>[ 共'+(d.prescriptionItems!=null?d.prescriptionItems.length:0)+" 味药 ]</span>"+(d.efficacy!=null?d.efficacy:"")+'</p><div class="showMore-hint dsn">更多>></div></li>';if(!tcmpClassical.prescriptionType[d.prescriptionId]){tcmpClassical.prescriptionType[d.prescriptionId]=d}});return a},showMorePrescript:function(a){$(".prescriptionDescribe").each(function(){if($(this).height()>36){$(this).addClass("showMore");$(this).next(".showMore-hint").show()}});if(a==3){$(".effectDrug-explain-detail .effectDrug-explain-describe").each(function(){if($(this).height()>60){$(this).addClass("showMore");$(this).next(".showMore-hint").show()}})}},renderPrescriptionDtl:function(e,c,h){if(Utils.isBlank(e)){var d="";if(Utils.isBlank(c)){d="haveCollect"}var g=tcmpClassical.prescriptionType[e];var b='<h4 class="header-title"><i class="returnBack fl" title="返回" id="returnPrescBack2" data-pardiv="'+h+'"></i><span class="header-drugName" id="'+e+'">'+g.prescriptionName+"</span>";b+='<i class="collect fr '+d+'" title="收藏" data-val="'+e+'" data-collect="'+c+'"></i></h4>';b+='<div class="css_prescription_info"><div class="css_prescription_cell"><div class="css_prescription_cell_key">出处</div>';b+='<div class="css_prescription_cell_value">'+g.prescriptionSource+"</div></div>";b+='<div class="css_prescription_cell agent-detail"><div class="css_prescription_cell_key">组成</div><div class="css_prescription_cell_value">共 <span>'+(g.prescriptionItems!=null?g.prescriptionItems.length:0)+"</span> 味药</div>";b+='<i class="quote fr" style="display:none" title="引用" data-val="'+e+'"></i>';b+='<div class="tool-tip">现代剂量（仅供参考）</div>';b+='<div class="right-drugShow"><ul>';var a=g.prescriptionItems;if(null!=a){$.each(a,function(j,k){b+='<li class="right-drugShow-item"><span class="herbal-name drugName" title="'+k.drugName+'">'+k.drugName+"</span>";b+='<span class="drugDose">'+k.drugDose+'</span><span class="drugUnitName">'+k.drugUnitName+"</span></li>"})}b+='</ul><div class="loadMore-hint dsn">更多>></div></div></div>';b+='<div class="css_prescription_cell attending"><div class="css_prescription_cell_key">主治</div><div class="css_prescription_cell_value">'+(g.indications!=null?g.indications:"");b+='</div><div class="showMore-hint dsn">更多>></div></div>';b+='<div class="css_prescription_cell attending"><div class="css_prescription_cell_key">用法</div><div class="css_prescription_cell_value">'+(g.usageMethod!=null?g.usageMethod:"");b+='</div><div class="showMore-hint dsn">更多>></div></div></div>';$(".prescriptionDetailsPage").empty();$(".prescriptionDetailsPage").append(b);var f=15;if(a.length>(f)){$(".prescriptionDetailsPage .loadMore-hint").show();$(".prescriptionDetailsPage").find(".right-drugShow li").each(function(j){if(j>f-1){$(this).hide()}});$(".prescriptionDetailsPage .loadMore-hint").on("click",function(){$(this).hide();$(".prescriptionDetailsPage").find(".right-drugShow li").each(function(j){if(j>f-1){$(this).show()}})})}$(".prescriptionDetailsPage").removeClass("dsn");$(".attending .css_prescription_cell_value").each(function(){if($(this).height()>100){$(this).addClass("showMore");$(this).next(".showMore-hint").show()}})}else{$(".prescriptionDetailsPage").empty()}},getPrescriptionByType:function(d,b){var a={};if(d==0&&null!=tcmpClassical.effectPrescriptions){return tcmpClassical.effectPrescriptions}var c={method:"POST",url:ContextClinc_Server+"TCMPrescription/queryPresciptionsByType",dataType:"json",data:{type:d,searchVal:(b!=null?b:"")},async:false};var e=Utils.myAjaxHandler(c);e.done(function(f){if(f.errorCode==SUCCESSCODE){if(null!=f.data){a=f.data.list;if(d==0){tcmpClassical.effectPrescriptions=a}}}}).fail(function(f){}).always(function(){});return a},getPrescriptionByTypeId:function(b){var c={};var a={method:"POST",url:ContextClinc_Server+"TCMPrescription/queryPresciptionsByTypeId?typeId="+b,dataType:"json",contentType:"application/json",async:false};var d=Utils.myAjaxHandler(a);d.done(function(e){if(e.errorCode==SUCCESSCODE){if(null!=e.data){c=e.data.list}}}).fail(function(e){}).always(function(){});return c},getCollectPresciption:function(a){var b="";var c={method:"POST",url:ContextClinc_Server+"TCMPrescription/queryCollectPresciption?itemId="+a,dataType:"json",contentType:"application/json",async:false};var d=Utils.myAjaxHandler(c);d.done(function(e){if(e.errorCode==SUCCESSCODE){if(null!=e.data&&Utils.isBlank(e.data.collectId)){b=e.data.collectId}}}).fail(function(e){}).always(function(){});return b},savePrescriptionCollect:function(e,b,g){var d={};var a=false;if(!Utils.isBlank(b)){b="";a=true}var c={method:"POST",url:ContextClinc_Server+"TCMPrescription/saveCollectionInfo?prescriptionId="+e+"&collectId="+b,dataType:"json",contentType:"application/json",showMask:true};var f=Utils.myAjaxHandler(c);f.done(function(i){if(i.errorCode==SUCCESSCODE){if(a){$.paSuccess("收藏成功！")}else{$.paSuccess("取消收藏成功！")}var h=tcmpClassical.getCollectPresciption(e);tcmpClassical.renderPrescriptionDtl(e,h,g)}else{$.paError("操作失败："+i.errorCode)}}).fail(function(h){}).always(function(){});return d},getClinicDrugs:function(c){if(Utils.isBlank(c)){var a={};var b={url:ContextClinc_Server+"TCMPrescription/queryClinicPresciptionDrugs?prescriptionId="+c,dataType:"json",contentType:"application/json; charset=utf-8",async:false};var d=Utils.myAjaxHandler(b);d.done(function(e){if(e.errorCode==SUCCESSCODE){if(null!=e.data){a=e.data}}}).fail(function(e){}).always(function(){});return a}else{return null}},quoteClassicPrescription:function(e){var d={};if(null!=e&&null!=e.list&&e.list.length>0){var c=e.list;var b=[];var a={};$.each(c,function(h){var g=0;if(!Utils.isBlank(c[h].DRUGID)){g=1}var f={drugId:c[h].DRUGID,drugName:c[h].PDRUGNAME,pDrugId:c[h].PDRUGID,pDrugName:c[h].PDRUGNAME,drugDose:c[h].DRUGDOSE,drugUnitName:c[h].DRUGUNITNAME,drugUnitId:c[h].DRUG_UNIT_ID,footnote:"",footnoteName:"",unitPrice:0,drugSource:g};b.push(f)});d.recipeCnList=b;d.agentQty=1;d.eatRequire=0;d.drugType=0;d.prescriptionId=e.prescriptionId}else{$.paWarn("该方剂下药品为空,请重新选择!");return}return d},};function TCMPrescriptionUtils(){}TCMPrescriptionUtils.prototype={calcTotalPrice:function(g,b){var d=0;var e=g.find(".pill-list-item:not(.prescription-cell-clone)");var a=g.parents(".pill-middle-info").find(".china-agentQty").val();var c=false;e.each(function(){var k=$(this).data("drugSource");if(k==0||k==3||!k){var i=$(this).data("drug");var m=i.DRUG_CONVERT_RATE_DOSE;var n=i.DRUG_CONVERT_RATE_STORE_UNIT;var l=i.DRUG_STORE_UNIT_QTY;var h=i.DRUG_RETAIL_PRICE;var j=$(this).data("drugDose");if(j&&j!="必填项不能为空。"&&a&&a!="必填项不能为空。"){if(!m||m==""){m=1}if(!n||n==""){n=1}if(l&&!isNaN(l)){if(k!=3&&tcmp.isStockCheck&&tcmp.isLowStock(j,a,m,n,l)){$(this).addClass("underStock");c=true}else{$(this).removeClass("underStock")}}else{if(k!=3&&tcmp.isStockCheck){$(this).addClass("underStock");c=true}else{$(this).removeClass("underStock")}}if(h){d+=h*j}}}else{$(this).removeClass("underStock")}});if(c){g.parents(".pill-middle-info").find(".understock-tag").show()}else{g.parents(".pill-middle-info").find(".understock-tag").hide()}var f=parseFloat(g.parents(".pill-wrap").find(".sumProjectprice").val());if(a&&a!="必填项不能为空。"){if(!f||f=="NaN"||f==""){f=0}if(!b){var d=prescriptionPrint.toDecimal4(d*a+f);g.parents(".pill-wrap").find(".china-totalPrice").text(d);g.parents(".pill-wrap").find(".china-totalPrice2").val(d)}}else{g.parents(".pill-wrap").find(".china-totalPrice").text("0.0000");g.parents(".pill-wrap").find(".china-totalPrice2").val("0.0000")}},calcTotalWeight:function(d){var b=0;var c=d.find(".pill-list-item:not(.prescription-cell-clone)");var a=d.parents(".pill-middle-info").find(".china-agentQty").val();c.each(function(){var g=$(this).data("drugSource");var e=$(this).find(".china-drugUnitName").text();if(e=="g"&&g!=1){var f=$(this).data("drugDose");if(f&&f!="必填项不能为空。"&&a&&a!="必填项不能为空。"){b=Utils.accAdd(b,Utils.accMul(f,a))}}});d.parents(".pill-wrap").find(".totalWeight").text(b)},calcProjectPrice:function(e){var b=0;var d=e.find(".extraChargePop .projectId");var f=0;var h=true;if(d.length>0){var a=e.find(".extraChargePop .projectPrice");var c=e.find(".extraChargePop .projectNum");var g=e.find(".extraChargePop .totalProjectPrice");$.each(a,function(j){if($(d[j]).val()!=null&&$(d[j]).val()!=""){f=Utils.accMul($(a[j]).val(),$(c[j]).val());$(g[j]).val(Utils.changePrice(f));b+=f}})}return(h?Utils.changePrice(b):h)},};