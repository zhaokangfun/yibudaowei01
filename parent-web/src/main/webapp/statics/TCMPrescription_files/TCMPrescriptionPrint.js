var gender={"1":"男","2":"女","3":"保密"};var drugType={"0":"饮片","1":"颗粒",};var eatRequire={"0":"内服","1":"外用"};var userInfo_aclc=config_cache.getCache("medical_user_data");var item3016=_.find(userInfo_aclc.clinicParams,function(a){return a.parameterCode=="3016"});var isSelfStyle=item3016&&item3016.parameterValue;var item3013=_.find(userInfo_aclc.clinicParams,function(a){return a.parameterCode=="3013"});var isHidePrice=item3013&&item3013.parameterValue;var item3012=_.find(userInfo_aclc.clinicParams,function(a){return a.parameterCode=="3012"});var isShowTotalWeight=item3012&&item3012.parameterValue;function TCMPrescriptionPrint(){}TCMPrescriptionPrint.prototype={doPrintFacade:function(e,d,a){var b=this;var c=b.getPrintData(e,d,a);wjPrintUtils.getPrintSetting(wjPrintUtils.printFunction.cnRecipe,function(g,f){if(g==1){b.doPrint(c,d,e,f)}else{if(g==2){$.paSuccess("正在打印...");wjPrintUtils.print(f,b.buildPrintData(c,d,e),function(h){if(h.code!=SUCCESSCODE){$.paWarn(h.message)}})}else{$.paWarn("请先配置打印参数！")}}})},buildPrintData:function(f,a,e){var l=this;var g={};var k=f.empi.IS_YB_REG==1?f.empi.INSURANCE_NO:"";var h=f.empi.MI_TYPE_NAME||"自费";var i=f.empi.CHINESE_TRA_DIAGNOSIS;if(i){if(f.empi.DiagnosisList){i+="；"+f.empi.DiagnosisList}}else{i=f.empi.DiagnosisList}var c=eatRequire[f.recipe.eatRequire];if(Utils.notBlank(f.recipe.frequencyName)){c+="，"+f.recipe.frequencyName}if(Utils.notBlank(f.recipe.useNum)){c+="，每次"+f.recipe.useNum+(f.recipe.useUnit||"ml")}if(f.recipe.advice){c+="，"+f.recipe.advice}var m="";if(f.recipe.processingProject&&f.recipe.processingProject!="null"){var b=new RegExp(",","g");m=f.recipe.processingProject.replace("1","代煎").replace("2","熬膏").replace("3","制丸").replace("4","打粉").replace(b,"、")}g.basicInfo={clinicName:userInfo_aclc.clinicName,ACOGRAPHY_SERIAL_NO:f.empi.ACOGRAPHY_SERIAL_NO,INSURANCE_NO:k,recipeName:"草药处方"+f.recipe.recipeName,PATIENT_NAME:f.empi.PATIENT_NAME,PATIENT_GENDER:f.empi.PATIENT_GENDER,PATIENT_BIRTH_DATE:Utils.getPersonAccurateAge(f.empi.PATIENT_BIRTH_DATE),addDate:f.recipe.addDate,printType:"7",PAYMENT_TYPE_NAME:h,DEPARTMENT_NAME:f.empi.DEPARTMENT_NAME,PATIENT_NO:f.empi.PATIENT_NO,LIVING_ADDRESS_COUNTRYSIDE:f.empi.LIVING_ADDRESS_COUNTRYSIDE,MOBILE_PHONE_NUMBER:f.empi.MOBILE_PHONE_NUMBER,diagnosis:i,agentQty:f.recipe.agentQty,recipeCnListLength:f.recipe.recipeCnList.length,advice:c,doctorName:f.recipe.employeeName||f.recipe.acography.doctorName,totalPrice:f.recipe.totalPrice,drugType:drugType[f.recipe.drugType],processingProject:m};g.recipeCnList=f.recipe.recipeCnList;for(var d=0;g.recipeCnList[d];d++){g.recipeCnList[d].drugSource=l.createDrugSource(g.recipeCnList[d].drugSource);g.recipeCnList[d].drugDose=g.recipeCnList[d].drugDose+g.recipeCnList[d].drugUnitName}return g},doPrint:function(data,acographyId,empiId,printSetting){var self=this;LODOP=getLodop();if(!LODOP){return}var x=_.isNumber(printSetting.rightOffset)?printSetting.rightOffset:0;var y=_.isNumber(printSetting.bottomOffset)?printSetting.bottomOffset:0;LODOP.PRINT_INITA(y,x,530+x,763+y,"");LODOP.SET_PRINT_PAGESIZE(1,1480,2100,"");var chinaMed=data.recipe;self.createHead(data.empi,chinaMed);self.createFooter(chinaMed,data.empi);var downPx=250;var totalWeight="";for(var j=0;chinaMed.recipeCnList[j];j++){if(downPx>520){downPx=250;LODOP.NEWPAGEA();self.createHead(data.empi,chinaMed);self.createFooter(chinaMed)}var recipeCn=chinaMed.recipeCnList[j];if(isSelfStyle==1){var drugDose=recipeCn.drugDose;LODOP.ADD_PRINT_TEXT(downPx,10+131*(j%4),141,30,recipeCn.drugName+" "+drugDose+recipeCn.drugUnitName);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"FontSize",10.5);if(j%4==3){downPx+=35}}else{if(isSelfStyle==2){if(chinaMed.drugType==1){var item3019=_.find(userInfo_aclc.clinicParams,function(item){return item.parameterCode=="3019"});var isSelfType=item3019&&item3019.parameterValue;if(isSelfType==1){var drugPackageSpec=recipeCn.drugPackageSpec;if(drugPackageSpec=="--"||drugPackageSpec==null){LODOP.ADD_PRINT_TEXT(downPx,10+131*(j%4),140,30,recipeCn.drugName)}else{LODOP.ADD_PRINT_TEXT(downPx,10+131*(j%4),140,30,recipeCn.drugName+"("+drugPackageSpec+")")}}else{LODOP.ADD_PRINT_TEXT(downPx,10+131*(j%4),140,30,recipeCn.drugName+(recipeCn.footnote==null||recipeCn.footnote==""?"":"/"+recipeCn.footnote))}}else{LODOP.ADD_PRINT_TEXT(downPx,10+131*(j%4),140,30,recipeCn.drugName+(recipeCn.footnote==null||recipeCn.footnote==""?"":"/"+recipeCn.footnote))}LODOP.SET_PRINT_STYLEA(0,"FontSize",10.5);LODOP.ADD_PRINT_TEXT(downPx+15,77+131*(j%4),80,30,recipeCn.drugDose+" "+recipeCn.drugUnitName);LODOP.SET_PRINT_STYLEA(0,"FontSize",10.5);if(j%4==3){downPx+=40}}else{if(isSelfStyle==3){var drugNews=(recipeCn.drugName+" "+recipeCn.drugDose+recipeCn.drugUnitName);LODOP.ADD_PRINT_TEXT(downPx,10+131*(j%4),141,30,drugNews);LODOP.SET_PRINT_STYLEA(0,"FontSize",(drugNews.length>7?10.5:14));if(j%4==3){downPx+=35}}else{if(isSelfStyle==0){LODOP.ADD_PRINT_TEXT(downPx,7+131*(j%4),141,30,self.createDrugSource(recipeCn.drugSource)+""+recipeCn.drugName+" "+recipeCn.drugDose+recipeCn.drugUnitName+""+(recipeCn.footnote==null||recipeCn.footnote==""?"":"("+recipeCn.footnote+")"));LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"FontSize",8);if(j%4==3){downPx+=35}}}}}if(recipeCn.drugSource!=1&&recipeCn.drugUnitName=="g"){totalWeight=Utils.accAdd(totalWeight,Utils.accMul(recipeCn.drugDose,chinaMed.agentQty))}}var height1=(isSelfStyle==3?655:685);LODOP.ADD_PRINT_TEXT(height1,301,115,25,(isSelfStyle==3?"金额（元）:":"处方总金额（元）:"));LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Alignment",3);LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_TEXT(height1-1,421,99,25,isHidePrice==1?"-":(self.toDecimal4(chinaMed.totalPrice)));LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Alignment",2);LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_LINE(height1+10,420,height1+10,516,0,1);if(isSelfStyle==2||isSelfStyle==3){LODOP.ADD_PRINT_TEXT(downPx+(chinaMed.recipeCnList.length%4!=0?38:0),215,100,20,"(以下空白)");LODOP.SET_PRINT_STYLEA(0,"FontName","宋体")}else{LODOP.ADD_PRINT_TEXT(downPx+(chinaMed.recipeCnList.length%4!=0?33:0),215,100,20,"(以下空白)");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑")}LODOP.SET_PRINT_STYLEA(0,"Alignment",2);LODOP.SET_PRINT_STYLEA(0,"Italic",1);LODOP.ADD_PRINT_TEXT(230,99,275,20,"（药材规格为"+eval("drugType["+chinaMed.drugType+"]")+(isShowTotalWeight==1?("；本处方总重量为"+totalWeight+"g"):"")+"）");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"FontSize",8);LODOP.SET_PRINT_STYLEA(0,"Italic",1);operateType()},createDrugSource:function(a){var b="";if(a==1){b="【外】"}else{if(a==2){b="【免】"}else{if(a==3){b="【煎】"}}}return b},createHead:function(empi,chinaMed){var self=this;LODOP.ADD_PRINT_TEXT(28,10,510,25,userInfo_aclc.clinicName);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"FontSize",13);LODOP.SET_PRINT_STYLEA(0,"Alignment",2);LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_TEXT(53,10,510,25,"中药 处方笺");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"FontSize",13);LODOP.SET_PRINT_STYLEA(0,"Alignment",2);LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_TEXT(30,450,67,20,"草药方"+chinaMed.recipeName);LODOP.ADD_PRINT_TEXT(79,7,111,20,"医疗证/医保卡号：");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.ADD_PRINT_TEXT(79,110,127,20,empi.IS_YB_REG==1?(empi.INSURANCE_NO||"-"):"-");LODOP.ADD_PRINT_TEXT(212,10,100,35,"RP:");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"FontSize",18);LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_TEXT(7,5,33,25,"NO.");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_TEXT(7,38,105,25,empi.ACOGRAPHY_SERIAL_NO);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_RECT(3,450,43,18,0,1);LODOP.ADD_PRINT_TEXT(8,455,35,25,"普通");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Alignment",2);LODOP.ADD_PRINT_TEXT(7,491,35,25,"#/&");LODOP.SET_PRINT_STYLEA(0,"ItemType",2);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Alignment",2);LODOP.ADD_PRINT_LINE(94,0,94,530,0,1);LODOP.ADD_PRINT_TEXT(105,7,45,25,"姓名 :");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_TEXT(105,159,40,25,"性别 :");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Alignment",2);LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_TEXT(105,229,41,25,"年龄 :");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Alignment",2);LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_TEXT(105,332,40,25,"科室 :");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Alignment",2);LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_TEXT(105,442,40,25,"费别 :");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Alignment",2);LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_TEXT(135,8,55,25,"病历号 :");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_TEXT(135,160,71,25,"住址/电话 :");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Alignment",2);LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_TEXT(170,8,100,25,"临床诊断及证型 :");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_TEXT(170,384,65,25,"开具日期 :");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Alignment",2);LODOP.SET_PRINT_STYLEA(0,"Bold",1);var size=9;var highPx=105;if(isSelfStyle==3){size=12;highPx=102}LODOP.ADD_PRINT_TEXT(highPx,50,108,25,empi.PATIENT_NAME);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"FontSize",size);LODOP.ADD_PRINT_TEXT(highPx,199,45,25,eval("gender["+empi.PATIENT_GENDER+"]"));LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"FontSize",size);var birth=Utils.getPersonAccurateAge(empi.PATIENT_BIRTH_DATE);LODOP.ADD_PRINT_TEXT(birth.length>5?105:highPx,270,75,25,birth);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"FontSize",birth.length>5?9:size);LODOP.ADD_PRINT_TEXT(105,372,81,25,(empi.DEPARTMENT_NAME||"-"));LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.ADD_PRINT_TEXT(170,445,120,25,Utils.timeStampToDateStr(chinaMed.addDate,7));LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.ADD_PRINT_TEXT(105,479,59,25,empi.MI_TYPE_NAME||"自费");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.ADD_PRINT_TEXT(135,55,122,25,(empi.PATIENT_NO||"-"));LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");var living_address_countryside=empi.LIVING_ADDRESS_COUNTRYSIDE;if(null==living_address_countryside||"null"==living_address_countryside||""==living_address_countryside){living_address_countryside="-"}var addressPhone=living_address_countryside+"/"+empi.MOBILE_PHONE_NUMBER;if(null!=empi.MOBILE_PHONE_NUMBER&&self.getStrLength(addressPhone)>98){var mobileLength=self.getStrLength("/"+empi.MOBILE_PHONE_NUMBER);addressPhone=self.cutStr(living_address_countryside,98-mobileLength)+"/"+empi.MOBILE_PHONE_NUMBER}if(empi.MOBILE_PHONE_NUMBER==null){addressPhone=living_address_countryside+"/-"}LODOP.ADD_PRINT_TEXT(135,229,308,25,addressPhone);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");var diagnosis=empi.CHINESE_TRA_DIAGNOSIS;if(diagnosis){if(empi.DiagnosisList){diagnosis+="；"+empi.DiagnosisList}}else{diagnosis=empi.DiagnosisList}LODOP.ADD_PRINT_TEXT(170,105,280,25,(diagnosis||"-"));LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.ADD_PRINT_LINE(198,0,198,530,0,1)},getPrintData:function(f,d,b){var c={};var a={url:ContextClinc_Server+"TCMPrescription/getRecipeCn4Print",dataType:"json",data:{empiId:f,acographyId:d,recipeId:b},async:false,showMask:true,};var e=Utils.myAjaxHandler(a);e.done(function(g){if(g.errorCode==SUCCESSCODE){c=g.data}}).fail(function(g){$.paError("操作失败!")}).always(function(){});return c},createFooter:function(chinaMed,empi){var self=this;var text="注：1、本处方当日有效\n       2、取药时请当面核对药品名称、规格、数量\n       3、延长处方用量时间原因： 慢性病、老年病、外地、其他";LODOP.ADD_PRINT_TEXT(596,10,510,45,"医嘱："+eval("eatRequire["+chinaMed.eatRequire+"]")+(Utils.notBlank(chinaMed.frequencyName)?"，"+chinaMed.frequencyName:"")+(Utils.notBlank(chinaMed.useNum)?"，每次"+chinaMed.useNum+(chinaMed.useUnit||"ml"):"")+(Utils.notBlank(chinaMed.advice)?"，"+chinaMed.advice:""));LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_LINE(645,0,645,530,0,1);LODOP.ADD_PRINT_TEXT(655,10,40,25,"审核 :");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_LINE(665,46,665,150,0,1);LODOP.ADD_PRINT_TEXT(655,180,40,25,"调配 :");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_LINE(665,216,665,310,0,1);var downPx=655;if(isSelfStyle==3){downPx=630;LODOP.ADD_PRINT_TEXT(685,372,55,25,"收银员 :");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_LINE(695,420,695,516,0,1)}LODOP.ADD_PRINT_TEXT(downPx,384,40,25,"医师 :");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_TEXT(downPx-1,421,99,25,empi.DOCTOR_NAME);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Alignment",2);LODOP.ADD_PRINT_LINE(downPx+10,420,downPx+10,516,0,1);LODOP.ADD_PRINT_TEXT(685,10,40,25,"核对 :");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_LINE(695,46,695,150,0,1);LODOP.ADD_PRINT_TEXT(685,180,40,25,"发药 :");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_LINE(695,216,695,310,0,1);LODOP.ADD_PRINT_TEXT(710,11,344,55,text);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"FontSize",8);var height=575;if(chinaMed.recipeTreatmentList&&"null"!=chinaMed.recipeTreatmentList&&chinaMed.recipeTreatmentList.length>0){var processingProject="附加费（-）";var projectNames="";var sumProjecPrice=0;_.each(chinaMed.recipeTreatmentList,function(item,key){sumProjecPrice+=item.totalPrice;projectNames+=item.treatmentName+"，"});projectNames=projectNames.substr(0,projectNames.length-1)+"。";if(isHidePrice==2){processingProject="附加费￥"+Utils.changePrice(sumProjecPrice)+"，包括："+projectNames}else{processingProject="附加费："+projectNames}if(processingProject.length>31){height=561}LODOP.ADD_PRINT_TEXT(height,180,338,20,processingProject);LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"FontSize",9)}LODOP.ADD_PRINT_TEXT(height-5,10,80,30,"总共"+chinaMed.agentQty+"剂");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"FontSize",13);LODOP.SET_PRINT_STYLEA(0,"Bold",1);LODOP.ADD_PRINT_TEXT(height,85,100,20,"（每剂"+chinaMed.recipeCnList.length+"味药）");LODOP.SET_PRINT_STYLEA(0,"FontName","微软雅黑");LODOP.SET_PRINT_STYLEA(0,"FontSize",9)},getStrLength:function(b){var a=b.match(/[^\x00-\xff]/ig);return b.length+(a==null?0:a.length)},cutStr:function(d,a){if(!d){return""}if(a<=0){return""}var c=0;for(var b=0;b<d.length;b++){if(d.charCodeAt(b)>255){c+=2}else{c++}if(c==a){return d.substring(0,b-2)}else{if(c>a){return d.substring(0,b-2)}}}return d},toDecimal4:function(a){var d=parseFloat(a);if(isNaN(d)||d<0){return"0.0000"}var d=Math.round(a*10000)/10000;var c=d.toString();var b=c.indexOf(".");if(b<0){b=c.length;c+="."}while(c.length<=b+4){c+="0"}return c},toDecimal2:function(a){var d=parseFloat(a);if(isNaN(d)||d<0){return"0.00"}var d=Math.round(a*100)/100;var c=d.toString();var b=c.indexOf(".");if(b<0){b=c.length;c+="."}while(c.length<=b+2){c+="0"}return c}};