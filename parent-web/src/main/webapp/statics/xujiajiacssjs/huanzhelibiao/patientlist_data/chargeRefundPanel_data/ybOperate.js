var SZNEWYBOperateClasz;$(function(){SZNEWYBOperateClasz=new SZNEWYBOperateClasz()});var szNewYbAppCodeEnum={DEAL_QUERY_CODE:"JY001",DEAL_REFUND_CODE:"JY002",DEAL_CANCEL_CODE:"JY003"};var WEBSOCKET_MESSAGE_TYPE={VERIFY_CODE:10702};var SZNEWYBOperateClasz=function(){this.ws=null;this.mask=null;this.async=null;this.successCallback=null;this.failCallback=null;this.serialNumber=null;this.reqMessage=null;this.init()};SZNEWYBOperateClasz.prototype={constructor:SZNEWYBOperateClasz,init:function(){var a=this;var c=8054;var b=WJBox_Server;try{if("WebSocket" in window){a.ws=new WebSocket(b,"protocol-yb-sz")}else{if("MozWebSocket" in window){a.ws=new MozWebSocket(b,"protocol-yb-sz")}else{console.log("WebSocket is not supported by this browser.");a.ws=null}}}catch(d){}if(null!=a.ws){a.ws.onmessage=function(e){console.log("WebSocket onmessage :"+e.data+"\n");a.handleSuccessEvent(e)};a.ws.onerror=function(e){console.log("WebSocket error :"+e.data+"\n")};a.ws.onopen=function(e){console.log("Connected\n")};a.ws.onclose=function(e){console.log("Disconnected\n")}}},handleSuccessEvent:function(evt){var self=this;var responseMessage=eval("("+evt.data+")");switch(responseMessage.type){case WEBSOCKET_MESSAGE_TYPE.VERIFY_CODE:var code=responseMessage.code;if(0!=code){$.paError("读取验证码失败!");return}var cardInfo=responseMessage.data;if(null==cardInfo){$.paError("读取验证码信息失败!");return}var cardInfoArray=cardInfo.split("|");var verifyCode=cardInfoArray[0]+"|"+cardInfoArray[1];var transVersion=cardInfoArray[2];self.reqMessage.transVersion=transVersion;self.reqMessage.verifyCode=verifyCode;self.ybInterfaceCall();break}},send_Msg:function(f,j,d,b,e){var i=this;var g={transTime:YBUtils.getCurrentDate("yyyyMMddHHmmss")+":000",transType:"",transReturnCode:"",transReturnMessage:"",transVersion:"",serialNumber:"",cardArea:"440300",hospitalCode:"",operatorCode:"",operatorName:"",operatorPass:"",transChannel:"10",verifyCode:"",extendDeviceId:"",extendUserId:"",extendSerialNumber:"",transBody:""};g.transType=f.appCode;g.transVersion="";g.verifyCode="";g.transBody=$.extend({},f.data);var h=MI_COMMON.getYBBaseInfo();if(null==h.ybClinicId||h.ybClinicId.length==0){$.paAlert("医保参数设置有误");return}if(undefined==h.ybOperatorId||null==h.ybOperatorId||h.ybOperatorId.length==0){$.paAlert("获取操作员编码失败");return}if(undefined==h.ybOperatorName||null==h.ybOperatorName||h.ybOperatorName.length==0){$.paAlert("获取操作员编码失败");return}g.hospitalCode=h.ybClinicId;g.operatorCode=h.ybOperatorId;g.operatorName=h.ybOperatorName;if(null==i.ws||i.ws.readyState!=1){$.paWarn("设备连接失败或没有安装驱动！",null);return}var c={};var a=ContextClinc_Server+"miSZNew/getOrgSettlementCode";i.sendMyAjaxHandler2(c,a,d,function(l){var k=l.orgSettlementCode;if(null==k){$.paAlert("获取交易流水号失败");return}g.serialNumber=k;i.reqMessage=g;i.mask=j;i.async=d;i.successCallback=b;i.failCallback=e;i.verifyCodeCall(g.transType,g.serialNumber,g.hospitalCode)})},ybInterfaceCall:function(){var a=this;if(a.mask){}var b=MI_COMMON.getIpAddress("yb0005","1");console.log("深圳新医保请求消息："+JSON.stringify(a.reqMessage));$.ajax({type:"get",async:a.async,url:b+"?param="+encodeURIComponent(encodeURIComponent(JSON.stringify(a.reqMessage))),dataType:"jsonp",jsonp:"backMsg",success:function(c){console.log("深圳新医保服务器返回结果："+JSON.stringify(c));if(c.data.transReturnCode=="00000000"){if(a.successCallback){a.successCallback(c.data)}}else{if(a.failCallback){a.failCallback(c.data.transReturnMessage)}}},error:function(){$.paAlert("医保前置程序连接异常!")},complete:function(){if(a.mask){Utils.removeLoadingMaskFrom()}}})},verifyCodeCall:function(e,b,d){var a=this;var c={type:WEBSOCKET_MESSAGE_TYPE.VERIFY_CODE,params:e+"|"+b+"|"+d+"|"};if(a.ws){a.ws.send(JSON.stringify(c))}},sendMyAjaxHandler:function(d,b,e){var a={type:"POST",contentType:"application/json; charset=utf-8",url:b,data:JSON.stringify(d),showMask:true,dataType:"json"};var c=Utils.myAjaxHandler(a);c.done(function(f){if(f!=null&&f.errorCode==SUCCESSCODE){e(f.data)}else{$.paError(f.errorMessage)}}).fail(function(f){$.paError("操作失败!")}).always(function(){})},sendMyAjaxHandler2:function(e,b,c,f){var a={type:"POST",contentType:"application/json; charset=utf-8",url:b,async:c,data:JSON.stringify(e),showMask:true,dataType:"json"};var d=Utils.myAjaxHandler(a);d.done(function(g){if(g!=null&&g.errorCode==SUCCESSCODE){f(g.data)}else{$.paError(g.errorMessage)}}).fail(function(g){$.paError("操作失败!")}).always(function(){})}};