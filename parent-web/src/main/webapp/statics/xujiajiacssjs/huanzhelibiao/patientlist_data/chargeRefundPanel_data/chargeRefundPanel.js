var panelInputParam={};var _parent_refundSuccessCallback=null;var _parent_refundFailCallback=null;var _parent_closePanelCallback=null;var chargeRefundClass_hand=null;var szNewYbRegister_ChargeRefundClass_hand=null;var recordInfoQueryResultData={};function initChargeRefund(a,c,d,b){panelInputParam=a;_parent_refundSuccessCallback=c;_parent_refundFailCallback=d;_parent_closePanelCallback=b;chargeRefundClass_hand=new ChargeRefundClass();chargeRefundClass_hand.init()}function ChargeRefundClass(){}ChargeRefundClass.prototype={constructor:ChargeRefundClass,init:function(){this.clearPageInfo();this.queryRecordPayBaseInfo();this.initPage();this.initRefundPayTypeDrop();this.bindEvent()},initPage:function(){var b=this;var c=panelInputParam.dataSource;if(b.strIsEmpty(c)){$.paError("数据来源无效");return}switch(c){case"01":var a=panelInputParam.businessData.triageId;if(b.strIsEmpty(a)){$.paError("分诊ID无效");return}szNewYbRegister_ChargeRefundClass_hand=new SzNewYbRegister_ChargeRefundClass();szNewYbRegister_ChargeRefundClass_hand.getRecordByTriageId(a,b.romanceRecordBaseInfo,function(d){$.paError(d.errorMessage)});break;default:break}},bindEvent:function(){$("#checkAll").on("click",function(){$(this).toggleClass("checked");if($(this).hasClass("checked")){$("#record-items-info td:not(.disabled) i").parent().addClass("checked");if($("#record-items-info td.checked").length==0){$("#refund_btn_id").addClass("disabled")}else{$("#refund_btn_id").removeClass("disabled")}}else{$("#record-items-info td:not(.disabled) i").parent().removeClass("checked");$("#refund_btn_id").addClass("disabled")}});$("#record-items-info .item-info-checkbox").off("click").on("click",function(){if(!$(this).parent().hasClass("disabled")){$(this).parent().toggleClass("checked");switch(panelInputParam.dataSource){case"01":if($(this).parent().hasClass("checked")){$("#record-items-info td:not(.disabled) i").parent().addClass("checked");$("#checkAll").addClass("checked")}else{$("#record-items-info td:not(.disabled) i").parent().removeClass("checked");$("#checkAll").removeClass("checked")}break;default:break}if($("#record-items-info td.checked").length==0){$("#refund_btn_id").addClass("disabled")}else{$("#refund_btn_id").removeClass("disabled")}}});$("#refund_btn_id").on("click",function(){if($("#refund_btn_id").hasClass("disabled")){return}if(2==recordInfoQueryResultData.record.chargeFlag){$.paWarn("不允许重复退费！");return}var h=$("#record-items-info td.checked");if(h.length==0){$.paWarn("请选择退费项目！");return}var d=$("#refund_reason_id").val();if(chargeRefundClass_hand.strIsEmpty(d)){$.paWarn("请输入退费原因！");return}var b=recordInfoQueryResultData.record.payKind;if(2==b&&!$("#refundPayType").attr("val")){$.paWarn("请选择退费方式");return}switch(panelInputParam.dataSource){case"01":var a={refundReason:d,refundPayType:$("#refundPayType").attr("val")};var e=chargeRefundClass_hand.getSelectedRecordItems();var g=$.extend({},recordInfoQueryResultData);g.recordItems=e;var f=$.extend({},g,a);var c=szNewYbRegister_ChargeRefundClass_hand.assembleRefundParam(f);szNewYbRegister_ChargeRefundClass_hand.doRefund(c,function(i){$.paSuccess("退费成功！");if(_parent_refundSuccessCallback){i.inputParam=panelInputParam;_parent_refundSuccessCallback(i)}},function(i){$.paError(i.errorMessage);if(_parent_refundFailCallback){i.inputParam=panelInputParam;_parent_refundFailCallback(i)}});break;default:break}});$("#refund-panel-close-bn").on("click",function(){if(_parent_closePanelCallback){_parent_closePanelCallback()}})},clearPageInfo:function(){$(".clearClass").empty();$("#checkAll").removeClass("checked");$("#refund_reason_id").val("")},romanceRecordBaseInfo:function(c){if(null!=c&&null!=c.record){var b=c.record;$("#patientName_").html(b.patientName);$("#patientSex_").html(b.patientGenderStr);$("#patientAge_").html(b.patientAge);$("#patientPhone_").html(b.mobilePhoneNumber);$("#doctorDept_").html(b.departmentName);$("#doctorName_").html(b.doctorName);$("#chargeNo_").html(b.chargeNo);$("#paymentType_").html(b.paymentTypeName);$("#payType_").html(b.payTypeStr);$("#discountFee_").html("￥"+(fmoney(b.discountMoney)||"0.00"));var a=c.recordItems;$("#record-items-info").html(chargeRefundClass_hand.generateRecordItemsHtml(a));switch(panelInputParam.dataSource){case"01":$("#owe-money-tip").hide();$("#refund_money_id").html((fmoney(b.totalMoney)||"0.00"));$("#small_money_id").html((fmoney(b.smallMoney)||"0.00"));break;default:break}}},generateRecordItemsHtml:function(b){var e="";if(null!=b){for(var d=0;d<b.length;d++){e+="<tr>";var a=b[d];var c=true;if(!chargeRefundClass_hand.strIsEmpty(a.refundId)&&a.amount<0){c=false}if(!c){e+='<td class="disabled" chargeItemId="'+a.chargeItemId+'"><i class="item-info-checkbox"></i></td>'}else{e+='<td chargeItemId="'+a.chargeItemId+'"><i class="item-info-checkbox"></i></td>'}e+="<td>"+(chargeRefundClass_hand.strIsEmpty(a.groupNum)?"":a.groupNum)+"</td>";e+="<td>"+(chargeRefundClass_hand.strIsEmpty(a.itemName)?"":a.itemName)+"</td>";e+="<td>"+(chargeRefundClass_hand.strIsEmpty(a.specification)?"--":a.specification)+"</td>";e+="<td>"+(chargeRefundClass_hand.strIsEmpty(a.agentQty)?"--":a.agentQty)+"</td>";if(!chargeRefundClass_hand.strIsEmpty(a.refundId)&&a.amount<0){e+="<td></td>"}else{e+="<td>"+a.amount+"</td>"}e+="<td>"+(chargeRefundClass_hand.strIsEmpty(a.unit)?"--":a.unit)+"</td>";e+="<td>"+fmoney(a.price)+"</td>";e+="<td>"+fmoney(a.money)+"</td>";switch(panelInputParam.dataSource){case"01":e+='<td><input disabled="disabled" style="background: #eee;" class="input-text" value="'+a.amount+'"></input></td>';break;default:if(c){e+='<td><input disabled="disabled" style="background: #eee;" class="input-text" value="'+a.amount+'"></input></td>'}else{e+='<td><input style="background: #eee;" class="input-text" value="'+a.amount+'"></input></td>'}break}e+="<td>"+chargeRefundClass_hand.getSendStateTxtByStatus(a.sendState)+"</td>"}}return e},getSendStateTxtByStatus:function(a){var b="";switch(a){case 0:b="未发药";break;case 1:b="已发药";break;case 2:b="已退药";break;case 3:b="部分退药";break;case 6:b="申请退药";break;default:b="--"}return b},queryRecordPayBaseInfo:function(){if(null==session_cache.getCache("recordPayData")){var c={typeName:"1"};var a={method:"POST",url:ContextClinc_Server+"charge/initCGRecordPage",data:c,dataType:"json",async:false,showMask:false};var b=Utils.myAjaxHandler(a);b.done(function(d){if(d!=null&&d.errorCode==SUCCESSCODE){session_cache.setCache("recordPayData",d.data)}else{$.paError(d.errorMessage,null);return}}).fail(function(d){$.paError("费用的基本信息时请求未响应，请检查网络连接！")}).always(function(){})}},filterPayTypeData:function(){var b=[];var a=session_cache.getCache("recordPayData");if(null!=a){var c=a.T21;if(null!=c){$.each(c,function(d){if(c[d]["dictItemCode"]!=chargeConstant.chargeMember&&c[d]["dictItemCode"]!=chargeConstant.chargeInsurance&&c[d]["dictItemCode"]!=chargeConstant.payTypeYZT){b.push(c[d])}})}}return b},getSelectedRecordItems:function(){var d=[];var f=$("#record-items-info td.checked");for(var c=0;c<f.length;c++){var a=f[c];var g=$(a).attr("chargeItemId");for(var b=0;b<recordInfoQueryResultData.recordItems.length;b++){var e=recordInfoQueryResultData.recordItems[c];if(g==e.chargeItemId){d.push(e);break}}}return d},initRefundPayTypeDrop:function(){var b=this;var e=$("#refundPayType");var c=b.filterPayTypeData();var d=[{dictItemCode:"",dictItemName:"默认"}];d=d.concat(c);var a={isNeedClear:false,isNeedAll:false,idKey:"dictItemCode",txtKey:"dictItemName"};e.WJZSDropdown(d,a,function(f,g){});e.SetWJZSDropdownSelectedData("")},checkIsVipPayType:function(b,a){if(b=="7"||a=="7"){flag=true}else{return false}},strIsEmpty:function(a){if(null==a||undefined==a||a.length==0){return true}return false}};function SzNewYbRegister_ChargeRefundClass(){}SzNewYbRegister_ChargeRefundClass.prototype={constructor:SzNewYbRegister_ChargeRefundClass,getRecordByTriageId:function(c,b,e){var g={triageId:c};var a=ContextClinc_Server+"charge/getRecordByTriageId";var d={method:"POST",url:a,dataType:"json",data:g,async:false,showMask:true};var f=Utils.myAjaxHandler(d);f.done(function(h){if(h!=null&&h.errorCode==SUCCESSCODE){recordInfoQueryResultData=h.data;b(h.data)}else{e(h)}}).fail(function(h){$.paError("收费信息时请求未响应，请检查网络连接！")}).always(function(){})},assembleRefundParam:function(d){var m=d.record;var b={};var e=d.refundPayType;var j="";var f="";var k=0;var h=0;if(chargeRefundClass_hand.checkIsVipPayType(m.payType,m.payType2nd)){j=m.payType;f=m.payType2nd;k=m.payMoney1st;h=m.payMoney2nd}else{j=m.payType;f=null;k=m.totalMoney;h=0}if(e.length>0){j=e}b={empiId:m.empiId,payType:j,payType2nd:f,payKind:1,acographyId:m.acographyId,acographySerialNo:m.acographySerialNo,payMoney1st:k,payMoney2nd:h,refundMoney:m.totalMoney,totalMoney:m.selfPayMoney,smallMoney:0,discountMoney:m.discountMoney,refundReason:d.refundReason,memberCardId:m.memberCardId,memberCardNumber:m.memberCardNumber,empiName:m.patientName,feeTotalMoney:m.feeTotalMoney,dataSource:m.dataSource,accountingMoney:0,selfPayMoney:m.selfPayMoney,ybFundMoney:m.ybFundMoney,selfYbMoney:m.selfYbMoney,memberOptRecordId:m.memberOptrecordId,isCounteract:1,totalOweMoney:0};var l=[];for(var c=0;c<d.recordItems.length;c++){var g=d.recordItems[c];var n={chargeItemId:g.chargeItemId,recipeItemId:g.recipeitemid,recipeId:g.recipeid,refundNumber:g.amount,agentQty:g.agentQty,acographyType:g.acographyType,remainingAmount:0,acographyItemAmount:g.amount};l.push(n)}m.ybType="yb0005";var a={pricingCharge:m,refundRecord:b,chargeList:l,accountingFlag:false,dataSource:m.dataSource,ybAcographyId:d.ybBizRecord.ybAcographyId,settleBizNo:d.ybBizFee.settleBizNo,settleSerialNo:d.ybBizFee.settleSerialNo,ybItemNo:d.ybBizFee.ybItemNo};return a},doRefund:function(d,a,e){var b=this;if(null==d){$.paWarn("退费参数无效！");return}if(chargeRefundClass_hand.strIsEmpty(d.ybAcographyId)){$.paWarn("门诊流水号无效！");return}if(chargeRefundClass_hand.strIsEmpty(d.settleBizNo)){$.paWarn("结算业务号无效！");return}if(chargeRefundClass_hand.strIsEmpty(d.settleSerialNo)){$.paWarn("医药机构结算业务序列号无效！");return}var c={appCode:"JY002",data:{akc190:d.ybAcographyId,ckc618:d.settleBizNo,bke384:d.settleSerialNo}};SZNEWYBOperateClasz.send_Msg(c,true,true,function(f){console.log("深圳新医保退费响应消息："+JSON.stringify(f));if(null!=f&&null!=f.transBody&&"1"==f.transBody.baz700){b.saveRefundInfo(d,function(g){a(g)},function(g){e(g)})}else{$.paError("医保接口费用退费失败,原因："+f)}},function(f){$.paError(f)})},saveRefundInfo:function(c,a,d){var b={url:ContextClinc_Server+"charge/shenzhenNewYb/registerRefund",dataType:"json",type:"POST",data:JSON.stringify(c),contentType:"application/json;charset=utf-8",async:true,showMask:true};var e=Utils.myAjaxHandler(b);e.done(function(f){if(f!=null&&f.errorCode==SUCCESSCODE){a(f)}else{d(f)}}).fail(function(f){$.paError("退费时请求未响应，请检查网络连接！");return}).always(function(){})}};