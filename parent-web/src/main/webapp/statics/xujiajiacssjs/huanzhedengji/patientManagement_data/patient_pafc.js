var PaUmInfoController=function(a){this.commonController=a;this.fromPsSystem=0;this.patientRegisterView};PaUmInfoController.prototype={setRegisterView:function(a){this.patientRegisterView=a},showRelativeInfoPannel:function(){$("#pa-data-info").show();$("#read_staffCard").show();$("#pa-um-account").addClass("validate(required,notspace,notChn)");$("#pa-company-name").addClass("validate(required,notspace,name)");$("#pa-department-name").addClass("validate(required,notspace,name)");$("#pa-entry-date-str").addClass("validate(date)");$("#pa-staff-id").addClass("validate(numAndLetter)");this._setDatePicker();this._bindEvent()},closeRelativeInfoPannel:function(){$("#pa-data-info").hide();$("#read_staffCard").hide();$("#pa-um-account").removeClass("validate(required,notspace,notChn)");$("#pa-company-name").removeClass("validate(required,notspace,name)");$("#pa-department-name").removeClass("validate(required,notspace,name)");$("#pa-entry-date-str").removeClass("validate(date)");$("#pa-staff-id").removeClass("validate(numAndLetter)")},resetRelativeInfoPannel:function(){$("#pa-um-account").val("");$("#pa-company-name").val("");$("#pa-department-name").val("");$("#pa-entry-date-str").val("");$("#pa-staff-id").val("");$("#pa-um-account").addClass("validate(required,notspace,notChn)");$("#pa-company-name").addClass("validate(required,notspace,name)");$("#pa-department-name").addClass("validate(required,notspace,name)");$("#pa-entry-date-str").addClass("validate(date)");$("#pa-staff-id").addClass("validate(numAndLetter)");this._setDatePicker()},setPaInfoData:function(a){if(a){$("#pa-um-account").val(a.paUmAccount);$("#pa-company-name").val(a.paCompanyName);$("#pa-department-name").val(a.paDepartmentName);$("#pa-entry-date-str").val(a.paEntryDateStr);$("#pa-staff-id").val(a.paStaffId);$("#pa-data-info").show()}this._setDatePicker()},getPatientData:function(){return{paUmAccount:$.trim($("#pa-um-account").val()),paStaffId:$.trim($("#pa-staff-id").val()),paCompanyName:$.trim($("#pa-company-name").val()),paDepartmentName:$.trim($("#pa-department-name").val()),paEntryDateStr:$.trim($("#pa-entry-date-str").val())}},setFromPsSystem:function(a){this.fromPsSystem=a},_bindEvent:function(){var a=this;$("#read_staffCard").off("click").on("click",function(){var b=document.getElementById("cSharpActiveX");if(!b.requestCard){a.installReadCardApp()}b.InitPort(0,115200);if(1==b.requestCard()){var c=b.readData();a.readICCard(c)}b.closePort()});$("#search-um-account").on("click",function(){var b=$.trim($("#pa-um-account").val());if(""==b){return}a.searchInfoByUmCount(b)})},installReadCardApp:function(){var a={msg:"您需要安装读卡设备，确认下载？",cancelTxt:"取消",saveTxt:"确定",onYes:function(){window.open("../resources/plugin/readCard/ismsiccard.msi")}};$.paConfirm(a)},readICCard:function(b){var c=this;var e;var a={showMask:false,contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"empi/read_ic_card?cardId="+b,dataType:"json"};var d=Utils.myAjaxHandler(a);d.error(function(){$.paError("请求未响应，请检查网络连接！")});d.done(function(f){console.info(f);if(f.errorCode=="E0000000"){if(f.data!=""){c.showPatientInfo(f)}}else{$.paError(f.errorMessage)}})},searchInfoByUmCount:function(b){var c=this;var e;var a={showMask:false,contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"empi/search_by_um",data:JSON.stringify({umAccount:b}),dataType:"json"};var d=Utils.myAjaxHandler(a);d.error(function(){$.paError("请求未响应，请检查网络连接！")});d.done(function(f){if(f.errorCode=="E0000000"){if(f.data!=""){c.showPatientInfo(f)}}else{$.paError(f.errorMessage)}})},showPatientInfo:function(g){var f=g.data;var e=this;if(f.patientInfo&&f.patientInfo!=""){if(e.patientRegisterView){e.patientRegisterView.clearData();e.patientRegisterView.fillPatiInfo(f.patientInfo,"pafc",function(){$("#pa-um-account").val(f.PAFC["umNum"]);$("#pa-company-name").val(f.PAFC["descr"]);$("#pa-department-name").val(f.PAFC["descr1"]);$("#pa-entry-date-str").val(f.PAFC["emplDate"]);$("#pa-staff-id").val(f.PAFC["emplId"]);$("#patiName").val(f.PAFC["lastName"]);if(f.PAFC["paicMobilePhone"]!=null&&f.PAFC["paicMobilePhone"]!=""){$("#phone").val(f.PAFC["paicMobilePhone"])}$("#sex_warpper").find("span[val='"+e.getGender(f.PAFC["sex"])+"']").addClass("checked").siblings("span").removeClass("checked");var i=f.PAFC["birthDate"];$("#birthday").val(i);var h=Utils.calcPatientAge(i);if(h!=""){var j=h.split(",");$("#age").val(j[0]);$("#month").val(j[1]);$("#age").removeClass("pawjzs-error");$("#month").removeClass("pawjzs-error")}})}}else{e.patientRegisterView.clearData();$("#pa-um-account").val(f.PAFC["umNum"]);$("#pa-company-name").val(f.PAFC["descr"]);$("#pa-department-name").val(f.PAFC["descr1"]);$("#pa-entry-date-str").val(f.PAFC["emplDate"]);$("#pa-staff-id").val(f.PAFC["emplId"]);$("#patiName").val(f.PAFC["lastName"]);if(f.PAFC["paicMobilePhone"]!=null&&f.PAFC["paicMobilePhone"]!=""){$("#phone").val(f.PAFC["paicMobilePhone"])}$("#sex_warpper").find("span[val='"+e.getGender(f.PAFC["sex"])+"']").addClass("checked").siblings("span").removeClass("checked");var b=f.PAFC["birthDate"];$("#birthday").val(b);var a=Utils.calcPatientAge(b);if(a!=""){var d=a.split(",");$("#age").val(d[0]);$("#month").val(d[1]);$("#age").removeClass("pawjzs-error");$("#month").removeClass("pawjzs-error")}var c=Utils.trimObj($("#patientno").attr("data-rule-id"));e.commonController.generatePatientNo(c)}$("#pa-data-info").show();e._setDatePicker()},_setDatePicker:function(){$("#pa-entry-date-str").datetimepicker({lang:"ch",format:"Y-m-d",maxDate:new Date().Format("yyyy-MM-dd"),timepicker:false,mask:false,onShow:function(){},onSelectDate:function(){}})},unBindDatePicker:function(){$("#pa-entry-date-str").off()},getGender:function(a){if("男"==a){return 1}else{if("女"==a){return 2}else{return 3}}}};