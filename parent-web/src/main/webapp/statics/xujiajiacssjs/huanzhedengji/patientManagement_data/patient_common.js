var dicts=["T2","T3","T4","T6","T8","T9","T10"];var ids=["marrayState","nation","country","cardType","aboBlood","rhBlood","profession"];var sex_map={"1":"男","2":"女","3":"保密"};var APPT_TYPE={"1":"初诊","2":"复诊"};var delList=[];var link_server=false;var regModel=getRegisterMethod();var isPafc=config_cache.isPafcClinic();var isMarkUpDate=isMakeUpDate();var PatientCommonMainController=function(){this._init()};PatientCommonMainController.prototype={_init:function(){var a=this;var b=$("#birthday");b.on("keypress",function(d){var c=$(this);var f=c.val();if(d.which===8){return}if(f!=null&&f.length==4){c.val(f+"-")}else{if(f.length==7){c.val(f+"-")}}});$("#age, #month").on("change",function(){var m=$.trim($("#age").val());var j=$.trim($("#month").val());if(m==""){m=0}if(j==""){j=0}if(isNaN(m)||isNaN(j)){return}var e;var h=$.trim(b.val());if(h!=null&&h!=""&&h!="必填项不能为空。"){var c=h.split("-");e=parseInt(c[2])}var l=Utils.calcPatientBirthday(m,j,e);l=l.replace(/\-/g,"/");if(new Date(l).getDate()==l.substring(l.length-2)){l=l.replace(/\//g,"-");b.val(l)}else{var d=l.split("/");var f=new Date();var g=f.getMonth()+1;var k=f.getDate();g=(g>9?g:"0"+g);k=(k>9?k:"0"+k);l=d[0]+"-"+g+"-"+k;b.val(l)}b.removeClass("pawjzs-error");b.parent().removeClass("pawjzs-error")});b.on("change",function(){a.setBirthDayMonthAndDay()});b.datetimepicker({lang:"ch",format:"Y-m-d",maxDate:new Date().Format("yyyy-MM-dd"),timepicker:false,mask:false,onShow:function(){},onSelectDate:function(){a.setBirthDayMonthAndDay()}});$("#remove_introducer").on("click",function(){$("#introducer").prop("disabled",false);$("#remove_introducer").css("display","none");$("#introducer").val("")});$(".radio-div > .radio").off("click").on("click",function(){var f=$(this);var d=f.attr("val");var c=f.parent().attr("data-target");if(!f.hasClass("checked")){f.addClass("checked").siblings().removeClass("checked")}var g=$("#"+c);if(d=="1"){g.removeClass("validate(required)").removeClass("pawjzs-error").attr("disabled","disabled").val("否认")}else{var e=g.data("data-cache")||"";g.addClass("validate(required)").removeClass("pawjzs-error").removeAttr("disabled").val(e)}$("#patientManager").ketchup()})},setBirthDayMonthAndDay:function(){var b=$.trim($("#birthday").val());var a=Utils.calcPatientAge(b);if(a!=""){var c=a.split(",");$("#age").val(c[0]).removeClass("pawjzs-error");$("#month").val(c[1]).removeClass("pawjzs-error")}},generatePatientNo:function(b){b=b||"";var c=new Date().getTime();var a={method:"GET",url:ContextClinc_Server+"empi/generatePatientNo?ruleId="+b+"&timestamp="+c,contentType:"application/json",dataType:"json"};var d=Utils.myAjaxHandler(a);d.done(function(f){if(f.errorCode=="E0000000"){var e=f.data.patientNo;$("#patientno").css("background-color","#fff").val(e).attr({"data-rule-id":b,"data-rule-no":e})}}).fail(function(e){}).always(function(){})},checkData:function(){var e=this;var c=$.trim($("#sex_warpper").find("span.checked").attr("val"));var g=$("#birthday").val();var a=$.trim($("#cardType").attr("val"));var d=$("#cardNum").val();if($("#cardType").val()=="居民身份证"&&Utils.trimObj(d)!=""){if(verfyIDCard(d)){var b=getGender(d);if(c!=b){$.paError("性别与身份证信息不符!");return false}var f=getBirthDay(d);if(f!=""&&f!=g){$("#birthday").addClass("pawjzs-error");$.paError("出生日期与身份证信息不符!");return false}}}return true},getPatientTypeLable:function(){var b=this;var a={url:ContextClinc_Server+"empi/patient_no_rules",dataType:"json",method:"GET"};var c=Utils.myAjaxHandler(a);c.done(function(d){if(d){if(d.data!=null&&d.data.length>0){$("#patient_type_row").show();var e="";$.each(d.data,function(f,h){var g=d.data[f];if(f==0){e+='<span class="patient_type selected" data-rule-id="'+g.ruleId+'">'+g.patientType+"</span>"}else{e+='<span class="patient_type" data-rule-id="'+g.ruleId+'">'+g.patientType+"</span>"}});b.generatePatientNo(d.data[0]["ruleId"]);$("#patient_type_label").html(e)}else{b.generatePatientNo("");$("#patient_type_row").hide()}}}).fail(function(d){$.paWarn("数据请求失败!")})},enableOrDisableSelect:function(c,b){var a=this;if(b==1){a.disabledAllInput($("#"+c).parent("div"))}else{a.enableAllInput($("#"+c).parent("div"))}},disabledAllInput:function(a){a.each(function(){var c=$(this);c.addClass("wjzs-disabled");c.find("input").addClass("wjzs-disabled");c[0].setAttribute("readOnly","true");c.find("input").each(function(){$(this)[0].setAttribute("readOnly","true")});c.find(".drop").each(function(){$(this).removeClass("drop");$(this).addClass("drop-disabled")});if(c.hasClass("drop")){c.removeClass("drop");c.addClass("drop-disabled")}if(c.hasClass("checkboxes")){c[0].removeAttribute("readOnly");c.removeClass("wjzs-disabled");c.append("<div class='select-disabled'>&nbsp;</div>");c.find("li").each(function(){$(this).addClass("wjzs-disabled")})}if(c.find("span").hasClass("radio")){c[0].removeAttribute("readOnly");c.removeClass("wjzs-disabled");var b=c.position().top;c.append("<div class='select-disabled' style='top:"+b+"px'>&nbsp;</div>");c.find("span").each(function(){$(this).addClass("wjzs-disabled")})}})},enableAllInput:function(a){a.each(function(){var b=$(this);b.removeClass("wjzs-disabled");b.find("input").removeClass("wjzs-disabled");b[0].removeAttribute("readOnly");b.find("input").each(function(){$(this)[0].removeAttribute("readOnly")});b.find(".drop-disabled").each(function(){$(this).removeClass("drop-disabled");$(this).addClass("drop")});if(b.hasClass("drop-disabled")){b.removeClass("drop-disabled");b.addClass("drop")}if(b.find("span").hasClass("radio")){b.find(".select-disabled").remove();b.find("span").each(function(){$(this).removeClass("wjzs-disabled")})}if(b.hasClass("checkboxes")){b.find(".select-disabled").remove();b.find("li").each(function(){$(this).removeClass("wjzs-disabled")})}})},initAllDropdown:function(){var a=[{id:"01",txt:"父母"},{id:"02",txt:"子女"},{id:"03",txt:"配偶"},{id:"04",txt:"兄弟姐妹"},{id:"05",txt:"朋友"},{id:"06",txt:"其它亲属"}];$("#contact_person_rel").WJZSDropdown(a,{},function(b,c){});$("#contact_person_rel").SelectWJZSDropdownFirstItem()},thinkIntroducer:function(){var c=this;var b={columns:[{display:"类型",dataKey:"INTRODUCER_ROLE_NAME",width:70},{display:"姓名",dataKey:"INTRODUCER_NAME",width:80},{display:"手机",dataKey:"INTRODUCER_MOBILE",width:100}],selectFirst:true,formatResult:function(d){return d.INTRODUCER_NAME},formatMatch:function(f,e,d){return f.INTRODUCER_NAME+"--"+f.INTRODUCER_MOBILE},matchContains:"word",autoFill:false,canedit:true,width:320,ajaxOptions:{method:"POST"},multiple:false,multipleSeparator:", ",highlight:function(e,d){return e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+d.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:180};var a=ContextClinc_Server+"patient/search_introducer";$("#introducer").autocomplete(a,b).result(function(d,f,e){$("#introducer").attr({introducer_id:f.INTRODUCER_ID,introducer_role:f.INTRODUCER_ROLE,introducer_name:f.INTRODUCER_NAME}).val(f.INTRODUCER_NAME).removeClass("pawjzs-error");$("#introducer").prop("disabled",true);$("#remove_introducer").css("display","block")})},setPreExamStatus:function(a,b,d){var c=$("#"+a).parent().parent();if(b){c.children().find("span[val='1']").addClass("checked");c.children().find("span[val='2']").removeClass("checked");$("#"+a).removeClass("validate(required)").removeClass("pawjzs-error").attr("disabled","disabled").val("否认")}else{c.children().find("span[val='1']").removeClass("checked");c.children().find("span[val='2']").addClass("checked");if(a=="allergy"||a=="pastMedical"){$("#"+a).addClass("validate(required)").removeClass("pawjzs-error").removeAttr("disabled").val(d);$("#"+a).data("data-cache",d)}else{$("#"+a).removeClass("pawjzs-error").attr("disabled","disabled").val("否认")}}}};function isBlankStr(a){if(a!=null&&a!=undefined&&a!=""){return false}else{return true}}function trimObjOrDefault(a,b){if(isBlankStr(a)){return b}return a}function showDataCheckNull(a){if(isBlankStr(a)){return""}return a}function getGenderName(b){if(b=="1"){return"男"}else{if(b=="2"){return"女"}else{if(b=="3"){return"保密"}else{return b}}}}function getTreateTypeName(a){if("1"==a||""==a){return"初诊"}else{return"复诊"}}var NOMAL_REG="1";var GUAHAO_REG="2";var CONSULT_REG="3";function getRegisterMethod(){var a=config_cache.getCache("medical_user_data");var b=a.clinicParams;for(var c in b){if(b[c].parameterCode=="3008"){var d=b[c].parameterValue;if(d!=null&&d!=""){return d}else{return"1"}}}return"1"}function isMakeUpDate(){var a=config_cache.getCache("medical_user_data");var b=a.clinicParams;for(var c in b){if(b[c].parameterCode=="3014"){var d=b[c].parameterValue;if(d!=null&&d=="1"){return true}}}return false}function setRadioValue(a,b){$("#"+a).find(".radio").each(function(c,d){if($(this).attr("val")==b){$(this).addClass("checked","checked").siblings().removeClass("checked");return}})}function getRadioValue(a){var b="";$("#"+a).find(".radio").each(function(c,d){if($(this).hasClass("checked")){b=$(this).attr("val");return false}});return b}function splitStrByLength(c,a){var b=[];b.push(c);if(c){if(c.length>a){b.push(c.substr(0,a)+"..")}else{b.push(c)}}return b}function handlePrint(a,b){printRegister(a,b)}function printRegister(b,e,m,g,f){var d=config_cache.getCache("medical_user_data");var l=_.find(d.clinicParams,function(q){return q.parameterCode=="1601"});var n=l&&l.parameterValue;var j=_.find(d.clinicParams,function(q){return q.parameterCode=="3008"});var a="";var k=_.find(d.clinicParams,function(q){return q.parameterCode=="1603"});var c=k&&k.parameterValue;if(e!=null&&e){a=j&&j.parameterValue}else{a="1"}var n=false;if(m!=null&&m==false){n=false}else{if(c=="1"){n=l!=null&&l.parameterValue=="1"}else{n=false}}if(!n&&a=="1"){return}var h={triageId:b};var p={method:"POST",url:ContextClinc_Server+"/empi/print_reg",dataType:"json",contentType:"application/json;charset=utf-8",data:JSON.stringify(h),showMask:true};var o=Utils.myAjaxHandler(p);o.done(function(q){if(q.errorCode=="E0000000"&&q.data){if(f){q.data.patient_balance=f}wjPrintUtils.getPrintSetting(wjPrintUtils.printFunction.patientRegister,function(s,r){if(s==1){registerPrint.doPrint(q.data,a,n)}else{if(s==2){$.paSuccess("正在打印...");q.data.REG_PRICE=fixByRound(q.data.REG_PRICE,2)+"元";q.data.REG_PRICE_SRC=fixByRound(q.data.REG_PRICE_SRC,2)+"元";q.data.PATIENT_GENDER=getGenderName(q.data.PATIENT_GENDER);q.data.PATIENT_BIRTH_DATE=q.data.PATIENT_BIRTH_DATE==null?"":getAgeByBirthDay(q.data.PATIENT_BIRTH_DATE)+"岁";q.data.TREATMENT_TYPE=getTreatmentType(q.data.TREATMENT_TYPE);q.data.MOBILE_PHONE_NUMBER=q.data.MOBILE_PHONE_NUMBER==null?"":q.data.MOBILE_PHONE_NUMBER;wjPrintUtils.print(r,{registerInfo:q.data},function(u){if(u.code!=SUCCESSCODE){$.paWarn(u.message)}})}else{$.paWarn("请先配置打印参数！")}}})}}).fail(function(q){}).always(function(){})}function getTreatmentType(a){var b="";switch(a){case 1:b="初诊";break;case 2:b="复诊";break;default:break}return b}function parseIdentityCardNo(c){var b={};var a={11:"北京",12:"天津",13:"河北",14:"山西",15:"内蒙古",21:"辽宁",22:"吉林",23:"黑龙江",31:"上海",32:"江苏",33:"浙江",34:"安徽",35:"福建",36:"江西",37:"山东",41:"河南",42:"湖北",43:"湖南",44:"广东",45:"广西",46:"海南",50:"重庆",51:"四川",52:"贵州",53:"云南",54:"西藏",61:"陕西",62:"甘肃",63:"青海",64:"宁夏",65:"新疆",71:"台湾",81:"香港",82:"澳门",91:"国外 "};if(!c||!/^\d{6}(18|19|20)?\d{2}(0[1-9]|1[012])(0[1-9]|[12]\d|3[01])\d{3}(\d|X)$/i.test(c)){return{msg:"身份证号格式错误"}}if(a[c.substr(0,2)]){b.province=a[c.substr(0,2)]}else{b.province="未知"}if(c.length==15){b.birthday="19"+c.substr(6,6);if(parseInt(c.substr(12,3))%2==0){b.gender="女"}else{b.gender="男"}}else{if(c.length==18){b.birthday=c.substr(6,8);if(parseInt(c.substr(14,3))%2==0){b.gender="女"}else{b.gender="男"}}}return b}var VisitCardType={"01":"居民身份证","02":"居民户口簿","03":"护照","04":"军官证","05":"驾驶证","06":"港澳居民通行证","07":"台湾居民通行证","98":"深圳市居民健康卡","99":"其他法定有效证件"};function fmoney(b,d){if(b==undefined||b==""){return b}d=d>0&&d<=20?d:2;b=(b+"").replace(/[^\d\.-]/g,"");c=b.split(".")[1]||0;if(c>d){}else{b=parseFloat(b).toFixed(d)+""}var a=b.split(".")[0].split("").reverse(),c=b.split(".")[1];t="";for(i=0;i<a.length;i++){t+=a[i]+((i+1)%3==0&&(i+1)!=a.length&&(a[i+1]!="-")?",":"")}return t.split("").reverse().join("")+"."+c}function getBirthdayFromIdCard(a){var b="";if(a!=null&&a!=""){if(a.length==15){b="19"+a.substr(6,6)}else{if(a.length==18){b=a.substr(6,8)}}b=b.replace(/(.{4})(.{2})/,"$1-$2-")}return b}function closeChargePay(){$("#pay_pop").hide();$("#layer_close_btn").click()}function saveChargePaySuccess(){$("#pay_pop").hide();$.paSuccess("收费成功",1000,function(){});setTimeout(function(){window.location.href="./patientManagement.html"},500)};