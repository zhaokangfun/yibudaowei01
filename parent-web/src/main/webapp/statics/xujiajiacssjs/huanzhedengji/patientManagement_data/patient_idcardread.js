var IdCardInfoController=function(a){this.commonController=a;this.fromPsSystem=0;this.patientRegisterView};IdCardInfoController.prototype={isInit:false,setRegisterView:function(a){this.patientRegisterView=a},showRelativeInfoPannel:function(){this._bindEvent()},resetRelativeInfoPannel:function(){var a=this;$("#patiName").val("");$("#birthday").val("");$("#age").val("");$("#month").val("");a.setSelectIdValue("cardType","");$("#cardNum").val("");$("#sex_warpper").val("");$("#sex_warpper").val("");a.setSelectIdValue("patiSource","");$("#phone").val("");a.setSelectIdValue("country","");a.setSelectIdValue("nation","")},isContainsTag:function(){var a=config_cache.getCache("medical_user_data");var b=a.clinic;if(b&&b.tags&&$.inArray("TYKZ",b.tags)){return true}return false},_bindEvent:function(){var a=this;if(a.isContainsTag()){$("#read_idCard").show();$("#read_idCard").off("click").on("click",function(){var c=navigator.userAgent.toUpperCase().indexOf("FIREFOX")>0?true:false;var f=(!!window.ActiveXObject||"ActiveXObject" in window);var b=window.navigator.userAgent.indexOf("Chrome")>0?true:false;if(c||b){try{a.firefoxReadCard()}catch(d){}}else{if(f){try{a.ieReadCard()}catch(d){}}else{$.paWarn("请选择IE、火狐或者谷歌浏览器")}}})}},firefoxReadCard:function(){var k=this;var e=document.getElementById("RoutonReader");var j=document.getElementById("formCard");try{if(false==this.isInit){var b=e.setPortNum(0);if(b==0){$.paError("端口初始化失败！")}isInit=true}}catch(h){var c={msg:"您需要下载并安装控件才能读取身份证，确认下载？",cancelTxt:"取消",saveTxt:"确定",onYes:function(){window.open("../resources/plugin/readIdCard/NPAPI.zip")}};$.paConfirm(c);return}e.Flag=0;e.PhotoPath="D:\\";var i=e.ReadCard();if(i!=144){e.PhotoPath="";i=e.ReadCard()}if(i==144){k.resetRelativeInfoPannel();var f=e.CardNo();k.getEmpiByIdCard(f);$("#patiName").val(e.NameL());var a=e.BornL().replace("年","-").replace("月","-").replace("日","");$("#birthday").val(a);var g=Utils.calcPatientAge(a);if(g!=""){var d=g.split(",");$("#age").val(d[0]);$("#month").val(d[1]);$("#age").removeClass("pawjzs-error");$("#month").removeClass("pawjzs-error")}k.setSelectIdValue("cardType","01");$("#cardNum").val(f);$("#sex_warpper").find("span[val='"+k.getGender(e.SexL())+"']").addClass("checked").siblings("span").removeClass("checked")}else{k.resetRelativeInfoPannel();if(i==2){$.paWarn("请重新将卡片放到读卡器上！")}if(i==65){$.paError("读取数据失败！")}}},ieReadCard:function(){var c=this;var b;try{var g=new ActiveXObject("IDRCONTROL.IdrControlCtrl.1")}catch(i){$.paError("请安装插件和驱动");c.installReadCardApp()}IdrControl1.RepeatRead(1);b=IdrControl1.ReadCard("1001","");if(b==1){c.resetRelativeInfoPannel();var f=IdrControl1.GetCode();c.getEmpiByIdCard(f);$("#patiName").val(IdrControl1.GetName());var d=IdrControl1.GetBirthYear()+"-"+IdrControl1.GetBirthMonth()+"-"+IdrControl1.GetBirthDay();$("#birthday").val(d);var a=Utils.calcPatientAge(d);if(a!=""){var h=a.split(",");$("#age").val(h[0]);$("#month").val(h[1]);$("#age").removeClass("pawjzs-error");$("#month").removeClass("pawjzs-error")}c.setSelectIdValue("cardType","01");$("#cardNum").val(f);$("#sex_warpper").find("span[val='"+c.getGender(IdrControl1.GetSex())+"']").addClass("checked").siblings("span").removeClass("checked")}else{c.resetRelativeInfoPannel();if(b==-1){$.paError("端口初始化失败！")}if(b==-2){$.paError("请重新将卡片放到读卡器上！")}if(b==-3){$.paError("读取数据失败！")}if(b==-4){$.paError("生成照片文件失败，请检查设定路径和磁盘空间！")}}},setSelectIdValue:function(d,c){var a=$("#"+d);var b=a.parent().find("li[data-value='"+c+"']").text();a.val(b);a.attr("val",c)},installReadCardApp:function(){var a={msg:"您需要安装读卡设备，确认下载？",cancelTxt:"取消",saveTxt:"确定",onYes:function(){window.open("../resources/plugin/readIdCard/IE.zip")}};$.paConfirm(a)},getEmpiByIdCard:function(b){var c=this;var e;var a={asyn:true,showMask:true,contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"empi/read_id_card?idCardNo="+b,dataType:"json"};var d=Utils.myAjaxHandler(a);d.error(function(){$.paError("请求未响应，请检查网络连接！")});d.done(function(f){if(f.errorCode=="E0000000"){if(f.data!=""){c.initPatientInfo(f)}}else{$.paError(f.errorMessage)}})},initPatientInfo:function(d){var c=d.data;var b=this;if(c.patientInfo&&c.patientInfo!=""){if(b.patientRegisterView){b.patientRegisterView.clearData();b.patientRegisterView.fillPatiInfo(c.patientInfo,{flag:"idcard"},function(){if(c.patientInfo.patiSource){b.setSelectIdValue("patiSource",c.patientInfo.patiSource)}if(c.patientInfo.mobilePhoneNumber){$("#phone").val(c.patientInfo.mobilePhoneNumber)}})}}else{var a=Utils.trimObj($("#patientno").attr("data-rule-id"));b.commonController.generatePatientNo(a)}},getGender:function(a){if("男"==a){return 1}else{if("女"==a){return 2}else{return 3}}}};