var isInit=false;$(function(){bindReadCardEvent()});function bindReadCardEvent(){$("#readCardId").click(function(){if(preReadCard()){$("#basicDiv").ableToFinish();return}var b=navigator.userAgent.toUpperCase().indexOf("FIREFOX")>0?true:false;var d=(!!window.ActiveXObject||"ActiveXObject" in window);var a=window.navigator.userAgent.indexOf("Chrome")>0?true:false;if(b||a){try{readCard()}catch(c){}}else{if(d){try{IEReadCard()}catch(c){}}else{$.paWarn("请选择IE、火狐或者谷歌浏览器")}}})}function preReadCard(){var a={IdCardNo:$("#fidCardNo").val(),clientName:$("#fname").val(),clientSex:getSelectValue($("#fpatientSexDiv")),clientBirthday:$("#fpatientBirthDate").val(),clientIdType:getSelectValue($("#fidCardTypeCodeDiv"))};if($.trim(a.IdCardNo)!=""&&$.trim(a.clientName)!=""&&$.trim(a.clientSex)!=""&&$.trim(a.clientBirthday)!=""&&$.trim(a.clientIdType)!=""){if(checkProvince($.trim(a.IdCardNo))===false){return true}if(checkBirthday($.trim(a.IdCardNo))===false){return true}if(checkParity($.trim(a.IdCardNo))===false){return true}getAppointmentInfo(a);return true}return false}function readCard(){var e=byId("RoutonReader");var b=byId("formCard");try{if(false==isInit){var a=e.setPortNum(0);if(a==0){$.paError("端口初始化失败！")}isInit=true}}catch(c){var d={msg:"您需要下载并安装控件才能读取身份证，确认下载？",cancelTxt:"取消",saveTxt:"确定",onYes:function(){openDownload("../resources/brower/plugin/idcard/NPAPI.zip")}};$.paConfirm(d);return}e.Flag=0;e.PhotoPath="D:\\";var f=e.ReadCard();if(f!=144){e.PhotoPath="";f=e.ReadCard()}if(f==144){setBasicInfo(e.NameL(),e.BornL().replace("年","-").replace("月","-").replace("日",""),e.SexL(),1,e.CardNo())}else{$("#fname").val("");$("#fpatientBirthDate").val("");$("#fpatientSex").val("");$("#fidCardNo").val("");$("#fage").val("");if(f==2){$.paWarn("请重新将卡片放到读卡器上！")}if(f==65){$.paError("读取数据失败！")}}}function IEReadCard(){var a;var f;var b;var d;try{var g=new ActiveXObject("IDRCONTROL.IdrControlCtrl.1")}catch(h){var c={msg:"您需要下载并安装控件才能读取身份证，确认下载？",cancelTxt:"取消",saveTxt:"确定",onYes:function(){openDownload("../resources/brower/plugin/idcard/IE.zip")}};$.paConfirm(c)}IdrControl1.RepeatRead(1);a=IdrControl1.ReadCard("1001","");if(a==1){setBasicInfo(IdrControl1.GetName(),IdrControl1.GetBirthYear()+"-"+IdrControl1.GetBirthMonth()+"-"+IdrControl1.GetBirthDay(),IdrControl1.GetSex(),1,IdrControl1.GetCode())}else{$("#fname").val("");$("#fpatientBirthDate").val("");$("#fpatientSex").val("");$("#fidCardNo").val("");$("#fage").val("");if(a==-1){$.paError("端口初始化失败！")}if(a==-2){$.paWarn("请重新将卡片放到读卡器上！")}if(a==-3){$.paError("读取数据失败！")}if(a==-4){$.paError("生成照片文件失败，请检查设定路径和磁盘空间！")}}}function byId(a){return document.getElementById(a)}function getAge(h){try{var a=h.match(/^(\d{1,4})(-|\/)(\d{1,2})\2(\d{1,2})$/);if(a==null){return""}var g=new Date(a[1],a[3]-1,a[4]);if(g.getFullYear()==a[1]&&(g.getMonth()+1)==a[3]&&g.getDate()==a[4]){var f=new Date().getFullYear();var i=new Date().getMonth()+1;var c=new Date().getDate();if(f-a[1]==0){return 0}if(a[3]>i){return(f-a[1]-1)}else{if(a[3]==i){if(a[4]<c){return(f-a[1])}else{return(f-a[1]-1)}}else{if(a[3]<i){return(f-a[1])}}}}return""}catch(b){return""}}function getAppointmentInfo(c){Utils.addLoadingMaskTo($("body"),"正在读取寿险体检函……");var a={type:"POST",contentType:"application/json;charset=utf-8",url:Context_MEC_Server+"pefoundation/get/patient",data:JSON.stringify(c),dataType:"json"};var b=Utils.myAjaxHandler(a);b.done(function(h){var f=h.data;if(f){Utils.removeLoadingMaskFrom();if(f.appointment==null){if(f.recorded==true){$.paWarn("没有搜索到寿险体检函，请确认是否已登记体检")}else{if(f=="未设置机构代码"){$.paWarn("未设置机构代码")}else{$.paWarn("没有搜索到寿险体检函")}}return}var d=f.appointment.recordItems;$("#examAgent").val(f.appointment.examAgent);$("#agentPhone").val(f.appointment.agentPhone);if(d){_isLifeInsuranceExam=true;showSelectItems(d);comboHidden()}var i=f.appointment.agentPhone;try{setPatientData(f.appointment)}catch(g){}if(i){showAppointData(i,true)}else{$(".pe-report-info").css("display","none")}setHeight()}}).fail(function(d){Utils.removeLoadingMaskFrom()}).always(function(){})}function setBasicInfo(f,a,d,c,b){if(f){$("#fname").val(f);$("#fname").data("preValue",f);$("#fname").blur()}if(a){$("#fpatientBirthDate").val(a)}if(d){setSelectValue($("#fpatientSexDiv"),d=="男"?1:2);$("#fpatientSex").data("preValue",d);$("#fpatientSex").blur()}if(c!=null&&c!=undefined){setSelectValue($("#fidCardTypeCodeDiv"),c)}if(b){$("#fidCardNo").val(b)}var e={IdCardNo:b,clientName:f,clientSex:d=="男"?1:2,clientBirthday:a,clientIdType:c};getAppointmentInfo(e);$("#fage").val(getAge($("#fpatientBirthDate").val()))};