var handleFlag=1;var empiId="";var triageId="";var triageInfo={};var visitInfo={};var fromHealthPro=false;var regAction,regView,commonController,ybDJObj;$(function(){if(cacheUtils.isChainClinic()){$("#pat-list-table tr:eq(0)").append($('<th width="15%">建档门店<th>'))}switch(regModel){case NOMAL_REG:$("#read_sicard_btn").hide();$("#clinic-doctor").show();$("#guahao-reg").hide();$(".registration-fee").hide();$("#consultant").hide();$("#guahao-doctor").removeClass("validate(required)");$("#guahao-dept").removeClass("validate(required)");break;case GUAHAO_REG:$("#clinic-doctor").hide();$("#consultant").hide();$("#reg_complete_btn").text("确认登记并收费");$("#guahao-reg").show();$(".registration-fee").show();$("#print-guahao").show();if(config_cache.getCache("guahao_print_checked")){$("#print-guahao").children("ul").children("li").addClass("checked")}break;case CONSULT_REG:$("#read_sicard_btn").hide();$("#clinic-doctor").hide();$("#guahao-reg").hide();$(".registration-fee").hide();$("#consultant").show();$("#guahao-doctor").removeClass("validate(required)");$("#guahao-dept").removeClass("validate(required)");break}if(Utils.getQueryString("visitId")||""!=""){fromHealthPro=true;visitInfo={visitId:Utils.getQueryString("visitId")||"",memberId:Utils.getQueryString("memberId")||"",visitName:Utils.getQueryString("visitName")||"",visitSex:Utils.getQueryString("visitSex")||"",visitBrithday:Utils.getQueryString("visitBrithday")||"",visitIdCardTypeCode:Utils.getQueryString("visitIdCardTypeCode")||"",visitIdCardCode:Utils.getQueryString("visitIdCardCode")||"",visitMobile:Utils.getQueryString("visitMobile")||"",address:Utils.getQueryString("address")||"",prdId:Utils.getQueryString("prdId")||"",cardId:Utils.getQueryString("cardId")||"",serviceId:Utils.getQueryString("serviceId")||"",serviceName:Utils.getQueryString("serviceName")||"",couponName:Utils.getQueryString("couponName")||"",prdPrice:Utils.getQueryString("prdPrice")||"",prdPriceUnit:Utils.getQueryString("prdPriceUnit")||""}}commonController=new PatientCommonMainController();regAction=new PatientRegisterAction(commonController);var g=new PatientLabelAction(regAction);var c=new PatientMemberAction(regAction);var f=new ApptRecordOperaterAction(regAction);var b=new IdCardInfoController(commonController);var d=new PaUmInfoController(commonController);regView=new PatientRegisterView(regAction,g,c,commonController,d);b.setRegisterView(regView);d.setRegisterView(regView);var a=new PatientSearchAction(regAction,regView);new PatientRegisterMain(regView,regAction,g,c,commonController,f,d,b);ybDJObj=new PatientYb(commonController,regView,regAction);$("#patientManagement").paKeyHandle({necessary:true,clz:"enterNext"})});var PatientRegisterMain=function(f,g,h,b,i,d,c,a){this.patientRegisterView=f;this.patientRegisterAction=g;this.patientRegisterAction.setView(f);this.patientRegisterAction.setAction(h);this.patientMemberAction=b;this.patientLabelAction=h;this.commonController=i;this.apptRecordOperaterAction=d;this.paUmInfoController=c;this.idCardInfoController=a;this.init();this.patientLabelAction._init();this.patientMemberAction._init()};PatientRegisterMain.prototype={init:function(){$("#discountInput").hide();var c=this;$("body").click(function(d){if(!$(d.target).closest(".small-table-box").length){$(".small-table-box").hide()}});$("#patiName").data("apptInfo","");$("#same_name_div").on("click",".patient_same_line",function(){var d=$(this);if(d.hasClass("selected")){d.removeClass("selected");$("#patient_same_confirm").attr("clickFlag",false);$("#patient_same_confirm").addClass("disabled")}else{d.addClass("selected").siblings().removeClass("selected");$("#patient_same_confirm").attr("clickFlag",true);$("#patient_same_confirm").removeClass("disabled")}var f=d.attr("patient_same_id")||"";$("#patient_same_confirm").attr("data-id",f);$("#patient_same_confirm").attr("data-patient-no",d.attr("data-patient-no")||"")});$("#patient_same_confirm").on("click",function(){var f=$("#patient_same_confirm").attr("clickFlag");var h=$("#patient_same_confirm").attr("data-id");var d=$("#patient_same_confirm").attr("data-patient-no");var g=c.getData(1,h,d);if(f=="true"){if(ybDJObj.isYbReg()&&ybDJObj.isNeedYbGhOrRegOperate()){if(ybDJObj.miTypeCode==MI_TYPE_ENUM.YB_SHENZHEN_NEW){ybDJObj.setYBRegParams(g)}ybDJObj.regSubmit(g)}else{c.patientRegisterAction.patientSubmit(g)}$(".popup").hide()}});$("#reg_complete_btn").on("click",function(){if(link_server){return}link_server=true;setInterval(function(){link_server=false},1000);if(!c.commonController.checkData()){return}var d=$("#patientManager").ableToFinish();if(!d){return}if(regModel==GUAHAO_REG){var f=$("#print-guahao").children("ul").children("li");if(f.hasClass("checked")){config_cache.setCache("guahao_print_checked","checked")}else{config_cache.removeCache("guahao_print_checked")}if($.trim($("#guahao-dept").attr("val"))==""||$.trim($("#guahao-doctor").attr("val"))==""){$.paAlert("挂号信息不完整");return}if($("#doctor-cure-amount").text()==""){$.paAlert("该医生未设置诊金");return}}var g=c.getData();if(ybDJObj.isYbReg()&&ybDJObj.isNeedYbGhOrRegOperate()){console.log("医保登记");if(ybDJObj.miTypeCode==MI_TYPE_ENUM.YB_SHENZHEN_NEW){ybDJObj.setYBRegParams(g)}ybDJObj.regSubmit(g)}else{c.patientRegisterAction.patientSubmit(g)}});$("#apptRegister").on("click",function(){var k=$(this).parent().parent();var g=k.data("apptInfo");var d=g.apptType!=null?g.apptType:"";var l=$(this).attr("data-health-product-id");if(l!=null&&l!=""){var i=g.recordId;var l=$(this).attr("data-health-product-id");var h={IS_SUPPORT_EQUIVALENCE:$(this).attr("data-isSupportEquivalence"),HEALTH_PRODUCT_ITEM_ID:$(this).attr("data-health-product-item-id"),HEALTH_PRODUCT_ID:$(this).attr("data-health-product-id"),DEPOSIT_FLAG:$(this).attr("data-deposit_flag")};c.apptRecordOperaterAction.showHealthProductTreatement(i,$("#confirmButton"),h)}else{var f="";if(g.doctorId){f="appt"}var j={flag:f,treatmentType:g.apptType};c.patientRegisterView.showTodaySchedulePop(false);c.patientRegisterAction.getPatInfo(g.empiId,j);c.patientRegisterView.fillApptData(g);if(!isBlankStr(g.departmentId)){c.set_dept_doctor(g.departmentId,g.doctorId)}}});$("#apptDetails").on("click",function(){var g=$(this).parent().parent();var d=g.attr("data-record-id");var f=g.attr("data-appt-flag");c.apptRecordOperaterAction.getPatientInfoAndBookInfo(d,f,g)});$("#search_patient").on("click",function(){var d="";if(!$("#patiName").hasClass("pawjzs-error")){d=$.trim($("#patiName").val())}$(".popup").hide();$("#searchPatPop").show();if(d!=""){$("#search-input").val(d);$("#seach_pat").click()}});$("#patiName").on("keyup",function(f){if(f.which==13){var d="";if(!$("#patiName").hasClass("pawjzs-error")){d=$.trim($("#patiName").val())}$(".popup").hide();$("#searchPatPop").show();if(d!=""){$("#search-input").val(d);$("#seach_pat").click()}}});$("#remove_patiName").on("click",function(){c.patientRegisterView.clearData();c.patientRegisterAction.reloadPatientNo();$("#patiName").prop("disabled",false);$("#remove_patiName").css("display","none")});$("#clear_data").on("click",function(){c.init_dept_doctor();ybDJObj.restYbReg();c.patientRegisterView.clearData();c.patientRegisterView.resetYbData();c.patientRegisterAction.reloadPatientNo()});$("#health_product").on("click",function(){location.href="healthProducts.html"});var a=$("#set-date");$("#today_schedule").on("click",function(){$(".popup").hide();var d=new Date().Format("yyyy-MM-dd");a.datetimepicker({lang:"ch",format:"Y-m-d",timepicker:false,mask:false,onSelectDate:function(){c.patientRegisterAction.queryTodaySchedule()}});a.val(d);c.patientRegisterAction.queryTodaySchedule();c.patientRegisterView.showTodaySchedulePop(true)});$(".date-prev").off("click").on("click",function(){var d=a.val();var f=c.calcPreAftDate("",d);a.val(f);c.patientRegisterAction.queryTodaySchedule()});$(".date-next").off("click").on("click",function(){var d=a.val();var f=c.calcPreAftDate("add",d);a.val(f);c.patientRegisterAction.queryTodaySchedule()});if(isPafc){c.paUmInfoController.showRelativeInfoPannel()}c.idCardInfoController.showRelativeInfoPannel();$("#patientManager").ketchup();this.patientRegisterAction.getAddress(0);c.init_dept_doctor();$("#registrationType").children().on("click",function(){var d=getRadioValue("registrationType");if($("#doctor-cure-amount").attr("treatment-price")){var f=$("#doctor-cure-amount").attr("treatment-price-"+d);if(f){$("#doctor-cure-amount").text(fmoney(f,2));$("#doctor-cure-amount").attr("treatment-price",f)}}c.patientRegisterAction.setDoctorTreatmentPrice()});this.patientRegisterAction.initDictItem(function(h){if(h){for(var g=0;g<dicts.length;g++){c.patientRegisterView.initDropdown(h[dicts[g]],ids[g])}var d={idKey:"PAT_SOURCE_ID",txtKey:"PAT_SOURCE_NAME",isNeedClear:false,isNeedThink:true};$("#patiSource").WJZSDropdown(h.patiSource,d,function(i,j){});$("#patiSource").SelectWJZSDropdownFirstItem();var f={idKey:"dictItemCode",txtKey:"dictItemName"};$("#patiType").WJZSDropdown(h.patiType,f,function(i,j){});c.patientRegisterView.initAllDropdown();if(fromHealthPro==true){c.patientRegisterAction.getPatientInfoByVisit()}}});$("#detail_title").on("click",function(){$("#detail_container").slideToggle();if($(this).children("h3").hasClass("detail_more_down")){$(this).children("h3").removeClass("detail_more_down").addClass("detail_more_up")}else{$(this).children("h3").removeClass("detail_more_up").addClass("detail_more_down")}});$("#patient_type_label").on("click",".patient_type",function(){var g=$("#patiName").attr("data-id")||"";var f=$("#patientno").attr("update-flag")||"";if(g==""||f=="1"){$(this).addClass("selected").siblings().removeClass("selected");var d=$(this).attr("data-rule-id");c.commonController.generatePatientNo(d)}});$(".pay-close").off("click").on("click",function(){closeChargePay()});c.commonController.getPatientTypeLable();c.commonController.thinkIntroducer();c.quicklySelect.allergyQueryData("allergy");c.quicklySelect.allergyQueryData("pastMedical");c.thinkPatientInfo();c.initMakeUpDate();c.getDiscountPermit();$("#discountInput").on("blur",function(){c.patientRegisterAction.setDoctorTreatmentPrice()});var b=0;$("#chooseDiscount").on("click",".radio",function(){if(b==$(this).index()){return}b=$(this).index();$("#discountInput").val("");$("#discountInput").hide();if(b==0){$("#discountInput").attr("disabled","disabled");$("#discountInput").removeClass("validate(number,numDecimal(2))");$("#discountInput").removeClass("validate(digits)");$("#discountInput").hide();$(".discountUnit").text("")}else{if(b==1){$("#discountInput").removeAttr("disabled").focus();$("#discountInput").removeClass("validate(number,numDecimal(2))");$("#discountInput").addClass("validate(digits)");$("#discountInput").show();$(".discountUnit").text("%")}else{if(b==2){$("#discountInput").removeAttr("disabled").focus();$("#discountInput").removeClass("validate(digits)");$("#discountInput").addClass("validate(number,numDecimal(2))");$("#discountInput").show();$(".discountUnit").text("元")}}}$("#patientManagement").ketchup();c.patientRegisterAction.setDoctorTreatmentPrice()})},getDiscountPermit:function(){var c={};var a={method:"POST",url:ContextClinc_Server+"charge/getDiscountPermit",data:c,dataType:"json",async:false,showMask:true};var b=Utils.myAjaxHandler(a);b.done(function(d){if(d!=null&&d.errorCode==SUCCESSCODE){dictData=d.data;session_cache.setCache("discountPermit",dictData.disaccount)}else{$.paError(d.errorMessage,null)}}).fail(function(d){$.paError("请求异常",null)}).always(function(){})},initMakeUpDate:function(){var a;switch(regModel){case NOMAL_REG:a=$("#clinic_makeup_date");break;case GUAHAO_REG:a=$("#guahao_makeup_date");break}if(isMarkUpDate&&a){$(".the-date-box").show();a.show();a.datetimepicker({lang:"ch",format:"Y-m-d",maxDate:new Date().Format("yyyy-MM-dd"),timepicker:false,mask:false,});a.val(Utils.timeStampToDateStr(new Date(),7))}else{$(".the-date-box").hide()}},set_dept_doctor:function(a,d){var c=this;if(isBlankStr(a)){return}switch(regModel){case NOMAL_REG:var b=$("#appDept").parent().find("li[data-value='"+a+"']");if(b.length>0){c.patientRegisterView.setSelectIdValue("appDept",a+"")}else{this.patientRegisterAction.getApptDeptByDepartmentId(a,function(g){var f=g.DEPT_NAME;$("#appDept").val(f);$("#appDept").attr("val",g.DEPT_ID)})}c.patientRegisterAction.getTodayApptDoctor(d);break;case GUAHAO_REG:var b=$("#guahao-dept").parent().find("li[data-value='"+a+"']");if(b.length>0){c.patientRegisterView.setSelectIdValue("guahao-dept",a+"")}else{this.patientRegisterAction.getApptDeptByDepartmentId(a,function(g){var f=g.DEPT_NAME;$("#guahao-dept").val(f);$("#guahao-dept").attr("val",g.DEPT_ID)})}c.patientRegisterAction.getTodayApptDoctor(d);break;case CONSULT_REG:}},init_dept_doctor:function(){var a=this;switch(regModel){case NOMAL_REG:case GUAHAO_REG:this.patientRegisterAction.getTodayApptDept(function(d){var b={idKey:"DEPT_ID",txtKey:"DEPT_NAME",isNeedClear:true};if(regModel==GUAHAO_REG){$("#guahao-dept").off("click");$("#guahao-dept").WJZSDropdown(d,b,function(g,h){if(h!=null&&h.isChange!=null&&h.isChange==true){$("#guahao-doctor").attr("val","").val("");$("#guahao-doctor").removeClass("pawjzs-error");$("#guahao-doctor").parent().removeClass("pawjzs-error");$("#guahao-dept").removeClass("pawjzs-error");$("#guahao-dept").parent().removeClass("pawjzs-error");$("#guahao-doctor").siblings(".wjzs-drop-menu").remove();$("#doctor-cure-amount").text("");$("#doctor-cure-amount").attr("treatment-price-1","");$("#doctor-cure-amount").attr("treatment-price-2","");$("#doctor-cure-amount").attr("treatment-price","");a.patientRegisterAction.getTodayApptDoctor()}});$("#guahao-dept").SelectWJZSDropdownFirstItem()}else{b.isNeedClear=false;var c=[];var f={DEPT_ID:"",DEPT_NAME:"未指定科室"};c.push(f);$.merge(c,d);$("#appDept").off("click");$("#appDept").WJZSDropdown(c,b,function(g,h){if(h!=null&&h.isChange!=null&&h.isChange==true){$("#appDoctor").attr("val","").val("");$("#appDoctor").removeClass("pawjzs-error");$("#appDept").removeClass("pawjzs-error");$("#appDept").parent().removeClass("pawjzs-error");$("#appDoctor").parent().removeClass("pawjzs-error");$("#appDoctor").siblings(".wjzs-drop-menu").remove();$("#appDoctor").attr("val","").val("");a.patientRegisterAction.getTodayApptDoctor()}});$("#appDept").SelectWJZSDropdownFirstItem()}});break;case CONSULT_REG:this.patientRegisterAction.initConsultDoctor(a);this.patientRegisterAction.getTodayApptDept(function(d){var b={idKey:"DEPT_ID",txtKey:"DEPT_NAME",isNeedClear:true};b.isNeedClear=false;var c=[];var f={DEPT_ID:"",DEPT_NAME:"未指定科室"};c.push(f);$.merge(c,d);$("#appDept_advisory").off("click");$("#appDept_advisory").WJZSDropdown(c,b,function(g,h){$("#appDoctor_advisory").attr("val","").val("");$("#appDoctor_advisory").removeClass("pawjzs-error");$("#appDept_advisory").removeClass("pawjzs-error");$("#appDept_advisory").parent().removeClass("pawjzs-error");$("#appDoctor_advisory").parent().removeClass("pawjzs-error");$("#appDoctor_advisory").siblings(".wjzs-drop-menu").remove();if(h!=null&&h.isChange!=null&&h.isChange==true){$("#appDoctor_advisory").attr("val","").val("");a.patientRegisterAction.getTodayApptDoctor()}else{$("#appDoctor_advisory").attr("val","").val("");a.patientRegisterAction.getTodayApptDoctor()}});$("#appDept_advisory").SelectWJZSDropdownFirstItem()});break}},quicklySelect:{allergyQueryData:function(d,f){var a=this;var h,c;if(d=="allergy"){h={dictType:"allergy_history"}}else{if(d=="pastMedical"){h={dictType:"ill_history"}}}var b={type:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"mdcDataDict/queryMdcDataDictByType",data:JSON.stringify(h),dataType:"json",showMask:true};var g=Utils.myAjaxHandler(b);g.done(function(i){if(i.errorCode==SUCCESSCODE){a.allergyInitQuicklySelect(i.data,d,f)}else{$.paError(i.errorMessage)}}).fail(function(i){$.paError("请求异常",null)}).always(function(){})},allergyInitQuicklySelect:function(f,c,d){var a=this;var b={idKey:"dictId",txtKey:"dictName",isNeedDel:[true,function(g){a.allergyDeleteItem(g,c)}],isNeedSave:[true,function(g){a.allergyInsertItem(g,c)}]};if(c=="allergy"){$("#allergy").setInputDrop(f,b,function(g){})}else{if(c=="pastMedical"){$("#pastMedical").setInputDrop(f,b,function(g){})}}if(d=="refresh"){if(c=="allergy"){$("#allergy").focus()}else{if(c=="pastMedical"){$("#pastMedical").focus()}}}},allergyDeleteItem:function(f,b){var d=f;var a={type:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"mdcDataDict/deleteDataDict",data:JSON.stringify(d),dataType:"json",showMask:true};var c=Utils.myAjaxHandler(a);c.done(function(g){if(g.errorCode==SUCCESSCODE){$.paSuccess("删除成功！");PatientRegisterMain.prototype.quicklySelect.allergyQueryData(b,"refresh")}else{$.paError(g.errorMessage)}}).fail(function(g){$.paError("请求异常",null)}).always(function(){})},allergyInsertItem:function(a,f){var a=a;var i=$.trim(a.dictName);if(!i){$.paWarn("添加内容不能为空!")}else{if(f=="allergy"){a.dictType="allergy_history";var d=$("#allergy").parent().find(".input_drop_data li");var b=false;if(d.length>=99){$.paWarn("常用过敏史数量达到最大数量限制！");return}d.each(function(){var j=$.trim($(this).data("tempData").dictName);if(i==j){b=true;return false}});if(b){$.paWarn("该过敏史已存在！");return}}else{if(f=="pastMedical"){a.dictType="ill_history";var d=$("#pastMedical").parent().find(".input_drop_data li");var b=false;if(d.length>=99){$.paWarn("常用既往史数量达到最大数量限制！");return}d.each(function(){var j=$.trim($(this).data("tempData").dictName);if(i==j){b=true;return false}});if(b){$.paWarn("该过敏史已存在！");return}}}a.dictName=i;var h=a;var c={type:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"mdcDataDict/insertDataDict",data:JSON.stringify(h),dataType:"json",showMask:true};var g=Utils.myAjaxHandler(c);g.done(function(j){if(j.errorCode==SUCCESSCODE){$.paSuccess("添加成功！");PatientRegisterMain.prototype.quicklySelect.allergyQueryData(f,"refresh")}else{$.paError(j.errorMessage)}}).fail(function(j){$.paError("请求异常",null)}).always(function(){})}}},calcPreAftDate:function(g,f){var d=new Date(f.replace(/-/g,"/"));var c=new Date();var a=null;if(g==="add"){a=new Date(d.setDate(d.getDate()+1))}else{a=new Date(d.setDate(d.getDate()-1))}var i=a.getMonth()+1;var h=i>9?i:"0"+i;var b=a.getDate()>9?a.getDate():"0"+a.getDate();return a.getFullYear()+"-"+h+"-"+b},thinkPatientInfo:function(){var d=this;var b={columns:[{display:"姓名",dataKey:"NAME",width:70},{display:"性别",dataKey:"PATIENTSEX",width:30},{display:"年龄",dataKey:"BIRTHDATEANDAGE",width:120},{display:"手机",dataKey:"MOBILEPHONENUMBER",width:100},{display:"最近就诊医生",dataKey:"RECENTDOCTORNAME",width:100}],selectFirst:true,formatResult:function(f){return f.NAME},formatMatch:function(h,g,f){return h.NAME+"--"+h.MOBILEPHONENUMBER},matchContains:"word",autoFill:false,canedit:true,ajaxOptions:{method:"POST"},multiple:false,multipleSeparator:", ",highlight:function(g,f){return g.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+f.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:180};if(cacheUtils.isChainClinic()){var c=0;b.columns[c].width=45;b.columns[++c].width=28;b.columns[++c].width=115;b.columns[++c].width=92;b.columns[++c].width=90;b.columns[++c]={display:"建档分店",dataKey:"CLINICNAME",width:95};b.width=615}else{b.width=530}var a=ContextClinc_Server+"patient/selectPatientListByPatName";$(".has-think-table").autocomplete(a,b).result(function(h,j,i){var k=j.EMPIID;var f=$(h.target).attr("data-flag");$("#patiName").data("apptInfo","");var g={flag:f};d.patientRegisterAction.getPatInfo(k,g,function(){$("#patiName").removeClass("pawjzs-error")});$(".input-text").removeClass("pawjzs-error");$(".input-textarea-text").removeClass("pawjzs-error");$("#patiName").prop("disabled",true);$("#remove_patiName").css("display","block")})},getData:function(W,b,R){var o=this;var c=$("#patiName").attr("data-edit");var n=$("#patiName").attr("data-id")||"";var m=Utils.trimObj($("#patientno").val());if(W&&W=="1"){c="create";n=b||"";if(R&&R!=""){m=R}}var t=Utils.trimObj($("#patiName").val());var D=$.trim($("#sex_warpper").find("span.checked").attr("val"));var k=$.trim($("#birthday").val());var l=Utils.trimObj($("#phone").val());var u=$.trim($("#cardType").attr("val"));var P=Utils.trimObj($("#cardNum").val());var d=Utils.trimObj($("#patiSource").attr("val"));var Y=Utils.trimObj($("#patiType").attr("val"));var J=Utils.trimObj($("#patiType").val());var F=Utils.trimObj($("#patientno").attr("data-rule-no"));var V=Utils.trimObj($("#patientno").attr("data-rule-id"));var A=Utils.trimObj($("#insurance_no").text());var M=Utils.trimObj($("#insurance_no").data("dnh"));var x=Utils.trimObj($("#insurance_no").data("instrancePassword"));var r=$.trim($("#patiProvince").attr("val"));var B=$.trim($("#patiCity").attr("val"));var f=$.trim($("#patiDistrict").attr("val"));var j=Utils.trimObj($("#addressDetail").val());var X=$("#patiProvince").val()+$("#patiCity").val()+$("#patiDistrict").val()+j;var L=Utils.trimObj($("#contact_person_name").val());var Q=Utils.trimObj($("#contact_person_phone").val());var H=Utils.trimObj($("#contact_person_rel").attr("val"));var K=Utils.trimObj($("#country").attr("val"));var v=Utils.trimObj($("#nation").attr("val"));var w=Utils.trimObj($("#marrayState").attr("val"));var g=Utils.trimObj($("#profession").attr("val"));var z=Utils.trimObj($("#company").val());var p=Utils.trimObj($("#aboBlood").attr("val"));var i=Utils.trimObj($("#rhBlood").attr("val"));var E=Utils.trimObj($("#email").val());var y=Utils.trimObj($("#remark").val());var T="";var C="";var h="";if($.trim($("#introducer").val())==""){T="";C=""}else{T=$.trim($("#introducer").attr("introducer_id"));C=$("#introducer").attr("introducer_role");h=$.trim($("#introducer").val())}var O={empiId:n,patientName:t,patientGender:D,patientBirthDate:k,mobilePhoneNumber:l,idCardTypeCode:u,idCardNo:P,patientSource:d,nationalityCode:K,nationalCode:v,blood:p,bloodRh:i,email:E,insuranceNo:A,instrancePassword:x,insuranceDnh:M};var s={empiId:n,classificationAndOccupations:g,maritalStatus:w,nameOfPatientEmployer:z,livingAddressProvince:r,livingAddressCity:B,livingAddressCounty:f,livingAddressCountryside:X,livingAddressVillage:j,contactPersonName:L,contactPersonPhoneNumber:Q,contactPersonTypeCode:H};if(isPafc){$.extend(s,o.paUmInfoController.getPatientData())}var G={patientNo:m,patiType:Y,patiTypeName:J,patLabel:o.patientLabelAction.currentSelectedLabel,patMember:o.patientMemberAction.memberCard,remark:y,orgPatientNo:F,ruleId:V,introducerId:T,introducerRole:C,introducerName:h};var a={};var N=$("#patiName").data("apptInfo");var I="";if(N!=null&&N!=""){I={recordId:trimObjOrDefault(N.recordId,""),isNeedPay:trimObjOrDefault(N.isNeedPay,0),payStatus:trimObjOrDefault(N.payStatus,0),payPrice:trimObjOrDefault(N.payPrice,""),apptDoctorId:trimObjOrDefault(N.doctorId,""),apptDepartmentId:trimObjOrDefault(N.departmentId,"")}}var q=o.getEmExamineInfo();switch(regModel){case GUAHAO_REG:case NOMAL_REG:var S=o.getTriageInfo();O.insuranceEncryptNo=S.insuranceEncryptNo;a.triage=S;break;case CONSULT_REG:var U=o.getConsultant();a.consultant=U;break}if(fromHealthPro==true){a.visitInfo=visitInfo}a=$.extend(a,{keyPatientInfo:O,extendPatientInfo:s,editFlag:c,examine:q,additionalInfo:G,apptInfo:I,apptRecord:I!=null||I!=""?I.recordId:"",regModel:regModel});return a},getEmExamineInfo:function(){return{ALLERGIES_HISTORY:$.trim($("#allergy").val()),PAST_HISTORY:$.trim($("#pastMedical").val())}},getTriageInfo:function(){var j=this;var d=$("#doctorType").attr("data-r-id");var b="";if(triageInfo.triageStatus!=null&&triageInfo.triageStatus==0){b=triageInfo.triageId}var p,m,i,o,k,l,h;if(regModel==GUAHAO_REG){p=$.trim($("#guahao-dept").attr("val"));m=j.getSelectText("guahao-dept");i=$.trim($("#guahao-doctor").attr("val"));o=j.getSelectText("guahao-doctor");k=getRadioValue("registrationType");l=$.trim($("#guahao-doctor").attr("yb-code"));h=$.trim($("#guahao-dept").attr("yb-code"))}else{p=$.trim($("#appDept").attr("val"));m=j.getSelectText("appDept");i=$.trim($("#appDoctor").attr("val"));o=j.getSelectText("appDoctor");k=$("#doctorType").getCheckedData()[0].id;l=$.trim($("#appDoctor").attr("yb-code"));h=$.trim($("#appDept").attr("yb-code"))}var g={departmentId:p||"",departmentName:m||"",doctorId:i||"",doctorName:o||"",recordId:d||"",treatmentType:k||"",triageId:b||"",miEmployeeCode:l,miDepartCode:h,discountType:1,discountValue:100,discountMoney:0,regPriceSrc:0,totalPriceFee:0,};if(regModel==GUAHAO_REG){var f=$("#doctor-cure-amount").attr("total-money");var a=$("#doctor-cure-amount").attr("treatment-id");var c="初诊诊金";if(getRadioValue("registrationType")=="2"){c="复诊诊金"}g.treatmentPrice=f||"";g.treatmentId=a||"";g.treatmentName=c||"";g.isRegistration=1;g.regPrice=f||"";g.discountType=$("#doctor-cure-amount").attr("discount-type")||1;g.discountValue=$("#doctor-cure-amount").attr("discount-value")||100;g.discountMoney=$("#doctor-cure-amount").attr("discount-money")||0;g.regPriceSrc=$("#doctor-cure-amount").attr("treatment-price-src")||0;g.totalPriceFee=g.regPrice}if(ybDJObj.isYbReg()){var n=ybDJObj.getYbRegData();g.totalPriceFee=n.total_price_fee||0;g=$.extend(g,n)}if(isPafc){g.fromPsSystem=j.paUmInfoController.fromPsSystem}if(isMarkUpDate){g.regDate=j.getMakeUpDate()}if(j.idCardInfoController.isContainsTag()){g.idCardTag="1"}console.log("getTriageInfo"+JSON.stringify(g));return g},getConsultant:function(){var a=$("#consultant_doctor_type").getCheckedData()[0].id;var d=$.trim($("#consultant_doctor").attr("val"));var g=$("#consultant_doctor").val();var h=$.trim($("#appDoctor_advisory").attr("val"));var b=$("#appDoctor_advisory").val();var c=$.trim($("#appDept_advisory").attr("val"));var f=$("#appDept_advisory").val();if(d==""){g=""}if(h==""){b=""}if(c==""){f=""}return{consultantDoctorType:a,consultantDoctorId:d,consultantDoctorName:g,doctorId:h,doctorName:b,departmentId:c,departmentName:f}},getSelectText:function(b){var a=$("#"+b).attr("val");if($.trim(a)==""){return""}else{return $("#"+b).val()}},getMakeUpDate:function(){var a;switch(regModel){case NOMAL_REG:a=$("#clinic_makeup_date");break;case GUAHAO_REG:a=$("#guahao_makeup_date");break}var b=$.trim(a.val());if(b==null||b==""){return Utils.timeStampToDateStr(new Date(),7)}else{return b}}};var PatientRegisterAction=function(a){this.patientRegisterView=null;this.patientLabelAction=null;this.commonController=a};PatientRegisterAction.prototype={setView:function(a){this.patientRegisterView=a},setAction:function(a){this.patientLabelAction=a},initDictItem:function(f){var b=this;var d={dicts:dicts};var a={method:"GET",url:ContextClinc_Server+"mdDictItem/getDicts",dataType:"json",data:d};var c=Utils.myAjaxHandler(a);c.done(function(h){if(h.errorCode=="E0000000"){var g=h.data;if(f){f.call(b,g)}}}).fail(function(g){}).always(function(){})},initConsultDoctor:function(c){$("#dept_advisory").hide();$("#doctor_advisory").hide();var b=[{id:"1",txt:"初诊"},{id:"2",txt:"复诊"}];$("#consultant_doctor_type").setInputForm(b,{type:"radio",idKey:"id",txt:"txt"},function(){var g=$("#consultant_doctor_type").getCheckedData()[0].id;if(g=="2"){$("#dept_advisory").show();$("#doctor_advisory").show();$("#appDoctor_advisory").attr("val","").val("");c.patientRegisterAction.getTodayApptDept(function(j){var h={idKey:"DEPT_ID",txtKey:"DEPT_NAME",isNeedClear:true};h.isNeedClear=false;var i=[];var k={DEPT_ID:"",DEPT_NAME:"未指定科室"};i.push(k);$.merge(i,j);$("#appDept_advisory").off("click");$("#appDept_advisory").WJZSDropdown(i,h,function(l,m){$("#appDoctor_advisory").attr("val","").val("");$("#appDoctor_advisory").removeClass("pawjzs-error");$("#appDept_advisory").removeClass("pawjzs-error");$("#appDept_advisory").parent().removeClass("pawjzs-error");$("#appDoctor_advisory").parent().removeClass("pawjzs-error");$("#appDoctor_advisory").siblings(".wjzs-drop-menu").remove();$("#appDoctor_advisory").attr("val","").val("");c.patientRegisterAction.getTodayApptDoctor()});$("#appDept_advisory").SelectWJZSDropdownFirstItem()})}else{$("#dept_advisory").hide();$("#doctor_advisory").hide()}}).checkedItem([{id:"1"}]);var f=$("#consultant_doctor_type").getCheckedData()[0].id;if(f=="2"){$("#dept_advisory").show();$("#doctor_advisory").show()}var a={method:"GET",url:ContextClinc_Server+"consult/consultants",contentType:"application/json",dataType:"json",};var d=Utils.myAjaxHandler(a);d.done(function(j){if(j.errorCode=="E0000000"){var i="";if(j.data&&j.data.length>0){i=j.data[0]["USER_ID"]}var g={idKey:"USER_ID",txtKey:"EMPLOYEE_NAME",isNeedClear:false};var h=[];h.push({USER_ID:"",EMPLOYEE_NAME:"未指定"});$.merge(h,j.data);$("#consultant_doctor").WJZSDropdown(h,g,function(k,l){});if(i!=""){$("#consultant_doctor").SetWJZSDropdownSelectedData(i)}else{$("#consultant_doctor").SelectWJZSDropdownFirstItem()}}}).fail(function(g){}).always(function(){})},reloadPatientNo:function(){var b=this;var a=$("#patientno").attr("data-rule-id");b.commonController.generatePatientNo(a)},getAddress:function(b,c){var d=this;var g={};var h;if(0==b){g.getProvince=1;h="patiProvince"}else{if(1==b){g.getCity=1;g.provinceSignature=$.trim($("#patiProvince").attr("val"));h="patiCity";if(g.provinceSignature==""){return}}else{if(2==b){g.getDistrict=1;g.provinceSignature=$.trim($("#patiProvince").attr("val"));g.citySignature=$.trim($("#patiCity").attr("val"));h="patiDistrict";if(g.provinceSignature==""||g.citySignature==""){return}}}}g=$.extend(g,c);var a={method:"POST",async:true,url:ContextClinc_Server+"mdDictItem/getAddrAssotList",dataType:"json",data:g};var f=Utils.myAjaxHandler(a);f.done(function(k){var j=k.errorCode;if(j=="E0000000"){var i={idKey:"DICT_ITEM_CODE",txtKey:"DICT_ITEM_NAME"};$("#"+h).WJZSDropdown(k.data,i,function(l,m){if(m.isChange==true){if(0==b){d.getAddress(1);$("#patiCity").val("").attr("val","");$("#patiDistrict").val("").attr("val","");$("#patiDistrict").cleanDropdownItem()}else{if(1==b){d.getAddress(2);$("#patiDistrict").val("").attr("val","")}}}});if(1==b&&c){d.patientRegisterView.setSelectIdValue("patiCity",c.citySignature)}else{if(2==b&&c){d.patientRegisterView.setSelectIdValue("patiDistrict",c.countrySignature)}}}})},getTodayApptDept:function(f){var b=this;var d={};var a={method:"POST",async:false,url:ContextClinc_Server+"apptSchedule/getAllApptDept",contentType:"application/json",dataType:"json",data:JSON.stringify(d)};var c=Utils.myAjaxHandler(a);c.done(function(h){var g=h.errorCode;if(g=="E0000000"){if(f){f.call(b,h.data)}}})},getApptDeptByDepartmentId:function(b,g){var c=this;var f={departmentId:b};var a={method:"POST",async:false,url:ContextClinc_Server+"apptSchedule/selectApptDeptByDepartmentId",contentType:"application/json",dataType:"json",data:JSON.stringify(f)};var d=Utils.myAjaxHandler(a);d.done(function(i){var h=i.errorCode;if(h=="E0000000"){if(g){g.call(c,i.data)}}})},getTodayApptDoctor:function(i){var f=this;var h={};var c;if(regModel==GUAHAO_REG){c=$("#guahao-dept").attr("val")}else{if(regModel==CONSULT_REG){c=$("#appDept_advisory").attr("val")}else{c=$("#appDept").attr("val")}}if(!c){var d=[];var a={idKey:"DOCTOR_ID",txtKey:"EMPLOYEE_NAME",isNeedClear:true,isNeedThink:true};if(regModel==NOMAL_REG){a.isNeedClear=false;d.push({DOCTOR_ID:"",EMPLOYEE_NAME:"未指定医生"});$("#appDoctor").WJZSDropdown(d,a,function(j,k){})}return}h.deptId=c;h.regModel=regModel;var b={method:"POST",url:ContextClinc_Server+"apptSchedule/getTodayApptDoctor",contentType:"application/json",dataType:"json",data:JSON.stringify(h)};var g=Utils.myAjaxHandler(b);g.done(function(r){var q=r.errorCode;if(q=="E0000000"){var l={idKey:"DOCTOR_ID",txtKey:"EMPLOYEE_NAME",isNeedClear:true,isNeedThink:true};if(regModel==GUAHAO_REG){$("#guahao-doctor").WJZSDropdown(r.data,l,function(s,t){$("#guahao-doctor").removeClass("pawjzs-error");$("#guahao-doctor").parent().removeClass("pawjzs-error");$("#doctor-cure-amount").text("");$("#doctor-cure-amount").attr("treatment-price","");$("#doctor-cure-amount").attr("treatment-id","");$("#doctor-cure-amount").attr("treatment-name","");if(t!=null&&""==$.trim(t.DOCTOR_ID)){return}if(t!=null&&t.TREATMENT_ID!=null){var j=getRadioValue("registrationType");if(j=="1"){$("#doctor-cure-amount").text(fmoney(t.TREATMENT_PRICE||0,2));$("#doctor-cure-amount").attr("treatment-price",t.TREATMENT_PRICE||0)}else{$("#doctor-cure-amount").text(fmoney(t.RETREATMENT_PRICE||0,2));$("#doctor-cure-amount").attr("treatment-price",t.RETREATMENT_PRICE||0)}$("#doctor-cure-amount").attr("treatment-price-1",t.TREATMENT_PRICE||0);$("#doctor-cure-amount").attr("treatment-price-2",t.RETREATMENT_PRICE||0);$("#doctor-cure-amount").attr("treatment-id",t.TREATMENT_ID);$("#doctor-cure-amount").attr("treatment-name",t.TREATMENT_NAME);f.setDoctorTreatmentPrice()}else{if(ybDJObj&&ybDJObj.isYbReg()&&ybDJObj.miTypeCode==MI_TYPE_ENUM.YB_SHENZHEN_NEW){}else{$.paAlert("该医生未设置诊金")}}f.patientRegisterView.showApptPayStatus()});if(i){f.patientRegisterView.setSelectIdValue("guahao-doctor",i);if(r.data!=null&&r.data!=""){for(var o=0;o<r.data.length;o++){var n=r.data[o];if(i==n.DOCTOR_ID){var k=getRadioValue("registrationType");if(k=="1"){$("#doctor-cure-amount").text(fmoney(n.TREATMENT_PRICE||0,2));$("#doctor-cure-amount").attr("treatment-price",n.TREATMENT_PRICE||0)}else{$("#doctor-cure-amount").text(fmoney(n.RETREATMENT_PRICE||0,2));$("#doctor-cure-amount").attr("treatment-price",n.RETREATMENT_PRICE||0)}$("#doctor-cure-amount").attr("treatment-price-1",n.TREATMENT_PRICE||0);$("#doctor-cure-amount").attr("treatment-price-2",n.RETREATMENT_PRICE||0);$("#doctor-cure-amount").attr("treatment-id",n.TREATMENT_ID);$("#doctor-cure-amount").attr("treatment-name",n.TREATMENT_NAME);f.setDoctorTreatmentPrice();break}}}}else{$("#guahao-doctor").SelectWJZSDropdownFirstItem()}f.patientRegisterView.showApptPayStatus()}else{if(regModel==CONSULT_REG){l.isNeedClear=false;var m=[];var p={DOCTOR_ID:"",EMPLOYEE_NAME:"未指定医生"};m.push(p);$.merge(m,r.data);$("#appDoctor_advisory").WJZSDropdown(m,l,function(j,s){});if(i){f.patientRegisterView.setSelectIdValue("appDoctor_advisory",i)}else{$("#appDoctor_advisory").SelectWJZSDropdownFirstItem()}}else{l.isNeedClear=false;var m=[];var p={DOCTOR_ID:"",EMPLOYEE_NAME:"未指定医生"};m.push(p);$.merge(m,r.data);$("#appDoctor").WJZSDropdown(m,l,function(j,s){});if(i){f.patientRegisterView.setSelectIdValue("appDoctor",i)}else{}}}}})},setDoctorTreatmentPrice:function(){if(regModel==GUAHAO_REG){if(!this.checkDiscountPower()){return}var a=fmoney($("#doctor-cure-amount").attr("total-money")||0,2);$("#doctor-cure-amount").text(a);if(ybDJObj&&ybDJObj.isYbReg()&&ybDJObj.miTypeCode==MI_TYPE_ENUM.YB_SHENZHEN_NEW){$("#total_amount_text").text("应收费用总额(元)：");$("#chooseDiscount").hide();a=fmoney((ybDJObj.getYbRegData().total_price_fee)||0,2);$("#doctor-cure-amount").text(a)}else{$("#total_amount_text").text("应收诊金(元)：");$("#chooseDiscount").show()}}},checkDiscountPower:function(){var h=parseFloat(session_cache.getCache("discountPermit"));var d=0;var c=$("#chooseDiscount").find("span.checked").attr("val");var g=Utils.trimObj($("#discountInput").val());if(isNaN(g)){return}var b=parseFloat(g);if(!h&&b>0){if(h!=0){$.paWarn("您无折扣权限！",null);return false}}var a=this.getSrcTreatmentMoney();var d=this.getDiscountMoney(c,g);var f=d;if(h==-1){h=0}if(h==0){d=a}switch(c){case"1":if(parseFloat(g)<0){$.paWarn("折扣比例不能小于0");$("#discountInput").val("");return false}else{if(parseFloat(g)>100){$.paWarn("折扣比例不能大于100");$("#discountInput").val("");return false}else{if(h!=0&&b<h){$("#discountInput").val("");$.paWarn("您的最高优惠折扣权限为："+h,null);return false}}}break;case"2":if(b>d){$("#discountInput").val("");$.paWarn("您的最高优惠金额为："+d,null);return false}break}$("#doctor-cure-amount").attr("total-money",accSub(a,f));$("#doctor-cure-amount").attr("discount-type",c);$("#doctor-cure-amount").attr("discount-value",g);$("#doctor-cure-amount").attr("discount-money",f);$("#doctor-cure-amount").attr("treatment-price-src",a);return true},getDiscountMoney:function(c,f){var a=this.getSrcTreatmentMoney();var b=0;var d=c==1?100:0;f=f||d;switch(c){case"1":b=parseFloat(fixByRound(accSub(a,accDiv(accMul(a,f),100)),2));break;case"2":b=f;break}return b},getSrcTreatmentMoney:function(){var b=0;if(regModel==GUAHAO_REG){var a=getRadioValue("registrationType");if(a=="1"){b=$("#doctor-cure-amount").attr("treatment-price-1")||0}else{b=$("#doctor-cure-amount").attr("treatment-price-2")||0}}return b},getAndSetGuaHaoDoctor:function(i){var f=this;var d=$("#guahao-dept").attr("val");if(d==null||d==""){return}var a={idKey:"DOCTOR_ID",txtKey:"EMPLOYEE_NAME",isNeedClear:true};var h={deptId:d,regModel:regModel};var c="apptSchedule/getTodayApptDoctor";if(ybDJObj.miTypeCode==MI_TYPE_ENUM.YB_SHENZHEN_NEW){c="apptSchedule/getLicenseApptDoctor"}var b={method:"POST",url:ContextClinc_Server+c,contentType:"application/json",dataType:"json",data:JSON.stringify(h)};var g=Utils.myAjaxHandler(b);g.done(function(j){if(j.errorCode=="E0000000"){$("#guahao-doctor").WJZSDropdown(j.data,a,function(l,m){$("#doctor-cure-amount").text("");$("#doctor-cure-amount").attr("treatment-price","");$("#doctor-cure-amount").attr("treatment-id","");$("#doctor-cure-amount").attr("treatment-name","");if(m!=null&&""==$.trim(m.DOCTOR_ID)){return}if(m!=null&&m.TREATMENT_ID!=null){var k=getRadioValue("registrationType");if(k=="1"){$("#doctor-cure-amount").text(fmoney(m.TREATMENT_PRICE||0,2));$("#doctor-cure-amount").attr("treatment-price",m.TREATMENT_PRICE||0)}else{$("#doctor-cure-amount").text(fmoney(m.RETREATMENT_PRICE||0,2));$("#doctor-cure-amount").attr("treatment-price",m.RETREATMENT_PRICE||0)}$("#doctor-cure-amount").attr("treatment-price-1",m.TREATMENT_PRICE||0);$("#doctor-cure-amount").attr("treatment-price-2",m.RETREATMENT_PRICE||0);$("#doctor-cure-amount").attr("treatment-id",m.TREATMENT_ID);$("#doctor-cure-amount").attr("treatment-name",m.TREATMENT_NAME);if(ybDJObj.isYbReg()){if(ybDJObj.getYbRegData().ybRegistrationType!=null){if(ybDJObj.miTypeCode&&ybDJObj.miTypeCode==MI_TYPE_ENUM.YB_SHENZHEN_NEW){$("#doctor-cure-amount").text(fmoney(0||0,2));$("#doctor-cure-amount").attr("treatment-price",0||0);$("#doctor-cure-amount").attr("treatment-price-1",0||0);$("#doctor-cure-amount").attr("treatment-price-2",0||0);$("#doctor-cure-amount").attr("total-money",0)}}}f.setDoctorTreatmentPrice()}else{if(ybDJObj&&ybDJObj.isYbReg()&&ybDJObj.miTypeCode==MI_TYPE_ENUM.YB_SHENZHEN_NEW){}else{$.paAlert("该医生未设置诊金")}}f.patientRegisterView.showApptPayStatus()});if(i){i()}}})},getMemberDictItem:function(){var a={method:"GET",url:ContextClinc_Server+"clinMember/getClinicMemeberDict",dataType:"json",data:{}};var b=Utils.myAjaxHandler(a);b.done(function(d){if(d.errorCode=="E0000000"){var c=d.data;if(c){}}}).fail(function(c){}).always(function(){})},patientSubmit:function(d){var b=this;if(""==d){return}var a={url:ContextClinc_Server+"empi/patient_register",dataType:"json",data:JSON.stringify(d),contentType:"application/json",showMask:true};var c=Utils.myAjaxHandler(a);c.done(function(f){if("E0000000"==f.errorCode){if(f.data.samePatientList!=null&&f.data.samePatientList!=""){b.showSamePatPannel(f.data.samePatientList);return}if(regModel==GUAHAO_REG){if(f.data.chargeData!=null&&f.data.chargeData!=""){b.showChargePannel(f.data.chargeData)}else{$.paSuccess("保存成功");b.patientRegisterView.clearData();b.patientRegisterView.resetYbData();b.reloadPatientNo();$("#patient_basic_info .extra-info").hide();$("#patiName").attr("data-edit","add");handlePrint(f.data.triageId||"",isRegisterationPrint())}}else{$.paSuccess("保存成功");b.patientRegisterView.clearData();b.patientRegisterView.resetYbData();b.reloadPatientNo();$("#patient_basic_info .extra-info").hide();$("#patiName").attr("data-edit","add");if(regModel!=CONSULT_REG){handlePrint(f.data.triageId||"")}}}else{if("alreadyExist"==f.data||"病历号已存在"==f.data){$.paError("病历号已刷新，请重新提交");b.reloadPatientNo()}else{if("umExist"==f.data){$.paError("UM账号已存在")}else{$.paError(f.errorMessage)}}}}).fail(function(f){}).always(function(){link_server=false})},showChargePannel:function(a){if(a!=""){chargePayPanel.window.initChargePay(a);$("#pay_pop").show()}},showSamePatPannel:function(a){var b=this;if(a!=""){b.initSamePat(a);$("#patient_same_name_window").show()}},initSamePat:function(c){var d=this;if(c&&c.length>0){$("#same_name_div").empty();$("#patient_same_num").text(c.length);for(var a=0;a<c.length;a++){var b=d.addSinglePatHtml(a,c[a]);$("#same_name_div").append(b)}$("#patient_same_confirm").attr("clickflag",false);$("#patient_same_confirm").addClass("disabled");$("#same_name_div").append($('<div class="patient_same_line clear">没有重复，确定要新建患者并登记</div>'))}},addSinglePatHtml:function(b,c){var d=$("#patient_same_line").clone(false);d.removeAttr("id");d.attr("patient_same_id",c.EMPI_ID);d.attr("data-patient-no",c.PATIENT_NO);d.children(".patient_same_name").text(c.PATIENT_NAME||"");d.children(".patient_same_sex").text(sex_map[c.PATIENT_GENDER]);var a=c.BIRTH_DATE!=null?c.BIRTH_DATE:"";d.children(".patient_same_birthday").text(Utils.timeStampToDateStr(a,5));d.children(".patient_same_number").text(c.MOBILE_PHONE_NUMBER!=null?c.MOBILE_PHONE_NUMBER:"--");d.children(".patient_same_doctor").text(c.DOCTOR_NAME!=null?"最近就诊医生："+c.DOCTOR_NAME:"");d.show();return d},getPatInfo:function(g,b,h){var c=this;var f={select:1};ybDJObj.restYbReg();c.patientRegisterView.clearData();var a={method:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"patient/selectPatientDetailInfo/"+g,dataType:"json",data:JSON.stringify(f),showMask:true};var d=Utils.myAjaxHandler(a);d.done(function(m){var i=m.data.dataSource;var j=m.errorMessage;var l=m.errorCode;if(l!="E0000000"){return}var k=m.data;c.patientRegisterView.fillPatiInfo(k,b,h)}).fail(function(i){}).always(function(){})},getPatientInfoByVisit:function(){var b=this;var a={method:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"patient/selectPatientInfoByVisit",dataType:"json",data:JSON.stringify(visitInfo),showMask:true};var c=Utils.myAjaxHandler(a);c.done(function(h){var d=h.data.dataSource;var f=h.errorMessage;var g=h.errorCode;if(g=="E0000000"){if(h.data!=""){b.patientRegisterView.fillPatiInfo(h.data)}b.patientRegisterView.fillVisitPatientInfo();return}}).fail(function(d){}).always(function(){})},checkParam:function(d){var a=config_cache.getCache("medical_user_data");var b=a.clinicParams;for(var c in b){if(b[c].parameterCode==d){return b[c].parameterValue=="1"}}return false},getPatietnList:function(d,b){var a={url:ContextClinc_Server+"patient/selectPatientList",dataType:"json",data:JSON.stringify(d),contentType:"application/json"};var c=Utils.myAjaxHandler(a);c.done(function(h){var g=h.data;b.parent().find("table tr:gt(1)").remove();var f=b.parent().find("table").attr("data-flag");var i="";if("pati"==f){i="patiName"}else{if("rela"==f){i="realPatiName"}}if(null==g||g.length<=0){b.siblings(".small-table-box").hide()}else{setThinkBox(b,g);b.siblings(".small-table-box").show()}})},apptRecordInfo:function(d){var b=this;b.patientRegisterView.clearApptRecordInfo();var a={method:"GET",url:ContextClinc_Server+"empi/apptrecord",dataType:"json",data:{empiId:d}};var c=Utils.myAjaxHandler(a);c.done(function(i){var h=i.errorCode;if(h=="E0000000"){var g=i.data;if(g){$("#doctorType").attr("data-r-id",g.RECORD_ID).attr("data-s-id",g.SCHEDULE_ID);$("#doctorType").checkedItem([{id:g.APPT_TYPE}]);var f=g.DEPARTMENT_ID;if(null==f){b.patientRegisterView.setSelectIdValue("appDept",g.DEPT_ID);b.getTodayApptDoctor(g.DOCTOR_ID)}else{b.patientRegisterView.setSelectIdValue("appDept",g.DEPARTMENT_ID);b.getTodayApptDoctor()}$("#appStartTime").val(g.START_TIME);$("#appEndTime").val(g.END_TIME);if(g.RECORD_ID){$(".disableDrop").off("click")}}}}).fail(function(f){}).always(function(){})},emExamineInfo:function(g,b){var b=b?b:{};var c=this;var f={triageId:triageId,empiId:g};c.patientRegisterView.clearExamineInfo();var a={method:"POST",contentType:"application/json",url:ContextClinc_Server+"empi/examine",dataType:"json",data:JSON.stringify(f)};var d=Utils.myAjaxHandler(a);d.done(function(l){var j=l.errorCode;if(j=="E0000000"){var i=l.data;if(i&&!$.isEmptyObject(i)){var h=i.ALLERGIES_HISTORY;var k=i.PAST_HISTORY;$("#allergy").val(h);$("#pastMedical").val(k);if(h!=null&&h!=""&&h!="否认"){c.commonController.setPreExamStatus("allergy",false,h)}else{c.commonController.setPreExamStatus("allergy",true,"")}if(k!=null&&k!=""&&k!="否认"){c.commonController.setPreExamStatus("pastMedical",false,k)}else{c.commonController.setPreExamStatus("pastMedical",true,"")}$("#patientManager").ketchup();c.setLastestedDeptAndDoctor(i,b.flag||"");c.patientRegisterView.setTreatmentType(b.treatmentType||"2")}else{c.patientRegisterView.setTreatmentType(b.treatmentType||"1")}}}).fail(function(h){}).always(function(){})},setLastestedDeptAndDoctor:function(c,a){var d=this;if(ybDJObj.isYbReg()||"appt"==a){return}if(c!=null&&c!=""){var f=$.trim(c.EMPLOYEE_ID);var b=$.trim(c.DEPARTMENT_ID);switch(regModel){case NOMAL_REG:d.patientRegisterView.setSelectIdValue("appDept",b+"");d.getTodayApptDoctor(f);break;case GUAHAO_REG:d.patientRegisterView.setSelectIdValue("guahao-dept",b+"");d.getTodayApptDoctor(f);break;case CONSULT_REG:d.patientRegisterView.setSelectIdValue("consultant_doctor",f+"");break}}},isRegister:function(f){var b=$("#patiName").attr("data-edit");var a="";if("add"==b){var c={method:"GET",async:false,url:ContextClinc_Server+"empi/lastRegiFlag",dataType:"json",data:{empiId:f}};var d=Utils.myAjaxHandler(c);d.done(function(h){var g=h.errorCode;if(g=="E0000000"){a=h.data}}).fail(function(g){}).always(function(){})}return a},getSelectText:function(b){var a=$("#"+b).attr("val");if($.trim(a)==""){return""}else{return $("#"+b).val()}},queryTodaySchedule:function(){var c=this;var b=$("#set-date").val();var a={method:"GET",async:false,url:ContextClinc_Server+"clinicAppt/today_record?apptDate="+b+"&timestamp="+new Date().getTime(),contentType:"application/json",dataType:"json",};var d=Utils.myAjaxHandler(a);d.done(function(g){var f=g.errorCode;if(f=="E0000000"){c.patientRegisterView.showApptRecordList(g.data)}})},updateYbRegBizState:function(b,c,g){if(b!=""){var a={acographyId:b,miTypeCode:c,bizState:g};var d={url:ContextClinc_Server+"ybReimburse/updateYbRegBizState",dataType:"json",type:"POST",data:JSON.stringify(a),contentType:"application/json;charset=utf-8",showMask:true};var f=Utils.myAjaxHandler(d);f.done(function(h){if(h!=null&&h.errorCode==SUCCESSCODE){}else{$.paError("更改医保登记状态失败"+e.errorMessage)}})}},};var PatientRegisterView=function(d,f,b,g,c,a){this.patientRegisterAction=d;this.patientLabelAction=f;this.patientLabelAction=f;this.patientMemberAction=b;this.commonController=g;this.paUmInfoController=c;this.idCardInfoController=a};PatientRegisterView.prototype={fillPatiInfo:function(f,g,n){var j=this;var b=f.keyPatientInfo;var o=f.patientClinicRelInfo;if(b!=undefined){$("#patiName").val(b.patientName);$("#patiName").prop("disabled",true);$("#remove_patiName").css("display","block");$("#patiName").attr("data-id",b.empiId);if(o&&o!=null){$("#patiName").attr("patient-id",o.PATIENT_ID)}else{regAction.reloadPatientNo()}j.patientRegisterAction.emExamineInfo(b.empiId,g);$("#sex_warpper").find("span[val='"+b.patientGender+"']").addClass("checked").siblings("span").removeClass("checked");var c=$.trim(b.patientBirthDate);$("#birthday").val(c);var h=Utils.calcPatientAge(c);if(h!=""){var d=h.split(",");$("#age").val(d[0]!=0?d[0]:"");$("#month").val(d[1]!=0?d[1]:"");$("#age").removeClass("pawjzs-error");$("#month").removeClass("pawjzs-error")}$("#phone").val(b.mobilePhoneNumber);j.setSelectIdValue("cardType",b.idCardTypeCode+"");$("#cardNum").val(b.idCardNo);j.setSelectIdValue("patiSource",b.patientSource);j.setSelectIdValue("aboBlood",b.blood+"");j.setSelectIdValue("rhBlood",b.bloodRh+"");$("#email").val(b.email);j.setSelectIdValue("country",b.nationalityCode);j.setSelectIdValue("nation",b.nationalCode)}var a=f.extendPatientInfo;if(a!=undefined){j.setSelectIdValue("patiProvince",a.livingAddressProvince);j.patientRegisterAction.getAddress(1,{provinceSignature:a.livingAddressProvince,citySignature:a.livingAddressCity});j.patientRegisterAction.getAddress(2,{provinceSignature:a.livingAddressProvince,citySignature:a.livingAddressCity,countrySignature:a.livingAddressCounty});$("#addressDetail").val(a.livingAddressVillage);$("#contact_person_name").val(a.contactPersonName);$("#contact_person_phone").val(a.contactPersonPhoneNumber);$("#company").val(a.nameOfPatientEmployer);j.setSelectIdValue("contact_person_rel",a.contactPersonTypeCode);j.setSelectIdValue("marrayState",a.maritalStatus);j.setSelectIdValue("profession",a.classificationAndOccupations);if(isPafc){j.paUmInfoController.setPaInfoData(a)}}var m=f.patientLabels;if(m!=null&&m.length>0){j.patientLabelAction.renderPatientLabels(m)}var i=f.patientMemberInfo;if(i!=null&&i.MEMBER_CARD_STATUS!=3){j.patientMemberAction.renderPatientMember(i);$("#close_member").hide()}var k=f.patientClinicRelInfo;if(k!=null){j.setSelectIdValue("patiType",k.PAYMENT_TYPE_ID);$("#patientno").val(k.PATIENT_NO);$("#introducer").val(k.INTRODUCER_NAME);$("#introducer").attr("introducer_id",k.INTRODUCER_ID);$("#introducer").attr("introducer_role",k.INTRODUCER_ROLE);$("#introducer").attr("introducer_name",k.INTRODUCER_NAME);if(k.PATIENT_NO!=null&&k.PATIENT_NO!=""){$("#patientno").attr("update-flag",0);$("#patientno").attr("readonly","readonly");$("#patientno").css("background-color","#f0f0f0")}else{var l=Utils.trimObj($("#patientno").attr("data-rule-id"));j.commonController.generatePatientNo(l);$("#patientno").attr("update-flag",1);$("#patientno").removeAttr("readonly")}$("#remark").val(k.REMARK)}if(n){n()}},fillVisitPatientInfo:function(){var d=this;if(visitInfo!=null){$("#patiName").val(visitInfo.visitName);if(!isBlankStr(visitInfo.visitName)){d.commonController.enableOrDisableSelect("patiName",1)}$("#sex_warpper").find("span[val='"+visitInfo.visitSex+"']").addClass("checked").siblings("span").removeClass("checked");if(!isBlankStr(visitInfo.visitSex)){d.commonController.enableOrDisableSelect("sex_warpper",1)}var b=visitInfo.visitBrithday;$("#birthday").val(b);var a=Utils.calcPatientAge(b);if(a==""){var c=a.split(",");$("#age").val(c[0]);$("#month").val(c[1]);$("#age").removeClass("pawjzs-error");$("#month").removeClass("pawjzs-error")}if(!isBlankStr(visitInfo.visitBrithday)){d.commonController.enableOrDisableSelect("birthday",1)}$("#phone").val(visitInfo.visitMobile);if(!isBlankStr(visitInfo.visitMobile)){d.commonController.enableOrDisableSelect("phone",1)}d.setSelectIdValue("cardType",visitInfo.visitIdCardTypeCode+"");if(!isBlankStr(visitInfo.visitIdCardTypeCode)){d.commonController.enableOrDisableSelect("cardType",1)}$("#cardNum").val(visitInfo.visitIdCardCode);if(!isBlankStr(visitInfo.visitIdCardCode)){d.commonController.enableOrDisableSelect("cardNum",1)}}},clearData:function(){var a=this;delList=[];$("#patiName").prop("disabled",false);$("#remove_patiName").css("display","none");$("#introducer").prop("disabled",false);$("#remove_introducer").css("display","none");$("#introducer").val("");$(".pawjzs-error").val("");$(".pawjzs-error").removeClass("pawjzs-error");$("#family_member").find(".newAddRelation").remove();$("input").each(function(){var b=$(this).attr("id");var c=/.*makeup_date$/;if(!c.test(b)){$(this).val("");$(this).removeAttr("val");$(this).removeAttr("data-id")}});$("textarea").each(function(){$(this).val("");$(this).removeAttr("val");$(this).removeAttr("data-id")});a.patientLabelAction.currentSelectedLabel=[];$("#labelList").html('<li class="fl add-label"><a id="add_label" href="javascript:;"></a></li>');a.clearApptData();$("#member-content").text("");$("#member-info").hide();$("#add-member").show();$("#patiName").attr("data-edit","");$("#patiName").removeAttr("readOnly");$("#patientno").removeAttr("update-flag");$("#doctor-cure-amount").text("");$("#doctor-cure-amount").attr("treatment-price","");$("#doctor-cure-amount").attr("treatment-price-1","");$("#doctor-cure-amount").attr("treatment-price-2","");$("#doctor-cure-amount").attr("treatment-id","");$("#doctor-cure-amount").attr("treatment-name","");fromHealthPro=false;visitInfo={};a.commonController.enableOrDisableSelect("patientManager",0);a.clear_dept_doctor();if(isPafc){a.paUmInfoController.resetRelativeInfoPannel()}if(ybDJObj.isYbReg()){ybDJObj.clearYbData()}else{$("#yb-data-info").hide()}a.resetPreExam()},resetYbData:function(){if(ybDJObj.isYbReg()){ybDJObj.restYbReg()}$("#yb-data-info").hide()},resetPreExam:function(){var a=$("#allergy-check").find("span[val='1']");a.addClass("checked").siblings().removeClass("checked");$(".allergy-input").find("input").attr("disabled","disabled").val("否认");var a=$("#pastMedical-check").find("span[val='1']");a.addClass("checked").siblings().removeClass("checked");$(".pastMedical-input").find("input").attr("disabled","disabled").val("否认")},clear_dept_doctor:function(){var a=this;switch(regModel){case NOMAL_REG:case GUAHAO_REG:if(regModel==GUAHAO_REG){$("#guahao-dept").SelectWJZSDropdownFirstItem();$("#guahao-doctor").cleanDropdownItem();$("#guahao-doctor").attr("val","").val("")}else{$("#appDept").SelectWJZSDropdownFirstItem();$("#appDoctor").cleanDropdownItem();$("#appDoctor").attr("val","").val("")}break;case CONSULT_REG:$("#consultant_doctor").SelectWJZSDropdownFirstItem();break}},clearApptData:function(){$("#patiName").data("apptInfo","")},fillApptData:function(a){$("#patiName").data("apptInfo",a)},showApptPayStatus:function(){if(regModel==GUAHAO_REG){var g=$("#patiName").data("apptInfo");var f=trimObjOrDefault(g.recordId,"");var a=trimObjOrDefault(g.doctorId,"");var d=trimObjOrDefault(g.departmentId,"");if(f!=""&&a!=""&&d!=""){var h=trimObjOrDefault(g.isNeedPay,0);var c=trimObjOrDefault(g.payStatus,0);var j=trimObjOrDefault(g.payPrice,"");var b=trimObjOrDefault($("#guahao-dept").attr("val"),"");var i=trimObjOrDefault($("#guahao-doctor").attr("val"),"");if(h==1&&c==1&&a==i&&d==b){$("#doctor-cure-amount").text(fmoney(j,2)+" [预约已收费]")}}}},initDropdown:function(f,c,b,d){if(null==c){return}var a={idKey:"dictItemCode",txtKey:"dictItemName",isNeedClear:false};$("#"+c).WJZSDropdown(f,a,function(g,h){});if(c=="cardType"){$("#cardType").SelectWJZSDropdownFirstItem()}},initAllDropdown:function(){var c=this;var a=[{id:"1",txt:"初诊"},{id:"2",txt:"复诊"}];$("#doctorType").setInputForm(a,{type:"radio",idKey:"id",txt:"txt"},function(){}).checkedItem([{id:"1"}]);var b=[{id:"01",txt:"金卡会员"},{id:"02",txt:"银卡会员"},{id:"03",txt:"普通会员"}];$("#memberType").WJZSDropdown(b,null,function(d,f){});c.commonController.initAllDropdown()},initThinkDropdown:function(g,b,a,d){if(null==b){return}var h=this;var f=$("#"+b).parent().find("ul");if(a){for(var c=0;c<g.length;c++){f.append($("#"+b+"li").clone(true).removeAttr("id").removeAttr("hidden").attr("value",g[c][a]).text(g[c][d]))}}else{for(var c=0;c<g.length;c++){f.append($("#"+b+"li").clone(true).removeAttr("id").removeAttr("hidden").attr("value",g[c]["EMPIID"]).text(g[c]["NAME"]+"-"+sex_map[g[c]["PATIENTSEX"]]+"-"+g[c]["MOBILEPHONENUMBER"]+"-"+g[c]["CLINICNAME"]+"-"+new Date(g[c]["PATIENTBIRTHDATE"]).Format("yyyy-MMM-dd")))}}},setSelectIdValue:function(f,d){var a=$("#"+f);var c=a.parent().find("li[data-value='"+d+"']");if(c.length>0){var b=c.text();a.val(b);a.attr("val",d)}},setThinkBox:function(d,c){if(c){for(var b=0;b<c.length;b++){var f=d.siblings(".small-table-box").find(".clone").clone(true);f.removeClass("clone").removeClass("dsn");f.find(".patiName").attr("data-id",c[b]["EMPIID"]).text(c[b]["NAME"]);f.find(".patiSex").text(sex_map[c[b]["PATIENTSEX"]]);var a=getPersonAge(c[b]["PATIENTBIRTHDATE"]);f.find(".patiAge").text(a+"岁");f.find(".patiPhone").text(c[b]["MOBILEPHONENUMBER"]);f.find(".clinicName").text(c[b]["CLINICNAME"]);d.siblings(".small-table-box").find("table").append(f)}}},delRelation:function(d){var c=$(d).parents("tr").find(".patiName").attr("data-id");var b=$(d).parents("tr").find(".patiName").attr("data-flag");var a=$(d).parents("tr").find(".relation").attr("data-id");$(d).parents("tr").remove();if("old"==b){delList.push(a)}},clearApptRecordInfo:function(){$("#appType").val("").attr("val","").attr("data-r-id","").attr("data-s-id","");$("#appDept").val("").attr("val","");$("#appDoctor").val("").attr("val","");$("#appStartTime").val("");$("#appEndTime").val("")},clearExamineInfo:function(){$("#allergy").val("");$("#pastMedical").val("")},showTodaySchedulePop:function(a){if(a){$("#schedulePop").show()}else{$("#schedulePop").hide()}},showApptRecordList:function(d){$("#res-tbody tr:not(#res-line-clone)").remove();if(d!=null&&d.length>0){$("#noData").hide();for(var f=0;f<d.length;f++){var h=$("#res-line-clone").clone(true);h.removeAttr("id");h.data("apptInfo",d[f]);h.find("span").text(d[f].visitName);h.attr("data-empi-id",d[f].empiId);h.attr("data-record-id",d[f].recordId);h.attr("data-appt-flag",d[f].apptFlag);h.attr("data-visit-id",d[f].visitId);h.attr("data-department-id",d[f].apptDepartmentId!=null?d[f].apptDepartmentId:"");h.attr("data-appt-type",d[f].apptType!=null?d[f].apptType:"");h.attr("data-doctor-id",d[f].apptDoctorId!=null?d[f].apptDoctorId:"");var a=Utils.trimObj(d[f].visitName);var b=(d[f].visitGender!=1)&&(d[f].visitGender!=2)?"保密":(d[f].visitGender!=2?"男":"女");var g=d[f].apptType==1?"初诊":"复诊";var c=Utils.trimObj(d[f].visitMobile);var l=(d[f].doctorName!=null)&&(d[f].doctorName!="")?d[f].doctorName:"-";var k=(d[f].apptItem!=null)&&(d[f].apptItem!="")?d[f].apptItem:"-";var j=(d[f].apptRemark!=null)&&(d[f].apptRemark!="")?d[f].apptRemark:"-";h.find(".VISIT_NAME").text(a);h.find(".VISIT_GENDER").text(b);h.find(".APPT_TYPE").text(g);h.find(".VISIT_MOBILE").text(c);h.find(".DOCTOR_NAME").text(l);h.find(".APPT_ITEM").text(k).attr("title",k);h.find(".APPT_REMARK").text(j).attr("title",j);if(Utils.notBlank(d[f].healthProductId)){h.find("#hp_icon").css("display","inline-block");h.find("#apptRegister").attr("data-health-product-id",d[f].healthProductId);h.find("#apptRegister").attr("data-health-product-item-id",d[f].healthProductItemId);h.find("#apptRegister").attr("data-isSupportEquivalence",d[f].isSupportEquivalence);h.find("#apptRegister").attr("data-deposit_flag",d[f].depositFlag);h.find("#apptRegister").text("就诊码")}h.show();$("#res-tbody").append(h);$("#appt_register").show()}}else{$("#appt_register").hide();$("#noData").show()}$("#schedulePop").show()},setTreatmentType:function(a){if(regModel==GUAHAO_REG){setRadioValue("registrationType",a)}else{if(regModel==NOMAL_REG){$("#doctorType").checkedItem([{id:a}])}else{$("#consultant_doctor_type").checkedItem([{id:a}]);if(a=="2"){$("#dept_advisory").show();$("#doctor_advisory").show()}else{$("#dept_advisory").hide();$("#doctor_advisory").hide()}}}}};var PatientSearchAction=function(b,a){this.patientRegisterAction=b;this.patientRegisterView=a;this._init()};PatientSearchAction.prototype={_init:function(){var a=this;$("#seach_pat").on("click",function(){a.searchPatient()});$("#search-input").on("keydown",function(c){var b=c.which;if(b==13){c.preventDefault();a.searchPatient()}});$("#pat-list-table").on("click","tr:gt(0)",function(){$(".popup").hide();var b=$(this).attr("data-empi-id");a.patientRegisterView.clearApptData();a.patientRegisterAction.getPatInfo(b,"");$(".input-text").removeClass("pawjzs-error");$(".input-textarea-text").removeClass("pawjzs-error")})},searchPatient:function(d,g){var c=this.$this!=null?this.$this:this;var a="";if(cacheUtils.isChainClinic()){a=ContextClinc_Server+"patient/search_sharePat_list"}else{a=ContextClinc_Server+"empi/search_pat_list"}var f={keyword:$.trim($("#search-input").val()),currentPage:(d==undefined||d==null)?1:d.currentPage,pageSize:10};var b=$.extend({},d,f);b.ajaxopts={showMask:true,url:a,type:"POST"};b.callback=function(k){$("#warehousing_table tr:gt(0)").remove();if(k.errorCode=="E0000000"){var h=k.data.dataSource;var j="";for(var i=0;i<h.length;i++){j+=c.addSingleHtml(i,h[i])}$("#pat-list-table tr:gt(0)").remove();$("#pat-list-table tr:eq(0)").after(j)}else{$.paError("请求失败:"+k.errorMessage)}};$("#my-page").generatePagination(b)},addSingleHtml:function(f,h){var g="<tr data-empi-id="+h.EMPI_ID+">";g+="<td>"+parseInt(f+1)+"</td>";g+="<td>"+h.PATIENT_NAME+"</td>";var i=h.MOBILE_PHONE_NUMBER!=null?h.MOBILE_PHONE_NUMBER:"";g+="<td>"+i+"</td>";var c=h.PATIENT_NO!=null?h.PATIENT_NO:"";g+="<td>"+c+"</td>";var b=h.CLINIC_DATE!=null?h.CLINIC_DATE:"";g+="<td>"+Utils.timeStampToDateStr(b,8)+"</td>";var d=h.DOCTOR_NAME!=null?h.DOCTOR_NAME:"";g+="<td>"+d+"</td>";if(cacheUtils.isChainClinic()){var a=h.CLINIC_NAME!=null?h.CLINIC_NAME:"";g+="<td>"+a+"</td>"}return g}};var PatientLabelAction=function(a){this.patientRegisterAction=a;this.currentSelectedLabel=[];this.allLabel=[]};PatientLabelAction.prototype={_init:function(){var a=this;$("#labelList").on("click","#add_label",function(){$(".popup").hide();$("#labelPop").show();a.searchAllClinicLabel()});$("#ul-label").on("click","li",function(){var c=$(this);var b=c.attr("data-opt");if(b!=null&&b=="add"){$("#add-label-div").show()}else{var d=c.attr("data-id");if(c.hasClass("fartorsSelect")){c.removeClass("fartorsSelect");c.addClass("allSelect")}else{c.addClass("fartorsSelect");c.removeClass("allSelect")}}});$("#add-label-btn").on("click",function(){a.addClinicLabel()});$(".label-ul").on("click",".delete-tag",function(){var b=$(this).parent("li").attr("data-id");if($.inArray(b,a.currentSelectedLabel)!=-1){a.currentSelectedLabel.splice($.inArray(b,a.currentSelectedLabel),1)}$(this).parent("li").remove()});$("#close-add-label-btn").on("click",function(){$("#label_add_input").val("");$("#add-label-div").hide()});$("#label-confirm").on("click",function(){$("#labelPop").hide();a.confirmLabel()});$("#label-cancle").on("click",function(){$("#labelPop").hide()});$(".label-ul").on("mouseover","li.p-tag",function(){$(this).addClass("choose");$(this).children(".delete-tag").show()}).on("mouseout","li.p-tag",function(){$(this).removeClass("choose");$(this).children(".delete-tag").hide()})},searchAllClinicLabel:function(){var b=this.$this!=null?this.$this:this;var a={method:"GET",showMask:false,contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"empi/get_all_label",dataType:"json"};var c=Utils.myAjaxHandler(a);c.error(function(){$.paError("请求未响应，请检查网络连接！")});c.done(function(k){$("#ul-label").empty();var h=k.data;if(h!=null){$("#label-div").show();$("#label-nothing").hide();b.allLabel=h;var f="";for(var d=0;d<h.length;d++){var g=h[d];var j=g.LABEL_ID;if($.inArray(j,b.currentSelectedLabel)!=-1){f+='<li class="fl fartorsSelect" data-id='+j+">"+g.LABEL_NAME+"</li>"}else{f+='<li class="fl allSelect" data-id='+j+">"+g.LABEL_NAME+"</li>"}}$("#ul-label").html(f)}else{$("#label-div").hide();$("#label-nothing").show()}})},confirmLabel:function(){var f=this;var d=[];$("#ul-label li.fartorsSelect").each(function(){d.push($(this).attr("data-id"))});f.currentSelectedLabel=d;$("#labelList").empty();var c="";for(var b=0;b<f.currentSelectedLabel.length;b++){var a=f.getLabelNameByID(f.currentSelectedLabel[b]);if(a!=""){c+='<li class="fl fartorsSelect p-tag" data-id='+f.currentSelectedLabel[b]+'><span class="span-text">#&nbsp;'+a+'</span><i class="delete-tag dsn" style="display: none;"></i> </li>'}}c+='<li class="fl add-label"><a id="add_label" href="javascript:;"></a></li>';$("#labelList").html(c)},renderPatientLabels:function(b){var f=this;f.currentSelectedLabel=[];$("#labelList").empty();var d="";for(var c=0;c<b.length;c++){var a=b[c];f.currentSelectedLabel.push(a.labelId);d+='<li class="fl fartorsSelect p-tag" data-id='+a.labelId+'><span class="span-text">'+a.labelName+'</span><i class="delete-tag dsn" style="display: none;"></i> </li>'}d+='<li class="fl add-label"><a id="add_label" href="javascript:;"></a></li>';$("#labelList").html(d)},getLabelNameByID:function(d){var c=this;for(var a=0;a<c.allLabel.length;a++){var b=c.allLabel[a];if(b.LABEL_ID==d){return b.LABEL_NAME}}}};var PatientMemberAction=function(a){this.patientRegisterAction=a;this.memberCard="";this.memberName="";this.memberAmount=0};PatientMemberAction.prototype={_init:function(){var a=this;$("#memberPop").ketchup();$("#add-member").on("click",function(){if($("#patiName").attr("data-id")==undefined||$("#patiName").attr("data-id")==""){$.paError("新患者需先完成首次登记!");return}$("#patiName-member").val($("#patiName").val());$("#phone-member").val($("#phone").val());$("#age-member").val($("#age").val());$("#birthday-member").val($("#birthday").val());$("#patiName-member,#phone-member,#age-member,#birthday-member").attr("readonly","readonly");$("#sex_warpper-member").find("span[val='"+$("#sex_warpper").find(".checked").attr("val")+"']").addClass("checked").siblings("span").removeClass("checked");$("#sex_warpper-member .radio").unbind();a.initMemberTypeDropBox($("#cardType-member"));a.initpaymentTypeDropBox($("#paymentType"));a.initIsOrNotPwdOn();a.clickSaveNewCard();a.keyupStoreValue();a.clickReturnBtn();$("#ticket-box").empty().setInputForm([{status:"printTicketBox",txt:"打印小票"}],{type:"checkbox",idKey:"status",txtKey:"txt"},function(){});$(".popup").hide();a.clearMemData();$("#memberPop").show()});$("#search-member-input").on("keydown",function(c){var b=c.which;if(b==13){c.preventDefault();a.searchMemberInfo()}});$("#member-cancle-btn").on("click",function(){$(".popup").hide()});$("#member-confirm-btn").on("click",function(){$(".popup").hide();a.clearPopData();a.confirmMember()});$("#close_member").on("click",function(){a.clearPopData();a.resetData();$("#member-content").empty();$("#member-info").hide();$("#add-member").show()})},initMemberType:function(c,g){var d={};var a=this;var b={url:ContextClinc_Server+"memberCard/initMembeCardType",dataType:"json",data:null,async:true,showMask:false};var f=Utils.myAjaxHandler(b);f.done(function(h){if(h!=null&&h.errorCode==SUCCESSCODE){a.memTypeData=h.data;if(g){g(a.memTypeData)}}else{$.paError(h.errorMessage)}}).fail(function(h){$.paError("操作失败!")}).always(function(){});return d},generatePatientNo:function(b){var a={method:"POST",url:ContextClinc_Server+"memberCard/generateMemberNo",dataType:"json",data:{formatNum:"000"},showMask:true};var c=Utils.myAjaxHandler(a);c.done(function(d){if(d.errorCode=="E0000000"){var f=d.data.memberCardNum;$("#cardNum-member").val(f);$("#cardNum-member").removeClass("pawjzs-error")}}).fail(function(d){}).always(function(){})},generateMemberNo:function(){var a={method:"POST",url:ContextClinc_Server+"memberCard/generateMemberNo",dataType:"json",data:{formatNum:"000"},showMask:true};var b=Utils.myAjaxHandler(a);b.done(function(c){if(c.errorCode=="E0000000"){var d=c.data.memberCardNum;$("#cardNum-member").val(d);$("#cardNum-member").removeClass("pawjzs-error")}}).fail(function(c){}).always(function(){})},initMemberTypeDropBox:function(c){var b=this;var a=b.initMemberType(null,function(f){var d={idKey:"MEMBER_TYPE_ID",txtKey:"MEMBER_TYPE_NAME"};c.WJZSDropdown(f,d,function(i,j){var h=j.MEMBER_TYPE_ID;var g={method:"POST",url:ContextClinc_Server+"memberCard/getMemberTypeInfo",data:{memberTypeId:h},dataType:"json",showMask:true};var k=Utils.myAjaxHandler(g);k.done(function(l){if(l!=null&&l.errorCode==SUCCESSCODE){var m="";$.each(l.data.statsTypeList,function(n){m+=l.data.statsTypeList[n].SUB_TYPE_NAME+l.data.statsTypeList[n].STATS_SUB_TYPE_DISCOUNT+"%,"});$.each(l.data.projectTypeList,function(o,p){var n,q;if(p.PROJECT_TYPE==0){n=p.TREATMENT_NAME;q=p.TREATMENT_ID}else{if(p.PROJECT_TYPE==1){n=p.EXAM_NAME;q=p.EXAM_ID}else{n=p.DRUG_NAME;q=p.DRUG_ID}}m+=n+":"+p.PROJECT_DISCOUNT+"%,"});if(m.length>0){m=m.substring(0,m.length-1)}$("#mem_remark").val(m)}}).fail(function(l){}).always(function(){});b.generateMemberNo()})})},initpaymentTypeDropBox:function(c){var b=this;var a=b.initPaymentTypeData(null,function(g){var f={idKey:"headerCode",txtKey:"headerName"};var d=$.grep(g,function(j,h){return g[h]["headerCode"]!="'7'"});c.WJZSDropdown(d,f,function(h,i){if(i.headerType===undefined){$("#paymentType").css("color","#9f9f9f")}else{$("#paymentType").css("color","initial")}})})},initPaymentTypeData:function(c,g){var d={};var a=this;if(a.payTypeData!=null&&g){g(a.payTypeData);return a.payTypeData}var b={method:"POST",url:ContextClinc_Server+"charge/querySettleHeader",data:"header",dataType:"json",async:true,showMask:true};var f=Utils.myAjaxHandler(b);var a=this;f.done(function(h){if(h!=null&&h.errorCode==SUCCESSCODE){a.payTypeData=h.data;if(g){g(a.payTypeData)}}else{$.paError(h.errorMessage,null);return}}).fail(function(h){$.paError("请求异常",null)}).always(function(){});return d},initIsOrNotPwdOn:function(){var b=this;var a=b.initPwdIsOnOrNot();if(a==1){$(".pwd_input").removeClass("dsn");$("#memberPop").css("height","420px")}else{$("#password").removeClass("validate(required)");$("#memberPop").css("height","384px")}},initPwdIsOnOrNot:function(){var b="";var a={url:ContextClinc_Server+"memberCard/initPwdIsOnOrNot",dataType:"json",data:null,async:false,showMask:false};var c=Utils.myAjaxHandler(a);c.done(function(d){if(d!=null&&d.errorCode==SUCCESSCODE){b=d.data;return b}else{$.paError(d.errorMessage)}}).fail(function(d){$.paError("操作失败!")}).always(function(){});return b},keyupStoreValue:function(){$("#storeValue").on("keyup",function(){if($("#storeValue").val()!=""&&$("#storeValue").val()!=0){var a=$("#storeValue").val();if(!Number(a)||a<0||a>99999999){$("#storeValue").val("");$.paWarn("请输入正确的金额");$("#cashGiftValue").attr("readonly","readonly");return}$("#ticket-box").checkedItem([{status:"printTicketBox"}]);$("#cashGiftValue").removeAttr("readonly")}else{$("#cashGiftValue").attr("readonly","readonly");$("#ticket-box").cancelCheckedAll()}});$("#cashGiftValue").on("keyup",function(){if($("#cashGiftValue").val()!=""&&$("#cashGiftValue").val()!=0){var a=$("#cashGiftValue").val();if(!Number(a)||a<0||a>99999999){$("#cashGiftValue").val("");$.paWarn("请输入正确的金额");return}}})},clickSaveNewCard:function(){var a=this;$("#confirmBtn-member").off("click").on("click",function(){var d=$("#memberPop").ableToFinish();if(!d){return}if(a.checkCardNum($("#cardNum-member").val())==1){$.paWarn("卡号已存在");return}var c=$.trim($("#storeValue").val());if(c!==null&&$.trim(c)!==""){if(!Number(c)||c<0||c>100000000){$.paWarn("请输入正确的金额");return}if($("#paymentType").attr("val")==undefined||$("#paymentType").attr("val")==null||$("#paymentType").attr("val").trim()==""){$.paWarn("请选择支付方式");return}}if(a.initPwdIsOnOrNot()==1){var b=$.trim($("#password").val());if(isNaN(b)||b.length!==6){$.paError("密码格式错误!");return}}a.saveNewMemberCard(a.saveNewMemberCardRecharge)})},checkCardNum:function(a){var d=0;var c={memberCardNumber:a};var b={url:ContextClinc_Server+"memberCard/queryMembeCardList",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(c),async:false,showMask:false};var f=Utils.myAjaxHandler(b);f.done(function(g){if(g.data!=null){d=1}}).fail(function(g){$.paError("操作失败!")}).always(function(){});return d},saveNewMemberCard:function(g){var d=this.$this!=null?this.$this:this;var a=$.trim($("#password").val());var c={memberCard:{memberName:$.trim($("#patiName-member").val()),memberMobile:$.trim($("#phone-member").val()),memberCardNumber:$.trim($("#cardNum-member").val()),memberCardType:$("#cardType-member").attr("val"),memberCardStatus:1,memberPassword:a,pyCode:$("#pyjm").val(),wbCode:$("#wbjm").val()},empiId:empiId=$("#patiName").attr("data-id")};var b={method:"post",url:ContextClinc_Server+"memberCard/newMemberCard",contentType:"application/json",data:JSON.stringify(c),dataType:"json",async:false,showMask:true};var f=Utils.myAjaxHandler(b);f.done(function(h){var i=h.data;if(h.errorCode=="E0000000"){if(i.memberCardId!=null){g(i.memberCardId,d.printChargeTicket);$.paSuccess(i.retMsg);$("#member-content").text(c.memberCard.memberName+"/"+c.memberCard.memberCardNumber);$("#member-info").css("background-color","#f0f0f0");$("#close_member").css("display","none");$("#member-info").show();$("#add-member").hide();$("#memberPop").hide()}else{$.paError(i.retMsg)}}else{$.paError(h.errorMessage)}}).fail(function(h){}).always(function(){})},clickReturnBtn:function(){$("#cancelBtn-member").off("click").on("click",function(){$(".pawjzs-error").removeClass("pawjzs-error");$("#memberPop").hide()})},clearMemData:function(){$("#cardType-member").SelectWJZSDropdownFirstItem();$("#paymentType").SelectWJZSDropdownFirstItem();$("#cardNum-member").val("");$("#password").val("");$("#storeValue").val("");$("#cashGiftValue").val("");$("#mem_remark").val("")},saveNewMemberCardRecharge:function(d,j){var h=this.$this!=null?this.$this:this;var k=$.trim($("#storeValue").val());if(k==null||$.trim(k)==""||$.trim(k)==0||isNaN(k)){return}var g=$.trim($("#cashGiftValue").val());if(g!=null&&$.trim(g)!=""&&isNaN(g)){$.paWarn("请填写正确的赠送金额");return}var a=$.trim($("#patiName-member").val());var b=$.trim($("#phone-member").val());var c=$.trim($("#cardNum-member").val());var i=$.trim($("#paymentType").attr("val")).replace(new RegExp(/(')/g),"");var f={memberCard:{memberCardId:d,memberName:a,memberCardNumber:c,capital:k,cashGift:g,balance:k},mobileNumber:b,remark:"",patClinicRel:$("#patiName").attr("patient-id"),operationType:0,payType:i,tradingAmount:k,giftTradingAmount:g,clientName:a};var m={url:ContextClinc_Server+"memberCard/membeCardRecharge",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(f),async:false,showMask:false};var l=Utils.myAjaxHandler(m);l.done(function(n){if(n!=null&&n.errorCode==SUCCESSCODE){j(f,n.data)}else{$.paError(n.errorMessage)}}).fail(function(n){$.paError("充值失败!")}).always(function(){})},printChargeTicket:function(a,b){if($("#printTicketBox").is(":checked")){wjPrintUtils.getPrintSetting(wjPrintUtils.printFunction.chargeTicket,function(q,d){if(q==1){var t=b.clinicName;var j=a.memberCard.memberName;var o="手机："+a.mobileNumber;var p=a.memberCard.memberCardNumber;var u="充值";var m=parseFloat(a.tradingAmount).toFixed(2)+"元";var l="0.00元";if(a.giftTradingAmount!=null&&a.giftTradingAmount!=""){l=parseFloat(isNaN(a.giftTradingAmount)?0:a.giftTradingAmount).toFixed(2)+"元"}var c="本金余额："+b.remainingSum+"元";var f="赠金余额："+b.giveBalance+"元";var h=b.operator;var g=b.rechargeTime;var s="备注：无";LODOP=getLodop();if(!LODOP){return}LODOP.PRINT_INITA(0,0,"56.99mm",600,"");LODOP.SET_PRINT_PAGESIZE(3,570,0,"pos");LODOP.SET_PRINT_MODE("TRYLINKPRINTER_NOALERT",true);LODOP.ADD_PRINT_TEXT(29,-2,213,25,"会员充值小票");LODOP.SET_PRINT_STYLEA(0,"Alignment",2);LODOP.ADD_PRINT_TEXT(6,-3,214,25,t);LODOP.SET_PRINT_STYLEA(0,"Alignment",2);LODOP.ADD_PRINT_LINE(51,0,51,"56.91mm",0,1);LODOP.ADD_PRINT_TEXT(72,5,95,30,"姓名：");LODOP.ADD_PRINT_TEXT(72,37,59,30,j);LODOP.ADD_PRINT_TEXT(103,5,142,20,o);LODOP.ADD_PRINT_TEXT(72,95,127,30,"卡号：");LODOP.ADD_PRINT_TEXT(72,127,87,30,p);LODOP.ADD_PRINT_LINE(124,0,124,"56.91mm",1,1);LODOP.ADD_PRINT_TEXT(138,5,81,20,"类型");LODOP.ADD_PRINT_TEXT(164,5,81,20,"充值金额：");LODOP.ADD_PRINT_TEXT(138,89,119,20,"金额");LODOP.ADD_PRINT_TEXT(164,89,118,20,m);LODOP.ADD_PRINT_TEXT(215,5,191,76,s);LODOP.ADD_PRINT_TEXT(306,5,211,20,c);LODOP.ADD_PRINT_LINE(301,0,301,"56.91mm",1,1);LODOP.ADD_PRINT_TEXT(358,5,85,20,"收费员：");LODOP.SET_PRINT_STYLEA(0,"LetterSpacing",4);LODOP.ADD_PRINT_TEXT(379,5,72,20,"充值时间：");LODOP.ADD_PRINT_TEXT(358,67,146,20,h);LODOP.ADD_PRINT_TEXT(379,68,146,20,g);LODOP.ADD_PRINT_TEXT(187,5,81,20,"赠送金额：");LODOP.ADD_PRINT_TEXT(187,89,118,20,l);LODOP.ADD_PRINT_TEXT(330,5,211,20,f);operateType()}else{if(q==2){var k={};k.data={};k.data.settleInfo={};k.data.settleInfo.clinicName=b.clinicName;k.data.settleInfo.memberName=a.memberCard.memberName;k.data.settleInfo.memberCardNumber=a.memberCard.memberCardNumber;k.data.settleInfo.mobileNumber=a.mobileNumber;k.data.settleInfo.remainingSum=b.remainingSum+"元";k.data.settleInfo.giveBalance=b.giveBalance+"元";k.data.settleInfo.operator=b.operator;k.data.settleInfo.rechargeTime=b.rechargeTime;k.data.payInfo=new Array();var r={};r.type="充值金额：";r.money=parseFloat(a.tradingAmount).toFixed(2)+"元";k.data.payInfo.push(r);var n={};var l="0.00元";if(a.giftTradingAmount!=null&&a.giftTradingAmount!=""){l=parseFloat(isNaN(a.giftTradingAmount)?0:a.giftTradingAmount).toFixed(2)+"元"}n.type="赠送金额：";n.money=l;k.data.payInfo.push(n);var i={};i.type="备注：";i.money="无";k.data.payInfo.push(i);wjPrintUtils.print(d,k,function(v){if(v.code!=SUCCESSCODE){$.paWarn(v.message)}})}else{$.paWarn("请先配置打印参数！")}}})}},searchMemberInfo:function(){var c=this.$this!=null?this.$this:this;c.resetData();var b={memberCardNumber:$.trim($("#search-member-input").val()),memberMobile:$.trim($("#search-member-input").val())};var a={method:"POST",showMask:false,contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"memberCard/queryMembeCardList",data:JSON.stringify(b),dataType:"json"};var d=Utils.myAjaxHandler(a);d.error(function(){$.paError("请求未响应，请检查网络连接！")});d.done(function(g){var f=g.data;if(f!=null&&f.length>0){$("#member-no").text(f[0]["memberCardNumber"]);$("#member-name").text(f[0]["memberName"]);$("#member-actual-amount").text(f[0]["capital"]);$("#member-give-amount").text(f[0]["cashGift"]);$("#member-mobile").text(f[0]["memberMobile"]);$("#member-no-type").text(f[0]["memberTypeName"]);$("#band_count").text("(一张会员卡最多可绑定"+f[0]["typeNum"]+"人)");c.memberCard=f[0]["memberCardNumber"];c.memberName=f[0]["memberName"];c.memberAmount=f[0]["capital"];c.renderMemberPatientList(f[0]["memberPatientList"])}else{c.clearPopData();c.resetData()}})},renderMemberPatientList:function(d){if(d!=null&&d.length>0){var b="";for(var c=0;c<d.length;c++){var a=d[c];b+="<tr>";b+="<td>"+parseInt(c+1)+"</td>";b+="<td>"+a.patientName+"</td>";b+="<td>"+showDataCheckNull(a.mobilePhoneNumber)+"</td>";b+="<td>"+showDataCheckNull(a.patientNo)+"</td>";b+="</tr>"}$("#member-patients tr:gt(0)").remove();$("#member-patients tr:eq(0)").after(b)}},resetData:function(){this.memberCard="";this.memberName="";this.memberAmount=""},clearPopData:function(){$("#search-member-input").val("");$("#member-name").empty();$("#member-mobile").empty();$("#member-no-type").empty();$("#member-no").empty();$("#member-actual-amount").empty();$("#member-give-amount").empty();$("#member-patients tr:gt(0)").remove()},renderPatientMember:function(c){if(c!=null){var b=c.MEMBER_NAME;var a=c.MEMBER_CARD_NUMBER;$("#member-content").text(b+"/"+a);$("#member-info").css("background-color","#f0f0f0");$("#member-info").show();$("#add-member").hide()}},confirmMember:function(){var a=this;if(a.memberCard!=""){var a=this;$("#add-member").hide();$("#member-content").text(a.memberName+"/"+a.memberCard+"/"+a.memberAmount);$("#member-info").show()}else{$("#add-member").show();$("#member-info").hide()}}};var ApptRecordOperaterAction=function(a){this.patientRegisterAction=a;this._init()};ApptRecordOperaterAction.prototype={_init:function(){var a=this;$("#confirmButton").on("click",function(){var d=$.trim($("#treatmentNum").val());if(!Utils.notBlank(d)){$.paAlert("请输入就诊码");return}var b=$(this).attr("record-id");var c=$(this).attr("health-product-id");a.healthProductReg(b,c,d)});$("#cancelButton").on("click",function(){a.closePop()})},closePop:function(){$("#confirmButton").attr("record-id","");$("#confirmButton").attr("health-product-id","");$("#insertTreatmentNum").hide()},showHealthProductTreatement:function(c,b,a){var d=this;b.attr("record-id",c);HealthProductVisitUtil.initButtonAttr(c,b,a);HealthProductVisitUtil.initBindEvent(b);$("#insertTreatmentNum").find(".close").off("click").on("click",function(){d.closePop()})},healthProductReg:function(f,i,b){var j=this;var d="";var k="";$("#healthProductItems").find("li").not(".disabled").each(function(n,p){if($(p).find("span").hasClass("active")){var o=$(p).data("serviceItem");k=o.serviceName;d=o.serviceId}});var g="";if($("#baimudi").attr("depositFlag")=="1"){$("#baimudi").find("li").not(".disabled").find("span").each(function(n,o){if($(o).hasClass("active")){g=$(o).attr("depositType")}});if(g==""){$.paWarn("请选择百慕迪健康商品押金支付方式");return}var c=/(^[1-9]([0-9]+)?(\.[0-9]{1,2})?$)|(^(0){1}$)|(^[0-9]\.[0-9]([0-9])?$)/;var a=$("#depositAmt").val();if(a==""||!c.test(a)){$.paWarn("请输入正确的押金金额");return}}var h={recordId:f,healthProductId:i,visitCode:b,healthProductItemId:d,healthProductItemName:k,depositType:g,depositAmt:$("#depositAmt").val()};var m={url:ContextClinc_Server+"health_product/health_product_book_reg",dataType:"json",data:JSON.stringify(h),contentType:"application/json",showMask:true};var l=Utils.myAjaxHandler(m);l.done(function(n){if("E0000000"==n.errorCode){$.paSuccess("登记成功");j.patientRegisterAction.queryTodaySchedule();j.closePop()}else{$.paError(n.errorMessage)}}).fail(function(n){}).always(function(){})},getPatientInfoAndBookInfo:function(b,f,d){var g=this;g.clearPatientInfoAndBookInfo();var c={RECORD_ID:b,APPT_FLAG:f};var a={method:"POST",showMask:false,contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"clinicAppt/getPatientInfoByRecordId",data:JSON.stringify(c),dataType:"json"};var h=Utils.myAjaxHandler(a);h.error(function(){$.paError("请求未响应，请检查网络连接！")});h.done(function(j){var i=j.data;g.clearPatientInfoAndBookInfo();g.renderPatientInfoAndBookInfo(i,d);$("#bookingDetails-pop").show();$("#bookingDetails-pop").find(".close").off("click").on("click",function(){$("#bookingDetails-pop").hide()})})},clearPatientInfoAndBookInfo:function(){$("#appt-record-patient-name").text("");$("#appt-record-patient-sex").text("");$("#appt-record-patient-birth-date").text("");$("#appt-record-treatement-type").text("");$("#appt-record-patient-mobile").text("");$("#appt-record-date").text("");$("#appt-record-time").text("");$("#appt-record-dept").text("");$("#appt-record-doctor").text("");$("#appt-record-item").text("");$("#appt-record-remark").text("");$("#appt-record-code").text("");$("#appt-record-datatime").text("");$("#appt-record-staus").text("");$("#package-name").text("");$("#visit-insurance-company").text("");$("#visit-insurance-order-number").text("");$("#health-product-name").text("");$("#visit-people-type").text("");$("#visit-id-card-type-code").text("");$("#visit-id-card-no").text("")},renderPatientInfoAndBookInfo:function(g,c){var j=this;if(""!=g){$("#appt-record-patient-name").text(Utils.trimObj(g.PATIENT_NAME));$("#appt-record-patient-sex").text(Utils.trimObj(getGenderName(g.PATIENT_GENDER)));$("#appt-record-treatement-type").text(getTreateTypeName(g.APPT_TYPE));$("#appt-record-patient-mobile").text(g.MOBILE_PHONE_NUMBER);$("#appt-record-date").text(Utils.trimObj(g.APPT_DATE)||"");var n="";if(g.START_TIME&&g.END_TIME&&g.START_TIME!=null&&g.END_TIME!=null){n=g.START_TIME+"-"+g.END_TIME}else{if(g.START_TIME&&g.START_TIME!=null){n=g.START_TIME}else{if(g.END_TIME&&g.END_TIME!=null){n=g.END_TIME}}}$("#appt-record-time").text(n);var h=Utils.trimObj(g.PATIENT_BIRTH_DATE);var i=Utils.calcPatientAge(h);if(i!=""){var d=i.split(",");if(h!=""&&h!=null){h+="   "+d[0]+"岁"}else{h+="   -"}}$("#appt-record-patient-birth-date").text(h);if(g.DEPARTMENT_ID){$("#appt-record-dept").text(g.DEPARTMENT_NAME||"")}else{var b=c.data("apptInfo");var l="";switch(regModel){case NOMAL_REG:l=$("#appDept");break;case GUAHAO_REG:l=$("#guahao-dept");break;case CONSULT_REG:l=$("#appDept_advisory");break}var o=l.parent().find("li[data-value='"+b.departmentId+"']");if(o.length>0){var f=o.text();$("#appt-record-dept").text(f||"")}else{if(!f&&(g.DOCTOR_ID||g.DOCTOR_ID!=null)){j.getPatientInfoAndDepartmentInfo(g.DOCTOR_ID)}}}if(g.DOCTOR_ID){$("#appt-record-doctor").text(g.DOCTOR_NAME||"")}var m=(g.APPT_ITEM!=null)&&(g.APPT_ITEM!="")?g.APPT_ITEM:"-";var k=(g.APPT_REMARK!=null)&&(g.APPT_REMARK!="")?g.APPT_REMARK:"-";$("#appt-record-item").text(m).attr("title",m);$("#appt-record-remark").text(k).attr("title",k);if(g.HEALTH_PRODUCT_ID){if($("#bookingDetails-health").hasClass("dsn")){$("#bookingDetails-health").removeClass("dsn")}$("#appt-record-code").text(g.APPT_ORDER_CODE);$("#appt-record-datatime").text(g.ADD_DATE);$("#visit-insurance-company").text(g.VISIT_INSURANCE_COMPANY||"");$("#visit-insurance-order-number").text(g.VISIT_INSURANCE_ORDER_NUMBER||"");$("#health-product-name").text(Utils.trimObj(g.REAL_HEALTHPRODUCT_NAME));$("#package-name").text(Utils.trimObj(g.HEALTH_PRODUCT_NAME));var a=Utils.trimObj(VisitCardType[g.VISIT_ID_CARD_TYPE_CODE]);if(!a){a=VisitCardType["99"]}$("#visit-id-card-type-code").text(a||"");$("#visit-id-card-no").text(g.VISIT_ID_CARD_NO||"");if(g.VISIT_PEOPLE_TYPE=="0"){$("#visit-people-type").text("成人")}else{if(g.VISIT_PEOPLE_TYPE=="1"){$("#visit-people-type").text("儿童")}}}else{if(!$("#bookingDetails-health").hasClass("dsn")){$("#bookingDetails-health").addClass("dsn")}}}},getPatientInfoAndDepartmentInfo:function(f){var c=this;c.clearPatientInfoAndBookInfo();var b={doctorId:f};var a={method:"POST",showMask:false,contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"clinicAppt/getPatientDepartmentByDoctorId",data:JSON.stringify(b),dataType:"json"};var d=Utils.myAjaxHandler(a);d.error(function(){$.paError("请求未响应，请检查网络连接！")});d.done(function(h){var g=h.data;$("#appt-record-dept").text(g.departmentName||"")})}};function closeChargePay(){if(ybDJObj!=null&&ybDJObj.miTypeCode!=null&&ybDJObj.miTypeCode==MI_TYPE_ENUM.YB_SHENZHEN_NEW){$("#pay_pop").hide()}else{regView.clearData();regView.resetYbData();regAction.reloadPatientNo();$("#pay_pop").hide();$("#yb-data-info").hide();$.paAlert("前往登记列表可继续收费")}}function saveChargePaySuccess(f){if(f.isPaySucceed){$.paAlert("挂号并收费成功！")}$("#pay_pop").hide();var b="";var d="";var c="";if(ybDJObj.isYbReg()&&ybDJObj.miTypeCode==MI_TYPE_ENUM.YB_SHENZHEN_NEW){var a=f.acographyId;b=ybDJObj.miTypeCode;regAction.updateYbRegBizState(a,ybDJObj.miTypeCode,"1")}regView.clearData();regView.resetYbData();regAction.reloadPatientNo();$("#patient_basic_info .extra-info").hide();$("#patiName").attr("data-edit","add");if(f!=null&&f.acographyId!=""){printRegister(f.acographyId,isRegisterationPrint(),null,b,d)}$("#yb-data-info").hide()}function isRegisterationPrint(){var a=$("#print-guahao").children("ul").children("li");if(a.hasClass("checked")){return true}return false};