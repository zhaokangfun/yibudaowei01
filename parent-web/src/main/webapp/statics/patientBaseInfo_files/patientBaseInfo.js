var patientID=Utils.getQueryString("empiId");var treatmentState=Utils.getQueryString("treatmentState");var pawjNo;var patientKeyInfor;$(function(){patientBaseInfo_js.init()});var patientBaseInfo_js=Class.create({treatmentStateValEnum:{WAITING:0,VISITING:1,FINISH:2},init:function(){patientBaseInfo_js.selectPatientBaseInfo(patientID);patientBaseInfo_js.emExamineInfo(patientID);patientBaseInfo_js.queryChargeMoneyByEmpi(patientID);patientBaseInfo_js.bindModifyPatEvent(patientID,treatmentState);patientBaseInfo_js.bindEvent()},bindEvent:function(){var a=this;$(".wxBind").on("click",function(){a.showWxQrCode()});$(".wxUnbind").on("click",function(){var c=$("#btn_unBindState").data("openId");var b={msg:"是否解除绑定？",cancelTxt:"取消",saveTxt:"确定",onYes:function(){a.unBindWx(c)}};$.paConfirm(b)});$("#wxBindPop .closePop").on("click",function(){$("#wxBindPop").hide();a.refreshBandStatus()})},refreshBandStatus:function(){var b={};var a={url:patientArchUrl.patientArch_refreshWxBandStatus,dataType:"json",data:{empiId:patientKeyInfor.empiId,},showMask:true};var c=Utils.myAjaxHandler(a);c.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){if(e.data!=""){var d=e.data;if(d!=""){$("#btn_unBindState").data("openId",d);$("#btn_unBindState").show();$("#btn_bindState").hide()}}}else{}}).fail(function(d){$.paAlert("操作失败!")}).always(function(){$("#wxBindPop").hide()})},showWxQrCode:function(){var b={};var a={url:patientArchUrl.patientArch_selectWxQrCode,dataType:"json",data:{empiId:patientKeyInfor.empiId,},showMask:true};var c=Utils.myAjaxHandler(a);c.done(function(d){if(d!=null&&d.errorCode==SUCCESSCODE){$(".codeImg img").attr("src",d.data);$("#wxBindPop").show()}else{$.paAlert(d.errorMessage)}}).fail(function(d){$.paAlert("操作失败!")}).always(function(){})},unBindWx:function(c){var b={};var a={url:patientArchUrl.patientArch_unBindWxAccount,dataType:"json",data:{empiId:patientKeyInfor.empiId,openId:c},showMask:true};var d=Utils.myAjaxHandler(a);d.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){if(e.data){$("#btn_unBindState").data("openId","");$("#btn_unBindState").hide();$("#btn_bindState").show()}else{$.paAlert("解绑失败")}}else{$.paAlert(status.errorMessage)}}).fail(function(e){$.paAlert("操作失败")}).always(function(){})},selectPatientBaseInfo:function(a){if(a!=null&&a!="undefined"){var c={};var b={url:patientArchUrl.patientArch_selectPatientBaseInfoMore,dataType:"json",data:{empiId:a},showMask:true};var d=Utils.myAjaxHandler(b);d.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){patientBaseInfo_js.appendPatientBaseInfo(e.data)}else{$.paAlert(e.errorMessage)}}).fail(function(e){$.paAlert("操作失败!")}).always(function(){});return c}else{$.paAlert("患者ID不能为空!");return null}},emExamineInfo:function(e){var b=this;var d={empiId:e};var a={method:"POST",contentType:"application/json",url:ContextClinc_Server+"empi/examine",dataType:"json",data:JSON.stringify(d)};var c=Utils.myAjaxHandler(a);c.done(function(h){var g=h.errorCode;if(g=="E0000000"){var f=h.data;if(f){$("#allergiesHistory").text((f.ALLERGIES_HISTORY||"-"));$("#personalHistory").text((f.PAST_HISTORY||"-"))}else{$("#allergiesHistory").text("-");$("#personalHistory").text("-")}}}).fail(function(f){}).always(function(){})},queryChargeMoneyByEmpi:function(d){var b=this;var a={method:"POST",url:ContextClinc_Server+"chargeOuter/queryChargeMoneyByEmpi",dataType:"json",data:{empiId:d}};var c=Utils.myAjaxHandler(a);c.done(function(g){var f=g.errorCode;if(f=="E0000000"){var e=g.data;if(e&&e.totalMoney){$("#totalMoney").text(e.totalMoney.toFixed(2))}else{$("#totalMoney").text("0.00")}if(e&&e.oweMoney){$("#oweMoney").text(e.oweMoney.toFixed(2))}else{$("#oweMoney").text("0.00")}}}).fail(function(e){}).always(function(){})},bindModifyPatEvent:function(a,c){var b=this;if(b.treatmentStateValEnum.VISITING==c){$("#btn_modifyPat").removeClass("dsn");$("#btn_modifyPat").off("click").on("click",function(d){layer.open({type:2,move:false,title:"修改患者信息",shadeClose:true,anim:false,shade:0.8,area:["100%","100%"],content:"../patientManagement/patient_edit.html?notReturn=1&id="+a,cancel:function(){b.init()}})})}else{$("#btn_modifyPat").addClass("dsn")}},appendPatientBaseInfo:function(f){patientBaseInfo_js.clearPatientBaseInfo();pawjNo=f.patInfo.patientClinicRelInfo.PAWJ_NO;patientKeyInfor=f.patInfo.keyPatientInfo;var g=f.patInfo.extendPatientInfo||{};var e=f.patInfo.patientClinicRelInfo||{};var c=f.patInfo.patientLabels;var d=f.patInfo.patientMemberInfo;$("#patName").text(patientKeyInfor.patientName);$("#patStatus").text((patientKeyInfor.patientGender!=1)&&(patientKeyInfor.patientGender!=2)?"保密":(patientKeyInfor.patientGender!=2?"男":"女"));$("#patOtherInfo").text(Utils.getPersonAccurateAge(patientKeyInfor.patientBirthDate,"岁","个月"));$("#patientName").text(patientKeyInfor.patientName);$("#patientGender").text((patientKeyInfor.patientGender!=1)&&(patientKeyInfor.patientGender!=2)?"保密":(patientKeyInfor.patientGender!=2?"男":"女"));var b=Utils.getPersonAccurateAge(patientKeyInfor.patientBirthDate,"岁","个月")+"   （"+patientKeyInfor.patientBirthDate+"）";var a=Utils.calcPatientAge(patientKeyInfor.patientBirthDate).split(",")[0];if(a<12){b=Utils.getPersonAccurateAge2(patientKeyInfor.patientBirthDate)+"   （"+patientKeyInfor.patientBirthDate+"）"}$("#patientBirthDate").text((patientKeyInfor.patientBirthDate!=null)?b:"-");$("#mobilePhoneNumber").text((patientKeyInfor.mobilePhoneNumber||"-"));$("#patientNo").text((e.PATIENT_NO||"-"));$("#introducerName").text((e.INTRODUCER_NAME||"-"));if(d&&d.MEMBER_NAME){$("#patientMemberInfo").text(d.MEMBER_NAME+"/"+d.MEMBER_CARD_NUMBER)}else{$("#patientMemberInfo").text("-")}$("#contactPersonName").text((g.contactPersonName||"-"));$("#extendPatientInfo").text((g.contactPersonPhoneNumber||"-"));$("#patientSource").text((patientKeyInfor.patientSource||"-"));$("#email").text((patientKeyInfor.email||"-"));$("#livingAddress").text((g.livingAddressCountryside||"-"));$("#remark").text((e.REMARK||"-"));if(c&&c.length>0){$.each(c,function(h){$("#patientLabels").append('<span class="patient-label">#&nbsp;'+c[h].labelName+"</span>")})}else{$("#patientLabels").append("-")}$("#cardType").text((patientKeyInfor.idCardTypeCode||"-"));$("#cardNum").text((patientKeyInfor.idCardNo||"-"));$("#paymentTypeName").text((e.PAYMENT_TYPE_NAME||"-"));$("#nationality").text((patientKeyInfor.nationalityCode||"-"));$("#national").text((patientKeyInfor.nationalCode||"-"));$("#marriage").text((g.maritalStatus||"-"));$("#occupational").text((g.classificationAndOccupations||"-"));$("#entity").text((g.nameOfPatientEmployer||"-"));$("#entityAddress").text((g.patEmplAddrVillage||"-"));$("#ABOBloodGroup").text((patientKeyInfor.blood||"-"));$("#RHBloodGroup").text((patientKeyInfor.bloodRh||"-"));$("#aocNum").text(f.aocNum);$("#nearDate").text((f.nearDate||"-"));if(g.paUmAccount!=null&&g.paUmAccount!=""){$("#paUmAccount").text(g.paUmAccount||"-");$("#paCompanyName").text((g.paCompanyName||"-"));$("#paStaffId").text((g.paStaffId||"-"));$("#paDepartmentName").text((g.paDepartmentName||"-"));$("#paEntryDateStr").text((g.paEntryDateStr||"-"));$("#pa-info").show();$("#base-info").addClass("firstBox")}else{$("#pa-info").hide();$("#base-info").removeClass("firstBox")}if(f.openId&&""!=f.openId){$("#btn_unBindState").data("openId",f.openId);$("#btn_unBindState").show();$("#btn_bindState").hide()}else{$("#btn_unBindState").data("openId","");$("#btn_unBindState").hide();$("#btn_bindState").show()}},clearPatientBaseInfo:function(){$("#patientName").val("");$("#patientGender").val("");$("#patientBirthDate").val("");$("#mobilePhoneNumber").val("");$("#patientSource").val("");$("#email").val("");$("#livingAddress").val("");$("#cardType").val("");$("#cardNum").val("");$("#nationality").val("");$("#national").val("");$("#marriage").val("");$("#occupational").val("");$("#entity").val("");$("#entityAddress").val("");$("#ABOBloodGroup").val("");$("#RHBloodGroup").val("");$("#aocNum").val("");$("#nearDate").val("");$("#patientLabels").empty()},});