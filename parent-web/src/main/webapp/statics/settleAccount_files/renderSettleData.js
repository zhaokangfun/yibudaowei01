$(function(){session_cache.removeCache("settleParamterData");var a=new SettleAccount();a.initPage();a.bindEvent();$("#search_btn").click();renderPermissionControl()});function SettleAccount(){this.listData=[]}SettleAccount.prototype={constructor:SettleAccount,listData:[],initPage:function(){this.showListData();this.initDateWidget();this.initHeaderData();this.initParamterData();this.initCallBackData()},initCallBackData:function(){var d=Utils.getQueryString("conSettleNumber");var c=Utils.getQueryString("beginChargeDate");var b=Utils.getQueryString("endChargeDate");var a=Utils.getQueryString("employeeID");if(d!=null&&d!=undefined){$("#settle_number").val(d)}if(c!=null&&c!=undefined){$("#start_date_time").val(c)}if(b!=null&&b!=undefined){$("#end_date_time").val(b)}if(a!=null&&a!=undefined){$("#cashier").val(a)}},bindEvent:function(){$("#search_btn").click(function(){if(!$(this).hasClass("disabled")){$(this).addClass("disabled");$("#settle_table tr:gt(1)").remove();chargeSettle.showSettleInfo();renderPermissionControl();$(this).removeClass("disabled")}});$("#settle_btn").click(function(){var b=session_cache.getCache("settleParamterData");if(b!=null&&b["5002"]=="2"){chargeSettle.queryUnSettleData(0)}else{chargeSettle.queryUnSettleData(1)}});$("#settle_save").click(function(){if(!$(this).hasClass("disabled")){$(this).addClass("disabled");chargeSettle.saveSettleData();$(this).removeClass("disabled")}});$(".checkout_confirm").click(function(){if(!$(this).hasClass("disabled")){$(this).addClass("disabled");chargeSettle.saveSettleData();$(this).removeClass("disabled")}});$(".checkout_search").click(function(){chargeSettle.queryUnSettleData(0)});var a=this;$("#confirm_btn").on("click",function(){a.validatePassword()});$("#cancel_btn").on("click",function(){$(".validate_pop").hide()});$(".checkout_cancel").on("click",function(){$(".checkout_window").hide()});$(".validate_pop").on("keyup",function(b){if(b.which==13){a.validatePassword()}})},validatePassword:function(){var c={userName:$("#user_id").val(),userPassword:$("#password_id").val()};var a={url:chargeUrl.validatePassword,dataType:"json",type:"POST",data:JSON.stringify(c),contentType:"application/json;charset=utf-8",async:false};var b=Utils.myAjaxHandler(a);b.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){var d=e.data;if(d){$(".validate_pop").hide();chargeSettle.queryUnSettleData(0)}else{$("#tip_id").text("授权码错误！")}return true}else{$.paError("保存退费信息ajax返回错误:"+e.errorCode+":"+e.errorMessage);return false}}).fail(function(d){$.paError("请求未响应，请检查网络连接！");return false}).always(function(){})},initDateWidget:function(){var a=new Date();a.setTime(a.getTime()-7*24*60*60*1000);var c=Utils.timeStampToDateStr(a,7);var b=$("#start_date_time");b.datetimepicker({lang:"ch",format:"Y-m-d",timepicker:false,maxDate:c});b.val(c);c=Utils.timeStampToDateStr(new Date(),7);b=$("#end_date_time");b.datetimepicker({lang:"ch",format:"Y-m-d",timepicker:false,maxDate:c});b.val(c);b=$("#begin_date");b.datetimepicker({lang:"ch",format:"Y-m-d",timepicker:false});b.val(c);b=$("#end_date");b.datetimepicker({lang:"ch",format:"Y-m-d",timepicker:false,maxDate:c});b.val(c)},initParamterData:function(){var b=session_cache.getCache("settleParamterData");if(b!=null&&b!=undefined){return}var b=["5002"];var a={method:"POST",url:chargeUrl.selectCodeMapByCodes,data:JSON.stringify(b),dataType:"json",contentType:"application/json",async:false};var c=Utils.myAjaxHandler(a);c.done(function(d){if(d!=null&&d.errorCode==SUCCESSCODE){session_cache.setCache("settleParamterData",d.data)}else{$.paError(d.errorMessage,null);return}}).fail(function(d){$.paError("请求异常",null)}).always(function(){})},initListData:function(){var c=config_cache.getCache("medical_user_data")["id"];if(c==undefined||c==null){c=""}var b=session_cache.getCache("settleDictData");var a={cashier:c,};$.each(a,function(d){$("#"+d).SetWJZSDropdownSelectedData(a[d])})},initHeaderData:function(){var c=session_cache.getCache("settleHeaderData");if(c!=null&&c!=undefined){this.renderHeaderHtml("settle_table");return}var b={method:"POST",url:chargeUrl.querySettleHeader,data:"header",dataType:"json",async:true,showMask:true};var d=Utils.myAjaxHandler(b);var a=this;d.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){session_cache.setCache("settleHeaderData",e.data);a.renderHeaderHtml("settle_table")}else{$.paError(e.errorMessage,null);return}}).fail(function(e){$.paError("请求异常",null)}).always(function(){})},showListData:function(){var d=session_cache.getCache("settleDictData");if(d!=null){this.renderDropMenu(d);this.initListData();return}var a=[];a.push("cashier");var f={dicts:a};var c={method:"POST",url:chargeUrl.queryDictItemInfo,data:f,dataType:"json",async:true,showMask:true};var e=Utils.myAjaxHandler(c);var b=this;e.done(function(g){if(g!=null&&g.errorCode==SUCCESSCODE){b.renderDropMenu(g.data);b.initListData();session_cache.setCache("settleDictData",g.data)}else{$.paError(g.errorMessage,null);return}}).fail(function(g){$.paError("请求异常",null)}).always(function(){})},renderDropMenu:function(a){$.each(a,function(d){var e=$("#"+d+"");e.empty();var c=a[d];var b={isNeedAll:true,isNeedClear:false,idKey:"dictItemCode",txtKey:"dictItemName"};e.WJZSDropdown(c,b,function(f,g){})})},fillDropMenu:function(a,b){if(b==null||b==undefined){$("#"+a).val("");$("#"+a).attr("")}else{$("#"+a).parent().find("li").each(function(c){if($(this).attr("value")==b){$("#"+a).val($(this).text());$("#"+a).attr("value",b);if($(this).text()==chargeConstant.baseStatisticsType){$("#"+a).attr("base","0")}else{$("#"+a).attr("base","1")}return false}})}},renderHeaderHtml:function(e){var g=session_cache.getCache("settleHeaderData");var f=g.length||0;var d=f+4;var b=f;var h=f;var a=f;var c="<thead><tr><th width='3.5%' rowspan='2'>结账单号</th><th width='3%' rowspan='2'><!--收费员-->结账员</th><th width='4.5%' rowspan='2'>结账时间</th>";c+="<th colspan='"+d+"' class='head-text-center'>收费业务</th><th colspan='"+b+"' class='head-text-center'>补交业务</th>";c+="<th colspan='"+h+"' class='head-text-center'>会员卡充值</th>";c+="<th colspan='"+a+"' class='head-text-center'>会员卡退款</th>";c+="<th rowspan='2' class='account-table-head'>操作</th></tr>";c+="<tr>";$.each(g,function(i){c+="<th >"+g[i]["headerName"]+"</th>"});c+="<th >实收总金额</th><th >记账金额</th><th>优惠金额</th><th>欠费金额</th>";$.each(g,function(i){c+="<th >"+g[i]["headerName"]+"</th>"});$.each(g,function(i){c+="<th >"+g[i]["headerName"]+"</th>"});$.each(g,function(i){c+="<th >"+g[i]["headerName"]+"</th>"});$("#"+e).empty();$("#"+e).append(c)},handleAutoComplete:function(){$('input[autocomplete="off"]').each(function(){var a=this;$(a).val("");var b=$(a).attr("name");var c=$(a).attr("id");$(a).removeAttr("name");$(a).removeAttr("id");setTimeout(function(){$(a).attr("name",b);$(a).attr("id",c)},6)})},};