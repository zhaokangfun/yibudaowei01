var chargeSettle=Class.create({showSettleInfo:function(){$("#settle_table tr:gt(1)").remove();var a=$("#start_date_time").val();var b=$("#end_date_time").val();if(a!=null&&b!=null&&a>b){$.paWarn("开始日期不能大于结束日期！");$("#end_date_time").val($("#start_date_time").val());return}var d={beginChargeDate:($("#start_date_time").val()==""?"":$("#start_date_time").val()+"T00:00:00.000+0800"),endChargeDate:($("#end_date_time").val()==""?"":$("#end_date_time").val()+"T23:59:59.000+0800"),employeeID:Utils.trimObj($("#cashier").attr("val")),settleNumber:$("#settle_number").val(),pageSize:10,dataKey:"itemList"};var c=d;c.ajaxopts={showMask:true,url:chargeUrl.querySettleAccount,};c.callback=function(e){$("#settle_table tr:gt(1)").remove();if(e.errorCode==SUCCESSCODE){chargeSettle.filledDataTemplate(e.data)}else{$.paError("查询结账记录失败，"+e.errorMessage)}};$("#my-page").generatePagination(c)},filledDataTemplate:function(h){var g=h.itemList.dataSource;var a=h.totalMap;var c="";var f="";var b=session_cache.getCache("settleHeaderData");var d;var e;$.each(g,function(j){f+="<tr>";f+="<td>"+g[j]["SETTLE_NUMBER"]+"</td>";f+="<td>"+g[j]["USER_NAME"]+"</td>";f+="<td>"+parseDate2String(g[j]["SETTLE_DATE"],"yyyy/MM/dd HH:mm:ss")+"</td>";$.each(b,function(i){var o=b[i]["headerCode"];f+="<td>"+fmoney(g[j][o]||0)+"</td>"});f+="<td>"+fmoney(g[j]["PAY_MONEY"]||0)+"</td>";f+="<td>"+fmoney(g[j]["ACCOUNTING_MONEY"]||0)+"</td>";f+="<td>"+fmoney(g[j]["DISCOUNT_MONEY"]||0)+"</td>";f+="<td>"+fmoney(g[j]["OWE_MONEY"]||0)+"</td>";$.each(b,function(i){var o="su_"+b[i]["headerCode"];f+="<td>"+fmoney(g[j][o]||0)+"</td>"});$.each(b,function(i){var o="me001_"+b[i]["headerCode"];f+="<td>"+fmoney(g[j][o]||0)+"</td>"});$.each(b,function(i){var o="me002_"+b[i]["headerCode"];f+="<td>"+fmoney(Math.abs(g[j][o]||0))+"</td>"});f+="<td><a href='javascript:' onclick='chargeSettle.printSettle("+JSON.stringify(g[j]["SETTLE_NUMBER"])+")' WJPerm ='CASH03-PRINT'>打印</a>";var m=$.trim($("#start_date_time").val());var l=$.trim($("#end_date_time").val());var k=$.trim($("#cashier").val());var n=$.trim($("#settle_number").val());f+="<a href='settleAccountDetail.html?settleNumber="+g[j]["SETTLE_NUMBER"]+"&beginChargeDate="+m+"&endChargeDate="+l+"&employeeID="+k+"&conSettleNumber="+n+"' WJPerm ='CASH03-VIEW'>详情</a>";f+="</td></tr>"});if(g.length>0){f+="<tr>";f+="<td ></td>";f+="<td ></td>";f+="<td >合计</td>";$.each(b,function(i){var j=b[i]["headerCode"];f+="<td  style='color:#f35708'>"+fmoney(a[j]||0)+"</td>"});f+="<td style='color:#f35708'>"+fmoney(a.PAY_MONEY||0)+"</td>";f+="<td style='color:#f35708'>"+fmoney(a.ACCOUNTING_MONEY||0)+"</td>";f+="<td style='color:#f35708'>"+fmoney(a.DISCOUNT_MONEY||0)+"</td>";f+="<td style='color:#f35708'>"+fmoney(a.OWE_MONEY||0)+"</td>";$.each(b,function(i){var j="su_"+b[i]["headerCode"];f+="<td  style='color:#f35708'>"+fmoney(a[j]||0)+"</td>"});$.each(b,function(i){var j="me001_"+b[i]["headerCode"];f+="<td  style='color:#f35708'>"+fmoney(a[j]||0)+"</td>"});$.each(b,function(i){var j="me002_"+b[i]["headerCode"];f+="<td  style='color:#f35708'>"+fmoney(Math.abs(a[j]||0))+"</td>"});f+="<td ></td>";f+="</tr>"}if(!$("#settle_table tr:last")){$("#settle_table tr:last").after(f)}else{$("#settle_table").append(f)}$.xScrollTable()},queryUnSettleData:function(a){$(".checkout_table tr:gt(0)").remove();$(".checkout_info_content").find("li").remove();var e={settleId:"0",flag:a,beginChargeDate:($("#begin_date").val()==""?"":$("#begin_date").val()+"T00:00:00.000+0800"),endChargeDate:($("#end_date").val()==""?"":$("#end_date").val()+"T23:59:59.000+0800")};var c={type:"POST",contentType:"application/json; charset=utf-8",url:chargeUrl.getUnSettleAccountDetails,data:JSON.stringify(e),dataType:"json",async:true,showMask:true};var d=Utils.myAjaxHandler(c);d.error(function(){$.paError("请求未响应，请检查网络连接！")});var b=this;d.done(function(f){if(f.errorCode=="E0000000"){var g=f.data;if(g==null||g==undefined){$("#user_id").val("");$("#password_id").val("");$("#tip_id").text("");$(".validate_pop").show();Utils.renderPopup($(".validate_pop"));$("#password_id").focus();return}b.showUnSettleData(g);$(".checkout_window").show();Utils.renderPopup($(".checkout_window"))}else{$.paError(f.errorMessage)}})},fillpayDataTemplate:function(d,c){var b="";var a="";b+="<tr>";b+="<td >"+d.empiName+"</td>";b+="<td >"+Utils.trimObj(d.empiPhone)+"</td>";b+="<td >"+Utils.trimObj(d.feeName)+"</td>";b+="<td >"+parseDate2String(d.chargeDate,"yyyy/MM/dd HH:mm:ss")+"</td>";b+="<td >"+d.employeeName+"</td>";b+="<td >"+d.billTypeName+"</td>";b+="<td >"+fmoney(d.chargeMoney)+"</td>";b+="</td></tr>";var a=$(b);a.data("payDataInfo",d);return a},fillfeeDataTemplate:function(c){var b="";var a="";b+="<li>";b+="<span>"+c.feeName+" : </span>";b+="<span> "+fmoney(c.totalMoney)+" </span>";b+="</li>";var a=$(b);a.data("feeDataInfo",c);return a},showUnSettleData:function(e){var d=e.typeList;var c=e.itemList;if(c.length==0||d.length==0){$.paError("查询日期内无待结账数据！");$("#totalMoney").html(0);return}var b=JSON.parse(localStorage.getItem("medical_user_data"));$.each(c,function(f){$(".checkout_table").append(chargeSettle.fillpayDataTemplate(c[f],b.userName))});var a=0;$.each(d,function(f){if(d[f]["feeCode"]!="7"){$(".checkout_info_content").append(chargeSettle.fillfeeDataTemplate(d[f]));a+=parseFloat(d[f]["totalMoney"])}else{$(".checkout_info_content").append(chargeSettle.fillfeeDataTemplate(d[f]))}});$("#totalMoney").html(a.toFixed(2))},saveSettleData:function(){if($(".checkout_table tr:gt(0)").length==0){$.paError("无待结账数据！");return}Utils.addLoadingMaskTo(".popup-settle");var e={settleId:"0",beginChargeDate:($("#begin_date").val()==""?"":$("#begin_date").val()+"T00:00:00.000+0800"),endChargeDate:($("#end_date").val()==""?"":$("#end_date").val()+"T23:59:59.000+0800")};var c={type:"POST",contentType:"application/json; charset=utf-8",url:chargeUrl.saveSettleAccount,data:JSON.stringify(e),dataType:"json",async:true,showMask:true};var d=Utils.myAjaxHandler(c);d.error(function(){$.paError("请求未响应，请检查网络连接！")});var b=this;var a=d.done(function(f){if(f.errorCode=="E0000000"){$(".checkout_window").hide();$.paSuccess("结账成功！");$("#search_btn").click()}else{$.paError("结账保存ajax：返回错误！"+f.errorMessage)}}).fail(function(f){$.paError("结账失败")}).always(function(){Utils.removeLoadingMaskFrom(".popup-settle")})},printSettle:function(d){var f={settleNumber:d};var c={type:"POST",contentType:"application/json; charset=utf-8",url:chargeUrl.queryPrintSettleAccount,data:JSON.stringify(f),dataType:"json",async:true,showMask:true};var e=Utils.myAjaxHandler(c);e.error(function(){$.paError("请求未响应，请检查网络连接！")});var b=this;var a=e.done(function(g){if(g.errorCode=="E0000000"){wjPrintUtils.getPrintSetting(wjPrintUtils.printFunction.paymentReport,function(l,j){if(l==1){charge_model.chargeReport(g.data)}else{if(l==2){$.paSuccess("正在打印...");g.data.settleInfo.reportName=userInfo_aclc.clinicName+"收费员交款报表";g.data.settleInfo.startEndTime=Utils.timeStampToDateStr(g.data.settleInfo.settleStartDate,6)+" 至 "+Utils.timeStampToDateStr(g.data.settleInfo.settleEndDate,6);var h={};h.data=g.data;var i={};i.feeCode="-1";i.feeName="总计";var k=0;$.each(g.data.payInfo,function(n,m){k=Utils.accAdd(k,g.data.payInfo[n].totalMoney)});i.totalMoney=k;h.data.payInfo.push(i);wjPrintUtils.print(j,h,function(m){if(m.code!=SUCCESSCODE){$.paWarn(m.message)}})}else{$.paWarn("请先配置打印参数！")}}})}else{$.paError("获取打印数据ajax：返回错误！"+g.errorMessage)}})}});