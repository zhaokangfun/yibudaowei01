var DentistClinicIncome=function(){this.count=5;this.beginDate="";this.endDate="";this.dateGap=7};DentistClinicIncome.prototype={init:function(){this.beginDate=this.getDelayFormatDate(this.dateGap);this.endDate=this.getNowFormatDate();this.bindEvent();this.renderView()},getNowFormatDate:function(){var b=new Date();var a="-";var e=b.getFullYear();var f=b.getMonth()+1;var d=b.getDate();if(f>=1&&f<=9){f="0"+f}if(d>=0&&d<=9){d="0"+d}var c=e+a+f+a+d;return c},getDelayFormatDate:function(g){if(!g){g=0}var b="-";var a=new Date();var f=new Date(a.getTime()-(24*60*60*1000*g));var e=f.getFullYear();var h=f.getMonth()+1;var d=f.getDate();if(h>=1&&h<=9){h="0"+h}if(d>=0&&d<=9){d="0"+d}var c=e+b+h+b+d;return c},renderView:function(){var a=this;var b=a.beginDate;var c=a.endDate;var d={beginDate:b,endDate:c};this.selectDentistClinicIncomeAction(d,function(f){var e=this.getXYAxisByReqData(b,c,f);a.fillViewByAxisData(e)})},fillViewByAxisData:function(c){var b=echarts.init(document.getElementById("incomeChart"));var a={title:{text:"诊所运营趋势",show:false,textStyle:{fontSize:12,fontWeight:"normal"},top:20,left:"center"},grid:{x:50,y:52,x2:70,y2:20},legend:{data:["就诊人次","实收金额（元）"]},tooltip:{trigger:"axis"},xAxis:[{type:"category",data:c.xAxis,splitLine:{show:false}}],yAxis:[{type:"value",name:"就诊人次",min:0,max:c.yAxisEmpiMax,interval:c.yAxisEmpiInterval,axisLabel:{formatter:"{value} 人"}},{type:"value",name:"实收金额（元）",min:0,max:c.yAxisMenoyMax,interval:c.yAxisMenoyInterval,axisLabel:{formatter:"{value} 元"}}],series:[{name:"就诊人次",type:"line",smooth:true,data:c.yAxis.yAxisEmpiCount},{name:"实收金额（元）",type:"line",yAxisIndex:1,smooth:true,data:c.yAxis.yAxisTotalMenoy}]};b.setOption(a);window.onresize=b.resize},bindEvent:function(){var a=this;$(".time_choose .radio").off("click").on("click",function(){$(".time_choose .radio").attr("class","radio");$(this).addClass("checked");var b=$(this).attr("val");var c=new DentistClinicIncome();c.dateGap=parseInt(b);c.beginDate=c.getDelayFormatDate(parseInt(b));c.endDate=c.getNowFormatDate();c.renderView()})},getXYAxisByReqData:function(d,g,e){var b=this.getXAxisArray(d,g);var a=this.getYAxisArray(d,g,e);var l=Math.max.apply(Math,a.yAxisTotalMenoy);var j=Math.max.apply(Math,a.yAxisEmpiCount);var h=Math.ceil(l/this.count/1000)*1000;var k=this.count*h;var f=Math.ceil(j/this.count);var i=this.count*f;var c={xAxis:b,yAxis:a,yAxisMenoyInterval:h,yAxisMenoyMax:k,yAxisEmpiInterval:f,yAxisEmpiMax:i};return c},convertTimeFormat:function(a){return a.replace(".0","").replace("-","/").replace("-","/")},getXAxisArray:function(f,a){var d=new Date(this.convertTimeFormat(f));var g=new Date(this.convertTimeFormat(a));var e=[];var h=(g.getTime()-d.getTime())/(1000*3600*24)+1;var c;for(var b=0;b<h;b++){c=new Date(d.getTime()+b*(1000*3600*24)).Format("MM.dd");e.push(c)}return e},getYAxisArray:function(c,o,k){var f=new Date(this.convertTimeFormat(c));var l=new Date(this.convertTimeFormat(o));var n=(l.getTime()-f.getTime())/(1000*3600*24)+1;var g=0;var m=[];var e=[];var a={};for(var h=0;h<n;h++){var b=new Date(f.getTime()+h*(1000*3600*24));var d;if(g<k.length){d=new Date(this.convertTimeFormat(k[g].CHARGE_DATE))}if(k.length>0&&this.isSameDay(b,d)&&g<k.length){m.push(k[g].EMPI_COUNT);e.push(k[g].SUM_TOTAL_MONEY);g++}else{m.push(0);e.push(0)}}a.yAxisEmpiCount=m;a.yAxisTotalMenoy=e;return a},isSameDay:function(b,a){if((b.getFullYear()==a.getFullYear())&&(b.getMonth()==a.getMonth())&&(b.getDate()==a.getDate())){return true}else{return false}},selectDentistClinicIncomeAction:function(d,e){var a=this;var b={type:"GET",method:"GET",url:ContextClinc_Server+"dwsreport/selectDentistClinicIncome",dataType:"json",data:d,async:true};var c=Utils.myAjaxHandler(b);c.done(function(f){if(f.errorCode=="E0000000"){if(e){e.call(a,f.data)}}else{$.paError("提交失败")}}).fail(function(f){$.paError("操作失败!")}).always(function(){})}};var MsgList=function(){};MsgList.prototype={updateReadStat:function(c,d,f){var a=this;var b={type:"POST",url:ContextClinc_Server+"messagews/updateReadStat/"+c,dataType:"json"};var e=Utils.myAjaxHandler(b);e.done(function(g){if(g.errorCode==SUCCESSCODE){a.cleanMessageCounter(d);if(f){f.call(a,d)}}}).fail(function(g){$.paError("请求失败")}).always(function(){})},updateReadStatByType:function(c,d,f){var a=this;var b={type:"POST",url:ContextClinc_Server+"messagews/updateReadList/"+d,dataType:"json"};var e=Utils.myAjaxHandler(b);e.done(function(g){if(g.errorCode==SUCCESSCODE){a.cleanMessageCounter(d);if(f){f.call(a,d)}}}).fail(function(g){$.paError("请求失败")}).always(function(){})},cleanMessageCounter:function(a){$(".message_remind_box .message_remind_ul",window.parent.document).hide();if(a==12){a=2;$(".message_remind_box .message_remind_appt_index",window.parent.document).hide().find("span").text("0")}else{if(a==13){a=3;$(".message_remind_box .message_remind_medicine_index",window.parent.document).hide().find("span").text("0")}else{if(a==11){a=1;$(".message_remind_box .message_remind_wechat_index",window.parent.document).hide().find("span").text("0")}else{if(a==14){a=9;$(".message_remind_box .message_remind_feedback_index",window.parent.document).hide().find("span").text("0")}}}}parent.menuForIndex.cleanWebsocketMessageCounter(a)}};$(function(){homeDoctor.init()});var homeDoctor=Class.create({level:2,weekSatisfaction:[],init:function(){var a=this;a.getHomeData();$(".type .radio").on("click",function(){a.getWeekSatisfaction($(this).index());$(this).addClass("checked").siblings().removeClass("checked")});a.dentistIncomeReport();a.messageList()},dentistIncomeReport:function(){var a=new DentistClinicIncome();a.init()},messageList:function(){var a=this;var b={type:"POST",url:ContextClinc_Server+"messagews/queryNewestMessageList",dataType:"json"};var c=Utils.myAjaxHandler(b);c.done(function(d){if(d.errorCode==SUCCESSCODE){a.renderMessageList(d.data)}}).fail(function(d){$.paError("请求失败")}).always(function(){})},renderMessageList:function(b){var a=this;if(b&&b.length>0){var c="";$.each(b,function(d,e){c+='<li typeModel="'+e.messageType+'"messageId="'+e.messageId+'"><h4><span class="message_title">'+a.getMegTopic(e.messageContent)+"</span>";if(e.messageStatus===0){c+='<span class="latest_logo">'}else{c+="<span>"}c+="</span></h4><p>"+a.getMegContent(e.messageContent)+'<span class="more_arrows"></span></p></li>'});$(".message_list").html(c);$(".message_list>li>p").each(function(){if($(this).height()>44){$(this).addClass("needToHide")}});$(".message_list li").off("click").on("click",function(){var e=$(this).attr("messageId");var d=new MsgList();var f=$(this).attr("typeModel");$.each($(".message_list li"),function(g,h){var i=$(h).attr("typeModel");if(i==f){$(h).find(".latest_logo").removeClass("latest_logo")}});d.updateReadStatByType(e,f,function(i){if(i==12){window.parent.menuForIndex.crossMenu("APT","order_management","APT02");$(".message_remind_box .message_remind_appt_index").hide().find("span").text("0")}else{if(i==13){window.parent.menuForIndex.crossMenu("DRUG","medicine_management","DRUG02");$(".message_remind_box .message_remind_medicine_index").hide().find("span").text("0")}else{if(i==11){window.parent.menuForIndex.crossMenu("SCRM","scrm_management");var g=Context_SCRM_Web+"scrmAdmin/main/wClinicManage.html";var h=$("#r-main");var j=$("#paFrame");if(j&&j.length==0){$("<iframe height='100%' width='100%' src='"+g+"' id='paFrame' name='paFrame' scrolling='no' frameborder='no' marginheight='0' marginwidth='0' allowTransparency='true' onload='javascript:SetWinSize()'></iframe>").appendTo(h)}else{j.attr("src",g)}$(".message_remind_box .message_remind_wechat_index").hide().find("span").text("0");i=1}else{if(i==14){$("#my_questions",window.parent.document).click()}}}}})})}else{$(".my_message  .indexNoData").show()}},getMegTopic:function(reportStr){var jsonObj=eval("("+reportStr+")");if(jsonObj.topic){return jsonObj.topic}else{return""}},getMegContent:function(reportStr){var jsonObj=eval("("+reportStr+")");if(jsonObj.content){return jsonObj.content}else{return""}},getHomeData:function(){var a=this;var c={level:a.level};var b={method:"POST",url:ContextClinc_Server+"dentist/getHomeData",dataType:"json",data:c};var d=Utils.myAjaxHandler(b);d.done(function(i){if(i.errorCode==SUCCESSCODE){var e=i.data;$("#todayApptCountSummary").text(e.todayApptCountSummary);$("#todayFinishPatCount").text(e.todayFinishPatCount);$("#todayFinishFollowUpCount").text(e.todayFinishFollowUpCount);if(e.todayMoney){$("#todayMoney").text(e.todayMoney.toFixed(2))}_.each(e.todayPatList,function(m,l,o){var k=$("#treatment_item_clon").clone(true).removeAttr("style").removeAttr("id");k.find(".ADD_DATE").text((new Date(m.ADD_DATE)).Format("HH:mm"));k.find(".PATIENT_NAME").text(m.PATIENT_NAME);k.find(".PATIENT_BIRTH_DATE").text(Utils.getPersonAccurateAge(m.PATIENT_BIRTH_DATE));var n="候诊中";if(m.TREATMENT_STATE==1){n="治疗中"}else{if(m.TREATMENT_STATE==2){n="已完成"}}k.find(".TREATMENT_STATE").text(n);k.find(".DOCTOR_NAME").text(m.DOCTOR_NAME||"");var j="初诊";if(m.VISIT_TYPE==1){j="初诊"}else{if(m.VISIT_TYPE==2){j="复诊"}}k.find(".VISIT_TYPE").text(j);k.find(".FREE_STATUS").text(m.FREE_STATUS);$("#treatment_item").append(k)});if(e.todayPatList&&e.todayPatList.length==0){$("#treatment_info .indexNoData").removeClass("dsn")}if(e.missRecord&&e.missRecord.length>0){_.each(e.missRecord,function(l,k,m){var j=$("#reg_item_clon").clone(true).removeAttr("style").removeAttr("id");var n=l.FAPPTITEM||"";j.find(".DOCTOR_NAME").html(l.FSCHESTARTTIME+"-"+l.FSCHEENDTIME+"    &nbsp;"+(l.DOCTOR_NAME||"未指定医生/科室"));j.find(".PATIENTNAME").html(l.PATIENTNAME+" <span title='"+n+"'>"+n+"</span>");if(l.FAPPTSTATUS=="9"){j.find(".FAPPTSTATUS").removeClass("wait").addClass("late").text("迟")}$("#reg_item").append(j)})}else{$("#appointment").remove()}if(e.news){var f="";var h=ClinicCenter_Web+"index/newsDetail.do?newsId=";_.each(e.news,function(k,j,l){f+='<div class="swiper-slide">';f+='<a class="clear" target="_blank" href="'+h+k.activityId+'">';f+='	<img class="fl banner_img" src="'+k.activityImageLocation+'" >';f+='	<div class="banner_info">';f+='		<div class="banner_title">'+k.activityTitle+"</div>";f+='		<div class="banner_abstract">'+k.activityBreif+"</div>";f+='		<div class="banner_time">'+Utils.timeStampToDateStr(k.createDate,7)+"</div>";f+='		<i class="detail_arrows"></i>';f+="	</div>";f+="</a></div>"});$(".swiper-wrapper").html(f);var g=new Swiper(".swiper-container",{speed:2500,autoplay:2500,direction:"horizontal",loop:true,pagination:".swiper-pagination",paginationClickable:true,autoplayDisableOnInteraction:false,})}if(e.activity){_.each(e.activity,function(k,j,l){var m='<a class="viewMore fr" target="_blank" href="'+ClinicCenter_Web+'index/getHomeCaseModel.do?caseModel=wjdt">查看更多 &gt;</a>';m+='<p class="news_line"><a class="news_info" target="_blank" href="'+ClinicCenter_Web+"index/newsDetail.do?newsId="+k.activityId+'">万家动态：'+k.activityTitle+"</a>";m+='	<span class="latest_logo"></span>';m+="</p>";$(".banner_news").html(m)})}}}).fail(function(e){}).always(function(){})},getWeekSatisfaction:function(d){var b=this;var e="";if(d===1){e="2"}var c={tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},color:["#F35200","#FF6347","#FF8C69","#269FF2","#ababab"],legend:{x:"left",itemWidth:8,itemHeight:8,data:["非常好","很好","好","一般","差评"]},grid:{left:"0%",right:"4%",bottom:"3%",containLabel:true},xAxis:{type:"value"},yAxis:{type:"category",boundaryGap:true,axisLabel:{show:true,formatter:"{value} "},data:["08.15","08.16","08.17","08.18","08.19","08.20","08.21"]},series:[{name:"非常好",type:"bar",stack:"总量",label:{normal:{show:true,position:"inside"}},data:[1,2,3,4,1,3,4]},{name:"很好",type:"bar",stack:"总量",label:{normal:{show:true,position:"inside"}},data:[3,3,11,13,9,2,3]},{name:"好",type:"bar",stack:"总量",label:{normal:{show:true,position:"inside"}},data:[22,1,19,23,29,3,31]},{name:"一般",type:"bar",stack:"总量",label:{normal:{show:true,position:"inside"}},data:[15,0,20,15,19,3,0]},{name:"差评",type:"bar",stack:"总量",label:{normal:{show:true,position:"inside"}},data:[8,8,9,9,12,13,13]}]};var a=echarts.init(document.getElementById("week_box_chart"));if(b.weekSatisfaction){c.yAxis.data=_.pluck(b.weekSatisfaction,"EVALUATIONDATE");c.series[0].data=_.map(_.pluck(b.weekSatisfaction,"VERYNICENUM"+e),function(f){if(f==0){return""}else{return f}});c.series[1].data=_.map(_.pluck(b.weekSatisfaction,"VERYGOODNUM"+e),function(f){if(f==0){return""}else{return f}});c.series[2].data=_.map(_.pluck(b.weekSatisfaction,"GOODNUM"+e),function(f){if(f==0){return""}else{return f}});c.series[3].data=_.map(_.pluck(b.weekSatisfaction,"COMMONLYNUM"+e),function(f){if(f==0){return""}else{return f}});c.series[4].data=_.map(_.pluck(b.weekSatisfaction,"BADNUM"+e),function(f){if(f==0){return""}else{return f}});a.setOption(c);window.onresize=a.resize}},});