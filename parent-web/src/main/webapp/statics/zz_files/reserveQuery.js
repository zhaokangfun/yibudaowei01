var reserveQueryParam={cancelParams:null,changeParams:null,mySelectDate:new Date(),curSelectStatisticsStart:null,curSelectStatisticsEnd:null,curSelectApptStatus:null,curSelectApptStatusActual:"1_0_8",currentPage:1};reserveQueryParam.mySelectDate.setTime(new Date().getTime()+(3*24*60*60*1000));function getCurrentMonthFirst(){var a=new Date();a.setDate(1);return a}function getCurrentMonthLast(){var b=new Date();var e=b.getMonth();var d=++e;var a=new Date(b.getFullYear(),d,1);var c=1000*60*60*24;return new Date(a-c)}$(function(){$("#startDate").val("");$("#endDate").val("");initalAppRecordType();initalApptStatus();serchRegInfo()});$("#res-tbody tr").on("mouseover",function(){});$("#res-tbody tr").on("mouseout",function(){});$("#res-search").on("click",function(){queryRecordInfoByName()});$("#userName").on("keypress",function(a){if(a.keyCode=="13"){queryRecordInfoByName()}});$("#startDate").datetimepicker({lang:"ch",format:"Y-m-d",timepicker:false});$("#endDate").datetimepicker({lang:"ch",format:"Y-m-d",timepicker:false,onSelectDate:function(){if($("#startDate").val()<=$("#endDate").val()){serchRegInfo()}}});$(".weekMonthTodaySelectArea").click(function(){$(".weekMonthTodaySelectArea").removeClass("current");$(this).addClass("current");getRecordStatistics($(this).attr("queryType"))});$(".weekMonthTodayCountArea").click(function(){initalChooseStyle("click",this);if(reserveQueryParam.curSelectStatisticsStart&&reserveQueryParam.curSelectStatisticsEnd){reserveQueryParam.curSelectApptStatus=$(this).attr("apptStatus");$("#startDate").val(reserveQueryParam.curSelectStatisticsStart);$("#endDate").val(reserveQueryParam.curSelectStatisticsEnd);var a=$(this).attr("apptFlag");if(a=="normal"){$("#appRecordTypeInput").val("普通预约")}else{if(a=="product"){$("#appRecordTypeInput").val("健康商品")}}$("#appRecordTypeInput").attr("val",a);serchRegInfo()}else{$.paWarn("未指定日期范围,请刷新后重试！")}});$(".appt-line-ok").on("click",function(){var b=this;var a={msg:"是否预约确认?",cancelTxt:"取消",saveTxt:"确定",onYes:function(){var c=$(b).attr("recordId");var d=$(b).attr("apptFlag");if(c){updateApptIsConfirm_yes(c,d)}else{$.paWarn("预约编号为空,请刷新后重试！")}}};$.paConfirm(a)});$(".appt-line-edit").on("click",function(){var a=$(this).attr("recordId");var b=function(){if($(".reserve-query").hasClass("waiting-appt-content")){$(".waiting-confirm-btn").click()}else{if($(".reserve-query").hasClass("all-appt-content")){$(".all-appt-btn").click()}}};editAppt(a,b)});$(".appt-line-cancel").on("click",function(){var g=this;var a=$(g).data("patientData");var h=a.recordId;var b=a.scheduleId;var d=a.intervalid;var e=a.apptFlag;var f=a.payStatus;var c=a.payPrice;if(!h){$.paWarn("预约编号为空,请刷新页面后重试");return}reserveQueryParam.cancelParams={FAPPTRECORDID:h,FSCHEDULEID:b,INTERVALID:d,APPT_FLAG:e,PAY_STATUS:f,PAY_PRICE:c};$("#cancelReasonSelect").val("");$("#cancelReasonSelect").attr("val","");$("#cancelReason").val("");$("#cancelReason").hide();initalReasonSelect("cancelReasonSelect");$("#showCancelReason").show();$("#showRecordDetail").hide();$("#showCancelReason").ketchup()});$(".appt-line-detail").on("click",function(){var c=$(this).attr("recordId");var d=$(this).attr("apptFlag");var h=$(this).attr("intervalId");var f=$(this).attr("scheduleId",f);var g=$(this).parent().attr("apptStatus");var b=$(this).attr("payStatus");var i=$(this).attr("payPrice");var e=$(this).parent().attr("isClinicTreatmentConfirm");var a={recordId:c,apptFlag:d,intervalid:h,scheduleId:f,fapptstatus:g,isClinicTreatmentConfirm:e,payStatus:b,payPrice:i};$("#showRecordDetail").find(".appt-line-cancel").data("patientData",a);scanGetPatientInfoByRecordId(c)});var appt_line_detail=function(a){scanGetPatientInfoByRecordId(a)};$("#main-details-cancel-btn").on("click",function(){appt_line_cancel(return_msg)});var appt_line_cancel=function(a){var b=a.data;console.log(b);var h=b.RECORD_ID;var c=b.SCHEDULE_ID;var e=b.INTERVAL_ID;var f=b.APPT_FLAG;var g=b.PAY_STATUS;var d=b.payPrice;if(!h){$.paWarn("预约编号为空,请刷新页面后重试");return}reserveQueryParam.cancelParams={FAPPTRECORDID:h,FSCHEDULEID:c,INTERVALID:e,APPT_FLAG:f,PAY_STATUS:g,PAY_PRICE:d};$("#cancelReasonSelect").val("");$("#cancelReasonSelect").attr("val","");$("#cancelReason").val("");$("#cancelReason").hide();initalReasonSelect("cancelReasonSelect");$("#showCancelReason").show();$("#showRecordDetail").hide();$("#showCancelReason").ketchup()};$("#confirmButton").click(function(){var c=$("#cancelReasonSelect").attr("val");if(c=="otherReason"){var a=$("#showCancelReason").ableToFinish();if(!a){return}c=Utils.trimObj($("#cancelReason").val())}else{if(!c){$.paWarn("请选择取消原因");return}}var e=reserveQueryParam.cancelParams.PAY_STATUS;var b=reserveQueryParam.cancelParams.PAY_PRICE;if(e&&e==1){var d={msg:"预约费用￥"+b+"将原路退回，是否确认取消？",cancelTxt:"取消",saveTxt:"确定",onYes:function(){cancelAppt(c)}};$.paConfirm(d)}else{cancelAppt(c)}});$("#exportBtn").off("click").on("click",function(){var c=getSerchParameter();var b="";for(var a in c){if(c[a]&&c[a]!=""&&c[a]!=null){b+=a+"="+c[a]+"&"}}if(b.indexOf("VISIT_NAME")<0){b+="VISIT_NAME="}$.exportData({url:ContextClinc_Server+"clinicAppt/exportAllRegInfo?"+b,})});function cancelAppt(b){reserveQueryParam.cancelParams.APPT_CANCEL_REASON=b;var a={url:ContextClinc_Server+"clinicAppt/cancelRegInfo",dataType:"json",data:JSON.stringify(reserveQueryParam.cancelParams),contentType:"application/json; charset=utf-8"};var c=Utils.myAjaxHandler(a);c.done(function(d){if(d.errorCode==SUCCESSCODE){$(".popup").hide();$.paSuccess("取消成功！");initalChooseStyle();serchRegInfo()}else{$.paWarn(d.errorMessage)}})}$(".cancelButton").click(function(){$(".popup").hide()});$(".tab-kind").off("click").on("click","span",function(){if($(this).hasClass("waiting-confirm-btn")){$(".reserve-query").addClass("waiting-appt-content").removeClass("all-appt-content");$(".show-or-hide").hide();reserveQueryParam.curSelectApptStatusActual="1_0_8";$("#appRecordTypeInput").val("全部").attr("val","");$("#startDate").val("");$("#endDate").val("");serchRegInfo()}else{if($(this).hasClass("all-appt-btn")){$(".reserve-query").addClass("all-appt-content").removeClass("waiting-appt-content");$(".show-or-hide").show();reserveQueryParam.curSelectApptStatusActual="all";$("#apptStatusInput").val("全部").attr("val","all");$("#appRecordTypeInput").val("全部").attr("val","");var b=getCurrentMonthFirst().Format("yyyy-MM-dd");var g=getCurrentMonthLast().Format("yyyy-MM-dd");var j=Utils.getQueryString("startDate");var f=Utils.getQueryString("endDate");var d=Utils.getQueryString("currentPage");var e=Utils.getQueryString("appRecordType");var a=Utils.getQueryString("apptStatusActual");var i=Utils.getQueryString("visitName");if(j&&f){b=j;g=f}else{var h=getQueryConditionFromCookie();if(h){b=h.startDate;g=h.endDate}}if(e){$("#appRecordTypeInput").attr("val",e);if(e=="normal"){$("#appRecordTypeInput").val("普通预约")}else{if(e=="product"){$("#appRecordTypeInput").val("健康商品")}else{$("#appRecordTypeInput").val("全部")}}}if(j&&f){$("#apptStatusInput").attr("val",a);reserveQueryParam.curSelectApptStatusActual=a;if(a=="0_0"){$("#apptStatusInput").val("已取消")}else{if(a=="1_0"){$("#apptStatusInput").val("待确认")}else{if(a=="1_1"){$("#apptStatusInput").val("已确认")}else{if(a=="2"||a=="3"||a=="4"||a=="5"){$("#apptStatusInput").val("已就诊")}else{if(a=="8"){$("#apptStatusInput").val("已过期")}else{if(a=="9"){$("#apptStatusInput").val("已爽约")}else{$("#apptStatusInput").val("全部")}}}}}}}$("#userName").val(i);var c={currentPage:!d?1:parseInt(d)};$("#startDate").val(b);$("#endDate").val(g);serchRegInfo(c)}}});function getSerchParameter(c){var a=$("#startDate").val();var g=$("#endDate").val();var e=Utils.trimObj($("#appRecordTypeInput").attr("val"));var b=Utils.trimObj($("#userName").val());if(a>g){$.paWarn("开始日期大于结束日期！");return}setQueryConditionToCookie(a,g);var f={START_DATE:a,EDN_DATE:g,VISIT_NAME:b,dataType:"reservationRecord",appt_flag:e,appt_status:reserveQueryParam.curSelectApptStatus,appt_status_actual:reserveQueryParam.curSelectApptStatusActual,currentPage:1,pageSize:10};var d=$.extend({},f,c);return d}function serchRegInfo(b){var c=getSerchParameter(b);c.ajaxopts={url:ContextClinc_Server+"clinicAppt/serchRegInfo",contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(c),async:true,showMask:true};c.callback=function(d){if(d.errorCode==SUCCESSCODE){if(c){reserveQueryParam.currentPage=d.data.currentPage}else{reserveQueryParam.currentPage=1}if($(".tab-content").hasClass("waiting-appt-content")){$(".waiting-confirm-btn").text("待确认（"+d.data.totalRecord+"）")}showRecordInfo(d.data.dataSource)}else{$.paWarn(d.errorMessage)}};var a=$("#my-page").generatePagination(c)}function showRecordInfo(u){$("#res-tbody tr:not(#res-line-clone)").remove();if(u){for(var x=0;x<u.length;x++){var r=u[x];var e=$("#res-line-clone").clone(true);e.removeAttr("id");var y=Utils.trimObj(r.PATIENTNAME);var f=Utils.trimObj(r.PATIENT_NO);var k=Utils.trimObj(r.APPT_FLAG);var p=Utils.trimObj(r.FSCHEDATE);var h=Utils.trimObj(r.FSCHESTARTTIME);var m=Utils.trimObj(r.FSCHEENDTIME);var t=Utils.trimObj(r.DOCTOR_NAME);var o=Utils.trimObj(r.HEALTH_PRODUCT_NAME);var l=Utils.trimObj(r.FAPPTITEM);var i=Utils.trimObj(r.FAPPTSTATUS);var s=Utils.trimObj(r.FSCHEDULEID);var B=Utils.trimObj(r.INTERVAL_ID);var a=Utils.trimObj(r.FAPPTRECORDID);var n=Utils.trimObj(r.IS_CONFIRM);var A=Utils.trimObj(r.PHONE_NUMBER);var v=Utils.trimObj(r.ADD_DATE);var q=Utils.trimObj(r.PAY_STATUS);var b=Utils.trimObj(r.PAY_PRICE);var z=splitStrByLength(y,6);e.find(".PATIENTNAME").attr("title",z[0]);e.find(".PATIENTNAME").attr("data-empiId",r.EMPI_ID).attr("data-gender",r.PATIENT_GENDER);e.find(".PATIENTNAME").text(z[1]);e.find(".PATIENTNO").text(f);if(k=="1"){e.find(".APPT_FLAG").text("健康商品")}else{e.find(".APPT_FLAG").text("普通预约")}e.find(".MONBILE").text(A);var d=splitStrByLength(Utils.trimObj(r.APPT_REMARK),8);e.find(".APPT_REMARK").text(d[1]);e.find(".APPT_REMARK").attr("title",d[0]);var c="";if(h&&m){c=h+"-"+m}else{if(h){c=h}else{if(m){c=m}}}e.find(".FSCHEDATE").text(p);e.find(".STARTANDENDTIME").text(c).attr("data-fsche-start-time",h);if(t==null||t==""){t="未分配医生"}var j=splitStrByLength(t,6);e.find(".DOCTOR_NAME").text(j[1]);e.find(".DOCTOR_NAME").attr("title",j[0]);var w=splitStrByLength(l,7);e.find(".FAPPTITEM").text(w[1]);e.find(".FAPPTITEM").attr("title",w[0]);e.find(".appt-line-ok").attr("recordId",a);e.find(".appt-line-ok").attr("apptFlag",k);e.find(".appt-line-change").attr("recordId",a);e.find(".appt-line-change").attr("apptDate",p);e.find(".appt-line-change").attr("appDateStart",h);e.find(".appt-line-change").attr("appDateEnd",m);e.find(".appt-line-detail").attr("recordId",a);e.find(".appt-line-detail").attr("apptFlag",k);e.find(".appt-line-detail").attr("intervalId",B);e.find(".appt-line-detail").attr("scheduleId",s);e.find(".appt-line-detail").attr("payStatus",q);e.find(".appt-line-detail").attr("payPrice",b);e.find(".appt-line-edit").attr("recordId",a);e.find(".HANDLER").attr("apptStatus",i);var g=Utils.trimObj(r.IS_CLINIC_TREATMENT_CONFIRM);e.find(".HANDLER").attr("isClinicTreatmentConfirm",g);if(i=="0"){e.find(".appt-line-edit").remove();e.find(".appt-line-ok").remove();e.find(".APPT_STATUS").text("已取消");e.find(".APPT_STATUS").addClass("cancleStyle")}else{if(i=="1"){if(n=="1"&&g=="0"){e.find(".appt-line-ok").remove();e.find(".APPT_STATUS").text("已确认")}else{if(g=="1"){e.find(".appt-line-edit").remove();e.find(".appt-line-ok").remove();e.find(".APPT_STATUS").text("已就诊")}else{if(n=="1"){e.find(".appt-line-ok").remove();e.find(".APPT_STATUS").text("已确认")}else{e.find(".APPT_STATUS").text("待确认");e.find(".APPT_STATUS").addClass("appointmentStyle")}}}}else{if(i=="2"||i=="3"||i=="4"||i=="5"){e.find(".appt-line-edit").remove();e.find(".appt-line-ok").remove();e.find(".APPT_STATUS").text("已就诊")}else{if(i=="8"){e.find(".APPT_STATUS").text("已过期");e.find(".APPT_STATUS").addClass("expiredStyle")}else{if(i=="9"){e.find(".appt-line-edit").remove();e.find(".appt-line-ok").remove();e.find(".APPT_STATUS").text("已爽约");e.find(".APPT_STATUS").addClass("missStyle")}}}}}e.show();$("#res-tbody").append(e)}}}function updateApptIsConfirm_yes(b,d){var c={FAPPTRECORDID:b,APPT_FLAG:d};var a={url:ContextClinc_Server+"clinicAppt/updateApptIsConfirm_yes",dataType:"json",data:JSON.stringify(c),contentType:"application/json; charset=utf-8"};var e=Utils.myAjaxHandler(a);e.done(function(g){if(g.errorCode==SUCCESSCODE){$.paSuccess("确认预约成功");initalChooseStyle();var f={currentPage:parseInt(reserveQueryParam.currentPage)};serchRegInfo(f);getWEIXINMessageByRecordId(b)}else{$.paWarn(g.errorMessage)}})}function getWEIXINMessageByRecordId(b){var d={recordId:b};var a={url:ContextClinc_Server+"clinicAppt/getWEIXINMessageByRecordId",dataType:"json",data:JSON.stringify(d),contentType:"application/json; charset=utf-8"};var c=Utils.myAjaxHandler(a);c.done(function(e){if(e.errorCode==SUCCESSCODE){sendWEIXINMessage(e.data)}})}function sendWEIXINMessage(e){if(e){var g=Utils.trimObj(e.clinicName);var i=Utils.trimObj(e.productName);var b=Utils.trimObj(e.addressName);var a=Utils.trimObj(e.visitName);var d=Utils.trimObj(e.apptTime);var c=Utils.trimObj(e.openId);var j=Utils.trimObj(e.productItemName);var k=Utils.trimObj(e.treatmentNumber);var h=Utils.trimObj(e.apptFlag);if(c&&g&&a&&d){var f=null;if(h=="1"){f={clinicName:g,productName:i,productItemName:j,treatmentNumber:k,addressName:b,visitName:a,apptTime:d,openId:c}}else{f={clinicName:g,addressName:b,visitName:a,apptTime:d,openId:c}}var m={type:"POST",contentType:"application/json; charset=utf-8",url:WXServicePath+"TempSureReg",data:JSON.stringify(f),dataType:"json"};var l=Utils.myAjaxHandler(m);l.done(function(n){if(n){}}).fail(function(n){}).always(function(){})}}}function getRecordStatistics(a){var d={queryType:a};var b={type:"POST",contentType:"application/x-www-form-urlencoded",url:ContextClinc_Server+"clinicAppt/getRecordStatisticsTotal",data:d,dataType:"json",async:true};var c=Utils.myAjaxHandler(b);c.done(function(e){if(e.errorCode==SUCCESSCODE){showRecordStatistics(a,e.data)}else{$.paWarn(e.errorMessage,null)}}).fail(function(e){$.paError("请求异常",null)}).always(function(){})}function showRecordStatistics(a,d){if(a=="month"){$(".weekMonthTodayName").text("（本月）")}else{if(a=="week"){$(".weekMonthTodayName").text("（本周）")}else{if(a=="today"){$(".weekMonthTodayName").text("（今日）")}}}if(d){reserveQueryParam.curSelectStatisticsStart=Utils.trimObj(d.START_DATE);reserveQueryParam.curSelectStatisticsEnd=Utils.trimObj(d.END_DATE);var f=d.normalProduceByWaitting?d.normalProduceByWaitting:0;var b=d.normalProduceByDiagnosed?d.normalProduceByDiagnosed:0;var e=d.healthProduceByWaitting?d.healthProduceByWaitting:0;var c=d.healthProduceByDiagnosed?d.healthProduceByDiagnosed:0;$("#normalProduceByWaitingCount").text(f);$("#normalProduceByDiagnosedCount").text(b);$("#healthProduceByWaitingCount").text(e);$("#healthProduceByDiagnosedCount").text(c)}}function queryRecordInfoByName(){reserveQueryParam.curSelectApptStatus=null;initalChooseStyle();if($(".tab-content").hasClass("all-appt-content")){reserveQueryParam.curSelectApptStatusActual=$("#apptStatusInput").attr("val")}else{if($(".tab-content").hasClass("waiting-appt-content")){reserveQueryParam.curSelectApptStatusActual="1_0_8"}}serchRegInfo()}function splitStrByLength(c,a){var b=[];b.push(c);if(c){if(c.length>a){b.push(c.substr(0,a)+"..")}else{b.push(c)}}return b}function checkStartAndEndTime(e,c){var d="";var a=e.split(":");var b=c.split(":");var f=parseInt(a[0])*60+parseInt(a[1]);var g=parseInt(b[0])*60+parseInt(b[1]);if(f>=g){d="起始时间必须小于终止时间"}return d}function initalReasonSelect(a){var c=[{modeId:"该时段预约已满,无法接诊",modeName:"该时段预约已满,无法接诊"},{modeId:"长时间联系不到客户,无法确认接诊",modeName:"长时间联系不到客户,无法确认接诊"},{modeId:"客户信息填写错误,要求重新预约",modeName:"客户信息填写错误,要求重新预约"},{modeId:"客户无法前往,要求取消或修改预约",modeName:"客户无法前往,要求取消或修改预约"},{modeId:"otherReason",modeName:"其他原因"}];var b={idKey:"modeId",txtKey:"modeName",isNeedAll:false,isNeedClear:true};$("#"+a).WJZSDropdown(c,b,function(d,e){if(e.modeId=="otherReason"){if(a.indexOf("cancel")>=0){$("#cancelReason").show()}else{$("#changeAppDateReason").show()}}else{if(a.indexOf("cancel")>=0){$("#cancelReason").hide()}else{$("#changeAppDateReason").hide()}}})}function initalAppRecordType(){var b=[{modeId:"normal",modeName:"普通预约"},{modeId:"product",modeName:"健康商品"}];var a={idKey:"modeId",txtKey:"modeName",isNeedAll:true,isNeedClear:false};$("#appRecordTypeInput").WJZSDropdown(b,a,function(c,d){reserveQueryParam.curSelectApptStatus=null;initalChooseStyle();serchRegInfo()})}function initalApptStatus(){var b=[{modeId:"all",modeName:"全部"},{modeId:"0_0",modeName:"已取消"},{modeId:"1_0",modeName:"待确认"},{modeId:"1_1",modeName:"已确认"},{modeId:"2",modeName:"已就诊"},{modeId:"8",modeName:"已过期"},{modeId:"9",modeName:"已爽约"}];var a={idKey:"modeId",txtKey:"modeName",isNeedAll:false,isNeedClear:false};$("#apptStatusInput").WJZSDropdown(b,a,function(c,d){reserveQueryParam.curSelectApptStatusActual=Utils.trimObj(d.modeId);initalChooseStyle();serchRegInfo()})}function initalChooseStyle(a,b){if(a=="click"){$(".weekMonthTodayCountArea").removeClass("selectedRecord");$(b).addClass("selectedRecord")}else{$(".weekMonthTodayCountArea").removeClass("selectedRecord")}}function getQueryConditionFromCookie(){var b=null;var a=Utils.trimObj(Utils.getCookie("START_DATE_IN_RESERVEQUERY_"));var c=Utils.trimObj(Utils.getCookie("END_DATE_IN_RESERVEQUERY_"));if(a&&c){b={startDate:a,endDate:c,}}return b}function setQueryConditionToCookie(a,c){var b=null;a=Utils.trimObj(a);c=Utils.trimObj(c);if(a&&c){document.cookie="START_DATE_IN_RESERVEQUERY_="+a;document.cookie="END_DATE_IN_RESERVEQUERY_="+c}return b};