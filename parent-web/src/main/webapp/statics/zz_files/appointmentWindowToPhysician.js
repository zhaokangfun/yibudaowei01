function ApptWindow(){this._initDom();this._init()}ApptWindow.prototype={newOrEditFlag:0,apptInfoData:{apptItems:[]},doctorOrDepartment:"",scheduleDoctorModel:1,doctorData:[],timesData:[],appointmentData:null,minAppointmentData:[],activeAppointmentData:{},activeRecordId:"",changeTimesOrder:false,changeDoctorName:false,firstNewAppt:true,activeAppointmentHeight:1,saveAppointmentData:{},APPT_FLAG:0,callback:null,timer:null,_init:function(){var c=this;c.initApptWindowEle();c.initRadioData();c.patientNameThinkBox();c.initDynamicData();c.renderApptWindowDom()},_initDom:function(){var c='        <div class="cancel-appt-window-p dsn">            <div class="cancel-close-p">×</div>            <div class="cancel-header-p">修改预约</div>            <div class="cancel-footer-p">                <div class="message-p">此预约来源于健康商品，请提供修改原因，系统将自动通知用户。</div>                <div class="clear write-reason-box-p">                    <span class="cancel-reason-title-p"><i class="must-icon">*</i>修改原因</span>                    <div class="cancel-reason-info-p">                        <textarea id="write-reason-p" maxlength="50"></textarea>                    </div>                </div>                <div class="clear">                    <div class="cancel-save-btn-p">保存</div>                    <div class="cancel-cancel-btn-p">取消</div>                </div>            </div>        </div>        <div class="bg-screen dsn">            <div class="appointment-box clear" id="cloneAppt" style="display: none;">                <i class="box-patient-type"></i>                <i class="product-icon"></i>                <div class="clear word-box">                    <div class="box-patient-name"></div>                    <div class="box-patient-time"></div>                </div>                <div class="clear word-box">                    <div class="box-appointment-events"></div>                </div>            </div>            <div class="popup new-appointment-window">                <div class="popstyle">                    <div class="poptitle"><span class="title">新增预约</span><span class="close">×</span></div>                    <div class="popcontent">                        <div class="content-left">                            <div class="wrap-line clear">                                <span class="wrap-name"><i class="must-icon">*</i>患者姓名:</span>                                <input type="text" class="input-text wrap-input validate(required)" id="patient-name" maxlength="25">                            </div>                            <div class="wrap-line clear">                                <span class="wrap-name"><i class="must-icon">*</i>患者性别:</span>                                <div id="patient-sex"></div>                            </div>                            <div class="wrap-line clear">                                <span class="wrap-name"><i class="must-icon">*</i>手机号码:</span>                                <input type="text" class="input-text wrap-input validate(required, phone)" id="patient-phone" maxlength="11">                            </div>                            <div class="wrap-line clear">                                <span class="wrap-name"><i class="must-icon">*</i>就诊类型:</span>                                <div id="cure-type"></div>                            </div>                            <div class="wrap-line clear">                                <span class="wrap-name">预约事项:</span>                                <div id="appointment-events"></div>                            </div>                            <div class="wrap-line clear">                                <span class="wrap-name">备注:</span>                                <textarea id="new-remark" maxlength="100"></textarea>                            </div>				        	<div class="wrap-line clear">						        <a id="clear_data" href="javascript:;" class="fl" style="margin-bottom: 0;">清空</a>							</div>                        </div>                        <div class="content-right">                            <div class="wrap-line clear">                                <div class="wrap-left clear">                                    <span class="wrap-name-half">预约医生:</span>                                    <div class="drop wrap-input-half">                                        <input id="doctor-name" type="text" class="input-text" readonly="readonly">                                        <i class="drop-icon"></i>                                        <ul class="wjzs-drop-menu dsn" style="top: 28px; display: none;">                                        </ul>                                    </div>                                </div>                                <div class="wrap-right clear">                                    <span class="wrap-name-half">预约日期:</span>                                    <div class="date  wrap-input-half date_list">                                        <input id="appointment-date" class="input-text" type="text" name="initiation" readonly="readonly">                                        <i class="date-icon"></i>                                    </div>                                </div>                            </div>                            <div class="wrap-line clear">                                <div class="wrap-left clear">                                    <span class="wrap-name-half">预约班次:</span>                                    <div class="drop wrap-input-half">                                        <input id="times-order" type="text" class="input-text" readonly="readonly">                                        <i class="drop-icon"></i>                                        <ul class="wjzs-drop-menu dsn" style="top: 28px; display: none;">                                        </ul>                                    </div>                                </div>                            </div>                            <div class="min-appt-box">                                <div class="min-table-time-box">                                    <table class="min-table-time">                                    </table>                                </div>                                <div class="min-table-doctor-box">                                    <table class="min-table-doctor"></table>                                    <div class="min-template-div">                                    </div>                                    <div class="min-appt-float-box" style="display: none">新增预约</div>                                </div>                            </div>                            <div class="new-appt-btn-box clear">                                <div class="new-appt-btn new-appt-save">保存</div>                                <div class="new-appt-btn new-appt-cancel">取消</div>                            </div>                        </div>                    </div>                </div>            </div>        </div>        ';if($(document).find("#cloneAppt").length==0){$("body").append(c)}if(this.newOrEditFlag==2){$("#clear_data").hide()}else{$("#clear_data").show()}},initApptWindowEle:function(){var c=this;if(c.apptInfoData.apptDate){$("#appointment-date").val(c.apptInfoData.apptDate)}if(c.apptInfoData.doctorOrDepartId){$("#doctor-name").attr("val",c.apptInfoData.doctorOrDepartId)}if(c.apptInfoData.scheduleSetId){$("#times-order").attr("val",c.apptInfoData.scheduleSetId)}},initRadioData:function(){var c=this;$("#patient-sex").setInputForm([{id:"1",txt:"男"},{id:"2",txt:"女"},{id:"3",txt:"保密"}]).checkedItem([{id:"1"}]);$("#cure-type").setInputForm([{id:"1",txt:"初诊"},{id:"2",txt:"复诊"}],{},function(d){if(d.id=="2"){$(".min-template-div").find("#min-appt-float-box .box-patient-type").text("复").show()}else{if(d.id=="1"){$(".min-template-div").find("#min-appt-float-box .box-patient-type").text("").hide()}}}).checkedItem([{id:"1"}]);$(".new-appt-cancel").on("click",function(){$(".bg-screen").hide()});$(".new-appointment-window").find(".close").off("click").on("click",function(){$(".bg-screen").hide()});$(".content-left").ketchup();$(".cancel-cancel-btn-p").off("click").on("click",function(){$(this).parents(".cancel-appt-window-p").hide()});$(".cancel-close-p").off("click").on("click",function(){$(this).parents(".cancel-appt-window-p").hide()});$(".cancel-save-btn-p").off("click").on("click",function(){var d=$.trim($("#write-reason-p").val());if(d!=""){var g=new RegExp("[`~!@#$^&*=|{}'',\\.<>/?~！@#￥……&*（）&mdash;—|{}【】‘”“']");var e="";for(var f=0;f<d.length;f++){e=e+d.substr(f,1).replace(g,"")}c.saveAppointmentData.apptInfo.apptEditReason=e;c.requestIntervalInfo(c.saveAppointmentData,"edit")}else{$.paWarn("修改原因不能为空！");return}});$("#clear_data").on("click",function(){if(c.newOrEditFlag==1){$("#patient-name").val("").removeClass("pawjzs-error").prop("disabled",false);$("#patient-phone").val("").removeClass("pawjzs-error");$("#appointment-events").cancelCheckedAll();$("#new-remark").val("").removeClass("pawjzs-error");$("#cure-type").checkedItem([{id:1}]);$("#patient-sex").checkedItem([{id:1}]);c.empiId=null}})},patientNameThinkBox:function(){var c=this;var e={columns:[{display:"姓名",dataKey:"NAME",width:90},{display:"性别",dataKey:"PATIENTSEX",width:40},{display:"年龄",dataKey:"PATIENTBIRTHDATE",width:70},{display:"手机",dataKey:"MOBILEPHONENUMBER",width:100},{display:"最近就诊医生",dataKey:"RECENTDOCTORNAME",width:100}],selectFirst:true,formatResult:function(f){return f.NAME},matchContains:"word",autoFill:false,width:415,ajaxOptions:{method:"POST"},multiple:false,multipleSeparator:", ",highlight:function(g,f){return g.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+f.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:180,canedit:true};var d=ContextClinc_Server+"patient/selectPatientListByPatName";$("#patient-name").autocomplete(d,e).result(function(f,h,g){$("#patient-name").prop("disabled",true);$("#patient-sex").checkedItem([{id:h.PATIENTSEX_}]);$("#patient-phone").val(h.MOBILEPHONENUMBER);$("#cure-type").checkedItem([{id:2}]);$(".min-template-div").find("#min-appt-float-box .box-patient-type").text("复").show();c.empiId=h.EMPIID})},initDateDom:function(){var e=this;var c=$("#appointment-date");if(e.apptInfoData.apptDate){c.val(e.apptInfoData.apptDate)}else{var d=new Date();d.setDate(d.getDate()+1);c.val(d.Format("yyyy-MM-dd"))}var f=new Date();f.setDate(f.getDate()+parseInt(e.MIN_APPT_DAY));f=f.Format("yyyy/MM/dd");var g=new Date();g.setDate(g.getDate()+parseInt(e.MAX_APPT_DAY));g=g.Format("yyyy/MM/dd");c.datetimepicker({lang:"ch",format:"Y-m-d",timepicker:false,mask:false,minDate:f,maxDate:g,onSelectDate:function(){e.changeTimesOrder=false;e.changeDoctorName=false;e.firstNewAppt=false;e.activeAppointmentHeight=JSON.parse($(".min-template-div").find("#min-appt-float-box").attr("y")).length;e.requestTimesOrderData()}})},initDynamicData:function(){var c=this;c.requestTimesOrderData();c.requestCanScheduleDoctor();c.requestAppointmentData();c.requestApptEventsByDoctorOrDept()},renderApptEventsByDoctorOrDept:function(e){var c=this;var e=e;if(e==null||e.length==0){$("#appointment-events").addClass("no-appt-events").html("暂无数据<br>请维护预约事项！")}else{$("#appointment-events").removeClass("no-appt-events");for(var d=0;d<e.length;d++){if(e[d].TIMES){e[d].ITEM_NAME_TIMES=e[d].ITEM_NAME+"（"+e[d].TIMES+"分钟）"}else{e[d].ITEM_NAME_TIMES=e[d].ITEM_NAME}}$("#appointment-events").empty().setInputForm(e,{idKey:"ITEM_ID",txtKey:"ITEM_NAME_TIMES",type:"checkbox"},function(j){var g=$("#appointment-events").getCheckedData();var h="";var k=0;if(g.length>0){for(var f=0;f<g.length;f++){if(f==g.length-1){h+=g[f].ITEM_NAME}else{h+=g[f].ITEM_NAME+"；"}k+=g[f].TIMES?parseInt(g[f].TIMES):0}$(".min-template-div").find("#min-appt-float-box .box-appointment-events").text(h).attr("title",h)}else{$(".min-template-div").find("#min-appt-float-box .box-appointment-events").text("")}c.calculateActiveApptHeight(k,j)}).checkedItem(c.apptInfoData.apptItems)}},calculateActiveApptHeight:function(j,h){var e=this;var g=Math.ceil(j/e.timeInterval);for(var f=0;f<e.minAppointmentData.length;f++){if($("#min-appt-float-box").attr("record_id")==e.minAppointmentData[f].RECORD_ID){var d=$(".min-table-time").find("tr[start_time='"+e.minAppointmentData[f].START_TIME+"']").index();var c=d+g-1;if(c<d){c=d}else{if(c>$(".min-table-time").find("tr").length-1){c=$(".min-table-time").find("tr").length-1;$.paWarn("剩余可约时长不足！")}}e.apptInfoData.endTime=e.activeAppointmentData.END_TIME=e.minAppointmentData[f].END_TIME=$(".min-table-time").find("tr").eq(c).attr("end_time")}}e.posAppointmentDiv()},renderDoctorDrop:function(f){var c=this;var e={idKey:"FEMPLOYEEID",txtKey:"FEMPLOYEENAME",isNeedClear:false,isNeedThink:true};$("#doctor-name").WJZSDropdown(f,e,function(h,i){c.changeTimesOrder=false;c.changeDoctorName=true;c.firstNewAppt=false;c.activeAppointmentHeight=JSON.parse($(".min-template-div").find("#min-appt-float-box").attr("y")).length;c.apptInfoData.scheduleSetId=$("#times-order").attr("val");c.apptInfoData.startTime=$("#min-appt-float-box").data("patientInfoData").START_TIME;c.apptInfoData.endTime=$("#min-appt-float-box").data("patientInfoData").END_TIME;c.apptInfoData.doctorOrDepartId=$("#doctor-name").attr("val");c.requestTimesOrderData();c.requestApptEventsByDoctorOrDept()});var g=f.length-1;$("#doctor-name").attr("val",f[g].FEMPLOYEEID).val(f[g].FEMPLOYEENAME);for(var d=0;d<f.length;d++){if(c.apptInfoData.doctorOrDepartId==f[d].FEMPLOYEEID){$("#doctor-name").attr("val",f[d].FEMPLOYEEID).val(f[d].FEMPLOYEENAME)}}c.renderMinTableDoctor()},renderTimesOrderDrop:function(e){var d=this;var h={idKey:"SCHEDULE_SET_ID",txtKey:"SCHEDULE_SET_NAME",isNeedClear:false};var f=e[0].INTERVAL_TIME;$("#times-order").WJZSDropdown(e,h,function(l,m){d.changeTimesOrder=true;d.changeDoctorName=false;d.firstNewAppt=false;d.activeAppointmentHeight=JSON.parse($(".min-template-div").find("#min-appt-float-box").attr("y")).length;for(var k=0;k<e.length;k++){if(m.SCHEDULE_SET_ID==e[k].SCHEDULE_SET_ID){f=e[k].INTERVAL_TIME}}d.renderMinTableTime(f)});$("#times-order").attr("val",e[0].SCHEDULE_SET_ID).val(e[0].SCHEDULE_SET_NAME);if(d.apptInfoData.scheduleSetId){for(var g=0;g<e.length;g++){if(d.apptInfoData.scheduleSetId==e[g].SCHEDULE_SET_ID){f=e[g].INTERVAL_TIME;$("#times-order").attr("val",e[g].SCHEDULE_SET_ID).val(e[g].SCHEDULE_SET_NAME);break}}}else{for(var c=0;c<e.length;c++){for(var j=0;j<e[c].INTERVAL_TIME.length;j++){if(d.apptInfoData.startTime==e[c].INTERVAL_TIME[j].START_TIME){f=e[c].INTERVAL_TIME;$("#times-order").attr("val",e[c].SCHEDULE_SET_ID).val(e[c].SCHEDULE_SET_NAME);break}}}}d.renderMinTableTime(f)},renderMinTableTime:function(e,f){var c=this;$(".min-table-time").empty();for(var d=0;d<e.length;d++){var g=$("<tr>").attr("start_time",e[d].START_TIME).attr("end_time",e[d].END_TIME).append("<td interval_limit="+e[d].INTERVAL_LIMIT+">"+e[d].START_TIME+"-"+e[d].END_TIME+"</td>");$(".min-table-time").append(g)}if(c.changeTimesOrder){c.apptInfoData.startTime=c.minAppointmentData[c.minAppointmentData.length-1].START_TIME=c.activeAppointmentData.START_TIME=$(".min-table-time").find("tr").eq(0).attr("start_time");var h=$(".min-table-time").find("tr").length;if(c.activeAppointmentHeight>h){c.apptInfoData.endTime=c.minAppointmentData[c.minAppointmentData.length-1].END_TIME=c.activeAppointmentData.END_TIME=$(".min-table-time").find("tr").eq(h-1).attr("end_time")}else{c.apptInfoData.endTime=c.minAppointmentData[c.minAppointmentData.length-1].END_TIME=c.activeAppointmentData.END_TIME=$(".min-table-time").find("tr").eq(c.activeAppointmentHeight-1).attr("end_time")}c.renderMinTableDoctor();c.posAppointmentDiv()}else{if(c.changeDoctorName){c.renderMinTableDoctor()}else{if(c.firstNewAppt){c.timer=setInterval(function(){if(c.doctorData.length>0){clearInterval(c.timer);c.renderDoctorDrop(c.doctorData)}},50)}else{c.renderMinTableDoctor()}}}},renderMinTableDoctor:function(){var d=this;var k=$(".min-table-time").find("tr").length;$(".min-table-doctor").empty();var c=$("#doctor-name").attr("val");var f=$("#times-order").attr("val");var j=$("#appointment-date").val();var g=false;if(c=="no"){while(k--){var h=$("<tr>").append("<td source_num=0></td>");$(".min-table-doctor").append(h)}}else{for(var e=0;e<d.timesData.length;e++){if(f==d.timesData[e].SCHEDULE_SET_ID){if(d.timesData[e].schedule_date.indexOf(j)!=-1){g=true;break}}}if(g){while(k--){var h=$("<tr>").append("<td source_num=0></td>");$(".min-table-doctor").append(h)}}else{while(k--){var h=$("<tr>").append("<td class='no-schedule'>未排班</td>");$(".min-table-doctor").append(h)}}}if(!d.firstNewAppt){if(!d.changeTimesOrder){d.requestAppointmentData()}}else{if(!d.changeTimesOrder){d.timer=setInterval(function(){if(d.appointmentData){clearInterval(d.timer);d.renderAppointmentDiv(d.appointmentData)}},50)}}},renderAppointmentDiv:function(g){var d=this;var c=$("#doctor-name").attr("val");d.minAppointmentData=[];if(c!="no"){for(var f=0;f<g.length;f++){if(g[f][d.doctorOrDepartment]==c){d.minAppointmentData.push(g[f])}}}else{for(var e=0;e<g.length;e++){if(g[e][d.doctorOrDepartment]==null||g[e][d.doctorOrDepartment]=="null"){d.minAppointmentData.push(g[e])}}}if(d.changeTimesOrder){d.posAppointmentDiv()}else{d.createMinApptData()}},createMinApptData:function(){var d=this;if(d.newOrEditFlag==1){if(d.apptInfoData.startTime&&d.apptInfoData.endTime){var c=false;var e=false;$(".min-table-time").find("tr").each(function(){if($(this).attr("start_time")==d.apptInfoData.startTime){c=true}if($(this).attr("end_time")==d.apptInfoData.endTime){e=true}});if(!c||!e){d.apptInfoData.startTime=$(".min-table-time").find("tr").eq(0).attr("start_time");var f=$(".min-table-time").find("tr").length;if(d.activeAppointmentHeight>f){d.apptInfoData.endTime=$(".min-table-time").find("tr").eq(f-1).attr("end_time")}else{d.apptInfoData.endTime=$(".min-table-time").find("tr").eq(d.activeAppointmentHeight-1).attr("end_time")}}d.activeAppointmentData={RECORD_ID:"new-appt-data",PATIENT_SEX:"1",APPT_TYPE:1,START_TIME:d.apptInfoData.startTime,END_TIME:d.apptInfoData.endTime}}else{d.activeAppointmentData={RECORD_ID:"new-appt-data",PATIENT_SEX:"1",APPT_TYPE:1,START_TIME:$(".min-table-time").find("tr").eq(0).attr("start_time"),END_TIME:$(".min-table-time").find("tr").eq(0).attr("end_time")}}d.minAppointmentData.push(d.activeAppointmentData);d.posAppointmentDiv()}else{if(d.newOrEditFlag==2){var c=false;var e=false;$(".min-table-time").find("tr").each(function(){if($(this).attr("start_time")==d.apptInfoData.startTime){c=true}if($(this).attr("end_time")==d.apptInfoData.endTime){e=true}});if(!c||!e){d.apptInfoData.startTime=$(".min-table-time").find("tr").eq(0).attr("start_time");var f=$(".min-table-time").find("tr").length;if(d.activeAppointmentHeight>f){d.apptInfoData.endTime=$(".min-table-time").find("tr").eq(f-1).attr("end_time")}else{d.apptInfoData.endTime=$(".min-table-time").find("tr").eq(d.activeAppointmentHeight-1).attr("end_time")}}d.activeAppointmentData={RECORD_ID:"new-appt-data",APPT_ITEMS:d.apptInfoData.apptItems,APPT_REMARK:d.apptInfoData.apptRemark,DOCTOR_OR_DEPART_ID:d.apptInfoData.doctorOrDepartId,DOCTOR_OR_DEPART_NAME:d.apptInfoData.doctorOrDepartName,APPT_TYPE:d.apptInfoData.apptType,START_TIME:d.apptInfoData.startTime,END_TIME:d.apptInfoData.endTime};d.minAppointmentData.push(d.activeAppointmentData);d.posAppointmentDiv()}}},posAppointmentDiv:function(){var u=this;$(".min-table-doctor").find("td").attr("source_num",0);$(".min-template-div").empty();for(var g=0;g<u.minAppointmentData.length;g++){var s="1";var m=$("#cloneAppt").clone(true);m.removeAttr("id");m.attr("record_id",u.minAppointmentData[g].RECORD_ID);m.data("patientInfoData",u.minAppointmentData[g]);if(u.minAppointmentData[g].APPT_TYPE==1){m.find(".box-patient-type").hide();m.find(".box-patient-name").addClass("has-no-status")}else{if(u.minAppointmentData[g].APPT_TYPE==2){m.find(".box-patient-type").text("复").show()}}m.find(".box-patient-name").text(u.minAppointmentData[g].PATIENT_NAME).attr("title",u.minAppointmentData[g].PATIENT_NAME);if(u.minAppointmentData[g].APPT_ITEM!=null&&u.minAppointmentData[g].APPT_ITEM!="null"){m.find(".box-appointment-events").text(u.minAppointmentData[g].APPT_ITEM).attr("title",u.minAppointmentData[g].APPT_ITEM)}var q=u.minAppointmentData[g].START_TIME+"-"+u.minAppointmentData[g].END_TIME;m.find(".box-patient-time").text(q).attr("title",q);$(".min-template-div").append(m);var t=0;var f=0;var p=false;var e=false;$(".min-table-time").find("tr").each(function(h){if($(this).attr("start_time")==u.minAppointmentData[g].START_TIME){t=h;p=true}if($(this).attr("end_time")==u.minAppointmentData[g].END_TIME){f=h;e=true}});if(p&&e){if(u.newOrEditFlag==1){for(var l=t;l<=f;l++){var k=$(".min-table-doctor").find("tr").eq(l).find("td");var d=k.attr("source_num");d?d=parseInt(d):d=0;k.attr("source_num",d+1)}}else{if(m.attr("record_id")!=u.activeRecordId&&u.newOrEditFlag==2){for(var l=t;l<=f;l++){var k=$(".min-table-doctor").find("tr").eq(l).find("td");var d=k.attr("source_num");d?d=parseInt(d):d=0;k.attr("source_num",d+1)}}}}var j=40;var o=$(".min-table-doctor").find("td:first-child").outerWidth();m.height((f-t+1)*j-4);m.css({top:t*j+3});var r=[];for(var c=0;c<f-t+1;c++){r.push(String.fromCharCode(t+c+97))}m.attr("x",s);m.attr("y",JSON.stringify(r));if(p&&e){m.show()}else{m.remove()}if(m.attr("record_id")==u.activeRecordId&&m.attr("record_id")!="new-appt-data"){m.remove()}}u.posLeftAppointmentDiv()},posLeftAppointmentDiv:function(){var l=this;var f=[];var h=["1"];$(".min-template-div").find(".appointment-box").each(function(){var c={};c.RECORD_ID=$(this).attr("record_id");c.x=$(this).attr("x");c.y=$(this).attr("y");f.push(c)});var g=[];for(var z=0;z<h.length;z++){var r={};r.x=h[z];r.y=[];for(var A=0;A<f.length;A++){if(f[A].x==h[z]){r.y.push(JSON.parse(f[A].y))}}g.push(r)}for(var y=0;y<g.length;y++){g[y].y=l.getArrKind(g[y].y);g[y].num=[];g[y].num.length=g[y].y.length;for(var s=0;s<g[y].num.length;s++){g[y].num[s]=0}g[y].index=[];g[y].totalId=[];g[y].ny=[];g[y].index.length=g[y].y.length;g[y].totalId.length=g[y].y.length;g[y].ny.length=g[y].y.length;for(var i=0;i<g[y].index.length;i++){g[y].index[i]=0;g[y].totalId[i]=[];g[y].ny[i]=[]}}for(var x=0;x<g.length;x++){for(var w=0;w<g[x].y.length;w++){for(var t=0;t<f.length;t++){if(l.rel(f[t].y,g[x].y[w])&&f[t].x==g[x].x){g[x].num[w]++;g[x].totalId[w].push(f[t].RECORD_ID);$.merge(g[x].ny[w],JSON.parse(f[t].y))}}}}if($(".min-table-doctor").find("tr").length>7){var v=254}else{var v=267}for(var F=0;F<g.length;F++){for(var E=0;E<g[F].ny.length;E++){g[F].ny[E]=l.getMost(g[F].ny[E]);for(var D=0;D<g[F].totalId[E].length;D++){$(".min-template-div").find("div[record_id="+g[F].totalId[E][D]+"]").width((v-16)/g[F].ny[E]-2)}}}for(var F=0;F<g.length;F++){for(var E=0;E<g[F].ny.length;E++){g[F].ny[E]=l.getMost(g[F].ny[E]);var e=l.pickArr(g[F].totalId[E]);for(var D=0;D<e.length;D++){for(var B=0;B<e[D].length;B++){var C=$(".min-template-div").find("div[record_id="+e[D][B]+"]");C.css("left",(parseInt(C.attr("x"))-1)*v+3+D*(C.width()+2))}}}}$("#patient-name").removeClass("pawjzs-error");$("#patient-phone").removeClass("pawjzs-error");$(".bg-screen").show();$(".new-appt-save").removeClass("already-click");$(".new-appointment-window").css({top:$(window).height()/2-271,right:$(window).width()/2-355}).show();l.renderMinContentStyle();l.minBindEvent();l.scrollTheTd(l.activeAppointmentData.START_TIME)},renderMinContentStyle:function(){var c=this;$(".min-template-div").find(".appointment-box").each(function(){var d=$(this).outerWidth();if(d<30){$(this).text("..")}else{if(d<40){$(this).find(".box-patient-type").hide();$(this).find(".box-patient-name").css("padding-right","0px")}}$(this).find(".box-appointment-events").width($(this).outerWidth()-2);if($(this).height()<70){$(this).find(".box-appointment-events").parent().hide()}else{$(this).find(".box-appointment-events").parent().show()}})},scrollTheTd:function(c){var d=0;$(".min-table-time").find("tr").each(function(){if($(this).attr("start_time")==c){d=$(this).offset().top-$(".min-appt-box").offset().top}});$(".min-appt-box").scrollTop(d+$(".min-appt-box").scrollTop()-140)},minBindEvent:function(){var c=this;$(".min-template-div").find(".appointment-box").each(function(){if($(this).attr("RECORD_ID")=="new-appt-data"){$(this).prop("id","min-appt-float-box").append("<i id='pull-move'></i><i class='pull' id='pull-up'></i><i class='pull' id='pull-down'></i>");var f=$("#appointment-events").getCheckedData();if(f.length>0){var g="";for(var e=0;e<f.length;e++){if(e==f.length-1){g+=f[e].ITEM_NAME}else{g+=f[e].ITEM_NAME+"；"}}$(this).find(".box-appointment-events").text(g).attr("title",g)}else{$(this).find(".box-appointment-events").text("")}var d=$(this).data("patientInfoData").START_TIME+"-"+$(this).data("patientInfoData").END_TIME;$(this).find(".box-patient-name").text(d).attr("title",d);if($("#cure-type").getCheckedData()[0].id=="1"){$(this).find(".box-patient-type").hide()}else{$(this).find(".box-patient-type").text("复").show()}}});$(".min-template-div").find("#min-appt-float-box").off("mouseenter").off("mouseleave").on({mouseenter:function(){$(this).find(".pull").show("fast")},mouseleave:function(){$(this).find(".pull").hide("fast")}});$(".min-template-div").find("#min-appt-float-box #pull-move").off("mousedown").on({mousedown:function(j){var j=j||event;j.preventDefault();var i=$(this).parent();i.css({opacity:0.5,"z-index":99998});var l=false;var g=$(".min-table-doctor").find("td:first-child").outerWidth();var f=$(".min-table-doctor").find("td:first-child").outerHeight();var m=0;var h=0;var k=$(".min-table-time").find("tr").length;var d=JSON.parse(i.attr("y")).length;$(document).on("mousemove",function(o){l=true;var o=o||event;var n=$(".min-template-div").offset().top;m=o.clientY-n+$(window).scrollTop();h=parseInt((m-f/2)/f);if(h<0){h=0}else{if(h>k-d){h=k-d}}m=h*f;i.css({width:g-6,top:m+3,left:3});$(".min-template-div").find("#min-appt-float-box .box-patient-name").text($(".min-table-time").find("tr").eq(h).attr("start_time")+"-"+$(".min-table-time").find("tr").eq(h+d-1).attr("end_time"))});$(document).on("mouseup",function(){$(document).off("mousemove");$(document).off("mouseup");i.css({opacity:1});if(l){for(var e=0;e<c.minAppointmentData.length;e++){if(i.attr("record_id")==c.minAppointmentData[e].RECORD_ID){c.apptInfoData.startTime=c.activeAppointmentData.START_TIME=c.minAppointmentData[e].START_TIME=$(".min-table-time").find("tr").eq(h).attr("start_time");c.apptInfoData.endTime=c.activeAppointmentData.END_TIME=c.minAppointmentData[e].END_TIME=$(".min-table-time").find("tr").eq(h+d-1).attr("end_time")}}c.posAppointmentDiv()}})}});$(".min-template-div").find("#pull-down").off("mousedown").on("mousedown",function(l){var l=l||event;l.preventDefault();var m=false;var k=$(this).parent();k.css({opacity:0.5});var h=l.clientY+$(".min-appt-box").scrollTop();var i=$(".min-table-doctor").find("td:first-child").outerHeight();var g=$(k).outerHeight();var n=Math.round((k.offset().top-k.parent().offset().top)/i)*i;var o=$(".min-table-doctor").find("tr").length;var f=0;var j=0;var d=0;$(document).on("mousemove",function(r){var r=r||event;m=true;var q=r.clientY+$(".min-appt-box").scrollTop();var s=q-h;var p=g+Math.round(s/i)*i;if(p<i){p=i-4}if((p+n)>o*i){p=o*i-n-3}k.height(p-2);f=k.offset().top-k.parent().offset().top;j=Math.round(f/i);d=Math.round((k.outerHeight()+4)/i);$(".min-template-div").find("#min-appt-float-box .box-patient-name").text($(".min-table-time").find("tr").eq(j).attr("start_time")+"-"+$(".min-table-time").find("tr").eq(j+d-1).attr("end_time"))});$(document).on("mouseup",function(q){var q=q||event;$(document).off("mousemove");$(document).off("mouseup");k.css({opacity:1});if(m){for(var p=0;p<c.minAppointmentData.length;p++){if(k.attr("record_id")==c.minAppointmentData[p].RECORD_ID){c.apptInfoData.startTime=c.activeAppointmentData.START_TIME=c.minAppointmentData[p].START_TIME=$(".min-table-time").find("tr").eq(j).attr("start_time");c.apptInfoData.endTime=c.activeAppointmentData.END_TIME=c.minAppointmentData[p].END_TIME=$(".min-table-time").find("tr").eq(j+d-1).attr("end_time")}}c.posAppointmentDiv()}})});$(".min-template-div").find("#pull-up").off("mousedown").on("mousedown",function(l){var l=l||event;l.preventDefault();var m=false;var k=$(this).parent();k.css({opacity:0.5});var h=l.clientY+$(".min-appt-box").scrollTop();var i=$(".min-table-doctor").find("td:first-child").outerHeight();var g=$(k).outerHeight();var n=k.offset().top-k.parent().offset().top;var f=0;var j=0;var d=0;$(document).on("mousemove",function(r){var r=r||event;m=true;var q=r.clientY+$(".min-appt-box").scrollTop();var t=q-h;var s=Math.round(t/i)*i;var o=Math.round((n+s)/i)*i;var p=g-s;if(p<i){p=i-4}if(o<0){o=0}else{if(o>(n+g-i)){o=n+g-i;k.height(p-2)}else{k.height(p-2)}}k.css({top:o+3});f=k.offset().top-k.parent().offset().top;j=Math.round(f/i);d=Math.round((k.outerHeight()+4)/i);$(".min-template-div").find("#min-appt-float-box .box-patient-name").text($(".min-table-time").find("tr").eq(j).attr("start_time")+"-"+$(".min-table-time").find("tr").eq(j+d-1).attr("end_time"))});$(document).on("mouseup",function(p){var p=p||event;$(document).off("mousemove");$(document).off("mouseup");k.css({opacity:1});if(m){for(var o=0;o<c.minAppointmentData.length;o++){if(k.attr("record_id")==c.minAppointmentData[o].RECORD_ID){c.apptInfoData.startTime=c.activeAppointmentData.START_TIME=c.minAppointmentData[o].START_TIME=$(".min-table-time").find("tr").eq(j).attr("start_time");c.apptInfoData.endTime=c.activeAppointmentData.END_TIME=c.minAppointmentData[o].END_TIME=$(".min-table-time").find("tr").eq(j+d-1).attr("end_time")}}c.posAppointmentDiv()}})});$(".new-appointment-window").find(".new-appt-save").off("click").on("click",function(){c.saveAppointmentData={};var o=$(".content-left").ableToFinish();c.saveAppointmentData.scheduleId="";if(!o){return}if($(".new-appt-save").hasClass("already-click")){return}$(".new-appt-save").addClass("already-click");if($(".min-table-doctor").find(".no-schedule").length>0){$.paWarn("该班次无排班,无法预约！",null);c.removeAlreadyClass();return}var l=JSON.parse($(".min-template-div").find("#min-appt-float-box").attr("y"));var q=$(".min-table-time").find("tr").eq(l[0].charCodeAt()-97).attr("start_time");var f=$(".min-table-time").find("tr").eq(l[l.length-1].charCodeAt()-97).attr("end_time");if(c.newOrEditFlag==2){c.saveAppointmentData.recordId=c.activeRecordId}else{if(c.newOrEditFlag==1){c.saveAppointmentData.recordId=""}}c.saveAppointmentData.visitInfo={visitName:$("#patient-name").val(),visitMobile:$("#patient-phone").val(),visitGender:$("#patient-sex").getCheckedData()[0].id};var r=new Date();r=r.getTime();var u=$("#appointment-date").val();var E=u+" "+q+":00";E=Date.parse(new Date(E.replace(/-/,"/")));if(E<r){$.paWarn("无法预约过去的时间！",null);c.removeAlreadyClass();return}var z=$.trim($("#new-remark").val());var B=new RegExp("[`~!@#$^&*=|{}'',\\.<>/?~！@#￥……&*（）&mdash;—|{}【】‘”“']");var e="";for(var A=0;A<z.length;A++){e=e+z.substr(A,1).replace(B,"")}c.saveAppointmentData.apptInfo={apptType:$("#cure-type").getCheckedData()[0].id,apptRemark:e,apptDate:u,startTime:q,endTime:f};if(c.scheduleDoctorModel==2){c.saveAppointmentData.apptInfo.doctorId=$("#doctor-name").attr("val")=="no"?"":$("#doctor-name").attr("val")}else{if(c.scheduleDoctorModel==1){c.saveAppointmentData.apptInfo.departmentId=$("#doctor-name").attr("val")=="no"?"":$("#doctor-name").attr("val")}}var k=$("#times-order").attr("val");if($("#doctor-name").attr("val")!="no"){for(var n=0;n<c.timesData.length;n++){if(k==c.timesData[n].SCHEDULE_SET_ID){var h=c.timesData[n].schedules;for(var m=0;m<h.length;m++){if(u==h[m].scheduleDateStr){c.saveAppointmentData.scheduleId=h[m].scheduleId}}}}}var g=$("#doctor-name").attr("val");var C=true;var t=$("#min-appt-float-box").data("patientInfoData");var d=l[0].charCodeAt()-97;var v=l[l.length-1].charCodeAt()-97;for(var s=d;s<=v;s++){if(parseInt($(".min-table-doctor").find("td").eq(s).attr("source_num"))>parseInt($(".min-table-time").find("td").attr("interval_limit"))){C=false;break}}if(!C){$.paWarn("该预约存在号源已满时段，无法预约！",null);c.removeAlreadyClass();return}var D=$("#appointment-events").getCheckedData();c.saveAppointmentData.items=[];for(var w=0;w<D.length;w++){c.saveAppointmentData.items.push({itemId:D[w].ITEM_ID,itemName:D[w].ITEM_NAME})}if(c.apptInfoData.empiId){c.saveAppointmentData.visitInfo.empiId=c.apptInfoData.empiId}if(c.apptInfoData.consultId){c.saveAppointmentData.consultationId=c.apptInfoData.consultId}if(c.apptInfoData.treatmentPlanItemId){c.saveAppointmentData.treatmentPlanItemId=c.apptInfoData.treatmentPlanItemId}if(c.empiId){c.saveAppointmentData.visitInfo.empiId=c.empiId}if(c.newOrEditFlag==1){c.requestIntervalInfo(c.saveAppointmentData,"new")}else{if(c.newOrEditFlag==2){if(c.APPT_FLAG==1){c.removeAlreadyClass();$(".cancel-appt-window-p").find("#write-reason-p").val("");$(".cancel-appt-window-p").show()}else{c.requestIntervalInfo(c.saveAppointmentData,"edit")}}}})},renderApptWindowDom:function(){var c=this;if(c.newOrEditFlag==1){$(".new-appointment-window .title").text("新增预约");$("#patient-name").prop("disabled",false).val("");$("#patient-sex").cancelDisabledAll().checkedItem([{id:1}]);$("#patient-phone").prop("disabled",false).val("");$("#cure-type").checkedItem([{id:1}]);$("#appointment-events").cancelCheckedAll();$("#new-remark").val("");if(c.apptInfoData.empiId){c.getPatientInfoByEmpiId(c.apptInfoData.empiId)}if(c.apptInfoData.phoneNumber){$("#patient-phone").val(c.apptInfoData.phoneNumber)}}else{if(c.newOrEditFlag==2){$(".new-appointment-window .title").text("修改预约");$("#patient-name").prop("disabled",true).val(c.apptInfoData.patientName);$("#patient-sex").checkedItem([{id:c.apptInfoData.patientSex}]).disabledAll();$("#patient-phone").prop("disabled",true).val(c.apptInfoData.phoneNumber);$("#new-remark").val(c.apptInfoData.apptRemark);$("#cure-type").checkedItem([{id:c.apptInfoData.apptType}]).disabledAll();if(c.apptInfoData.disableDoctorDrop){if(!$("#doctor-name").parent().hasClass("no_select")){$("#doctor-name").parent().addClass("no_select")}}else{$("#doctor-name").parent().removeClass("no_select")}}}},removeAlreadyClass:function(){$(".new-appt-save").removeClass("already-click")},getPatientInfoByEmpiId:function(g){var c=this;var f={EMPI_ID:g};var d={type:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"clinicAppt/getPatientInfoByEmpiId",data:JSON.stringify(f),dataType:"json",async:true};var e=Utils.myAjaxHandler(d);e.done(function(h){if(h.errorCode==SUCCESSCODE){if(h.data){$("#patient-name").val(h.data.PATIENT_NAME).prop("disabled",true);$("#patient-sex").checkedItem([{id:h.data.PATIENT_GENDER}]).disabledAll();if(!h.data.MOBILE_PHONE_NUMBER){$("#patient-phone").val("").prop("disabled",false)}else{$("#patient-phone").val(h.data.MOBILE_PHONE_NUMBER).prop("disabled",true)}if(c.newOrEditFlag==1){$("#cure-type").checkedItem([{id:2}]);if($(document).find("#min-appt-float-box").length>0){$(document).find("#min-appt-float-box .box-patient-type").text("复").show()}}}}else{$.paWarn(h.errorMessage,null)}}).fail(function(h){$.paError("请求异常",null)}).always(function(){})},requestApptEventsByDoctorOrDept:function(){var c=this;var e="";var h=$.trim($("#doctor-name").attr("val"));if(!h){h=c.apptInfoData.doctorOrDepartId}if(h=="no"){h=""}var g={docIdOrDeptId:h};var d={type:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"apptItem/getApptItemInfoByDocIdOrDeptId",data:JSON.stringify(g),dataType:"json",async:true};var f=Utils.myAjaxHandler(d);f.done(function(i){if(i.errorCode==SUCCESSCODE){e=i.data;c.renderApptEventsByDoctorOrDept(e)}else{$.paError(i.errorMessage)}}).fail(function(i){$.paError("请求异常",null)}).always(function(){})},requestCanScheduleDoctor:function(){var c=this;var g={};var e="";var d={type:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"apptSchedule/getClinicDocsOrDepts",data:JSON.stringify(g),dataType:"json"};var f=Utils.myAjaxHandler(d);f.done(function(h){if(h.errorCode==SUCCESSCODE){e=h.data;if(e.length==0){c.scheduleDoctorModel=2;c.doctorOrDepartment="DOCTOR_ID";e.push({FEMPLOYEEID:"no",FEMPLOYEENAME:"未分配医生",SCHEDULES:"all"});$(".doctorOrDepart").text("预约医生:")}else{if(e[0].SHOW_TYPE=="doc"){c.scheduleDoctorModel=2;c.doctorOrDepartment="DOCTOR_ID";e.push({FEMPLOYEEID:"no",FEMPLOYEENAME:"未分配医生",SCHEDULES:"all"});$(".doctorOrDepart").text("预约医生:")}else{if(e[0].SHOW_TYPE=="dept"){c.scheduleDoctorModel=1;c.doctorOrDepartment="DEPARTMENT_ID";e.push({FEMPLOYEEID:"no",FEMPLOYEENAME:"未分配科室",SCHEDULES:"all"});$(".doctorOrDepart").text("预约科室:")}}}c.doctorData=e}else{$.paWarn(h.errorMessage)}}).fail(function(h){$.paError("请求异常")}).always(function(){})},getMinutesByTime:function(d){var c=d.split(":");return parseInt(c[0])*60+parseInt(c[1])},requestTimesOrderData:function(){var d=this;var f="";var c=$("#appointment-date").val();if(!$.trim(c)||d.firstNewAppt){c=d.apptInfoData.apptDate}var i=$.trim($("#doctor-name").attr("val"));if(!i){i=d.apptInfoData.doctorOrDepartId}if(i=="no"){i=""}var h={startDateTime:c,endDateTime:c,doctorOrDeptId:i};var e={type:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"apptScheduleExtend/getApptScheduleInfo",data:JSON.stringify(h),dataType:"json",async:true,showMask:true};var g=Utils.myAjaxHandler(e);g.done(function(j){if(j.errorCode==SUCCESSCODE){d.MIN_APPT_DAY=j.data.MIN_APPT_DAY;d.MAX_APPT_DAY=j.data.MAX_APPT_DAY;d.timeInterval=d.getMinutesByTime(j.data.SCHEDULE_SETS[0].INTERVAL_TIME[0].END_TIME)-d.getMinutesByTime(j.data.SCHEDULE_SETS[0].INTERVAL_TIME[0].START_TIME);f=j.data.SCHEDULE_SETS;if(!f||f.length==0){$.paWarn("诊所未排班,请先设置排班信息！",null);return}d.timesData=f;d.renderTimesOrderDrop(f);if(d.firstNewAppt){d.initDateDom()}}else{$.paError(j.errorMessage)}}).fail(function(j){$.paError("请求异常",null)}).always(function(){})},requestAppointmentData:function(){var e=this;var g="";var d=$("#appointment-date").val();if(!$.trim(d)||e.firstNewAppt){d=e.apptInfoData.apptDate}var h="";var c="0_1_2";var j={apptDate:d,apptStatus:c,departmentId:h};var f={type:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"apptScheduleExtend/getApptRegsByDate",data:JSON.stringify(j),dataType:"json",async:true,showMask:true};var i=Utils.myAjaxHandler(f);i.done(function(k){if(k.errorCode==SUCCESSCODE){g=k.data;if(g==null||g==undefined||g==""){g=[]}e.appointmentData=g;if(!e.firstNewAppt){e.renderAppointmentDiv(g)}}else{$.paError(k.errorMessage)}}).fail(function(k){$.paError("请求异常",null)}).always(function(){})},saveToSql:function(e){var c=this;var d={type:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"clinicAppt/add_appointment",data:JSON.stringify(e),dataType:"json",async:true,showMask:true};var f=Utils.myAjaxHandler(d);f.done(function(g){if(g.errorCode==SUCCESSCODE){requestData=g.data;$.paSuccess("预约成功",null);$(".bg-screen").hide();if(c.callback){c.callback()}}else{$.paError(g.errorMessage)}c.removeAlreadyClass()}).fail(function(g){$.paError("请求异常",null);c.removeAlreadyClass()}).always(function(){})},requestIntervalInfo:function(f,c){var d=this;var f=f;if($("#doctor-name").attr("val")=="no"){f.intervalInfo=[];if(c=="new"){d.saveToSql(f)}else{if(c=="edit"){d.updateToSql(f)}}}else{var h={startTime:f.apptInfo.startTime,endTime:f.apptInfo.endTime,scheduleId:f.scheduleId};var e={type:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"apptScheduleExtend/getIntervalIdByTimes",data:JSON.stringify(h),dataType:"json",async:true,showMask:true};var g=Utils.myAjaxHandler(e);g.done(function(i){if(i.errorCode==SUCCESSCODE){f.intervalInfo=i.data;if(c=="new"){d.saveToSql(f)}else{if(c=="edit"){d.updateToSql(f)}}}else{$.paError(i.errorMessage)}}).fail(function(i){$.paError("请求异常",null)}).always(function(){})}},updateToSql:function(e){var c=this;var d={type:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"clinicAppt/edit_appointment",data:JSON.stringify(e),dataType:"json",async:true,showMask:true};var f=Utils.myAjaxHandler(d);f.done(function(g){if(g.errorCode==SUCCESSCODE){requestData=g.data;$.paSuccess("修改成功",null);$(".bg-screen").hide();$(".cancel-appt-window-p").hide();if(c.callback){c.callback()}}else{$.paError(g.errorMessage)}c.removeAlreadyClass()}).fail(function(g){$.paError("请求异常",null);c.removeAlreadyClass()}).always(function(){})},rel:function(e,c){for(var f=0;f<e.length;f++){for(var d=0;d<c.length;d++){if(e[f]==c[d]){return true}}}return false},getMost:function(d){function j(e){var k=[];for(var g=0;g<e.length;g++){var f=e[g];if($.inArray(f,k)==-1){k.push(f)}}return k}var c=j(d);var n=[];n.length=c.length;for(var l=0;l<n.length;l++){n[l]=0}for(var i=0;i<c.length;i++){for(var m=0;m<d.length;m++){if(c[i]==d[m]){n[i]++}}}var h=0;for(var o=0;o<n.length;o++){if(n[o]>h){h=n[o]}}return h},pickArr:function(d){var g=this;function c(o,p){var m=o;var k=p;for(var n=m.length-1;n>=0;n--){a=m[n];for(var l=k.length-1;l>=0;l--){b=k[l];if(a==b){m.splice(n,1);k.splice(l,1);break}}}return m}var j=[];var i=d;function f(n){var m=[];var o=[];for(var l=0;l<n.length;l++){var k=JSON.parse($(".min-template-div").find("div[record_id="+n[l]+"]").attr("y"));if(!g.rel(o,k)){$.merge(o,k);m.push(n[l])}}j.push(JSON.stringify(m));i=c(i,m);if(i.length>0){f(i)}}f(i);var h=[];h.length=j.length;for(var e=0;e<j.length;e++){h[e]=JSON.parse(j[e])}return h},unique:function(c){var f=[];for(var e=0;e<c.length;e++){var d=c[e];if($.inArray(d,f)==-1){f.push(d)}}return f},getArrKind:function(g){var k=this;var i=[];var j=[];var l=j.length;var f=function(){l=j.length;for(var d=0;d<g.length;d++){if(k.rel(j,g[d])){$.merge(j,g[d])}}j=k.unique(j);if(j.length>l){f()}else{i.push(j)}};for(var h=0;h<g.length;h++){j=k.unique(g[h]);f()}for(var e=0;e<i.length;e++){i[e].sort();i[e]=JSON.stringify(i[e])}i=k.unique(i);for(var c=0;c<i.length;c++){i[c]=JSON.parse(i[c])}return i}};var apptWindow=null;function newAppt(d,c){ApptWindow.prototype.apptInfoData={apptItems:[]};ApptWindow.prototype.newOrEditFlag=1;ApptWindow.prototype.APPT_FLAG=0;ApptWindow.prototype.activeRecordId="new-appt-data";ApptWindow.prototype.apptInfoData=$.extend({},ApptWindow.prototype.apptInfoData,d);if(c){ApptWindow.prototype.callback=c}else{ApptWindow.prototype.callback=null}apptWindow=new ApptWindow()}function editAppt(c,d){ApptWindow.prototype.apptInfoData={apptItems:[]};ApptWindow.prototype.newOrEditFlag=2;if(c){getPatientInfoByRecordId(c)}if(d){ApptWindow.prototype.callback=d}else{ApptWindow.prototype.callback=null}}function getPatientInfoByRecordId(d){if(d){var f={RECORD_ID:d};var c={type:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"clinicAppt/getPatientInfoByRecordId",data:JSON.stringify(f),dataType:"json",async:true,showMask:true};var e=Utils.myAjaxHandler(c);e.done(function(j){if(j.errorCode==SUCCESSCODE){ApptWindow.prototype.APPT_FLAG=j.data.APPT_FLAG;ApptWindow.prototype.activeRecordId=d;var k={apptDate:j.data.APPT_DATE,recordId:j.data.RECORD_ID,empiId:j.data.EMPI_ID,apptType:j.data.APPT_TYPE,startTime:j.data.START_TIME,endTime:j.data.END_TIME,apptItems:[],apptRemark:j.data.APPT_REMARK,apptFlag:j.data.APPT_FLAG,patientSex:j.data.PATIENT_GENDER,patientName:j.data.PATIENT_NAME,phoneNumber:j.data.MOBILE_PHONE_NUMBER};if(j.data.DOCTOR_ID!=null&&j.data.DOCTOR_ID!="null"){k.doctorOrDepartId=j.data.DOCTOR_ID;k.doctorOrDepartName=j.data.DOCTOR_NAME}if(j.data.DEPARTMENT_ID!=null&&j.data.DEPARTMENT_ID!="null"){k.doctorOrDepartId=j.data.DEPARTMENT_ID;k.doctorOrDepartName=j.data.DEPARTMENT_NAME}if(j.data.SCHEDULE_SET_ID!=null&&j.data.SCHEDULE_SET_ID!="null"){k.scheduleSetId=j.data.SCHEDULE_SET_ID}var g=[];for(var h=0;h<j.data.APPT_ITEMS.length;h++){g.push({ITEM_ID:j.data.APPT_ITEMS[h].ITEM_ID})}k.apptItems=g;ApptWindow.prototype.apptInfoData=$.extend({},ApptWindow.prototype.apptInfoData,k);if(j.data.PAY_STATUS==1){ApptWindow.prototype.apptInfoData.disableDoctorDrop=true}else{ApptWindow.prototype.apptInfoData.disableDoctorDrop=false}apptWindow=new ApptWindow()}else{$.paWarn(j.errorMessage)}}).fail(function(g){$.paError("请求异常")}).always(function(){})}};