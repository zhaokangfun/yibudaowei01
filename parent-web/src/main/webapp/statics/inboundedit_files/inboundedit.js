var arr_vender;$(function(){inDateStart=Utils.getQueryString("inDateStart");inDateEnd=Utils.getQueryString("inDateEnd");inTypeValue=Utils.getQueryString("inType");keyWord=Utils.getQueryString("keyWord");currentPage=Utils.getQueryString("currentPage");renderFlag=Utils.getQueryString("renderFlag");saveFlag=Utils.getQueryString("saveFlag");currentPage=(currentPage==null?1:currentPage);plat=Utils.getQueryString("plat");var b=[];initClassify();inboundAdd.isValidityRequired();$("#invoiceNum").on("keyup",function(){inboundEdit.getTotalPrice()});$("#select_medicines ").on("click",function(h){drugIndex.searchDrug();$(".popretrieval").show()});$(".close ").on("click",function(h){$(".popretrieval").hide()});$("#inboundSearchKey").on("keyup",function(h){if(h.which==13){drugIndex.searchDrug()}});$("#bill-source").on("click",function(){if(plat!=PLAT_CCM){var h=$(this).attr("bill-source");var i=$(this).attr("in-type");inBoundChainOperate.showLayer(h,"clinic",i)}});var a=Utils.timeStampToDateStr(new Date(),7);$("#inDate").val(a);$("#inType").WJZSDropdown(inTypeEnum,null,function(h,i){tempInbound.saveTempInbound(null,tempInbound.oprationFlag_modifyMain)});var d={columns:[{display:"名称",dataKey:"DRUG_NAME",width:220},{display:"规格",dataKey:"DRUG_PACKAGE_SPEC",width:90},{display:"零售价",dataKey:"DRUG_RETAIL_PRICE",width:55},{display:"单位",dataKey:"DRUG_STORE_UNIT_NAME",width:40},{display:"生产厂商",dataKey:"DRUG_MANUFACTOR_NAME",width:180},{display:"产地",dataKey:"PRODUCTION_PLACE",width:150}],extraParams:{key:"searchText",limit:20,},ajaxOptions:{method:"POST"},selectFirst:true,formatResult:function(h){return""},formatMatch:function(k,j,h){return k.DRUG_CODE+"--"+k.DRUG_COMMON_NAME},matchContains:"word",autoFill:false,width:930,multiple:false,multipleSeparator:", ",highlight:function(i,h){return i.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+h.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:180};var c=ContextClinc_Server+"drugAPI/inbound/drugDicts";$("#add-coloum").autocomplete(c,d).result(function(i,n,o){var r=[];$(this).parent("tr").find("td").each(function(v,w){r.push($(this).text())});var t=$(this).parent("tr");var m={drugId:n.DRUG_ID,drugName:n.DRUG_NAME,drugCode:n.DRUG_CODE,drugPackageSpec:n.DRUG_PACKAGE_SPEC,drugStoreUnitName:n.DRUG_STORE_UNIT_NAME,drugStoreUnitId:n.DRUG_STORE_UNIT_ID,drugRetailPrice:n.DRUG_RETAIL_PRICE,drugPurchasePrice:n.DRUG_PURCHASE_PRICE,drugUnitName:n.DRUG_DISPENSE_UNIT_NAME,drugDispenseUnitRate:n.DRUG_DISPENSE_UNIT_RATE,drugStoreUnitRate:n.DRUG_STORE_UNIT_RATE,drugRetailPrice:n.DRUG_RETAIL_PRICE,manufactorName:n.DRUG_MANUFACTOR_NAME,drugTypeCode:n.DRUG_TYPE_CODE,productionPlace:n.PRODUCTION_PLACE,drugSplit:n.DRUG_SPLIT};var s=false;var k=$(".drugValidate");for(var q=0;q<k.length;q++){var l=$(k[q]).find('td[data-name="drugCode"]').text();var u=$(k[q]).find('td[data-name="drugPackageSpec"]').text();if(l==m.drugCode){s=true;break}}if(s){$.paWarn("药品重复！");return}var h=inboundAdd.addInboundInfo(m);var p=drugIndex.getManufactor();var j={idKey:"VENDOR_ID",txtKey:"VENDOR_NAME",isNeedThink:true};h.find("input[name='manufactor']").WJZSDropdown(p,j,function(v,w){});h.find("input").on("blur",function(){tempInbound.saveTempInbound($(this).parent().parent(),tempInbound.oprationFlag_modifyDeail)});$(".common-table tr:last").before(h);$("#add-coloum").val("");$("#inboundeditvalidate").ketchup();$(".samll-table-box").hide();$(".inbound-table").paKeyHandle({necessary:true,clz:"enterNext"});tempInbound.saveTempInbound(h,tempInbound.oprationFlag_newLine)});var g={columns:[{display:"编码",dataKey:"VENDOR_CODE",width:100},{display:"名称",dataKey:"VENDOR_NAME",width:150},],extraParams:{key:"searchText",},ajaxOptions:{method:"POST"},selectFirst:true,formatResult:function(h){return h.VENDOR_NAME},formatMatch:function(k,j,h){return k.VENDOR_CODE+k.VENDOR_NAME+k.PY_CODE},matchContains:"word",autoFill:false,width:300,multiple:false,multipleSeparator:", ",highlight:function(i,h){return i.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+h.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:100};arr_vender=drugIndex.getVendor();$("#vendor").autocomplete(arr_vender,g).result(function(h,j,i){$("#vendorId").text(j.VENDOR_ID);tempInbound.saveTempInbound(null,tempInbound.oprationFlag_modifyMain)});$("td i").on("click",function(h){$(this).hasClass("active")?$(this).removeClass("active"):$(this).addClass("active")});$("#search_list th i").on("click",function(){var h=$(this).hasClass("active");if(h){$(this).removeClass("active");$("#search_list tr").each(function(){$(this).find("td i").removeClass("active")})}else{$(this).addClass("active");$("#search_list tr").each(function(){$(this).find("td i").addClass("active")})}});$(document).on("click","#retrival-btn",function(){var l=[];var m=$("#projecttable tr");m.each(function(){var i=$(this).attr("data-drug-id");if(i){l.push(i)}});$("#search_list tr.select").each(function(){var s=[];var q=0;if($(this).find("i").hasClass("active")){var t=$(this);var v=t.find('td[data-name="drugName"]').attr("data-id");var u=$.inArray(v,l);if(u>=0){l.splice(u,1)}else{var p={drugId:t.find('td[data-name="drugName"]').attr("data-id"),drugCode:t.find('td[data-name="drugCode"]').text(),drugName:t.find('td[data-name="drugName"]').text(),drugPackageSpec:t.find('td[data-name="drugPackageSpec"]').text(),drugStoreUnitName:t.find('td[data-name="drugStoreUnitName"]').text(),drugStoreUnitId:t.find('td[data-name="drugStoreUnitName"]').attr("data-id"),drugRetailPrice:t.find('td[data-name="drugRetailPrice"]').text(),drugPurchasePrice:t.find('td[data-name="drugPurchasePrice"]').text(),drugUnitName:t.find('td[data-name="drugUnitName"]').text(),};var i=inboundAdd.addInboundInfo(p);var r=drugIndex.getManufactor();var o={idKey:"VENDOR_ID",txtKey:"VENDOR_NAME"};i.find("input[name='manufactor']").WJZSDropdown(r,o,function(w,x){});$(".common-table tr:last").before(i)}}});if(l.length>0){for(var k=0;k<l.length;k++){var n=$("#"+l[k]);if(n){var j=n.attr("in_price");j=isNaN(j)?0:j;var h=$("#totalPrice").val();h=accSub(h,j);if(!isNaN(h)){$("#totalPrice").val(showFormatPrice(parseFloat(h).toFixed(6)))}n.remove()}}}$("#inboundeditvalidate").ketchup();$(".popretrieval").hide()});function f(h){var i=true;$("#projecttable tr").each(function(j){if(j>0&&$(this).attr("value")==h){i=false}});return i}$(document).on("click",".delete",function(){var i=$(this).parents("tr");if(i.attr("data-id")){var j={delFlag:1,inboundItemId:$(this).parents("tr").attr("data-id")};inboundEdit.delList.push(j)}var l=$.trim(i.find("input[name='inQty']").val());var m=$.trim(i.find("input[name='drugInPrice']").val());if(l!=""&&m!=""){var k=accMul(l,m);var h=$("#totalPrice").val();h=accSub(h,k);$("#totalPrice").val(showFormatPrice(fixByRound(h,6)))}tempInbound.deleteTempInboundItem($(i).find("input[name='inQty']").attr("data-id"));$(this).parents("tr").remove()});$(".dropicon").on("click",function(h){$(this).parents(".clname").find(".dropL").show()});$(".dropL li").on("click",function(h){var j=$(this).text();var i=$(this).attr("value");$(this).parents(".clname").find("input").val(j);$(this).parents(".clname").find("input").attr("val",i);$(this).parents(".dropL").hide("");drugIndex.searchDrug()});$(".indate_list").datetimepicker({lang:"ch",format:"Y-m-d",maxDate:new Date().Format("yyyy-MM-dd"),timepicker:false,mask:false,onShow:function(){}});var e=Utils.getQueryString("id");if(e){$(".bl-title").find("h2").text("修改入库");$("#exportExeclInbound").attr("inboundId",e);inboundEdit.getInboundInfo(e)}$("#inboundeditvalidate").ketchup();$("#inboundeditvalidate .btn-cancel").on("click",function(){location.href="inboundlist.html?inDateStart="+inDateStart+"&inDateEnd="+inDateEnd+"&inType="+inTypeValue+"&keyWord="+keyWord+"&currentPage="+currentPage});$("#btn_vendor_add").on("click",function(){showAddVendorPanel();$("#inboundeditvalidate").hide()});$("#btn_add").on("click",function(){location.href="inboundMdcDictDrugAdd.html?inTypeValue="+inTypeValue+"&keyWord="+keyWord});$("#vendor_info_cancel").click(function(){$("#add_edit_div").hide();$("#inboundeditvalidate").show()});$("#invoiceNum").on("blur",function(){tempInbound.saveTempInbound(null,tempInbound.oprationFlag_modifyMain)});$("#remark").on("blur",function(){tempInbound.saveTempInbound(null,tempInbound.oprationFlag_modifyMain)});tempInbound.renderTempInbound(config_cache.getCache("tempInboundData"),renderFlag);tempInbound.renderExportBtn(saveFlag)});var currentSelectedTr;function getDrugInfo(){return currentSelectedTr}function initClassify(){var c={content:""};var a={method:"GET",type:"POST",url:ContextClinc_Server+"mdcDictDrug/drugtypes",data:{paramTxt:JSON.stringify(c)},dataType:"json"};var b=Utils.myAjaxHandler(a);b.done(function(f){if("成功"==f.errorMessage){var d={idKey:"drugTypeId",txtKey:"drugTypeName",isNeedAll:true,isNeedClear:false};var e=f.data;$("#classifyType").WJZSDropdown(e,d,function(g,h){drugIndex.searchDrug()})}else{$.paError(f.errorMessage,null)}}).fail(function(d){$.paError("请求异常",null)}).always(function(){})}var delList=[];function showAddVendorPanel(){$("#add_edit_div").removeErrorMsg();$("#vendorType").val("供应商");$("#vendorName").val($("#vendor").val());$("#inboundeditvalidate").hide();$("#add_edit_div").show();productTypeDrop();getNation();getProvince();getCity("");$("#add_edit_div").ketchup()}function addVendorAtInventory(){var a=$("#add_edit_div").ableToFinish();if(!a){return}var d={vendorTypeId:"332905D165298287E053CA3214AC3CB0",vendorId:$("#vendorId").val(),pVendorId:$("#pVendorId").val(),vendorCode:$("#vendorCode").val(),vendorName:$("#vendorName").val(),vendorShort:$("#vendorShort").val(),productTypeId:localStorage.getItem($("#productType").val()),vendorLicense:$("#vendorLicense").val(),wbCode:$("#wbCode").val(),pyCode:$("#pyCode").val(),nationId:localStorage.getItem($("#nation").val()+"_nation_id"),provinceId:localStorage.getItem($("#province").val()+"_province_id"),cityId:localStorage.getItem($("#city").val()+"_city_id"),detailAddr:$("#detailAddr").val(),permitNO:$("#permitNO").val(),registerNO:$("#registerNO").val()};var b={method:"POST",url:maindata_url.getUrl().mdcVendor_saveVendorInfo,data:d,dataType:"json",showMask:true};var c=Utils.myAjaxHandler(b);c.done(function(h){var f=h.errorMessage;var g=h.errorCode;if(g!="E0000000"){$.paAlert(f);return}$.paAlert("保存成功！");$("#add_edit_div").hide();$("#inboundeditvalidate").show();$("#vendor").val($("#vendorName").val());var e={VENDOR_NAME:$("#vendorName").val(),VENDOR_CODE:$("#vendorCode").val()};arr_vender.push(e);$("#add_edit_div input[type='text']").each(function(){$(this).val("")})}).fail(function(e){}).always(function(){})};