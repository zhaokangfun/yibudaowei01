var userInfo=JSON.parse(localStorage.getItem("medical_user_data"));var imageServerPath="";var hasInvoice="";var chargeRecord=Class.create({clickMemberCardListMoreBtn:function(){$(".operate-a").on("click",function(){$(".operate-list").not($(this).next()).hide();$(this).next().toggle()});$("body").on("click",function(){$(".operate-list").hide()});$(".operate-td").on("click",function(a){a.stopPropagation()})},showChargeInfo:function(){chargeRecord.hasInvoice();var a=$("#start_date_time").val();var c=$("#end_date_time").val();if(a!=null&&c!=null&&a>c){$.paWarn("开始日期不能大于结束日期！");$("#end_date_time").val($("#start_date_time").val());return}var e={beginChargeDate:(a==""?"":a+"T00:00:00.000+0800"),endChargeDate:(c==""?"":c+"T23:59:59.000+0800"),employeeID:Utils.trimObj($("#cashier").attr("val")),empiID:$("#patient_key").val(),paymentTypeID:$.trim($("#payment_type").attr("val")),payType:$.trim($("#T21").attr("val")),refundStatus:$("#receipt_type").attr("val"),dataSource:$("#data_source").attr("val"),pageSize:10,dataKey:"pageRecord"};var d=e;d.ajaxopts={showMask:true,url:chargeUrl.queryChargeRecord,};d.callback=function(h){$("#charge_table").empty();if(h.errorCode==SUCCESSCODE){var g=h.data.pageRecord;var f=g.dataSource.length;var i=g.dataSource;$.each(i,function(j){$("#charge_table").append(chargeRecord.filledDataTemplate(i[j]))});if(h.data.totalRecord.RECORDTOTAL!=0){$("#charge_table").append(chargeRecord.filledTotalTemplate(h.data.totalRecord))}}else{$.paError("查询收费记录失败，"+h.errorMessage)}renderPermissionControl();chargeRecord.clickMemberCardListMoreBtn();if($(".tipso-back-pay").length==0){$(".tips-floating .tips-list ul li").first().hide()}else{$(".tips-floating .tips-list ul li").first().show()}if($(".operate-a").length==0){$(".tips-floating .tips-list ul li").eq(1).hide()}else{$(".tips-floating .tips-list ul li").eq(1).show()}$(".tipso-back-pay").tipso({content:"如需退费，点击退费，退费原因必填",useTitle:false,});$(".operate-a").tipso({content:"点击更多，可以看到收费详情、修改支付方式、打印收费清单，补打发票",useTitle:false,});$(".tipso-charge-man").tipso({content:"选择收费员，查看对应收费员收费记录，不勾选则会默认所有",useTitle:false,});$(".tips-floating .tips-list ul li").first().click(function(){$(".tipso-back-pay").first().tipso("show",{delay:300,"continue":2000})});$(".tips-floating .tips-list ul li").eq(1).click(function(){$(".operate-a").first().tipso("show",{delay:300,"continue":2000})});$(".tips-floating .tips-list ul li").eq(2).click(function(){$(".tipso-charge-man").tipso("show",{delay:300,"continue":2000})})};var b=$("#my-page").generatePagination(d)},hasInvoice:function(){var a={url:ContextClinc_Server+"charge/hasInvoice",contentType:"application/json; charset=utf-8",method:"POST",type:"POST",dataType:"json",showMask:true};var b=Utils.myAjaxHandler(a);b.done(function(c){if(c!=null&&c.errorCode==SUCCESSCODE&&c.data!=""){hasInvoice=c.data}if($(".tipso-back-pay").length==0){$(".tips-floating .tips-list ul li").first().hide()}else{$(".tips-floating .tips-list ul li").first().show()}if($(".operate-a").length==0){$(".tips-floating .tips-list ul li").eq(1).hide()}else{$(".tips-floating .tips-list ul li").eq(1).show()}}).fail(function(c){})},fmoneys:function(a){if(null==a||0==a){return"--"}else{return a}},filledDataTemplate:function(f){var g=session_cache.getCache("IS_USE_YZT");var a=session_cache.getCache("IS_YB_CLINIC");var c="";var b="";c+="<tr title='查看详情'>";c+="<td width='8%'>"+f.empiName+"</td>";c+="<td width='7%'>"+f.CHARGE_FLAG_NAME+"</td>";c+="<td width='7%'>"+this.fmoneys(f.feeTotalMoney)+"</td>";c+="<td width='7%'>"+this.fmoneys(f.payMoney)+"</td>";if("1"==a){c+="<td width='7%'>"+this.fmoneys(f.ybTotalMoney)+"</td>";c+="<td width='5%'>"+this.fmoneys(f.paymentTypeName)+"</td>"}c+="<td width='7%'>"+this.fmoneys(f.refundMoney)+"</td>";c+="<td width='7%'>"+this.fmoneys(f.oweMoney)+"</td>";b=f.payTypeName||"";c+="<td width='7%' class='pay-type' >"+b+"</td>";if("1"==g){b=f.payStateName||"--";c+="<td width='6%'>"+b+"</td>"}c+="<td width='6%'>"+Utils.trimObj(f.employeeName)+"</td>";c+="<td width='8%'>"+parseDate2String(f.chargeDate,"yyyy/MM/dd HH:mm:ss")+"</td>";c+="<td width='5%'>"+f.checkoutStatusName+"</td>";c+="<td width='5%'>"+f.dataSource_+"</td>";c+="<td width='8%' class='operate-td'>";c+="<a class='dynamic_modify_confirm dsn' onclick='javascript:modifyData(event,"+JSON.stringify(f)+")' >确认</a> ";var e=9!=f.payType?true:(9==f.payType&&f.payOrderId==null)?true:false;if(!e){var d=f.onLinePayModel==0?"支付":"退款";if(f.onLinePayModel==0){c+="<a href='javascript:void(0);' onclick='showQRCode("+JSON.stringify(f)+")' >"+d+"</a>"}else{c+="<a href='javascript:void(0);' onclick='refundYZT("+JSON.stringify(f)+")' >"+d+"</a>"}}if(e){if(f.refundStatus==chargeConstant.allRefundStatus||f.entityType==2){c+="<a  class='disabled tipso-back-pay' href='javascript:void(0);'  >退费</a>"}else{c+="<a  class='tipso-back-pay' href='javascript:RefundShow("+(JSON.stringify(f)).replace(/'/g,"&apos;")+")'  >退费</a>"}}c+="<a href='javascript:void(0);' class='table-a operate-a ' id='operateA'>更多</a>";c+="<div class='operate-list'><ul>";c+="<li class='dynamic_details' onclick='showChargeDetail("+(JSON.stringify(f)).replace(/'/g,"&apos;")+")'>详情</li>";if(!f.payTypeName||f.payKind==2||f.checkoutStatus==chargeConstant.doneCheckoutStatus||f.EMPLOYEE_ID!=userInfo.id||f.payType==chargeConstant.chargeMember||f.payType==chargeConstant.chargeHealth||f.refundStatus==chargeConstant.allRefundStatus||(f.payStateName!="待支付"&&f.payType==chargeConstant.chargeYZT)){c+="<li class='dynamic_modify disabled' style='color: #a4a4a4;'>修改</li> "}else{c+="<li class='dynamic_modify' onclick='javascript:modifyData(event,"+JSON.stringify(f)+")' >修改</li> "}c+="<li class='printTypeClass' >打印</li>";if(f.payType==chargeConstant.chargeHealth){c+="<li class='upLoadImgClass' >上传</li>"}if(hasInvoice){c+="<li href='javascript:void(0);' onclick='chargeRecord.printInvoiceSupple("+JSON.stringify({chargeDate:parseDate2String(f.chargeDate,"yyyy-MM-dd"),payType:f.payTypeName||"",departmentName:f.departmentName,paymentTypeName:f.paymentTypeName||"",invoiceTag:hasInvoice,chargeNo:Utils.trimObj(f.chargeNo),chargeId:f.chargeId})+")'>补打发票</li>"}c+="</td></tr>";var b=$(c);b.find(".printTypeClass").on("click",function(){chargeRecord.printType({chargeId:f.chargeId,flag:0,paymentTypeId:f.paymentTypeId,bizNo:f.bizNo})});b.find(".upLoadImgClass").on("click",function(){chargeRecord.upLoadImg({chargeId:f.chargeId,empiId:f.empiId})});b.data("chargeInfo",f);return b},printInvoiceSupple:function(b){var d=b;$("#printInvoiceSupple").show();var a={url:ContextClinc_Server+"charge/getMaxInvoiceNo",contentType:"application/json; charset=utf-8",method:"POST",type:"POST",dataType:"json",showMask:true};var c=Utils.myAjaxHandler(a);c.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){b=e.data;$("#invoice_confirm").val(b.INVOICE_NO);$("#invoice_no_pre").val(b.INVOICE_NO_PRE);$("#printInvoiceSupple").show()}}).fail(function(e){$.paError("未能获取发票号！")});$("#printerInvoice").off().on("click",function(){$("#printInvoiceSupple").hide();var e=$("#invoice_no_pre").val();var f=$("#invoice_confirm").val();if(f){d.invoiceNoPre=e;d.invoiceNo=f;d.invoicePrint_sup=true;InvoicePrintModel.printInvoice(d)}else{$.paError("请输入发票号！")}})},filledTotalTemplate:function(d){var c="";var b="";var a=session_cache.getCache("IS_YB_CLINIC");c+="<tr>";c+="<td ></td>";c+="<td ><b>合计:</b></td>";c+="<td  style='color:#f35708'>"+fmoney(d.FEETOTALMONEY)+"</td>";c+="<td  style='color:#f35708' >"+fmoney(d.PAYMONEY)+"</td>";if("1"==a){c+="<td  style='color:#f35708'>"+fmoney(d.YBTOTALMONEY)+"</td>";c+="<td ></td>"}c+="<td  style='color:#f35708' >"+fmoney(d.REFUNDMONEY)+"</td>";c+="<td  style='color:#f35708' >"+fmoney(d.OWEMONEY)+"</td>";c+="<td ></td>";c+="</tr>";return c},printType:function(a){getYBData(function(c){var b=c.clinicInfo||null;if(!b||(b&&b.miOpenFlag==1)||(a.paymentTypeId!=5&&a.paymentTypeId!=9&&a.paymentTypeId!=10&&a.paymentTypeId!="yb0004")){chargeRecord.popUpPrintTypeDialog(a,false)}else{chargeRecord.popUpPrintTypeDialog(a,true)}})},getChargeAndPrintParam:function(){var a=self.userInfo.clinicParams.filter(function(b,c){if(b.parameterCode=="5006"){return b}});return a.length==1&&a[0]["parameterValue"]=="2"?true:false},popUpPrintTypeDialog:function(a,b){PrintTypeModel.init(a,b)},printXMChargeList:function(a){window.open("./yb/xiamen/print.html?chargeId="+a.chargeId+"&bizNo="+a.bizNo+"&source=1");return},printChargeList:function(d){var b=this;var f={chargeId:d.chargeId};var c={type:"POST",contentType:"application/json; charset=utf-8",url:chargeUrl.queryPrintChargeList,data:JSON.stringify(f),dataType:"json",async:true,showMask:true};var e=Utils.myAjaxHandler(c);e.error(function(){$.paError("请求未响应，请检查网络连接！")});var a=e.done(function(h){if(h.errorCode=="E0000000"){var g=charge_model.buildHtmlPrintData(h.data);g.chargeInfo.chargeDate=Utils.timeStampToDateStr(g.chargeInfo.chargeDate,9);charge_model.printModel(h.data,g,null,function(){var i=config_cache.getCache("curChargePrint");if(!i){managePrint.showChoosePrintDiag(function(){b.printChargeList(d)});return}})}else{$.paError("获取打印数据发生错误！"+h.errorMessage)}})},uploadImageLst:[],imageTotalSize:0,uploader:null,bindImgEvent:function(){$(".uploadimgbox").find("img").off("dblclick").on("dblclick",function(){var a=$(this).attr("src");window.open(a)})},upLoadImg:function(b){var a=this;a.judgeImg(b.chargeId);a.uploadImageLst=[];$("#dialog").reveal({posFixed:false});$("#dialog").removeErrorMsg();a.uploadMyFiles("path",b);$("#storage").val("");a.imageTotalSize=0;a.bindImgEvent()},judgeImg:function(a){var c={chargeId:a};var b={url:ContextClinc_Server+"charge/queryInvoiceImages",dataType:"json",type:"POST",data:JSON.stringify(c),contentType:"application/json;charset=utf-8"};var d=Utils.myAjaxHandler(b);d.done(function(e){if(e.errorCode==SUCCESSCODE){if(e.data!=null&&e.data!=undefined&&e.data.length!=0){$(".uploadimgbox").show();imageServerPath=e.data[0].imageServerPath;$(".uploadimgbox").find("img").attr("src",e.data[0].imageServerPath+e.data[0].imageRelativePath);$(".label").text("已有图片：")}else{$(".uploadimgbox").hide();$(".label").text("上传图片：")}}else{$.paWarn(e.errorMessage)}}).fail(function(e){$.paError("请求异常!")}).always(function(){})},uploadMyFiles:function(b,c){var a=this;$(".save").off("click").on("click",function(){if(!$("#dialog").ableToFinish()){return false}if(!$("#storage").val()){$("#dialog .close-reveal-modal").click();return false}Utils.addLoadingMaskTo("#dialog","影像数据正在保存中，请稍等...");var e={url:chargeUrl.saveInvoiceImages,dataType:"json",type:"POST",data:JSON.stringify(a.uploadImageLst),contentType:"application/json;charset=utf-8"};var f=Utils.myAjaxHandler(e);f.done(function(g){if(g!=null&&g.errorCode==SUCCESSCODE){$.paSuccess("保存图片成功",1000);$("#dialog .close-reveal-modal").click();var h=parseInt($("#img_type").attr("val"));$("#choose li").each(function(i,j){if(i===h){$(j).click()}})}else{$.paError("保存图片失败："+g.errorMessage,1000)}a.uploadImageLst=[]}).fail(function(g){$.paError("保存图片失败",1000)}).always(function(){Utils.removeLoadingMaskFrom("#dialog")})});var d=ContextClinc_Server+"publicUploadImg/testFormUpload";d+="?cookie_pawj_medical_user_id="+Utils.getCookie("cookie_pawj_medical_user_id")+"&sysType=B";if(a.uploader!=null){a.uploader.destroy();a.uploader=null}a.uploader=new plupload.Uploader({runtimes:"html5,html4,flash,silverlight",browse_button:b,container:document.getElementById("upd-box"),url:d,multi_selection:false,filters:{max_file_size:"10mb",mime_types:[{title:"Image files",extensions:"bmp,jpg,jpeg,jpe,gif,tif,tiff,png"}]},resize:{crop:true,quality:80,preserve_headers:false},init:{PostInit:function(){},FilesAdded:function(e,f){Utils.addLoadingMaskTo("#dialog","影像数据正在上传中，请稍等...");var h=$("#storage");var g=f[0].name;h.val(((h==="")?"":h.val()+"\n")+g);$(".label").text("已有图片：");a.uploader.start();$(".uploadimgbox").find("img").attr("src","");$(".uploadimgbox").show()},UploadProgress:function(e,f){},FileUploaded:function(e,h,f){if(f&&f.response){var i=$.parseJSON(f.response)}a.uploadImageLst.push({empiId:c.empiId,chargeId:c.chargeId,imageSource:1,imageOriginalFilename:h.name,imageSuffix:h.name.lastIndexOf(".")===-1?"":h.name.substring(h.name.lastIndexOf(".")+1),imageRelativePath:i.imgurl,});Utils.removeLoadingMaskFrom();if(imageServerPath==""||imageServerPath==null){var g={url:ContextClinc_Server+"charge/queryImageServerPath",dataType:"json",type:"POST",contentType:"application/json;charset=utf-8"};var j=Utils.myAjaxHandler(g);j.done(function(k){if(k.errorCode==SUCCESSCODE){imageServerPath=k.data;$(".uploadimgbox").find("img").attr("src",imageServerPath+i.imgurl)}else{$.paWarn(k.errorMessage)}}).fail(function(k){$.paError("请求异常!")}).always(function(){})}else{$(".uploadimgbox").find("img").attr("src",imageServerPath+i.imgurl)}}}});a.uploader.init()}});