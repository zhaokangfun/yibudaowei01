var setIntervalGetPayStates=null;var payStatesCircle=false;var intervalSecond=5000;var intervalTotalSecond=180000;var intervalCurrentSecond=0;$(function(){initDrop();$("#w_code_show_window .close").off("click").on("click",function(){ChargeRecordItem.closeRePayQRCode()});$("#confirm_btn").on("click",function(){validatePassword()});$(".validate_pop").on("keyup",function(a){if(a.which==13){validatePassword()}});$("#cancel_btn").on("click",function(){$(".validate_pop").hide()});$("#isCounteract").click(function(){var a=0;var b=parseFloat($("#totalOweMoney").text());if($("#isCounteract").hasClass("checked")){$("#isCounteract").removeClass("checked");$("#refund_table_id tr").each(function(){if($(this).find("td:eq(0)").hasClass("checked")){a=accAdd(a,parseFloat($(this).find("td:eq(0)").attr("money")))}});$("#refund_money_id").text(fmoney(a.toFixed(2),2))}else{$("#isCounteract").addClass("checked");$("#refund_table_id tr").each(function(){if($(this).find("td:eq(0)").hasClass("checked")){a=accAdd(a,parseFloat($(this).find("td:eq(0)").attr("money")))}});if(b>a){$("#refund_money_id").text("0.00")}else{$("#refund_money_id").text(fmoney((accSub(a,b)).toFixed(2),2))}}});$("#checkAll").on("click",function(){var d=session_cache.getCache("refundChargeInfo");var g=d.payType;if(chargeConstant.chargeHealth==g){$("#refund_btn_id").addClass("disabled");$(".warm-tip").text("温馨提示：该笔支付方式，不支持退费！");return}$(this).toggleClass("checked");if($(this).hasClass("checked")){$("#refund_btn_id").removeClass("disabled");$("#refund_table_id td:not(.disabled) i").parent().addClass("checked");if(d.payKind==2){var c=session_cache.getCache("chargeParamterData");if(c!=null&&c["5015"]=="2"){var b=session_cache.getCache("cg_record_item_data").rsList;$.each(b,function(h,j){if(j.sendState=="1"){$.paWarn("存在已发药项目，请先退药");$("#refund_btn_id").addClass("disabled");return false}})}}$("#small_money_id").text(fmoney(d.smallMoney,2));$("#accounting_value_id").text(-d.accountingMoney)}else{$("#refund_btn_id").addClass("disabled");$("#refund_table_id td:not(.disabled) i").parent().removeClass("checked");$("#refund_money_id").text("0.00");$("#small_money_id").text("0.00");$("#accounting_value_id").text("0.00")}var a=$("#refund_table_id td.disabled");var f=$("#refund_table_id td.checked");if(a&&a.length>0&&(!f||f.length<1)){$("#refund_btn_id").addClass("disabled")}calcRefundMoney()});$("#refund_table_id").on("click","td i",function(){if(!$(this).parent().hasClass("disabled")){$("#refund_btn_id").removeClass("disabled");var h=$(this).parent().attr("value");var d=$(this).parent().attr("recipeid");var a=$(this).parent().attr("chargeitemid");var i=session_cache.getCache("refundChargeInfo");var b=$(this).parent().attr("accountingmoney");var g=i.payKind;var f=$("#discount_value_id").text();var c=i.payType;if(chargeConstant.chargeHealth==c){$("#refund_btn_id").addClass("disabled");$(".warm-tip").text("温馨提示：该笔支付方式，不支持退费！")}else{if($("#refund_btn_id").data("ybFlag")==true){$(".warm-tip").text("温馨提示：该笔收费使用医保支付，不支持单项退费！");$(".refund-table").find(".checkbox").click()}else{if(c=="7"||(i.payType2nd|"")=="7"){$(".warm-tip").text("温馨提示：该笔收费使用会员支付方式，不支持单项退费！");$(".refund-table").find(".checkbox").click()}else{if(chargeConstant.chargeYZT==c){$(".warm-tip").text("温馨提示：该笔收费使用聚合支付，不支持单项退费！");$(".refund-table").find(".checkbox").click()}else{if(chargeConstant.chargeWeixin==c&&i.realPayOrderId){$(".warm-tip").text("温馨提示：该笔收费使用微信在线支付，不支持单项退费！");$(".refund-table").find(".checkbox").click()}else{if(b&&b!="0"){$(".warm-tip").text("温馨提示：该笔收费使用记账支付，不支持单项退费！");$(".refund-table").find(".checkbox").click()}else{if(f==""||f=="null"){$(this).parent().toggleClass("checked");if($(this).parent().attr("acographytype")=="5"){var j=this;$("#refund_table_id td i").each(function(l){if(h!="no"&&$(this).parent().attr("value")==h){if($(j).parent().hasClass("checked")){if(this!=j){$(this).parent().addClass("checked")}}else{if(this!=j){$(this).parent().removeClass("checked")}}}})}calcRefundMoney()}else{$(".warm-tip").text("温馨提示：该笔收费存在优惠金额，不支持单项退费！");$(".refund-table").find(".checkbox").click()}}}}}}}}})});function initDrop(){var f=$("#refundPayType");var c=session_cache.getCache("recordPayData");var b=filterPayTypeData(c.T21);var d=[{dictItemCode:"",dictItemName:"默认"}];d=d.concat(b);var a={isNeedClear:false,isNeedAll:false,idKey:"dictItemCode",txtKey:"dictItemName"};f.WJZSDropdown(d,a,function(g,h){})}function chooseAllItem(){$("#refund_table_id td i").parent().toggleClass("checked");$("#refund_money_id").text("0.00");if($(this).parent().hasClass("checked")){var a=$("#total_money_id").text();$("#refund_money_id").text(fmoney(a,2))}}var targetEvent;function validatePassword(){var c={userName:$("#user_id").val(),userPassword:$("#password_id").val()};var a={url:chargeUrl.validatePassword,dataType:"json",type:"POST",data:JSON.stringify(c),contentType:"application/json;charset=utf-8",async:true,showMask:true};var b=Utils.myAjaxHandler(a);b.done(function(g){if(g!=null&&g.errorCode==SUCCESSCODE){var d=g.data;if(d){$(".validate_pop").hide();var f=session_cache.getCache("refundChargeInfo");if(targetEvent==null){showRefundInfo(f)}else{doModifyData(targetEvent,f)}}else{$("#tip_id").text("授权码错误！")}return true}else{$.paError("保存退费信息ajax返回错误:"+g.errorCode+":"+g.errorMessage);return false}}).fail(function(d){$.paError("请求未响应，请检查网络连接！");return false}).always(function(){})}function checkOutRefundRule(b){var a=session_cache.getCache("chargeParamterData");if(targetEvent==null){if(a!=null&&a["5003"]=="2"){return true}}else{if(a!=null&&a["5004"]=="2"){return true}}if(b.checkoutStatus==chargeConstant.doneCheckoutStatus){$("#user_id").val("");$("#password_id").val("");$("#tip_id").text("");$(".validate_pop").show();Utils.renderPopup($(".validate_pop"));$("#password_id").focus();return false}else{return true}}function checkOutModifyRule(b){var a=JSON.parse(localStorage.getItem("medical_user_data"));if(b.checkoutStatus==chargeConstant.doneCheckoutStatus){$.paWarn("已结账数据无法修改支付方式！");return false}else{if(b.EMPLOYEE_ID!=a.id){$.paWarn("只能本收费员修改支付方式！");return false}else{return true}}}function calcPatientAge(g){var d="";if(g&&g!=""){var f=new Date(g.replace(/-/g,"/"));var b=new Date();if(f<=b){var a=(b.getTime()-f.getTime())/(1000*60*60*24*30);var c=Math.floor(a/12);d=c}else{d=""}}return d}function showChargeDetail(b){clearShowRefundData(b);$("#charge_table_id").empty();if(b.empiName!=null){$("#basicInfo").show();$("#patientName").text(b.empiName);$("#patientSex").text(b.patientGender);$("#patientAge").text(calcPatientAge(b.empiBirth)+"岁")}else{$("#basicInfo").hide()}if(b.empiPhone!=null){$("#mobilePhone").show();$("#patientPhone").text(b.empiPhone)}else{$("#mobilePhone").hide()}$("#recId").text(b.chargeNo==null?"----":b.chargeNo);$("#paymentType").text(b.paymentTypeName);var a="";if(b.payTypeName1st!=null){a=b.payTypeName1st+"￥"+(fmoney(b.payMoney1st)||"0.00")+"    ";if(b.payTypeName2nd!=null){a+=b.payTypeName2nd+"￥"+(fmoney(b.payMoney2nd)||"0.00")+"    "}}if(b.ybTotalMoney>0){a+="医保￥"+(fmoney(b.ybTotalMoney)||"0.00")}$("#payType").text(a);$("#discountFee").text("￥"+(fmoney(b.discountMoney)||"0.00"));$("#remark").text(b.REMARK==null?"":b.REMARK);ChargeRecordItem.showChargeRecordItem(b,".charge-pop",function(f){var d=f;f=d.rsList;if(f[0].doctorName!=null){$("#doctorInfo").show();$("#doctorDept").text(f[0].departmentName||"");$("#doctorName").text(f[0].doctorName)}else{$("#doctorInfo").hide()}var c=ChargeRecordItem.buildChargeItemDetail(f);if(!$("#charge_table_id tr:last")){$("#charge_table_id tr:last").after(c)}else{$("#charge_table_id").append(c)}});$(".charge-pop").show();Utils.renderPopup($(".charge-pop"))}function RefundShow(c){session_cache.setCache("refundChargeInfo",c);clearShowRefundData(c);targetEvent=null;if(c.empiName!=null){$("#basicInfo_").show();$("#patientName_").text(c.empiName);$("#patientSex_").text(c.patientGender);$("#patientAge_").text(calcPatientAge(c.empiBirth)+"岁")}else{$("#basicInfo_").hide()}if(c.empiPhone!=null){$("#mobilePhone_").show();$("#patientPhone_").text(c.empiPhone)}else{$("#mobilePhone_").hide()}$("#recId_").text(c.chargeNo==null?"----":c.chargeNo);$("#paymentType_").text(c.paymentTypeName);var a="";if(c.payTypeName1st!=null){a=c.payTypeName1st+"￥"+(fmoney(c.payMoney1st)||"0.00")+"    ";if(c.payTypeName2nd!=null){a+=c.payTypeName2nd+"￥"+(fmoney(c.payMoney2nd)||"0.00")+"    "}}if(c.ybTotalMoney>0){a+="医保￥"+(fmoney(c.ybTotalMoney)||"0.00")}$("#payType_").text(a);$("#discountFee_").text("￥"+(fmoney(c.discountMoney)||"0.00"));$("#remark_").text(c.REMARK==null?"":c.REMARK);var d=chargeBizUtil.classifyPaymentType(c);var f=$("#refund_btn_id");if(d==3){f.data("ybFlag",true)}f.data("ybType",c.interfaceCode);if(!checkOutRefundRule(c)){return}var b=false;if(c.payType=="7"||(c.payType2nd&&c.payType2nd=="7")){b=true}if(c.payType!="9"&&d!=3&&c.payType!="8"&&!b&&!c.realPayOrderId){$("#isCounteract").addClass("checked");$("#isCounteract").parent().css("display","none");$("#refundPayType").parent().parent().css("display","");$("#refundPayType").val("默认");$("#refundPayType").attr("val","");$("#totalOweMoney").parent().css("display","")}else{$("#refundPayType").parent().parent().css("display","none");$("#refundPayType").val("");$("#refundPayType").attr("val","");$("#isCounteract").removeClass("checked");$("#isCounteract").parent().css("display","none");$("#totalOweMoney").parent().css("display","none")}showRefundInfo(c)}function isInteger(a){return a%1===0}function checkIsInteger(a,b){if(a.parent().find("input").attr("disabled")=="disabled"){return true}return isInteger(b)}function reEdit(){$("#refund_table_id td input").each(function(a){$(this).parent().find("input").attr("disabled","disabled");$(this).parent().find("input").css("background","#eee")});$("#refund_table_id td[class='checked']").each(function(a){if($(this).parent().find("input").attr("isEdit")=="true"){$(this).parent().find("input").removeAttr("disabled");$(this).parent().find("input").css("background","")}})}function showRefundInfo(a){$("#refund_btn_id").addClass("disabled");$("#payment_name_id").text(a.paymentTypeName);$("#patient_name_id").text(a.empiName);$("#discount_value_id").text(a.discountValue);$("#total_money_id").text(fmoney(Utils.accSub(a.payMoney,a.refundMoney),2));$("#pay_type_1st").text(a.payTypeName1st||"");$("#pay_type_2nd").text(a.payTypeName2nd||"");$("#pay_money_1st").text(fmoney(a.payMoney1st||"",2));$("#pay_money_2nd").text(fmoney(a.payMoney2nd||"",2));$("#yb_money_id").text("0.00");$("#person_money_id").text("0.00");ChargeRecordItem.showChargeRecordItem(a,".refundpop",function(d){var c=d.rsList;if(c[0].doctorName!=null){$("#doctorInfo_").show();$("#doctorDept_").text(c[0].departmentName||"");$("#doctorName_").text(c[0].doctorName)}else{$("#doctorInfo_").hide()}$("#refund_table_id").empty();var b=ChargeRecordItem.buildchargeItemTemplate(d.rsList,a);if(!$("#refund_table_id tr:last")){$("#charge_table tr:last").after(b)}else{$("#refund_table_id").append(b)}$("#refund_table_id").find("input").off("blur").blur(function(){var f=parseFloat($(this).val());if(!f||!isInteger(f)){$.paAlert("请输入正整数");$("#refund_btn_id").addClass("disabled");return}var g=parseFloat($(this).parent().parent().find("td:first").attr("remainingamount"));if(f<0||f>g){$.paAlert("退费数量不能大于"+g);$("#refund_btn_id").addClass("disabled");return}calcRefundMoney()});if(d.oweData&&d.oweData.TOTAL_MONEY){$("#totalOweMoney").text(d.oweData.TOTAL_MONEY.toFixed(2));$("#totalOweMoney").attr("val",d.oweData.TOTAL_MONEY)}else{$("#totalOweMoney").text("0.00");$("#totalOweMoney").attr("val",0)}if(parseFloat($("#totalOweMoney").text())==0){$("#totalOweMoney").parent().hide()}else{if(a.payType!="9"&&!$("#refund_btn_id").data("ybFlag")==true&&a.payType!="8"&&!isVipRefund()){$("#totalOweMoney").parent().show()}else{$("#totalOweMoney").parent().hide()}}});$(".refund_apply").show();Utils.renderPopup($(".refundpop"))}function modifyData(b,a){session_cache.setCache("refundChargeInfo",a);targetEvent=b;e=b||window.event;var c=e.srcElement||e.target;if($(c).text()=="修改"&&!checkOutModifyRule(a)){return}doModifyData(b,a)}function showQRCode(b){if(pos&&b.realPayTypeCode){var c={order_id:b.payOrderId,tran_amt:b.payOrderMoney,qr_code:b.qrCodeBase64};if(b.realPayTypeCode==2){pos.unionPayCard(c,function(d){afterPayEnd(d)})}else{if(b.realPayTypeCode==4){c.scan_auth_tp=getPosPayType(b.realPayTypeCode);pos.qrCode(c,function(d){afterPayEnd(d)})}else{if(b.realPayTypeCode==5){c.scan_auth_tp=getPosPayType(b.realPayTypeCode);pos.qrCode(c,function(d){afterPayEnd(d)})}else{return}}}}else{var a=b.onLinePayModel==0?"(收费)":"(退费)";$("#w_code_totalMoney").text(a+"￥"+fmoney(b.payOrderMoney||0,2));$("#qrcodeImg").removeAttr("src");$("#w_code_show_window").removeAttr("style");$("#qrcodeImg").attr("src","data:image/png;base64,"+b.qrCodeBase64);$(".w_code_show_bg").removeClass("dsn");ChargeRecordItem.intervalPayGet(b,function(){closeQRCode()})}}function afterPayEnd(a){if(a.respCode){$.paSuccess("支付成功！");$("#search_btn").click()}else{var b={msg:a.respMsg,saveTxt:"确定",hideCancel:true,hideCloseBtn:true,onYes:function(){location.href="./chargeRecord.html"}};$.paConfirm(b)}}function refundYZT(a){var b={PAY_ORDER_ID:a.payOrderId,PUSH_TYPE:a.pushType,QR_CODE:a.qrCodeBase64,PAY_MONEY:a.payOrderMoney,REAL_PAY_TYPE_CODE:a.realPayTypeCode};ChargeRecordItem.onlineRefundCallBack(b,a.chargeId)}function doModifyData(a,j){e=a||window.event;var f=e.srcElement||e.target;var n=$(f).text();if(n=="修改"){var o=session_cache.getCache("recordPayData");var h=filterPayTypeData(o.T21);var b={idKey:"dictItemCode",txtKey:"dictItemName",isNeedClear:false};var m=$("#drop_template").clone();m.removeClass("dsn");var i=$(f).parent().parent().parent().siblings(".pay-type");i.empty();i.append(m);var l=i.find(".pay-type");l.addClass("validate(required)");$(f).parent().parent().ketchup();l.WJZSDropdown(h,b,function(q,r){});l.SetWJZSDropdownSelectedData(j.payType);$(f).parent().hide();$(f).parent().parent().parent().parent().siblings().find("a").hide();$(".dynamic_modify_confirm").siblings().addClass("dsn");$(".dynamic_modify_confirm").removeClass("dsn")}else{if(n=="确认"){var i=$(f).parent().siblings(".pay-type");var k=i.find("input").attr("val");if(!$(f).parent().parent().ableToFinish()){return}if(j.payType==k){$("#search_btn").click();return}if(parseInt(k)==parseInt(chargeConstant.payTypeYZT)){$.paError("不可修改为[聚合支付]");return}if(parseInt(k)==parseInt(chargeConstant.chargeHealth)){$.paError("不可修改为[基金商保]");return}if(parseInt(j.payType)==parseInt(chargeConstant.payTypeYZT)){var o=session_cache.getCache("recordPayData");var g=o.T21;var c="新的支付方式";$.each(g,function(q){if(g[q]["dictItemCode"]==k){c=g[q]["dictItemName"];return false}});var d={msg:"确认已用"+c+"收款？",cancelTxt:"取消",saveTxt:"确认",onYes:function(){j.payType_=k;var q=saveModifyData(j)},};$.paConfirm(d);return}j.payType_=k;var p=saveModifyData(j)}}}function filterPayTypeData(b){var c=[];var a=false;$.each(b,function(d){if(b[d]["dictItemCode"]!=chargeConstant.chargeMember&&b[d]["dictItemCode"]!=chargeConstant.chargeHealth&&b[d]["dictItemCode"]!=chargeConstant.payTypeYZT){c.push(b[d])}});return c}function initDropMenu(b,a){if(a==""||a==null||a==undefined){b.val("");b.attr("")}else{b.parent().find("li").each(function(c){if($(this).attr("value")==a){b.val($(this).text());b.attr("value",a);b.attr("val",a);return false}})}}function saveModifyData(c){var b;b=chargeUrl.modifyChargeRecord;var a={url:b,dataType:"json",type:"POST",data:JSON.stringify(c),contentType:"application/json;charset=utf-8",async:true,showMask:true};var d=Utils.myAjaxHandler(a);d.done(function(f){if(f!=null&&f.errorCode==SUCCESSCODE){$.paSuccess("修改成功！");$("#search_btn").click();return true}else{$.paError("保存退费信息ajax返回错误:"+f.errorCode+":"+f.errorMessage);return false}}).fail(function(f){$.paError("请求未响应，请检查网络连接！");return false}).always(function(){})}function getYBBizItemByChargeId(c,d){var a={url:ContextClinc_Server+"ybReimburse/getYBBizItemByChargeId",dataType:"json",type:"POST",data:JSON.stringify(c),contentType:"application/json;charset=utf-8",showMask:true};var b=Utils.myAjaxHandler(a);b.done(function(f){if(f!=null&&f.errorCode==SUCCESSCODE){d(f.data)}else{$.paError("获取已上传医保对照项目信息失败:",f.errorMessage)}})}function updateYBBizFeeRefundBalance(c,d){var a={url:ContextClinc_Server+"ybReimburse/updateYBBizFeeRefundBalance",dataType:"json",type:"POST",data:JSON.stringify(c),contentType:"application/json;charset=utf-8",showMask:true,async:false};var b=Utils.myAjaxHandler(a);b.done(function(f){if(f!=null&&f.errorCode==SUCCESSCODE){if(d){d(f)}}else{$.paError("保存医保的退费结算信息失败:",f.errorMessage)}})}function doRefund(){if(!$("#refund_btn_id").hasClass("disabled")){if(Utils.trimObj($("#refund_reason_id").val())==""||$("#refund_reason_id").val()==undefined){$.paWarn("请输入退费原因！");return}if($("#refund_table_id td[class='checked']")==undefined){$.paWarn("请选择退费项目！");return}var d=session_cache.getCache("refundChargeInfo");if(d.payKind==2&&!$("#refundPayType").attr("val")&&!isVipRefund()&&(!isCheckedAll()||$("#totalOweMoney").parent().css("display")!="none")){$.paWarn("请选择退费方式");return}if(isAllRefund()){if($("#refund_table_id td[class='disabled']").length>0){$.paWarn("请全部退药");return}var a=false;$("#refund_table_id td[class='checked']").each(function(){if($(this).parent().find("td:last-child").text()=="已发药"||$(this).parent().find("td:last-child").text()=="部分退药"||$(this).parent().find("td:last-child").text()=="申请退药"){a=true}});if(a){var f="";var b=session_cache.getCache("chargeParamterData");if(b!=null&&b["5015"]=="1"){if($("#refund_btn_id").data("ybFlag")==true){f="医保退费，请先操作退药";$.paWarn(f);return}}else{f="未退药，不允许退费";$.paWarn(f);return}}if(!isCheckedAll()){$.paWarn("该笔订单只支持全部退费，请全选");return}}if(!$(".cause_box").ableToFinish()){return}if($("#refund_btn_id").data("ybType")=="yb0004"){var d=session_cache.getCache("refundChargeInfo");var h=ChargeRecordItem.acquireRefundParam(d);if(!h){return}var c={ybBizRecord:{acographyId:h.pricingCharge.acographyId},bizFee:{chargeBizId:h.pricingCharge.chargeId}};getYBBizItemByChargeId(c,function(j){var i={astr_jykz_xml:{akc190:j.ybAcographyId,yka103:j.originItemNo,ka130:"0201"},astr_jysr_xml:{yka055:j.total,yka107:j.ybPayMoney,yka065:j.selfYbMoney}};h.ybItemNo=j.originItemNo;h.pricingCharge.ybType="yb0004";h.refundRecord.totalMoney=h.refundRecord.selfPayMoney;cdYbServiceInvoke.reFund(i,function(l){var o,m,k;if(l){o=l.astr_jyyzm;m=l.astr_jylsh;k=l.astr_pcbh}var n={chargeBizId:d.chargeId,ybRefundBalanceResult:JSON.stringify(l),ybRefundVerifyCode:o,ybRefundSn:m,ybRefundPcbh:k};ChargeRecordItem.saveRefundInfo(h,function(p){updateYBBizFeeRefundBalance(n,function(){cdYbServiceInvoke.tradeConfrim(m,o,function(){p()})})})})})}else{if($("#refund_btn_id").data("ybType")=="yb0003"){var d=session_cache.getCache("refundChargeInfo");var h=ChargeRecordItem.acquireRefundParam(d);if(!h){return}var c={ybBizRecord:{acographyId:h.pricingCharge.acographyId},bizFee:{chargeBizId:h.pricingCharge.chargeId}};getYBBizItemByChargeId(c,function(j){var i={serialNo:j.originItemNo,optUser:parent.$("#u-name").text(),clinicNo:j.ybAcographyId,reverseType:"0",insuranceType:"1"};h.ybItemNo=j.originItemNo;h.pricingCharge.ybType="yb0003";h.refundRecord.totalMoney=h.refundRecord.selfPayMoney;cqYbServiceInvoke.reFund(i,function(k){var l={chargeBizId:d.chargeId,ybRefundBalanceResult:JSON.stringify(k)};ChargeRecordItem.saveRefundInfo(h,function(m){updateYBBizFeeRefundBalance(l,function(){m()})})})})}else{if($("#refund_btn_id").data("ybType")=="yb0002"){var d=session_cache.getCache("refundChargeInfo");var h=ChargeRecordItem.acquireRefundParam(d);if(!h){return}var c={ybBizRecord:{acographyId:h.pricingCharge.acographyId},bizFee:{chargeBizId:h.pricingCharge.chargeId}};getYBBizItemByChargeId(c,function(j){var i={cardno:j.cardno,cxdjh0:j.originItemNo,request:"TRUE"};h.ybItemNo=j.originItemNo;h.pricingCharge.ybType="yb0002";h.refundRecord.totalMoney=h.refundRecord.selfPayMoney;xmYbServiceInvoke.mzsfcx(i,function(k){var l={chargeBizId:d.chargeId,ybRefundBalanceResult:JSON.stringify(k)};ChargeRecordItem.saveRefundInfo(h,function(m){updateYBBizFeeRefundBalance(l,function(){m()})})})})}else{if($("#refund_btn_id").data("ybType")=="yb0001"){var d=session_cache.getCache("refundChargeInfo");var g=new ybCharge(d);g.refundYBFee(d,function(i){if(i.ybBalanceResult){var j={chargeBizId:d.chargeId,ybRefundBalanceResult:i.ybBalanceResult};updateYBBizFeeRefundBalance(j)}var k=ChargeRecordItem.acquireRefundParam(i.reimburseInfo);if(!k){return}k.ybItemNo=i.ybPayData.ybItemNo;g.payYBFee(i.ybPayData,function(l){ChargeRecordItem.saveRefundInfo(k,function(m){m()})})})}else{if($("#refund_btn_id").data("ybType")=="yb0005"){var d=session_cache.getCache("refundChargeInfo");var h=ChargeRecordItem.acquireRefundParam(d);if(!h){return}var c={ybBizRecord:{acographyId:h.pricingCharge.acographyId},bizFee:{chargeBizId:h.pricingCharge.chargeId}};getYBBizItemByChargeId(c,function(j){if(null==j.ybAcographyId){$.paAlert("获取门诊流水号失败");return}if(null==j.settleSerialNo){$.paAlert("获取结算业务序列号失败");return}if(null==j.settleBizNo){$.paAlert("获取结算业务号失败");return}var i={appCode:"JY002",data:{akc190:j.ybAcographyId,ckc618:j.settleBizNo,bke384:j.settleSerialNo}};console.log("深圳新医保退费请求消息："+JSON.stringify(i));SZNEWYBOperateClasz.send_Msg(i,true,true,function(l){console.log("深圳新医保退费响应消息："+JSON.stringify(l));if(null!=l&&null!=l.transBody&&"1"==l.transBody.baz700){var k={chargeBizId:d.chargeId,ybRefundBalanceResult:JSON.stringify(l)};h.ybItemNo=j.originItemNo;h.pricingCharge.ybType="yb0005";h.refundRecord.totalMoney=h.refundRecord.selfPayMoney;ChargeRecordItem.saveRefundInfo(h,function(m){updateYBBizFeeRefundBalance(k,function(){m()})})}else{$.paError("医保接口费用退费失败,原因："+l)}},function(k){$.paError(k)})})}else{var h=ChargeRecordItem.acquireRefundParam();if(!h){return}ChargeRecordItem.saveRefundInfo(h)}}}}}}}function showYBRefundInfo(a){var b=a.reimburseInfo;$("#yb_money_id").text(fmoney((b.ybMoney||b.ybPayMoney)||0,2));$("#person_money_id").text(fmoney((b.personMoney||b.selfYbMoney)||0,2))}function calcRefundMoney(){reEdit();var b=0,a=0;var c=false;var d=session_cache.getCache("refundChargeInfo");var f=true;if(isCheckedAll()){if(isVipRefund()){b=accAdd(d.payMoney1st,d.payMoney2nd)}else{b=d.totalMoney}a=d.accountingMoney;$("#refund_table_id td[class='checked']").each(function(h){var i=handleNumber($.trim($(this).parent().find("input").val())?$.trim($(this).parent().find("input").val()):"0");var j=parseFloat($(this).attr("remainingamount"));if(!i||!checkIsInteger($(this),i)){$.paAlert("请输入正整数");f=false;return}if(i<=j){}else{$.paAlert("请输入小于"+j+"的正整数");f=false;return}})}else{$("#refund_table_id td[class='checked']").each(function(h){var m=handleNumber($(this).attr("money"));var l=handleNumber($(this).attr("amount"));var i=handleNumber($(this).attr("drugSource"));var o=handleNumber($.trim($(this).parent().find("input").val())?$.trim($(this).parent().find("input").val()):"0");var p=parseFloat($(this).attr("remainingamount"));var n=parseFloat($(this).attr("price"));if(!o||!checkIsInteger($(this),o)){$.paAlert("请输入正整数");f=false;return}if(o<=p){var j=handleNumber($(this).attr("accountingMoney"));if(d.dataSource==chargeConstant.dataSourcePE){b=accAdd(b,m)}else{if(i&&(i==1||i==3)){b=accAdd(b,0)}else{b=accAdd(b,accMul(n,o))}}a=accAdd(a,accDiv(accMul(j,o),l))}else{$.paAlert("请输入小于"+p+"的正整数");f=false;return}})}$("#accounting_value_id").text(a);b=accDiv(Math.floor(accMul(b,100)),100);if($("#isCounteract").hasClass("checked")){var g=parseFloat($("#totalOweMoney").text());if(g>b){$("#refund_money_id").text("0.00")}else{$("#refund_money_id").text(fmoney((accSub(b,g)).toFixed(2),2))}}else{$("#refund_money_id").text(fmoney(b.toFixed(2),2))}if($("#refund_table_id td[class='checked']").size()>0&&f){$("#refund_btn_id").removeClass("disabled")}else{$("#refund_btn_id").addClass("disabled")}}function fixMoneyBySet(c,b){var a;var d=session_cache.getCache("chargeParamterData");if(b==1){if(d["5001"]==2){a=fixByFive(c,b)}else{if(d["5001"]==1){a=fixByRound(c,b)}else{if(d["5001"]==3){a=fixByInteger(c)}else{if(d["5001"]==4){a=parseInt(fixByRound(c,0))}else{a=fixByRound(c,b)}}}}}else{a=fixByRound(c,b)}return a}function clearShowRefundData(a){if(a.dataSource!=chargeConstant.dataSourcePE){$("#state_id").text("发药状态")}else{if(a.dataSource==chargeConstant.dataSourcePE){$("#state_id").text("体检状态")}}$("#refund_btn_id").data("ybUploadFlag",false);$("#refund_btn_id").data("ybFlag",false);$("#refund_btn_id").text("退费");$("#refund_table_id").empty();$("#refund_money_id").text("0.00");$("#accounting_value_id").text("0.00");$("#refund_reason_id").val("");$(".checkbox").removeClass("checked");$(".warm-tip").text("温馨提示：当前退费为不可逆动作，请谨慎操作！")}function isCheckedAll(){var a=true;if($("#refund_table_id tr").size()!=$("#refund_table_id td[class='checked']").size()){a=false;return a}$("#refund_table_id td[class='checked']").each(function(b){var c=handleNumber($(this).attr("amount"));var d=handleNumber($.trim($(this).parent().find("input").val())?$.trim($(this).parent().find("input").val()):"0");if(c!=d){a=false;return}});return a}function isAllRefund(){var f=session_cache.getCache("refundChargeInfo");var d=f.accountingMoney;var b=f.payKind;var h=f.payType;var g=f.discountMoney;var a=f.payType2nd|"";var c=f.realPayOrderId;if($("#refund_btn_id").data("ybFlag")==true){return true}else{if(chargeConstant.chargeYZT==h){return true}else{if(chargeConstant.chargeWeixin==h&&c){return true}else{if(d&&d>0){return true}else{if(g&&g>0){return true}else{if(h=="7"||a=="7"){return true}}}}}}return false}function isVipRefund(){var c=session_cache.getCache("refundChargeInfo");var d=c.payType;var b=c.payType2nd|"";var a=false;if(d=="7"||b=="7"){a=true}return a}var ChargeRecordItem={showChargeRecordItem:function(d,b,f){var a={url:chargeUrl.queryChargeItemInfo,dataType:"json",type:"POST",data:JSON.stringify(d),contentType:"application/json;charset=utf-8",async:true,showMask:true};var c=Utils.myAjaxHandler(a);c.done(function(g){if(g!=null&&g.errorCode==SUCCESSCODE){session_cache.setCache("cg_record_item_data",g.data);f(g.data)}else{$.paError("查询明细数据ajax返回错误:"+g.errorCode+":"+g.errorMessage);return}}).fail(function(g){$.paError("请求未响应，请检查网络连接！");return}).always(function(){})},buildchargeItemTemplate:function(d,c){var b="";var a="";var f={};$.each(d,function(j){f=d[j];b+="<tr>";if(f.groupNum==null||f.groupNum==""){tempGroup="no"}else{tempGroup=f.recipeId+f.groupNum}var k=session_cache.getCache("chargeParamterData"),m=false;if(k!=null&&k["5015"]=="1"){m=true}var i=f.acographyMainId||"";var h=true;if(f.refundStatus==chargeConstant.allRefundStatus||(f.sendState==chargeConstant.sendedState&&!m)||(f.sendState==chargeConstant.apptBackState&&!m)||(f.itemStatus!=undefined&&f.itemStatus!=chargeConstant.peUndoStatus)||((f.refundId!==null&&f.refundId!==undefined&&f.refundId!=="")&&f.amount<0)){h=false}var l=f.remainingAmount;var k=session_cache.getCache("chargeParamterData");if(k!=null&&k["5015"]=="2"){if(f.sendState==3){if(f.saleDrugRecipeQty>0){l=accSub(f.remainingAmount,accSub(f.saleDrugRecipeQty,f.refundRecipeQty))}if(l<=0){h=false,l=""}}}if(!h){b+="<td width='55px' class='disabled' recipeid=\""+f.recipeId+'" acographymainid="'+i+'"  amount="'+f.amount+'"  drugSource="'+f.drugSource+'"  remainingAmount="'+l+'"  agentQty="'+f.agentQty+'"  acographytype="'+f.acographyType+'"  price="'+f.price+'" recorditemid="'+f.recordItemId+'"  recipeitemid = "'+f.recipeItemId+'" chargeitemid="'+f.chargeItemId+'" value="'+tempGroup+'" money="'+f.money+'" actualMoney="'+f.actualMoney+'" accountingMoney ="'+f.accountingMoney+'" type="'+f.acographyType+'" ><i ></i></td>'}else{b+="<td width='55px' recipeid=\""+f.recipeId+'" acographymainid="'+i+'"  amount="'+f.amount+'"  drugSource="'+f.drugSource+'"  remainingAmount="'+l+'"  agentQty="'+f.agentQty+'"  acographytype="'+f.acographyType+'"  price="'+f.price+'" recorditemid="'+f.recordItemId+'" recipeitemid = "'+f.recipeItemId+'" chargeitemid="'+f.chargeItemId+'" value="'+tempGroup+'" money="'+f.money+'" actualMoney="'+f.actualMoney+'" accountingMoney ="'+f.accountingMoney+'" type="'+f.acographyType+'" ><i></i></td>'}j=f.groupNum==null?"":f.groupNum;b+="<td width='30px'>"+j+"</td>";var g=(null==f.itemName?"":f.itemName);b+="<td width='100px'>"+g+"</td>";j=f.specification==null?"--":f.specification;b+="<td width='90px'>"+j+"</td>";j=f.agentQty||"--";b+="<td width='40px'>"+j+"</td>";if((f.refundId!==null&&f.refundId!==undefined&&f.refundId!=="")&&f.amount<0){b+="<td width='40px'></td>"}else{b+="<td width='40px'>"+f.amount+"</td>"}j=f.unit||"--";b+="<td width='55px'>"+j+"</td>";b+="<td width='80px'>"+fmoney(f.price)+"</td>";b+="<td width='60px'>"+fmoney(f.money)+"</td>";if(h){if(f.acographyType==5||c.payType=="9"||c.accountingMoney>0||c.dataSource==chargeConstant.dataSourcePE||isAllRefund()||!isInteger(l)){b+="<td width='60px'><input disabled='disabled' style='background: #eee;width: 90%;' class='input-text' value="+l+"></input></td>"}else{b+="<td width='60px'><input disabled='disabled' isEdit='true' style='background: #eee;width: 90%;' class='input-text' value="+l+" ></input></td>"}}else{if((f.refundId!==null&&f.refundId!==undefined&&f.refundId!=="")&&f.amount<0){b+="<td width='60px'><input disabled='disabled' style='background: #eee;width: 90%;' class='input-text' value="+Math.abs(f.amount)+"></input></td>"}else{b+="<td width='60px'><input disabled='disabled' style='background: #eee;width: 90%;' class='input-text'></input></td>"}}if(f.itemStatus==undefined){j=ChargeRecordItem.handleSendState(f.sendState)}else{j=ChargeRecordItem.handlePEState(f.itemStatus)}b+="<td>"+j+"</td>";b+="</tr>"});return b},buildChargeItemDetail:function(c){var b="";var a="";var d={};$.each(c,function(h){d=c[h];b+="<tr>";if(d.groupNum==null||d.groupNum==""){tempGroup="no"}else{tempGroup=d.recipeId+d.groupNum}var g=d.acographyMainId||"";var f=d.groupNum||"";b+="<td width='35px'>"+f+"</td>";b+="<td width='150px'>"+d.itemName+"</td>";h=d.specification==null?"--":d.specification;b+="<td width='100px'>"+h+"</td>";h=d.agentQty||"--";b+="<td width='40px'>"+h+"</td>";b+="<td width='40px'>"+d.amount+"</td>";h=d.unit||"--";b+="<td width='60px'>"+h+"</td>";b+="<td width='80px'>"+fmoney(d.price)+"</td>";b+="<td width='120px'>"+fmoney(d.money)+"</td>";if(d.itemStatus==undefined){h=ChargeRecordItem.handleSendState(d.sendState)}else{h=ChargeRecordItem.handlePEState(d.itemStatus)}b+="<td>"+h+"</td>";b+="</tr>"});return b},handleSendState:function(a){var b;switch(a){case 0:b="未发药";break;case 1:b="已发药";break;case 2:b="已退药";break;case 3:b="部分退药";break;case 6:b="申请退药";break;default:b="--"}return b},handlePEState:function(b){var a;switch(b){case 0:a="待检";break;case 1:a="完成";break;case 2:a="暂存";break;case 3:a="拒检";break;default:a="--"}return a},acquireRefundParam:function(f){var m=session_cache.getCache("refundChargeInfo");var o=[];var k=0,i=0;var p=false;if(m.dataSource!=chargeConstant.dataSourcePE){var h=true;$("#refund_table_id td[class='checked']").each(function(r){var x=parseFloat($.trim($(this).parent().find("input").val()));var w=parseFloat($(this).attr("remainingamount"));var u=parseFloat($(this).attr("price"));if(x>w){h=false}var t=handleNumber($(this).attr("money"));var s=handleNumber($(this).attr("amount"));o.push({chargeItemId:$(this).attr("chargeitemid"),recipeItemId:$(this).attr("recipeitemid"),recipeId:$(this).attr("recipeid"),refundNumber:x,agentQty:parseInt(accDiv(accMul(x,(parseInt($(this).attr("agentqty"))|0)),s)),acographyType:$(this).attr("acographytype"),acographyItemAmount:parseFloat($(this).attr("amount"))});var v=handleNumber($.trim($(this).parent().find("input").val())?$.trim($(this).parent().find("input").val()):"0");i=accAdd(i,accMul(u,v));k=accAdd(k,accMul(u,v))});if(isCheckedAll()){if(isVipRefund()){i=accAdd(m.payMoney1st,m.payMoney2nd)}else{i=m.totalMoney}k=m.feeTotalMoney}if(!h){$.paAlert("退费数量错误，请重新输入");return null}}else{if(m.dataSource==chargeConstant.dataSourcePE){$("#refund_table_id td[class='checked']").each(function(r){var w=$(this).attr("type")==9?null:$(this).attr("recorditemid");var u=parseFloat($(this).attr("price"));o.push({chargeItemId:$(this).attr("chargeitemid"),recordItemId:$(this).attr("recorditemid"),recordItemId_:w,acographyMainId:$(this).attr("acographymainid"),acographyId:m.BIZ_ID,acographyType:$(this).attr("type")});var t=handleNumber($(this).attr("money"));var s=handleNumber($(this).attr("amount"));var v=handleNumber($.trim($(this).parent().find("input").val())?$.trim($(this).parent().find("input").val()):"0");i=accAdd(i,t);k=accAdd(k,accMul(u,v))});if(isCheckedAll()){if(isVipRefund()){i=accAdd(m.payMoney1st,m.payMoney2nd)}else{i=m.totalMoney}k=m.feeTotalMoney}}else{return null}}var b=handleNumber($("#refund_money_id").text());if(m.accountingMoney>0){p=true}var d=0;var a=0;var q=0;if(f){d=(-f.zfMoney||f.selfPayMoney)||0;a=(-f.ybMoney||f.ybPayMoney||f.ybFundMoney)||0;q=(-f.personMoney||f.selfYbMoney)||0}if(i>m.totalMoney){i=m.totalMoney}i=accDiv(Math.floor(accMul(i,100)),100);var l,n;var j,c;if(isVipRefund()){l=m.payType;j=m.payType2nd;n=m.payMoney1st;c=m.payMoney2nd}else{if(m.payKind==2&&isCheckedAll()&&!$("#refundPayType").attr("val")){l=m.payType;j=m.payType2nd;n=m.payMoney1st;c=m.payMoney2nd}else{l=m.payType;n=i;j=null;c=0}}if($("#refundPayType").attr("val")){l=$("#refundPayType").attr("val")}var g={pricingCharge:m,refundRecord:{empiId:m.empiId,payType:l,payType2nd:j,payKind:1,acographyId:m.BIZ_ID,acographySerialNo:m.BIZ_NO,payMoney1st:n,payMoney2nd:c,refundMoney:b,totalMoney:i,smallMoney:0,discountMoney:m.discountMoney,refundReason:$("#refund_reason_id").val(),memberCardId:m.memberCardId,memberCardNumber:m.memberCardNumber,feeTotalMoney:k,dataSource:m.dataSource,accountingMoney:-$("#accounting_value_id").text(),selfPayMoney:d,ybFundMoney:a,selfYbMoney:q,memberOptRecordId:m.memberOptRecordId,isCounteract:$("#isCounteract").hasClass("checked")?0:1,totalOweMoney:parseFloat($("#totalOweMoney").attr("val"))},chargeList:o,accountingFlag:p,dataSource:m.dataSource};return g},saveRefundInfo:function(f,d){var a=this;var b={url:chargeUrl.saveRefundInfo,dataType:"json",type:"POST",data:JSON.stringify(f),contentType:"application/json;charset=utf-8",async:true,showMask:true};var c=Utils.myAjaxHandler(b);c.done(function(g){if(g!=null&&g.errorCode==SUCCESSCODE){ChargeRecordItem.onlineRefundCallBack(g.data,f.pricingCharge.chargeId,function(){if(d){d(function(){$(".refund_apply").hide();if(f.realPayOrderId&&f.payType==chargeConstant.chargeWeixin){$.paSuccess("退费成功，退款3个工作日内到账")}else{$.paSuccess("退费成功！")}$("#search_btn").click()})}else{$(".refund_apply").hide();if(f.realPayOrderId&&f.payType==chargeConstant.chargeWeixin){$.paSuccess("退费成功，退款3个工作日内到账")}else{$.paSuccess("退费成功！")}$("#search_btn").click()}})}else{if(g.errorCode=="E2SP0116"){$.paError(g.errorMessage,2000,function(){$(".refundpop").hide();$("#search_btn").click()})}else{$.paError(g.errorMessage)}}}).fail(function(g){$.paError("请求未响应，请检查网络连接！");return}).always(function(){})},onlineRefundCallBack:function(b,a,c){if(b&&b.REAL_PAY_TYPE_CODE==2){var b={order_id:b.PAY_ORDER_ID,push_type:b.PUSH_TYPE,qr_code:b.QR_CODE,tran_amt:b.PAY_MONEY};pos.unionPayCardRefund(b,function(i){var g;if(i.respCode==pos.payCallbackRespCodeConst.Success){g=2}else{if(i.respCode==pos.payCallbackRespCodeConst.Fail){g=4}else{$.paError(i.respMsg,2000,function(){$(".refund_apply").hide();$("#search_btn").click()});return false}}var f={pricingCharge:{chargeId:a,chargeFlag:g}};var d={url:ContextClinc_Server+"charge/updateRefundInfo",dataType:"json",type:"POST",data:JSON.stringify(f),contentType:"application/json;charset=utf-8",async:true,showMask:true};var h=Utils.myAjaxHandler(d);h.done(function(k){if(k!=null&&k.errorCode==SUCCESSCODE){var j="退款成功！";if(g==4){j=i.respMsg;$.paError(j,2000,function(){$(".refund_apply").hide();$("#search_btn").click()})}else{$.paSuccess(j,2000,function(){$(".refund_apply").hide();$("#search_btn").click()})}}else{$.paError("退款失败！",2000,function(){$(".refund_apply").hide();$("#search_btn").click()})}}).fail(function(j){$.paError("请求未响应，请检查网络连接！");return}).always(function(){})})}else{if(c){c()}}},doWithResultSuccess1:function(b,c){var a=b.qrCodeBase64;if(a!=null){$(".refund_apply").hide();$("#chargebtnid").addClass("disabled");$("#w_code_totalMoney").text("(退费)￥"+fmoney(b.totalMoney||0,2));$("#qrcodeImg").removeAttr("src");$("#w_code_show_window").removeAttr("style");$("#qrcodeImg").attr("src","data:image/png;base64,"+a);$(".w_code_show_bg").removeClass("dsn");this.intervalGet(b,c)}else{this.resultCallBack(c)}},intervalGet:function(c,b){var a=this;setIntervalGetPayStates=setInterval(function(){a.getPayStatesCircle(c,b)},intervalSecond)},getPayStatesCircle:function(h,g){var a=this;var f={payOrderId:h.payOrderId,};var b={url:ContextClinc_Server+"charge/getPayOrderStates",dataType:"json",type:"POST",data:JSON.stringify(f),contentType:"application/json;charset=utf-8",};var d=Utils.myAjaxHandler(b);d.done(function(i){if(i!=null&&i.errorCode==SUCCESSCODE&&i.data.payStatus==2){a.clearIntervalPayStates();a.resultCallBackSuccess(g)}});intervalCurrentSecond+=intervalSecond;if(intervalCurrentSecond>intervalTotalSecond){a.clearIntervalPayStates();var c={msg:"未查询到支付信息,请前往收费记录,再次支付.",saveTxt:"确定",hideCancel:true,hideCloseBtn:true,onYes:function(){a.resultCallBack(g)},onNo:function(){a.resultCallBack(g)}};$.paConfirm(c)}},clearIntervalPayStates:function(){if(setIntervalGetPayStates!=null){clearInterval(setIntervalGetPayStates)}$(".w_code_show_bg").addClass("dsn");intervalCurrentSecond=0},resultCallBackSuccess:function(a){if(a){a(function(){$(".refund_apply").hide();$.paSuccess("退费成功！");$("#search_btn").click()})}else{$(".refund_apply").hide();$.paSuccess("退费成功！");$("#search_btn").click()}},resultCallBack:function(a){if(a){a(function(){$(".refund_apply").hide();$.paSuccess("退费成功！");$("#search_btn").click()})}else{$(".refund_apply").hide();$.paSuccess("退费成功！");$("#search_btn").click()}},intervalPayGet:function(c,b){var a=this;setIntervalGetPayStates=setInterval(function(){a.getRePayStatesCircle(c,b)},intervalSecond)},getRePayStatesCircle:function(g){var a=this;var f={payOrderId:g.payOrderId,};var b={url:ContextClinc_Server+"charge/getPayOrderStates",dataType:"json",type:"POST",data:JSON.stringify(f),contentType:"application/json;charset=utf-8",};var d=Utils.myAjaxHandler(b);d.done(function(h){console.log("payStatus= "+h.data.payStatus);if(h!=null&&h.errorCode==SUCCESSCODE&&h.data.payStatus==1){a.closeRePayQRCode()}});intervalCurrentSecond+=intervalSecond;if(intervalCurrentSecond>intervalTotalSecond){a.clearIntervalPayStates();var c={msg:"未查询到支付信息,请前往收费记录,再次支付.",saveTxt:"确定",hideCancel:true,hideCloseBtn:true,onYes:function(){a.closeRePayQRCode()},onNo:function(){a.closeRePayQRCode()}};$.paConfirm(c)}},closeRePayQRCode:function(){ChargeRecordItem.clearIntervalPayStates();$(".w_code_show_bg").addClass("dsn");$("#search_btn").click()},saveRefundOnLine:function(c){var a={url:ContextClinc_Server+"charge/saveRefundOnLine",dataType:"json",type:"POST",data:JSON.stringify(c),contentType:"application/json;charset=utf-8",showMask:true};var b=Utils.myAjaxHandler(a);b.done(function(d){if(d!=null&&d.errorCode==SUCCESSCODE&&d.data.payState==1){$.paSuccess("退款成功!");$("#search_btn").click()}else{$.paError("退款失败!"+d.errorMessage);return}}).fail(function(d){$.paError("请求未响应，请检查网络连接！");return}).always(function(){})},};