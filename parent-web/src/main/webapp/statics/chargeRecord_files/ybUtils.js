var local="https://ybservice.pinganwj.com:9443/";var YBUtils=Class.create({sendMsg:function(g,e,b){var c=this;var a=local+this.getAPPNameByAreaCode(g.areaCode)+"/i/clientEntrance/dispatchClient";var d={type:"GET",url:a+"?param="+encodeURIComponent(encodeURIComponent(JSON.stringify(g))),dataType:"jsonp",jsonp:"backMsg",showMask:true};var f=Utils.myAjaxHandler(d);f.done(function(i){if(i.errorCode&&i.errorCode=="E0000000"){if(e){e(i.data.clientResult||i.data.clientRet)}}else{if(Utils.notBlank(i.data.clientError)&&i.data.clientError.indexOf("10交易调用出错")>-1){if(e){e()}}else{if(i.errorMessage&&i.errorMessage.indexOf("处方明细做废时，未找到想应信息!")>-1){i.errorMessage="该门诊号已结算，请重新挂号！"}if(b){b()}var h="医保系统提示:"+i.errorMessage;c.ErrorHintPop(h)}}}).fail(function(){if(b){b()}$.paConfirm({msg:"请求未响应，请检查医保服务网络连接！",saveTxt:"确定",hideCancel:true,onYes:function(){}})})},cdSendMsg:function(g,e,b){var c=this;if(!Utils.notBlank(g.operateType)){$.paWarn("操作类型operateType为空");return}var a=local+this.getAPPNameByAreaCode(g.areaCode)+"/i/clientEntrance/"+g.operateType;var d={type:"GET",url:a+"?param="+encodeURIComponent(encodeURIComponent(JSON.stringify(g))),dataType:"jsonp",jsonp:"backMsg",showMask:true,msgText:"医保系统处理中..."};var f=Utils.myAjaxHandler(d);f.done(function(i){if(i.errorCode&&i.errorCode=="E0000000"){if(i.data&&i.data.clientResult&&i.data.clientResult>=0){if(e){e(i.data.clientRet)}}else{if(b){b()}var h="医保系统提示:"+i.errorMessage;c.ErrorHintPop(h)}}else{if(b){b()}var h="医保系统提示:"+i.errorMessage;c.ErrorHintPop(h)}}).fail(function(){$.paConfirm({msg:"请求未响应，请检查医保服务网络连接！",saveTxt:"确定",hideCancel:true,onYes:function(){}})})},checkParameter:function(c,b){console.log("checkParameter --> param:"+JSON.stringify(c));console.log(b);var a=true;if(!c||!c.transType||!c.transVersion||!c.cardArea||!c.verifyCode||!c.serialNumber){$.paConfirm({msg:"参数错误！",saveTxt:"确定",hideCancel:true,onYes:function(){console.log("!param : "+!c);console.log("param.transType : "+c.transType);console.log("param.transVersion : "+c.transVersion);console.log("param.cardArea : "+c.cardArea);console.log("param.verifyCode : "+c.verifyCode);console.log("param.serialNumber : "+c.serialNumber)}});return false}if(!b||!b.ybClinicId||!b.ybOperatorId||!b.ybOperatorName){$.paConfirm({msg:"请配置医保基本信息！",saveTxt:"确定",hideCancel:true,onYes:function(){}});return false}return true},getSzYbNewOrgSettlementCode:function(){var c=null;var a={url:ContextClinc_Server+"miSZNew/getOrgSettlementCode",dataType:"json",type:"POST",contentType:"application/json;charset=utf-8",showMask:false,async:false,beforeSend:function(){Utils.addLoadingMaskTo("body","获取流水号...")}};var b=Utils.myAjaxHandler(a);b.done(function(d){if(d!=null&&d.errorCode==SUCCESSCODE){c=d.data.orgSettlementCode;console.log("getSzYbNewOrgSettlementCode-->orgSettlementCode:"+c)}else{$.paError("获取医药机构结算业务序列号失败:",d.errorMessage)}}).always(function(){Utils.removeLoadingMaskFrom("body")});return c},szNewSendMsg:function(d,g,e){var i=this;var h=i.getYBBaseInfo();if(!i.checkParameter(d,h)){console.log("param error!");return}var f={transTime:i.getCurrentDate("yyyyMMddHHmmss")+":000",transType:d.transType,transReturnCode:"",transReturnMessage:"",transVersion:d.transVersion,serialNumber:d.serialNumber,cardArea:d.cardArea,hospitalCode:h.ybClinicId,operatorCode:h.ybOperatorId,operatorName:h.ybOperatorName,operatorPass:"",transChannel:"10",verifyCode:d.verifyCode,extendDeviceId:"",extendUserId:"",extendSerialNumber:"",transBody:d.transBody};var c=local+this.getAPPNameByAreaCode("SZ_NEW")+"/i/clientEntrance/dispatchClient";var a="http://192.168.1.228:17001/szsi-portal/transData";var b=c+"?url="+encodeURIComponent(encodeURIComponent(a))+"&param="+encodeURIComponent(encodeURIComponent(JSON.stringify(f)));var k={type:"get",async:false,beforeSend:function(){Utils.addLoadingMaskTo(null,i.methodCodeTransFer(d.transType)||"医保处理中...")},url:b,dataType:"jsonp",jsonp:"backMsg"};var j=$.ajax(k);j.always(function(l){Utils.removeLoadingMaskFrom()}).done(function(l){if(l&&l.errorCode=="E0000000"){if(l.data&&l.data.transReturnCode=="00000000"&&l.data.transBody){console.log("szNewSendMsg --> msg:"+JSON.stringify(l));g(l.data)}else{if(l.data&&l.data.transReturnMessage){i.ErrorHintPop(l.data.transReturnMessage||"调用医保接口失败")}else{i.ErrorHintPop("调用医保接口失败")}if(e){e(l.data)}}}else{if(e){e(l.data)}i.ErrorHintPop("【前置机】调用医保接口失败")}}).error(function(l){i.ErrorHintPop(l.errorMessage||"请求未响应，请检查医保服务网络连接！")})},ErrorHintPop:function(a){var b=$('<div id="error-hintPop"><div class="error-hintBox"><div class="error-hint-text" style="word-break: break-all;">'+a+'</div><div class="foot-btn"><span class="btn normal-btn" id="error-hintBtn">确定</span></div></div></div>');b.find("#error-hintBtn").on("click",function(){$(this).parents("#error-hintPop").remove()});$(window.top.document.body).append(b)},getCurrentDate:function(a){if(Utils.notBlank(a)){return(new Date()).Format(a)}return(new Date()).Format("yyyyMMdd")},saveYBRequestParam:function(c){console.log("saveYBRequestParam-->requestParams:"+JSON.stringify(c));var b={ybItemNo:c.ybItemNo,requestParams:JSON.stringify(c),};var a={url:ContextClinc_Server+"ybReimburse/updateYBBizFee",dataType:"json",type:"POST",data:JSON.stringify(b),contentType:"application/json;charset=utf-8",showMask:true,async:false};var d=Utils.myAjaxHandler(a);d.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){console.log("保存结算参数成功")}else{console.log("保存结算参数失败")}})},getCurrentMilis:function(){return(new Date).getTime()},getCurrentMilisAndRandom:function(){return this.getCurrentMilis()+""+Math.floor((Math.random()*100)+1)},guid:function(a){return a+"xxxxxxxxxxxx".replace(/[xy]/g,function(e){var d=Math.random()*16|0,b=e=="x"?d:(d&3|8);return b.toString(16)})},getYbPageUrl:function(b){var a="";switch(b){case MI_TYPE_CODE_CONSTANTS.YB_SHENZHEN_TYPE_CODE:a="../chargeManagement/shenzhen/ybDJ.html";break;case MI_TYPE_CODE_CONSTANTS.YB_XIAMEN_TYPE_CODE:a="../chargeManagement/yb/xiamen/xm_mi_settle_page.html";break;case MI_TYPE_CODE_CONSTANTS.YB_CHONGQING_TYPE_CODE:a="../chargeManagement/yb/chongqing/cq_mi_settle_page.html";break;case MI_TYPE_CODE_CONSTANTS.YB_CHENGDU_TYPE_CODE:a="../chargeManagement/yb/chengdu/cd_mi_settle_page.html";break;case MI_TYPE_CODE_CONSTANTS.YB_NEW_SHENZHEN_TYPE_CODE:a="../chargeManagement/yb/shenzhen_new/sz_new_mi_settle_page.html";break}return a},isShenZhenYb:function(a){return MI_TYPE_CODE_CONSTANTS.YB_SHENZHEN_TYPE_CODE==a},isShenZhenNewYb:function(a){return MI_TYPE_CODE_CONSTANTS.YB_NEW_SHENZHEN_TYPE_CODE==a},isXiaMenYb:function(a){return MI_TYPE_CODE_CONSTANTS.YB_XIAMEN_TYPE_CODE==a},isChongQingYb:function(a){return MI_TYPE_CODE_CONSTANTS.YB_CHONGQING_TYPE_CODE==a},isChengDuYb:function(a){return MI_TYPE_CODE_CONSTANTS.YB_CHENGDU_TYPE_CODE==a},getYBBizStateById:function(c,d){var a={type:"POST",url:ContextClinc_Server+"ybReimburse/getYBBizStateById",data:JSON.stringify(c),dataType:"json",contentType:"application/json; charset=utf-8",async:false,showMask:true};var b=Utils.myAjaxHandler(a);b.done(function(e){if(e.errorCode=="E0000000"){d(e.data)}else{$.paError(e.errorMessage)}}).error(function(){$.paError("请求未响应，请检查网络连接！")})},addOrUpdateYbBizRecord:function(b,c){var a={type:"POST",url:ContextClinc_Server+"ybReimburse/addOrUpdateYbBizRecord",data:JSON.stringify(b),dataType:"json",contentType:"application/json; charset=utf-8",showMask:true,async:false};var d=Utils.myAjaxHandler(a);d.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){if(c){c()}}else{}}).fail(function(e){$.paError("请求异常:",e.data)})},getDiagnosisAndRecipeCount:function(b,e){var d={acographyId:b};var a={url:ContextClinc_Server+"ybReimburse/getDiagnosisAndRecipeCount",dataType:"json",type:"POST",data:d,showMask:true,async:false};var c=Utils.myAjaxHandler(a);c.done(function(f){if(f!=null&&f.errorCode==SUCCESSCODE){e(f.data)}else{$.paError("获取诊断信息和处方单数失败")}}).error(function(){$.paError("请求未响应，请检查网络连接！")})},getAPPNameByAreaCode:function(b){var a;switch(b){case MI_AREA_CODE.XIAMEN:a="pinganwj-mip-xm-web-server";break;case MI_AREA_CODE.CHONGQING:a="pinganwj-mip-cq-web-server";break;case MI_AREA_CODE.CHENGDU:a="pinganwj-mip-cd-web-server";break;case MI_AREA_CODE.YB_NEW_SHENZHEN_TYPE_CODE:a="pinganwj-mip-sz-web-server";break;default:a="pinganwj-mip-web-server"}return a},getYBBaseInfo:function(){var b=this;var a=session_cache.getCache("ybData");if(!Utils.notBlank(a)){b.getYBData(function(f){session_cache.setCache("ybData",f);a=f})}var e={ybClinicId:null,ybOperatorId:null,ybOperatorName:null};if(a&&a.clinicInfo&&a.curEmployeeInfo){var c=a.clinicInfo;var d=a.curEmployeeInfo;ybClinicId=c.orgCode;ybOperatorId=d.miEmployeeCode;ybOperatorName=d.miEmployeeName;e={ybClinicId:ybClinicId,ybOperatorId:ybOperatorId,ybOperatorName:ybOperatorName}}return e},getYBData:function(c){var a={method:"POST",url:ContextClinc_Server+"ybReimburse/getYBBaseInfoByClinicId",data:null,dataType:"json",async:true,showMask:true};var b=Utils.myAjaxHandler(a);b.done(function(d){if(d!=null&&d.errorCode==SUCCESSCODE){c(d.data);return}else{$.paError(d.errorMessage,null);return}})},getPageFeeList:function(){var b=[];parent.$(".charge-item-table .readWritItem:not(.not-item)").not(":last").each(function(){var h=$(this).attr("acographyitemid");var l=$(this).find(".input-charge-item-name").val();var i=$(this).find(".charge-item-spec").text();var j=$(this).find(".input-charge-item-total-amount").val();var g=$(this).find(".charge-item-unit").text();var k=$(this).find(".charge-item-price").text();var f=$(this).find(".charge-item-money").text();var e=$(this).find(".charge-drug-source-drop").attr("val");var d={pendItemId:null,itemId:h,itemName:l,itemSpec:i,itemUnit:g,itemPrice:k,itemAmount:j,itemMoney:f||0,drugSource:e||"0"};b.push(d)});var a=session_cache.getCache("chargeOPItems");var c=parent.$("#acographyList").getCheckedData();$.each(a,function(d){$.each(c,function(g,i){var f=a[d].sameGroupFlag;var e=i.sameGroupFlag;if(e==f){var h={pendItemId:a[d].pendItemId,itemId:a[d].acographyItemId,itemName:a[d].acographyItemName,itemSpec:a[d].acographyItemSpec,itemUnit:a[d].acographyItemUnit,itemPrice:a[d].acographyItemPrice,itemAmount:a[d].acographyItemAmount,itemMoney:a[d].totalMoney||0,drugSource:a[d].drugSource||"0"};b.push(h)}})});return b},createYbItems:function(d,a,c){var b=[];$.each(d,function(g,f){var e="clinicbm"+g;f.ybItemNo=c;f.clinicItemId=e;$.each(a,function(h,j){if(f.itemId==j.acographyItemId){f.clinicItemId=j.clinicItemCode;f.ybItemId=j.miItemCode;f.ybSettleCode=j.miItemCode;f.itemSpec=j.itemSpec!=null?j.itemSpec:f.itemSpec;f.itemUnit=j.itemUnit!=null?j.itemUnit:f.itemUnit}});b.push(f)});return b},getYBBizNo:function(a,f){var c="";var e={bizPrefix:a};var b={type:"POST",url:ContextClinc_Server+"ybReimburse/getYBBizNo",data:JSON.stringify(e),dataType:"json",contentType:"application/json; charset=utf-8",async:false,showMask:true};var d=Utils.myAjaxHandler(b);d.done(function(g){if(g.errorCode=="E0000000"){c=g.data}else{$.paError(g.errorMessage)}}).error(function(){$.paError("请求未响应，请检查网络连接！")}).always(function(){});return c},updateYBBizFeeOutpatientSettle:function(g,b,m){var j=g.ybChargeResult;var c=j.transBody;var l=g.pricingCharge.ybParams;var h=g.receMoney;var d=parseFloat(c.akb068||0);var k=parseFloat(c.akb067||0);var q=0;var n=c.outputlist;if(n!=null&&n.length>=1){for(var f=0;f<n.length;f++){if(n[f]["aaa036"]=="310200"||n[f]["aaa036"]=="310210"){q+=parseFloat(n[f]["aae019"]||0)}}}var e=d-q;var a={ybItemNo:l.inputlist[0].FEE_DOC_NO,actualPayMoney:h,ransomMoney:0,payState:1,settleBizNo:c.ckc618,settleSerialNo:j.serialNumber,selfPayMoney:k,selfYbMoney:q,ybBalanceResult:JSON.stringify(j),ybCatCharge:JSON.stringify(j),ybPayMoney:e,ybActBalance:parseFloat(c.aae240||0),ybBefeBalance:parseFloat(g.beforeBalance||0),};var p={url:ContextClinc_Server+"ybReimburse/updateYBBizFeePayMoney",dataType:"json",type:"POST",data:JSON.stringify(a),contentType:"application/json;charset=utf-8",showMask:true,async:false};var o=Utils.myAjaxHandler(p);o.done(function(i){if(i!=null&&i.errorCode==SUCCESSCODE){if(b){b(i.data)}}else{if(m){m()}}})},updateYBBizFeePayMoney:function(h,d,l){var k=h.ybChargeResult;var e=k.transBody;var i=h.payKind||"1";var o=h.paymentTypeId||"1";var j=h.receMoney||0;var g=0;if(1==i&&1==o){j=h.chargeMoney||h.CASH_PAY_MONEY||0}if(e&&h.settleTotalMoney!=parseFloat(e.akc264||0)){$.paConfirm({msg:"传给医保的总金额不等于返回回来的医疗费用总额！",saveTxt:"确定",hideCancel:true,onYes:function(){}});return}var f=parseFloat(e.akb068||0);var c=parseFloat(e.akb066||0);var a=parseFloat(e.akb067||0);var b={ybItemNo:h.ybItemNo,actualPayMoney:j,ransomMoney:g,payState:1,settleBizNo:e.ckc618,settleSerialNo:h.orgSettlementCode,selfPayMoney:a,selfYbMoney:c,ybBalanceResult:JSON.stringify(k),ybCatCharge:JSON.stringify(k),ybPayMoney:f,ybActBalance:parseFloat(e.aae240||0),ybBefeBalance:parseFloat(h.beforeBalance||0),};var n={url:ContextClinc_Server+"ybReimburse/updateYBBizFeePayMoney",dataType:"json",type:"POST",data:JSON.stringify(b),contentType:"application/json;charset=utf-8",showMask:true,async:false};var m=Utils.myAjaxHandler(n);m.done(function(p){if(p!=null&&p.errorCode==SUCCESSCODE){if(d){d(p)}}else{if(l){l()}$.paError("更新医保支付信息失败!")}})},methodCodeTransFer:function(b){var a="";switch(b){case"XX001":a="获取个人基本信息中...";break;case"FY001":a="费用（处方）明细录入中...";break;case"FY004":a="费用试算中...";break;case"FY005":a="费用结算中...";break;case"MZ002":a="门诊挂号结算中...";break;case"FY005":a="在职公务员";break;default:a="医保处理中..."}return a},});var MI_TYPE_CODE_CONSTANTS={YB_SHENZHEN_TYPE_CODE:"yb0001",YB_XIAMEN_TYPE_CODE:"yb0002",YB_CHONGQING_TYPE_CODE:"yb0003",YB_CHENGDU_TYPE_CODE:"yb0004",YB_NEW_SHENZHEN_TYPE_CODE:"yb0005",YB_NANCHANG_TYPE_CODE:"yb0006",};var GENDER_CODE={MAN:"1",WOMEN:"2"};var MI_AREA_CODE={SHENZHEN:"SZ",XIAMEN:"XM",CHONGQING:"CQ",CHENGDU:"CD",YB_NEW_SHENZHEN_TYPE_CODE:"SZ_NEW"};