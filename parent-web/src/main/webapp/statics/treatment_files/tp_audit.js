var audit_Btn={acographyId:Utils.getQueryString("acographyId"),init:function(){var a=this;if(existClinicTag("WISDOM_MI")){a.isYbRegisterAction(a.acographyId,function(b){if(!b){$(".tp_audit").remove();return}$(".tp_audit").show();$(".tp_audit").off("click").on("click",function(){if(!$(this).is(":visible")||$(this).hasClass("disabled")){return}var c=$(this).attr("type");if(c==2){var d=a.tcm.getHerbalRecipesData();if(d.code==1||d.data.length<=0){$.paWarn("尚未填写任何药品");return}a.auditRecipe(d.data)}else{if(c==3){a.assistCheck.auditRecipe()}else{if(c==4){a.treat.auditTreatProject()}else{if(c==5){a.chuzhi.auditChuzhiProject()}}}}})})}else{$(".tp_audit").remove()}},isYbRegisterAction:function(c,e){var a=this;var b={url:ContextClinc_Server+"ybReimburse/isYbRegister",dataType:"json",data:c,showMask:true,contentType:"application/json; charset=utf-8"};var d=Utils.myAjaxHandler(b);d.done(function(f){if(f.errorCode=="E0000000"){e.call(a,f.data)}else{$.paError("查询失败")}}).fail(function(f){$.paError("操作失败!")}).always(function(){})},auditRecipe:function(c,b){var a=this;if(typeof(c)=="undefined"||c==null){$.paWarn("尚未填写任何药品")}a.auditRecipeAction(c,b,function(d){if(d==null){$.paSuccess("审核通过");return}layer.open({type:2,title:"审核结果",shadeClose:true,anim:false,shade:0.8,area:["800px","600px"],content:d,cancel:function(){},end:function(){}})})},auditRecipeAction:function(e,d,f){var a=this;var b={url:ContextClinc_Server+"dentistryRecipe/medicalInsuranceAuditTip",dataType:"json",data:JSON.stringify(e),showMask:true,contentType:"application/json; charset=utf-8"};var c=Utils.myAjaxHandler(b);c.done(function(g){if(g.errorCode=="E0000000"){f.call(a,g.data)}else{if(g.errorMessage!=null){if(d!=0){if("审核通过"==g.errorMessage){$.paSuccess("审核通过")}else{$.paError(g.errorMessage)}}}else{if(d!=0){$.paError("审核失败")}}}}).fail(function(g){$.paError("医保审核操作失败!")}).always(function(){})},chuzhi:{auditChuzhiProject:function(b){var a=this;if(existClinicTag("WISDOM_MI")){audit_Btn.isYbRegisterAction(audit_Btn.acographyId,function(f){if(!f){return}var e=a.getStroeData();var g=[];var c={};for(var d in e){if(!e[d].mdTreatmentID||""==e[d].mdTreatmentID){e.splice(d,1);d--}}if(!e||e.length<=0){$.paError("诊疗项目为空");return}c.dwsTreatProList=e;c.acographyId=audit_Btn.acographyId;g.push(c);audit_Btn.auditRecipe(g,b)})}},getStroeData:function(){var b=[];var a=$(".editCard > .item:gt(0)");a.each(function(e,f){var g=$(f);var c=$.trim(g.find(".nurse").attr("val"));var d={treatmentID:g.attr("data-id")||"",acographyID:audit_Btn.acographyId,position:g.find(".pos").getToothPosition(),mdTreatmentID:g.find(".tName").attr("data-id"),treatmentRemark:g.find(".tDesc").val(),treatmentName:g.find(".tName").val(),treatmentQty:g.find(".qty").val(),treatmentPrice:g.find(".price").text().substring(1),treatmentUnit:g.find(".unit").val(),chargeStatus:g.find(".chargeStatus").val()||0,nurseId:c,nurseName:c?g.find(".nurse").val():"",delFlag:g.css("display")=="none"?1:0};b.push(d)});return _.filter(b,function(c){return c.delFlag==0})}},tcm:{getHerbalRecipesData:function(){return tcmp.getHerbalRecipesData("auditTipFlag")},auditRecipe:function(b){var a=this;if(existClinicTag("WISDOM_MI")){audit_Btn.isYbRegisterAction(audit_Btn.acographyId,function(c){if(!c){return}var d=a.getHerbalRecipesData();if(d.code==1){$.paWarn("尚未填写任何药品");return}audit_Btn.auditRecipe(d.data,b)})}}},treat:{insertDwsTreatPro:function(f){var e=$("#table_tp").find(".tp_newtr");var d=[];e.splice(e.length-1,1);var b=e&&e.length!=0&&true;$.each(e,function(h){var j=$(e[h]).find("td");var a=j.find("._tp_tab_ip_unit_id").val();var g=j.find("._tp_tab_ip_pro_id").val();if(Utils.isBlank(g)){var k={treatmentID:null,acographyID:f,clinicID:clinicID,mdTreatmentID:j.find("._tp_tab_ip_pro_id").val(),groupNum:j.find("._tp_tab_ip_teamnum").val(),mdFrequencyID:MDFREQUENCYID_DEFALUT,treatmentRemark:j.find("._tp_tab_ip_remark").val(),treatmentName:j.find("._tp_tab_ip_pro").val(),frequencyName:j.find("._tp_tab_ip_unit").val(),treatmentQty:j.find("._tp_tab_ip_treatnum").val(),treatmentPrice:j.find("._tp_tab_ip_price").val(),isCombineItem:$(e[h]).attr("is_combine_item"),chargeStatus:0,treatmentType:1,orderNum:j.find("._tp_tab_ip_teamnum").val()};d.push(k)}else{return}});if(b){var c={dwsTreatmentList:d};return c}else{return false}},auditTreatProject:function(b){var a=this;if(existClinicTag("WISDOM_MI")){audit_Btn.isYbRegisterAction(audit_Btn.acographyId,function(f){if(!f){return}var h=[];var e={};var g=[];g=g.concat(a.insertDwsTreatPro(audit_Btn.acographyId).dwsTreatmentList);var c=treatPro_action.selectDwsTpByAcographyID(audit_Btn.acographyId);g=g.concat(c);if(g&&g.length>0){for(var d in g){if(!g[d]){g.splice(d,1);d--}}}if(g&&g.length<=0){$.paError("诊疗项目为空");return}g.forEach(function(k,i,j){if(k){if(k.ACOGRAPHY_ID){k.acographyID=k.ACOGRAPHY_ID}if(k.CLINIC_ID){k.clinicID=k.CLINIC_ID}if(k.FREQUENCYNAME){k.frequencyName=k.FREQUENCYNAME}if(k.GROUPNUM){k.groupNum=k.GROUPNUM}if(k.IS_COMBINE_ITEM){k.isCombineItem=k.IS_COMBINE_ITEM}if(k.MDFREQUENCYID){k.mdFrequencyID=k.MDFREQUENCYID}if(k.MD_TREATMENT_ID){k.mdTreatmentID=k.MD_TREATMENT_ID}if(k.ORDERNUM){k.orderNum=k.ORDERNUM}if(k.ITEM_ID){k.treatmentID=k.ITEM_ID}if(k.TREATMENTNAME){k.treatmentName=k.TREATMENTNAME}if(k.TREATMENTPRICE){k.treatmentPrice=k.TREATMENTPRICE}if(k.TREATNUM){k.treatmentQty=k.TREATNUM}if(k.TREATMENTREMARK){k.treatmentRemark=k.TREATMENTREMARK}if(k.TREATMENT_TYPE){k.treatmentType=k.TREATMENT_TYPE}}});e.dwsTreatmentList=g;e.acographyId=audit_Btn.acographyId;h.push(e);audit_Btn.auditRecipe(h,b)})}}},assistCheck:{auditRecipe:function(a){if(existClinicTag("WISDOM_MI")){audit_Btn.isYbRegisterAction(audit_Btn.acographyId,function(e){if(!e){return}var d=[];var c=_acMain.insertAcAndLc(audit_Btn.acographyId);c.dwsLaboratoryCheckList=c.dwsLaboratoryCheckList.concat(_acAction.selectDwsAcByAcographyID(audit_Btn.acographyId).dwsLaboratoryCheckList);c.acographyId=audit_Btn.acographyId;if(c.dwsLaboratoryCheckList.length!=0){var b=c.dwsLaboratoryCheckList;b.forEach(function(h,g,f){h.acographyID=h.ACOGRAPHYID;h.chargeStatus=h.CHARGESTATUS;h.mdExamID=h.EXAM_ID;h.examSampleID=h.EXAM_SAMPLE_ID;h.examSerialNo=h.EXAM_SERIAL_NO;h.isExecute=h.ISEXECUTE;h.isSend=h.IS_SEND;h.examName=h.ITEMNAME;h.labExamID=h.LABCHECKID;h.labExamPrice=h.PRICE;h.examSampleName=h.SAMPLES;delete h.ACOGRAPHYID;delete h.CHARGESTATUS;delete h.CLINIC_ID;delete h.EXAMITEMID;delete h.EXAM_ID;delete h.EXAM_SAMPLE_ID;delete h.EXAM_SERIAL_NO;delete h.ISEXECUTE;delete h.IS_SEND;delete h.IS_SHOW_BTN;delete h.ITEMNAME;delete h.LABCHECKID;delete h.PRICE;delete h.SAMPLES;delete h.UPDATETIME})}c.dwsAssistCheckList=c.dwsAssistCheckList.concat(_acAction.selectDwsAcByAcographyID(audit_Btn.acographyId).dwsAssistCheckList);c.acographyId=audit_Btn.acographyId;if(c.dwsAssistCheckList.length!=0){var b=c.dwsAssistCheckList;b.forEach(function(h,g,f){h.acographyID=h.ACOGRAPHYID;h.chargeStatus=h.CHARGESTATUS;h.mdExamID=h.EXAMITEMID;h.examSampleID=h.EXAM_SAMPLE_ID;h.examSerialNo=h.EXAM_SERIAL_NO;h.isExecute=h.ISEXECUTE;h.isSend=h.IS_SEND;h.examName=h.ITEMNAME;h.labExamID=h.LABCHECKID;h.assistExamPrice=h.PRICE;h.examSampleName=h.SAMPLES;delete h.ACOGRAPHYID;delete h.CHARGESTATUS;delete h.CLINIC_ID;delete h.EXAMITEMID;delete h.EXAM_ID;delete h.EXAM_SAMPLE_ID;delete h.EXAM_SERIAL_NO;delete h.ISEXECUTE;delete h.IS_SEND;delete h.IS_SHOW_BTN;delete h.ITEMNAME;delete h.LABCHECKID;delete h.PRICE;delete h.SAMPLES;delete h.UPDATETIME})}if(!c&&c.dwsAssistCheckList.length<=0&&c.dwsLaboratoryCheckList.length<=0){$.paError("检验检查为空");return}d.push(c);audit_Btn.auditRecipe(d,a)})}}},west:{assemblyAuditDrugRecipe:function(d){var b=this;var g=$(".recipe_lable.current").attr("recipeName");var c=$(".recipe_lable.current").attr("recipeId");var f={recipeId:c,acographyId:b.acographyId,empiId:b.empiId,recipeName:g};var e=[];var a=d.find("tr[drugid]");a=$.grep(a,function(k){var j=$(k);var i=j.find(".west-drugName").val();if(i==null||i==undefined||i==""){return true}var h={};h.drugId=j.attr("drugid");h.recipeWestId=j.attr("recipeWestId");h.drugName=i;h.drugSource=j.find(".west-source").attr("val");h.unitPrice=j.attr("unitprice");h.totalQty=j.find(".west-totalQty").val();e.push(h)});f.recipeWestList=e;return[f]},getRecipeClassNameByRecipeName:function(a){return"recipe"+a}}};$(function(){audit_Btn.init()});