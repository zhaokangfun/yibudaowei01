var userInfo_aclc=config_cache.getCache("medical_user_data");var clinicID=userInfo_aclc!=null?userInfo_aclc.clinicId:$.paError("页面参数错误:[clinicID]不能为空");var tp_acographyID=Utils.getQueryString("acographyId");var tp_empiId=Utils.getQueryString("empiId");var treatmentState=Utils.getQueryString("treatmentState");var tp_len=0;var MDFREQUENCYID_DEFALUT="PL07001";var is_jiuzhen=false;var tp_recordId=Utils.getQueryString("recordId");var savedTreatment=null;var currentScrollTop=0;var startIndex=0;var pageSize=20;var delay=false;var completeRegister={};var hidePrice=2;var editState=1;var finishPatFlag=true;var clinicTemplate=[];var personalTemplate=[];var choosedTemplate=[];var exam_api={treatment_list:ContextClinc_Server+"intentInput/getMdcDictTreatment",dictdrug_list:ContextClinc_Server+"intentInput/getNewMdcDictDrug",selectListDrug:ContextClinc_Server+"drugAPI/getMdcDictDrug"};var par={method:"GET",url:ContextClinc_Server+"reception/queryClinicDoctors",dataType:"json",data:{}};var doctorName=userInfo_aclc.employee.employeeName;var employeeId=userInfo_aclc.id;var validateStock=2;var editPrice=1;var clinicParams=userInfo_aclc.clinicParams;for(var index in clinicParams){if(clinicParams[index].parameterCode=="3020"){editPrice=clinicParams[index].parameterValue;break}}for(var index in clinicParams){if(clinicParams[index].parameterCode=="3013"){hidePrice=clinicParams[index].parameterValue;break}}var isYbReg=Utils.getQueryString("isYbReg");var isYbClinic=0;for(var index in userInfo_aclc.clinic["tags"]){if(userInfo_aclc.clinic["tags"][index].tagCode=="MI"){isYbClinic=1}}var treatTmpl_model=Class.create({dwsTreatmentTmpl:{templateId:"",clinicId:clinicID,departmentId:"",doctorId:"",templateName:"",templateType:3,remark:""},});var treatPro_main=Class.create({initdoctor:function(){var a=new component_drop_doctor();a.init_preChoose();a.init_view_readOnly();$(".component_drop_doctor_readonly_input").addClass("doci-input");$(".component_drop_doctor_input").addClass("docs-input")},getEmployList:function(){var a={method:"GET",url:ContextClinc_Server+"employee/getEmployList",dataType:"json",data:{}};return Utils.myAjaxHandler(a)},init:function(a){_tpMain.treatProjectHistory=new TreatProjectHistory();_tpMain.cleanTpTable();config_cache.removeCache(cacheMap.treatmentTmplList);if(a!=null&&a!=""){_tpMain.initdoctor();_tpMain.treatProjectHistory.init(a);_tpMain.getTpByAcographyid(a)}else{$("#table_tp").append(_tpView.showNewATr(0));_tpMain.initdoctor()}_tpMain.changeMulPrice();_tpMain.treatProjectBindTmpl();_tpMain.clickTpTmpl();_tpMain.clickSaveTreatTmplBtn();_tpMain.clickSubmitBtn();_tpMain.clinicPrintBtn();_tpMain.thinksearchCTI();$("#table_tp tr").ketchup();_tpMain.bindTotalPriceUpdate();_tpMain.bindSearchTemplate();_tpMain.bindCheckStock();_tpView.refreshDropDown();_tpMain.getDiscountPermit();_tpMain.checkDiscount();_tpView.checkSaveTmplBtn()},bindCheckStock:function(){$("#table_tp").on("blur","._tp_tab_ip_treatnum",function(){var a=parseInt($(this).val());var b=$(this).attr("qty");if(validateStock=="1"&&a!=null&&a>b&&b!="-"&&b!=null){$.paWarn($(this).parents("tr").find("._tp_tab_ip_pro").val()+" 库存不足");$(this).addClass("overFlowStore")}else{$(this).removeClass("overFlowStore")}})},bindSearchTemplate:function(){$(".search-btn").on("click",function(){var a=$(".search-input").val();var c="<dt>个人模版</dt>";choosedTemplate=[];if($("#tmpl_tp_platform").find("dt").hasClass("topIcon")){c="<dt>诊所模版</dt>";$(clinicTemplate).each(function(d,e){if(e.templateName.indexOf(a)!=-1){choosedTemplate.push(e)}});for(var b=0;b<choosedTemplate.length;b++){c=c+'<dd tmplid="'+choosedTemplate[b].templateId+'"  title="'+choosedTemplate[b].templateName+'" class="_dws_tp_dd" >'+choosedTemplate[b].templateName+"</dd>"}$("#tmpl_tp_platform").empty().append(c);$("#tmpl_tp_platform").find("dt").addClass("topIcon");$("#tmpl_tp_persion").find("dd").hide();$("#tmpl_tp_platform").find("dd").show();Utils.renderPopup()}if($("#tmpl_tp_persion").find("dt").hasClass("topIcon")){$(personalTemplate).each(function(d,e){if(e.templateName.indexOf(a)!=-1){choosedTemplate.push(e)}});for(var b=0;b<choosedTemplate.length;b++){c=c+'<dd tmplid="'+choosedTemplate[b].templateId+'"  title="'+choosedTemplate[b].templateName+'" class="_dws_tp_dd" >'+choosedTemplate[b].templateName+"</dd>"}$("#tmpl_tp_persion").empty().append(c);$("#tmpl_tp_persion").find("dt").addClass("topIcon");$("#tmpl_tp_platform").find("dd").hide();$("#tmpl_tp_persion").find("dd").show();Utils.renderPopup()}})},bindTotalPriceUpdate:function(){if(editPrice==2){$("._tp_tab_ip_price").attr("readonly","readonly")}else{if(editPrice==1&&editState==1){$("._tp_tab_ip_price").removeAttr("readonly")}}$("._tp_tab_ip_price").off("keyup").on("keyup",function(){$(this).val(_tpMain.priceConvert($(this).val()));_tpView.showSumPrice(true)})},priceConvert:function(a){if((a.lastIndexOf(".")==a.length-1)&&(a.indexOf(".")==a.lastIndexOf("."))&&(a.indexOf(".")!=0)){return a}else{if((a.lastIndexOf(".")==a.length-2)&&(a.indexOf(".")==a.lastIndexOf("."))&&(a.indexOf(".")!=0)&&(a.lastIndexOf("0")==a.length-1)){return a}else{var b=Math.floor(parseFloat(a)*100)/100;if(isNaN(b)||b<0){return 0}else{if(b<1000000){return b}else{return 999999.99}}}}},thinksearchCTI:function(){$("#table_tp").on("input propertyChange","._tp_tab_ip_pro",function(c){if($(this).val()==""){return}if(editState==2){return}$(this).siblings("._tp_tab_ip_pro_old").val($(this).val());var a=$(this).siblings(".easy-resault");a.scrollTop(0);var b=$(this);options={resaultName:"经典药名",keyAndValue:{keyName:"TREATMENT_CODE",valueName:"TREATMENT_NAME"},columns:[{dataKey:"TREATMENT_CODE",width:"20%",name:"项目编号"},{dataKey:"TREATMENT_NAME",width:"35%",name:"项目名称"},{dataKey:"TREATMENT_PRICE",width:"30%",name:"单价"},{dataKey:"TREATMENT_QUANTITY",width:"15%",name:"库存"}],callback:function(g){var d=userInfo_aclc.clinicParams;for(var e in d){if(d[e].parameterCode=="1014"){validateStock=d[e].parameterValue}}if(validateStock=="1"&&g.DRUG_CODE!=null&&g.TREATMENT_QUANTITY==0){$.paError("该项目库存不足,无法选择");return}var f=b.parents("tr");var h=f.find(".can_edit_t .input-text").attr("val");if(h==1){$(b).attr("unit",g.DRUG_DISPENSE_UNIT_NAME);$(b).attr("unitname",g.DRUG_PACKAGE_SPEC)}else{$(b).attr("unit",g.TREATMENT_UNIT);$(b).attr("unitname",g.TREATMENT_UNIT_NAME)}$(b).val(g.TREATMENT_NAME);$(b).siblings("._tp_tab_ip_pro_id").val(g.TREATMENT_ID);$(b).parent().siblings(".price").children().val(Utils.changePrice(g.TREATMENT_PRICE));$(b).parent().siblings(".price").children().attr("price",g.TREATMENT_PRICE);$(b).parent().siblings(".treatnum").children().val(1).focus();$(b).parent().siblings(".treatnum").children().attr("qty",g.DRUG_STORE_UNIT_QTY);$(b).parents("tr").attr("is_combine_item",g.IS_COMBINE_ITEM);_tpView.showSumPrice(true);if($(b).parent().parent().attr("del_flag")==1){_tpMain.newATr($(b).parent(),tp_len)}_tpView.checkSaveTmplBtn();f.find(".input-text").cleanDropdownItem();if(hidePrice==1){_tpView.hidePrice()}}};if(isYbClinic==1){options.columns=[{dataKey:"TREATMENT_CODE",width:"20%",name:"项目编号"},{dataKey:"TREATMENT_NAME",width:"35%",name:"项目名称"},{dataKey:"FEE_LEVEL",width:"15%",name:"医保属性"},{dataKey:"TREATMENT_PRICE",width:"15%",name:"单价"},{dataKey:"TREATMENT_QUANTITY",width:"15%",name:"库存"}]}_this=this;if(delay==false){delay=true;if(completeRegister[$(this).attr("id")]!=1){$(_this).easyAutoComplete(options);completeRegister[$(this).attr("id")]=1;$(".easy-resault").scroll(function(){var d=$(this)[0].scrollHeight;if($(this).scrollTop()>currentScrollTop&&d-$(this).height()-$(this).scrollTop()<=28){startIndex+=20;_tpMain.getMenuData($(_this),startIndex,options)}currentScrollTop=$(this).scrollTop()})}setTimeout(function(){currentScrollTop=0;_tpMain.getMenuData($(_this));delay=false},500)}})},getMenuData:function(c,g,h){var f=c.parents("tr").find(".input-text").attr("val");var e=$.trim(c.parents("tr").find("._tp_tab_ip_pro").val());var a=f==0?1:3;var b={examFlag:a,keyword:e,startIndex:g!=null?g:0,limitRows:pageSize};var j={method:"POST",data:b,dataType:"json"};var d="";if(b.examFlag==1){d=IntentInput_url.intentInput_selectDesTIAE}else{d=exam_api.selectListDrug;b.currentPage=g!=null?(g/pageSize+1):1;b.pageSize=pageSize;b.drugPropType=10;b.dictItemCodes=[104];j.key="keyword";j.limit=20;j.data=b;j.traditional=true}j.url=d;var i=Utils.myAjaxHandler(j);i.done(function(m){if(SUCCESSCODE==m.errorCode){var k=m.data;if(b.examFlag!=1){for(var l=0;l<k.length;l++){k[l].TREATMENT_ID=k[l].DRUG_ID;k[l].TREATMENT_CODE=k[l].DRUG_CODE;k[l].TREATMENT_NAME=k[l].DRUG_NAME;k[l].CEILING_PRICE=k[l].DRUG_RETAIL_PRICE;k[l].TREATMENT_PRICE=k[l].DRUG_RETAIL_PRICE;k[l].TREATMENT_QUANTITY=k[l].SHOW_STORE_VALIDE_QTY;k[l].YB_COMPARE=k[l].CONSTRAST_FLAG==null?"否":(k[l].CONSTRAST_FLAG==1?"是":"否")}}else{for(var l=0;l<k.length;l++){k[l].TREATMENT_QUANTITY="-";k[l].YB_COMPARE=k[l].CONSTRAST_FLAG==null?"否":(k[l].CONSTRAST_FLAG==1?"是":"否");k[l].TREATMENT_PRICE=(isYbClinic==1&&isYbReg!=1&&k[l].CEILING_PRICE!=null)?k[l].CEILING_PRICE:k[l].TREATMENT_PRICE}}if(isYbClinic!=1){for(var l=0;l<k.length;l++){k[l].highlight="false"}}else{for(var l=0;l<k.length;l++){if(k[l].FEE_LEVEL=="未对照"){k[l].highlight="true"}}}if(g==null){c.easyDataChange(k)}else{_tpMain.appendCompleteData(c.siblings(".easy-resault"),k,h)}}else{$.paError(status.errorMessage)}}).fail(function(k){if(k.status==200){if(g==null){c.easyDataChange([])}else{_tpMain.appendCompleteData(c.siblings(".easy-resault"),[],h)}}else{$.paError("请求异常")}}).always(function(){});return""},appendCompleteData:function(k,f,l){for(var g=0,h=f.length;g<h;g++){var b=f[g];if(isYbClinic!=1){b.highlight="false"}else{if(b.FEE_LEVEL=="未对照"){b.highlight="true"}}var c=b.highlight=="true"?$('<li class="easy_option ac_special"></li>'):$('<li class="easy_option"></li>');var a=l.columns.length;if(a>0){var e="";for(var d=0;d<a;d++){e+='<span title="'+b[l.columns[d].dataKey]+'" style="width:'+l.columns[d]["width"]+'">'+b[l.columns[d].dataKey]+"</span>"}c.append(e);if(!l.columns[0].width){c.find("span").css("width",Math.floor(100/a)+"%")}}else{c.append(b[l.keyAndValue.valueName])}(function(i){c.on("click",function(){if($(this).hasClass("easy_option")){l.callback(i)}});c.off("keydown").on("keydown",function(j){if(j.keyCode==13){if($(this).hasClass("easy_option")){l.callback(i)}}})})(b);k.append(c)}},initKeyUp:function(){$("#table_tp").on("keyup","._tp_tab_ip_pro",function(j){var f=$(this).siblings(".small-table-box");if(j.keyCode==38){var m=f.find("tbody").children("tr.active");var b=m.length;if(b==1){var h=m.prev("tr");if(h.length!=0){m.removeClass("active");h.addClass("active");var l=h.position().top;if(l<27){currentScrollTop-=27;$(".small-table-box").scrollTop(currentScrollTop)}}}else{f.find("tbody").children("tr:eq(0)").addClass("active")}return}else{if(j.keyCode==40){var m=f.find("tbody").children("tr.active");var b=m.length;if(b==1){var k=m.next("tr");if(k.length!=0){m.removeClass("active");k.addClass("active");var l=k.position().top;if(l>253){currentScrollTop+=27;$(".small-table-box").scrollTop(currentScrollTop)}}}else{f.find("tbody").children("tr:eq(0)").addClass("active")}return}}currentScrollTop=0;startIndex=0;var c=$(this).val();if(c!==""&&c.length>0){var i=$(this).parents("tr").find(".input-text").attr("val");var g=$.trim($(this).val());var a=i==0?1:3;var d={examFlag:a,keyword:g,startIndex:0,limitRows:20};_tpMain.getProjectInfoByProjectType(d,f,false)}$("body").click(function(n){if(!$(n.target).closest(".small-table-box").length){$(".small-table-box").hide();$("body").off("click")}})})},initScroll:function(){$(".small-table-box").scroll(function(f){var b=$(this)[0].scrollHeight;if($(this).scrollTop()>currentScrollTop&&b-$(this).height()-$(this).scrollTop()==0){startIndex+=20;var g=$(this).parents("tr").find(".input-text").attr("val");var a=$.trim($(this).parents("tr").find("._tp_tab_ip_pro").val());var d=$(this);var h=g==0?1:3;var c={examFlag:h,keyword:a,startIndex:startIndex,limitRows:20};_tpMain.getProjectInfoByProjectType(c,d,true)}currentScrollTop=$(this).scrollTop()})},getProjectInfoByProjectType:function(f,b,c){var a={method:"POST",data:f,dataType:"json"};var e="";if(f.examFlag==1){e=IntentInput_url.intentInput_selectDesTIAE}else{e=exam_api.selectListDrug;f.currentPage=f.startIndex/20+1;f.pageSize=f.limitRows;f.params={keyword:f.keyword,disabled:0,type:1};a.contentType="application/json; charset=utf-8";a.data=JSON.stringify(f)}a.url=e;var d=Utils.myAjaxHandler(a);d.done(function(h){if(SUCCESSCODE==h.errorCode){var g=f.examFlag==1?h.data:h.data.dataSource;if(c){_tpMain.appendSmallTable(f,g,b)}else{_tpMain.refreshSmallTable(f,g,b)}}else{$.paError(status.errorMessage)}}).fail(function(g){$.paError("请求异常")}).always(function(){});return""},refreshSmallTable:function(f,m,h){var d=h.find(".small-table-ware-tbody");d.html("");for(var j=0;j<m.length;j++){var o=m[j];var c=f.examFlag==1?o.TREATMENT_ID:o.DRUG_ID;var e=f.examFlag==1?o.TREATMENT_CODE:o.DRUG_CODE;var b=f.examFlag==1?o.TREATMENT_NAME:o.DRUG_NAME;var k=f.examFlag==1?o.TREATMENT_PRICE:o.DRUG_RETAIL_PRICE;var a=f.examFlag==1?o.TREATMENT_PRICE:o.DRUG_RETAIL_PRICE;var n=f.examFlag==1?"-":(o.DRUG_STORE_UNIT_QTY==null?0:o.DRUG_STORE_UNIT_QTY);var g=0;if(!k){k=0}var l=$("<tr id='"+c+"' iscombine='"+g+"'><td id='"+e+"'>"+e+"</td><td id='"+b+"'>"+b+"</td><td id='"+k+"' ybprice='"+a+"'>"+k+"</td><td>"+n+"</td></tr>");l.appendTo(d);l.on("click",function(i){_tpMain.smallTableRowClickHandler(h,i)})}d.find("tr").hover(function(){$(this).find("td").css({color:"#fff","background-color":"#01a9db"})},function(){$(this).find("td").css({color:"#242f44","background-color":"#fff"})});h.show()},appendSmallTable:function(f,m,h){var d=h.find(".small-table-ware-tbody");for(var j=0;j<m.length;j++){var o=m[j];var c=f.examFlag==1?o.TREATMENT_ID:o.DRUG_ID;var e=f.examFlag==1?o.TREATMENT_CODE:o.DRUG_CODE;var b=f.examFlag==1?o.TREATMENT_NAME:o.DRUG_NAME;var k=f.examFlag==1?o.TREATMENT_PRICE:o.DRUG_RETAIL_PRICE;var a=f.examFlag==1?o.TREATMENT_PRICE:o.DRUG_RETAIL_PRICE;var n=f.examFlag==1?"-":(o.DRUG_STORE_UNIT_QTY==null?0:o.DRUG_STORE_UNIT_QTY);var g=0;if(!k){k=0}var l=$("<tr id='"+c+"' iscombine='"+g+"'><td id='"+e+"'>"+e+"</td><td id='"+b+"'>"+b+"</td><td id='"+k+"' ybprice='"+a+"'>"+k+"</td><td>"+n+"</td></tr>");l.appendTo(d);l.on("click",function(i){_tpMain.smallTableRowClickHandler(h,i)})}d.find("tr").hover(function(){$(this).find("td").css({color:"#fff","background-color":"#01a9db"})},function(){$(this).find("td").css({color:"#242f44","background-color":"#fff"})})},smallTableRowClickHandler:function(a,c){var b=c.target.tagName;var d={};if("TD"==b||"td"==b){d.id=c.target.parentElement.id;d.code=c.target.parentElement.childNodes[0].id;d.name=c.target.parentElement.childNodes[1].id;d.price=c.target.parentElement.childNodes[2].id;d.ybPrice=c.target.parentElement.childNodes[2].ybprice;d.isCombine=c.target.parentElement.childNodes[0].iscombine;d.qty=c.target.parentElement.childNodes[3].innerHTML}a.parents("tr").find("._tp_tab_ip_pro_id").val(d.id);a.parents("tr").find("._tp_tab_ip_pro").val(d.name);a.parents("tr").find(".price").children().val(Utils.changePrice(d.price));a.parents("tr").find(".treatnum").children().val(1).focus();a.parents("tr").find(".treatnum").children().attr("qty",d.qty);a.parents("tr").attr("is_combine_item",d.isCombine);a.parents("tr").find("._tp_tab_ip_pro").attr("readonly","readonly");a.parents("tr").find("._tp_tab_ip_pro").off();_tpView.showSumPrice(true);if(a.parents("tr").attr("del_flag")==1){_tpMain.newATr(a.parents("tr").find("._tp_tab_td_pro"),tp_len)}_tpView.checkSaveTmplBtn();a.parents("tr").find(".input-text").cleanDropdownItem();a.hide()},initTpTmplList:function(){$("#tmpl_tp_platform").empty();$("#tmpl_tp_persion").empty();_tpView.showTpTmplBar(_tpAction.selectDwsTpTmpl())},insertDwsTreatPro:function(i){var g=$("#table_tp").find(".tp_newtr");var b=[];g.splice(g.length-1,1);var f=$("#table_tp").find(".tp_newtr")[$("#table_tp").find(".tp_newtr").length-1];if(f){if(Utils.notBlank($(f).find("._tp_tab_ip_treatnum").val())&&"必填项不能为空。"!=$(f).find("._tp_tab_ip_treatnum").val()||Utils.notBlank($(f).find("._tp_tab_ip_remark").val())){$.paError("项目必须为选择值");return false}}if(g&&g.length==0){if($("#table_tp").children("tr").not(".tp_newtr").length==0){$.paError("项目必须为选择值");return false}else{$.paSuccess("保存成功");_tpMain.showEditeBtn();_tpMain.init(i);return false}}var h=true;var j=false;var d=userInfo_aclc.clinicParams;for(var e in d){if(d[e].parameterCode=="1014"){validateStock=d[e].parameterValue}}$.each(g,function(l){var m=$(g[l]).find("td");var a=m.find("._tp_tab_ip_unit_id").val();var k=m.find("._tp_tab_ip_pro_id").val();var n=m.find("._tp_tab_ip_treatnum").val();var p=m.find("._tp_tab_ip_treatnum").attr("qty");if(validateStock=="1"&&p!="-"&&parseInt(n)>parseInt(p)){$.paWarn(m.find("._tp_tab_ip_pro").val()+"超出库存");m.find("._tp_tab_ip_treatnum").addClass("overFlowStore");j=true;return}if(Utils.isBlank(k)){var o={treatmentID:$(g[l]).attr("treatment_id")!=null?$(g[l]).attr("treatment_id"):null,acographyID:i,clinicID:clinicID,mdTreatmentID:m.find("._tp_tab_ip_pro_id").val(),groupNum:m.find("._tp_tab_ip_teamnum").val(),mdFrequencyID:MDFREQUENCYID_DEFALUT,treatmentRemark:$.trim(m.find("._tp_tab_ip_remark").val())==""?"--":$.trim(m.find("._tp_tab_ip_remark").val()),treatmentName:m.find("._tp_tab_ip_pro").val(),frequencyName:m.find("._tp_tab_ip_unit").val(),treatmentQty:m.find("._tp_tab_ip_treatnum").val(),treatmentPrice:m.find("._tp_tab_ip_price").attr("price"),treatmentPriceModify:m.find("._tp_tab_ip_price").val(),isCombineItem:$(g[l]).attr("is_combine_item"),chargeStatus:0,treatmentType:1,orderNum:m.find("._tp_tab_ip_teamnum").val(),userId:$("#docs-input").attr("val"),employeeName:$("#docs-input").val(),itemType:m.find(".input-text").attr("val"),treatmentUnit:m.find("._tp_tab_ip_pro").attr("unit"),treatmentUnitName:m.find("._tp_tab_ip_pro").attr("unitname")};b.push(o)}else{$.paError("项目必须为选择值");h=false;return}});if(j){return null}if(h){var c={dwsTreatmentList:b};return c}},getTpByAcographyid:function(b){var a=_tpAction.selectDwsTpByAcographyID(b);savedTreatment=a;_tpView.showTreatProList(a);if(Utils.isBlank(a)&&a.length>0){if(treatmentState==1){_tpMain.showEditeBtn()}}else{$("#editeBtn").hide();_tpMain.showSaveBtn()}},logicDeleteDwsTpByID:function(a,c){if(a!=null){var b={msg:"是否确认删除？",cancelTxt:"取消",saveTxt:"确认",onYes:function(){if(a!=null){var d=_tpAction.logicDelDwsTpByID(a);if(d==0){$.paWarn("该项目已收费")}else{_tpView.removeTableTR(c);tp_len-=1;_tpView.showSumPrice(true);var f=$("#table_tp");var e=f.find("._tp_tab_ip_teamnum");e.each(function(g,h){$(this).val(g+1)})}}else{_tpView.removeTableTR(c);_tpView.showSumPrice(true)}}};$.paConfirm(b)}else{_tpView.removeTableTR(c);_tpView.showSumPrice(true)}_tpMain.docDropEditAuto()},refreshDelFlag:function(){var a=$("#table_tp").children("tr");a.splice(a.length-1,1);$.each(a,function(b){$(a[b]).attr("del_flag",2)})},newATr:function(c,a){var b=$(_tpView.showNewATr(a));$(c).parent().parent().append(b);$(c).removeAttr("onclick");_tpMain.refreshDelFlag();$(c).parent().ketchup();$("body").paKeyHandle({necessary:true,clz:"enterNext"});$("#table_tp").children("tr").each(function(d){$(this).find("td:eq(0)").find("input").val(d+1)});_tpView.refreshDropDown();_tpMain.docDropEditAuto();_tpMain.bindTotalPriceUpdate()},changeMulPrice:function(){$("#table_tp").on("keyup","._tp_tab_ip_treatnum",function(){_tpView.showSumPrice(true)})},treatProjectBindTmpl:function(){$("#zlmb_model_btn").off("click").on("click",function(a){$(".search-input").val("");_tpMain.initTpTmplList();a.stopPropagation();$(".treatment-project .popup-model").show();$("#tmpl_tp_persion").find("dd").show();$("#tmpl_tp_persion").find("dt").addClass("topIcon");Utils.renderPopup()});$(".treatment-project .popup-model").off("click","dt").on("click","dt",function(b){var a=$(this).parents("dl").find("dd").is(":visible");if(!a){$(this).parents("dl").siblings().find("dd").hide();$(this).parents("dl").find("dd").show();$(this).parents("dl").siblings().find("dt").removeClass("topIcon");$(this).addClass("topIcon");Utils.renderPopup()}else{$(this).parents("dl").find("dd").hide();$(this).removeClass("topIcon")}})},cleanTpTable:function(){$("#table_tp").empty();tp_len=0;_tpView.checkSaveTmplBtn()},clickTpTmpl:function(){$("#treatmentTmplDetail").off("click","._dws_tp_dd").on("click","._dws_tp_dd",function(a){Utils.addLoadingMaskTo();setTimeout("Utils.removeLoadingMaskFrom()",170);var d=$(this).attr("tmplid");var c=_tpAction.selectDwsTpTmplItem(d);var b=c.dwsTreatmentTmplItemList!="undefined"?c.dwsTreatmentTmplItemList:null;$("#table_tp .tp_newtr:last").remove();tp_len-=1;_tpView.selectDwsTpTmplItem(b);$(".treatment-project .popup-model").hide();_tpView.checkSaveTmplBtn();_tpMain.docDropEditAuto();_tpMain.bindTotalPriceUpdate();if(hidePrice==1){_tpView.hidePrice()}})},clickSaveTreatTmplBtn:function(){var a=this;$("#treatmentSaveTmplBtn").off("click").on("click",function(){var b={msg:'<div class="clear" style="margin-bottom: 12px; padding-left: 18px;"><div class="fl" style="color:#5c5c5c;">模板级别：</div><div class="template-level"><span class="radio checked" val="3" onclick="_tpMain.checkRadio(this)">个人模板</span><span class="radio" val="2" onclick="_tpMain.checkRadio(this)">诊所模板</span></div></div><i class="necessary">*</i>模板名称：<input type="text" class="input-text validate(required,maxlength(15),notEmpty)" maxlength="15" id="cfm-input">',label:"模板名称: ",cancelTxt:"取消",saveTxt:"确认",onYes:function(){var d=$("#cfm-msg").ableToFinish();if(!d){return}var c=[];var e=$("#table_tp").children("tr");$.each(e,function(g){c[c.length]=$(e[g]).find("._tp_tab_ip_pro_id").val()});var f=$.trim($("#cfm-input").val());if(_tpAction.checkTpTmplName(f)){_tpMain.saveToTreatTmpl(f)}else{$.paError("模板名称已经存在!");return}$("#pa-confirm").remove()}};a.paConfirm(b)})},paConfirm:function(d){$("body").append('<div id="pa-confirm" class="reveal-modal msg" style="height: 140px;"><span id="icon_close" class="icon_close"></span><div id="cfm-msg" class="show-msg"></div><div class="btn-bar"><span class="bn-size btn-default" id="pa-cancel" style="margin: 0px 0px 0px 0px;"></span><span class="bn-size btn-success" id="pa-save"></span></div></div>');var e={msg:"是否确认执行该操作？",cancelTxt:"取消",saveTxt:"保存",onYes:function(){alert("无法获取确认操作的回调函数")},onNo:function(){$("#pa-confirm").remove()},onPreview:function(){$("#pa-confirm").remove()}};var c=$.extend({},e,d);var a="<input id='cfm-input' type='text' class='input-text'/>";var b=c.msg==="input"?"<span class='ipt-label'>"+c.label+"</span>"+a:c.msg;$("#cfm-msg").html(b);$("#cfm-msg").ketchup();$("#pa-cancel").text(c.cancelTxt);$("#pa-save").text(c.saveTxt);$("#pa-confirm").show();$("div.btn-bar span#pa-save").off("click").on("click",function(){c.onYes()});$("div.btn-bar span#pa-cancel,#icon_close").off("click").on("click",c.onNo);$("div.btn-bar span#pa-cancel").off("click").on("click",c.onPreview);if(c.hideCancel){$("#pa-cancel").remove()}if(c.hideSave){$("#pa-save").remove()}},saveToTreatTmpl:function(c){var g=treatTmpl_model.dwsTreatmentTmpl;g.templateName=c;g.templateType=$(".template-level .radio.checked").attr("val");var f=$("#table_tp").children("tr");var e=[];f.splice(f.length-1,1);var b=true;$.each(f,function(j){var l=$(f[j]).find("td");var a=l.find("._tp_tab_ip_unit_id").val();var h=l.find("._tp_tab_ip_pro_id").val();if(Utils.isBlank(h)){var k={templateId:null,templateItemId:null,mdTreatmentId:l.find("._tp_tab_ip_pro_id").val(),itemType:l.find(".input-text").attr("val"),groupNum:l.find("._tp_tab_ip_teamnum").val(),mdFrequencyId:MDFREQUENCYID_DEFALUT,remark:l.find("._tp_tab_ip_remark").val(),treatmentPrice:l.find("._tp_tab_ip_price").attr("price"),treatmentUnit:l.find("._tp_tab_ip_pro").attr("unit"),treatmentName:l.find("._tp_tab_ip_pro").val(),frequencyName:l.find("._tp_tab_ip_unit").val(),treatmentQty:l.find("._tp_tab_ip_treatnum").val(),isCombineItem:$(f[j]).attr("is_combine_item")};e.push(k)}else{$.paError("项目必须为选择值");b=false;return}});if(b){var d={dwsTreatmentTmplItemList:e};d.dwsTreatmentTmpl=g;_tpAction.editeDwsTreatmentTmpl(d);config_cache.removeCache(cacheMap.treatmentTmplList)}else{$.paError("不能保存")}},arrayIsRepeat:function(b){b=b.sort();for(var a=0;a<b.length-1;a++){if(b[a]&&b[a]==b[a+1]){return 1}}return -1},clickSubmitBtn:function(){$(".tp_submit").off("click").on("click",function(){if(!$("#table_tp tr:not(:last)").ableToFinish()){return}var a=[];var b=$("#table_tp").children("tr");$.each(b,function(e){a[a.length]=$(b[e]).find("._tp_tab_ip_pro_id").val()});var d=_tpMain.insertDwsTreatPro(tp_acographyID);if(!d){return}_tpMain.showEditeBtn();var c=_tpAction.insertOrUpdateDwsTp(d);_tpMain.init(tp_acographyID);audit_Btn.treat.auditTreatProject(0)})},clinicPrintBtn:function(){var a=this;$(".print:not(.history_print)").off("click").on("click",function(){var b={msg:'<div class="clear" style="margin: 5px 0px -15px 0px; padding-left: 18px;"><div class="print-type"><span class="radio checked" val="1" onclick="_tpMain.checkRadio(this);" style="margin:  0px 40px 0px -20px;">打印未收费</span><span class="radio" val="2" onclick="_tpMain.checkRadio(this);" style="margin: 0px 0px 0px 0px;">打印全部</span></div></div>',label:"打印选项: ",cancelTxt:"预览",saveTxt:"打印",onYes:function(){var d=$(".print-type").find("span.checked").attr("val");if(d==1){var c=0;$("#table_tp").children("tr:visible").each(function(e,f){if($(f).attr("del_flag")==2&&$(f).attr("chargestatus")!=1&&$(f).attr("chargestatus")!=2&&$(f).attr("chargestatus")!=4&&$(f).find(".operate .status span").text()!="已退药"){c++}});if(c==0){$.paWarn("没有未收费的项目，不能打印");return}}else{if(d==2){var c=0;$("#table_tp").children("tr:visible").each(function(e,f){if($(f).attr("chargestatus")!=2&&$(f).find(".operate .status span").text()!="已退药"){c++}});if(c==0){$.paWarn("没有项目可打印");return}}}if(is_jiuzhen){new HmoPrint().doPrint(3,tp_recordId,savedTreatment)}else{new TreatmentReportPrint().doPrintFacade(acographyId,tp_empiId,d,hidePrice)}$("#pa-confirm").remove()},onPreview:function(){var d=$(".print-type").find("span.checked").attr("val");if(d==1){var c=0;$("#table_tp").children("tr:visible").each(function(e,f){if($(f).attr("del_flag")==2&&$(f).attr("chargestatus")!=1&&$(f).attr("chargestatus")!=2&&$(f).attr("chargestatus")!=4&&$(f).find(".operate .status span").text()!="已退药"){c++}});if(c==0){$.paWarn("没有未收费的项目，不能预览");return}}else{if(d==2){var c=0;$("#table_tp").children("tr:visible").each(function(e,f){if($(f).attr("chargestatus")!=2&&$(f).find(".operate .status span").text()!="已退药"){c++}});if(c==0){$.paWarn("没有项目可打印");return}}}if(is_jiuzhen){if(reviewFlag==false){}}else{reviewFlag=true;new TreatmentReportPrint().doPrintFacade(acographyId,tp_empiId,d,hidePrice)}$("#pa-confirm").remove()}};a.paConfirm(b)})},showEditeBtn:function(){$(".submit-btn:not(.tp_audit)").hide();if(treatmentState==1){$("#editeBtn").show();_tpMain.treatProjectHistory.quoteBtnHide()}$("#zlmb_model_btn").hide();$("#treatmentSaveTmplBtn").hide();$("#table_tp ._tp_tab_ip_pro").css("background-color","transparent");$("#table_tp tr ._tp_tab_ip_pro").attr("readonly","readonly");$("#table_tp ._tp_tab_ip_treatnum").css("background-color","transparent");$("#table_tp ._tp_tab_ip_treatnum").attr("readonly","readonly");$("#table_tp ._tp_tab_ip_remark").css("background-color","transparent");$("#table_tp ._tp_tab_ip_remark").attr("readonly","readonly");$("#table_tp ._tp_tab_ip_price").css("background-color","transparent").attr("readonly","readonly");$("#table_tp ._tp_tab_ip_unit").css("background-color","transparent");$(".dropDiv").removeClass("drop");$(".delete").hide();$(".delete").siblings(".status").show();_tpMain.clickEditeBtn();$("#table_tp").children("tr:last").hide();if(hidePrice==1){_tpView.hidePrice()}editState=2;finishPatFlag=true},showSaveBtn:function(){$(".submit-btn:not(.tp_audit)").hide();if(treatmentState==1){$("#saveBtn").show();finishPatFlag=false;$("#treatmentSaveTmplBtn").show();$("#zlmb_model_btn").show();var a=$(".delete");a=$.grep(a,function(b){var c=$(b).parent("td").parent("tr").attr("chargeStatus");return c==0||c==undefined});$(a).siblings(".status").hide();$(a).show();_tpMain.treatProjectHistory.quoteBtnShow()}$("#table_tp tr").each(function(c,d){var b=$(this).attr("chargeStatus");if(b==1||b==2||b==4){}else{$(this).find(".drop .input-text").removeAttr("readonly");$(this).find("._tp_tab_ip_pro").css("background-color","").removeAttr("readonly");$(this).find("._tp_tab_ip_treatnum").css("background-color","").removeAttr("readonly");$(this).find("._tp_tab_ip_remark").css("background-color","").removeAttr("readonly");$(this).find("._tp_tab_ip_unit").css("background-color","")}});$(".dropDiv").addClass("drop");$("input._tp_tab_ip_unit").each(function(){_tpMain.clickDropDownBtn($(this))});$("#table_tp").children("tr:last").show();editState=1;_tpMain.bindTotalPriceUpdate();_tpView.showPrice();if(hidePrice==1){_tpView.hidePrice()}_tpView.refreshDropDown()},clickEditeBtn:function(){$("#editeBtn").off("click").on("click",function(){_tpMain.showSaveBtn()})},checkRadio:function(a){if(!$(a).hasClass("checked")){$(a).addClass("checked");$(a).siblings().removeClass("checked")}},docDropEditAuto:function(){if($("#table_tp .tp_newtr").length<2&&($("#table_tp tr").length>1)){}else{}},getDiscountPermit:function(){var c={};var a={method:"POST",url:ContextClinc_Server+"charge/getDiscountPermit",data:c,dataType:"json",async:false,showMask:true};var b=Utils.myAjaxHandler(a);b.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){var d=e.data;session_cache.setCache("discountPermit",d.disaccount)}else{$.paError(e.errorMessage,null)}}).fail(function(d){$.paError("请求异常",null)}).always(function(){})},checkDiscount:function(){$("#table_tp").on("blur","._tp_tab_ip_price",function(){_tpMain.validateDiscount(this)})},validateDiscount:function(e){var b=true;if(editPrice==1){var d=session_cache.getCache("discountPermit");if(d==-1||d==0){}else{if(e){var c=$(e).attr("price");var a=$(e).val();if(a/c<d/100){$(e).val(c);_tpView.showSumPrice(true);$.paWarn("不能超过最大折扣权限（"+d+"%）");b=false}}else{}}}return b}});var treatPro_view=Class.create({refreshDropDown:function(){$("#table_tp").children("tr").each(function(g,j){var d=$(this);var e=$(this).prev();var i=$(this).find(".can_edit_t input");var f=i.attr("val");var h=i.attr("itemtype");var b=[{id:0,txt:"诊疗"},{id:1,txt:"材料"}];var c={idKey:"id",txtKey:"txt",isNeedClear:false};if(f==null){$(i).WJZSDropdown(b,c,function(l,k){d.find("._tp_tab_ip_pro").val("");d.find("._tp_tab_ip_pro").removeAttr("unit");d.find("._tp_tab_ip_pro").removeAttr("unitname");d.find("._tp_tab_ip_pro_id").val("");d.find("._tp_tab_ip_treatnum").val("");d.find("._tp_tab_ip_treatnum").removeAttr("qty");d.find("._tp_tab_ip_remark").val("");d.find("._tp_tab_ip_price").val("0.00");d.find("._tp_tab_ip_price").removeAttr("price");_tpView.showSumPrice()});if(h==0||h==1){$(i).SetWJZSDropdownSelectedData(h==null?0:h)}else{if(e!=null){var a=e.find(".can_edit_t input").GetWJZSDropdownSelectedData();$(i).SetWJZSDropdownSelectedData(a==null?0:a.id)}else{$(i).SetWJZSDropdownSelectedData(0)}}}else{i.WJZSDropdown(b,c,function(l,k){d.find("._tp_tab_ip_pro").val("");d.find("._tp_tab_ip_pro").removeAttr("unit");d.find("._tp_tab_ip_pro").removeAttr("unitname");d.find("._tp_tab_ip_pro_id").val("");d.find("._tp_tab_ip_treatnum").val("");d.find("._tp_tab_ip_treatnum").removeAttr("qty");d.find("._tp_tab_ip_remark").val("");d.find("._tp_tab_ip_price").val("0.00");d.find("._tp_tab_ip_price").removeAttr("price");_tpView.showSumPrice()});i.SetWJZSDropdownSelectedData(f)}if($(this).find("._tp_tab_ip_pro").attr("readonly")=="readonly"&&g!=$("#table_tp").children("tr").length-1){$(i).cleanDropdownItem()}})},showTreatProList:function(e){var c;var b=0;if(e!=null){c=e.length}if(c>0){var d="";$.each(e,function(k){d=d+'<tr del_flag="2" class="tp_newtr" is_combine_item="'+e[k].IS_COMBINE_ITEM+'" chargeStatus="'+e[k].CHARGESTATUS+'" treatment_id="'+e[k].ITEM_ID+'">                                    <td>                                        <input type="text" class="_tp_tab_ip_teamnum" id="td_tp_teamnum_'+k+'" value="'+(k+1)+'" readonly="readonly" >                                    </td>                                    <td><div class="drop can_edit_t"><input type="text" class="input-text item-type-input-'+(k+1)+'" itemtype="'+e[k].ITEM_TYPE+'"><i class="drop-icon"></i></div></td>                                    <td style="position:relative;">                                        <input  type="text" class="_tp_tab_ip_pro validate(maxlength(50))" id="td_tp_pro_'+k+'" value="'+e[k].ITEMNAME+'" readonly="readonly" placeholder="项目名称/五笔码/拼音码/编码" maxlength="50" unit="'+$.trim(e[k].TREATMENT_UNIT)+'" unitname="'+$.trim(e[k].TREATMENT_UNIT_NAME)+'">										<input  type="hidden" class="_tp_tab_ip_pro_old" value="'+e[k].ITEMNAME+'" readonly="readonly" maxlength="50">                                    <input  type="hidden" class="_tp_tab_ip_pro_id"  value="'+e[k].MD_TREATMENT_ID+'" >                                    	<ul class="easy-resault"></ul>                                    </td>                                    <td>                                        <input type="text" class="_tp_tab_ip_treatnum validate(notspace,required,digits,maxlength(3),range(1,999))" value="'+e[k].TREATNUM+'" placeholder="数量" readonly="readonly" maxlength="3" qty="'+(e[k].DRUG_STORE_UNIT_QTY||"-")+'">                                    </td>                                    <td>                                        <input type="text" class="_tp_tab_ip_remark validate(maxlength(50))" id="td_tp_remark_'+k+'" value="'+(e[k].TPREMARK!=null?e[k].TPREMARK:"--")+'" placeholder="备注" readonly="readonly" maxlength="50">                                    </td>';var j=Utils.changePrice(e[k].PRICE);var h=Utils.changePrice(e[k].PRICE_MODIFY);d=d+'<td class="price">                                    <input type="text" class="_tp_tab_ip_price" id="td_tp_price_'+k+'"  price="'+j+'" value="'+(h==null?j:h)+'" readonly="readonly" >                               </td>';var l="";var g=e[k].CHARGESTATUS;var f=e[k].ISEXECUTE;var n=e[k].ITEM_TYPE;var m=e[k].IS_SEND;if(g==0){l="已提交";d=d+'<td class="operate"><span class="status">'+l+'</span><a href="javascript:;" class="delete" id="td_tp_opetion_'+k+'"  onclick="_tpMain.logicDeleteDwsTpByID(\''+e[k].FTREATPROJECTID+"',this)\">删除</a></td>"}else{if(g!=0){if(g==2){l="<span style='color:red;'>已退费</span>"}else{if(g==4){l="收费中"}else{if(f==0||f==null||f==undefined){l="已收费"}else{if(f==1){l="执行中"}else{l="已执行"}}}}if(n==1){if(m==1){l="已发药"}else{if(m==2){l="<span style='color:red;'>已退药</span>"}else{if(m==3){l="部分退药"}}}}d=d+'<td class="operate"><span class="status">'+l+"</span></td>"}}d=d+"</tr>";if(k==(c-1)){$("#doci-input").val(e[k].EMPLOYEE_NAME).attr("val",e[k].USER_ID);$("#docs-input").val(e[k].EMPLOYEE_NAME).attr("val",e[k].USER_ID)}});$("#table_tp").append(d)}else{$("#doci-input").val(doctorName).attr("val",employeeId)}tp_len=c;if(treatmentState==1){var a=_tpView.showNewATr(c);$("#table_tp").append(a)}else{$("#zlmb_model_btn").hide();$(".tp_submit").hide()}_tpView.showSumPrice(false);_tpView.refreshDropDown()},showNewATr:function(a){var b='<tr del_flag="1" class="tp_newtr" >                        <td class="teamnum">                            <input  type="text" readonly="readonly" class="enterNext _tp_tab_ip_teamnum placeholder="序号" validate(required,number,maxlength(6))" value="'+(tp_len+1)+'"  maxlength="8">                        </td>                        <td><div class="drop can_edit_t"><input type="text" class="input-text item-type-input-'+(tp_len+1)+'"><i class="drop-icon"></i></div></td>                        <td class="_tp_tab_td_pro  input-think" >                            <input class="enterNext _tp_tab_ip_pro validate(maxlength(50))" type="text" placeholder="项目名称/五笔码/拼音码/编码" value="" maxlength="50">							<input class="_tp_tab_ip_pro_old" type="hidden" value="" maxlength="50">                            <input class="_tp_tab_ip_pro_id" type="hidden" value="" >                            <ul class="easy-resault"></ul>                        </td>                        <td class="treatnum" >                            <input class="enterNext _tp_tab_ip_treatnum validate(notspace,required,digits,maxlength(3),range(1,999))" type="text" placeholder="数量"  value=""  maxlength="3"/>                        </td>                        <td class="remark">                        <input class="enterNext _tp_tab_ip_remark validate(maxlength(50))" type="text"  value="" placeholder="备注" maxlength="50">                        </td>                        <td class="price">                            <input class="enterNext _tp_tab_ip_price validate(required,number)" type="text"  value="0.00"  >                        </td>                        <td>                            <a class="delete" href="javascript:;" onclick="_tpMain.logicDeleteDwsTpByID(null,this)">删除</a>                        </td>                    </tr>';tp_len=tp_len+1;return b},removeTableTR:function(b){if($(b).parent().parent().attr("del_flag")=="2"){$(b).parent().parent().remove();var c=$("#table_tp");var a=c.find("._tp_tab_ip_teamnum");a.each(function(d,e){$(this).val(d+1)});_tpView.showSumPrice(true);_tpView.checkSaveTmplBtn();$.paSuccess("删除成功")}else{$.paError("该条不能删除")}},showSumPrice:function(e){var b=0;var a=$("#table_tp").find("._tp_tab_ip_price");var c=$("#table_tp").find("._tp_tab_ip_treatnum");var d=0;if(a.length>0){$.each(a,function(f){d=Utils.accMul($(a[f]).val(),$(c[f]).val());if(d!=null&&d!=""&&Utils.checkIsRate(d)){b=Utils.accAdd(b,d)}})}$("#sumprice_tp").val(Utils.changePrice(b))},showTpTmplBar:function(d){var c=d.dwsTreatProjectTmplList;var b="<dt>个人模版</dt>";var a="<dt>诊所模版</dt>";if(c!=null&&c.length>0){$("#noDataHint").hide();$.each(c,function(e){if(c[e].templateType==3){b=b+'<dd tmplid="'+c[e].templateId+'"  title="'+c[e].templateName+'" class="_dws_tp_dd" >'+c[e].templateName+"</dd>";personalTemplate.push(c[e])}else{a=a+'<dd tmplid="'+c[e].templateId+'" title="'+c[e].templateName+'"  class="_dws_tp_dd" >'+c[e].templateName+"</dd>";clinicTemplate.push(c[e])}});$("#tmpl_tp_persion").append(b);$("#tmpl_tp_platform").append(a)}else{$("#noDataHint").show()}},selectDwsTpTmplItem:function(d){if(d!=null&&d.length>0){var c="";var b=null;$.each(d,function(e){b=Utils.changePrice((isYbClinic==1&&isYbReg!=1&&d[e].ceilingPrice!=null)?d[e].ceilingPrice:d[e].treatmentPrice);c=c+'<tr del_flag="2" class="tp_newtr" is_combine_item="'+d[e].isCombineItem+'">                <td class="teamnum">                    <input  readonly="readonly" type="text" class="_tp_tab_ip_teamnum" value="'+(tp_len+e+1)+'"  maxlength="8">                </td>                <td><div class="drop can_edit_t"><input type="text" class="input-text item-type-input-'+(tp_len+e+1)+'" itemtype="'+d[e].itemType+'"><i class="drop-icon"></i></div></td>                <td class="_tp_tab_td_pro  input-think">                    <input class="_tp_tab_ip_pro validate(maxlength(50))"  type="text" value="'+d[e].treatmentName+'" placeholder="项目名称/五笔码/拼音码/编码" maxlength="50" unit="'+$.trim(d[e].treatmentUnit)+'" unitname="">					<input class="_tp_tab_ip_pro_old"  type="hidden" value="'+d[e].treatmentName+'" maxlength="50">                    <input class="_tp_tab_ip_pro_id" type="hidden" value="'+d[e].mdTreatmentId+'" >                    <ul class="easy-resault"></ul>                </td>                 <td class="treatnum" >                    <input class="_tp_tab_ip_treatnum validate(notspace,required,digits,maxlength(3),range(1,999))" type="text" placeholder="数量" value="'+d[e].treatmentQty+'"  maxlength="3">                 </td>                 <td class="remark">                    <input class="_tp_tab_ip_remark validate(maxlength(50))" type="text" maxlength="50" placeholder="备注" value="'+(d[e].remark!=null?d[e].remark:"--")+'" >                 </td>                 <td class="price">                    <input class="_tp_tab_ip_price validate(required,number)" type="text"  price="'+b+'" value="'+b+'"  >                 </td>                 <td>                    <a class="delete" href="javascript:;" onclick="_tpMain.logicDeleteDwsTpByID(null,this)">删除</a>                </td>            </tr>'});$("#table_tp").append(c);tp_len+=d.length;var a=_tpView.showNewATr(d.length);$("#table_tp").append(a);_tpView.showSumPrice(true);_tpView.refreshDropDown();$("#table_tp tr").ketchup()}else{$.paError("模板数据为空!")}},fillTreamentItem:function(b){if(b!=null&&b.length>0){Utils.addLoadingMaskTo();setTimeout("Utils.removeLoadingMaskFrom()",170);$("#table_tp .tp_newtr:last").remove();var a="";$.each(b,function(d){var c=Utils.changePrice((isYbClinic==1&&isYbReg!=1&&b[d].CEILING_PRICE!=null)?b[d].CEILING_PRICE:b[d].ZX_PRICE);a=a+'<tr del_flag="2" class="tp_newtr" is_combine_item="'+b[d].IS_COMBINE_ITEM+'">                <td class="teamnum">                    <input  readonly="readonly" type="text" class="_tp_tab_ip_teamnum" value="'+(d+1)+'"  maxlength="8">                </td>                <td><div class="drop can_edit_t"><input type="text" class="input-text item-type-input-'+(d+1)+'" itemtype="'+b[d].ITEM_TYPE+'"><i class="drop-icon"></i></div></td>                <td class="_tp_tab_td_pro  input-think">                    <input class="_tp_tab_ip_pro validate(maxlength(50))"  type="text" value="'+b[d].ITEMNAME+'" placeholder="项目名称/五笔码/拼音码/编码" maxlength="50" unit="'+$.trim(b[d].TREATMENT_UNIT)+'" unitname="">					<input readonly="readonly" class="_tp_tab_ip_pro_old"  type="hidden" value="'+b[d].ITEMNAME+'" maxlength="50">                    <input class="_tp_tab_ip_pro_id" type="hidden" value="'+b[d].MD_TREATMENT_ID+'" >                    <ul class="easy-resault"></ul>                </td>                 <td class="treatnum" >                    <input class="_tp_tab_ip_treatnum validate(notspace,required,digits,maxlength(3),range(1,999))" type="text" placeholder="数量" value="'+b[d].TREATNUM+'"  maxlength="3">                 </td>                 <td class="remark">                    <input class="_tp_tab_ip_remark validate(maxlength(50))" type="text" maxlengt="50" placeholder="备注" value="'+(b[d].TPREMARK!=null?b[d].TPREMARK:"--")+'" >                 </td>                 <td class="price">                    <input class="_tp_tab_ip_price" type="text"  price="'+c+'" value="'+c+'"  >                 </td>                 <td>                    <a class="delete" href="javascript:;" onclick="_tpMain.logicDeleteDwsTpByID(null,this)">删除</a>                </td>            </tr>'});$("#table_tp").append(a);$("#table_tp").children("tr").eq($("#table_tp").children("tr").length-1).children("._tp_tab_ip_pro");_tpMain.newATr($("#table_tp").children("tr").eq($("#table_tp").children("tr").length-1).children(),$("#table_tp").children("tr").length);_tpView.showSumPrice(true);_tpView.refreshDropDown();$("#table_tp tr").ketchup()}else{$.paError("模板数据为空!")}$("#table_tp").children("tr").each(function(c){$(this).find("td:eq(0)").find("input").val(c+1)})},checkSaveTmplBtn:function(){var a=$("#table_tp").children("tr");if(a.length>1){$("#treatmentSaveTmplBtn").show()}else{$("#treatmentSaveTmplBtn").hide()}if(treatmentState==2){$("#treatmentSaveTmplBtn").hide()}},hidePrice:function(){$(".price_head").hide();$(".price").hide();$(".total-price-left").hide()},showPrice:function(){$(".price_head").show();$(".price").show();$(".total-price-left").show()},getStatusText:function(b,e,d,a){var c="--";if(b==0){c="已提交"}else{if(b!=0){if(b==2){c="<span style='color:red;'>已退费</span>"}else{if(b==4){c="收费中"}else{if(a==0||a==null||a==undefined){c="已收费"}else{if(a==1){c="执行中"}else{c="已执行"}}}}if(e==1){if(d==1){c="已发药"}else{if(d==2){c="<span style='color:red;'>已退药</span>"}else{if(d==3){c="部分退药"}}}}}}return c}});var treatPro_action=Class.create({insertOrUpdateDwsTp:function(b){var c={};b.empiId=tp_empiId;b.acographyId=tp_acographyID;var a={url:TreatPro_url.treatPro_insertOrUpdateDwsTpNew,dataType:"json",contentType:"application/json",data:JSON.stringify(b),async:false};var d=Utils.myAjaxHandler(a);d.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){c=e.data;$.paSuccess("保存成功")}else{$.paError(e.errorMessage)}}).fail(function(e){$.paError("操作失败!")}).always(function(){});return c},selectDwsTpByAcographyID:function(c){var b={};var a={url:TreatPro_url.treatPro_selectDwsTpByAcographyID,dataType:"json",data:{acographyID:c},async:false,showMask:true};var d=Utils.myAjaxHandler(a);d.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){b=e.data}else{$.paError(e.errorMessage)}}).fail(function(e){$.paError("操作失败!")}).always(function(){});return b},selectDesCTI:function(b){var c={};var a={url:IntentInput_url.intentInput_selectDesTIAE,dataType:"json",data:b,async:false};var d=Utils.myAjaxHandler(a);d.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){c=e.data}else{$.paError(e.errorMessage)}}).fail(function(e){$.paError("操作失败!")}).always(function(){});return c},freData:null,selectDesMDDQ:function(c,f){var a=this;if(a.freData!=null&&f){f(a.freData);return a.freData}var d={};var b={type:"GET",method:"GET",url:ContextClinc_Server+"combox/drugFrequency",dataType:"json",data:null,async:true};var e=Utils.myAjaxHandler(b);e.done(function(g){if(g!=null&&g.errorCode==SUCCESSCODE){a.freData=g.data;if(f){f(a.freData)}}else{$.paError(g.errorMessage)}}).fail(function(g){$.paError("操作失败!")}).always(function(){})},logicDelDwsTpByID:function(b){var c={};var a={url:TreatPro_url.treatPro_logicDelDwsTpByID,dataType:"json",data:{ftreatProjectID:b},async:false};var d=Utils.myAjaxHandler(a);d.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){c=e.data}else{c=0}}).fail(function(e){$.paError("操作失败!")}).always(function(){});return c},selectDwsTpTmpl:function(){var c=config_cache.getCache(cacheMap.treatmentTmplList);if(c==null||c==undefined||c==""){var b={};var a={url:TreatPro_url.treatPro_selectDwsTpTmpl,dataType:"json",data:{},async:false};var d=Utils.myAjaxHandler(a);d.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){b=e.data;config_cache.setCache(cacheMap.treatmentTmplList,b)}else{$.paError(e.errorMessage)}}).fail(function(e){$.paError("操作失败!")}).always(function(){});return b}else{return c}},selectDwsTpTmplItem:function(b){var c={};var a={url:TreatPro_url.treatPro_selectDwsTpTmplItem,dataType:"json",data:{templateId:b},async:false};var d=Utils.myAjaxHandler(a);d.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){c=e.data}else{$.paError(e.errorMessage)}}).fail(function(e){$.paError("操作失败!")}).always(function(){});return c},checkTpTmplName:function(d){var b={};var a={url:tmplEditeUrl.checkTpTmplName,dataType:"json",data:{tmplName:d!=null?d:""},async:false};var c=Utils.myAjaxHandler(a);c.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){b=e.data}else{$.paError(e.errorMessage)}}).fail(function(e){$.paError("操作失败!")}).always(function(){});return b},editeDwsTreatmentTmpl:function(b){var c={};var a={url:tmplEditeUrl.editeDwsTreatmentTmpl,dataType:"json",contentType:"application/json",data:JSON.stringify(b),async:false};var d=Utils.myAjaxHandler(a);d.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){c=e.data;$.paSuccess("操作成功!")}else{$.paError(e.errorMessage)}}).fail(function(e){$.paError("操作失败!")}).always(function(){});return c},});var _tpAction=treatPro_action;var _tpView=treatPro_view;var _tpMain=treatPro_main;$(function(){_tpMain.init(tp_acographyID)});