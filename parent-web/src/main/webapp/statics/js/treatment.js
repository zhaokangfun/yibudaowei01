$(function(){var c=[{id:"0",txt:"否"},{id:"1",txt:"是"}];var b=[{id:0,txt:"启用"},{id:1,txt:"停用"}];var d=[{id:0,txt:"提成比例"},{id:1,txt:"固定金额"}];var a={idKey:"id",txtKey:"txt",isNeedAll:false,isNeedClear:false};$("#royalty").WJZSDropdown(d,a,function(e,f){royaltyValidate()});$("#treatmentPrice").blur(isRoyaltyAmount);$("#status").WJZSDropdown(b,{isNeedAll:true,isNeedClear:false},function(f,g){var e="";e=$(".current a").eq(0).attr("val")?$(".current a").eq(0).attr("val"):-1;getClickCategoryList(e,$("#searchCode").val())});$("#status").SetWJZSDropdownSelectedData(0);$("#btn_add").click(function(){$("#addOrEdit").removeErrorMsg();$("#royalty").SetWJZSDropdownSelectedData(0);royaltyValidate();$("#rateUnit").html("%");$("#royaltyContent").val("");$("#list").hide();$("#addOrEdit").show();clearInput();getCategoryList();initIreatmentCode();var e=$(".current a").eq(0).text();if(e!=""&&e!=null){$("#treatmentCategory").val(e);$("#treatmentCategory").attr("val",$(".current a").eq(0).attr("val"))}$("#ssFlag").checkedItem([{id:"0"}]);$("#addOrEdit").ketchup()});$("#info_cancel").click(function(){$("#addOrEdit").hide();$("#list").show()});$("#searchCode").off("input propertychange").on("input propertychange",function(){searchTreatment()});dropDownInit();getTreatmentCategoryList();getClickCategoryList("-1",$("#searchCode").val());$("#ssFlag").setInputForm(c,{type:"radio",idKey:"id",txtKey:"txt"},function(e){var f=e.id})});function isRoyaltyAmount(){var a=$("#treatmentPrice").val()||0;if($("#royalty").attr("val")==1&&!isNaN(a)){$("#clone").empty().append('<input type="text" class="input-text validate(min(0),max('+a+'), decimal(2),notspace)" id="royaltyContent">').ketchup()}else{if(isNaN(a)){$("#clone").empty().append('<input type="text" class="input-text validate(min(0),max(0), decimal(2),notspace)" id="royaltyContent">').ketchup()}}}function royaltyValidate(){if($("#royalty").attr("val")==0){$("#clone").empty().append('<input type="text" class="input-text validate(min(0),max(100), decimal(2),notspace)" id="royaltyContent">').ketchup();$("#rateUnit").html("%")}else{$("#rateUnit").html("元");isRoyaltyAmount()}}function initIreatmentCode(){var a={method:"GET",url:maindata_url.getUrl().mdcTreatment_getTreatmentCode,dataType:"json",showMask:true};var b=Utils.myAjaxHandler(a);b.done(function(c){$("#treatmentCode").val(c.data)}).fail(function(c){}).always(function(){})}function getTreatmentCategoryList(){var a={method:"POST",url:maindata_url.getUrl().mdcTreatment_getCategoryList,dataType:"json",showMask:true};var b=Utils.myAjaxHandler(a);b.done(function(g){var c=g.data;var d=g.errorMessage;var f=g.errorCode;if(f!="E0000000"){$.paAlert("失败："+f+"，"+d);return}for(var e=0;e<c.length;e++){$(".left-column-menu").append("<li><a onclick='getClickCategoryList(\""+c[e].TREATMENT_TYPE_ID+'","")\' val=\''+c[e].TREATMENT_TYPE_ID+"'>"+c[e].TREATMENT_TYPE_NAME+"</a>")}$(".left-column-menu li a").click(function(){$(this).parent("li").addClass("current").siblings().removeClass("current")})}).fail(function(c){}).always(function(){})}function getClickCategoryList(b,a){$("#treatmentTable").empty();if(a==""||a.length==0){document.getElementById("searchCode").value=""}var c={treatmentTypeId:b,searchCode:a,currentPage:1,diabled:$.trim($("#status").attr("val"))};showListInPage(c)}function showListInPage(a){var b={currentPage:(a==undefined||a==null)?1:a.currentPage,pageSize:20};$.extend(b,a);b.ajaxopts={method:"POST",url:maindata_url.getUrl().mdcTreatment_getClickCategoryList,dataType:"json",contentType:"application/x-www-form-urlencoded",showMask:true};b.callback=function(d){var g=d.data;var h=d.errorMessage;var k=d.errorCode;localStorage.setItem("currentPage",g.currentPage);if(k!="E0000000"){$.paAlert("失败："+k+"，"+h);return}var c=g.dataSource;var f="";$("#treatmentTable").empty();for(var e=0;e<c.length;e++){if(c[e].DISABLED==0){f="停用"}else{if(c[e].DISABLED==1){f="启用"}}var l={0:"DISABLE",1:"ENABLE"};var j="<tr><td width='8%'>"+(e+1)+"</td><td width='14%'>"+c[e].TREATMENT_CODE+"</td><td width='22%'>"+c[e].TREATMENT_NAME+"</td><td width='8%'>"+c[e].TREATMENT_UNIT_NAME+"</td><td width='10%'>"+c[e].TREATMENT_PRICE+"</td><td width='14%'>"+c[e].REMARK+"</td><td><a onclick='updateTreatmentInit(\""+c[e].TREATMENT_ID+"\")' WJPerm='DICT03-UPDATE,CLINICSETUP06-UPDATE'>编辑</a> <a id='"+c[e].TREATMENT_ID+"' onclick='updateDisable(\""+c[e].TREATMENT_ID+'","'+c[e].TREATMENT_PRICE+"\")' WJPerm='DICT03-"+l[c[e].DISABLED]+",CLINICSETUP06-"+l[c[e].DISABLED]+"'>"+f+"</a></td></tr>";j=j.replace(/null/g,"");$("#treatmentTable").append(j)}renderPermissionControl()};$("#my-page").generatePagination(b)}function searchTreatment(){var a=$("#searchCode").val();getClickCategoryList($(".current a").eq(0).attr("val")?$(".current a").eq(0).attr("val"):-1,a)}function getCategoryList(){var a={method:"POST",url:maindata_url.getUrl().mdcTreatment_getCategoryList,dataType:"json",showMask:true};var b=Utils.myAjaxHandler(a);b.done(function(g){var d=g.data;var e=g.errorMessage;var f=g.errorCode;if(f!="E0000000"){$.paAlert("失败："+f+"，"+e);return}var c={idKey:"TREATMENT_TYPE_ID",txtKey:"TREATMENT_TYPE_NAME"};$("#treatmentCategory").WJZSDropdown(d,c,function(h,i){})}).fail(function(c){}).always(function(){})}function dropMenu(){$(".drop-menu li").on("click",function(a){var c=$(this).text();var b=$(this).attr("value");$(this).parents(".drop").find("input").val(c);$(this).parents(".drop").find("input").attr("val",b);$(this).parents(".drop-menu").hide("")})}function keyup(){SetPYValue();SetWBValue()}function SetPYValue(){var b=$("#treatmentName").val();var a=hz2JP(b);$("#pyjm").val(a)}function SetWBValue(){var b=$("#treatmentName").val();var a=hz2WB(b);$("#wbjm").val(a)}function save(){var a=$("#addOrEdit").ableToFinish();if(!a){return}var c=$("#ssFlag").getCheckedData()[0].id;var e={pTreatmentId:$("#pTreatmentId").val(),treatmentId:$("#treatmentId").val(),treatmentCode:$("#treatmentCode").val(),treatmentName:$("#treatmentName").val(),treatmentPrice:$("#treatmentPrice").val(),ceilingPrice:$("#ceilingPrice").val(),treatmentUnit:$.trim($("#treatmentUnit").attr("val")),treatmentTypeId:$.trim($("#treatmentCategory").attr("val")),ssFlag:c,wbjm:$("#wbjm").val(),pyjm:$("#pyjm").val(),remark:$("#remark").val(),royalty:$("#royaltyContent").val(),royaltyStatus:$("#royalty").attr("val")};var b={method:"POST",url:maindata_url.getUrl().mdcTreatmemt_save,data:e,dataType:"json",showMask:true};var d=Utils.myAjaxHandler(b);d.done(function(i){var f=i.errorMessage;var g=i.errorCode;if(g!="E0000000"){$.paAlert(f);return}$.paAlert("保存成功！");$("#addOrEdit").hide();$("#list").show();var h={treatmentTypeId:$(".current a").eq(0).attr("val")?$(".current a").eq(0).attr("val"):-1,searchCode:"",currentPage:localStorage.getItem("currentPage"),diabled:$.trim($("#status").attr("val"))};showListInPage(h)}).fail(function(f){}).always(function(){})}function updateTreatmentInit(a){$("#addOrEdit").removeErrorMsg();$("#list").hide();$("#addOrEdit").show();var b={method:"POST",url:maindata_url.getUrl().mdcTreatment_getEditInfo,data:{treatmentId:a},dataType:"json",showMask:true};var c=Utils.myAjaxHandler(b);c.done(function(g){var d=g.data;var e=g.errorMessage;var f=g.errorCode;if(f!="E0000000"){$.paAlert("失败："+f+"，"+e);return}$("#treatmentId").val(a);$("#treatmentCode").val(d.TREATMENT_CODE);$("#treatmentName").val(d.TREATMENT_NAME);$("#treatmentPrice").val(d.TREATMENT_PRICE);$("#treatmentUnit").SetWJZSDropdownSelectedData(d.TREATMENT_UNIT);$("#treatmentCategory").val(d.TREATMENT_TYPE_NAME);$("#treatmentCategory").attr("val",d.TREATMENT_TYPE_ID);$("#wbjm").val(d.WB_CODE);$("#pyjm").val(d.PY_CODE);$("#remark").val(d.REMARK);$("#ceilingPrice").val(d.CEILING_PRICE);$("#royalty").SetWJZSDropdownSelectedData(0);$("#rateUnit").html("%");if(d.ROYALTY_RATE!=null){royaltyValidate();$("#royaltyContent").val(d.ROYALTY_RATE*10000/100)}else{if(d.ROYALTY_AMOUNT!=null){$("#royalty").SetWJZSDropdownSelectedData(1);$("#rateUnit").html("元");royaltyValidate();$("#royaltyContent").val(d.ROYALTY_AMOUNT)}else{$("#royaltyContent").val("")}}$("#ssFlag").checkedItem([{id:d.IS_SS_FLAG}])}).fail(function(d){}).always(function(){});getCategoryList();$("#addOrEdit").ketchup()}function updateDisable(a,d){var c=null;if($("#"+a).text()=="停用"){$("#"+a).text("启用");$("#"+a).attr("WJPerm","DICT03-ENABLE");c=1}else{if($("#"+a).text()=="启用"){$("#"+a).text("停用");$("#"+a).attr("WJPerm","DICT03-DISABLE");c=0}}renderPermissionControl();var f={treatmentId:a,disabled:c,price:d};var b={method:"POST",url:maindata_url.getUrl().mdcTreatment_updateDisable,data:f,dataType:"json",showMask:true};var e=Utils.myAjaxHandler(b);e.done(function(j){var g=j.errorMessage;var h=j.errorCode;if(h!="E0000000"){$.paAlert("失败："+h+"，"+g);return}$.paAlert("更新状态成功！");var i={treatmentTypeId:$(".current a").eq(0).attr("val")?$(".current a").eq(0).attr("val"):-1,searchCode:"",currentPage:localStorage.getItem("currentPage"),diabled:$.trim($("#status").attr("val"))};showListInPage(i)}).fail(function(g){}).always(function(){})}function dropDownInit(){var a={method:"POST",url:maindata_url.getUrl().mdcTreatmentUnit_getAllEnableTreatmentUnitList,dataType:"json",data:{}};var b=Utils.myAjaxHandler(a);b.done(function(g){var d=g.data;var e=g.errorMessage;var f=g.errorCode;if(f!="E0000000"){$.paError("失败："+f+"，"+e);return}var c={idKey:"treatmentUnitId",txtKey:"treatmentUnitName"};$("#treatmentUnit").WJZSDropdown(d,c,function(h,i){if(i.treatmentUnitName!=="请选择"){$("#treatmentUnit").removeClass("pawjzs-error");$("#treatmentUnit").parent().removeClass("pawjzs-error")}})}).fail(function(c){$.paError("获取数据失败!")}).always(function(){})}function clearInput(){Utils.enableInput($("#treatmentCode"));$("#pTreatmentId").val("");$("#treatmentId").val("");$("#treatmentCode").val("");$("#treatmentName").val("");$("#treatmentPrice").val("");$("#treatmentUnit").SetWJZSDropdownSelectedData("");$("#treatmentCategory").SetWJZSDropdownSelectedData("");$("#wbjm").val("");$("#pyjm").val("");$("#remark").val("");$("#ceilingPrice").val("")};