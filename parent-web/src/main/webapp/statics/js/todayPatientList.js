var ybDJObj,detailTable;
var secondConsultRoom=2;
var userInfo_aclc=config_cache.getCache("medical_user_data");
var logInfoClinicId=config_cache.getCache("medical_user_data").clinicId;
var logInfoUserId=config_cache.getCache("medical_user_data").userId;
var _employee=config_cache.getCache("medical_user_data").employee;
var logEmployeeId=_employee?_employee.employeeId:"";
var logEmployeeName=_employee?_employee.employeeName:"";
var logInfoUserName=config_cache.getCache("medical_user_data").userName;
var logInfoEmploeePostCode=config_cache.getCache("medical_user_data").employee.employeePostCode;
var docEmployeeId=userInfo_aclc.employee.employeeId;
var clinicParams=userInfo_aclc.clinicParams;
var showQueueFlag="2";
for(var index in clinicParams){
	if(clinicParams[index].parameterCode=="1601"){
		showQueueFlag=clinicParams[index].parameterValue
		}
	if(clinicParams[index].parameterCode=="3004"){
		isDoctorCode=clinicParams[index].parameterValue
		}
	}
$(function(){
	ybDJObj=new YbVisitController();
	detailTable=new DetailTable();
	detailTable._init();
	parent.ClinicIndex.prototype.reloadPatDropDown()
	}
);
function DetailTable(){
	this.returnMsg=null;
	this.userInfo_aclc=config_cache.getCache("medical_user_data");
	this.curPage=0;
	this.curDate=new Date().Format("yyyy-MM-dd");
	this.patientListUrls={
			patientList_getWaitPatListInPageByParam:ContextClinc_Server+"patientList/getWaitPatListInPageByParam",
			patientList_getWaitAndVisitPatCountByParam:ContextClinc_Server+"patientList/getWaitAndVisitPatCountByParam",
			patientList_getWaitPatCountByParam:ContextClinc_Server+"patientList/getWaitPatCountByParam",
			patientList_getMyTodayVisitPatList:ContextClinc_Server+"patientList/getMyTodayVisitPatList",
			patientList_getMyTodayVisitPatCount:ContextClinc_Server+"patientList/getMyTodayVisitPatCount",
			docWorkSta_saveVisitPatInfo:ContextClinc_Server+"docWorkSta/saveVisitPatInfo",
			docWorkSta_saveFinishVisitPatInfo:ContextClinc_Server+"docWorkSta/saveFinishVisitPatInfo",
			docWorkSta_saveVisitPatInfoByEmployee:ContextClinc_Server+"docWorkSta/saveVisitPatInfoByEmployee",
			docWorkSta_saveFinishVisitPatInfoByEmployee:ContextClinc_Server+"docWorkSta/saveFinishVisitPatInfoByEmployee",
			docWorkSta_saveVisitPatInfoByParam:ContextClinc_Server+"docWorkSta/saveVisitPatInfoByParam",
			docWorkSta_saveVisitPatQueueInfoByParam:ContextClinc_Server+"docWorkSta/saveVisitPatQueueInfoByParam",
			docWorkSta_saveReVisitPatInfoByParam:ContextClinc_Server+"docWorkSta/saveReVisitPatInfoByParam",
			docWorkSta_saveFinishVisitPatInfoByParam:ContextClinc_Server+"docWorkSta/saveFinishVisitPatInfoByParam"
			};
	this.treatmentTypeEnum={1:"初诊",2:"复诊"};
	this.sexEnum={1:"男",2:"女",3:"保密"};
	this.vistTypeEnum={1:"初诊",2:"复诊"};
	this.treatmentStateValEnum={WAITING:0,VISITING:1,FINISH:2};
	this.clinicDoctors=[]
	}
DetailTable.prototype={
		constructor:DetailTable,_init:function(){
			var b=this;b._bindEvent();
			b.renderAllTabPatCount();
			var a=$("#curDate");
			var d=new Date().Format("yyyy-MM-dd");
			a.datetimepicker({
				lang:"ch",
				format:"Y-m-d",
				maxDate:d,
				timepicker:false,
				mask:false,
				onSelectDate:function(){
					var h=$("#curDate").val();
					if(h){
						b.curDate=h
						}
					else{
						b.curDate=new Date().Format("yyyy-MM-dd")
						}
					b.renderAllTabPatCount();
					b.showDataListInPage()
					}
			});
			a.attr("placeholder",d);
			a.val(d);
			b.curDate=d;
			$("#tab-wait").click();
			b.clickFastBtn();
			b.initPatiNameThinkBox();
			b.initBirthdayDatetimepicker();
			b.clickSaveBtn();b.clickClosedBtn();
			b.nextPatientBtn();
			patientDependOuter.showPatientNoRuleList();
			var g=$("#birthday");
			$("#age, #month").on("change",function(){var q=$.trim($("#age").val());var n=$.trim($("#month").val());if(q==""||isNaN(q)){q=0}if(n==""||isNaN(n)){n=0}var j;var m=$.trim(g.val());if(m!=null&&m!=""){var h=m.split("-");j=parseInt(h[2])}var p=Utils.calcPatientBirthday(q,n,j);p=p.replace(/\-/g,"/");if(new Date(p).getDate()==p.substring(p.length-2)){p=p.replace(/\//g,"-");g.val(p)}else{var i=p.split("/");var k=new Date();var l=k.getMonth()+1;var o=k.getDate();l=(l>9?l:"0"+l);o=(o>9?o:"0"+o);p=i[0]+"-"+l+"-"+o;g.val(p)}g.removeClass("pawjzs-error");g.parent().removeClass("pawjzs-error")});g.on("blur",function(){var i=$.trim(g.val());var h=Utils.calcPatientAge(i);if(h!=""){var j=h.split(",");$("#age").val(j[0]!=0&&j[0]!=null?j[0]:"");$("#month").val(j[1]!=0&&j[1]!=null?j[1]:"");$("#age").removeClass("pawjzs-error");$("#month").removeClass("pawjzs-error")}});var f=config_cache.getCache("medical_user_data");var c=f.clinicParams;for(var e in c){if(c[e].parameterCode=="3018"){secondConsultRoom=c[e].parameterValue}}},_bindEvent:function(){var a=this;$("#tab-wait").on("click",function(d){var c=$(this);$("#keyword").val("");c.addClass("cur").siblings().removeClass("cur");a.renderTabPatCount(c);a.showDataListInPage()});$("#tab-consult").on("click",function(d){var c=$(this);$("#keyword").val("");c.addClass("cur").siblings().removeClass("cur");a.renderTabPatCount(c);a.showDataListInPage()});$("#tab-finish").on("click",function(d){var c=$(this);$("#keyword").val("");c.addClass("cur").siblings().removeClass("cur");a.renderTabPatCount(c);a.showDataListInPage()});var b=$("#curDate");$(".t-pre").on("click",function(){var c=b.val();var d=a.calcPreAftDate("",c);b.val(d);a.curDate=d;a.renderAllTabPatCount();a.showDataListInPage()});$(".t-aft").on("click",function(){var c=b.val();var d=a.calcPreAftDate("add",c);b.val(d);a.curDate=d;a.renderAllTabPatCount();a.showDataListInPage()});$("#search_btn").on("click",function(){a.renderAllTabPatCount();a.showDataListInPage()});$(document).keyup(function(c){if(c.keyCode==13){a.renderAllTabPatCount();a.showDataListInPage()}});$("#clear_data").on("click",function(){a.cleanFastData()})},showDataListInPage:function(b){var a=this;var d="";var c={};if($("#tab-wait").is(".cur")){d=a.patientListUrls.patientList_getWaitPatListInPageByParam;c={curDate:a.curDate}}else{if($("#tab-consult").is(".cur")){d=a.patientListUrls.patientList_getMyTodayVisitPatList;c={curDate:a.curDate,TREATMENT_STATE:a.treatmentStateValEnum.VISITING}}else{if($("#tab-finish").is(".cur")){d=a.patientListUrls.patientList_getMyTodayVisitPatList;c={curDate:a.curDate,TREATMENT_STATE:a.treatmentStateValEnum.FINISH}}}}c.keyword=Utils.trimObj($("#keyword").val());var e={curPage:(b==undefined||b==null)?1:b.currentPage,pageSize:12,params:c,currentPageKey:"curPage"};e.ajaxopts={url:d,dataType:"json",contentType:"application/json",showMask:true};e.callback=function(j){var f=j.data.dataSource;var g=j.errorMessage;var i=j.errorCode;if(i!="E0000000"){$.paError("失败："+i+"，"+g);return}var h=$("#dataList");a.renderPatListTable(f,h);$("#pageControll").empty();a.curPage=j.data.currentPage;window.parent.SetWinSize()};$("#my-page").generatePagination(e)},renderPatListTable:function(s,r){var e=this;r.empty();if(s.length==0){$("#nothing").removeClass("hide");return}else{$("#nothing").addClass("hide")}for(var p=0;p<s.length;p++){var m=$("#box_template").clone(true).removeAttr("id");var j=s[p];var l=Utils.getPersonAccurateAge(j.PATIENT_BIRTH_DATE);var c=j.PATIENT_NAME;var g=j.ZHENSHI==null?"":j.ZHENSHI;if(j.IS_YB_REG=="1"){c+='<span style="font-size:14px;color: #ffffff;">[医保]</span>'}m.find(".patient_name").html(c);if(secondConsultRoom==1){m.find(".zhenshi").html(g)}m.find(".patient_ageOrsex").html(l+"&nbsp;"+e.sexEnum[j.PATIENT_SEX]);m.find(".treatment_information").html(e.vistTypeEnum[j.VISIT_TYPE]||"");var k=j.DOCTOR_ID||"";var f=j.DOCTOR_NAME||"";m.find(".docter_information").html(f);m.find(".patient_date").text(j.PATIENT_NAME||"");if($("#tab-finish").is(".cur")){m.find(".patient_date").text(new Date(j.MODIFY_DATE).Format("yyyy-MM-dd HH:mm:ss"))}else{m.find(".patient_date").text(new Date(j.ADD_DATE).Format("yyyy-MM-dd HH:mm:ss"))}var n=m.find(".s_box_top");n.data("ACOGRAPHY_ID",j.ACOGRAPHY_ID);n.data("ACOGRAPHY_SERIAL_NO",j.ACOGRAPHY_SERIAL_NO);n.data("EMPI_ID",j.EMPI_ID);n.data("TRIAGE_ID",j.TRIAGE_ID);n.data("RECORD_ID",j.APPT_RECORD_ID);n.data("PATIENT_NAME",j.PATIENT_NAME);n.data("PATIENT_SEX",j.PATIENT_SEX);n.data("PATIENT_AGE",l);n.data("PATIENT_SEX_NAME",e.sexEnum[j.PATIENT_SEX]);n.data("PAYMENT_TYPE_ID",j.PAYMENT_TYPE_ID);n.data("PAYMENT_TYPE_NAME",j.PAYMENT_TYPE_NAME);n.data("TREATMENT_STATE",j.TREATMENT_STATE);n.data("MODIFY_DATE",j.MODIFY_DATE);n.data("DEPARTMENT_ID",j.DEPARTMENT_ID);n.data("IS_YB_REG",j.IS_YB_REG);n.data("DOCTOR_ID",j.DOCTOR_ID);n.data("ADD_USER",j.ADD_USER);n.data("MDREC_NO","");n.on("click",function(){if(logInfoEmploeePostCode=="ZW26001"){e.viewPat($(this),logEmployeeId,logEmployeeName)}else{if(k&&f){e.viewPat($(this),k,f)}else{e.viewPat($(this),"","")}}});var b=null;if($("#tab-wait").is(".cur")){b=$("#box_bot_template1").clone(true).removeAttr("id");var d=b.find(".accepts");d.data("EMPI_ID",j.EMPI_ID);d.data("ACOGRAPHY_SERIAL_NO",j.ACOGRAPHY_SERIAL_NO);d.data("TRIAGE_ID",j.TRIAGE_ID);d.data("RECORD_ID",j.APPT_RECORD_ID);d.data("PATIENT_NAME",j.PATIENT_NAME);d.data("PATIENT_SEX",j.PATIENT_SEX);d.data("PATIENT_AGE",l);d.data("PATIENT_SEX_NAME",e.sexEnum[j.PATIENT_SEX]);d.data("PAYMENT_TYPE_ID",j.PAYMENT_TYPE_ID);d.data("PAYMENT_TYPE_NAME",j.PAYMENT_TYPE_NAME);d.data("VISIT_TYPE",j.VISIT_TYPE);d.data("DEPARTMENT_ID",j.DEPARTMENT_ID);d.data("DOCTOR_ID",j.DOCTOR_ID);d.data("MDREC_NO","");d.data("IS_YB_REG",j.IS_YB_REG);d.on("click",function(){if(isDoctorCode==1){if(logInfoEmploeePostCode!="ZW26001"){$.paWarn("仅医生可接诊！");return}}if(secondConsultRoom==1){var i=$(this).parents(".s_box").find(".zhenshi").text();if(i==""){$.paWarn("暂未分配诊室，请稍候再接诊！");return}}if(logInfoEmploeePostCode=="ZW26001"){e.visitPatient($(this),logEmployeeId,logEmployeeName)}else{if(k&&f){e.visitPatient($(this),k,f)}else{e.visitPatient($(this),"","")}}})}else{if($("#tab-consult").is(".cur")){b=$("#box_bot_template2").clone(true).removeAttr("id");var a=b.find(".continueCure");a.data("ACOGRAPHY_ID",j.ACOGRAPHY_ID);a.data("ACOGRAPHY_SERIAL_NO",j.ACOGRAPHY_SERIAL_NO);a.data("EMPI_ID",j.EMPI_ID);a.data("TRIAGE_ID",j.TRIAGE_ID);a.data("RECORD_ID",j.APPT_RECORD_ID);a.data("PATIENT_NAME",j.PATIENT_NAME);a.data("PATIENT_SEX",j.PATIENT_SEX);a.data("PATIENT_AGE",l);a.data("PATIENT_SEX_NAME",e.sexEnum[j.PATIENT_SEX]);a.data("PAYMENT_TYPE_ID",j.PAYMENT_TYPE_ID);a.data("PAYMENT_TYPE_NAME",j.PAYMENT_TYPE_NAME);a.data("TREATMENT_STATE",j.TREATMENT_STATE);a.data("DEPARTMENT_ID",j.DEPARTMENT_ID);a.data("MDREC_NO","");a.data("IS_YB_REG",j.IS_YB_REG);a.data("DOCTOR_ID",j.DOCTOR_ID);a.data("ADD_USER",j.ADD_USER);a.on("click",function(){e.viewPat($(this),k,f)});var h=b.find(".cureEnd");h.data("ACOGRAPHY_ID",j.ACOGRAPHY_ID);h.data("ACOGRAPHY_SERIAL_NO",j.ACOGRAPHY_SERIAL_NO);h.data("TRIAGE_ID",j.TRIAGE_ID);h.data("RECORD_ID",j.APPT_RECORD_ID);h.data("IS_YB_REG",j.IS_YB_REG);h.data("DOCTOR_ID",j.DOCTOR_ID);h.data("ADD_USER",j.ADD_USER);h.on("click",function(){if($(this).data("DOCTOR_ID")!=logEmployeeId&&($(this).data("ADD_USER")!=logEmployeeId)){$.paWarn("该患者正在接受治疗！");return}e.finishPatVisit($(this))})}else{if($("#tab-finish").is(".cur")){b=$("#box_bot_template3").clone(true).removeAttr("id");var t=b.find(".followup");t.data("ACOGRAPHY_ID",j.ACOGRAPHY_ID);t.data("ACOGRAPHY_SERIAL_NO",j.ACOGRAPHY_SERIAL_NO);t.data("EMPI_ID",j.EMPI_ID);t.data("IS_YB_REG",j.IS_YB_REG);t.on("click",function(){e.followUpPatient($(this))});var q=b.find(".againClinical");var o=j.MODIFY_DATE;var u=new Date();if(u<=o+86400000){q.data("ACOGRAPHY_ID",j.ACOGRAPHY_ID);q.data("ACOGRAPHY_SERIAL_NO",j.ACOGRAPHY_SERIAL_NO);q.data("EMPI_ID",j.EMPI_ID);q.data("TRIAGE_ID",j.TRIAGE_ID);q.data("RECORD_ID",j.APPT_RECORD_ID);q.data("PATIENT_NAME",j.PATIENT_NAME);q.data("PATIENT_SEX",j.PATIENT_SEX);q.data("PATIENT_AGE",l);q.data("PATIENT_SEX_NAME",e.sexEnum[j.PATIENT_SEX]);q.data("DEPARTMENT_ID",j.DEPARTMENT_ID);q.data("MDREC_NO","");q.data("IS_YB_REG",j.IS_YB_REG);q.on("click",function(){if(isDoctorCode==1){if(logInfoEmploeePostCode!="ZW26001"){$.paWarn("仅医生可接诊！");return}}if(k&&f){e.reVisitPatient($(this),k,f)}else{e.reVisitPatient($(this),"","")}})}else{q.remove();t.attr("class","accepts")}}}}m.append(b);if(j.ARREARS=="1"){m.append('<span class="pick-status pick-before">欠费</span>')}r.append(m)}},renderAllTabPatCount:function(){var a=this;var c={curDate:a.curDate};var e={params:c};var b={url:a.patientListUrls.patientList_getWaitAndVisitPatCountByParam,dataType:"json",contentType:"application/json",data:JSON.stringify(e)};var d=Utils.myAjaxHandler(b);d.done(function(i){var f=i.data;var g=i.errorMessage;var h=i.errorCode;if(h!="E0000000"){$.paError("失败："+h+"，"+g);return}$("#tab-wait-count").html("("+(f.waitCount==null?0:f.waitCount)+")");$("#tab-consult-count").html("("+(f.visitCount==null?0:f.visitCount)+")");$("#tab-finish-count").html("("+(f.finishCount==null?0:f.finishCount)+")")}).fail(function(f){$.paError("获取数据失败!")}).always()},renderTabPatCount:function(b){var a=this;var e={};var d="";if(b.attr("id")=="tab-wait"){d=a.patientListUrls.patientList_getWaitPatCountByParam;e={curDate:a.curDate,}}else{if(b.attr("id")=="tab-consult"){d=a.patientListUrls.patientList_getMyTodayVisitPatCount;e={curDate:a.curDate,TREATMENT_STATE:a.treatmentStateValEnum.VISITING}}else{if(b.attr("id")=="tab-finish"){d=a.patientListUrls.patientList_getMyTodayVisitPatCount;e={curDate:a.curDate,TREATMENT_STATE:a.treatmentStateValEnum.FINISH}}}}var g={params:e};var c={url:d,dataType:"json",data:JSON.stringify(g),contentType:"application/json"};var f=Utils.myAjaxHandler(c);f.done(function(k){var i=k.data;var h=k.errorMessage;var j=k.errorCode;if(j!="E0000000"){$.paError("失败："+j+"，"+h);return}if(b.attr("id")=="tab-wait"){$("#"+b.attr("id")+"-count").html("("+(i==null?0:i)+")")}else{if(b.attr("id")=="tab-consult"){$("#"+b.attr("id")+"-count").html("("+(i==null?0:i)+")")}else{if(b.attr("id")=="tab-finish"){$("#"+b.attr("id")+"-count").html("("+(i==null?0:i)+")")}}}}).fail(function(h){$.paError("获取数据失败!")}).always()},visitPatient:function(c,a,g){var b=this;var e={dwsAcography:{empiId:c.data("EMPI_ID"),paymentTypeId:c.data("PAYMENT_TYPE_ID"),paymentTypeName:c.data("PAYMENT_TYPE_NAME"),treatmentType:c.data("VISIT_TYPE"),treatmentState:b.treatmentStateValEnum.VISITING,triageId:c.data("TRIAGE_ID"),recordId:c.data("RECORD_ID"),departmentId:c.data("DEPARTMENT_ID"),acographySerialNo:c.data("ACOGRAPHY_SERIAL_NO")}};if((showQueueFlag=="1")&&(logInfoEmploeePostCode=="ZW26001")){b.refreshQueueStatus(c.data("EMPI_ID"),c.data("TRIAGE_ID"))}var f={url:b.patientListUrls.docWorkSta_saveVisitPatInfoByParam,dataType:"json",data:JSON.stringify(e),contentType:"application/json",showMask:true};var d=Utils.myAjaxHandler(f);d.done(function(h){var k=h.data;var i=h.errorMessage;var j=h.errorCode;if(j!="E0000000"){if(j=="E2SP0113"){$.paError(i)}else{$.paError("失败："+j+"，"+i)}return}if(c!=undefined&&c!=null){parent.$(parent.document).trigger("topGenerateDwsBar",[null,{ACOGRAPHY_ID:k,ACOGRAPHY_SERIAL_NO:c.data("ACOGRAPHY_SERIAL_NO"),TRIAGE_ID:c.data("TRIAGE_ID"),RECORD_ID:c.data("RECORD_ID"),EMPI_ID:c.data("EMPI_ID"),PATIENT_NAME:c.data("PATIENT_NAME"),PATIENT_SEX:c.data("PATIENT_SEX"),PATIENT_SEX_NAME:c.data("PATIENT_SEX_NAME"),PATIENT_AGE:c.data("PATIENT_AGE"),TREATMENT_STATE:b.treatmentStateValEnum.VISITING,IS_YB_REG:c.data("IS_YB_REG"),curDate:b.curDate,doctorId:a,doctorName:g}])}}).fail(function(h){$.paError("当前用户不是医生，无法接诊!")})},refreshQueueStatus:function(d,a){var b=this;var f={operateUserId:logInfoUserId,clinicId:logInfoClinicId,empiId:d,triageId:a};var c={method:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"patientList/refreshQueueStatus",dataType:"json",data:JSON.stringify(f),};var e=Utils.myAjaxHandler(c);e.done(function(h){var g=h.errorCode;if(g!="E0000000"){$.paError("排队信息同步失败");return}}).fail(function(g){$.paError("排队信息同步失败!")}).always(function(){})},finishPatVisit:function(b){var a=this;var c={msg:"是否确定完成就诊？",cancelTxt:"取消",saveTxt:"确定",onYes:function(){var e={dwsAcography:{acographyId:b.data("ACOGRAPHY_ID"),triageId:b.data("TRIAGE_ID"),recordId:b.data("RECORD_ID")}};var f={url:a.patientListUrls.docWorkSta_saveFinishVisitPatInfoByParam,dataType:"json",data:JSON.stringify(e),contentType:"application/json",showMask:true};var d=Utils.myAjaxHandler(f);d.done(function(g){var h=g.errorMessage;var i=g.errorCode;if(i!="E0000000"){if(i=="E2SP0113"){$.paError(h)}else{$.paError("失败："+i+"，"+h)}return}if(g.data.openId!=undefined&&g.data.openId!=null&&g.data.openId!=""){a.sendWEIXINMessage(g.data)}$.paSuccess("就诊已完成!");$("#tab-consult").click();a.renderTabPatCount($("#tab-finish"));a.completeQueueVisit()}).fail(function(g){$.paError("结束就诊失败!")})}};$.paConfirm(c)},reVisitPatient:function(c,a,g){var b=this;var e={dwsAcography:{empiId:c.data("EMPI_ID"),recordId:c.data("RECORD_ID"),triageId:c.data("TRIAGE_ID"),acographyId:c.data("ACOGRAPHY_ID"),acographySerialNo:c.data("ACOGRAPHY_SERIAL_NO")}};var f={url:b.patientListUrls.docWorkSta_saveReVisitPatInfoByParam,dataType:"json",data:JSON.stringify(e),contentType:"application/json",showMask:true};var d=Utils.myAjaxHandler(f);d.done(function(h){var i=h.errorMessage;var j=h.errorCode;if(j!="E0000000"){if(j=="E2SP0113"){$.paError(i)}else{$.paError("失败："+j+"，"+i)}return}if(c!=undefined&&c!=null){parent.$(parent.document).trigger("topGenerateDwsBar",[null,{ACOGRAPHY_ID:c.data("ACOGRAPHY_ID"),ACOGRAPHY_SERIAL_NO:c.data("ACOGRAPHY_SERIAL_NO"),TRIAGE_ID:c.data("TRIAGE_ID"),RECORD_ID:c.data("RECORD_ID"),EMPI_ID:c.data("EMPI_ID"),PATIENT_NAME:c.data("PATIENT_NAME"),PATIENT_SEX:c.data("PATIENT_SEX"),PATIENT_SEX_NAME:c.data("PATIENT_SEX_NAME"),PATIENT_AGE:c.data("PATIENT_AGE"),TREATMENT_STATE:b.treatmentStateValEnum.VISITING,IS_YB_REG:c.data("IS_YB_REG"),curDate:b.curDate,doctorId:a,doctorName:g}])}}).fail(function(h){$.paError("重新接诊失败!")})},viewPat:function(e,a,f){var c=this;var d=null;if(e.data("TREATMENT_STATE")==1){d="treatment"}var b=e.data("ACOGRAPHY_ID");if(e!=undefined&&e!=null){parent.$(parent.document).trigger("topGenerateDwsBar",[d,{ACOGRAPHY_ID:b,ACOGRAPHY_SERIAL_NO:e.data("ACOGRAPHY_SERIAL_NO"),RECORD_ID:e.data("RECORD_ID"),EMPI_ID:e.data("EMPI_ID"),PATIENT_NAME:e.data("PATIENT_NAME"),PATIENT_SEX:e.data("PATIENT_SEX"),PATIENT_SEX_NAME:e.data("PATIENT_SEX_NAME"),PATIENT_AGE:e.data("PATIENT_AGE"),TREATMENT_STATE:e.data("TREATMENT_STATE"),PAYMENT_TYPE_ID:e.data("PAYMENT_TYPE_ID"),PAYMENT_TYPE_NAME:e.data("PAYMENT_TYPE_NAME"),VISIT_TYPE:e.data("VISIT_TYPE"),TRIAGE_ID:e.data("TRIAGE_ID"),MODIFY_DATE:e.data("MODIFY_DATE"),DEPARTMENT_ID:e.data("DEPARTMENT_ID"),IS_YB_REG:e.data("IS_YB_REG"),curDate:c.curDate,doctorId:a,doctorName:f}])}},nextPatientBtn:function(){var a=this;if(logInfoEmploeePostCode!="ZW26001"){$("#nextPatientBtn").addClass("dsn");return}if(showQueueFlag=="2"){$("#nextPatientBtn").addClass("dsn");return}$("#nextPatientBtn").removeClass("dsn").off("click").on("click",function(){a.popGetQueueHead()});$("#callPatient").off("click").on("click",function(){a.popCallNextPatientOutdoor()});$("#treatPatient").off("click").on("click",function(){a.popTreatPatient()});$("#callNextPatient").off("click").on("click",function(){a.popCallPatient()})},popGetQueueHead:function(){var a=this;var d={doctorId:docEmployeeId};var b={method:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"nur_queue/call_next",dataType:"json",data:JSON.stringify(d),showMask:true};var c=Utils.myAjaxHandler(b);c.done(function(f){var e=f.errorCode;if(e!="E0000000"){$.paError("获取数据失败");return}a.fillNextPatientPop(f.data)}).fail(function(e){$.paError("获取数据失败!")}).always(function(){})},fillNextPatientPop:function(a){if(!a){$.paWarn("当前无患者候诊");$("#next_treat_patientInfo").attr("doctorName","");$("#next_treat_patientInfo").attr("departmentName","");$("#next_treat_patientInfo").attr("patientName","");$("#next_treat_patientInfo").attr("queueNo","");$("#next_treat_patientInfo").attr("triageId","");$("#next_treat_patientName").text("");$("#next_treat_queueNo").text("");$("#next_treat_doctorid").val("");$("#nextPatientPop").hide();return}$("#next_treat_patientInfo").attr("doctorName",a.doctorName);$("#next_treat_patientInfo").attr("departmentName",a.departmentName);$("#next_treat_patientInfo").attr("patientName",a.patientName);$("#next_treat_patientInfo").attr("queueNo",a.queueNo);$("#next_treat_patientInfo").attr("triageId",a.triageId);$("#next_treat_patientName").text(a.patientName);$("#next_treat_queueNo").text(a.queueNo);$("#next_treat_doctorid").val(a.doctorId);$("#nextPatientPop").show()},popCallNextPatientOutdoor:function(){var a=$("#next_treat_patientInfo").attr("queueNo");if((a=="null")||(!a)){$("#nextPatientPop").hide();$.paWarn("当前无患者候诊");return}var d={queueNo:a,screen:""};var b={method:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"/nur_queue/call_queue",dataType:"json",data:JSON.stringify(d)};var c=Utils.myAjaxHandler(b);c.done(function(f){var e=f.errorCode;if(e!="E0000000"){$.paError("请求呼号失败");return}$.paSuccess("呼号成功")}).fail(function(e){$.paError("请求呼号失败")}).always(function(){})},popTreatPatient:function(){var a=this;var d={triageId:$("#next_treat_patientInfo").attr("triageId")};var b={method:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"patientList/getPatInfoByTriageId",dataType:"json",data:JSON.stringify(d)};var c=Utils.myAjaxHandler(b);c.done(function(f){var e=f.errorCode;if(e!="E0000000"){$.paError("操作失败");return}a.popVisitPatient(f.data)}).fail(function(e){$.paError("获取数据失败!")}).always(function(){})},popVisitPatient:function(c){if(!c){$("#nextPatientPop").hide();$.paWarn("当前无患者候诊");return}var a=this;var d={params:{queueNo:$("#next_treat_patientInfo").attr("queueNo")},dwsAcography:{empiId:c.EMPI_ID,paymentTypeId:c.PAYMENT_TYPE_ID,paymentTypeName:c.PAYMENT_TYPE_NAME,treatmentType:c.VISIT_TYPE,treatmentState:a.treatmentStateValEnum.VISITING,triageId:c.TRIAGE_ID,recordId:c.APPT_RECORD_ID,departmentId:c.DEPARTMENT_ID,acographySerialNo:c.ACOGRAPHY_SERIAL_NO}};var e={url:a.patientListUrls.docWorkSta_saveVisitPatQueueInfoByParam,dataType:"json",data:JSON.stringify(d),contentType:"application/json",showMask:true};var b=Utils.myAjaxHandler(e);b.done(function(f){var i=f.data;var g=f.errorMessage;var h=f.errorCode;if(h!="E0000000"){if(h=="E2SP0113"){$.paError(g)}else{$.paError("失败："+h+"，"+g)}return}if(c!=undefined&&c!=null){parent.$(parent.document).trigger("topGenerateDwsBar",[null,{ACOGRAPHY_ID:i,ACOGRAPHY_SERIAL_NO:c.ACOGRAPHY_SERIAL_NO,TRIAGE_ID:c.TRIAGE_ID,RECORD_ID:c.APPT_RECORD_ID,EMPI_ID:c.EMPI_ID,PATIENT_NAME:c.PATIENT_NAME,PATIENT_SEX:c.PATIENT_SEX,PATIENT_SEX_NAME:a.sexEnum[c.PATIENT_SEX],PATIENT_AGE:Utils.getPersonAccurateAge(c.PATIENT_BIRTH_DATE),TREATMENT_STATE:a.treatmentStateValEnum.VISITING,IS_YB_REG:c.IS_YB_REG,curDate:a.curDate}])}}).fail(function(f){$.paError("保存接诊记录失败!")})},completeQueueVisit:function(){var a=this;var d={doctorId:docEmployeeId,clinicId:logInfoClinicId};var b={method:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"patientList/completeQueueVisit",dataType:"json",data:JSON.stringify(d),showMask:true};var c=Utils.myAjaxHandler(b);c.done(function(f){var e=f.errorCode;if(e!="E0000000"){$.paError("排队信息同步失败");return}}).fail(function(e){$.paError("排队信息同步失败!")}).always(function(){})},popCallPatient:function(){var a=this;var d={queueNo:$("#next_treat_patientInfo").attr("queueNo"),skieReason:""};var b={method:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"nur_queue/skip_patient",dataType:"json",data:JSON.stringify(d)};var c=Utils.myAjaxHandler(b);c.done(function(f){var e=f.errorCode;if(e!="E0000000"){$.paError("操作失败");return}$("#tab-wait").click();a.popGetQueueHead()}).fail(function(e){$.paError("获取数据失败!")}).always(function(){})},clickFastBtn:function(){var a=this;$("#tab-fast").off("click").on("click",function(){a.initClinicDoctors();$(".layui-layer").remove();$("#dialog").show().ketchup()})},initPatiNameThinkBox:function(){var d=this;var b={columns:[{display:"姓名",dataKey:"NAME",width:60},{display:"性别",dataKey:"PATIENTSEX",width:30},{display:"年龄",dataKey:"BIRTHDATEANDAGE",width:115},{display:"手机",dataKey:"MOBILEPHONENUMBER",width:100}],selectFirst:true,formatResult:function(e){return e.NAME},matchContains:"word",autoFill:false,ajaxOptions:{method:"POST"},multiple:false,multipleSeparator:", ",highlight:function(f,e){return f.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+e.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:180,canedit:true};if(cacheUtils.isChainClinic()){var c=0;b.columns[c].width=45;b.columns[++c].width=25;b.columns[++c].width=115;b.columns[++c].width=95;b.columns[++c]={display:"建档分店",dataKey:"CLINICNAME",width:95};b.width=520}else{b.width=415}var a=ContextClinc_Server+"patient/selectPatientListByPatName";$("#patiName").autocomplete(a,b).result(function(e,g,f){var h=g.EMPIID;d.appendPatientInfo(h)})},appendPatientInfo:function(d){var e=this;var c={select:1};var a={method:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"patient/selectPatientDetailInfo/"+d,dataType:"json",data:JSON.stringify(c)};var b=Utils.myAjaxHandler(a);b.done(function(g){var f=g.errorCode;if(f!="E0000000"){$.paError("获取数据失败");return}e.fillPatiInfo(g.data)}).fail(function(f){$.paError("获取数据失败!")}).always(function(){})},fillPatiInfo:function(d){var f=this;var c=d.keyPatientInfo;$("#patiName").attr("patientID",c.empiId);$("#patiName").attr("readOnly",true);if(c.mobilePhoneNumber&&c.mobilePhoneNumber!=""){$("#moblieNum").attr("readOnly",true)}$("#birthday").attr("readOnly",true);$("#remove_member").show();$("#patiName").val(c.patientName||"");$("#sex_warpper").find("span[val='"+c.patientGender+"']").addClass("checked").siblings("span").removeClass("checked");var b=Utils.timeStampToDateStr(c.birthDate,7);$("#birthday").val(b);var a=Utils.calcPatientAge(b);if(a!=""){var e=a.split(",");$("#age").val(e[0]);$("#month").val(e[1]);$("#age").removeClass("pawjzs-error");$("#month").removeClass("pawjzs-error");$("#birthday").removeClass("pawjzs-error");$("#birthday").parent().removeClass("pawjzs-error")}$("#moblieNum").val(c.mobilePhoneNumber)},setSelectIdValue:function(d,c){var a=$("#"+d);var b=a.parent().find("li[value='"+c+"']").text();a.val(b);a.attr("val",c)},initSexDropDwon:function(){var a=[{id:"1",txt:"男"},{id:"2",txt:"女"},{id:"3",txt:"保密"}];$("#sex").WJZSDropdown(a,null,function(b,c){})},initBirthdayDatetimepicker:function(){$("#birthday").datetimepicker({lang:"ch",format:"Y-m-d",maxDate:new Date().Format("yyyy-MM-dd"),timepicker:false,mask:false,onShow:function(){},onSelectDate:function(){$("#birthday").trigger("blur")}}).on("keypress",function(){var a=$(this);var b=a.val();if(b!=null&&b.length==4){a.val(b+"-")}else{if(b.length==7){a.val(b+"-")}}})},clickSaveBtn:function(){var a=this;$(".patientInfo_submit").off("click").on("click",function(){var d=$("#dialog").ableToFinish();if(!d){return}var f=$("#receptionDoctor").attr("val");var c=$("#receptionDoctor").val();var e=false;if(a.userInfo_aclc&&a.userInfo_aclc.employee&&a.userInfo_aclc.employee.employeePostCode=="ZW26001"){e=true}if(!f){if(e){f=logEmployeeId;c=logEmployeeName}else{$("#receptionDoctor").SelectWJZSDropdownFirstItem();f=$("#receptionDoctor").attr("val");c=$("#receptionDoctor").val()}}var b={empiId:$("#patiName").attr("patientID"),ruleId:patientDependOuter.getPatientRuleId(),patientName:$("#patiName").val(),patientBirthDate:$("#birthday").val(),patientGender:$("#sex_warpper").find("span.checked").attr("val"),mobilePhoneNumber:$("#moblieNum").val(),clinicId:a.userInfo_aclc.clinicId,doctorId:f,doctorName:c,editFlag:"add"};a.submitDataToDB(b)})},submitDataToDB:function(b){var d=this;var a={url:ContextClinc_Server+"empi/fastRigiste",dataType:"json",data:b,showMask:true};var c=Utils.myAjaxHandler(a);c.done(function(e){if("E0000000"==e.errorCode){$("#dialog").hide();parent.$(parent.document).trigger("topGenerateDwsBar",["treatment",{ACOGRAPHY_ID:e.data.acographyId,RECORD_ID:null,EMPI_ID:e.data.empiId,PATIENT_NAME:$("#patiName").val(),PATIENT_SEX:$("#sex_warpper").find("span.checked").attr("val"),PATIENT_SEX_NAME:d.sexEnum[""+$("#sex_warpper").find("span.checked").attr("val")+""],PATIENT_AGE:Utils.getPersonAccurateAge($("#birthday").val()),TREATMENT_STATE:1,PAYMENT_TYPE_ID:null,PAYMENT_TYPE_NAME:null,VISIT_TYPE:1,TRIAGE_ID:e.data.triageId}])}else{}}).fail(function(e){}).always(function(){})},followUpPatient:function(a){parent.$(parent.document).trigger("topCross",["followup_management","FOLLOWUP03","?empiId="+a.data("EMPI_ID")+"&acographyId="+a.data("ACOGRAPHY_ID")])},clickClosedBtn:function(){var a=this;$("#dialog .close").off("click").on("click",function(){a.cleanFastData();$(".popfast").hide()})},cleanFastData:function(){$("#patiName").removeAttr("readOnly");$("#moblieNum").removeAttr("readOnly");$("#patiName").removeAttr("patientID");$(".popcontent .input-text").val("");$(".popcontent .input-text").removeClass("pawjzs-error");$("#birthday").parent().removeClass("pawjzs-error");$("#receptionDoctor").removeAttr("val")},isDepartmentShow:function(){var b=this;var a=b.userInfo_aclc.department;if(Utils.isBlank(a)){$("#departmentDiv").hide();$("#department").removeClass("validate(required)")}else{$("#departmentDiv").show();$("#department").addClass("validate(required)");b.initDepartmentDrop()}},initDepartmentDrop:function(){var a={url:ContextClinc_Server+"mdcDepartment/selectListForClinic",dataType:"json"};var b=Utils.myAjaxHandler(a);b.done(function(d){if("E0000000"==d.errorCode){var c={idKey:"DEPARTMENT_ID",txtKey:"DEPARTMENT_NAME"};$("#department").WJZSDropdown(d.data,c,function(e,f){})}else{}}).fail(function(c){}).always(function(){})},calcPreAftDate:function(h,c){var d=new Date(c.replace(/-/g,"/"));var f=new Date();var i=null;var a=parseInt(Math.abs(f-d)/1000/60/60/24);if(h==="add"){if(a>0){i=new Date(d.setDate(d.getDate()+1))}else{i=d}}else{i=new Date(d.setDate(d.getDate()-1))}var b=i.getMonth()+1;var e=b>9?b:"0"+b;var g=i.getDate()>9?i.getDate():"0"+i.getDate();return i.getFullYear()+"-"+e+"-"+g},sendWEIXINMessage:function(e){if(e){var g=Utils.trimObj(e.clinicName);var b=Utils.trimObj(e.addressName);var a=Utils.trimObj(e.visitName);var c=Utils.trimObj(e.openId);var h=Utils.trimObj(e.acographySerialNum);var i=Utils.trimObj(e.payMoney);var d=Utils.trimObj(e.addDate);if(g&&b&&h&&i&&a&&d&&c){var f={clinicName:g,addressName:b,acographySerialNum:h,payMoney:i,visitName:a,addDate:d,openId:c};var k={type:"POST",contentType:"application/json; charset=utf-8",url:WXServicePath+"TempNoPay",data:JSON.stringify(f),dataType:"json"};var j=Utils.myAjaxHandler(k);j.done(function(l){if(l){}}).fail(function(l){}).always(function(){})}}},initClinicDoctors:function(){var c=this;if(c.clinicDoctors&&c.clinicDoctors.length==0){var a={method:"GET",url:ContextClinc_Server+"reception/queryClinicDoctors",dataType:"json",data:{}};var b=Utils.myAjaxHandler(a);b.done(function(d){if(d.errorCode==SUCCESSCODE){c.clinicDoctors=d.data;c.setDocDropdown()}}).fail(function(d){}).always(function(){})}else{c.setDocDropdown()}},setDocDropdown:function(){var e=this;var d=false;if(e.userInfo_aclc&&e.userInfo_aclc.employee&&e.userInfo_aclc.employee.employeePostCode=="ZW26001"){d=true}if(!(e.clinicDoctors&&e.clinicDoctors.length>0)&&!d){e.clinicDoctors=[{USER_ID:e.userInfo_aclc.userId,EMPLOYEE_NAME:e.userInfo_aclc.employee.employeeName}]}var b={idKey:"USER_ID",txtKey:"EMPLOYEE_NAME",isNeedClear:false,isNeedThink:true};var c=$("#receptionDoctor");if(e.clinicDoctors!=null&&e.clinicDoctors.length>0){for(var a in e.clinicDoctors){if(!e.clinicDoctors[a].EMPLOYEE_NAME){e.clinicDoctors.splice(a,1)}}c.WJZSDropdown(e.clinicDoctors,b,function(f,g){})}if(d){$("#receptionDoctor").SetWJZSDropdownSelectedData(e.userInfo_aclc.userId)}else{if(e.clinicDoctors!=null&&e.clinicDoctors.length>0){$("#receptionDoctor").SelectWJZSDropdownFirstItem()}}}};function getBirthDayByAge(b){var e=new Date();var d=e.getFullYear();var a=e.getMonth()+1;var c=e.getDate();d=d-b;return d+"-"+(a<10?"0"+a:a)+"-"+c};
	