var currentPage="1";var docId="";var inDateStart="";var inDateEnd="";var inTypeValue="";var keyWord="";var vendorArr=[];var manufactorArr=[];var selectDrugIds=[];var plat="";var PLAT_CCM="ccm";var validityRequired=false;var dropItem={dropBtnClick:function(a){$("#"+a+" li").on("click",function(b){var c=$(this).text();$(this).parents(".drop").find("input").val(c);$(this).parents(".drop-menu").hide()})}};var inBound={getSearchKeyWord:function(){var a={inDateStart:($("#inDateStart").val()==""?"":$("#inDateStart").val()+" 00:00:00"),inDateEnd:($("#inDateEnd").val()==""?"":$("#inDateEnd").val()+" 23:59:59"),inType:$("#inType").attr("val"),docNum:$("#keyWord").val()};return a},addInboundListhtml:function(c){var b=this;var a="";if("1"==c.STATUS){a+='<tr ondblclick="inboundInfo.infoPageDblClick(this);">'}else{a+="<tr >"}a+='<td width="12%" data-id="'+c.INBOUND_ID+'"> '+c.INBOUND_CODE+"</td>";a+='<td width="10%">'+new Date(c.IN_DATE).Format("yyyy-MM-dd")+"</td>";a+='<td width="8%">'+DICT_VALUE.INTYPE[c.IN_TYPE]+"</td>";a+='<td width="15%">'+checkNullData(c.VENDOR_NAME)+"</td>";a+='<td width="8%">'+checkNullData(c.CREATOR)+"</td>";a+='<td width="8%">'+checkNullData(c.AUDITOR)+"</td>";a+='<td width="8%" style="text-align: right;padding-right:9px;">'+showFormatMoney(c.TOTAL_PRICE)+"</td>";if("0"==c.STATUS){a+='<td width="6%" style="color: red;">'+DICT_VALUE.STATUS[c.STATUS]+"</td>";a+="<td>";if(b.isCanEdit(c.BILL_SOURCE,c.IN_TYPE)){a+='<a href="javascript:void(0);" onclick="inboundEdit.editPageClick(this);">修改</a>'}a+='<a href="javascript:void(0);" onclick="inboundConfirm.confirmPageClick(this);">确认</a>';a+='<a href="javascript:void(0);" onclick="inBound.delInboundDoc(this);">删除</a></td>'}else{if("1"==c.STATUS){a+='<td width="6%">'+DICT_VALUE.STATUS[c.STATUS]+"</td>";a+='<td><a href="javascript:void(0);" onclick="inboundInfo.infoPageClick(this);" >详情</a></td>'}}a+="</tr>";return a},isCanEdit:function(a,b){if(a&&a!=""){if(b=="3"){return false}}return true},delInboundDoc:function(b){var a={msg:"是否确认删除？",cancelTxt:"取消",saveTxt:"确认",onYes:function(){var d=$(b).parents("tr").find("td[data-id]").attr("data-id");var f={docId:d};var c={type:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"inwarehouse/removeInbound",data:JSON.stringify(f),dataType:"json"};var e=Utils.myAjaxHandler(c);e.done(function(g){if("成功"==g.errorMessage){showHaveRegInfo();$.paSuccess("成功",null)}else{$.paError(g.errorMessage,null)}}).fail(function(g){$.paError("请求异常",null)}).always(function(){})}};$.paConfirm(a)}};function showHaveRegInfo(c,d){var a={inDateStart:($("#inDateStart").val()==""?"":$("#inDateStart").val()+" 00:00:00"),inDateEnd:($("#inDateEnd").val()==""?"":$("#inDateEnd").val()+" 23:59:59"),inType:$("#inType").attr("val"),docNum:$("#keyWord").val(),START_DATE:"",EDN_DATE:"",VISIT_NAME:"",currentPage:(c==undefined||c==null)?parseInt(currentPage):c.currentPage,pageSize:10};var b=$.extend({},c,a);b.ajaxopts={showMask:true,url:ContextClinc_Server+"inwarehouse/getInboundPage",type:"POST"};b.callback=function(k){$("#warehousing_table").empty();if(k.errorCode=="E0000000"){var h=k.data;var f=h.dataSource.length;var j={containerId:"my-page",pageCount:h.totalPage,condition:b,callback:showHaveRegInfo};currentPage=h.currentPage;var e=k.data.dataSource;var i="";for(var g=0;g<e.length;g++){i+=inBound.addInboundListhtml(e[g])}$("#warehousing_table").empty();$("#warehousing_table").append(i)}else{$.paError("请求失败:"+k.errorMessage)}};$("#my-page").generatePagination(b)}var drugIndex={initClassify:function(a){var d={content:""};var b={method:"GET",type:"POST",url:ContextClinc_Server+"combox/drugtypes",data:{paramTxt:JSON.stringify(d)},dataType:"json"};var c=Utils.myAjaxHandler(b);c.done(function(e){if("成功"==e.errorMessage){drugIndex.setDrugClassify(e.data,a)}else{$.paError(e.errorMessage,null)}}).fail(function(e){$.paError("请求异常",null)}).always(function(){})},setDrugClassify:function(d,a){if(null==a){return}var c=$("#"+a).find("ul");$("#"+a).find("input").val("全部").attr("val","0");for(var b=0;b<d.length;b++){c.append($("#classifyli").clone(true).removeAttr("id").removeAttr("hidden").attr("value",d[b]["DICT_ITEM_ID"]).text(d[b]["DICT_ITEM_NAME"]))}},getSearchKey:function(){var a={filterTxt:$("#inboundSearchKey").val(),drugPropId:($("#classifyType").attr("val")==0?"":$("#classifyType").attr("val"))};return a},searchDrug:function(c){var e;var a;if(c){e=c;a="drugThinkbox"}else{e=JSON.stringify(this.getSearchKey());a="search_list"}var b={method:"GET",type:"POST",url:ContextClinc_Server+"combox/druginfo/inbound",data:{paramTxt:e},dataType:"json"};var d=Utils.myAjaxHandler(b);d.done(function(h){if(SUCCESSCODE==h.errorCode){$("#"+a+" tr:gt(0)").remove();selectDrugIds=[];var g=h.data;if(g){$("#projecttable tr").each(function(i){var j=$(this);var k=j.attr("data-drug-id");if(k){selectDrugIds.push(k)}});for(var f=0;f<g.length;f++){drugIndex.addDrugListhtml(g[f],a)}}}else{$.paError(h.errorMessage,null)}}).fail(function(f){$.paError("请求异常",null)}).always(function(){})},addDrugListhtml:function(f,b){var c="";if("search_list"==b){var a=f.DRUG_ID;if($.inArray(a,selectDrugIds)!=-1){c+='<tr class="part2 select"  value="'+a+'" data-base-unit-id="'+f.DRUG_BASIC_UNIT_ID+'" >';c+='<td><i onclick="drugIndex.checkBoxDrugSel(this)" class="active"></i></td>'}else{c+='<tr class="part2"  value="'+a+'" data-base-unit-id="'+f.DRUG_BASIC_UNIT_ID+'" >';c+='<td><i onclick="drugIndex.checkBoxDrugSel(this)"></i></td>'}c+='<td data-name="drugTypeName" data-id="'+f.DRUG_PROP_ID+'">'+f.DRUG_TYPE_NAME+"</td>";c+='<td data-name="drugName" data-id="'+f.DRUG_ID+'">'+f.DRUG_NAME+"</td>";c+='<td data-name="drugPackageSpec">'+f.DRUG_PACKAGE_SPEC+"</td>";c+='<td class="dsn" width="70px" data-name="drugStoreUnitName" data-id="'+f.DRUG_STORE_UNIT_ID+'">'+f.DRUG_STORE_UNIT_NAME+"</td>";c+='<td data-name="drugRetailPrice">'+showFormatMoney(f.DRUG_RETAIL_PRICE,"元")+"</td>";c+='<td data-name="drugUnitName">'+f.DRUG_UNIT_NAME+"</td>";var e=f.LAST_INBOUND_PRICE!=""?f.LAST_INBOUND_PRICE:getDrugStorePurchasePrice(f.DRUG_PURCHASE_PRICE,f.DRUG_DISPENSE_UNIT_RATE,f.DRUG_STORE_UNIT_RATE);c+='<td class="dsn" width="105px" data-name="drugPurchasePrice">'+e+"</td>";c+="</tr>"}else{if("drugThinkbox"==b){c+='<tr data-base-unit-id = "'+f.DRUG_BASIC_UNIT_ID+'" >';c+='<td data-name="drugName" data-id="'+f.DRUG_ID+'">'+f.DRUG_NAME+"</td>";c+='<td data-name="drugPackageSpec">'+f.DRUG_PACKAGE_SPEC+"</td>";c+='<td data-name="drugStoreUnitName" data-id="'+f.DRUG_STORE_UNIT_ID+'">'+f.DRUG_STORE_UNIT_NAME+"</td>";c+='<td data-name="drugRetailPrice">'+showFormatMoney(f.DRUG_RETAIL_PRICE,"元")+"</td>";c+="<td>"+f.DRUG_PURCHASE_PRICE+"</td>";c+="</tr>"}}var d=$("#"+b);d.append(c)},getManufactor:function(){if(manufactorArr!=null&&manufactorArr.length>0){return manufactorArr}else{var c="{}";var a={method:"GET",type:"POST",async:false,url:ContextClinc_Server+"combox/factors",data:{paramTxt:c},dataType:"json"};var b=Utils.myAjaxHandler(a);b.done(function(d){if("成功"==d.errorMessage){manufactorArr=d.data}else{$.paError(d.errorMessage,null)}}).fail(function(d){$.paError("请求异常",null)}).always(function(){});return manufactorArr}},getVendor:function(){if(vendorArr!=null&&vendorArr.length>0){return vendorArr}else{var c="{}";var a={method:"GET",type:"GET",async:false,url:ContextClinc_Server+"combox/venders",data:{paramTxt:c},dataType:"json"};var b=Utils.myAjaxHandler(a);b.done(function(d){if("成功"==d.errorMessage){vendorArr=d.data}else{$.paError(d.errorMessage,null)}}).fail(function(d){$.paError("请求异常",null)}).always(function(){});return vendorArr}},setVendor:function(b){if(null==b){return}var c=$("#"+b);if(c){var a={idKey:"VENDOR_ID",txtKey:"VENDOR_NAME",isNeedThink:false};var d=drugIndex.getVendor();c.WJZSDropdown(d,a,function(e,f){})}},checkBoxClick:function(a){$(a).hasClass("active")?$(a).removeClass("active"):$(a).addClass("active")},checkBoxDrugSel:function(c){var b=$(c);var a=b.parent().parent();if(b.hasClass("active")){b.removeClass("active");a.removeClass("select")}else{b.addClass("active");a.addClass("select")}}};var inboundAdd={showAddCreateInBound:function(a,b){inDateStart=$("#inDateStart").val();inDateEnd=$("#inDateEnd").val();inTypeValue=$.trim($("#inType").attr("val"));keyWord=$("#keyWord").val();location.href="inboundedit.html?inDateStart="+inDateStart+"&inDateEnd="+inDateEnd+"&inType="+inTypeValue+"&keyWord="+keyWord+"&currentPage="+currentPage+"&renderFlag="+tempInbound.renderFlag},getDrugInfo:function(b){var d={name:b};var a={type:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"inwarehouse/getInboundPage",data:JSON.stringify(d),dataType:"json",showMask:true};var c=Utils.myAjaxHandler(a);c.done(function(f){if("成功"==f.errorMessage){var e=this.addInboundInfo(f.data);$(".common-table tr:last").before(e);$(".samll-table-box").hide();$("#add-coloum").val("");$("#inboundaddvalidate").ketchup()}else{$.paError(f.errorMessage,null)}}).fail(function(e){$.paError("请求异常",null)}).always(function(){})},addInboundInfo:function(g){var f=$("#clone").clone(true);f.show();f.removeAttr("id");f.removeAttr("hidden");f.removeAttr("value");f.addClass("drugValidate");f.attr("data-base-unit",g.baseUnitId);f.attr("data-drug-id",g.drugId);f.attr("id",g.drugId);f.attr("drug-type",g.drugTypeCode);f.attr("drug-store-rate",g.drugStoreUnitRate);f.attr("drug-dispense-rate",g.drugDispenseUnitRate);f.find("input[name='inQty']").attr("data-id",g.inboundItemId);f.find('td[data-name="drugName"]').text(g.drugName);f.find('td[data-name="drugName"]').attr("data-id",g.drugId);f.find('td[data-name="drugCode"]').text(g.drugCode);f.find('td[data-name="drugPackageSpec"]').text(g.drugPackageSpec);f.find('input[name="inQty"]').addClass("validate(notEmpty,decimal(4),range(0,99999))").val();if(g.inQty){f.find('input[name="inQty"]').val(g.inQty)}f.find('input[name="inQty"]').on("blur",function(){var i=$(this).parents("tr");var m=$.trim($(this).val());var n=$.trim(i.find("input[name='drugInPrice']").val());var l=$.trim(i.find("input[name='drugRetailPrice']").val());var k=i.attr("drug-type");var h=i.attr("drug-store-rate");var j=i.attr("drug-dispense-rate");inboundEdit.calTotalPrice(i,m,n);inboundEdit.calUnitPriceForShow(i,m,n);if(k==103){m=m*h/j}inboundEdit.calDrugRetailPriceTotalForShow(i,m,l)});var b=g.drugStoreUnitName?g.drugStoreUnitName:g.DRUG_STORE_UNIT_NAME;f.find('td[data-name="drugStoreUnitName"]').text(b);f.find('td[data-name="drugStoreUnitName"]').attr("data-id",g.drugStoreUnitId);var d=g.drugPurchasePrice!=null&&g.drugPurchasePrice!="null"?g.drugPurchasePrice:"";f.find('input[name="drugInPrice"]').val(d).addClass("validate(decimal(4),range(0,1000000))");if(g.unitPrice){f.find("input[name='unitPrice']").val(g.unitPrice)}f.find("input[name='drugInPrice']").on("blur",function(){var h=$(this).parents("tr");var j=$.trim($(this).val());var i=$.trim(h.find("input[name='inQty']").val());inboundEdit.calTotalPrice(h,i,j);inboundEdit.calUnitPriceForShow(h,i,j)});f.find("#recipeUnitName").text(b);f.find('input[name="batchNum"]').val();if(g.batchNum){f.find('input[name="batchNum"]').val(g.batchNum)}if(g.manufactorName){f.find("#manufactorUI").val(g.manufactorName)}if(g.productionPlace){f.find("#productionPlace").val(g.productionPlace)}var e=g.DRUG_RETAIL_PRICE?g.DRUG_RETAIL_PRICE:(g.drugRetailPrice?g.drugRetailPrice:0);f.find('input[name="drugRetailPrice"]').addClass("validate(notEmpty,decimal(4),range(0,1000000))").val(e?e:0);f.find("input[name='drugRetailPrice']").on("blur",function(){var i=$(this).parents("tr");var l=$.trim($(this).val());var m=$.trim(i.find("input[name='inQty']").val());var k=i.attr("drug-type");var h=i.attr("drug-store-rate");var j=i.attr("drug-dispense-rate");if(k==103){m=m*h/j}inboundEdit.calDrugRetailPriceTotalForShow(i,m,l)});var a=b;if(g.drugTypeCode==103){a=g.drugUnitName}else{f.find("#productionPlace").hide()}f.find("#drugRetailUnitName").text(a);if(g.DRUG_STORE_UNIT_NAME){f.find("td").eq(3).text(g.DRUG_STORE_UNIT_NAME);f.find("#recipeUnitName").text(g.DRUG_STORE_UNIT_NAME)}if(g.drugRetailPriceTotal){f.find("input[name='drugRetailPriceTotal']").val(g.drugRetailPriceTotal)}if(!g.validDate){f.find('input[name="validity"]').val("")}else{f.find('input[name="validity"]').val(new Date(g.validDate).Format("yyyy-MM-dd"))}var c=f.find("input[name='validity']");c.datetimepicker({lang:"ch",format:"Y-m-d",minDate:new Date().Format("yyyy-MM-dd"),timepicker:false,scrollInput:false,mask:false,onSelectDate:function(h,i){tempInbound.saveTempInbound($(i).parents("tr"),tempInbound.oprationFlag_modifyDeail)},onShow:function(){}}).on("keypress",function(i){var h=$(this);var j=h.val();if(i.which===8){return}if(j!=null&&j.length==4){h.val(j+"-")}else{if(j.length==7){h.val(j+"-")}}}).addClass("validate(date, validity)");if(validityRequired==true){c.parents(".project-date").find(".necessary").removeClass("dsn");c.removeClass("validate(date, validity)").addClass("validate(required, date, validity)")}return f},isValidityRequired:function(){var a={url:ContextClinc_Server+"mdcParameter/getParamValueByCode",data:{code:"1013"},dataType:"json",type:"POST",async:false};var b=Utils.myAjaxHandler(a);b.done(function(c){if(c.errorCode==SUCCESSCODE){validityRequired=c.data==="1"?true:false}else{$.paError(c.errorMessage,null);return}}).fail(function(c){$.paError("请求异常",null)}).always(function(){})}};var inboundInfo={infoPageClick:function(a){var b=$(a).parents("tr").find("td[data-id]").attr("data-id");inDateStart=$("#inDateStart").val();inDateEnd=$("#inDateEnd").val();inTypeValue=$.trim($("#inType").attr("val"));keyWord=$("#keyWord").val();location.href="inbounddetail.html?id="+b+"&inDateStart="+inDateStart+"&inDateEnd="+inDateEnd+"&inType="+inTypeValue+"&keyWord="+keyWord+"&currentPage="+currentPage},getInboundInfo:function(b){var d={docId:b};var a={type:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"inwarehouse/getInboundInfo",data:JSON.stringify(d),dataType:"json"};var c=Utils.myAjaxHandler(a);c.done(function(e){if(SUCCESSCODE==e.errorCode){inboundInfo.setInboundDco(e.data.outbound);inboundInfo.setInboundItem(e.data.items,"inboundItemUI")}else{$.paError(e.errorMessage,null)}}).fail(function(e){$.paError("请求异常",null)}).always(function(){})},setInboundDco:function(c,a){a=(a==null?"inboundDocUI":a);var b=$("#"+a);if(c){b.find("#inDate").text((new Date(c.inDate)).Format("yyyy-MM-dd"));b.find("#inType").text(c.inType!=null?DICT_VALUE.INTYPE[c.inType]:"");b.find("#vendor").text(c.vendorName!=null?c.vendorName:"");b.find("#totalPrice").text(c.totalPrice!=null?showFormatPrice(c.totalPrice):"0");b.find("#creator").text(c.creator);b.find("#remark").text((c.remark==null?"--":c.remark))}else{$.paError("入库单数据为空，无法渲染")}},setInboundItem:function(b,a){var d="";for(var c=0;c<b.length;c++){d+=this.getItemHtml(b[c])}$("#"+a).append(d)},getItemHtml:function(b){var a="";a+="<tr>";a+="<td>"+(b.DRUG_NAME==null?"--":b.DRUG_NAME)+"</td>";a+="<td>"+(b.DRUG_PACKAGE_SPEC==null?"--":b.DRUG_PACKAGE_SPEC)+"</td>";a+="<td>"+(b.IN_QTY==null?"0":b.IN_QTY)+"</td>";a+="<td>"+(b.DRUG_UNIT_NAME==null?"--":b.DRUG_UNIT_NAME)+"</td>";a+="<td>"+(b.DRUG_RETAIL_PRICE==null?"--":b.DRUG_RETAIL_PRICE)+"</td>";a+="<td>"+(b.DRUG_PURCHASE_PRICE==null?"--":b.DRUG_PURCHASE_PRICE)+"</td>";a+="<td>"+(b.BATCH_NUM==null?"--":b.BATCH_NUM)+"</td>";a+="<td>"+(b.VALID_DATE==null?"--":(new Date(b.VALID_DATE)).Format("yyyy-MM-dd"))+"</td>";a+="<td>"+(b.MANUFACTOR_NAME==null?"--":b.MANUFACTOR_NAME)+"</td>";a+="</tr>";return a},infoPageDblClick:function(a){this.infoPageClick($(a).children("td[data-id]"))}};var inboundEdit={delList:[],setDatetimePicker:function(){$(".indate_list").datetimepicker({lang:"ch",format:"Y-m-d",maxDate:new Date().Format("yyyy-MM-dd"),timepicker:false,mask:false,onShow:function(){}})},editPageClick:function(a){var b=$(a).parents("tr").find("td[data-id]").attr("data-id");inDateStart=$("#inDateStart").val();inDateEnd=$("#inDateEnd").val();inTypeValue=$.trim($("#inType").attr("val"));keyWord=$("#keyWord").val();location.href="inboundedit.html?id="+b+"&inDateStart="+inDateStart+"&inDateEnd="+inDateEnd+"&inType="+inTypeValue+"&keyWord="+keyWord+"&currentPage="+currentPage+"&saveFlag="+true},getInboundInfo:function(b){var d={docId:b};var a={type:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"inwarehouse/getInboundInfo",data:JSON.stringify(d),dataType:"json"};var c=Utils.myAjaxHandler(a);c.done(function(h){if(SUCCESSCODE==h.errorCode){if(h.data){var e=h.data.items;if(e){for(var f=0;f<e.length;f++){var g=inboundEdit.getItemHtml(e[f]);$("#lastTr").before(g)}}if(h.data.outbound){inboundEdit.setInboundDco(h.data.outbound)}inboundEdit.getTotalPrice();inboundEdit.setDatetimePicker();$("#inboundeditvalidate").ketchup()}}else{$.paError(h.errorMessage,null)}}).fail(function(e){$.paError("请求异常",null)}).always(function(){})},setInboundDco:function(c,a){a=(a==null?"inboundDocUI":a);var b=$("#"+a);if(c){if(c.inboundId){b.attr("data-id",c.inboundId)}b.find("#inDate").val((new Date(c.inDate)).Format("yyyy-MM-dd"));selectModel.setValue("inType",c.inType);selectModel.setValue("vendor",c.vendorId);if(c.vendorName){b.find("#vendor").val(c.vendorName)}b.find("#invoiceNum").val(c.invoiceNum);b.find("#remark").val((c.remark==null?"--":c.remark));b.find("#totalPrice").val(showFormatPrice(c.totalPrice));if(c.billSource!=null&&c.billSource!=""){$("#chart-info").show();$("#bill-source").attr("bill-source",c.billSource);$("#bill-source").text(c.billSourceCode)}}else{$.paError("入库单数据为空，无法渲染")}},setInboundItem:function(b,a){var d="";for(var c=0;c<b.length;c++){d+=this.getItemHtml(b[c])}$("#thinktr").before(d)},getItemHtml:function(h){var i=$("#clone").clone(true);i.removeAttr("id");i.removeAttr("hidden");i.addClass("drugValidate");i.show();i.attr("data-id",h.INBOUND_ITEM_ID);i.attr("drug-type",h.DRUG_TYPE_CODE);i.attr("drug-store-rate",h.STORE_RATE);i.attr("drug-dispense-rate",h.RECIPE_RATE);i.find('td[data-name="drugCode"]').text(h.DRUG_CODE);i.find('td[data-name="drugName"]').text(h.DRUG_NAME);i.find('td[data-name="drugName"]').attr("data-id",h.DRUG_ID);i.find('td[data-name="drugPackageSpec"]').text(h.DRUG_PACKAGE_SPEC);i.find('input[name="inQty"]').addClass("validate(notEmpty,decimal(4),range(0,99999))").val(h.IN_QTY);i.find('input[name="inQty"]').attr("data-id",h.INBOUND_ITEM_ID);i.find('input[name="inQty"]').on("blur",function(){var m=$(this).parents("tr");var q=$.trim($(this).val());var r=$.trim(m.find("input[name='drugInPrice']").val());var p=$.trim(m.find("input[name='drugRetailPrice']").val());var o=m.attr("drug-type");var l=m.attr("drug-store-rate");var n=m.attr("drug-dispense-rate");inboundEdit.calTotalPrice(m,q,r);inboundEdit.calUnitPriceForShow(m,q,r);if(o==103){q=q*l/n}inboundEdit.calDrugRetailPriceTotalForShow(m,q,p)});i.find('td[data-name="drugStoreUnitName"]').text(h.DRUG_UNIT_NAME);i.find('td[data-name="drugStoreUnitName"]').attr("data-id",h.DRUG_UNIT_ID);i.find('input[name="drugInPrice"]').val(h.DRUG_PURCHASE_STORE_PRICE!=null?h.DRUG_PURCHASE_STORE_PRICE:"");i.find('input[name="drugInPrice"]').on("blur",function(){var l=$(this).parents("tr");var n=$.trim($(this).val());var m=$.trim(l.find("input[name='inQty']").val());inboundEdit.calTotalPrice(l,m,n);inboundEdit.calUnitPriceForShow(l,m,n)});var d=checkNullDefaultZero(h.IN_QTY);var k=checkNullDefaultZero(h.DRUG_PURCHASE_STORE_PRICE);i.attr("in_price",accMul(d,k));i.find('td[data-name="drugUnitName"]').text(h.DRUG_UNIT_NAME);i.find('input[name="unitPrice"]').val(h.UNIT_PRICE);i.find('input[name="batchNum"]').val(h.BATCH_NUM);i.find("#recipeUnitName").text(h.DRUG_STORE_UNIT_NAME);var a=h.DRUG_RETAIL_PRICE?h.DRUG_RETAIL_PRICE:"0";i.find('input[name="drugRetailPrice"]').addClass("validate(required,decimal(4),range(0,1000000))").val(a!=null?a:"");i.find('input[name="drugRetailPrice"]').on("blur",function(){var l=$(this).parents("tr");var m=$.trim($(this).val());var n=$.trim(l.find("input[name='inQty']").val());inboundEdit.calDrugRetailPriceTotalForShow(l,n,m)});var j=checkNullDefaultZero(h.IN_QTY)*checkNullDefaultZero(a);if(h.DRUG_TYPE_CODE==103){i.find('input[name="drugRetailPriceTotal"]').val(j==null?0:showFormatPrice(j.toFixed(4)*h.STORE_RATE/h.RECIPE_RATE));i.find("#drugRetailUnitName").text(h.DRUG_DISPENSE_UNIT_NAME)}else{i.find('input[name="drugRetailPriceTotal"]').val(j==null?0:showFormatPrice(j.toFixed(4)));i.find("#drugRetailUnitName").text(h.DRUG_STORE_UNIT_NAME);i.find("#productionPlace").hide()}if(!h.VALID_DATE){i.find('input[name="validity"]').val("")}else{i.find('input[name="validity"]').val(new Date(h.VALID_DATE).Format("yyyy-MM-dd"))}i.find("input[name='validity']").datetimepicker({lang:"ch",format:"Y-m-d",minDate:new Date().Format("yyyy-MM-dd"),timepicker:false,mask:false,onSelectDate:function(){tempInbound.saveTempInbound($(this).parent().parent(),tempInbound.oprationFlag_modifyDeail)},onShow:function(){}}).on("keypress",function(m){var l=$(this);var n=l.val();if(m.which===8){return}if(n!=null&&n.length==4){l.val(n+"-")}else{if(n.length==7){l.val(n+"-")}}}).addClass("validate(date, validity)");var b=i.find('input[name="manufactor"]');var e=drugIndex.getManufactor();var c={idKey:"VENDOR_ID",txtKey:"VENDOR_NAME",isNeedThink:true};b.WJZSDropdown(e,c,function(l,m){tempInbound.saveTempInbound()});if(h.MANUFACTOR_ID){var g=b.parent().find("li[data-value='"+h.MANUFACTOR_ID+"']").text();if(g){setSelectIdValueToEle(b,h.MANUFACTOR_ID)}else{var f=h.MANUFACTOR_NAME;b.val(f);b.attr("val","")}}else{var f=h.MANUFACTOR_NAME;b.val(f);b.attr("val","")}i.find("#productionPlace").val(h.PRODUCTION_PLACE);return i},getEditInboundItem:function(e){var a=0;var c=$(e).find("td[data-name='drugOutPrice']").text();c=c.substring(0,c.indexOf("/"));var b={drugId:$(e).find("td[data-name='drugName']").attr("data-id"),drugName:$(e).find("td[data-name='drugName']").text(),drugPackageSpec:$(e).find("td[data-name='drugPackageSpec']").text(),inQty:$(e).find("input[name='inQty']").val(),inboundItemId:$(e).find("input[name='inQty']").attr("data-id"),drugUnitId:$(e).find("td[data-name='drugStoreUnitName']").attr("data-id"),drugUnitName:$(e).find("td[data-name='drugStoreUnitName']").text(),drugRetailPrice:c,drugPurchaseStorePrice:$(e).find("input[name='drugInPrice']").val()?$(e).find("input[name='drugInPrice']").val():null,batchNum:$(e).find("input[name='batchNum']").val(),drugRetailPrice:$(e).find("input[name='drugRetailPrice']").val(),drugRetailPriceTotal:Utils.trimObj($(e).find("input[name='drugRetailPriceTotal']").val()),validDate:$(e).find("input[name='validity']").val(),manufactorName:getPaSelectValue($(e).find("input[name='manufactor']"))==""?($(e).find("input[name='manufactor']").val()=="请选择"?"":$(e).find("input[name='manufactor']").val()):getPaSelectValue($(e).find("input[name='manufactor']")),manufactorId:Utils.trimObj($(e).find("input[name='manufactor']").attr("val")),productionPlace:$(e).find("#productionPlace").val()};if(b.inQty&&b.drugPurchaseStorePrice){var d=b.drugPurchaseStorePrice*b.inQty;a+=d;b.unitPrice=d}return b},editInboundSubmit:function(){var h=this;var d=$("#inboundeditvalidate").ableToFinish();if(!d){return}var j=[];var g=0;var f=$("#projecttable tr");for(var c=0;c<f.length;c++){var m=f[c];j.push(h.getEditInboundItem(m))}if(this.delList){for(var e=0;e<this.delList.length;e++){j.push(this.delList[e])}}var a=$.trim($("#inType").attr("val"));if(a!=""){a=parseInt(a)}var b={inboundId:$("#inboundDocUI").attr("data-id"),inDate:$("#inDate").val(),inType:a,vendorId:$("#vendorId").text(),vendorName:$("#vendor").val()?$("#vendor").val():"",remark:$("#remark").val(),invoiceNum:$("#invoiceNum").val(),totalPrice:g,lstItems:j};var l={type:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"inwarehouse/saveData",data:JSON.stringify(b),showMask:true,dataType:"json"};var k=Utils.myAjaxHandler(l);k.done(function(i){if("成功"==i.errorMessage){if(plat==PLAT_CCM){chainClosePage()}config_cache.removeCache("tempInboundData");tempInbound.saveFlag=true;$("#inbound-btn-save").attr("disabled","disabled");$.paSuccess("保存成功！",1000,function(){$($(".btn-cancel")[0]).click()})}else{$.paError(i.errorMessage,null)}}).fail(function(i){$.paError("请求异常",null)}).always(function(){})},getTotalPrice:function(){var b=0;var a=$("#projecttable tr");for(var c=0;c<a.length;c++){var f=a[c];var g=$(f).find("input[name='inQty']").val();var e=$(f).find("input[name='drugInPrice']").val();if(g&&e){var d=e*g;b+=d}}$("#totalPrice").val(showFormatPrice(b.toFixed(6)))},calTotalPrice:function(d,f,b){var c=d.attr("in_price");c=c==null||c==""?0:c;f=isNaN(f)?0:f;b=isNaN(b)?0:b;var e=accMul(f,b);var a=$("#totalPrice").val();if(isNaN(a)){a=0}a=accSub(a,c);a=accAdd(a,e.toFixed(6));d.attr("in_price",e.toFixed(6));$("#totalPrice").val(showFormatPrice(a.toFixed(6)))},calUnitPriceForShow:function(b,d,a){var c=accMul(isNaN(d)?0:d,isNaN(a)?0:a);b.find("input[name='unitPrice']").val(showFormatPrice(c.toFixed(6)))},calDrugRetailPriceTotalForShow:function(b,d,a){var c=accMul(isNaN(d)?0:d,isNaN(a)?0:a);b.find("input[name='drugRetailPriceTotal']").val(showFormatPrice(c.toFixed(6)))},updateDrugRetailPrice:function(){var b={drugId:detailData.DRUG_ID,drugRetailPrice:$.trim($("#drugRetailPrice").val())};var a={mdcDictDrug:b,};var d=JSON.stringify(a);var c={url:ContextClinc_Server+"mdcDictDrug/updateDrugAndConvertRate",dataType:"json",data:d,contentType:"application/json",showMask:true};var e=Utils.myAjaxHandler(c);e.done(function(h){var f=h.errorMessage;var g=h.errorCode;if(g!="E0000000"){$.paError("失败："+g+"，"+f);return}$.paSuccess("更新成功！")}).fail(function(f){$.paError("获取数据失败!")}).always()},exportExeclInbound:function(b){var c=$(b).attr("inboundId");if(c==null){return}var a=ContextClinc_Server+"inwarehouse/exportInboundSheet?inboundId="+c+"&cookie_pawj_medical_user_id="+Utils.getCookie("cookie_pawj_medical_user_id");$.exportData({url:a})}};var inboundConfirm={confirmPageClick:function(a){var b=$(a).parents("tr").find("td[data-id]").attr("data-id");inDateStart=$("#inDateStart").val();inDateEnd=$("#inDateEnd").val();inTypeValue=$.trim($("#inType").attr("val"));keyWord=$("#keyWord").val();location.href="inboundconfirm.html?id="+b+"&inDateStart="+inDateStart+"&inDateEnd="+inDateEnd+"&inType="+inTypeValue+"&keyWord="+keyWord+"&currentPage="+currentPage},getInboundInfo:function(b){var d={docId:b};var a={type:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"inwarehouse/getInboundInfo",data:JSON.stringify(d),dataType:"json"};var c=Utils.myAjaxHandler(a);c.done(function(e){if("成功"==e.errorMessage){inboundDocModel.setInboundDoc(e.data.outbound,"confirmDoc");inboundInfo.setInboundItem(e.data.items,"inboundItemUI")}else{$.paError(e.errorMessage,null)}}).fail(function(e){$.paError("请求异常",null)}).always(function(){})},confirmInboundDoc:function(c){var b=inboundDocModel.getInboundDoc("confirmDoc");var a={type:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"inwarehouse/confirmInbound",data:JSON.stringify(b),dataType:"json"};var d=Utils.myAjaxHandler(a);d.done(function(e){if(SUCCESSCODE==e.errorCode){$.paSuccess("确认入库成功");if(plat==PLAT_CCM){chainClosePage()}else{location.href="inboundlist.html?inDateStart="+inDateStart+"&inDateEnd="+inDateEnd+"&inType="+inTypeValue+"&keyWord="+keyWord+"&currentPage="+currentPage}}else{$.paError(e.errorMessage,null)}}).fail(function(e){$.paError("请求异常",null)}).always(function(){})}};var inboundDocModel={getInboundDoc:function(a){var c=$("#"+(null==a?"inboundDocUI":a));var d={inDate:c.find("#inDate").val(),inType:selectModel.getValue("inType").id,vendorId:selectModel.getValue("vendor").id,vendorName:selectModel.getValue("vendor").value,remark:c.find("#remark").val()};var b=c.find("#inDate").attr("data-id");if(b){d.docId=b}return d},setInboundDoc:function(c,a){var b=$("#"+(a==null?"inboundDocUI":a));if(c){b.find("#inDate").val((new Date(c.inDate).Format("yyyy-MM-dd")));b.find("#inDate").attr("data-id",c.inboundId);selectModel.setValue("inType",c.inType);selectModel.setValue("vendor",c.vendorId);if(c.vendorName){b.find("#vendor").val(c.vendorName)}b.find("#remark").val(c.remark)}else{$.paError("入库单数据为空，无法渲染")}},getInboundItems:function(a){var c=$("#"+null==a?"projecttable":a);var b=[];c.find("tr :gt(0)").each(function(d,e){var f={}})},setInboundItems:function(a,b){var d="";for(var c=0;c<b.length;c++){d+=this.getItemHtml(b[c])}$("#"+a).append(d)},getItemHtml:function(b){var a="";a+="<tr>";a+='<td><input class="input-text" type="text" name="" value="'+b[0]+'"></td>';a+="<td>"+b[1]+"</td>";a+='<td><input class="input-text" type="text" name="" value="'+b[2]+'"></td>';a+="<td>盒</td>";a+="<td>"+b[3]+"</td>";a+='<td><input class="input-text" type="text" name="" value="'+b[4]+'"></td>';a+='<td><input class="input-text" type="text" name=""></td>';a+="<td>";a+='<div class="date">';a+='  <input class="input-text validity" type="text" name="validity" id="" class="validity" onclick="laydate()"  placeholder="2016/01/01">';a+='  <i class="date-icon"></i>';a+=" </div>";a+=" </td>";a+='<td><input class="input-text" type="text" name=""></td>';a+="<td>";a+='      <a href="javascript:;" class="delete">删除</a>';a+="</td>";return a}};var tempInbound={tempInboundData:null,oprationFlag_modifyDeail:3,oprationFlag_modifyMain:1,oprationFlag_newLine:2,renderFlag:false,saveFlag:false,showAssetTip:function(){var a=this;a.isExitTempInbound(function(c){if(c){var b={msg:"上次的入库操作未完成，是否继续？",cancelTxt:"否",saveTxt:"是",onYes:function(){a.renderFlag=true;inboundAdd.showAddCreateInBound()},onNo:function(){$("#inboundDocUI").attr("data-id","");a.renderFlag=false;a.deleteTempInbound(a.tempInboundData,function(){inboundAdd.showAddCreateInBound()})},closeCallback:function(){}};$.paConfirm(b)}else{inboundAdd.showAddCreateInBound()}})},isExitTempInbound:function(c){var a=this;var b={type:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"inwarehouse/getTempInbound",dataType:"json"};var d=Utils.myAjaxHandler(b);d.done(function(e){if(SUCCESSCODE==e.errorCode){if(c){a.tempInboundData=e.data;config_cache.setCache("tempInboundData",e.data);c.call(a,e.data)}}else{$.paError(e.errorMessage,null)}}).fail(function(e){$.paError("请求异常",null)}).always(function(){})},getTempInboundItem:function(e){var a=0;var c=$(e).find("td[data-name='drugOutPrice']").text();c=c.substring(0,c.indexOf("/"));var b={drugId:$(e).find("td[data-name='drugName']").attr("data-id"),drugName:$(e).find("td[data-name='drugName']").text(),drugPackageSpec:$(e).find("td[data-name='drugPackageSpec']").text(),inQty:$(e).find("input[name='inQty']").val(),inboundItemId:$(e).find("input[name='inQty']").attr("data-id"),drugUnitId:$(e).find("td[data-name='drugStoreUnitName']").attr("data-id"),drugUnitName:$(e).find("td[data-name='drugStoreUnitName']").text(),drugRetailPrice:c,drugPurchaseStorePrice:$(e).find("input[name='drugInPrice']").val()?$(e).find("input[name='drugInPrice']").val():null,batchNum:$(e).find("input[name='batchNum']").val(),drugRetailPrice:$(e).find("input[name='drugRetailPrice']").val(),drugRetailPriceTotal:Utils.trimObj($(e).find("input[name='drugRetailPriceTotal']").val()),validDate:$(e).find("input[name='validity']").val(),manufactorName:$(e).find("#manufactorUI").val(),productionPlace:$(e).find("#productionPlace").val(),};if(b.inQty&&b.drugPurchaseStorePrice){var d=b.drugPurchaseStorePrice*b.inQty;a+=d;b.unitPrice=d}return b},saveTempInbound:function(a,e){var h=this;if(h.saveFlag||saveFlag=="true"){return}if(e==3){var b=$(a).ableToFinish();if(!b){return}}var i=[];var f=$("#totalPrice").val()==""?0:parseFloat($("#totalPrice").val());if(e!=1){i.push(h.getTempInboundItem(a));i=_.filter(i,function(l){return Utils.isBlank(l.drugId)})}var c=$.trim($("#inType").attr("val"));if(c!=""){c=parseInt(c)}var g=$("#inboundDocUI").attr("data-id");if(!g&&config_cache.getCache("tempInboundData")){g=config_cache.getCache("tempInboundData").inboundId}var d={inboundId:g,inDate:$("#inDate").val(),inType:c,vendorId:$("#vendorId").text(),vendorName:$("#vendor").val()?$("#vendor").val():"",remark:$("#remark").val(),invoiceNum:$("#invoiceNum").val(),totalPrice:f,status:2,lstItems:i};if(e==2){Utils.addLoadingMaskTo()}var k={type:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"inwarehouse/saveTempInbound",data:JSON.stringify(d),dataType:"json"};var j=Utils.myAjaxHandler(k);j.done(function(o){if(SUCCESSCODE==o.errorCode){var n=o.data;config_cache.setCache("tempInboundData",n);var l=n.lstItems;for(var m=0;m<l.length;m++){if(l[m].randomNum=="1"){$(a).find("input[name='inQty']").attr("data-id",l[m].inboundItemId)}}$("#inboundDocUI").attr("data-id",n.inboundId)}else{$.paError(o.errorMessage,null)}}).fail(function(l){$.paError("请求异常",null)}).always(function(){if(e==2){Utils.removeLoadingMaskFrom()}})},deleteTempInbound:function(e,c){if(e==null){return}config_cache.removeCache("tempInboundData");var a=this;var b={type:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"inwarehouse/removeTempInbound",data:JSON.stringify(e),dataType:"json"};var d=Utils.myAjaxHandler(b);d.done(function(f){if(SUCCESSCODE==f.errorCode){config_cache.removeCache("tempInboundData");if(c){c.call(a,f.data)}}else{$.paError(f.errorMessage,null)}}).fail(function(f){$.paError("请求异常",null)}).always(function(){})},deleteTempInboundItem:function(e,d){if(e==null){return}var b=this;if(b.saveFlag||saveFlag=="true"){return}var a=$("#totalPrice").val();var c={type:"GET",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"inwarehouse/removeTempInboundItem?inboundItemId="+e,dataType:"json"};var f=Utils.myAjaxHandler(c);f.done(function(l){if(SUCCESSCODE==l.errorCode){var j=[];var k=config_cache.getCache("tempInboundData");var g=k.lstItems;for(var h=0;h<g.length;h++){if(g[h].inboundItemId==e){}else{j.push(g[h])}}k.lstItems=j;k.totalPrice=a;config_cache.setCache("tempInboundData",k);b.renderMain(k);b.saveTempInbound(null,tempInbound.oprationFlag_modifyMain);if(d){d.call(b,l.data)}}else{$.paError(l.errorMessage,null)}}).fail(function(g){$.paError("请求异常",null)}).always(function(){})},getWmsInboundDocItemsDict:function(d,f){var b=[];for(var e=0;e<d.length;e++){b.push({drugId:d[e]})}var g={lstItems:b};var a=this;var c={type:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"inwarehouse/getWmsInboundDocItemsDict",data:JSON.stringify(g),dataType:"json"};var h=Utils.myAjaxHandler(c);h.done(function(r){if(SUCCESSCODE==r.errorCode){var k=[];var p=config_cache.getCache("tempInboundData").lstItems;for(var n=0;n<p.length;n++){var q=p[n];for(var o=0;o<r.data.length;o++){var m=r.data[o];if(q.drugId==m.DRUG_ID){var l=$.extend({},q,m);l.drugPurchasePrice=q.drugPurchaseStorePrice;k.push(l)}}}if(f){f.call(a,k)}}else{$.paError(r.errorMessage,null)}}).fail(function(i){$.paError("请求异常",null)}).always(function(){})},rendering:function(e){var a=this;for(var b=0;b<e.length;b++){var c=e[b];var d=inboundAdd.addInboundInfo(c);$(".common-table tr:last").before(d);d.find("input").on("blur",function(){tempInbound.saveTempInbound($(this).parent().parent(),a.oprationFlag_modifyDeail)});$("#add-coloum").val("");$("#inboundeditvalidate").ketchup();$(".samll-table-box").hide();$(".inbound-table").paKeyHandle({necessary:true,clz:"enterNext"})}},renderMain:function(a){$("#inboundDocUI").attr("data-id",a.inboundId);$("#inType").val(a.inType);$("#inType").SetWJZSDropdownSelectedData(a.inType);$("#vendor").val(a.vendorName);$("#invoiceNum").val(a.invoiceNum);$("#remark").val(a.remark);$("#totalPrice").val(a.totalPrice)},renderTempInbound:function(d,a){var b=this;if(a=="true"&&d&&d.lstItems&&d.lstItems.length>=1){var c=_.pluck(d.lstItems,"drugId");b.getWmsInboundDocItemsDict(c,b.rendering);b.renderMain(d)}else{if(a=="true"&&d){b.renderMain(d)}}},renderExportBtn:function(a){if(a==null||a!="true"){$("#exportExeclInbound").remove()}}};var selectModel={getValue:function(c){var b=$("#"+c);var a={id:b.attr("val"),value:b.val()};return a},setValue:function(d,b){var a=$("#"+d);a.attr("val",b);var c=a.parent(".drop").find("li[value="+b+"]").text();a.val(c)}};var inBoundChainOperate={showLayer:function(c,a,d){var b="";var e="";switch(d){case"1":e="采购入库";b=Context_CCM_Web+"ccm/purchaseDoc/wmsPurchaseInfoAndAudit.html?mode=info&plat=clinic&viewType=iframe&purchaseId="+c;break;case"3":e="调拨入库";b=Context_CCM_Web+"ccm/allocateDoc/wmsAllocateDocDetails.html?mode=info&plat=clinic&viewType=iframe&allocateId="+c;break}layer.open({type:2,title:e,shadeClose:true,anim:false,shade:0.8,area:["100%","100%"],content:b,cancel:function(){}})}};var DICT_VALUE={INTYPE:{"1":"采购入库","2":"科室退药","3":"调拨入库","9":"其它入库"},STATUS:{0:"未确认",1:"已确认"}};var inTypeEnum=[{id:"1",txt:"采购入库"},{id:"2",txt:"科室退药"},{id:"3",txt:"调拨入库"},{id:"9",txt:"其它入库"}];function setDateConfig(a){laydate({elem:$(a).attr("id"),min:laydate.now(-1),max:laydate.now(+1)})}function chainClosePage(){var a=parent.layer.getFrameIndex(window.name);if(a&&parent.layer){parent.layer.close(a)}}(function($){$.extend({exportData:function(setting){var id=new Date();frame=(jQuery("<iframe frameborder='0' width='0' height='0'/>").attr({id:id,name:id,src:""}).addClass("export-hidden")).appendTo(document.documentElement);function cb(){var response="";try{var doc=frame.contents();if(doc&&doc[0].body){response=eval("("+doc.find("body").text()+")")}if(doc&&doc[0].XMLDocument){response=doc[0].XMLDocument}else{response=eval("("+doc+")")}}catch(e){}frame.unbind("load",cb);if(setting.callback&&typeof setting.callback=="function"){setting.callback.call(frame,response,setting)}setTimeout(function(){frame.remove()},100)}frame.bind("load",cb);var p=setting.data;if(typeof p=="object"){p=$.param(p)}setting.url+=(setting.url.indexOf("?")!=-1?"&":"?")+"_dc="+(new Date().getTime());setting.url+=(setting.url.indexOf("?")!=-1?"&":"?")+p;setting.url+=(setting.url.indexOf("?")!=-1?"&":"?")+"acceptContentType=html";setting.url+="&cookie_pawj_medical_user_id="+Utils.getCookie("cookie_pawj_medical_user_id");frame.attr("src",setting.url)}})})(jQuery);