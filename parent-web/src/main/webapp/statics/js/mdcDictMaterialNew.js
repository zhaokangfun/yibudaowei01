$(function(){new MdcDictMaterialNew().switchTab()});MdcDictMaterialNew=function(){this.bindEventPint=0};MdcDictMaterialNew.prototype={currPage:1,drugType:3,returnMsg:null,init:function(){this.currPage=1;this.search();if(this.bindEventPint==0){this.bindEventPint++;this.bindEvent()}},switchTab:function(){var a=this;$(".pageNav .pageNav-item.material").on("click",function(){if($(this).hasClass("checked")){return}$(this).addClass("checked").siblings().removeClass("checked");$(".materialMedic").removeClass("dsn").siblings().addClass("dsn");$("#material_add_edit_div").addClass("dsn");a.init()})},bindEvent:function(){$("#material_add_edit_div").ketchup();var a=this;$("#material_status").WJZSDropdown([{id:0,txt:"启用"},{id:1,txt:"停用"}],{isNeedAll:true,isNeedClear:false},function(b,c){a.currPage=1;a.search()});$("#material_status").SetWJZSDropdownSelectedData(0);$("#material_btn_add").click(function(){a.showMaterialPanel()});$("#material_add_edit_div .submit-btn").click(function(){a.submitMaterial()});$("#material_add_edit_div .normal-inverse-btn").click(function(){a.showList()});$("#material_btn_search").click(function(){a.currPage=1;a.search()});a.drugSortDropdown();a.madrugSplitDropdown();a.madrugBasicUnitIdDropdown();$("#madrugName").off("keyup",a.setPYValue);$("#madrugName").on("keyup",a.setPYValue);$("#madrugName").off("keyup",a.setWBValue);$("#madrugName").on("keyup",a.setWBValue);a.setDefaultDrugProp();$(".materialMedic").on("click",".btn_modify",function(){a.findDictMaterial($(this).attr("val"))});$(".materialMedic").on("click",".btn_updateStat",function(){a.updateDisabled($(this).attr("val"),$(this).attr("value"))});$("#cai li").on("click",function(c){var b=$(this).find("input");b.hasClass("checked")?b.removeClass("checked"):b.addClass("checked");var d=$(this).find("span");d.hasClass("active")?d.removeClass("active"):d.addClass("active");$(this).attr("val",($(this).attr("val")==="0"?1:0));a.currPage=1;a.search()})},updateDisabled:function(g,c){if(!g||!c){return}var e=this;var b=e.returnMsg.data.dataSource[g];if(b&&c==="1"){if(b.DRUG_STORE_UNIT_QTY>0){$.paAlert("该材料有库存，不能停用!");return}}var d={drugId:b.DRUG_ID,disabled:c};var a={mdcDictDrug:d};var f={url:maindata_url.getUrl().mdcDictDrug_updateByPrimaryKeySelective,dataType:"json",data:JSON.stringify(a),contentType:"application/json"};var h=Utils.myAjaxHandler(f);h.done(function(k){var i=k.errorMessage;var j=k.errorCode;if(j!="E0000000"){$.paAlert("失败："+j+"，"+i);return}$.paSuccess("更新状态成功！");e.search()}).fail(function(i){$.paError("获取数据失败!")}).always()},findDictMaterial:function(b){var a=this;var c=a.returnMsg.data.dataSource[b];a.showMaterialPanel();a.renderDictDrug(c);if(c.DRUG_STORE_UNIT_QTY!=null&&c.DRUG_STORE_UNIT_QTY>0){$("#madrugSplit,#madrugBasicUnitId,#madrugStoreUnitId").parents(".drop").addClass("disabled");$("#madrugSplit,#madrugBasicUnitId,#madrugStoreUnitId,#madrugStoreUnitRate").attr({readonly:"readonly",disabled:"disabled"}).addClass("wjzs-disabled")}},renderDictDrug:function(a){$("#madrugName").val(a.DRUG_NAME);$("#madrugId").val(a.DRUG_ID);$("#mawbCode").val(a.WB_CODE);$("#mapyCode").val(a.PY_CODE);$("#madrugSortId").SetWJZSDropdownSelectedData(a.DRUG_SORT_ID);$("#madrugPackageSpec").val(a.DRUG_PACKAGE_SPEC);$("#madrugSplit").SetWJZSDropdownSelectedData(a.DRUG_SPLIT||0);$("#madrugBasicUnitId").SetWJZSDropdownSelectedData(a.DRUG_BASIC_UNIT_ID);$("#madrugStoreUnitId").SetWJZSDropdownSelectedData(a.DRUG_STORE_UNIT_ID);$("#madrugStoreUnitRate").val(a.DRUG_STORE_UNIT_RATE);$("#madrugRetailPrice").val(a.DRUG_RETAIL_PRICE);this.renderUnit()},setDefaultDrugProp:function(){var a=this;var b={method:"POST",url:ContextClinc_Server+"mdDictItem/getDrugType",dataType:"json",data:{type:"1"}};var c=Utils.myAjaxHandler(b);c.done(function(g){var d=g.data;var e=g.errorMessage;var f=g.errorCode;if(f!=SUCCESSCODE){$.paAlert("药品类型加载失败："+f+"，"+e);return}if(d[0]&&d[0].DRUG_TYPE_ID){$("#madrugPropId").val(d[0].DRUG_TYPE_ID)}}).fail(function(d){$.paError("获取数据失败!")}).always(function(){})},setPYValue:function(a){var c=$("#madrugName").val();var b=hz2JP(c);$("#mapyCode").val(b)},setWBValue:function(a){var c=$("#madrugName").val();var b=hz2WB(c);$("#mawbCode").val(b)},submitMaterial:function(){if(!$("#material_add_edit_div").ableToFinish()){return}var c="";if($("#madrugId").val()!=""){c=maindata_url.getUrl().mdcDictDrug_updateDrugAndConvertRate}else{c=maindata_url.getUrl().mdcDictDrug_saveDrugAndConvertRate}var a=this;var d=JSON.stringify(a.getModel());var b={url:c,dataType:"json",data:d,contentType:"application/json",showMask:true};var e=Utils.myAjaxHandler(b);e.done(function(h){var f=h.errorMessage;var g=h.errorCode;if(g!="E0000000"){$.paAlert("失败："+g+"，"+f);return}if($("#madrugId").val()!=""){$.paSuccess("更新成功！")}else{a.currPage=1;$.paSuccess("保存成功！")}a.showList();a.search()}).fail(function(f){$.paError("获取数据失败!")}).always()},showList:function(){$("#material_add_edit_div").addClass("dsn");$("#list_div").removeClass("dsn")},getModel:function(){var b={drugName:$("#madrugName").val(),drugCommonName:$("#madrugName").val(),drugPropId:$.trim($("#madrugPropId").val()),drugSortId:$("#madrugSortId").attr("val"),drugPackageSpec:$("#madrugPackageSpec").val(),drugBasicUnitId:$.trim($("#madrugBasicUnitId").attr("val")),drugDoseUnitId:$.trim($("#madrugBasicUnitId").attr("val")),drugSplit:$.trim($("#madrugSplit").attr("val")),drugStoreUnitId:$.trim($("#madrugStoreUnitId").attr("val")),drugDispenseUnitId:$.trim($("#madrugBasicUnitId").attr("val")),drugRetailPrice:$.trim($("#madrugRetailPrice").val()),drugBasicUnitName:$.trim($("#madrugBasicUnitId").val()),drugDoseUnitName:$.trim($("#madrugBasicUnitId").val()),drugStoreUnitName:$.trim($("#madrugStoreUnitId").val()),drugDispenseUnitName:$.trim($("#madrugBasicUnitId").val()),drugStoreUnitRate:$.trim($("#madrugStoreUnitRate").val()),pyCode:$("#mapyCode").val(),wbCode:$("#mawbCode").val(),presetStatus:0,isMaterial:1};if($("#madrugId").val()!=""){$.extend(b,{drugId:$("#madrugId").val()})}else{$.extend(b,{delFlag:0,disabled:0})}var a={mdcDictDrug:b,};return a},madrugBasicUnitIdDropdown:function(){var a=this;var b={url:maindata_url.getUrl().combox_mdcDrugUnit,dataType:"json",contentType:"application/json"};var c=Utils.myAjaxHandler(b);c.done(function(h){var e=h.data;var f=h.errorMessage;var g=h.errorCode;if(g!="E0000000"){$.paError("失败："+g+"，"+f);return}var d={idKey:"DRUG_UNIT_ID",txtKey:"DRUG_UNIT_NAME",isNeedClear:false};$("#madrugBasicUnitId").WJZSDropdown(e,d,function(i,j){a.renderUnit()});$("#madrugStoreUnitId").WJZSDropdown(e,d,function(i,j){})}).fail(function(d){$.paError("获取数据失败!")}).always(function(){})},renderUnit:function(){var a=this;var b=$("#madrugSplit").attr("val");if(b!=null&&b=="0"){$("#madrugStoreUnitId").SetWJZSDropdownSelectedData($.trim($("#madrugBasicUnitId").attr("val")));$("#madrugStoreUnitId").removeClass("pawjzs-error");$("#madrugStoreUnitId").parent().removeClass("pawjzs-error")}a.enableOrDisableSelect("madrugStoreUnitId",$("#madrugSplit").attr("val")==0?1:0);if($("#madrugBasicUnitId").val()&&$("#madrugBasicUnitId").val()!=""){$("#madrugRetailPrice-suffix").text("元/"+$("#madrugBasicUnitId").val())}},enableOrDisableSelect:function(b,a){if(a==1){Utils.disabledInput($("#"+b).parent("div"))}else{Utils.enableInput($("#"+b).parent("div"))}},madrugSplitDropdown:function(){var c=this;var b=[{id:"0",txt:"否"},{id:"1",txt:"是"}];var a={isNeedClear:false};$("#madrugSplit").WJZSDropdown(b,a,function(d,e){c.renderUnit()})},drugSortDropdown:function(){var a={method:"POST",url:ContextClinc_Server+"mdDictItem/getDrugSubType",dataType:"json",data:{type:"1"}};var b=Utils.myAjaxHandler(a);b.done(function(g){var e=g.errorMessage;var f=g.errorCode;if(f!=SUCCESSCODE){$.paError("失败："+f+"，"+e);return}var d=g.data;d.push({DRUG_SUB_TYPE_ID:" ",DRUG_SUB_TYPE_NAME:"&nbsp;"});var c={idKey:"DRUG_SUB_TYPE_ID",txtKey:"DRUG_SUB_TYPE_NAME",isNeedClear:false};$("#madrugSortId").WJZSDropdown(d,c,function(h,i){})}).fail(function(c){$.paError("获取数据失败!")}).always(function(){})},search:function(){var b=this;var a=b.getParam();var c=$.extend({},a);c.ajaxopts={showMask:true,url:maindata_url.getUrl().mdcDictDrug_page,type:"POST"};c.callback=function(l){b.returnMsg=l;var e=l.data.dataSource;var g=l.errorMessage;var k=l.errorCode;if(k!="E0000000"){$.paAlert("失败："+k+"，"+g);return}var f=$(".materialMedic .tableBox-cont table");f.empty();for(var h=0;h<e.length;h++){var d=e[h];var j=b.getTr(d,h);f.append(j)}b.currPage=l.data.currentPage};$("#material-my-page").generatePagination(c)},getTr:function(a,b){var d="<a class='btn_modify' val='"+b+"' WJPerm='DICT02-UPDATE' >编辑</a>";var c="";if(a.DISABLED==0){c="<a class='btn_updateStat' value='1' val='"+b+"' WJPerm='DICT02-DISABLE'>停用</a>"}else{c="<a class='btn_updateStat' value='0' val='"+b+"' WJPerm='DICT02-DISABLE'>启用</a>"}var e='<tr><td width="25%">'+a.DRUG_CODE+'</td><td width="25%">'+a.DRUG_NAME+'</td><td width="20%">'+a.DRUG_PACKAGE_SPEC+'</td><td width="15%">'+a.DRUG_STORE_UNIT_NAME+"</td><td>"+d+c+"</td></tr>";return $(e)},getParam:function(){var b=this;var a={keyword:$("#material_drugName").val(),type:"1",delFlag:0,drugType:b.drugType,zeroCai:$("#zero_cai").attr("val"),disabled:$("#material_status").attr("val")==" "?"":$("#material_status").attr("val")};var c={currentPage:this.currPage,params:a};return c},showMaterialPanel:function(){var a=this;$("#material_add_edit_div").removeClass("dsn");$("#list_div").addClass("dsn");a.clearMaterial()},clearMaterial:function(){var b=this;$("#madrugSplit,#madrugBasicUnitId,#madrugStoreUnitId").parents(".drop").removeClass("disabled");$("#madrugSplit,#madrugBasicUnitId,#madrugStoreUnitId,#madrugStoreUnitRate").attr({readonly:false,disabled:false}).removeClass("wjzs-disabled");var a=$("#material_add_edit_div");a.removeErrorMsg();$("#material_add_edit_div input").attr("val","");$("#material_add_edit_div input").val("");b.enableOrDisableSelect("madrugStoreUnitId",1);$("#madrugSplit").SetWJZSDropdownSelectedData(0);$("#madrugBasicUnitId").SetWJZSDropdownSelectedData(0);$("#madrugRetailPrice-suffix").text("")}};