var treatmentState;var browserInfo=Utils.getBrowserInfo();var isIe8=browserInfo.browser=="msie"&&browserInfo.ver=="8.0";var dDentistryRecipeMain;var isYbReg=Utils.getQueryString("isYbReg");var finishPatFlag=false;var clinicTemplate=[];var personalTemplate=[];var choosedTemplate=[];var docChange={};var emp={};var disaccount=100;var isYbClinic=0;var checkDurgInputPrice=true;var checkMaterialInputPrice=true;var checkMaterialUnitPrice=true;var userInfo_aclc=config_cache.getCache("medical_user_data");for(var index in userInfo_aclc.clinic["tags"]){if(userInfo_aclc.clinic["tags"][index].tagCode=="MI"){isYbClinic=1}}var par={method:"GET",url:ContextClinc_Server+"reception/queryClinicDoctors",dataType:"json",data:{}};var result=Utils.myAjaxHandler(par);var userInfo_aclc=config_cache.getCache("medical_user_data");var doctorName=userInfo_aclc.employee.employeeName;var employeeId=userInfo_aclc.id;var clinicParams=userInfo_aclc.clinicParams;var validateStock;var isShowAmount;var drugLimit;var materialInventory;for(var index in clinicParams){if(clinicParams[index].parameterCode=="3020"){validateStock=clinicParams[index].parameterValue}if(clinicParams[index].parameterCode=="3013"){isShowAmount=clinicParams[index].parameterValue}if(clinicParams[index].parameterCode=="3022"){drugLimit=clinicParams[index].parameterValue}if(clinicParams[index].parameterCode=="1014"){materialInventory=clinicParams[index].parameterValue}}$(function(){var e=Utils.getQueryString("empiId");var a=Utils.getQueryString("acographyId");treatmentState=Utils.getQueryString("treatmentState");var i=new Stock();i.init();var b=i.isStockCheck;var f=null;var g=isNeedReturnDrugApply();var c=new DentistryRecipeAction();var d=new DentistryRecipeModle(c,a,e,b,g);var h=new DentistryRecipeHistory(d,c,e);d.dentistryRecipeHistory=h;dDentistryRecipeMain=new DentistryRecipeMain(d,c,a,treatmentState,h,g)});var DentistryRecipeMain=function(a,c,e,b,d,f){this.acographyId=e;this.treatmentState=b;this.dentistryRecipeModle=a;this.dentistryRecipeAction=c;this.history=d;this.canDoctorReturnDrug=f;this.init()};DentistryRecipeMain.prototype={init:function(){this._bindButtonEvent();this._getRecipeList();this.dentistryRecipeModle.initModle();this.history.initHistoryRecipeRecord(this.acographyId);this.getDiscountPermit();this.initPrice();this.initPriceReadonly()},initPrice:function(){var a=this;$(".west-totalPrice").off("blur").on("blur",function(b){checkDurgInputPrice=true;log("药品总金额失焦....");var h=$(".recipe_lable.current").attr("recipename");var c=$(".recipe_lable.current").attr("enableedit")||1;if(c!=1){checkDurgInputPrice=true;log("checkDurgInputPrice: true")}else{var m=0;var f=$(".recipe_lable.current").attr("recipeName");var g=$(".recipe_tbody.recipe"+f).is(":visible");if(g){$(".recipe_tbody.recipe"+f).children("tr").each(function(r){var v=$(this);if(v.find(".west-source").attr("val")!=0){return}var p=v.find(".west-totalQty").val();var u=v.attr("drugSplit");var s=v.find(".west-drugPrice").val();var t=v.attr("storeUnitName");var q=v.attr("dispenseUnitName");var o=v.find(".west-recipeUnit").val();if(isNaN(p)||isNaN(s)){return}if(p&&s){m=m+(p*s)}});var i=Utils.changePrice(Math.round(m*100)/100);$(".recipe_tbody.recipe"+f).attr("drugPrice",i)}var e=$(".recipe_tbody.recipe"+h).attr("drugPrice");var l=$(".accessional"+h).attr("additionprice");if(l==undefined||isNaN(l)||l==0||l.trim()==""){l=0}var n=$(this).val();if(n.trim()==""){n=0}if(!isNaN(parseFloat(e))&&!isNaN(parseFloat(disaccount))&&disaccount!=-1&&disaccount!=0){if(n<(parseFloat(e)*parseFloat(disaccount)/100)){$.paWarn("药品总金额不能超过最大折扣权限("+disaccount+"%)!");$(".west-totalPrice").val(e);n=e}else{checkDurgInputPrice=true}}$(".recipe_tbody.recipe"+h).attr("totalprice",n);var d=n;if(d==undefined||isNaN(d)||d==0||d.trim()==""){d=0}var k=checkNum(parseFloat(d)+parseFloat(l));$(".hj").val(Utils.changePrice(Math.round(k*100)/100));log("checkDurgInputPrice:"+checkDurgInputPrice)}});$(".west-additionTotalPrice").off("blur").on("blur",function(g){log("附加总金额失焦....");checkMaterialInputPrice=true;var i=$(".recipe_lable.current").attr("recipename");var e=$(".recipe_lable.current").attr("enableedit")||1;if(e!=1){checkMaterialInputPrice=true;log("checkMaterialInputPrice: true")}else{var b=$(".accessional"+i).attr("materialprice");var f=$(".recipe_tbody.recipe"+i).attr("totalprice");if(f==undefined||isNaN(f)||f==0||f.trim()==""){f=0}var c=$(this).val();if(c.trim()==""){c=0}if(!isNaN(parseFloat(b))&&!isNaN(parseFloat(disaccount))&&disaccount!=-1&&disaccount!=0){if(c<(parseFloat(b)*parseFloat(disaccount)/100)){$.paWarn("附加总金额不能超过最大折扣权限("+disaccount+"%)!");$(".west-additionTotalPrice").val(b);c=b}else{checkMaterialInputPrice=true}}$(".accessional"+i).attr("additionprice",c);var d=c;if(d==undefined||isNaN(d)||d==0||d.trim()==""){d=0}var h=checkNum(parseFloat(f)+parseFloat(d));$(".hj").val(Utils.changePrice(Math.round(h*100)/100));log("checkMaterialInputPrice:"+checkMaterialInputPrice)}});$(".west-totalPrice,.west-additionTotalPrice").off("input propertychange").on("input propertychange",function(d){var f=$(".recipe_lable.current").attr("recipename");var c=$(".west-totalPrice").val();var b=$(".west-additionTotalPrice").val();var e=checkNum(parseFloat(c)+parseFloat(b));$(".hj").val(Utils.changePrice(Math.round(e*100)/100))});$(".west-totalQty").off("input propertychange").on("input propertychange",function(c){$(".west-totalPrice").trigger("totalPriceCaclue");var b=$(".west-totalPrice").val();var d=$(".recipe_lable.current").attr("recipename");$(".recipe_tbody.recipe"+d).attr("totalprice",b);var e=$(".accessional"+d).attr("additionprice");if(b==undefined||isNaN(b)||b.trim()==""){b=0}if(e==undefined||isNaN(e)||e.trim()==""){e=0}$(".hj").val(Utils.changePrice(Math.round(checkNum(parseFloat(b)+parseFloat(e))*100)/100))})},initPriceReadonly:function(){if(validateStock=="1"){$(".west-totalPrice").removeAttr("readonly");$(".west-additionTotalPrice").removeAttr("readonly")}else{$(".west-totalPrice").attr("readonly","readonly");$(".west-additionTotalPrice").attr("readonly","readonly");$(".hj").attr("readonly","readonly")}if(isShowAmount=="1"){$(".priceHide").hide()}},getEmployList:function(){var a={method:"GET",url:ContextClinc_Server+"employee/getEmployList",dataType:"json",data:{}};return Utils.myAjaxHandler(a)},getDiscountPermit:function(){var c={};var a={method:"POST",url:ContextClinc_Server+"charge/getDiscountPermit",data:c,dataType:"json",async:false,showMask:true};var b=Utils.myAjaxHandler(a);b.done(function(e){if(e!=null&&e.errorCode==SUCCESSCODE){var d=e.data;disaccount=d.disaccount}else{$.paError(e.errorMessage,null)}}).fail(function(d){$.paError("请求异常",null)}).always(function(){})},_bindButtonEvent:function(){var a=this;if(a.canDoctorReturnDrug){$("#check_all").parent().removeClass("hidden")}$("#xycf_model_btn").off("click").on("click",function(){a.dentistryRecipeModle.tmplDivShow()});$(".west-recipe .popup-model dt").off("click").on("click",function(){a.dentistryRecipeModle.tmplDlswitchover($(this))});$("tbody").delegate(".west-totalQty","amountCaclue",function(){a.caculaWestAmount($(this))});$("tbody").delegate(".west-totalQty","calculateInventory",function(){a.calculateInventory($(this))});$("#teml_btn_search").off("click").on("click",function(){var b=$(".search-input").val();var d="<dt>个人模版</dt>";choosedTemplate=[];if($("#west-tmpl-clinic-dl").find("dt").hasClass("topIcon")&&!$("#west-tmpl-person-dl").find("dt").hasClass("topIcon")){d="<dt>诊所模版</dt>";$(clinicTemplate).each(function(e,f){if(f.templateName.indexOf(b)!=-1){choosedTemplate.push(f)}});for(var c=0;c<choosedTemplate.length;c++){d=d+'<dd recipetmplid="'+choosedTemplate[c].recipetmplId+'"  title="'+choosedTemplate[c].templateName+'" class="west-tmpl-item" >'+choosedTemplate[c].templateName+"</dd>"}$("#west-tmpl-clinic-dl").empty().append(d);$("#west-tmpl-clinic-dl").find("dt").addClass("topIcon");$("#west-tmpl-person-dl").find("dd").hide();$("#west-tmpl-clinic-dl").find("dd").show();$(".west-tmpl-item").off("click");$(".west-tmpl-item").on("click",function(e){$(".popup-model").hide();$(".west-tmpl-item").hide();a.dentistryRecipeModle.getRecipeTmplInfoByTmplId($(this).attr("recipetmplId"))})}else{if(!$("#west-tmpl-clinic-dl").find("dt").hasClass("topIcon")&&$("#west-tmpl-person-dl").find("dt").hasClass("topIcon")){$(personalTemplate).each(function(e,f){if(f.templateName.indexOf(b)!=-1){choosedTemplate.push(f)}});for(var c=0;c<choosedTemplate.length;c++){d=d+'<dd recipetmplid="'+choosedTemplate[c].recipetmplId+'"  title="'+choosedTemplate[c].templateName+'" class="west-tmpl-item" >'+choosedTemplate[c].templateName+"</dd>"}$("#west-tmpl-person-dl").empty().append(d);$("#west-tmpl-person-dl").find("dt").addClass("topIcon");$("#west-tmpl-clinic-dl").find("dd").hide();$("#west-tmpl-person-dl").find("dd").show();$(".west-tmpl-item").off("click");$(".west-tmpl-item").on("click",function(e){$(".popup-model").hide();$(".west-tmpl-item").hide();a.dentistryRecipeModle.getRecipeTmplInfoByTmplId($(this).attr("recipetmplId"))})}else{if(b.trim()==""){a.dentistryRecipeModle.tmplDivShow()}else{$(personalTemplate).each(function(e,f){if(f.templateName.indexOf(b)!=-1){choosedTemplate.push(f)}});for(var c=0;c<choosedTemplate.length;c++){d=d+'<dd tmplid="'+choosedTemplate[c].templateId+'"  title="'+choosedTemplate[c].templateName+'" class="_dws_tp_dd" >'+choosedTemplate[c].templateName+"</dd>"}$("#west-tmpl-person-dl").empty().append(d);$("#west-tmpl-person-dl").find("dt").addClass("topIcon");$("#west-tmpl-clinic-dl").find("dd").hide();$("#west-tmpl-person-dl").find("dd").show()}}}Utils.removeLoadingMaskFrom();Utils.renderPopup($(".west-recipe .popup-model"));$(".west-recipe .popup-model dt").off("click").on("click",function(){a.dentistryRecipeModle.tmplDlswitchover($(this))})});$(".total-price-right").delegate(".west-totalPrice","totalPriceCaclue",function(){a.caculaWestTotalPrice($(this))});$(".add-cf").off("click").on("click",function(){a.dentistryRecipeModle.currentRecipe=a.dentistryRecipeModle.addDefineRecipe()});$(".delete-cf").off("click").on("click",function(b){a.delRecipe($(this));b.stopPropagation()});$(".save_tmpl").off("click").on("click",function(){var b=$("#cfm-input").val();if(b&&b.trim()==""){$.paWarn("模板名称不能为空！")}else{a.saveWestRecipeTmplBtn(function(){a.execSaveWestRecipeTmpl()})}});$(".tp_submit").off("click").on("click",function(){log("[submit checkDurgInputPrice:"+checkDurgInputPrice+" checkMaterialInputPrice:"+checkMaterialInputPrice+" ,checkMaterialUnitPrice:"+checkMaterialUnitPrice+"]");a.saveRecipe()});$(".tp_modify").off("click").on("click",function(){a.modifyRecipe()});$(".tp_return").off("click").on("click",function(){if(!$(this).is(":visible")||$(this).hasClass("disabled")){return}a.returnRecipe()});if(existClinicTag("WISDOM_MI")){a.dentistryRecipeAction.isYbRegisterAction(a.acographyId,function(b){if(!b){$(".tp_audit").remove();return}$(".tp_audit").show();$(".tp_audit").off("click").on("click",function(){if(!$(this).is(":visible")||$(this).hasClass("disabled")){return}a.auditRecipe(null,true)})})}else{$(".tp_audit").remove()}$(".print").off("click").on("click",function(){$("#print_review").attr("style","float:left; margin-right: 20px;margin-top: 20px; color: #bbbbbb; border: 1px solid #bbbbbb;");$("#print_sure").attr("style","float:left; margin-right: 20px;margin-top: 20px; color: #bbbbbb; border: 1px solid #bbbbbb;background: transparent");$("#print_type_popup").show()})},_bindCheckboxEvent:function(){var a=this;if(a.canDoctorReturnDrug){$("#check_all").off("click").on("click",function(){var b=$(".recipe_tbody."+a.dentistryRecipeModle.getRecipeClassNameByRecipeName($(".recipe_lable.current").attr("recipeName")));if($(this).hasClass("checked")){$(this).removeClass("checked");b.find(".checkbox").removeClass("checked")}else{$(this).addClass("checked");b.find(".checkbox").addClass("checked")}})}$(".recipe_tbody").on("click",".checkbox",function(){if($(this).hasClass("checked")){var b=$(this).parents("tr.recipe-line").find(".west-groupNum").attr("groupNum");$(this).parents(".recipe_tbody").find("tr.recipe-line").each(function(c,d){if($(this).find(".west-groupNum").attr("groupNum")==b){if($(this).find(".checkbox").hasClass("checked")){$(this).find(".checkbox").removeClass("checked")}}})}else{var b=$(this).parents("tr.recipe-line").find(".west-groupNum").attr("groupNum");$(this).parents(".recipe_tbody").find("tr.recipe-line").each(function(c,d){if($(this).find(".west-groupNum").attr("groupNum")==b){if(!$(this).find(".checkbox").hasClass("checked")){$(this).find(".checkbox").addClass("checked")}}})}})},printWestRecipe:function(){var a=$(".recipe_lable.current").attr("recipeId");if(a){new WMPrescriptionPrint().printWestRecipeFacade(a,acographyId,empiId)}else{$.paWarn("请先保存处方！")}},printWestAddition:function(){var a=$(".recipe_lable.current").attr("recipeId");if(a){new AdditionPrint().doPrintFacade(acographyId,empiId,1,a)}else{$.paWarn("请先保存处方！")}},modifyRecipe:function(){var b=$(".recipe_lable.current");this.dentistryRecipeModle.disableReturnDrugElments(b.attr("doctorReturn"),$(".recipe_tbody."+this.dentistryRecipeModle.getRecipeClassNameByRecipeName(b.attr("recipeName"))));this.dentistryRecipeModle.changeReadWriteMode();this.dentistryRecipeModle.setInputReadOnlyToReadWrite();var a=$(".recipe_lable.current").attr("enableedit");if(a!=0){if(validateStock=="1"){$(".west-totalPrice").removeAttr("readonly");$(".west-additionTotalPrice").removeAttr("readonly")}}else{$(".west-totalPrice").attr("readonly","readonly");$(".west-additionTotalPrice").attr("readonly","readonly");$(".hj").attr("readonly","readonly")}},saveWestRecipeTmplBtn:function(c){var b=this;var a={msg:'<div class="clear" style="margin-bottom: 12px; padding-left: 18px;"><div class="fl" style="color:#5c5c5c;">模板级别：</div><div class="template-level"><span class="radio checked" val="3" onclick="dDentistryRecipeMain.checkRadio(this)" >个人模板</span><span class="radio" val="2" onclick="dDentistryRecipeMain.checkRadio(this)">诊所模板</span></div></div><i class="necessary">*</i>模板名称：<input type="text" class="input-text validate(required,maxlength(15))" maxlength="15" id="cfm-input">',label:"模板名称: ",cancelTxt:"取消",saveTxt:"确认",onYes:c};b.paConfirm(a)},checkRadio:function(a){if(!$(a).hasClass("checked")){$(a).addClass("checked");$(a).siblings().removeClass("checked")}},execSaveWestRecipeTmpl:function(){var a=this;var c=$("#cfm-msg").ableToFinish();if(!c){return}var d=$.trim($("#cfm-input").val());var b=$(".template-level .radio.checked").attr("val");this.dentistryRecipeAction.checkWestRecipeTmplNameAction(d,b,function(e){if(e){a.saveWestRecipeTmpl(d,b)}else{$.paWarn("模板名称已经存在!");return}$("#pa-confirm").remove()})},paConfirm:function(d){$("body").append('<div id="pa-confirm" class="reveal-modal msg" style="height: 140px;"><span id="icon_close" class="icon_close"></span><div id="cfm-msg" class="show-msg"></div><div class="btn-bar"><span class="bn-size btn-default" id="pa-cancel"></span><span class="bn-size btn-success" id="pa-save"></span></div></div>');var e={msg:"是否确认执行该操作？",cancelTxt:"取消",saveTxt:"保存",onYes:function(){alert("无法获取确认操作的回调函数")},onNo:function(){$("#pa-confirm").remove()}};var c=$.extend({},e,d);var a="<input id='cfm-input' type='text' class='input-text'/>";var b=c.msg==="input"?"<span class='ipt-label'>"+c.label+"</span>"+a:c.msg;$("#cfm-msg").html(b);$("#cfm-msg").ketchup();$("#pa-cancel").text(c.cancelTxt);$("#pa-save").text(c.saveTxt);$("#pa-confirm").show();$("div.btn-bar span#pa-save").off("click").on("click",function(){var f=$("#cfm-input").val();if(f&&f.trim()==""){$.paWarn("模板名称不能为空！")}else{c.onYes()}});$("div.btn-bar span#pa-cancel,#icon_close").off("click").on("click",c.onNo);if(c.hideCancel){$("#pa-cancel").remove()}if(c.hideSave){$("#pa-save").remove()}},saveWestRecipeTmpl:function(c,b){var a=this.dentistryRecipeModle.getRecipeWestTmplInfo(c,b);if(a.recipeWestTmplList.length<1){$.paWarn("当前处方为空");return}this.dentistryRecipeAction.addRecipeWestTmplAction(a)},isShowTable:function(a){if(this.treatmentState==0){this.dentistryRecipeModle.noDataMsgShow();return false}else{if(this.treatmentState==1){this.dentistryRecipeModle.westDrugTableShow();this.dentistryRecipeModle.addDefineRecipe();if(a<1){finishPatFlag=false;this.dentistryRecipeModle.changeReadWriteMode()}else{finishPatFlag=true;this.dentistryRecipeModle.changeReadOnlyModle()}return true}else{if(a<1){this.dentistryRecipeModle.noDataMsgShow();return false}else{this.dentistryRecipeModle.westDrugTableShow();this.dentistryRecipeModle.changeReadOnlyModle();this.dentistryRecipeModle.modifyButtonHide();this.dentistryRecipeModle.addDefineRecipe();return true}}}},_callbackRecipeList:function(b){if(b.length<1){return}this.dentistryRecipeModle.clearAllRecipe();var g;var e;var o,d;var m=$({});for(var w=0;w<b.length;w++){e=b[w];emp[w]={employeeName:e.employeeName==null?"":e.employeeName,userId:e.userId==null?"":e.userId};g=e.recipeName;o=this.dentistryRecipeModle.addRecipe(g);this.dentistryRecipeModle.fillRecipeLable(e.recipaName,e.recipeId,o,e.recipeCode);var a=$(".recipe_tbody."+this.dentistryRecipeModle.getRecipeClassNameByRecipeName(g));var x=(e.isPay||e.isSend)?0:1;a.attr("enableEdit",x);o.attr("enableEdit",x);o.attr("recipeId",e.recipeId);var r=b[w].acography;$("#doci-input").val(r.doctorName);var s=-1;if(e.canDoctorReturnDrug==1){s=0}var y=false;var v=b[w].recipeWestList;var f=b[w].additionList;this.dentistryRecipeModle.fillAdditionInfo(f,function(i){f=i});var z=b[w].totalPrice;var l=b[w].recipeAdditionPrice;for(var u=0;u<v.length;u++){d=v[u];m=this.dentistryRecipeModle.addRecipeItem(g,false);this.dentistryRecipeModle.fillRecipeItem(d,m,g);this.dentistryRecipeModle.setInputReadOnly(g,m);if(s==-1){continue}s=parseInt(m.find("td:last").data("returnStatus"))|s}var n=[];for(var t=0;t<f.length;t++){var p={additionId:f[t].additionId,treatmentId:f[t].drugId,relationId:f[t].relationId,materialsName:f[t].additionName,drugPackageSpec:f[t].drugPackageSpec,quantity:f[t].additionQty,usageId:f[t].drugUsageId,remark:f[t].remark,treatmentPrice:f[t].unitPrice,isPay:f[t].isPay,isSend:f[t].isSend,treatmentType:f[t].additionType,unitName:f[t].unitName,DRUG_STORE_UNIT_QTY:f[t].storeUnitQty,};n.push(p)}var c={};c.accessional=n;c.recipename=b[w].recipeName;c.drugId="";c.totalPrice=z;c.additionPrice=l;this.dentistryRecipeModle.renderAtnMaterial(c);o.attr("doctorReturn",s);$(".recipe_tbody.recipe"+g).attr("totalPrice",z);$(".accessional"+g).attr("additionprice",l);this.dentistryRecipeModle.fillTotalPrice(z,$("#drug-totalPrice"));this.dentistryRecipeModle.fillTotalPrice(l,$("#west-additionTotalPrice"));var h=$("a."+this.dentistryRecipeModle.getRecipeClassNameByRecipeName(g)+"[recipename="+g+"]")}if(this.dentistryRecipeModle.currentRecip==undefined||this.dentistryRecipeModle.currentRecipe==null){this.dentistryRecipeModle.currentRecipe=this.dentistryRecipeModle.getRecipeClassNameByRecipeName($(".west-recipe a.recipe_lable").last().attr("recipeName"))}$(".recipe_lable."+this.dentistryRecipeModle.currentRecipe).click();var q=parseInt($(".recipe_lable.current").attr("doctorReturn"));if(q==0||q==-1){$(".treatment-footBtn .tp_return").hide();$("#check_all").addClass("hidden")}else{if(q==1||q==3){$(".treatment-footBtn .tp_return").removeClass("disabled").show();$("#check_all").removeClass("hidden")}else{if(q==2){$(".treatment-footBtn .tp_return").addClass("disabled").show();$("#check_all").addClass("hidden")}}}this._bindCheckboxEvent()},caculaWestAmount:function(k){var o=k.parent().parent().parent();var b=o.attr("drugConvertRateDose");var g=o.attr("drugConvertRate");var c=o.find(".west-drugDose").val();var f=o.attr("frequencyQty");var a=o.find(".west-totalDay").val();var i=o.attr("drugSplit");var u=o.attr("drugConvertRateStoreUnit");var e=o.attr("convertRange");var p=o.attr("recipeUnit");var h=o.attr("storeUnitName");var t=o.attr("dispenseUnitName");var l=o.attr("drugDosageType");var s=parseFloat(o.attr("storeUnitQty"));var q=o.find(".west-drugName").val();var r;if(p==h){r=0}else{r=1}var d=this.caleAmount(l,c,f,a,b,g,u,r);if(!d){return}var n=parseFloat(d);var m=o.find(".west-source").attr("val");if(!this.dentistryRecipeModle.checkStore(n,s,m,g,u,r)){$.paWarn(q+" 库存不足");k.addClass("overFlowStore")}else{k.removeClass("overFlowStore")}if(n){o.find(".west-totalQty").click().val(n).blur()}$(".west-totalPrice").trigger("totalPriceCaclue")},calculateInventory:function(k){var o=k.parent().parent().parent();var b=o.attr("drugConvertRateDose");var g=o.attr("drugConvertRate");var c=o.find(".west-drugDose").val();var f=o.attr("frequencyQty");var a=o.find(".west-totalDay").val();var i=o.attr("drugSplit");var u=o.attr("drugConvertRateStoreUnit");var e=o.attr("convertRange");var p=o.attr("recipeUnit");var h=o.attr("storeUnitName");var t=o.attr("dispenseUnitName");var l=o.attr("drugDosageType");var s=parseFloat(o.attr("storeUnitQty"));var q=o.find(".west-drugName").val();var r;if(p==h){r=0}else{r=1}var d=this.caleAmount(l,c,f,a,b,g,u,r);if(!d){return}var n=parseFloat(d);var m=o.find(".west-source").attr("val");if(!this.dentistryRecipeModle.checkStore(n,s,m,g,u,r)){$.paWarn(q+" 库存不足");k.addClass("overFlowStore")}else{k.removeClass("overFlowStore")}$(".west-totalPrice").trigger("totalPriceCaclue")},drugInventory:function(k){var o=k.parent().parent().parent();var b=o.attr("drugConvertRateDose");var g=o.attr("drugConvertRate");var c=o.find(".west-drugDose").val();var f=o.attr("frequencyQty");var a=o.find(".west-totalDay").val();var i=o.attr("drugSplit");var u=o.attr("drugConvertRateStoreUnit");var e=o.attr("convertRange");var p=o.attr("recipeUnit");var h=o.attr("storeUnitName");var t=o.attr("dispenseUnitName");var l=o.attr("drugDosageType");var s=parseFloat(o.attr("storeUnitQty"));var q=o.find(".west-drugName").val();var r;if(p==h){r=0}else{r=1}var d=k.val();if(!d){return}var n=parseFloat(d);var m=o.find(".west-source").attr("val");if(!this.dentistryRecipeModle.checkStore(n,s,m,g,u,r)){$.paWarn(q+" 库存不足");k.addClass("overFlowStore")}else{k.removeClass("overFlowStore")}},additionInventory:function(e){var b=e.parent().parent();var a=parseFloat(b.attr("additionStoreQty"));var d=parseFloat(b.attr("additionType"));var f=b.find(".west-additionName").val();var c=$(e).val();if(materialInventory==1&&d==0&&c>a){$.paWarn(f+" 库存不足");e.addClass("overFlowStore")}else{e.removeClass("overFlowStore")}},caleAmount:function(k,f,c,b,a,l,d,e){if(isNaN(f)||isNaN(c)||isNaN(b)||isNaN(a)||isNaN(l)||isNaN(d)||isNaN(e)){return""}var i=l;if(e==0){i=d}if(f&&c&&b&&a&&l){if(k==1){var h=Math.ceil(Utils.accMul(f,this.accDiv(a,l)));var m=Utils.accMul(h,c);if(e==0){return Math.ceil(this.accDiv(Utils.accMul(m,b),this.accDiv(d,l)))}else{return Utils.accMul(m,b)}}else{var g=Utils.accMul(Utils.accMul(Utils.accMul(f,c),b),a);if(e==0){return Math.ceil(this.accDiv(g,d))}else{return Math.ceil(this.accDiv(g,l))}}}else{return""}},accDiv:function(arg1,arg2){var t1=0,t2=0,r1,r2;try{t1=arg1.toString().split(".")[1].length}catch(e){}try{t2=arg2.toString().split(".")[1].length}catch(e){}with(Math){r1=Number(arg1.toString().replace(".",""));r2=Number(arg2.toString().replace(".",""));var accLength=(r1/r2).toString().length;var _str1=0;if(accLength>7){_str1=(r1/r2).toString().substring(0,(r1/r2).toString().indexOf(".")+7)}else{_str1=(r1/r2).toString().substring(0,(r1/r2).toString().length)}return Utils.accMul(_str1,pow(10,t2-t1))}},caculaWestTotalPrice:function(d){var c=this;var a=0;var f=$(".recipe_lable.current").attr("recipeName");var b=$(".recipe_tbody.recipe"+f).is(":visible");if(b){$(".recipe_tbody.recipe"+f).children("tr").each(function(l){var p=$(this);if(p.find(".west-source").attr("val")!=0){return}var h=p.find(".west-totalQty").val();var o=p.attr("drugSplit");var m=p.find(".west-drugPrice").val();var n=p.attr("storeUnitName");var k=p.attr("dispenseUnitName");var g=p.find(".west-recipeUnit").val();if(isNaN(h)||isNaN(m)){return}if(h&&m){a=a+(h*m)}});d.val(Utils.changePrice(Math.round(a*100)/100));var e=Utils.changePrice(Math.round(a*100)/100);$(".recipe_tbody.recipe"+f).attr("totalprice",e);$(".recipe_tbody.recipe"+f).attr("drugPrice",e);c.dentistryRecipeModle.grossPrice()}},historyRecipe:function(){var a=this;$(".west-recipe .popup-model").hide();Utils.addLoadingMaskTo();this.dentistryRecipeAction.getHistoryRecipeListAction(this.acographyId,function(b){a.dentistryRecipeModle.clearHistoryDiv();a.dentistryRecipeModle.fillHistRecipeList(b);Utils.removeLoadingMaskFrom();$(".whistory").fadeIn(0);Utils.renderPopup($(".whistory"))})},renderResableMecdtion:function(d){var h=[];if(d){var o=d;for(var p=0;p<o.length;p++){var e={title:null,msg:[]};var f=o[p];e.title="西药处方"+f.warningMsg;var r=f.result.resultCode;if("000000"!=r){continue}if(f.result.result){for(var n=0;n<f.result.result.length;n++){var s=f.result.result[n];if(s.hitSize=="0"){continue}e.msg.push(s.msg);if(s.results){for(var m=0;m<s.results.length;m++){var c=s.results[m];e.msg.push(c.violationDetails[0].ruleMsg)}}}}else{e.msg.push(f.result.msg)}h.push(e)}}if(h&&h.length>0){var b="";for(var m=0;m<h.length;m++){var a=h[m];var q=a.title;for(var g=0;g<a.msg.length;g++){b+='<div class="drugs_line_wrap clear"><span>'+q+"&nbsp;&nbsp;&nbsp;&nbsp;"+a.msg[g]+'</span><span class="testing_reason"></span></div>'}}if(Utils.isBlank(b)){$("#drugs_testing").attr("style","display:block");$("#drugs_testing").find(".popcontent").html(b)}}},saveRecipe:function(){var c=this;var a=this.dentistryRecipeModle.checkParams();if(!a){return}var e=this.dentistryRecipeModle.getRecipeParamList();if(e==""||e==undefined||e.length==0){$.paSuccess("保存成功");c._getRecipeList();return}for(var d=0;d<e.length;d++){var b=e[d].recipeWestList;if(b.length<1){$.paWarn("存在空处方");return}}c.dentistryRecipeAction.saveRecipeAction(e,function(){c._getRecipeList();RMUilts.action(e,c.renderResableMecdtion);if(existClinicTag("WISDOM_MI")){c.dentistryRecipeAction.isYbRegisterAction(c.acographyId,function(f){if(!f){return}c.auditRecipe(e,false)})}})},getRecipeListActionTmp:function(d){var a=this;var c={acographyId:d};var b={url:ContextClinc_Server+"dentistryRecipe/getDentistryRecipeList",dataType:"json",showMask:true,async:false,data:c};var e=Utils.myAjaxHandler(b);e.done(function(f){if(f.errorCode=="E0000000"){return f.data}else{$.paError("提交失败")}}).fail(function(f){$.paError("操作失败!")}).always(function(){})},returnRecipe:function(){var a=this;var d=$(".recipe_lable.current").attr("recipeName");var b=$(".recipe_tbody."+a.dentistryRecipeModle.getRecipeClassNameByRecipeName(d));if(b.find(".checkbox.checked").length==0){$.paWarn("尚未选择药品");return}if(b.ableToFinish()){var c={msg:"申请退药后不可恢复，确定要申请退药吗?",cancelTxt:"取消",saveTxt:"确定",onYes:function(){a.dentistryRecipeAction.returnRecipeAction(a.dentistryRecipeModle.assemblyReturnDrugRecipe(b),function(){a._getRecipeList()})}};$.paConfirm(c)}},auditRecipe:function(e,c){var a=this;if(typeof(e)=="undefined"||e==null){var d=$(".recipe_lable.current").attr("recipeName");var b=$(".recipe_tbody."+a.dentistryRecipeModle.getRecipeClassNameByRecipeName(d));if(b.find("tr[drugid]").length==0){$.paWarn("尚未填写任何药品");return}if(!b.ableToFinish()){return}e=a.dentistryRecipeModle.assemblyAuditDrugRecipe(b)}a.dentistryRecipeAction.auditRecipeAction(e,c,function(f){if(f==null){if(c){$.paSuccess("审核通过")}return}layer.open({type:2,title:"审核结果",shadeClose:true,anim:false,shade:0.8,area:["800px","600px"],content:f,cancel:function(){},end:function(){}})})},delRecipe:function(c){if(treatmentState==2){$.paWarn("就诊已结束不允许修改处方");return}var a=this;var b={msg:"是否确认删除？",cancelTxt:"取消",saveTxt:"确认",onYes:function(){a.delFj(c.parent("a").attr("recipename"));a.execDelRecipe(c)}};$.paConfirm(b)},delFj:function(f){var e=$(".west-table2").find("tbody");for(var d=0;d<e.length;d++){var c=e[d];var b=$(c).hasClass("accessional"+f);if(b){$(c).remove()}}},execDelRecipe:function(d){var a=this;d=d.parent("a");var c=d.attr("recipeId");var e=d.attr("recipeName");if(d.hasClass("current")){var b=d.next(".recipe_lable");if(!b||!b.hasClass("recipe_lable")){b=d.prev(".recipe_lable")}a.dentistryRecipeModle.currentRecipe=a.dentistryRecipeModle.getRecipeClassNameByRecipeName(b.attr("recipeName"))}if(!c){a.dentistryRecipeModle.delRecipe(e);return}a.dentistryRecipeAction.delRecipeAction(c,e,function(f){a.dentistryRecipeModle.delRecipe(f);a.dentistryRecipeModle.changeReadWriteMode()});if(config_cache.getCache("medical_user_data").visitInfo){$("#doci-input").val(config_cache.getCache("medical_user_data").visitInfo.visitDoctorName)}},_getRecipeList:function(){var a=this;this.dentistryRecipeAction.getRecipeListAction(this.acographyId,function(b){var c=b?b.length:0;if(a.isShowTable(c)){a.getRecipeDataByRecipeList(b,function(d){a._callbackRecipeList(d)})}})},getRecipeDataByRecipeList:function(b,d){var c=[];$.each(b,function(e,f){$.each(f.recipeWestList,function(g,h){c.push(h.drugId)})});var a=this;this.dentistryRecipeAction.getMdcDictDrugWithIdAction(c,function(e){$.each(b,function(f,g){$.each(g.recipeWestList,function(h,i){var k=$(".fjxm").is(":visible");if(!k){$(".fjxm").removeClass("dsn")}$.each(e,function(m,l){if(i.drugId==l.DRUG_ID){i.convertRange=l.DRUG_CONVERT_RATE||1;i.drugConvertRateDose=l.DRUG_CONVERT_RATE_DOSE||1,i.drugConvertRate=l.DRUG_CONVERT_RATE||1,i.drugConvertRateStoreUnit=l.DRUG_CONVERT_RATE_STORE_UNIT||1,i.drugDosageType=l.DRUG_DOSAGE_TYPE,i.storeUnitQty=l.DRUG_STORE_UNIT_QTY;if(isYbClinic==1&&isYbReg!=1&&l.CEILING_PRICE!=null){i.unitPrice=l.CEILING_PRICE}else{i.unitPrice=l.NEW_RETAIL_PRICE}if(!i.recipeUnit){i.recipeUnit=l.DRUG_DISPENSE_UNIT_NAME}i.drugSplit=l.DRUG_SPLIT;i.drugUnitId=l.DRUG_DISPENSE_UNIT_ID;i.dispenseUnitName=l.DRUG_DISPENSE_UNIT_NAME;i.storeUnitId=l.DRUG_STORE_UNIT_ID;i.storeUnitName=l.DRUG_STORE_UNIT_NAME;i.scatteredPrice=l.NEW_SCATTERED_PRICE}})})});d.call(a,b)})},};var DentistryRecipeModle=function(a,c,e,b,d){this.dentistryRecipeAction=a;this.acographyId=c;this.empiId=e;this.maxRecipeCount=5;this.isCheckStore=b;this.canDoctorReturnDrug=d;this.quoteObj=$("<span class='des west-line-use' display:none>引用</span>")};DentistryRecipeModle.prototype={initModle:function(){this.delDrugInfos=[]},initKetchup:function(a){a.find(".west-groupNum").addClass("validate(required,maxlength(3))");a.find(".west-drugName").addClass("validate(required,maxlength(60))");a.find(".west-drugUsageName").addClass("validate(required,maxlength(5))");a.find(".west-frequencyName").addClass("validate(required,maxlength(5))");a.find(".west-drugDose").addClass("validate(required,decimal(5),maxlength(10),max(10000))");a.find(".west-totalDay").addClass("validate(required,number,maxlength(5))");a.find(".west-totalQty").addClass("validate(required,number,maxlength(6))");a.ketchup()},clearHistoryDiv:function(){$(".west-his-div").remove()},fillHistRecipeList:function(c){for(var b=0;b<c.length;b++){var a=c[b];this.fillOneHisRecipe(a)}this.historyRecipeShow()},historyQuteBtnShow:function(){$(".west-line-use").show()},newHistoryDiv:function(){var a="<div class='syndromeitem west-his-div'></div>";return $(a)},newHistoryH2:function(){var a="<h2 class='west-his-h2'><span class='datetime west-his-datetime'></span><span class='text'>诊断：<span class='west-his-diagnosis'></span></span></h2>";return $(a)},newRecipeTitle:function(){var a="<div class='solution clear'><div class='rp  fl'>RP :</div><table class='solute_yao west-his-table'></table><p class='singer west-his-doctorName'>医生签名：<span></span></p></div>";return $(a)},newDrugItem:function(){var a="<tr class='west-his-tr'><td class='west-his-td-1' width='30%'></td><td class='west-his-td-2' width='30%'></td><td class='west-his-td-3' width='25%'></td> <td class='west-his-td-4'></td></tr>";return $(a)},fillOneHisRecipe:function(f){var b=new Date(f.addDate).Format("yyyy-MM-dd");var o=this.newHistoryDiv();var g=this.newHistoryH2();g.find(".west-his-datetime").text(b);g.find(".west-his-diagnosis").text(f.diagnosis||"");o.append(g);var a=f.recipe;for(var c=0;c<a.length;c++){var k=this.newRecipeTitle();var n=a[c].recipeWestList;for(var e=0;e<n.length;e++){var d=n[e];var l=this.newDrugItem();l.addClass("west-his-tr01");l.find(".west-his-td-1").text(d.drugName||"");l.find(".west-his-td-2").text(d.drugSpec||"");l.find(".west-his-td-3").text((d.totalQty||"")+(d.recipeUnit||""));if(e==0){l.find(".west-his-td-4").append(this.quoteObj.clone());l.find(".west-line-use").off("click").on("click",function(){var m=$(this).parent("td").parent("tr").parent("tbody").parent("table");var i=m.data("data");p.quoteHisRecipe(i);$(".whistory").hide()})}k.find(".west-his-table").append(l).data("data",n);var h=this.newDrugItem();h.addClass("west-his-tr02");h.find(".west-his-td-2").text((d.drugDose||"")+(d.drugUnitName||""));h.find(".west-his-td-3").text(d.drugUsageName||"");h.find(".west-his-td-4").text(d.frequencyName||"");k.find(".west-his-table").append(h)}var p=this;k.find(".west-his-doctorName > span").text(f.doctorName);o.append(k)}$("#west-his-div").append(o)},quoteHisRecipe:function(k){var m=this;k=this.modifyPayStatus(k);this.getRecipeDataByDrugList(k,function(i){m.fillDataByTmplData(i)});var b=$(".fj:visible");var h=0;for(var c=0;c<b.length;c++){var f=$(b[c]).find(".west-additionRm").val();var e=$(b[c]).find(".west-additionPrice").val();if(!isNaN(f)&&!isNaN(e)){var l=parseFloat(f)*parseFloat(e);h+=l}}var a=$(".west-additionTotalPrice").val(checkNum(h));var d=$(".west-totalPrice").val();var g=parseFloat(a.val())+parseFloat(checkNum(d));$(".hj").val(Utils.changePrice(Math.round(checkNum(g)*100)/100))},modifyPayStatus:function(a){for(var b=0;b<a.length;b++){a[b].isPay=undefined}return a},getRecipeDataByDrugList:function(c,d){var b=this;var a={};this.fillDurgParmByDurgInfo(c,function(e){a.recipeWestTmplList=e;d.call(b,a)})},fillDurgParmByDurgInfo:function(c,e){var a=this;var b=a.getDrugIds(c);var d=[];this.dentistryRecipeAction.getMdcDictDrugWithIdAction(b,function(h){for(var g=0;g<c.length;g++){for(var f=0;f<h.length;f++){if(c[g].drugId==h[f].DRUG_ID){c[g].convertRange=h[f].DRUG_CONVERT_RATE||1;c[g].drugConvertRateDose=h[f].DRUG_CONVERT_RATE_DOSE||1,c[g].drugConvertRate=h[f].DRUG_CONVERT_RATE||1,c[g].drugConvertRateStoreUnit=h[f].DRUG_CONVERT_RATE_STORE_UNIT||1,c[g].drugDosageType=h[f].DRUG_DOSAGE_TYPE,c[g].storeUnitQty=h[f].DRUG_STORE_UNIT_QTY;if(isYbClinic==1&&isYbReg!=1&&h[f].CEILING_PRICE!=null){c[g].unitPrice=h[f].CEILING_PRICE}else{c[g].unitPrice=h[f].NEW_RETAIL_PRICE}if(!c[g].recipeUnit){c[g].recipeUnit=h[f].DRUG_DISPENSE_UNIT_NAME}if(!c[g].frequencyQty){c[g].frequencyQty=h[f].DRUG_FREQUENCY_QTY}c[g].drugSplit=h[f].DRUG_SPLIT;c[g].drugUnitId=h[f].DRUG_DISPENSE_UNIT_ID;c[g].dispenseUnitName=h[f].DRUG_DISPENSE_UNIT_NAME;c[g].storeUnitId=h[f].DRUG_STORE_UNIT_ID;c[g].storeUnitName=h[f].DRUG_STORE_UNIT_NAME;c[g].scatteredPrice=h[f].NEW_SCATTERED_PRICE;d.push(c[g])}}}e.call(a,d)})},fillAdditionInfo:function(e,d){var a=this;var b=a.getDrugIds(e);var c=[];this.dentistryRecipeAction.getMdcDictDrugWithIdAction(b,function(h){for(var g=0;g<e.length;g++){for(var f=0;f<h.length;f++){if(e[g].drugId==h[f].DRUG_ID){e[g].storeUnitQty=h[f].DRUG_STORE_UNIT_QTY}}}d.call(a,e)})},checkStore:function(c,b,d,e,g,f){if(f==0){var a=dDentistryRecipeMain.accDiv(b,(dDentistryRecipeMain.accDiv(g,e)));if((isNaN(b)&&this.isCheckStore&&d!=1&&d!=2)||(b=="0"&&this.isCheckStore&&d!=1&&d!=2)){return false}if((c>a)&&d!=1&&d!=2&&this.isCheckStore){return false}else{return true}}else{if((isNaN(b)&&this.isCheckStore&&d!=1&&d!=2)||(b=="0"&&this.isCheckStore&&d!=1&&d!=2)){return false}if((c>b)&&d!=1&&d!=2&&this.isCheckStore){return false}else{return true}}},fillPersonalTmplView:function(d){var c;var a=this;$("#west-tmpl-person-dl dd").remove();personalTemplate=[];for(var b=0;b<d.length;b++){c=$("<dd/>");c.attr("class","west-tmpl-item");c.attr("title",d[b].templateName);c.attr("recipetmplId",d[b].recipetmplId);c.text(d[b].templateName);c.off("click");c.show();c.on("click",function(e){$(".popup-model").hide();$(".west-tmpl-item").hide();a.getRecipeTmplInfoByTmplId($(this).attr("recipetmplId"))});personalTemplate.push(d[b]);$("#west-tmpl-person-dl").append(c)}},fillClinicTmplView:function(d){var c;var a=this;$("#west-tmpl-clinic-dl dd").remove();clinicTemplate=[];for(var b=0;b<d.length;b++){c=$("<dd/>");c.attr("class","west-tmpl-item");c.attr("title",d[b].templateName);c.attr("recipetmplId",d[b].recipetmplId);c.text(d[b].templateName);c.off("click");c.on("click",function(e){$(".popup-model").hide();$(".west-tmpl-item").hide();a.getRecipeTmplInfoByTmplId($(this).attr("recipetmplId"))});clinicTemplate.push(d[b]);$("#west-tmpl-clinic-dl").append(c)}},getRecipeTmplInfoByTmplId:function(b){var a=this;this.dentistryRecipeAction.getWestRecipeTmplInfoByTempId(b,function(c){a.addDrugStoreUnitQty(c,function(d){if(d.recipeWestTmplList.length>0){a.fillDataByTmplData(d)}else{$.paWarn("模板中的药品不存在或已停用！")}})})},addDrugStoreUnitQty:function(c,d){var a=this;var b=c.recipeWestTmplList;this.fillDurgParmByDurgInfo(b,function(e){c.recipeWestTmplList=e;d.call(a,c)})},getDrugIds:function(c){var a=[];for(var b=0;b<c.length;b++){a.push(c[b].drugId)}return a},fillDataByTmplData:function(d){var m=this;var c=$(".recipe_lable.current");var h=c.attr("recipename");if(parseInt(c.attr("enableEdit"))==0){h=this.newRecipeName();if(h==null){$.paWarn("超出最大处方数");return}var g=this.addRecipe(h);this.fillRecipeLable(h,"",g);var k=$("a."+this.getRecipeClassNameByRecipeName(h));$(k[0]).addClass("current").siblings(".recipe_lable").removeClass("current");this.bindRecipeLableEvent($(k[0]))}else{var i=$(".recipe_tbody."+this.getRecipeClassNameByRecipeName(h)).find(".recipe-line:last");i.remove()}var n=d.recipeWestTmplList;for(var b=0;b<n.length;b++){var e=n[b];if(e.recipeWestId!=undefined&&e.recipeWestId!=null&&e.recipeWestId!=""){e.recipeWestId=""}if(e.recipeId!=undefined&&e.recipeId!=null&&e.recipeId!=""){e.recipeId=""}if(e.drugSource==null||e.drugSource==undefined){e.drugSource=0}var l=this.addRecipeItem(h,true);if(b==0){var a=this.newGroupNum(l)}if(a>1){var f=parseInt(e.groupNum);f+=(a-1);e.groupNum=f}this.fillRecipeItem(e,l,h)}this.addRecipeItem(h,true);this.enableRecipeDelItem();m.refreshList()},tmplDivShow:function(){var a=this;$(".whistory").hide();Utils.addLoadingMaskTo();this.dentistryRecipeAction.getWestRecipePersonalTmplList(function(b){a.fillPersonalTmplView(b);Utils.removeLoadingMaskFrom();$(".west-recipe .popup-model").fadeIn(0);Utils.renderPopup($(".west-recipe .popup-model"))});this.dentistryRecipeAction.getWestRecipeClinicTmplList(function(b){a.fillClinicTmplView(b);Utils.removeLoadingMaskFrom()})},tmplDlswitchover:function(b){var a=b.parents("dl").find("dd").is(":visible");if(!a){b.parents("dl").siblings().find("dd").hide();b.parents("dl").find("dd").show();b.parents("dl").siblings().find("dt").removeClass("topIcon");b.parents("dl").find("dt").addClass("topIcon")}else{b.parents("dl").find("dd").hide();b.parents("dl").find("dt").removeClass("topIcon")}},changeReadOnlyModle:function(){this.saveTmplButtonHide();this.recipeTmplButtonHide();this.saveButtonHide();this.addButtonHide();this.historyQuoteButtonHide();this.disableRecipeDelItem();this.modifyButtonShow();this.dentistryRecipeHistory.quoteBtnHide();this.disableDropdown();this.changeStatusModle()},changeReadWriteMode:function(){this.modifyButtonHide();this.saveTmplButtonShow();this.recipeTmplButtonShow();this.saveButtonShow();this.enableRecipeDelItem();this.historyQuoteButtonShow();this.dentistryRecipeHistory.quoteBtnShow();var a=$(".recipe_lable").length||0;if(a<this.maxRecipeCount){this.addButtonShow()}else{this.addButtonHide()}this.enableDropdown();this.changeEditModle()},enableRecipeDelItem:function(){$(".recipe_lable").hover(function(){var a=$(this).attr("enableEdit");if(a==undefined||parseInt(a)==1){$(this).find(".delete-cf").show()}},function(){$(this).find(".delete-cf").hide()})},westDrugTableShow:function(){$(".west-table").show()},noDataMsgShow:function(){var a='<div><div class="no_data_msg">当前暂无处方记录！</div></div>';$(".west-table").remove();$("#history_record").before(a)},disableRecipeDelItem:function(){$(".tab-content-top").off("mouseenter mouseleave")},historyQuoteButtonShow:function(){$(".west-line-use").show()},historyQuoteButtonHide:function(){$(".west-line-use").hide()},saveTmplButtonShow:function(){$("#medRecSaveTmplBtn").show()},saveTmplButtonHide:function(){$("#medRecSaveTmplBtn").hide()},recipeTmplButtonShow:function(){$("#xycf_model_btn").show()},recipeTmplButtonHide:function(){$("#xycf_model_btn").hide()},saveButtonShow:function(){$(".tp_submit").show();$("#skinTest").removeClass("check-disable")},saveButtonHide:function(){$(".tp_submit").hide()},modifyButtonShow:function(){$(".tp_modify").show()},modifyButtonHide:function(){$(".tp_modify").hide()},historyRecipeShow:function(){$(".whistory").show()},disableDropdown:function(){$(".west-table .drop").addClass("read-drop")},enableDropdown:function(){$(".west-table .drop").removeClass("read-drop")},getRecipeClassNameByRecipeName:function(a){return"recipe"+a},addButtonShow:function(){$(".add-cf").show()},addButtonHide:function(){$(".add-cf").hide()},changeStatusModle:function(){$(".west-table").find("thead").find("th:last").text("状态")},changeEditModle:function(){$(".west-table").find("thead").find("th:last").text("编辑")},addRecipeLable:function(c){var a=$(".recipe_lable_clone");var b=a.clone(true);b.removeClass("recipe_lable_clone");b.attr("recipeName",c);b.addClass(this.getRecipeClassNameByRecipeName(c));b.addClass("recipe_lable");b.find("span").text(c);a.before(b);b.show();$(".print").attr("title","打印处方"+c);return b},addRecpeTbody:function(b){var a=$(".recipe_tbody_clone");var c=a.clone(true).removeAttr("id");c.removeClass("recipe_tbody_clone");c.addClass("recipe_tbody");c.addClass(this.getRecipeClassNameByRecipeName(b));c.attr("recipeName",b);a.before(c);c.show().siblings(".recipe_tbody").hide();return c},addRecipeItem:function(n,k,b){var g=$(".recipe-line.recipe"+this.getRecipeIndex());var f=[];var e=$(".recipe_lable.current").attr("enableedit");for(var l=0;l<g.length;l++){var o=g[l].getAttribute("drugid");if(o!=undefined&&o!=null&&o!=""){var m=$.inArray(o,f);if(m==-1){f.push(o)}}}if(drugLimit==1&&e!=0&&!b){if(f.length>5){$.paWarn("每个处方最多只能开5种药品");var q=$(".recipe_tbody_clone .recipe-line-clone");var h=$(".recipe_tbody."+this.getRecipeClassNameByRecipeName(n));var c=q.clone(true);c.removeClass("recipe-line-clone").addClass("recipe-line").addClass(this.getRecipeClassNameByRecipeName(n)).attr("recipeName",n);if(this.canDoctorReturnDrug){c.prepend("<td></td>")}c.show();h.children().eq(-2).remove();h.children(":last-child").before(c);if(k){this._initThinkInput(c.find(".thinkBoxInputArea"));this._initUsageDropBox(c.find(".west-drugUsageName"));this._initFrequencyDropBox(c.find(".west-frequencyName"));this._initDrugSourceDropBox(c.find(".west-source"))}return c}}else{if(f.length>1000){$.paWarn("每个处方最多只能开1000种药品");var q=$(".recipe_tbody_clone .recipe-line-clone");var h=$(".recipe_tbody."+this.getRecipeClassNameByRecipeName(n));var c=q.clone(true);c.removeClass("recipe-line-clone").addClass("recipe-line").addClass(this.getRecipeClassNameByRecipeName(n)).attr("recipeName",n);if(this.canDoctorReturnDrug){c.prepend("<td></td>")}c.show();h.children().eq(-2).remove();h.children(":last-child").before(c);if(k){this._initThinkInput(c.find(".thinkBoxInputArea"));this._initUsageDropBox(c.find(".west-drugUsageName"));this._initFrequencyDropBox(c.find(".west-frequencyName"));this._initDrugSourceDropBox(c.find(".west-source"))}return c}}var q=$(".recipe_tbody_clone .recipe-line-clone");var h=$(".recipe_tbody."+this.getRecipeClassNameByRecipeName(n));var c=q.clone(true);c.removeClass("recipe-line-clone").addClass("recipe-line").addClass(this.getRecipeClassNameByRecipeName(n)).attr("recipeName",n);if(this.canDoctorReturnDrug){c.prepend("<td></td>")}c.show();h.children(":last-child").before(c);if(k){this._initThinkInput(c.find(".thinkBoxInputArea"));this._initUsageDropBox(c.find(".west-drugUsageName"));this._initFrequencyDropBox(c.find(".west-frequencyName"));this._initDrugSourceDropBox(c.find(".west-source"))}var d=c.find(".west-totalQty");c.find(".west-drugDose").on("input propertychang",function(){if(isIe8){return}d.trigger("amountCaclue")});c.find(".drugFrequencyArea > .drop").delegate("li","click",function(){p.syncTotalDay($(this));d.trigger("amountCaclue")});var p=this;c.find(".west-totalDay").off("input propertychange").on("input propertychange",function(r){var i=c;if(isIe8){return}p.syncTotalDay($(this));p.refreshList();d.trigger("amountCaclue")});c.find(".west-drop").off("input propertychange").on("input propertychange",function(r){var i=c;if(isIe8){return}p.syncDrop($(this))});c.find(".west-groupNum").off("input propertychange").on("input propertychange",function(t){var r=c;var i=p.checkGroupNumAndDrugInfo($(this).parent("td").parent("tr"));if(i){var s=$(this).parent("td").parent("tr").find(".west-drugName").val();$.paWarn("组号"+$(this).val()+"中 已存在"+s);$(this).val($(this).attr("groupNum"));return}else{$(this).attr("groupNum",$(this).val())}p.syncInfoByGroupNum($(this));p.refreshList()});var a=c.siblings("tr").find(".west-totalPrice");c.find(".west-totalQty").off("input propertychange").on("input propertychange",function(i){var B=$(this).parent().parent().parent();var y=parseFloat(B.attr("storeUnitQty"));var r=B.find(".west-drugName").val();var t=parseFloat($(this).val());var w=B.find(".west-source").attr("val");var z=B.attr("drugConvertRate");var v=B.attr("drugConvertRateStoreUnit");var u=B.attr("recipeUnit");var A=B.attr("storeUnitName");var s=B.attr("dispenseUnitName");var x;if(u==A){x=0}else{x=1}if(!p.checkStore(t,y,w,z,v,x)){$.paWarn(r+" 库存不足");$(this).addClass("overFlowStore")}else{$(this).removeClass("overFlowStore")}$(".west-totalPrice").trigger("totalPriceCaclue")});if(isIe8){$("input, textarea").placeholder({customClass:"my-placeholder"})}c.find(".west-delete").off("click").on("click",function(){p.clearItemInput($(this).parent("td").parent("tr"));p.refreshList();$(".west-totalPrice").trigger("totalPriceCaclue")});return c},checkGroupNumAndDrugInfo:function(c,a){var b=c.find(".west-groupNum").val();a=a?a:c.attr("drugId");var d=c.siblings("tr[drugId="+a+"]");d=_.filter(d,function(e){var f=$(e).children("td").children(".west-groupNum").val();if(f==""){return false}return f==b});if(!d||d.length<1){return false}else{return true}},syncInfoByGroupNum:function(e){var g=e.val();var a=e.parent("td").parent("tr");if(!a.attr("drugId")){return}var f=a.siblings(".recipe-line");var c=$.grep(f,function(k,h){return $(k).find(".west-groupNum").val()==g});if(!c||c.length<1){return}var b=$(c[0]);var d=b.find(".west-drop").val()||"";a.find(".west-drugUsageName").parent().parent().parent().attr("drugusageid",b.find(".west-drugUsageName").attr("val"));a.find(".west-drugUsageName").attr("val",b.find(".west-drugUsageName").attr("val"));a.find(".west-drugUsageName").val(b.find(".west-drugUsageName").val());a.attr("frequencyId",b.attr("frequencyId"));a.attr("frequencyQty",b.attr("frequencyQty"));a.find(".west-frequencyName").val(b.find(".west-frequencyName").val());a.find(".west-frequencyName").attr("val",b.find(".west-frequencyName").attr("val"));a.find(".west-totalDay").val(b.find(".west-totalDay").val());if(b.find(".west-drugUsageName").attr("val")=="YF09005"){a.find(".west-drop").val(d).removeAttr("readonly").addClass("readWrite")}else{a.find(".west-drop").val("").attr("readonly","readonly").removeClass("readWrite")}a.find(".west-totalQty").trigger("amountCaclue")},addRecipe:function(c){var a=($(".recipe_lable").length||0)+1;var b=this.addRecipeLable(c);this.addRecpeTbody(c);this.bindRecipeLableEvent($("a."+this.getRecipeClassNameByRecipeName(c)));if(a>=this.maxRecipeCount){$(".add-cf").hide()}return b},addDefineRecipe:function(){var h=this;var d=this.newRecipeName();if(d==null){return}var c=($(".recipe_lable").length||0)+1;this.addRecipeLable(d);this.addRecpeTbody(d);this.addRecipeItem(d,true);this.enableRecipeDelItem();var g=$("a."+this.getRecipeClassNameByRecipeName(d));g.addClass("current").siblings(".recipe_lable").removeClass("current");this.bindRecipeLableEvent(g);if(c>=this.maxRecipeCount){$(".add-cf").hide()}var b=$(".recipe_lable.current").attr("enableedit");var e=$(".tp_modify").is(":visible");var a=$(".tp_return").is(":visible");if(b!=0&&!e&&!a){if(validateStock=="1"){$(".west-totalPrice").removeAttr("readonly");$(".west-additionTotalPrice").removeAttr("readonly")}var f=$(".recipe_lable.current").attr("recipename");var i=$(".recipe_tbody.recipe"+f).attr("totalprice");if(i==undefined||isNaN(i)||i.trim()==""){$(".hj,.west-totalPrice").val("0.00")}else{$(".recipe_tbody.recipe"+f).attr("totalprice",i);$(".west-totalPrice").val(i);$(".hj").val(Utils.changePrice(Math.round(checkNum(i)*100)/100))}}else{$(".west-totalPrice").attr("readonly","readonly");$(".west-additionTotalPrice").attr("readonly","readonly");$(".hj").attr("readonly","readonly");var f=$(".recipe_lable.current").attr("recipename");var i=$(".recipe_tbody.recipe"+f).attr("totalprice");if(i==undefined||isNaN(i)||i.trim()==""){$(".hj,.west-totalPrice").val("0.00")}else{$(".recipe_tbody.recipe"+f).attr("totalprice",i);$(".west-totalPrice").val(i);$(".hj").val(Utils.changePrice(Math.round(checkNum(i)*100)/100))}}if(config_cache.getCache("medical_user_data").visitInfo){$("#doci-input").val(config_cache.getCache("medical_user_data").visitInfo.visitDoctorName)}h.clickInitialize();h.renderIndex(h.getRecipeIndex());return this.getRecipeClassNameByRecipeName(d)},newRecipeName:function(){var b=$(".recipe_lable");var c=parseInt(b.last().attr("recipename")||0)+1;var a=(b.length||0);if(a>=this.maxRecipeCount){$(".add-cf").hide();return null}return c},bindRecipeLableEvent:function(b){var a=this;b.off("click").on("click",function(){a.recipeLableClickEvent($(this))})},recipeLableClickEvent:function(g){var a=this;if(g.hasClass("current")){return}g.addClass("current").siblings(".recipe_lable").removeClass("current");var h=g.attr("recipeName");this.currentRecipe=this.getRecipeClassNameByRecipeName(h);a.clickInitialize();var d=$(".accessional"+h).attr("additionprice");$(".west-additionTotalPrice").val(d);var c=$(".recipe_tbody."+this.getRecipeClassNameByRecipeName(h));c.show().siblings(".recipe_tbody").hide();$(".print").attr("title","打印处方"+h);this.disableReturnDrugElments(parseInt(g.attr("doctorReturn")),c);if($(".treatment-footBtn .tp_modify").is(":visible")){this.enableReturnDrugElments(parseInt(g.attr("doctorReturn")),c)}var b=$(".recipe_lable.current").attr("enableedit");var f=$(".tp_modify").is(":visible");var e=$(".tp_return").is(":visible");if(b!=0&&!f&&!e){if(validateStock=="1"){$(".west-totalPrice").removeAttr("readonly");$(".west-additionTotalPrice").removeAttr("readonly")}}else{$(".west-totalPrice").attr("readonly","readonly");$(".west-additionTotalPrice").attr("readonly","readonly");$(".hj").attr("readonly","readonly")}a.grossPrice()},checkTotalPrice:function(g){var b=0;var e=$(".recipe_tbody.recipe"+g).children(".recipe-line.recipe"+g);e.each(function(k){var m=$(this);if(m.find(".west-source").attr("val")!=0){return}var h=m.find(".west-totalQty").val();var l=m.attr("unitPrice");if(isNaN(h)||isNaN(l)){return}if(h&&l){b=b+(h*l)}});var f=Utils.changePrice(Math.round(b*100)/100);$(".recipe_tbody.recipe"+g).attr("west-totalqty",f);$(".recipe_tbody.recipe"+g).attr("totalprice",f);var c=$(".recipe_tbody.recipe"+g).is(":visible");var d=$(".recipe_tbody.recipe"+g).attr("west-totalqty");var a=$(".recipe_tbody.recipe"+g).attr("totalprice");if(c){$(".west-totalqty").val(checkNum(d));$(".hj").val(Utils.changePrice(Math.round(checkNum(a)*100)/100))}},checkDrugPrice:function(c){var a=0;var b=$(".recipe_tbody.recipe"+c).children(".recipe-line.recipe"+c);b.each(function(f){var h=$(this);if(h.find(".west-source").attr("val")!=0){return}var e=h.find(".west-totalQty").val();var g=h.attr("unitPrice");if(isNaN(e)||isNaN(g)){return}if(e&&g){a=a+(e*g)}});var d=Utils.changePrice(Math.round(a*100)/100);return d},enableReturnDrugElments:function(c,b){var a=b.find(".checkbox");if(a.length>0){a.removeClass("hidden");$("#check_all").removeClass("checked").removeClass("hidden")}if(c==0||c==-1){$(".treatment-footBtn .tp_return").hide()}else{if(c==1||c==3){$(".treatment-footBtn .tp_return").removeClass("disabled").show()}else{if(c==2){$(".treatment-footBtn .tp_return").addClass("disabled").show()}}}},disableReturnDrugElments:function(c,b){$("#check_all").removeClass("checked").addClass("hidden");var a=b.find(".checkbox");if(a.length>0){a.addClass("hidden")}$(".treatment-footBtn .tp_return").hide()},delRecipe:function(e){var c=$(".recipe_lable");var a=c.length;if(a<this.maxRecipeCount){$(".add-cf").show()}var d=$("a."+this.getRecipeClassNameByRecipeName(e));var b=d.hasClass("current");$(".recipe_tbody."+this.getRecipeClassNameByRecipeName(e)).remove();d.remove();if(a<=1){this.currentRecipe=this.addDefineRecipe();return}if(b){$(".recipe_lable."+this.currentRecipe).click()}},getRecipeWestTmplInfo:function(d,b){var c=$(".recipe_lable.current span").text();var a=this.getRecipeTmplParam(c);a.templateName=d;a.templateType=b;return a},clearAllRecipe:function(){$(".recipe_lable").remove();$(".recipe_tbody").remove()},getRecipeParamList:function(){var m=this;var b=[];var g;var f;var e=$(".west-table > .recipe_tbody");for(var d=0;d<e.length;d++){var h=$(e[d]);g=h.attr("recipeName");var a=$("a."+this.getRecipeClassNameByRecipeName(g)+"[recipename="+g+"]");if(parseInt(h.attr("enableEdit"))==0){continue}f=a.attr("recipeId");recipeCode=a.attr("recipeCode");var c=m.getRecipeParam(g);c.recipeId=f;c.recipeCode=recipeCode;c.acographyId=this.acographyId;c.empiId=empiId;c.userId=$(".docs-input").attr("val");c.employeeName=$(".docs-input").val();var k=c.totalPrice;var l=m.getModifyPrice(g);if(k!=null&&l!=null&&validateStock=="1"){if(k==l){c.isModify="0"}else{c.isModify="1"}}else{c.isModify="0"}b.push(c)}return b},getModifyPrice:function(d){var a=0;var c=0;var b=$(".recipe_tbody.recipe"+d).children(".recipe-line.recipe"+d);b.each(function(f){var h=$(this);if(h.find(".west-source").attr("val")!=0){return}var e=h.find(".west-totalQty").val();var g=h.attr("unitPrice");if(isNaN(e)||isNaN(g)){return}if(e&&g){a=a+(e*g)}});c=Utils.changePrice(Math.round(a*100)/100);return c},getRecipeParam:function(f){var b={};b.recipeName=f;var a=$(".recipe_tbody.recipe"+f).attr("totalprice");var d=$(".accessional"+f).attr("additionprice");b.totalPrice=(a==undefined||a==null||a.trim()=="")?0:a;b.recipeAdditionPrice=(d==undefined||d==null||d.trim()=="")?0:d;var e=this.getRecipeItemList(f);var c=this.getRecipeAdditionList(f);b.recipeWestList=e;b.additionList=c;return b},getRecipeTmplParam:function(c){var a={};a.recipeName=c;a.totalPrice=$(".recipe_tbody."+this.getRecipeClassNameByRecipeName(c)+" .west-totalPrice").val();var b=this.getRecipeItemList(c);a.recipeWestTmplList=b;return a},getRecipeItemList:function(g){var m=[];var c;var f=$(".recipe_tbody."+this.getRecipeClassNameByRecipeName(g)+" tr."+this.getRecipeClassNameByRecipeName(g));f=$.grep(f,function(n){var i=$(n).attr("drugId");if(i){return true}else{return false}});for(var d=0;d<f.length;d++){c=$(f[d]);var b=c.find(".west-drugName").val();if(b==null||b==undefined||b==""){continue}var e={};e.orderNum=c.index();e.groupNum=c.find(".west-groupNum").val();e.drugName=c.find(".west-drugName").val();e.drugSpec=c.find(".west-drugSpec").val();e.drugUsageName=c.find(".west-drugUsageName").val();e.drugDose=c.find(".west-drugDose").val();e.drugUnitName=c.find(".west-drugUnit").val();e.frequencyName=c.find(".west-frequencyName").val();e.totalDay=c.find(".west-totalDay").val();e.totalQty=c.find(".west-totalQty").val();e.unitPrice=c.attr("unitPrice");e.drugSource=c.find(".west-source").attr("val");e.remark=c.find(".west-remark").val();e.recipeUnit=c.find(".west-recipeUnit").val();e.drugId=c.attr("drugId");e.drugUnitId=c.attr("drugUnitId");e.drugUsageId=c.attr("drugUsageId");e.frequencyId=c.attr("frequencyId");e.frequencyQty=c.attr("frequencyQty");e.recipeWestId=c.attr("recipeWestId");e.storeUnitId=c.attr("storeUnitId");e.storeUnitName=c.attr("storeUnitName");e.drugSplit=c.attr("drugSplit");e.scatteredPrice=c.attr("scatteredPrice");e.dispenseUnitName=c.attr("dispenseUnitName");var a=c.find(".west-drop").val();if(a&&a==0){a=0}e.dripSpeed=a;var l=c.find("#skinTest").hasClass("checked");if(l){e.skinTest=1}else{e.skinTest=0}e.delFlag=0;m.push(e)}var h=$("a."+this.getRecipeClassNameByRecipeName(g));var k=h.data("delWestIdList");$.each(k,function(o,p){var n={};n.recipeWestId=p;n.delFlag=1;m.push(n)});return m},getRecipeAdditionList:function(k){var l=[];var f;var h=$(".accessional"+k).find(".fj");for(var g=0;g<h.length;g++){f=$(h[g]);var c=f.find(".west-additionName").val();var a=f.find(".west-additionSpec").val();if(c==undefined||c==null||c==""){continue}var b={};b.additionId=f.attr("additionId");if(f.attr("additionId")==undefined||f.attr("additionId")==null||f.attr("additionId")==""){b.isSend=0;b.isPay=0}b.relationId=f.attr("relationid");b.unitName=f.attr("unitName");b.additionType=f.attr("additionType");b.drugId=f.attr("treatmentid");b.drugUsageId=f.attr("usageid");b.groupNum=f.find(".west-number").val();b.orderNum=f.find(".west-number").val();b.additionName=c;b.drugPackageSpec=a;var d=f.find(".west-additionRm").val();if(d==undefined||d==null||d==""||isNaN(d)){d=0}b.additionQty=d;var e=f.find(".west-additionPrice").val();if(e==undefined||e==null||e==""){e=0}b.unitPrice=e;b.remark=f.find(".west-additionRemake").val();b.delFlag=0;l.push(b)}return l},checkParams:function(){var a=this;var f;var c=$(".west-table > .recipe_tbody");for(var d=0;d<c.length;d++){var e=$(c[d]);f=e.attr("recipeName");var g=$("a."+this.getRecipeClassNameByRecipeName(f)+"[recipename="+f+"]");if(parseInt(g.attr("enableEdit"))==0){continue}var b=a.checkRecipeParamItem(f);if(!b){return false}}return true},checkRecipeParamItem:function(k){var h=$(".recipe_tbody."+this.getRecipeClassNameByRecipeName(k)+" tr."+this.getRecipeClassNameByRecipeName(k)).not(":last");var d;if(h.length==0){$.paWarn("存在空处方！");return false}for(var e=0;e<h.length;e++){d=$(h[e]);if(d.find(".west-totalQty").hasClass("overFlowStore")){var a=d.find(".west-drugName").val();$.paWarn(a+" 库存不足");return false}var g=d.ableToFinish();if(!g){$.paWarn("输入不正确,请重新输入！");return false}if(d.attr("drugName")!=d.find(".west-drugName").val()){$.paWarn(d.find(".west-drugName").val()+"不合法");return false}if(d.find(".west-drugName").hasClass("overFlowStore")){$.paWarn(d.find(".west-drugName").val()+"的零售价、库存单位、发药单、是否拆零不能为空,请先完善药品信息!");return false}}var f;var c=$(".accessional"+k).find(".fj");for(var e=0;e<c.length;e++){f=$(c[e]);if(f.find(".west-additionRm").hasClass("overFlowStore")){var b=f.find(".west-additionName").val();$.paWarn(b+" 库存不足");return false}}return true},assemblyReturnDrugRecipe:function(d){var b=this;var g=$(".recipe_lable.current").attr("recipeName");var c=$(".recipe_lable.current").attr("recipeId");var f={recipeId:c,acographyId:b.acographyId,recipeName:g};var e=[];var a=d.find("tr.recipe-line");a=$.grep(a,function(l){var k=$(l);if(!k.find(".checkbox").hasClass("checked")){return true}var i=k.find(".west-drugName").val();if(i==null||i==undefined||i==""){return true}var h={};h.recipeWestId=k.attr("recipeWestId");h.isSend=6;e.push(h)});f.westReturnDrugItemList=e;return f},assemblyAuditDrugRecipe:function(d){var b=this;var g=$(".recipe_lable.current").attr("recipeName");var c=$(".recipe_lable.current").attr("recipeId");var f={recipeId:c,acographyId:b.acographyId,empiId:b.empiId,recipeName:g};var e=[];var a=d.find("tr[drugid]");a=$.grep(a,function(l){var k=$(l);var i=k.find(".west-drugName").val();if(i==null||i==undefined||i==""){return true}var h={};h.drugId=k.attr("drugid");h.recipeWestId=k.attr("recipeWestId");h.drugName=i;h.drugSource=k.find(".west-source").attr("val");h.unitPrice=k.attr("unitprice");h.scatteredPrice=k.attr("scatteredPrice");h.totalQty=k.find(".west-totalQty").val();e.push(h)});f.recipeWestList=e;return[f]},_initThinkInput:function(d){var a=this;var c={columns:[{display:"名称",dataKey:"DRUG_NAME",width:200},{display:"规格",dataKey:"DRUG_PACKAGE_SPEC",width:120},{display:"厂家",dataKey:"DRUG_MANUFACTOR_NAME",width:120},{display:"价格",dataKey:"NEW_RETAIL_PRICE",width:50},{display:"库存",dataKey:"SHOW_STORE_VALIDE_QTY",width:100}],extraParams:{key:"keyword",limitRows:20,drugPropType:2},selectFirst:true,formatResult:function(e){if(isYbClinic==1&&isYbReg!=1&&e.CEILING_PRICE!=null){e.NEW_RETAIL_PRICE=e.CEILING_PRICE}if(e.CONSTRAST_FLAG==1){e.CONSTRAST_FLAG="是"}else{e.CONSTRAST_FLAG="否"}if(e.DRUG_MANUFACTOR_NAME==null){e.DRUG_MANUFACTOR_NAME="--"}return e.DRUG_NAME},formatMatch:function(g,f,e){return g.DRUG_NAME+"--"+g.DRUG_CODE+"--"+g.PY_CODE+"--"+g.WB_CODE},matchContains:"word",autoFill:false,width:780,multiple:false,multipleSeparator:", ",highlight:function(f,e){return f.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+e.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},rowHighlight:function(f){var e=false;if(isYbClinic==1){if(f.FEE_LEVEL=="未对照"){e=true}}return e},scroll:true,scrollHeight:180,wrapperHandle:".dentistry-project"};if(isYbClinic==1){c.columns=[{display:"名称",dataKey:"DRUG_NAME",width:200},{display:"医保属性",dataKey:"FEE_LEVEL",width:100},{display:"规格",dataKey:"DRUG_PACKAGE_SPEC",width:120},{display:"厂家",dataKey:"DRUG_MANUFACTOR_NAME",width:120},{display:"价格",dataKey:"NEW_RETAIL_PRICE",width:50},{display:"库存",dataKey:"SHOW_STORE_VALIDE_QTY",width:100}];c.width=880}var b=ContextClinc_Server+"drugAPI/getMdcDictDrug";var a=this;d.autocomplete(b,c).result(function(e,g,h){var f=$(".fjxm").is(":visible");if(!f){$(".fjxm").removeClass("dsn")}var n=$(this).parent("td").parent("tr");if(isYbClinic==1&&isYbReg!=1&&g.CEILING_PRICE!=null){g.NEW_RETAIL_PRICE=g.CEILING_PRICE}if(g.NEW_RETAIL_PRICE==null){$.paWarn(g.DRUG_NAME+"零售价为空,请先完善药品信息！");$(this).addClass("overFlowStore")}else{if(g.DRUG_DISPENSE_UNIT_ID==null||g.DRUG_DISPENSE_UNIT_NAME==null){$.paWarn(g.DRUG_NAME+"发药单位为空,请先完善药品信息！");$(this).addClass("overFlowStore")}else{if(g.DRUG_STORE_UNIT_ID==null||g.DRUG_STORE_UNIT_NAME==null){$.paWarn(g.DRUG_NAME+"库存单位为空,请先完善药品信息！");$(this).addClass("overFlowStore")}else{if(g.DRUG_SPLIT==null||g.DRUG_SPLIT==null){$.paWarn(g.DRUG_NAME+"拆零参数为空,请先完善药品信息！");$(this).addClass("overFlowStore")}else{$(this).removeClass("overFlowStore");if(g.DRUG_SPLIT==1){n.find(".west-drugPrice").val(g.NEW_SCATTERED_PRICE)}else{n.find(".west-drugPrice").val(g.NEW_RETAIL_PRICE)}}}}}var l=n.find(".west-groupNum").val();var m=a.checkGroupNumAndDrugInfo(n,g.DRUG_ID);if(m>0){$.paWarn("组号"+l+"中 已存在"+g.DRUG_NAME);$(this).val("");return}$(this).parent("td").parent("tr").attr("drugName",g.DRUG_NAME);var i=n.find(".west-source").attr("val");if(!g.DRUG_STORE_UNIT_QTY&&a.isCheckStore&&i!=1&&i!=2){$.paWarn(g.DRUG_NAME+" 库存不足")}a.fillRecipeItemByThinkBoxData($(this).parent("td").parent("tr"),g);var k=g.DRUG_USAGE_ID;a.refreshList()})},initAdditionalRequest:function(f,e){var b=this;var a={accessional:[]};if(f==undefined||f==null||f.length==0){return a}var c={dataType:"json",contentType:"application/json",method:"post",url:ContextClinc_Server+"treatmentMaterials/selectTreatmentDictDrugList",data:JSON.stringify(f)};var d=Utils.myAjaxHandler(c);d.done(function(g){if(g!=null&&g.errorCode==SUCCESSCODE){a.accessional=g.data;if(e){e.call(b,a)}}else{$.paError(g.errorMessage)}}).fail(function(g){$.paError("操作失败!")}).always(function(){})},renderAtnMaterial:function(c){var r=this;var b=c.accessional.length;if(b!=0){$(".fjxm").show()}var n=r.getRecipeIndex();if(n==undefined){n=c.recipename}r.getfjClone($("#fjmnClone"),n,$(".west-table2"));r.getExistDetails(n);if(c.accessional.length==undefined||c.accessional.length==0){var s=$(".accessional"+n).find(".fj:visible");if(s.length==0){$(".fjxm").hide()}else{return}}for(j=0,len=c.accessional.length;j<len;j++){var m=r.getUsageData(c.accessional[j]);var e=m.isPay;var f=m.isSend;if(e==1){if(f==1){e="已发药"}else{if(f==0){e="已收费"}else{if(f==6){e="申请退药"}else{if(f==2){e="已退药"}else{if(f==3){e="部分退药"}}}}}}else{if(e==2){e="已退费"}else{if(e==3){e="部分退费"}else{if(e==4){e="收费中"}else{if(e==0){e="已提交"}}}}}r.renderAdditionalDetails(e,n,m)}var q=$(".recipe_tbody.recipe"+n).find("tr");var p=[];for(var g=0;g<q.length;g++){var l=$(q[g]).find(".west-drugUsageName").attr("val");if(l!=undefined&&l!=null&&l.trim()!=""){var h=$.inArray(l,p);if(h>=0){continue}else{p.push(l)}}}if(p.length==0){r.getExistDetails(n)}for(var d=0;d<q.length;d++){var p=$(q[d]);var o=$(q[d]).find(".west-drugUsageName").attr("val");if(o!=undefined&&o!=null&&o.trim()!=""){r.totalNumber(p,n)}}r.fillEvent(n);r.renderIndex(n);r.grossPrice()},refreshList:function(){var c=this;var b=$(".recipe_tbody.recipe"+c.getRecipeIndex()).children("tr");var g=[];c.emptyList();for(var e=0;e<b.length;e++){var f=$(b[e]).find(".west-drugUsageName").attr("val");if(f!=undefined&&f!=null&&f.trim()!=""){var d=$.inArray(f,g);if(d>=0){continue}else{g.push(f)}}}if(g.length>0){c.initAdditionalRequest(g,function(a){c.renderAtnMaterial(a)})}},fillEvent:function(c){var a=this;var b=$(".accessional"+c);b.find(".west-delete").off("click").on("click",function(){a.deleteWestItem($(this));var d=b.find(".fj:visible");if(d.length==0){$(".fjxm").hide();$(".accessional"+c).addClass("dsn")}a.renderIndex(c);a.grossPrice()});$(".west-additionRm,.west-additionPrice").off("input propertychange").on("input propertychange",function(d){a.renderIndex(a.getRecipeIndex());a.grossPrice();if(isIe8){return}if($(this).hasClass("west-additionRm")){dDentistryRecipeMain.additionInventory($(this))}});$(".west-additionPrice").off("blur").on("blur",function(g){var e=$(this).val();var d=$(this).attr("unitPrice");var f=$(".recipe_lable.current").attr("enableedit")||1;if(f!=1){checkMaterialUnitPrice=true;log("checkMaterialUnitPrice: true")}else{if(!isNaN(parseFloat(d))&&!isNaN(parseFloat(disaccount))&&disaccount!=-1&&disaccount!=0){if(e<(parseFloat(d)*parseFloat(disaccount)/100)){$.paWarn("单价不能超过最大折扣权限("+disaccount+"%)!");$(this).val(d)}else{checkMaterialUnitPrice=true}a.renderIndex(a.getRecipeIndex());a.grossPrice()}}})},grossPrice:function(){var b=this;var d=b.getRecipeIndex();var a=$(".recipe_tbody.recipe"+d).attr("totalprice");var e=$(".accessional"+d).attr("additionprice");if(isNaN(a)){a=0;$(".west-totalPrice").val("0.00")}else{$(".west-totalPrice").val(a)}if(isNaN(e)){e=0;$(".west-additionTotalPrice").val("0.00")}else{$(".west-additionTotalPrice").val(e)}var c=parseFloat(a)+parseFloat(e);c=Utils.changePrice(Math.round(c*100)/100);if(c==0){c="0.00"}$(".hj").val(Utils.changePrice(Math.round(checkNum(c)*100)/100))},emptyList:function(){var b=this;var d=$(".accessional"+b.getRecipeIndex()).children("tr");for(var c=0,a=d.length;c<a;c++){$(d[c]).remove()}$(".accessional"+b.getRecipeIndex()).attr("additionPrice","0.00");$("#west-additionTotalPrice").val("0.00");$(".fjxm").hide()},renderAdditionalDetails:function(a,e,d){var i=this;var f=$("#fjmnClone").find(".recipe-addition-clone").clone();var c=f;c.removeClass("recipe-addition-clone dsn");c.addClass("fj");c.attr("additionid",d.additionId);c.attr("drugeid",d.drugeId);c.attr("treatmentid",d.treatmentId);c.attr("relationid",d.relationId);c.attr("materialsname",d.materialsName);c.attr("drugPackageSpec",d.drugPackageSpec);c.attr("materialsunitid",d.materialsUnitId);c.attr("materialsunitname",d.materialsUnitName);c.attr("presetstatus",d.presetStatus);c.attr("quantity",d.quantity);c.attr("usageid",d.usageId);c.attr("additionType",d.additionType);c.attr("unitName",d.unitName);if(d.additionType==0){c.attr("additionStoreQty",d.additionStoreQty)}var h=$(".tp_submit").is(":visible");var g=$(".tp_modify").is(":visible");var b=$(".tp_return").is(":visible");if(a==undefined){c.find(".west-number").attr("readonly","readonly");c.find(".west-additionName").attr("readonly","readonly").val(d.materialsName);c.find(".west-additionSpec").attr("readonly","readonly").val(d.drugPackageSpec);c.find(".west-additionRm").val(d.quantity);c.find(".west-additionRemake").val(d.remark);if(validateStock=="1"){c.find(".west-additionPrice").val(d.treatmentPrice);c.find(".west-additionPrice").attr("unitPrice",d.treatmentPrice)}else{c.find(".west-additionPrice").attr("unitPrice",d.treatmentPrice);c.find(".west-additionPrice").val(d.treatmentPrice).attr("readonly","readonly")}}else{c.find(".west-number").attr("readonly","readonly");c.find(".west-additionName").attr("readonly","readonly").val(d.materialsName).css("cursor","auto").css("background","transparent");c.find(".west-additionSpec").attr("readonly","readonly").val(d.drugPackageSpec).css("cursor","auto").css("background","transparent");c.find(".west-additionRm").val(d.quantity).attr("readonly","readonly").css("cursor","auto").css("background","transparent");c.find(".west-additionRemake").val(d.remark).attr("readonly","readonly").css("cursor","auto").css("background","transparent");c.find(".west-additionPrice").attr("unitPrice",d.treatmentPrice);c.find(".west-additionPrice").val(d.treatmentPrice).attr("readonly","readonly").css("cursor","auto").css("background","transparent");c.find(".operate").children("a").remove();if(a=="已退费"||a=="部分退费"||a=="已退药"){c.find(".operate").html('<span style="color:red">'+a+"</span>").css("cursor","auto").css("background","transparent")}else{c.find(".operate").html("<span>"+a+"</span>").css("cursor","auto").css("background","transparent")}}$(".accessional"+e).append(c)},getExistDetails:function(d){var c=$(".accessional"+d).children("tr");for(var b=0,a=c.length;b<a;b++){$(c[b]).remove()}$(".accessional"+d).attr("additionPrice","0.00");$("#west-additionTotalPrice").val("0.00")},selectPriceOrNumDrug:function(g,f){var a=this;var d={};var c={id:g};var b={url:ContextClinc_Server+"dentistryRecipe/selectPriceOrNum",dataType:"json",showMask:true,data:c,async:false};var e=Utils.myAjaxHandler(b);e.done(function(h){if(h.errorCode=="E0000000"){if(f){f.call(a,h.data)}}else{$.paError("提交失败")}}).fail(function(h){$.paError("操作失败!")}).always(function(){})},selectPriceOrNumZl:function(a,f){var b=this;var d={treatmentId:a};var c={url:ContextClinc_Server+"mdcTreatment/getEditInfo",dataType:"json",showMask:true,data:d,async:false};var e=Utils.myAjaxHandler(c);e.done(function(g){if(g.errorCode=="E0000000"){if(f){f.call(b,g.data)}}else{$.paError("提交失败")}}).fail(function(g){$.paError("操作失败!")}).always(function(){})},getUsageData:function(a){if(isNaN(a.quantity)){a.quantity=0}if(isNaN(a.treatmentPrice)){a.treatmentPrice=0}var b={additionType:a.treatmentType,unitName:a.materialsUnitName,treatmentId:a.treatmentId,relationId:a.relationId,materialsName:a.materialsName,drugPackageSpec:a.drugPackageSpec,materialsUnitId:a.materialsUnitId,materialsUnitName:a.materialsUnitName,presetStatus:a.presetStatus,quantity:a.quantity,usageId:a.usageId,remark:a.remark,treatmentPrice:a.treatmentPrice,additionId:a.additionId,isPay:a.isPay,isSend:a.isSend,additionStoreQty:a.DRUG_STORE_UNIT_QTY};return b},getRecipeIndex:function(){var a=$(".recipe_lable.current").attr("recipename");return a},getfjClone:function(a,g,d){var c=this;var e=a;var b=e.clone();b.removeAttr("id");b.removeClass("fjmn-clone dsn");var f=$(".west-table2").find(".accessional"+g);if(f.length==0){b.addClass("accessional"+g);b.empty();d.append(b)}else{$(".accessional"+g).removeClass("dsn")}},renderIndex:function(c){var k=this;var e=$(".accessional"+c).find(".fj:visible");var f=0;if(e.length==0){$(".fjxm").hide()}for(var a=0;a<e.length;a++){$(e[a]).find(".west-number").val(a+1);var d=$(e[a]).find(".west-additionRm").val();var b=$(e[a]).find(".west-additionPrice").val();if((d==undefined||d==null||d.trim()=="")||(b==undefined||b==null||b.trim()=="")){continue}if(!isNaN(d.trim())&&!isNaN(b.trim())){var h=parseFloat(d)*parseFloat(b);f+=h}}$(".accessional"+c).attr("additionprice",f);$(".accessional"+c).attr("materialprice",f);$("#west-additionTotalPrice").val(f);var g=$(".recipe_tbody.recipe"+k.getRecipeIndex()).attr("totalprice");if(g==undefined||g==null||g==""){g="0.00"}$(".west-totalPrice").val(g);return f},totalNumber:function(r,h){var p=this;var d=$(".recipe_lable.current").attr("recipeName");if(d==undefined){p.renderIndex(h);return}var o=$(".recipe_tbody.recipe"+d).find("tr:visible");var e=[];var a=[];var t={};var k=0;var l=r.find(".west-totalDay").val();var g=r.find(".west-groupNum").val();var c=r.attr("drugusageid");var q=r.attr("frequencyqty");for(var s=0;s<o.length;s++){var f=o.eq(s).find(".west-groupNum").val();var u=o.eq(s).attr("drugusageid");var b=o.eq(s).find(".west-totalDay").val();var n=o.eq(s).attr("frequencyqty");if(b==undefined||b==null||b==""||n==undefined||n==null||n==""){continue}if($.inArray(f,e)==-1){if(u==c){if(!t[s]){k+=parseFloat(b*n);t[s]=true;e.push(f)}}}}var m=$(".fj:visible").filter("[usageid="+c+"]");m.each(function(){var w=$(this);var v=w.attr("quantity");var i=k*v;w.find(".west-additionRm").val(i);var x=w.find(".west-additionRm");dDentistryRecipeMain.additionInventory($(x))});p.renderIndex(d)},clickInitialize:function(){var c=this;$("tbody[class^='accessional']").addClass("dsn");$(".fjxm").hide();$(".accessional"+c.getRecipeIndex()).removeClass("dsn");var d=$(".accessional"+c.getRecipeIndex()).children("tr");if(d.length>0){$(".fjxm").show();var b=$(".accessional"+c.getRecipeIndex()).find(".fj:visible");if(b.length<0){$(".fjxm").hide()}}},_editAuthority:function(){var a=$(".tp_modify").is(":visible");if(act=="2"&&a){_itemClone.find(".west-number").attr("readonly","readonly");_itemClone.find(".west-additionName").attr("readonly","readonly");_itemClone.find(".west-additionSpec").attr("readonly","readonly");_itemClone.find(".west-additionRm").attr("readonly","readonly");_itemClone.find(".west-additionRemake").attr("readonly","readonly");_itemClone.find(".west-additionPrice").attr("readonly","readonly")}},_obtainVisibleDrug:function(f){var f=$(".recipe_lable.current").attr("recipename");var h=$(".recipe-line.recipe"+f+":visible");var b=[];var c="";for(var d=0;d<h.length;d++){c=$(h[d]).attr("drugusageid");if(c!=undefined&&c!=null&&c.trim()!=""){b.push(c)}}var e=$(".accessional"+f).find(".fj:visible");for(var d=0;d<e.length;d++){var c=e[d].dataset.usageid;var g=e[d].dataset.customize;var k=$.inArray(c,b);if(k==-1){$(e[d]).remove()}}this._renderIndex(f);var a=$(".accessional"+f).find(".fj:visible");if(a.length==0){$(".fjxm").hide();$(".accessional"+f).addClass("dsn");$(".accessional"+f).attr("additionprice",0);$(".west-additionTotalPrice").val(0)}else{this._accessionalTotal();$(".recipe-line").find(".west-groupNum")[0].focus();$(".recipe-line").find(".west-groupNum")[0].blur()}},_accessionalTotal:function(){var m=$(".recipe_lable.current").attr("recipeName");var l=$(".west-table2").find("tbody");for(var h=0;h<l.length;h++){var r=l[h];var n=$(r).hasClass("accessional"+m);if(n){var d=$(r).find(".fj:visible");if(d.length>0){$(".fjxm").show()}var f=0;for(var e=0;e<d.length;e++){var q=$(d[e]).find(".west-additionRm").val();var p=$(d[e]).find(".west-additionPrice").val();f+=parseFloat(checkNum(q,2))*parseFloat(checkNum(p))}break}}$(r).attr("additionprice",f);var c=$(".accessional"+m).hasClass("dsn");var g=$(".recipe_tbody.recipe"+m).attr("west-totalqty");if(!c){var b=$(".west-additionTotalPrice").val(f);var k=$(".west-totalPrice").val();var o=parseFloat(b.val())+parseFloat(k);$(".hj").val(Utils.changePrice(Math.round(checkNum(o)*100)/100))}else{var k=$(".west-totalPrice").val();$(".hj").val(Utils.changePrice(Math.round(checkNum(k)*100)/100))}},_initUsageDropBox:function(d){var a=this;var b;var c=this.dentistryRecipeAction.selectUsageAction(null,function(f){var e={idKey:"DRUG_USAGE_ID",txtKey:"DRUG_USAGE_NAME"};d.WJZSDropdown(f,e,function(l,m){var i=d.parent().parent().parent();var n=i.attr("drugUsageId");i.attr("drugUsageId",m.DRUG_USAGE_ID);d.data("data",m);var k=d.parent(".drop").parent("td").parent("tr");b=k;var h=k.children("td").children(".west-groupNum").val();var g=a.getTrObjByGroupNum(k.siblings(".recipe-line"),h);if(g){$(g).children("td").children(".drop").children(".west-drugUsageName").each(function(){$(this).SetWJZSDropdownSelectedData(m.DRUG_USAGE_ID);$(this).parent().parent().parent().attr("drugUsageId",m.DRUG_USAGE_ID)});if(m.DRUG_USAGE_ID=="YF09005"){b.find(".west-drop").removeAttr("readonly").addClass("readWrite");$(g).find(".west-drop").each(function(){$(this).removeAttr("readonly").addClass("readWrite")})}else{b.find(".west-drop").val("").attr("readonly","readonly").removeClass("readWrite");$(g).find(".west-drop").each(function(){$(this).val("").attr("readonly","readonly").removeClass("readWrite")})}}a.refreshList()})})},syncTotalDay:function(f){var e=f.val();var c=f.parent("td").parent("tr");var b=c.children("td").children(".west-groupNum").val();var a=this.getTrObjByGroupNum(c.siblings(".recipe-line"),b);if(a){var d=$(a).children("td");d.children(".west-totalDay").each(function(){$(this).val(e);d.children().children(".west-totalQty").trigger("amountCaclue")})}},syncDrop:function(f){var c=f.val();var d=f.parent("td").parent("tr");var b=d.children("td").children(".west-groupNum").val();var a=this.getTrObjByGroupNum(d.siblings(".recipe-line"),b);if(a){var e=$(a).children("td");e.children(".west-drop").each(function(){$(this).val(c)})}},getTrObjByGroupNum:function(c,a){var b=_.filter(c,function(d){var e=$(d).children("td").children(".west-groupNum").val();if(e==""){return false}return e==a});return b},drugSourceData:[{id:0,name:"本院"},{id:1,name:"外购"},{id:2,name:"免费"}],convertId2Name:function(b){for(var a=0;a<this.drugSourceData.length;a++){if(this.drugSourceData[a].id==b){return this.drugSourceData[a].name}}return""},_initDrugSourceDropBox:function(b){var a={idKey:"id",txtKey:"name"};b.WJZSDropdown(this.drugSourceData,a,function(c,d){$(".west-totalPrice").trigger("totalPriceCaclue")})},_initFrequencyDropBox:function(c){var a=this;var b=this.dentistryRecipeAction.selectFrequencyAction(null,function(e){var d={idKey:"DRUG_FREQUENCY_ID",txtKey:"DRUG_FREQUENCY_NAME"};c.WJZSDropdown(e,d,function(k,l){c.data("data",l);var h=c.parent().parent().parent();h.attr("frequencyId",l.DRUG_FREQUENCY_ID);h.attr("frequencyQty",l.DRUG_FREQUENCY_QTY);var i=c.parent(".drop").parent("td").parent("tr");var g=i.children("td").children(".west-groupNum").val();var f=a.getTrObjByGroupNum(i.parent().children(".recipe-line"),g);if(f){$(f).children("td").children(".drop").children(".west-frequencyName").each(function(m){$(this).SetWJZSDropdownSelectedData(l.DRUG_FREQUENCY_ID);$(this).parent().parent().parent().attr("frequencyid",l.DRUG_FREQUENCY_ID);$(this).parent().parent().parent().attr("frequencyQty",l.DRUG_FREQUENCY_QTY);$(this).parent().parent().parent().find(".west-totalQty").trigger("amountCaclue")})}i.find(".west-totalQty").trigger("amountCaclue");a.refreshList()});$("body").paKeyHandle({necessary:true,clz:"enterNext"})})},defaultParam:{drugSource:0,groupNum:1},fillRecipeItemByThinkBoxData:function(d,c){var b=d.data("data")?false:true;var e=d.data("data")||this.defaultParam;e.groupNum=this.newGroupNum(d);var a=this.getRecipeItemByThinkData(c,e,d);var f=d.attr("recipeName");this.fillRecipeItem(a,d,f);d.find(".west-totalQty").trigger("amountCaclue");b&&this.addRecipeItem(f,true)},newGroupNum:function(b){var a=b.prev("tr.recipe-line");if(!(a&&a.length>0)){return 1}return parseInt(a.find(".west-groupNum").val()||0)+1},getRecipeItemByThinkData:function(d,a,g){var k={drugId:d.DRUG_ID,drugUsageId:d.DRUG_USAGE_ID,drugUnitId:d.DRUG_DISPENSE_UNIT_ID,dispenseUnitName:d.DRUG_DISPENSE_UNIT_NAME,recipeUnit:d.DRUG_DISPENSE_UNIT_NAME,storeUnitId:d.DRUG_STORE_UNIT_ID,storeUnitName:d.DRUG_STORE_UNIT_NAME,drugSplit:d.DRUG_SPLIT,frequencyId:d.DRUG_FREQUENCY_ID,frequencyQty:d.DRUG_FREQUENCY_QTY,drugUnitName:d.DRUG_DOSE_UNIT_NAME,drugName:d.DRUG_NAME,drugSpec:d.DRUG_PACKAGE_SPEC,drugUsageName:d.DRUG_USAGE_NAME,drugDose:d.DRUG_DOSE,frequencyName:d.DRUG_FREQUENCY_NAME,unitPrice:d.NEW_RETAIL_PRICE,scatteredPrice:d.NEW_SCATTERED_PRICE,convertRange:d.DRUG_CONVERT_RATE,drugConvertRateStoreUnit:d.DRUG_CONVERT_RATE_STORE_UNIT,drugConvertRateDose:d.DRUG_CONVERT_RATE_DOSE||1,drugConvertRate:d.DRUG_CONVERT_RATE||1,drugDosageType:d.DRUG_DOSAGE_TYPE,storeUnitQty:d.DRUG_STORE_UNIT_QTY};var i=$.extend({},a,k);var f=false;var b=g.find(".west-groupNum").val();var h;if(Utils.notBlank(b)){f=true;i.groupNum=b;var c=g.siblings(".recipe-line");var e=$.grep(c,function(m,l){return $(m).find(".west-groupNum").val()==b});if(!e||e.length<1){f=false}else{h=$(e[0])}}else{i.groupNum=this.newGroupNum(g)}if(f){i.drugUsageId=h.find(".west-drugUsageName").attr("val");i.drugUsageName=h.find(".west-drugUsageName").val();i.frequencyId=h.attr("frequencyId");i.frequencyQty=h.attr("frequencyQty");i.frequencyName=h.find(".west-frequencyName").val();i.totalDay=h.find(".west-totalDay").val();i.dripSpeed=h.find(".west-drop").val()}return i},fillRecipeItem:function(e,d,f){if(e.skinTest=="0"&&g){d.find(".checkbox_li").addClass("disabled");$(".west-totalPrice").attr("readonly","readonly")}else{if(e.skinTest=="1"){var g=$(".tp_submit").is(":visible");if(g&&treatmentState!="2"&&(e.isSend==undefined||e.isSend=="0")){d.find(".checkbox_li").addClass("checked");if(validateStock=="1"){$(".west-totalPrice").removeAttr("readonly");$(".west-additionTotalPrice").removeAttr("readonly")}}else{d.find(".checkbox_li").addClass("check-disable");$(".west-totalPrice").attr("readonly","readonly");$(".west-additionTotalPrice").attr("readonly","readonly");$(".hj").attr("readonly","readonly")}}}d.find(".west-skinTest").val(e.skinTest);d.find(".west-groupNum").attr("groupNum",e.groupNum).val(e.groupNum);d.find(".west-drugName").val(e.drugName);if(d.find(".west-drugName").data("typeahead")){d.find(".west-drugName").data("typeahead").selectVlue=e.drugName}d.find(".west-drugSpec").val(e.drugSpec);d.find(".west-drugUsageName").val(e.drugUsageName);d.find(".west-drugDose").val(e.drugDose);d.find(".west-drugUnit").val(e.drugUnitName);d.find(".west-frequencyName").val(e.frequencyName);d.find(".west-totalDay").val(e.totalDay);d.find(".west-totalQty").val(e.totalQty);d.find(".west-remark").val(e.remark);d.find(".west-remark").attr("title",e.remark);d.find(".west-drop").val(e.dripSpeed);if(e.drugSplit==null||e.drugSplit==0||(e.storeUnitId==e.drugUnitId)){var b=$(d).find(".west-recipeUnit");var a={idKey:"code",txtKey:"text",isNeedClear:false};var h=[{code:"0",text:e.recipeUnit}];b.WJZSDropdown(h,a,function(l,m){if(m.code==1){d.find(".west-drugPrice").val(e.scatteredPrice)}else{d.find(".west-drugPrice").val(e.unitPrice)}d.attr("recipeUnit",m.text);d.find(".west-totalQty").trigger("amountCaclue");$(".west-totalPrice").trigger("totalPriceCaclue")});b.SetWJZSDropdownSelectedData(h[0].code);b.val(h[0].text).attr("val",h[0].code)}else{if(e.drugSplit==1){if(e.storeUnitId!=undefined&&e.storeUnitId!=null&&e.storeUnitId!=""){var b=$(d).find(".west-recipeUnit");var a={idKey:"code",txtKey:"text",isNeedClear:false};var h=[{code:"0",text:e.storeUnitName},{code:"1",text:e.dispenseUnitName}];b.WJZSDropdown(h,a,function(l,m){if(m.code==1){d.find(".west-drugPrice").val(e.scatteredPrice)}else{d.find(".west-drugPrice").val(e.unitPrice)}d.attr("recipeUnit",m.text);d.find(".west-totalQty").trigger("amountCaclue");$(".west-totalPrice").trigger("totalPriceCaclue")});if(e.recipeUnit==e.storeUnitName){b.SetWJZSDropdownSelectedData(h[0].code);b.val(h[0].text).attr("val",h[0].code)}else{b.SetWJZSDropdownSelectedData(h[1].code);b.val(h[1].text).attr("val",h[1].code)}}}}d.find(".west-drugUsageName").attr("val",e.drugUsageId);d.find(".west-frequencyName").attr("val",e.frequencyId);d.find(".west-source").val(this.convertId2Name(e.drugSource));d.find(".west-source").attr("val",e.drugSource);d.attr("unitPrice",e.unitPrice);d.attr("drugId",e.drugId);d.attr("drugUnitId",e.drugUnitId);d.attr("drugUsageId",e.drugUsageId);d.attr("frequencyId",e.frequencyId);d.attr("frequencyQty",e.frequencyQty);d.attr("convertRange",e.convertRange);d.attr("drugConvertRateDose",e.drugConvertRateDose);d.attr("drugConvertRate",e.drugConvertRate);d.attr("drugConvertRateStoreUnit",e.drugConvertRateStoreUnit);d.attr("drugDosageType",e.drugDosageType);d.attr("storeUnitQty",e.storeUnitQty);d.attr("drugName",e.drugName);d.attr("recipeWestId",e.recipeWestId);d.attr("recipeUnit",e.recipeUnit);d.attr("storeUnitId",e.storeUnitId);d.attr("storeUnitName",e.storeUnitName);d.attr("drugSplit",e.drugSplit);d.attr("scatteredPrice",e.scatteredPrice);d.attr("dispenseUnitName",e.dispenseUnitName);if(e.recipeUnit==e.storeUnitName){d.find(".west-drugPrice").val(e.unitPrice)}else{d.find(".west-drugPrice").val(e.scatteredPrice)}var c=e.isPay;var k=this;if(e.drugSource!=1){if(c!=undefined){if(c==1){if(e.isSend==1){d.find("td:last").html("已发药").data("returnStatus",1);d.find(".west-drop").attr("readonly","readonly");$(".west-totalPrice").attr("readonly","readonly");if(e.skinTest=="0"){d.find(".checkbox_li").addClass("disabled")}else{d.find(".checkbox_li").addClass("disabled").addClass("check-disable")}if(this.canDoctorReturnDrug){d.find("td:first").append('<i class="checkbox"></i>')}var i=$(d).find(".wjzs-drop-menu");i.remove()}else{if(e.isSend==0){d.find("td:last").html("已收费").data("returnStatus",0);d.find(".west-drop").attr("readonly","readonly");$(".west-totalPrice").attr("readonly","readonly");if(e.skinTest=="0"){d.find(".checkbox_li").addClass("disabled")}else{d.find(".checkbox_li").addClass("disabled").addClass("check-disable")}var i=$(d).find(".wjzs-drop-menu");i.remove()}else{if(e.isSend==6){d.find("td:last").html("申请退药").data("returnStatus",2);d.find(".west-drop").attr("readonly","readonly");$(".west-totalPrice").attr("readonly","readonly");if(e.skinTest=="0"){d.find(".checkbox_li").addClass("disabled")}else{d.find(".checkbox_li").addClass("disabled").addClass("check-disable")}var i=$(d).find(".wjzs-drop-menu");i.remove()}else{if(e.isSend==2){d.find("td:last").html('<span style="color:red">已退药</span>').data("returnStatus",2);d.find(".west-drop").attr("readonly","readonly");$(".west-totalPrice").attr("readonly","readonly");if(e.skinTest=="0"){d.find(".checkbox_li").addClass("disabled")}else{d.find(".checkbox_li").addClass("disabled").addClass("check-disable")}var i=$(d).find(".wjzs-drop-menu");i.remove()}else{if(e.isSend==3){d.find("td:last").html('<span style="color:red">部分退药</span>').data("returnStatus",2);d.find(".west-drop").attr("readonly","readonly");$(".west-totalPrice").attr("readonly","readonly");if(e.skinTest=="0"){d.find(".checkbox_li").addClass("disabled")}else{d.find(".checkbox_li").addClass("disabled").addClass("check-disable")}var i=$(d).find(".wjzs-drop-menu");i.remove()}}}}}}else{if(c==2){d.find("td:last").html('<span style="color:red">已退费</span>').data("returnStatus",2);d.find(".west-drop").attr("readonly","readonly");$(".west-totalPrice").attr("readonly","readonly");if(e.skinTest=="0"){d.find(".checkbox_li").addClass("disabled")}else{d.find(".checkbox_li").addClass("disabled").addClass("check-disable")}var i=$(d).find(".wjzs-drop-menu");i.remove()}else{if(c==2){d.find("td:last").html('<span style="color:red">部分退费</span>').data("returnStatus",2);d.find(".west-drop").attr("readonly","readonly");$(".west-totalPrice").attr("readonly","readonly");if(e.skinTest=="0"){d.find(".checkbox_li").addClass("disabled")}else{d.find(".checkbox_li").addClass("disabled").addClass("check-disable")}var i=$(d).find(".wjzs-drop-menu");i.remove()}else{if(c==4){d.find("td:last").html("收费中").data("returnStatus",0);d.find(".west-drop").attr("readonly","readonly");$(".west-totalPrice").attr("readonly","readonly");if(e.skinTest=="0"){d.find(".checkbox_li").addClass("disabled")}else{d.find(".checkbox_li").addClass("disabled").addClass("check-disable")}var i=$(d).find(".wjzs-drop-menu");i.remove()}else{if(c==0){d.find("td:last").html("已提交").data("returnStatus",0);var i=$(d).find(".wjzs-drop-menu");i.remove()}}}}}d.find(".drop-menu").remove()}else{if(e.drugUsageId!=undefined&&e.drugUsageId!=null&&e.drugUsageId=="YF09005"){d.find(".west-drop").removeAttr("readonly").addClass("readWrite")}else{d.find(".west-drop").attr("readonly","readonly").removeClass("readWrite")}d.find(".west-delete").off("click").on("click",function(){k.deleteWestItem($(this));k.appendDelItemId($(this));k.refreshList();$(".west-totalPrice").trigger("totalPriceCaclue")})}}else{d.find("td:last").empty()}this.initKetchup(d);$(d).data("data",e);if(e.totalQty==null||e.totalQty==""){$(d).find(".west-totalQty").trigger("amountCaclue")}else{if(e.drugSource==0&&(c==undefined||c==0)){$(d).find(".west-totalQty").trigger("calculateInventory")}}$(".west-totalPrice").trigger("totalPriceCaclue")},deleteWestItem:function(b){var a=this;b.parent("td").parent("tr").remove()},appendDelItemId:function(e){var c=e.parent(".operate").parent(".recipe-line");var f=c.attr("recipeName");var a=c.attr("recipeWestId");var d=$("a."+this.getRecipeClassNameByRecipeName(f));if(!a){return}var b=d.data("delWestIdList");if(!b){b=[]}b.push(a);d.data("delWestIdList",b)},clearItemInput:function(a){a.find("input").val("");a.find("input").attr("val","");a.removeAttr("drugusageid")},setInputReadOnly:function(c,b){var d=$("a."+this.getRecipeClassNameByRecipeName(c)+"[recipename="+c+"]");b.find("input").attr("readonly","readonly").removeClass("readWrite");b.find(".drop").css("cursor","auto").css("background","transparent");b.find(".units").removeClass("drop-menu");var a=$(".accessional"+c).find(".west-additionRm, .west-additionRemake, .west-additionPrice");a.attr("readonly","readonly").removeClass("readWrite");a.css("cursor","auto").css("background","transparent");$(".west-totalPrice").attr("readonly","readonly")},setInputReadOnlyToReadWrite:function(){var a=this;var b=$(".recipe_tbody");$.each(b,function(c,d){if(parseInt($(d).attr("enableEdit"))==0){return}a.setInputReadWriteAndInit($(d))})},setInputReadWriteAndInit:function(c){var m=this;var g=c.find(".west-recipeUnit, .west-groupNum, .west-drugName, .west-drugUsageName, .west-drugDose, .west-frequencyName, .west-frequencyName, .west-totalQty, .west-totalDay, .west-source, .west-remark");var f=c.attr("recipename");g.removeAttr("readonly").addClass("readWrite");var q;if(validateStock==1){q=$(".accessional"+f).find(".west-additionRm, .west-additionRemake, .west-additionPrice")}else{q=$(".accessional"+f).find(".west-additionRm, .west-additionRemake")}var k=c.find(".west-totalQty");for(var s=0;s<k.length-1;s++){var p=$(k[s]);dDentistryRecipeMain.drugInventory(p)}if(materialInventory==1){var n=$(".accessional"+f).find(".west-additionRm");for(var s=0;s<n.length;s++){var p=$(n[s]);dDentistryRecipeMain.additionInventory(p)}}q.removeAttr("readonly").addClass("readWrite");var r=c.find(".west-skinTest");var t=0;for(var s=0;s<r.length;s++){if(r[s].value!=""){t=r[s].value;if(t=="0"){c.find(".checkbox_li")[s].setAttribute("class","checkbox_li")}else{c.find(".checkbox_li")[s].setAttribute("class","checkbox_li checked")}}}var a=c.find(".west-drugUsageName");var d="";for(var s=0;s<a.length;s++){var e=$(a[s]).attr("val");if(e!=""){d=e;var l=$(c).find(".west-drop")[s];if(d=="YF09005"){$(l).removeAttr("readonly").addClass("readWrite")}else{$(l).attr("readonly","readonly").removeClass("readWrite")}}}c.find(".drop").css("cursor","pointer").css("background","#fff");$.each(c.find(".thinkBoxInputArea"),function(u,v){m._initThinkInput($(v));if($(v).data("typeahead")){$(v).data("typeahead").selectVlue=$(v).val()}});$.each(c.find(".west-drugUsageName"),function(u,v){m._initUsageDropBox($(v))});$.each(c.find(".west-frequencyName"),function(u,v){m._initFrequencyDropBox($(v))});$.each(c.find(".west-source"),function(u,v){m._initDrugSourceDropBox($(v))});$.each(c.find(".west-recipeUnit"),function(z,C){var H=$(C).parent().parent().parent().parent();var y=H.attr("drugSplit");var B=H.attr("storeUnitId");var F=H.attr("drugUnitId");var I=H.attr("scatteredPrice");var D=H.attr("unitPrice");var x=H.attr("recipeUnit");var G=H.attr("storeUnitName");var w=H.attr("dispenseUnitName");var A={drugSplit:y,storeUnitId:B,drugUnitId:F,scatteredPrice:I,unitPrice:D,recipeUnit:x,storeUnitName:G,dispenseUnitName:w};if(A.drugSplit==null||A.drugSplit==0||(A.storeUnitId==A.drugUnitId)){var v=$(C);var u={idKey:"code",txtKey:"text",isNeedClear:false};var E=[{code:"0",text:A.recipeUnit}];v.WJZSDropdown(E,u,function(i,J){if(J.code==1){$(H).find(".west-drugPrice").val(A.scatteredPrice)}else{$(H).find(".west-drugPrice").val(A.unitPrice)}$(H).attr("recipeUnit",J.text);$(H).find(".west-totalQty").trigger("amountCaclue");$(".west-totalPrice").trigger("totalPriceCaclue")});v.SetWJZSDropdownSelectedData(E[0].code);v.val(E[0].text).attr("val",E[0].code)}else{if(A.drugSplit==1){if(A.storeUnitId!=undefined&&A.storeUnitId!=null&&A.storeUnitId!=""){var v=$(C);var u={idKey:"code",txtKey:"text",isNeedClear:false};var E=[{code:"0",text:A.storeUnitName},{code:"1",text:A.dispenseUnitName}];v.WJZSDropdown(E,u,function(i,J){if(J.code==1){$(H).find(".west-drugPrice").val(A.scatteredPrice)}else{$(H).find(".west-drugPrice").val(A.unitPrice)}$(H).attr("recipeUnit",J.text);$(H).find(".west-totalQty").trigger("amountCaclue");$(".west-totalPrice").trigger("totalPriceCaclue")});if(A.recipeUnit==A.storeUnitName){v.SetWJZSDropdownSelectedData(E[0].code);v.val(E[0].text).attr("val",E[0].code)}else{v.SetWJZSDropdownSelectedData(E[1].code);v.val(E[1].text).attr("val",E[1].code)}}}}});var b=$("<a class='west-delete'>删除</a>");b.off("click").on("click",function(){m.deleteWestItem($(this));m.appendDelItemId($(this));m.refreshList();$(".west-totalPrice").trigger("totalPriceCaclue")});var o=_.map(c,function(i){return $(i).attr("recipeName")});c.find(".operate").empty();c.find(".operate").append(b.clone(true));var h=$("<a class='west-delete'>删除</a>");h.off("click").on("click",function(){m.deleteWestItem($(this));var i=$(".accessional"+f).find(".fj:visible");if(i.length==0){$(".fjxm").hide();$(".accessional"+f).addClass("dsn")}m.renderIndex(f);m.grossPrice()});$(".accessional"+f).find(".operate").empty();$(".accessional"+f).find(".operate").append(h.clone(true));$.each(o,function(u,v){m.addRecipeItem(v,true,true)})},fillRecipeLable:function(d,b,c,a){$(c).attr("recipeId",b);$(c).attr("recipeCode",a);$(c).find("span").text(d)},fillTotalPrice:function(b,a){$(a).val(Utils.changePrice(b))}};var DentistryRecipeAction=function(){this.isUpdate=true};DentistryRecipeAction.prototype={selectUsageAction:function(c,f){var a=this;if(a.usageData!=null&&f){if(f){f.call(a,a.usageData);return}}var d={};var b={type:"GET",method:"GET",url:ContextClinc_Server+"mdcDrugUsage/selectDropDownList",dataType:"json",data:null,async:true};var e=Utils.myAjaxHandler(b);e.done(function(g){if(g!=null&&g.errorCode==SUCCESSCODE){a.usageData=g.data;if(f){f.call(a,a.usageData)}}else{$.paError(g.errorMessage)}}).fail(function(g){$.paError("操作失败!")}).always(function(){})},selectFrequencyAction:function(c,f){var a=this;if(a.freData!=null&&f){if(f){f.call(a,a.freData);return}}var d={};var b={type:"GET",method:"GET",url:ContextClinc_Server+"combox/drugFrequency",dataType:"json",data:null,async:true};var e=Utils.myAjaxHandler(b);e.done(function(g){if(g!=null&&g.errorCode==SUCCESSCODE){a.freData=g.data;if(f){f.call(a,a.freData)}}else{$.paError(g.errorMessage)}}).fail(function(g){$.paError("操作失败!")}).always(function(){})},getRecipeListAction:function(d,f){var a=this;var c={acographyId:d};var b={url:ContextClinc_Server+"dentistryRecipe/getDentistryRecipeList",dataType:"json",showMask:true,data:c};var e=Utils.myAjaxHandler(b);e.done(function(g){if(g.errorCode=="E0000000"){f.call(a,g.data)}else{$.paError("提交失败")}}).fail(function(g){$.paError("操作失败!")}).always(function(){})},getRecipeByRecipeIdAction:function(c,f){var a=this;var d={recipeId:c};var b={url:ContextClinc_Server+"dentistryRecipe/getDentistryRecipeRecipeId",dataType:"json",showMask:true,data:d};var e=Utils.myAjaxHandler(b);e.done(function(g){if(g.errorCode=="E0000000"){f.call(a,g.data)}else{$.paError("提交失败")}}).fail(function(g){$.paError("操作失败!")}).always(function(){})},getAdditionByRecipeIdAction:function(c,f){var a=this;var d={recipeId:c};var b={url:ContextClinc_Server+"dentistryRecipe/getAdditionRecipeId",dataType:"json",showMask:true,data:d};var e=Utils.myAjaxHandler(b);e.done(function(g){if(g.errorCode=="E0000000"){f.call(a,g.data)}else{$.paError("提交失败")}}).fail(function(g){$.paError("操作失败!")}).always(function(){})},delRecipeAction:function(c,f,g){var a=this;var d={recipeId:c};var b={url:ContextClinc_Server+"dentistryRecipe/delDentistryRecipe",dataType:"json",showMask:true,data:d};var e=Utils.myAjaxHandler(b);e.done(function(h){if(h.errorCode=="E0000000"){if(h.data<1){$.paWarn(h.errorCode+"处方已经发药或者收费，不允许删除该处方！")}else{g.call(a,f)}}else{$.paError("提交失败")}}).fail(function(h){$.paError("操作失败!")}).always(function(){})},getWestRecipePersonalTmplList:function(e){var a=this;if(a.recipePersonalTmplList!=null&&e&&!this.isUpdate){if(e){e.call(a,a.recipePersonalTmplList);return}}var c={tmpLevel:3};var b={url:ContextClinc_Server+"DwsRecipeTmpl/getRecipeWestImpl",dataType:"json",data:JSON.stringify(c),contentType:"application/json; charset=utf-8"};var d=Utils.myAjaxHandler(b);d.done(function(f){if(f.errorCode=="E0000000"){if(f.data==null||f.data==undefined){return}a.recipePersonalTmplList=f.data;a.isUpdate=false;e.call(a,f.data)}}).fail(function(f){$.paError("操作失败!")}).always(function(){})},getWestRecipeClinicTmplList:function(e){var a=this;if(a.recipeClinicTmplList!=null&&e&&!this.isUpdate){if(e){e.call(a,a.recipeClinicTmplList);return}}var c={tmpLevel:2};var b={url:ContextClinc_Server+"DwsRecipeTmpl/getRecipeWestImpl",dataType:"json",data:JSON.stringify(c),contentType:"application/json; charset=utf-8"};var d=Utils.myAjaxHandler(b);d.done(function(f){if(f.errorCode=="E0000000"){if(f.data==null||f.data==undefined){return}a.recipeClinicTmplList=f.data;a.isUpdate=false;e.call(a,f.data)}}).fail(function(f){$.paError("操作失败!")}).always(function(){})},getWestRecipeTmplInfoByTempId:function(c,f){var a=this;var d={recipeTmplId:c};var b={url:ContextClinc_Server+"dwsRecipeWestTmpl/getRecipeWestImplInfo",dataType:"json",data:d,showMask:true,contentType:"application/x-www-form-urlencoded"};var e=Utils.myAjaxHandler(b);e.done(function(g){if(g.errorCode=="E0000000"){if(g.data==null||g.data==undefined){return}if(g.data.length<1){return}f.call(a,g.data)}else{$.paError("提交失败")}}).fail(function(g){$.paError("操作失败!")}).always(function(){})},getHistoryRecipeListAction:function(d,f){var a=this;if(a.hisData!=null&&a.hisData!=undefined){f.call(a,a.hisData);return}var c={acographyId:d};var b={url:ContextClinc_Server+"dentistryRecipe/getDentistryRecipeHistoryList",dataType:"json",data:c,contentType:"application/x-www-form-urlencoded"};var e=Utils.myAjaxHandler(b);e.done(function(g){if(g.errorCode=="E0000000"){a.hisData=g.data;f.call(a,g.data)}else{$.paError("提交失败")}}).fail(function(g){$.paError("操作失败!")}).always(function(){})},getMdcDictDrugWithIdAction:function(c,f){var a=this;if(c&&c!=""){var e={drugIds:c};var b={type:"POST",method:"POST",contentType:"application/json; charset=utf-8",url:ContextClinc_Server+"intentInput/getMdcDictDrugWithDrugId",data:JSON.stringify(e),dataType:"json",async:false};var d=Utils.myAjaxHandler(b);d.done(function(g){if(!g.errorMessage){f.call(a,g.data)}else{$.paError(g.errorMessage,null);return}}).fail(function(g){$.paError("请求异常",null)}).always(function(){})}else{f.call(a,[])}},checkWestRecipeTmplNameAction:function(f,a,e){var c={};var b={url:ContextClinc_Server+"dwsRecipeWestTmpl/checkWestTmplName",dataType:"json",data:{tmplName:f!=null?f:"",tmplType:a,tmplId:null},async:false};var d=Utils.myAjaxHandler(b);d.done(function(g){if(g!=null&&g.errorCode==SUCCESSCODE){e.call(self,g.data)}else{$.paError(g.errorMessage)}}).fail(function(g){$.paError("操作失败!")}).always(function(){});return c},addRecipeWestTmplAction:function(a){var b=this;var c={url:ContextClinc_Server+"dwsRecipeWestTmpl/addRecipeWestImpl",dataType:"json",data:JSON.stringify(a),showMask:true,contentType:"application/json; charset=utf-8"};var d=Utils.myAjaxHandler(c);d.done(function(e){if(e.errorCode=="E0000000"){b.isUpdate=true;$.paSuccess("保存成功")}else{$.paError("保存失败")}}).fail(function(e){$.paError("操作失败!")}).always(function(){})},saveRecipeAction:function(a,l){for(var e=0;e<a.length;e++){var b=[];var h=a[e].recipeName;var f=a[e].recipeWestList;for(var d=0;d<f.length;d++){var c=f[d].drugId;var k=f[d].delFlag;if(c!=undefined&&c!=null&&c!=""&&k!="1"){var g=$.inArray(c,b);if(g==-1){b.push(c)}}}if(drugLimit==1){if(b.length>5){finishPatFlag=false;$.paWarn("保存失败,处方"+h+"中最多只允许存在5种药品,请修改处方!");return}}else{if(b.length>1000){finishPatFlag=false;$.paWarn("保存失败,处方"+h+"中最多只允许存在1000种药品,请修改处方!");return}}}var m=this;var o={url:ContextClinc_Server+"dentistryRecipe/addAndUpdateRecipeWestList",dataType:"json",data:JSON.stringify(a),showMask:true,contentType:"application/json; charset=utf-8"};var n=Utils.myAjaxHandler(o);n.done(function(i){if(i.errorCode=="E0000000"){finishPatFlag=true;$.paSuccess("保存成功");l.call(m)}else{if(i.errorCode=="E2SP7001"){finishPatFlag=false;$.paWarn(i.errorMessage);l.call(m)}else{finishPatFlag=false;$.paError("提交失败")}}}).fail(function(i){$.paError("操作失败!")}).always(function(){})},returnRecipeAction:function(d,e){var a=this;var b={url:ContextClinc_Server+"dentistryRecipe/initiateReturnDrug",dataType:"json",data:JSON.stringify(d),showMask:true,contentType:"application/json; charset=utf-8"};var c=Utils.myAjaxHandler(b);c.done(function(f){if(f.errorCode=="E0000000"){$.paSuccess("保存成功");e.call(a)}else{if(f.errorCode=="E2SP7001"){$.paWarn(f.errorMessage);e.call(a)}else{$.paError("提交失败")}}}).fail(function(f){$.paError("操作失败!")}).always(function(){})},auditRecipeAction:function(e,c,f){var a=this;var b={url:ContextClinc_Server+"dentistryRecipe/auditRecipe",dataType:"json",data:JSON.stringify(e),showMask:true,contentType:"application/json; charset=utf-8"};var d=Utils.myAjaxHandler(b);d.done(function(g){if(g.errorCode=="E0000000"){f.call(a,g.data)}else{if(c){if(g.errorMessage!=null){$.paError(g.errorMessage)}else{$.paError("审核失败")}}}}).fail(function(g){$.paError("操作失败!")}).always(function(){})},isYbRegisterAction:function(c,e){var a=this;var b={url:ContextClinc_Server+"ybReimburse/isYbRegister",dataType:"json",data:c,showMask:true,contentType:"application/json; charset=utf-8"};var d=Utils.myAjaxHandler(b);d.done(function(f){if(f.errorCode=="E0000000"){e.call(a,f.data)}else{$.paError("查询失败")}}).fail(function(f){$.paError("操作失败!")}).always(function(){})},_initAdditionName:function(d){var a=this;var c={columns:[{display:"名称",dataKey:"TREATMENT_NAME",width:200},{display:"价格",dataKey:"TREATMENT_PRICE",width:50}],extraParams:{key:"keyword",limitRows:20},selectFirst:true,formatResult:function(e){if(e.TREATMENT_PRICE!=null){e.TREATMENT_PRICE=e.TREATMENT_PRICE+"元"}return e.TREATMENT_NAME},formatMatch:function(g,f,e){return g.TREATMENT_NAME+"--"+g.TREATMENT_CODE+"--"+g.TREATMENT_ID},matchContains:"word",autoFill:false,width:300,multiple:false,multipleSeparator:", ",highlight:function(f,e){return f.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+e.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:true,scrollHeight:180,wrapperHandle:".dentistry-project"};var b=ContextClinc_Server+"intentInput/getTreatmentMaterialsList";var a=this;d.autocomplete(b,c).result(function(f,h,g){var i=h.RN;var e=h.TREATMENT_PRICE.replace(/\元/g,"");d.parent().parent().attr("data-treatmentid",h.TREATMENT_ID);d.parent().siblings("td").find(".west-additionRm").val(checkNum(i,2));d.parent().siblings("td").find(".west-additionPrice").val(e)})}};function checkNum(b,a){if(isNaN(b)){if(a!=undefined&&a!==null&&a!=""){b=0}else{b=0}}return b}function log(a){if(window.console){console.log(a)}}function setRecipeDoctor(a,c,b){log(a+"   "+c+"    "+b);$("#doci-input").val(c)};