var userInfo_aclcs=config_cache.getCache("medical_user_data");var DentistryRecipeHistory=function(a,b,c){this.dentistryRecipeModle=a;this.quoteObj=$("<span class='fl quote' title='引用'></span>");this.dentistryRecipeAction=b;this.empiId=c};DentistryRecipeHistory.prototype={initHistoryRecipeRecord:function(b){var a=this;this.bindEvent();this.getHistoryRecipeListAction(b,function(c){a.fillRecipeRecord(c)})},bindEvent:function(){var a=this;$("#history_record").off("click",".head-line");$("#history_record").on("click",".head-line",function(){if($(this).find("button").hasClass("expand")){$(this).find("button").removeClass("expand").addClass("collapse");$(this).siblings(".detail").show()}else{$(this).find("button").removeClass("collapse").addClass("expand");$(this).siblings(".detail").hide()}});$("#history_record").off("click",".history_recipe_lable");$("#history_record").on("click",".history_recipe_lable",function(){$(this).addClass("current").siblings(".history_recipe_lable").removeClass("current");var d=$(this).find("span").attr("recipeName");var c=$(this).parent(".history-top-recipe").siblings(".history-top-btn");c.find(".print").attr("title","打印处方"+d);c.find(".quote").attr("title","引用处方"+d);var b=$(this).parent(".history-top-recipe").parent(".history-content-top").siblings(".history-table-wrapper").find("table[recipeName="+d+"]");b.show().siblings(".west-history-table").hide()});$("#history_record").off("click",".quote");$("#history_record").on("click",".quote",function(){var b=$(this).parent(".history-top-btn").siblings(".history-top-recipe").find(".history_recipe_lable.current").data("recipeRecord");console.log(b);a.dentistryRecipeModle.quoteHisRecipe(b.recipeWestList)});$("#history_record").off("click",".print");$("#history_record").on("click",".print",function(){var b=$(this).parent(".history-top-btn").siblings(".history-top-recipe").find(".history_recipe_lable.current");var d=b.attr("recipeId");var c=b.attr("acographyId");a.printCurrentRecipeByRecipeId(d,c,a.empiId)})},printCurrentRecipeByRecipeId:function(a,b,c){if(a){this.dentistryRecipeAction.getRecipeByRecipeIdAction(a,function(d){if(!d){$.paWarn("处方信息为空！");return}new WMPrescriptionPrint().printWestRecipeFacade(d,b,c)})}else{$.paWarn("请先保存处方！")}},fillRecipeRecord:function(b){var a=this;$.each(b,function(f,h){var d=userInfo_aclcs.clinicId;var c=a.newHistoryRecordItem();var g=h.recipe;c.find(".check-style").text(a.convertTreatmentType(h.treatmentType));c.find(".checkDate").text(new Date(h.addDate).Format("yyyy-MM-dd HH:mm:ss"));if(h.doctorName==undefined||h.doctorName==null||h.doctorName=="null"){h.doctorName=""}c.find(".doctorName").text(h.doctorName);if(h.isChainClinic=="1"&&h.clinicId!=d){c.find(".clinicName").text("门店: "+h.clinicName)}g=_.sortBy(g,function(e){return e.recipeName});$.each(g,function(e,i){a.fillRecipe(c,i);if(e==0){a.selectRecipe(c,i.recipeName)}});$("#history_record").append(c);if(h.clinicId!=d){$("#history_record").find(".quote").hide();$("#history_record").find(".print").hide()}})},fillRecipe:function(b,c){var e=this;var f=this.newHistoryRecipeLable();f.data("recipeRecord",c);f.find(".index").attr("recipeName",c.recipeName).text(c.recipeName);f.attr("recipeId",c.recipeId);f.attr("acographyId",c.acographyId);b.find(".history-top-recipe").append(f);var a=this.newHistoryRecipeTable();a.attr("recipeName",c.recipeName);var d=c.recipeWestList;$.each(d,function(g,h){e.fillRecipeTr(h,a)});this.fillRecipeTotalPrice(c,a);b.find(".history-table-wrapper").append(a)},fillRecipeTr:function(c,a){var b=this.newHistoryDrugTrItem();this.fillRecipeItem(c,b);a.append(b)},convertTreatmentType:function(a){if(a===1||a==="1"||a==null){return"初诊"}else{if(a===2||a==="2"){return"复诊"}}return"未知"},fillRecipeTotalPrice:function(b,a){var c=this.newHistoryTotalPriceTrItem();c.find(".zj").val(Utils.changePrice(b.totalPrice));a.append(c)},quoteBtnShow:function(){this.quoteObj.show();$("#history_record").find(".quote").show()},quoteBtnHide:function(){this.quoteObj.hide();$("#history_record").find(".quote").hide()},drugSourceData:[{id:0,name:"本院"},{id:1,name:"外购"},{id:2,name:"免费"}],convertId2Name:function(b){for(var a=0;a<this.drugSourceData.length;a++){if(this.drugSourceData[a].id==b){return this.drugSourceData[a].name}}return""},selectRecipe:function(a,b){a.find(".history_recipe_lable").addClass("current");a.find(".west-history-table").show();a.find(".print").attr("title","打印处方"+b);a.find(".quote").attr("title","引用处方"+b)},fillRecipeItem:function(a,d){d.find(".west-groupNum").attr("groupNum",a.groupNum).val(a.groupNum);d.find(".west-drugName").val(a.drugName);if(d.find(".west-drugName").data("typeahead")){d.find(".west-drugName").data("typeahead").selectVlue=a.drugName}d.find(".west-drugSpec").val(a.drugSpec);d.find(".west-drugUsageName").val(a.drugUsageName);d.find(".west-drugDose").val(a.drugDose);d.find(".west-drugUnit").val(a.drugUnitName);d.find(".west-frequencyName").val(a.frequencyName);d.find(".west-totalDay").val(a.totalDay);d.find(".west-totalQty").val(a.totalQty);d.find(".west-remark").val(a.remark);d.find(".west-remark").attr("title",a.remark);d.find(".west-recipeUnit").val(a.recipeUnit);d.find(".west-drugUsageName").attr("val",a.drugUsageId);d.find(".west-frequencyName").attr("val",a.frequencyId);d.find(".west-source").val(this.convertId2Name(a.drugSource));d.find(".west-source").attr("val",a.drugSource);var c=a.dripSpeed;if(c&&c==0){c=0}d.find(".west-drop").val(c);d.attr("unitPrice",a.unitPrice);d.attr("drugId",a.drugId);d.attr("drugUnitId",a.drugUnitId);d.attr("drugUsageId",a.drugUsageId);d.attr("frequencyId",a.frequencyId);d.attr("frequencyQty",a.frequencyQty);d.attr("convertRange",a.convertRange);d.attr("drugConvertRateDose",a.drugConvertRateDose);d.attr("drugConvertRate",a.drugConvertRate);d.attr("drugConvertRateStoreUnit",a.drugConvertRateStoreUnit);d.attr("storeUnitQty",a.storeUnitQty);d.attr("drugName",a.drugName);d.attr("recipeWestId",a.recipeWestId);if(a.drugSplit==1){d.find(".west-drugPrice").val(a.scatteredPrice)}else{d.find(".west-drugPrice").val(a.unitPrice)}var e=a.isPay;var b=a.isSend;if(e==1){if(b==1){e="已发药"}else{if(b==0){e="已收费"}else{if(b==6){e="申请退药"}else{if(b==2){e="已退药";d.find(".west-ispay").css("color","red")}else{if(b==3){e="部分退药";d.find(".west-ispay").css("color","red")}}}}}}else{if(e==2){e="已退费";d.find(".west-ispay").css("color","red")}else{if(e==3){e="部分退费";d.find(".west-ispay").css("color","red")}else{if(e==4){e="收费中"}else{if(e==0){e="已提交"}}}}}d.find(".west-ispay").val(e);if(a.skinTest=="0"){d.find(".checkbox_li").removeClass("check-disable").removeClass("checked");d.find(".west-skinTest").val("0")}else{d.find(".checkbox_li").addClass("check-disable");d.find(".west-skinTest").val("1")}$(d).data("data",a)},getHistoryRecipeListAction:function(d,f){var a=this;var c={acographyId:d};var b={url:ContextClinc_Server+"dentistryRecipe/getDentistryRecipeHistoryList",dataType:"json",data:c,contentType:"application/x-www-form-urlencoded"};var e=Utils.myAjaxHandler(b);e.done(function(g){if(g.errorCode=="E0000000"){a.hisData=g.data;f.call(a,g.data)}else{$.paError("提交失败")}}).fail(function(g){$.paError("操作失败!")}).always(function(){})},newHistoryDrugTrItem:function(){var a="<tr class='historyDurgItem'>						<td>							<input type='text' class='west-groupNum' readonly='readonly'/>						</td>						<td>							<input type='text' class='west-drugName' readonly='readonly'/>						</td>						<td>							<input type='text' readonly='readonly' class='west-drugSpec'>						</td>						<td>							<div class='drop read-drop'>								<input type='text' class='input-text west-drugUsageName' readonly='readonly'/>								<i class='drop-icon'></i>							</div>						</td>						<td>						    <input type='text' style='width: 60px;' class='west-drop input-text ' maxlength='5' readonly='readonly'/>						</td>						<td>							<input type='text' style='width: 30px;' class='west-drugDose' readonly='readonly' />							<input type='text' readonly='readonly' class='west-drugUnit' style='width: 30px;'></td>						<td>							<div class='drop read-drop'>								<input type='text' class='input-text west-frequencyName' readonly='readonly'/>								<i class='drop-icon' placeholder='频率'></i>							</div>						</td>						<td>							<input type='text' class='west-totalDay' readonly='readonly'/>						</td>						<td>							<input type='text' style='width: 40px;' class='west-totalQty' readonly='readonly'/>							<input type='text' readonly='readonly' class='west-recipeUnit' style='width: 30px;'/>						</td>						<td>							<div class='drop read-drop'>								<input type='text' class='input-text west-source' readonly='readonly'>								<i class='drop-icon'></i>							</div>						</td>						<td>							<input type='text'  class='west-remark' readonly='readonly'/>						</td>						<td name='skin' class='skin'>							<ul class='checkboxes_ul'>									<li class='checkbox_li'  id='skinTest'></li>									<input type='hidden' class='west-skinTest' />							</ul>						</td>        				<td>							<input type='text' style='width: 60px;' class='west-ispay' readonly='readonly'/>						</td></tr>";return $(a)},newHistoryTotalPriceTrItem:function(){var a="<tr class='west-table-foot' style='background: rgb(239, 244, 248);'>						<td colspan='12'>							<div class='total-price'>								总价（元）：<input class='fr zj' type='text' readonly='readonly' style='margin-right:10px;'>							</div>						</td>					</tr>";return $(a)},newHistoryRecordItem:function(){var b="<div class='history_record_item'>						<div class='head-line history'>							<span class='check-style'>初诊</span>							就诊时间:<span class='checkDate'>2016-11-25 12:00:00</span>							就诊医生:<span class='doctorName'>张三</span>							<span class='clinicName'></span>							<button class='expand'>								<i></i>							</button>						</div>						<div class='detail' style='display: none'>							<div class='history-content-top'>							    <div class='history-top-recipe'>                                </div>                                <div class='history-top-btn'>                                    <span class='fl print' title='打印'></span>                                </div>							</div>							<div class='table-wrapper history-table-wrapper'>							</div>						</div>					</div>";var a=$(b);a.find(".print").before(this.quoteObj.clone());return a},newHistoryRecipeLable:function(){var a="<a class='cf-btn fl history_recipe_lable'						data-index='0'>处方<span class='index'>0</span>					</a>";return $(a)},newHistoryRecipeTable:function(){var a="<table class='common-table west-history-table' style='display: none'>						<thead>							<tr>								<th width='4%'>组号</th>								<th width='14%'>药品名称</th>								<th width='9%'>规格</th>								<th width='9%'>用法</th>								<th width='4%'>滴/分钟</th>								<th width='9%'>剂量</th>								<th width='9%'>频率</th>								<th width='4%'>天数</th>								<th width='9%'>总量</th>								<th width='7%'>来源</th>								<th width='8%'>备注</th>								<th width='1%'>皮试</th>								<th>状态</th>							</tr>						</thead>						<tbody>						</tbody>					</table>";return $(a)}};